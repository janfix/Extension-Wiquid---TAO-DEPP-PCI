{
  "version": 3,
  "sources": [
    "../build/config-wrap-start-default.js",
    "../../../taoQtiItem/views/js/portableLib/jquery_2_1_1.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/xml.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/math.js",
    "../../../taoQtiItem/views/js/portableLib/jquery.qtip.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/tooltip.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/html.js",
    "../../../pciWiquid/views/js/pciCreator/dev/snap/runtime/js/lib/snapsrc.js",
    "../../../pciWiquid/views/js/pciCreator/dev/snap/runtime/js/renderer.js",
    "../../../taoQtiItem/views/js/portableLib/lodash.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/EventMgr.js",
    "../../../taoQtiItem/views/js/portableLib/OAT/util/event.js",
    "../../../pciWiquid/views/js/pciCreator/dev/snap/runtime/SnapForTao.amd.js",
    "../build/config-wrap-end-default.js"
  ],
  "names": [],
  "mappings": "AAAA;AACA,ACDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AC3/RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AChBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACn6GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACzDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AC978DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AC7DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,ACnLA;AACA",
  "file": "SnapForTao.min.js",
  "sourcesContent": [
    "\n",
    "/**\n * JEROME's note:\n * \n * The only change in jQuery source is the comment added from\n * l. 9190 to l. 9192.\n *\n * Wrapped into a define call with no dependency to scope\n * the whole source code and get rid of the window.$ and window.jQuery.\n *\n * The modification is then minimal (close to automation) to get a pure AMD release\n * of jQuery.\n */\n\ndefine('taoQtiItem/portableLib/jquery_2_1_1',[],function() {\n\n// BEGIN JQUERY SOURCE\n\n/*!\n * jQuery JavaScript Library v2.1.1\n * http://jquery.com/\n *\n * Includes Sizzle.js\n * http://sizzlejs.com/\n *\n * Copyright 2005, 2014 jQuery Foundation, Inc. and other contributors\n * Released under the MIT license\n * http://jquery.org/license\n *\n * Date: 2014-05-01T17:11Z\n */\n\n(function( global, factory ) {\n\n\tif ( typeof module === \"object\" && typeof module.exports === \"object\" ) {\n\t\t// For CommonJS and CommonJS-like environments where a proper window is present,\n\t\t// execute the factory and get jQuery\n\t\t// For environments that do not inherently posses a window with a document\n\t\t// (such as Node.js), expose a jQuery-making factory as module.exports\n\t\t// This accentuates the need for the creation of a real window\n\t\t// e.g. var jQuery = require(\"jquery\")(window);\n\t\t// See ticket #14549 for more info\n\t\tmodule.exports = global.document ?\n\t\t\tfactory( global, true ) :\n\t\t\tfunction( w ) {\n\t\t\t\tif ( !w.document ) {\n\t\t\t\t\tthrow new Error( \"jQuery requires a window with a document\" );\n\t\t\t\t}\n\t\t\t\treturn factory( w );\n\t\t\t};\n\t} else {\n\t\tfactory( global );\n\t}\n\n// Pass this if window is not defined yet\n}(typeof window !== \"undefined\" ? window : this, function( window, noGlobal ) {\n\n// Can't do this because several apps including ASP.NET trace\n// the stack via arguments.caller.callee and Firefox dies if\n// you try to trace through \"use strict\" call chains. (#13335)\n// Support: Firefox 18+\n//\n\nvar arr = [];\n\nvar slice = arr.slice;\n\nvar concat = arr.concat;\n\nvar push = arr.push;\n\nvar indexOf = arr.indexOf;\n\nvar class2type = {};\n\nvar toString = class2type.toString;\n\nvar hasOwn = class2type.hasOwnProperty;\n\nvar support = {};\n\n\n\nvar\n\t// Use the correct document accordingly with window argument (sandbox)\n\tdocument = window.document,\n\n\tversion = \"2.1.1\",\n\n\t// Define a local copy of jQuery\n\tjQuery = function( selector, context ) {\n\t\t// The jQuery object is actually just the init constructor 'enhanced'\n\t\t// Need init if jQuery is called (just allow error to be thrown if not included)\n\t\treturn new jQuery.fn.init( selector, context );\n\t},\n\n\t// Support: Android<4.1\n\t// Make sure we trim BOM and NBSP\n\trtrim = /^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g,\n\n\t// Matches dashed string for camelizing\n\trmsPrefix = /^-ms-/,\n\trdashAlpha = /-([\\da-z])/gi,\n\n\t// Used by jQuery.camelCase as callback to replace()\n\tfcamelCase = function( all, letter ) {\n\t\treturn letter.toUpperCase();\n\t};\n\njQuery.fn = jQuery.prototype = {\n\t// The current version of jQuery being used\n\tjquery: version,\n\n\tconstructor: jQuery,\n\n\t// Start with an empty selector\n\tselector: \"\",\n\n\t// The default length of a jQuery object is 0\n\tlength: 0,\n\n\ttoArray: function() {\n\t\treturn slice.call( this );\n\t},\n\n\t// Get the Nth element in the matched element set OR\n\t// Get the whole matched element set as a clean array\n\tget: function( num ) {\n\t\treturn num != null ?\n\n\t\t\t// Return just the one element from the set\n\t\t\t( num < 0 ? this[ num + this.length ] : this[ num ] ) :\n\n\t\t\t// Return all the elements in a clean array\n\t\t\tslice.call( this );\n\t},\n\n\t// Take an array of elements and push it onto the stack\n\t// (returning the new matched element set)\n\tpushStack: function( elems ) {\n\n\t\t// Build a new jQuery matched element set\n\t\tvar ret = jQuery.merge( this.constructor(), elems );\n\n\t\t// Add the old object onto the stack (as a reference)\n\t\tret.prevObject = this;\n\t\tret.context = this.context;\n\n\t\t// Return the newly-formed element set\n\t\treturn ret;\n\t},\n\n\t// Execute a callback for every element in the matched set.\n\t// (You can seed the arguments with an array of args, but this is\n\t// only used internally.)\n\teach: function( callback, args ) {\n\t\treturn jQuery.each( this, callback, args );\n\t},\n\n\tmap: function( callback ) {\n\t\treturn this.pushStack( jQuery.map(this, function( elem, i ) {\n\t\t\treturn callback.call( elem, i, elem );\n\t\t}));\n\t},\n\n\tslice: function() {\n\t\treturn this.pushStack( slice.apply( this, arguments ) );\n\t},\n\n\tfirst: function() {\n\t\treturn this.eq( 0 );\n\t},\n\n\tlast: function() {\n\t\treturn this.eq( -1 );\n\t},\n\n\teq: function( i ) {\n\t\tvar len = this.length,\n\t\t\tj = +i + ( i < 0 ? len : 0 );\n\t\treturn this.pushStack( j >= 0 && j < len ? [ this[j] ] : [] );\n\t},\n\n\tend: function() {\n\t\treturn this.prevObject || this.constructor(null);\n\t},\n\n\t// For internal use only.\n\t// Behaves like an Array's method, not like a jQuery method.\n\tpush: push,\n\tsort: arr.sort,\n\tsplice: arr.splice\n};\n\njQuery.extend = jQuery.fn.extend = function() {\n\tvar options, name, src, copy, copyIsArray, clone,\n\t\ttarget = arguments[0] || {},\n\t\ti = 1,\n\t\tlength = arguments.length,\n\t\tdeep = false;\n\n\t// Handle a deep copy situation\n\tif ( typeof target === \"boolean\" ) {\n\t\tdeep = target;\n\n\t\t// skip the boolean and the target\n\t\ttarget = arguments[ i ] || {};\n\t\ti++;\n\t}\n\n\t// Handle case when target is a string or something (possible in deep copy)\n\tif ( typeof target !== \"object\" && !jQuery.isFunction(target) ) {\n\t\ttarget = {};\n\t}\n\n\t// extend jQuery itself if only one argument is passed\n\tif ( i === length ) {\n\t\ttarget = this;\n\t\ti--;\n\t}\n\n\tfor ( ; i < length; i++ ) {\n\t\t// Only deal with non-null/undefined values\n\t\tif ( (options = arguments[ i ]) != null ) {\n\t\t\t// Extend the base object\n\t\t\tfor ( name in options ) {\n\t\t\t\tsrc = target[ name ];\n\t\t\t\tcopy = options[ name ];\n\n\t\t\t\t// Prevent never-ending loop\n\t\t\t\tif ( target === copy ) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Recurse if we're merging plain objects or arrays\n\t\t\t\tif ( deep && copy && ( jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy)) ) ) {\n\t\t\t\t\tif ( copyIsArray ) {\n\t\t\t\t\t\tcopyIsArray = false;\n\t\t\t\t\t\tclone = src && jQuery.isArray(src) ? src : [];\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\tclone = src && jQuery.isPlainObject(src) ? src : {};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Never move original objects, clone them\n\t\t\t\t\ttarget[ name ] = jQuery.extend( deep, clone, copy );\n\n\t\t\t\t// Don't bring in undefined values\n\t\t\t\t} else if ( copy !== undefined ) {\n\t\t\t\t\ttarget[ name ] = copy;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Return the modified object\n\treturn target;\n};\n\njQuery.extend({\n\t// Unique for each copy of jQuery on the page\n\texpando: \"jQuery\" + ( version + Math.random() ).replace( /\\D/g, \"\" ),\n\n\t// Assume jQuery is ready without the ready module\n\tisReady: true,\n\n\terror: function( msg ) {\n\t\tthrow new Error( msg );\n\t},\n\n\tnoop: function() {},\n\n\t// See test/unit/core.js for details concerning isFunction.\n\t// Since version 1.3, DOM methods and functions like alert\n\t// aren't supported. They return false on IE (#2968).\n\tisFunction: function( obj ) {\n\t\treturn jQuery.type(obj) === \"function\";\n\t},\n\n\tisArray: Array.isArray,\n\n\tisWindow: function( obj ) {\n\t\treturn obj != null && obj === obj.window;\n\t},\n\n\tisNumeric: function( obj ) {\n\t\t// parseFloat NaNs numeric-cast false positives (null|true|false|\"\")\n\t\t// ...but misinterprets leading-number strings, particularly hex literals (\"0x...\")\n\t\t// subtraction forces infinities to NaN\n\t\treturn !jQuery.isArray( obj ) && obj - parseFloat( obj ) >= 0;\n\t},\n\n\tisPlainObject: function( obj ) {\n\t\t// Not plain objects:\n\t\t// - Any object or value whose internal [[Class]] property is not \"[object Object]\"\n\t\t// - DOM nodes\n\t\t// - window\n\t\tif ( jQuery.type( obj ) !== \"object\" || obj.nodeType || jQuery.isWindow( obj ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ( obj.constructor &&\n\t\t\t\t!hasOwn.call( obj.constructor.prototype, \"isPrototypeOf\" ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If the function hasn't returned already, we're confident that\n\t\t// |obj| is a plain object, created by {} or constructed with new Object\n\t\treturn true;\n\t},\n\n\tisEmptyObject: function( obj ) {\n\t\tvar name;\n\t\tfor ( name in obj ) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t},\n\n\ttype: function( obj ) {\n\t\tif ( obj == null ) {\n\t\t\treturn obj + \"\";\n\t\t}\n\t\t// Support: Android < 4.0, iOS < 6 (functionish RegExp)\n\t\treturn typeof obj === \"object\" || typeof obj === \"function\" ?\n\t\t\tclass2type[ toString.call(obj) ] || \"object\" :\n\t\t\ttypeof obj;\n\t},\n\n\t// Evaluates a script in a global context\n\tglobalEval: function( code ) {\n\t\tvar script,\n\t\t\tindirect = eval;\n\n\t\tcode = jQuery.trim( code );\n\n\t\tif ( code ) {\n\t\t\t// If the code includes a valid, prologue position\n\t\t\t// strict mode pragma, execute code by injecting a\n\t\t\t// script tag into the document.\n\t\t\tif ( code.indexOf(\"use strict\") === 1 ) {\n\t\t\t\tscript = document.createElement(\"script\");\n\t\t\t\tscript.text = code;\n\t\t\t\tdocument.head.appendChild( script ).parentNode.removeChild( script );\n\t\t\t} else {\n\t\t\t// Otherwise, avoid the DOM node creation, insertion\n\t\t\t// and removal by using an indirect global eval\n\t\t\t\tindirect( code );\n\t\t\t}\n\t\t}\n\t},\n\n\t// Convert dashed to camelCase; used by the css and data modules\n\t// Microsoft forgot to hump their vendor prefix (#9572)\n\tcamelCase: function( string ) {\n\t\treturn string.replace( rmsPrefix, \"ms-\" ).replace( rdashAlpha, fcamelCase );\n\t},\n\n\tnodeName: function( elem, name ) {\n\t\treturn elem.nodeName && elem.nodeName.toLowerCase() === name.toLowerCase();\n\t},\n\n\t// args is for internal usage only\n\teach: function( obj, callback, args ) {\n\t\tvar value,\n\t\t\ti = 0,\n\t\t\tlength = obj.length,\n\t\t\tisArray = isArraylike( obj );\n\n\t\tif ( args ) {\n\t\t\tif ( isArray ) {\n\t\t\t\tfor ( ; i < length; i++ ) {\n\t\t\t\t\tvalue = callback.apply( obj[ i ], args );\n\n\t\t\t\t\tif ( value === false ) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor ( i in obj ) {\n\t\t\t\t\tvalue = callback.apply( obj[ i ], args );\n\n\t\t\t\t\tif ( value === false ) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t// A special, fast, case for the most common use of each\n\t\t} else {\n\t\t\tif ( isArray ) {\n\t\t\t\tfor ( ; i < length; i++ ) {\n\t\t\t\t\tvalue = callback.call( obj[ i ], i, obj[ i ] );\n\n\t\t\t\t\tif ( value === false ) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor ( i in obj ) {\n\t\t\t\t\tvalue = callback.call( obj[ i ], i, obj[ i ] );\n\n\t\t\t\t\tif ( value === false ) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn obj;\n\t},\n\n\t// Support: Android<4.1\n\ttrim: function( text ) {\n\t\treturn text == null ?\n\t\t\t\"\" :\n\t\t\t( text + \"\" ).replace( rtrim, \"\" );\n\t},\n\n\t// results is for internal usage only\n\tmakeArray: function( arr, results ) {\n\t\tvar ret = results || [];\n\n\t\tif ( arr != null ) {\n\t\t\tif ( isArraylike( Object(arr) ) ) {\n\t\t\t\tjQuery.merge( ret,\n\t\t\t\t\ttypeof arr === \"string\" ?\n\t\t\t\t\t[ arr ] : arr\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tpush.call( ret, arr );\n\t\t\t}\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tinArray: function( elem, arr, i ) {\n\t\treturn arr == null ? -1 : indexOf.call( arr, elem, i );\n\t},\n\n\tmerge: function( first, second ) {\n\t\tvar len = +second.length,\n\t\t\tj = 0,\n\t\t\ti = first.length;\n\n\t\tfor ( ; j < len; j++ ) {\n\t\t\tfirst[ i++ ] = second[ j ];\n\t\t}\n\n\t\tfirst.length = i;\n\n\t\treturn first;\n\t},\n\n\tgrep: function( elems, callback, invert ) {\n\t\tvar callbackInverse,\n\t\t\tmatches = [],\n\t\t\ti = 0,\n\t\t\tlength = elems.length,\n\t\t\tcallbackExpect = !invert;\n\n\t\t// Go through the array, only saving the items\n\t\t// that pass the validator function\n\t\tfor ( ; i < length; i++ ) {\n\t\t\tcallbackInverse = !callback( elems[ i ], i );\n\t\t\tif ( callbackInverse !== callbackExpect ) {\n\t\t\t\tmatches.push( elems[ i ] );\n\t\t\t}\n\t\t}\n\n\t\treturn matches;\n\t},\n\n\t// arg is for internal usage only\n\tmap: function( elems, callback, arg ) {\n\t\tvar value,\n\t\t\ti = 0,\n\t\t\tlength = elems.length,\n\t\t\tisArray = isArraylike( elems ),\n\t\t\tret = [];\n\n\t\t// Go through the array, translating each of the items to their new values\n\t\tif ( isArray ) {\n\t\t\tfor ( ; i < length; i++ ) {\n\t\t\t\tvalue = callback( elems[ i ], i, arg );\n\n\t\t\t\tif ( value != null ) {\n\t\t\t\t\tret.push( value );\n\t\t\t\t}\n\t\t\t}\n\n\t\t// Go through every key on the object,\n\t\t} else {\n\t\t\tfor ( i in elems ) {\n\t\t\t\tvalue = callback( elems[ i ], i, arg );\n\n\t\t\t\tif ( value != null ) {\n\t\t\t\t\tret.push( value );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Flatten any nested arrays\n\t\treturn concat.apply( [], ret );\n\t},\n\n\t// A global GUID counter for objects\n\tguid: 1,\n\n\t// Bind a function to a context, optionally partially applying any\n\t// arguments.\n\tproxy: function( fn, context ) {\n\t\tvar tmp, args, proxy;\n\n\t\tif ( typeof context === \"string\" ) {\n\t\t\ttmp = fn[ context ];\n\t\t\tcontext = fn;\n\t\t\tfn = tmp;\n\t\t}\n\n\t\t// Quick check to determine if target is callable, in the spec\n\t\t// this throws a TypeError, but we will just return undefined.\n\t\tif ( !jQuery.isFunction( fn ) ) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// Simulated bind\n\t\targs = slice.call( arguments, 2 );\n\t\tproxy = function() {\n\t\t\treturn fn.apply( context || this, args.concat( slice.call( arguments ) ) );\n\t\t};\n\n\t\t// Set the guid of unique handler to the same of original handler, so it can be removed\n\t\tproxy.guid = fn.guid = fn.guid || jQuery.guid++;\n\n\t\treturn proxy;\n\t},\n\n\tnow: Date.now,\n\n\t// jQuery.support is not used in Core but other projects attach their\n\t// properties to it so it needs to exist.\n\tsupport: support\n});\n\n// Populate the class2type map\njQuery.each(\"Boolean Number String Function Array Date RegExp Object Error\".split(\" \"), function(i, name) {\n\tclass2type[ \"[object \" + name + \"]\" ] = name.toLowerCase();\n});\n\nfunction isArraylike( obj ) {\n\tvar length = obj.length,\n\t\ttype = jQuery.type( obj );\n\n\tif ( type === \"function\" || jQuery.isWindow( obj ) ) {\n\t\treturn false;\n\t}\n\n\tif ( obj.nodeType === 1 && length ) {\n\t\treturn true;\n\t}\n\n\treturn type === \"array\" || length === 0 ||\n\t\ttypeof length === \"number\" && length > 0 && ( length - 1 ) in obj;\n}\nvar Sizzle =\n/*!\n * Sizzle CSS Selector Engine v1.10.19\n * http://sizzlejs.com/\n *\n * Copyright 2013 jQuery Foundation, Inc. and other contributors\n * Released under the MIT license\n * http://jquery.org/license\n *\n * Date: 2014-04-18\n */\n(function( window ) {\n\nvar i,\n\tsupport,\n\tExpr,\n\tgetText,\n\tisXML,\n\ttokenize,\n\tcompile,\n\tselect,\n\toutermostContext,\n\tsortInput,\n\thasDuplicate,\n\n\t// Local document vars\n\tsetDocument,\n\tdocument,\n\tdocElem,\n\tdocumentIsHTML,\n\trbuggyQSA,\n\trbuggyMatches,\n\tmatches,\n\tcontains,\n\n\t// Instance-specific data\n\texpando = \"sizzle\" + -(new Date()),\n\tpreferredDoc = window.document,\n\tdirruns = 0,\n\tdone = 0,\n\tclassCache = createCache(),\n\ttokenCache = createCache(),\n\tcompilerCache = createCache(),\n\tsortOrder = function( a, b ) {\n\t\tif ( a === b ) {\n\t\t\thasDuplicate = true;\n\t\t}\n\t\treturn 0;\n\t},\n\n\t// General-purpose constants\n\tstrundefined = typeof undefined,\n\tMAX_NEGATIVE = 1 << 31,\n\n\t// Instance methods\n\thasOwn = ({}).hasOwnProperty,\n\tarr = [],\n\tpop = arr.pop,\n\tpush_native = arr.push,\n\tpush = arr.push,\n\tslice = arr.slice,\n\t// Use a stripped-down indexOf if we can't use a native one\n\tindexOf = arr.indexOf || function( elem ) {\n\t\tvar i = 0,\n\t\t\tlen = this.length;\n\t\tfor ( ; i < len; i++ ) {\n\t\t\tif ( this[i] === elem ) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn -1;\n\t},\n\n\tbooleans = \"checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped\",\n\n\t// Regular expressions\n\n\t// Whitespace characters http://www.w3.org/TR/css3-selectors/#whitespace\n\twhitespace = \"[\\\\x20\\\\t\\\\r\\\\n\\\\f]\",\n\t// http://www.w3.org/TR/css3-syntax/#characters\n\tcharacterEncoding = \"(?:\\\\\\\\.|[\\\\w-]|[^\\\\x00-\\\\xa0])+\",\n\n\t// Loosely modeled on CSS identifier characters\n\t// An unquoted value should be a CSS identifier http://www.w3.org/TR/css3-selectors/#attribute-selectors\n\t// Proper syntax: http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier\n\tidentifier = characterEncoding.replace( \"w\", \"w#\" ),\n\n\t// Attribute selectors: http://www.w3.org/TR/selectors/#attribute-selectors\n\tattributes = \"\\\\[\" + whitespace + \"*(\" + characterEncoding + \")(?:\" + whitespace +\n\t\t// Operator (capture 2)\n\t\t\"*([*^$|!~]?=)\" + whitespace +\n\t\t// \"Attribute values must be CSS identifiers [capture 5] or strings [capture 3 or capture 4]\"\n\t\t\"*(?:'((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\"|(\" + identifier + \"))|)\" + whitespace +\n\t\t\"*\\\\]\",\n\n\tpseudos = \":(\" + characterEncoding + \")(?:\\\\((\" +\n\t\t// To reduce the number of selectors needing tokenize in the preFilter, prefer arguments:\n\t\t// 1. quoted (capture 3; capture 4 or capture 5)\n\t\t\"('((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\")|\" +\n\t\t// 2. simple (capture 6)\n\t\t\"((?:\\\\\\\\.|[^\\\\\\\\()[\\\\]]|\" + attributes + \")*)|\" +\n\t\t// 3. anything else (capture 2)\n\t\t\".*\" +\n\t\t\")\\\\)|)\",\n\n\t// Leading and non-escaped trailing whitespace, capturing some non-whitespace characters preceding the latter\n\trtrim = new RegExp( \"^\" + whitespace + \"+|((?:^|[^\\\\\\\\])(?:\\\\\\\\.)*)\" + whitespace + \"+$\", \"g\" ),\n\n\trcomma = new RegExp( \"^\" + whitespace + \"*,\" + whitespace + \"*\" ),\n\trcombinators = new RegExp( \"^\" + whitespace + \"*([>+~]|\" + whitespace + \")\" + whitespace + \"*\" ),\n\n\trattributeQuotes = new RegExp( \"=\" + whitespace + \"*([^\\\\]'\\\"]*?)\" + whitespace + \"*\\\\]\", \"g\" ),\n\n\trpseudo = new RegExp( pseudos ),\n\tridentifier = new RegExp( \"^\" + identifier + \"$\" ),\n\n\tmatchExpr = {\n\t\t\"ID\": new RegExp( \"^#(\" + characterEncoding + \")\" ),\n\t\t\"CLASS\": new RegExp( \"^\\\\.(\" + characterEncoding + \")\" ),\n\t\t\"TAG\": new RegExp( \"^(\" + characterEncoding.replace( \"w\", \"w*\" ) + \")\" ),\n\t\t\"ATTR\": new RegExp( \"^\" + attributes ),\n\t\t\"PSEUDO\": new RegExp( \"^\" + pseudos ),\n\t\t\"CHILD\": new RegExp( \"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\(\" + whitespace +\n\t\t\t\"*(even|odd|(([+-]|)(\\\\d*)n|)\" + whitespace + \"*(?:([+-]|)\" + whitespace +\n\t\t\t\"*(\\\\d+)|))\" + whitespace + \"*\\\\)|)\", \"i\" ),\n\t\t\"bool\": new RegExp( \"^(?:\" + booleans + \")$\", \"i\" ),\n\t\t// For use in libraries implementing .is()\n\t\t// We use this for POS matching in `select`\n\t\t\"needsContext\": new RegExp( \"^\" + whitespace + \"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\(\" +\n\t\t\twhitespace + \"*((?:-\\\\d)?\\\\d*)\" + whitespace + \"*\\\\)|)(?=[^-]|$)\", \"i\" )\n\t},\n\n\trinputs = /^(?:input|select|textarea|button)$/i,\n\trheader = /^h\\d$/i,\n\n\trnative = /^[^{]+\\{\\s*\\[native \\w/,\n\n\t// Easily-parseable/retrievable ID or TAG or CLASS selectors\n\trquickExpr = /^(?:#([\\w-]+)|(\\w+)|\\.([\\w-]+))$/,\n\n\trsibling = /[+~]/,\n\trescape = /'|\\\\/g,\n\n\t// CSS escapes http://www.w3.org/TR/CSS21/syndata.html#escaped-characters\n\trunescape = new RegExp( \"\\\\\\\\([\\\\da-f]{1,6}\" + whitespace + \"?|(\" + whitespace + \")|.)\", \"ig\" ),\n\tfunescape = function( _, escaped, escapedWhitespace ) {\n\t\tvar high = \"0x\" + escaped - 0x10000;\n\t\t// NaN means non-codepoint\n\t\t// Support: Firefox<24\n\t\t// Workaround erroneous numeric interpretation of +\"0x\"\n\t\treturn high !== high || escapedWhitespace ?\n\t\t\tescaped :\n\t\t\thigh < 0 ?\n\t\t\t\t// BMP codepoint\n\t\t\t\tString.fromCharCode( high + 0x10000 ) :\n\t\t\t\t// Supplemental Plane codepoint (surrogate pair)\n\t\t\t\tString.fromCharCode( high >> 10 | 0xD800, high & 0x3FF | 0xDC00 );\n\t};\n\n// Optimize for push.apply( _, NodeList )\ntry {\n\tpush.apply(\n\t\t(arr = slice.call( preferredDoc.childNodes )),\n\t\tpreferredDoc.childNodes\n\t);\n\t// Support: Android<4.0\n\t// Detect silently failing push.apply\n\tarr[ preferredDoc.childNodes.length ].nodeType;\n} catch ( e ) {\n\tpush = { apply: arr.length ?\n\n\t\t// Leverage slice if possible\n\t\tfunction( target, els ) {\n\t\t\tpush_native.apply( target, slice.call(els) );\n\t\t} :\n\n\t\t// Support: IE<9\n\t\t// Otherwise append directly\n\t\tfunction( target, els ) {\n\t\t\tvar j = target.length,\n\t\t\t\ti = 0;\n\t\t\t// Can't trust NodeList.length\n\t\t\twhile ( (target[j++] = els[i++]) ) {}\n\t\t\ttarget.length = j - 1;\n\t\t}\n\t};\n}\n\nfunction Sizzle( selector, context, results, seed ) {\n\tvar match, elem, m, nodeType,\n\t\t// QSA vars\n\t\ti, groups, old, nid, newContext, newSelector;\n\n\tif ( ( context ? context.ownerDocument || context : preferredDoc ) !== document ) {\n\t\tsetDocument( context );\n\t}\n\n\tcontext = context || document;\n\tresults = results || [];\n\n\tif ( !selector || typeof selector !== \"string\" ) {\n\t\treturn results;\n\t}\n\n\tif ( (nodeType = context.nodeType) !== 1 && nodeType !== 9 ) {\n\t\treturn [];\n\t}\n\n\tif ( documentIsHTML && !seed ) {\n\n\t\t// Shortcuts\n\t\tif ( (match = rquickExpr.exec( selector )) ) {\n\t\t\t// Speed-up: Sizzle(\"#ID\")\n\t\t\tif ( (m = match[1]) ) {\n\t\t\t\tif ( nodeType === 9 ) {\n\t\t\t\t\telem = context.getElementById( m );\n\t\t\t\t\t// Check parentNode to catch when Blackberry 4.6 returns\n\t\t\t\t\t// nodes that are no longer in the document (jQuery #6963)\n\t\t\t\t\tif ( elem && elem.parentNode ) {\n\t\t\t\t\t\t// Handle the case where IE, Opera, and Webkit return items\n\t\t\t\t\t\t// by name instead of ID\n\t\t\t\t\t\tif ( elem.id === m ) {\n\t\t\t\t\t\t\tresults.push( elem );\n\t\t\t\t\t\t\treturn results;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn results;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// Context is not a document\n\t\t\t\t\tif ( context.ownerDocument && (elem = context.ownerDocument.getElementById( m )) &&\n\t\t\t\t\t\tcontains( context, elem ) && elem.id === m ) {\n\t\t\t\t\t\tresults.push( elem );\n\t\t\t\t\t\treturn results;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t// Speed-up: Sizzle(\"TAG\")\n\t\t\t} else if ( match[2] ) {\n\t\t\t\tpush.apply( results, context.getElementsByTagName( selector ) );\n\t\t\t\treturn results;\n\n\t\t\t// Speed-up: Sizzle(\".CLASS\")\n\t\t\t} else if ( (m = match[3]) && support.getElementsByClassName && context.getElementsByClassName ) {\n\t\t\t\tpush.apply( results, context.getElementsByClassName( m ) );\n\t\t\t\treturn results;\n\t\t\t}\n\t\t}\n\n\t\t// QSA path\n\t\tif ( support.qsa && (!rbuggyQSA || !rbuggyQSA.test( selector )) ) {\n\t\t\tnid = old = expando;\n\t\t\tnewContext = context;\n\t\t\tnewSelector = nodeType === 9 && selector;\n\n\t\t\t// qSA works strangely on Element-rooted queries\n\t\t\t// We can work around this by specifying an extra ID on the root\n\t\t\t// and working up from there (Thanks to Andrew Dupont for the technique)\n\t\t\t// IE 8 doesn't work on object elements\n\t\t\tif ( nodeType === 1 && context.nodeName.toLowerCase() !== \"object\" ) {\n\t\t\t\tgroups = tokenize( selector );\n\n\t\t\t\tif ( (old = context.getAttribute(\"id\")) ) {\n\t\t\t\t\tnid = old.replace( rescape, \"\\\\$&\" );\n\t\t\t\t} else {\n\t\t\t\t\tcontext.setAttribute( \"id\", nid );\n\t\t\t\t}\n\t\t\t\tnid = \"[id='\" + nid + \"'] \";\n\n\t\t\t\ti = groups.length;\n\t\t\t\twhile ( i-- ) {\n\t\t\t\t\tgroups[i] = nid + toSelector( groups[i] );\n\t\t\t\t}\n\t\t\t\tnewContext = rsibling.test( selector ) && testContext( context.parentNode ) || context;\n\t\t\t\tnewSelector = groups.join(\",\");\n\t\t\t}\n\n\t\t\tif ( newSelector ) {\n\t\t\t\ttry {\n\t\t\t\t\tpush.apply( results,\n\t\t\t\t\t\tnewContext.querySelectorAll( newSelector )\n\t\t\t\t\t);\n\t\t\t\t\treturn results;\n\t\t\t\t} catch(qsaError) {\n\t\t\t\t} finally {\n\t\t\t\t\tif ( !old ) {\n\t\t\t\t\t\tcontext.removeAttribute(\"id\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// All others\n\treturn select( selector.replace( rtrim, \"$1\" ), context, results, seed );\n}\n\n/**\n * Create key-value caches of limited size\n * @returns {Function(string, Object)} Returns the Object data after storing it on itself with\n *\tproperty name the (space-suffixed) string and (if the cache is larger than Expr.cacheLength)\n *\tdeleting the oldest entry\n */\nfunction createCache() {\n\tvar keys = [];\n\n\tfunction cache( key, value ) {\n\t\t// Use (key + \" \") to avoid collision with native prototype properties (see Issue #157)\n\t\tif ( keys.push( key + \" \" ) > Expr.cacheLength ) {\n\t\t\t// Only keep the most recent entries\n\t\t\tdelete cache[ keys.shift() ];\n\t\t}\n\t\treturn (cache[ key + \" \" ] = value);\n\t}\n\treturn cache;\n}\n\n/**\n * Mark a function for special use by Sizzle\n * @param {Function} fn The function to mark\n */\nfunction markFunction( fn ) {\n\tfn[ expando ] = true;\n\treturn fn;\n}\n\n/**\n * Support testing using an element\n * @param {Function} fn Passed the created div and expects a boolean result\n */\nfunction assert( fn ) {\n\tvar div = document.createElement(\"div\");\n\n\ttry {\n\t\treturn !!fn( div );\n\t} catch (e) {\n\t\treturn false;\n\t} finally {\n\t\t// Remove from its parent by default\n\t\tif ( div.parentNode ) {\n\t\t\tdiv.parentNode.removeChild( div );\n\t\t}\n\t\t// release memory in IE\n\t\tdiv = null;\n\t}\n}\n\n/**\n * Adds the same handler for all of the specified attrs\n * @param {String} attrs Pipe-separated list of attributes\n * @param {Function} handler The method that will be applied\n */\nfunction addHandle( attrs, handler ) {\n\tvar arr = attrs.split(\"|\"),\n\t\ti = attrs.length;\n\n\twhile ( i-- ) {\n\t\tExpr.attrHandle[ arr[i] ] = handler;\n\t}\n}\n\n/**\n * Checks document order of two siblings\n * @param {Element} a\n * @param {Element} b\n * @returns {Number} Returns less than 0 if a precedes b, greater than 0 if a follows b\n */\nfunction siblingCheck( a, b ) {\n\tvar cur = b && a,\n\t\tdiff = cur && a.nodeType === 1 && b.nodeType === 1 &&\n\t\t\t( ~b.sourceIndex || MAX_NEGATIVE ) -\n\t\t\t( ~a.sourceIndex || MAX_NEGATIVE );\n\n\t// Use IE sourceIndex if available on both nodes\n\tif ( diff ) {\n\t\treturn diff;\n\t}\n\n\t// Check if b follows a\n\tif ( cur ) {\n\t\twhile ( (cur = cur.nextSibling) ) {\n\t\t\tif ( cur === b ) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn a ? 1 : -1;\n}\n\n/**\n * Returns a function to use in pseudos for input types\n * @param {String} type\n */\nfunction createInputPseudo( type ) {\n\treturn function( elem ) {\n\t\tvar name = elem.nodeName.toLowerCase();\n\t\treturn name === \"input\" && elem.type === type;\n\t};\n}\n\n/**\n * Returns a function to use in pseudos for buttons\n * @param {String} type\n */\nfunction createButtonPseudo( type ) {\n\treturn function( elem ) {\n\t\tvar name = elem.nodeName.toLowerCase();\n\t\treturn (name === \"input\" || name === \"button\") && elem.type === type;\n\t};\n}\n\n/**\n * Returns a function to use in pseudos for positionals\n * @param {Function} fn\n */\nfunction createPositionalPseudo( fn ) {\n\treturn markFunction(function( argument ) {\n\t\targument = +argument;\n\t\treturn markFunction(function( seed, matches ) {\n\t\t\tvar j,\n\t\t\t\tmatchIndexes = fn( [], seed.length, argument ),\n\t\t\t\ti = matchIndexes.length;\n\n\t\t\t// Match elements found at the specified indexes\n\t\t\twhile ( i-- ) {\n\t\t\t\tif ( seed[ (j = matchIndexes[i]) ] ) {\n\t\t\t\t\tseed[j] = !(matches[j] = seed[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n}\n\n/**\n * Checks a node for validity as a Sizzle context\n * @param {Element|Object=} context\n * @returns {Element|Object|Boolean} The input node if acceptable, otherwise a falsy value\n */\nfunction testContext( context ) {\n\treturn context && typeof context.getElementsByTagName !== strundefined && context;\n}\n\n// Expose support vars for convenience\nsupport = Sizzle.support = {};\n\n/**\n * Detects XML nodes\n * @param {Element|Object} elem An element or a document\n * @returns {Boolean} True iff elem is a non-HTML XML node\n */\nisXML = Sizzle.isXML = function( elem ) {\n\t// documentElement is verified for cases where it doesn't yet exist\n\t// (such as loading iframes in IE - #4833)\n\tvar documentElement = elem && (elem.ownerDocument || elem).documentElement;\n\treturn documentElement ? documentElement.nodeName !== \"HTML\" : false;\n};\n\n/**\n * Sets document-related variables once based on the current document\n * @param {Element|Object} [doc] An element or document object to use to set the document\n * @returns {Object} Returns the current document\n */\nsetDocument = Sizzle.setDocument = function( node ) {\n\tvar hasCompare,\n\t\tdoc = node ? node.ownerDocument || node : preferredDoc,\n\t\tparent = doc.defaultView;\n\n\t// If no document and documentElement is available, return\n\tif ( doc === document || doc.nodeType !== 9 || !doc.documentElement ) {\n\t\treturn document;\n\t}\n\n\t// Set our document\n\tdocument = doc;\n\tdocElem = doc.documentElement;\n\n\t// Support tests\n\tdocumentIsHTML = !isXML( doc );\n\n\t// Support: IE>8\n\t// If iframe document is assigned to \"document\" variable and if iframe has been reloaded,\n\t// IE will throw \"permission denied\" error when accessing \"document\" variable, see jQuery #13936\n\t// IE6-8 do not support the defaultView property so parent will be undefined\n\tif ( parent && parent !== parent.top ) {\n\t\t// IE11 does not have attachEvent, so all must suffer\n\t\tif ( parent.addEventListener ) {\n\t\t\tparent.addEventListener( \"unload\", function() {\n\t\t\t\tsetDocument();\n\t\t\t}, false );\n\t\t} else if ( parent.attachEvent ) {\n\t\t\tparent.attachEvent( \"onunload\", function() {\n\t\t\t\tsetDocument();\n\t\t\t});\n\t\t}\n\t}\n\n\t/* Attributes\n\t---------------------------------------------------------------------- */\n\n\t// Support: IE<8\n\t// Verify that getAttribute really returns attributes and not properties (excepting IE8 booleans)\n\tsupport.attributes = assert(function( div ) {\n\t\tdiv.className = \"i\";\n\t\treturn !div.getAttribute(\"className\");\n\t});\n\n\t/* getElement(s)By*\n\t---------------------------------------------------------------------- */\n\n\t// Check if getElementsByTagName(\"*\") returns only elements\n\tsupport.getElementsByTagName = assert(function( div ) {\n\t\tdiv.appendChild( doc.createComment(\"\") );\n\t\treturn !div.getElementsByTagName(\"*\").length;\n\t});\n\n\t// Check if getElementsByClassName can be trusted\n\tsupport.getElementsByClassName = rnative.test( doc.getElementsByClassName ) && assert(function( div ) {\n\t\tdiv.innerHTML = \"<div class='a'></div><div class='a i'></div>\";\n\n\t\t// Support: Safari<4\n\t\t// Catch class over-caching\n\t\tdiv.firstChild.className = \"i\";\n\t\t// Support: Opera<10\n\t\t// Catch gEBCN failure to find non-leading classes\n\t\treturn div.getElementsByClassName(\"i\").length === 2;\n\t});\n\n\t// Support: IE<10\n\t// Check if getElementById returns elements by name\n\t// The broken getElementById methods don't pick up programatically-set names,\n\t// so use a roundabout getElementsByName test\n\tsupport.getById = assert(function( div ) {\n\t\tdocElem.appendChild( div ).id = expando;\n\t\treturn !doc.getElementsByName || !doc.getElementsByName( expando ).length;\n\t});\n\n\t// ID find and filter\n\tif ( support.getById ) {\n\t\tExpr.find[\"ID\"] = function( id, context ) {\n\t\t\tif ( typeof context.getElementById !== strundefined && documentIsHTML ) {\n\t\t\t\tvar m = context.getElementById( id );\n\t\t\t\t// Check parentNode to catch when Blackberry 4.6 returns\n\t\t\t\t// nodes that are no longer in the document #6963\n\t\t\t\treturn m && m.parentNode ? [ m ] : [];\n\t\t\t}\n\t\t};\n\t\tExpr.filter[\"ID\"] = function( id ) {\n\t\t\tvar attrId = id.replace( runescape, funescape );\n\t\t\treturn function( elem ) {\n\t\t\t\treturn elem.getAttribute(\"id\") === attrId;\n\t\t\t};\n\t\t};\n\t} else {\n\t\t// Support: IE6/7\n\t\t// getElementById is not reliable as a find shortcut\n\t\tdelete Expr.find[\"ID\"];\n\n\t\tExpr.filter[\"ID\"] =  function( id ) {\n\t\t\tvar attrId = id.replace( runescape, funescape );\n\t\t\treturn function( elem ) {\n\t\t\t\tvar node = typeof elem.getAttributeNode !== strundefined && elem.getAttributeNode(\"id\");\n\t\t\t\treturn node && node.value === attrId;\n\t\t\t};\n\t\t};\n\t}\n\n\t// Tag\n\tExpr.find[\"TAG\"] = support.getElementsByTagName ?\n\t\tfunction( tag, context ) {\n\t\t\tif ( typeof context.getElementsByTagName !== strundefined ) {\n\t\t\t\treturn context.getElementsByTagName( tag );\n\t\t\t}\n\t\t} :\n\t\tfunction( tag, context ) {\n\t\t\tvar elem,\n\t\t\t\ttmp = [],\n\t\t\t\ti = 0,\n\t\t\t\tresults = context.getElementsByTagName( tag );\n\n\t\t\t// Filter out possible comments\n\t\t\tif ( tag === \"*\" ) {\n\t\t\t\twhile ( (elem = results[i++]) ) {\n\t\t\t\t\tif ( elem.nodeType === 1 ) {\n\t\t\t\t\t\ttmp.push( elem );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn tmp;\n\t\t\t}\n\t\t\treturn results;\n\t\t};\n\n\t// Class\n\tExpr.find[\"CLASS\"] = support.getElementsByClassName && function( className, context ) {\n\t\tif ( typeof context.getElementsByClassName !== strundefined && documentIsHTML ) {\n\t\t\treturn context.getElementsByClassName( className );\n\t\t}\n\t};\n\n\t/* QSA/matchesSelector\n\t---------------------------------------------------------------------- */\n\n\t// QSA and matchesSelector support\n\n\t// matchesSelector(:active) reports false when true (IE9/Opera 11.5)\n\trbuggyMatches = [];\n\n\t// qSa(:focus) reports false when true (Chrome 21)\n\t// We allow this because of a bug in IE8/9 that throws an error\n\t// whenever `document.activeElement` is accessed on an iframe\n\t// So, we allow :focus to pass through QSA all the time to avoid the IE error\n\t// See http://bugs.jquery.com/ticket/13378\n\trbuggyQSA = [];\n\n\tif ( (support.qsa = rnative.test( doc.querySelectorAll )) ) {\n\t\t// Build QSA regex\n\t\t// Regex strategy adopted from Diego Perini\n\t\tassert(function( div ) {\n\t\t\t// Select is set to empty string on purpose\n\t\t\t// This is to test IE's treatment of not explicitly\n\t\t\t// setting a boolean content attribute,\n\t\t\t// since its presence should be enough\n\t\t\t// http://bugs.jquery.com/ticket/12359\n\t\t\tdiv.innerHTML = \"<select msallowclip=''><option selected=''></option></select>\";\n\n\t\t\t// Support: IE8, Opera 11-12.16\n\t\t\t// Nothing should be selected when empty strings follow ^= or $= or *=\n\t\t\t// The test attribute must be unknown in Opera but \"safe\" for WinRT\n\t\t\t// http://msdn.microsoft.com/en-us/library/ie/hh465388.aspx#attribute_section\n\t\t\tif ( div.querySelectorAll(\"[msallowclip^='']\").length ) {\n\t\t\t\trbuggyQSA.push( \"[*^$]=\" + whitespace + \"*(?:''|\\\"\\\")\" );\n\t\t\t}\n\n\t\t\t// Support: IE8\n\t\t\t// Boolean attributes and \"value\" are not treated correctly\n\t\t\tif ( !div.querySelectorAll(\"[selected]\").length ) {\n\t\t\t\trbuggyQSA.push( \"\\\\[\" + whitespace + \"*(?:value|\" + booleans + \")\" );\n\t\t\t}\n\n\t\t\t// Webkit/Opera - :checked should return selected option elements\n\t\t\t// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked\n\t\t\t// IE8 throws error here and will not see later tests\n\t\t\tif ( !div.querySelectorAll(\":checked\").length ) {\n\t\t\t\trbuggyQSA.push(\":checked\");\n\t\t\t}\n\t\t});\n\n\t\tassert(function( div ) {\n\t\t\t// Support: Windows 8 Native Apps\n\t\t\t// The type and name attributes are restricted during .innerHTML assignment\n\t\t\tvar input = doc.createElement(\"input\");\n\t\t\tinput.setAttribute( \"type\", \"hidden\" );\n\t\t\tdiv.appendChild( input ).setAttribute( \"name\", \"D\" );\n\n\t\t\t// Support: IE8\n\t\t\t// Enforce case-sensitivity of name attribute\n\t\t\tif ( div.querySelectorAll(\"[name=d]\").length ) {\n\t\t\t\trbuggyQSA.push( \"name\" + whitespace + \"*[*^$|!~]?=\" );\n\t\t\t}\n\n\t\t\t// FF 3.5 - :enabled/:disabled and hidden elements (hidden elements are still enabled)\n\t\t\t// IE8 throws error here and will not see later tests\n\t\t\tif ( !div.querySelectorAll(\":enabled\").length ) {\n\t\t\t\trbuggyQSA.push( \":enabled\", \":disabled\" );\n\t\t\t}\n\n\t\t\t// Opera 10-11 does not throw on post-comma invalid pseudos\n\t\t\tdiv.querySelectorAll(\"*,:x\");\n\t\t\trbuggyQSA.push(\",.*:\");\n\t\t});\n\t}\n\n\tif ( (support.matchesSelector = rnative.test( (matches = docElem.matches ||\n\t\tdocElem.webkitMatchesSelector ||\n\t\tdocElem.mozMatchesSelector ||\n\t\tdocElem.oMatchesSelector ||\n\t\tdocElem.msMatchesSelector) )) ) {\n\n\t\tassert(function( div ) {\n\t\t\t// Check to see if it's possible to do matchesSelector\n\t\t\t// on a disconnected node (IE 9)\n\t\t\tsupport.disconnectedMatch = matches.call( div, \"div\" );\n\n\t\t\t// This should fail with an exception\n\t\t\t// Gecko does not error, returns false instead\n\t\t\tmatches.call( div, \"[s!='']:x\" );\n\t\t\trbuggyMatches.push( \"!=\", pseudos );\n\t\t});\n\t}\n\n\trbuggyQSA = rbuggyQSA.length && new RegExp( rbuggyQSA.join(\"|\") );\n\trbuggyMatches = rbuggyMatches.length && new RegExp( rbuggyMatches.join(\"|\") );\n\n\t/* Contains\n\t---------------------------------------------------------------------- */\n\thasCompare = rnative.test( docElem.compareDocumentPosition );\n\n\t// Element contains another\n\t// Purposefully does not implement inclusive descendent\n\t// As in, an element does not contain itself\n\tcontains = hasCompare || rnative.test( docElem.contains ) ?\n\t\tfunction( a, b ) {\n\t\t\tvar adown = a.nodeType === 9 ? a.documentElement : a,\n\t\t\t\tbup = b && b.parentNode;\n\t\t\treturn a === bup || !!( bup && bup.nodeType === 1 && (\n\t\t\t\tadown.contains ?\n\t\t\t\t\tadown.contains( bup ) :\n\t\t\t\t\ta.compareDocumentPosition && a.compareDocumentPosition( bup ) & 16\n\t\t\t));\n\t\t} :\n\t\tfunction( a, b ) {\n\t\t\tif ( b ) {\n\t\t\t\twhile ( (b = b.parentNode) ) {\n\t\t\t\t\tif ( b === a ) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t};\n\n\t/* Sorting\n\t---------------------------------------------------------------------- */\n\n\t// Document order sorting\n\tsortOrder = hasCompare ?\n\tfunction( a, b ) {\n\n\t\t// Flag for duplicate removal\n\t\tif ( a === b ) {\n\t\t\thasDuplicate = true;\n\t\t\treturn 0;\n\t\t}\n\n\t\t// Sort on method existence if only one input has compareDocumentPosition\n\t\tvar compare = !a.compareDocumentPosition - !b.compareDocumentPosition;\n\t\tif ( compare ) {\n\t\t\treturn compare;\n\t\t}\n\n\t\t// Calculate position if both inputs belong to the same document\n\t\tcompare = ( a.ownerDocument || a ) === ( b.ownerDocument || b ) ?\n\t\t\ta.compareDocumentPosition( b ) :\n\n\t\t\t// Otherwise we know they are disconnected\n\t\t\t1;\n\n\t\t// Disconnected nodes\n\t\tif ( compare & 1 ||\n\t\t\t(!support.sortDetached && b.compareDocumentPosition( a ) === compare) ) {\n\n\t\t\t// Choose the first element that is related to our preferred document\n\t\t\tif ( a === doc || a.ownerDocument === preferredDoc && contains(preferredDoc, a) ) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif ( b === doc || b.ownerDocument === preferredDoc && contains(preferredDoc, b) ) {\n\t\t\t\treturn 1;\n\t\t\t}\n\n\t\t\t// Maintain original order\n\t\t\treturn sortInput ?\n\t\t\t\t( indexOf.call( sortInput, a ) - indexOf.call( sortInput, b ) ) :\n\t\t\t\t0;\n\t\t}\n\n\t\treturn compare & 4 ? -1 : 1;\n\t} :\n\tfunction( a, b ) {\n\t\t// Exit early if the nodes are identical\n\t\tif ( a === b ) {\n\t\t\thasDuplicate = true;\n\t\t\treturn 0;\n\t\t}\n\n\t\tvar cur,\n\t\t\ti = 0,\n\t\t\taup = a.parentNode,\n\t\t\tbup = b.parentNode,\n\t\t\tap = [ a ],\n\t\t\tbp = [ b ];\n\n\t\t// Parentless nodes are either documents or disconnected\n\t\tif ( !aup || !bup ) {\n\t\t\treturn a === doc ? -1 :\n\t\t\t\tb === doc ? 1 :\n\t\t\t\taup ? -1 :\n\t\t\t\tbup ? 1 :\n\t\t\t\tsortInput ?\n\t\t\t\t( indexOf.call( sortInput, a ) - indexOf.call( sortInput, b ) ) :\n\t\t\t\t0;\n\n\t\t// If the nodes are siblings, we can do a quick check\n\t\t} else if ( aup === bup ) {\n\t\t\treturn siblingCheck( a, b );\n\t\t}\n\n\t\t// Otherwise we need full lists of their ancestors for comparison\n\t\tcur = a;\n\t\twhile ( (cur = cur.parentNode) ) {\n\t\t\tap.unshift( cur );\n\t\t}\n\t\tcur = b;\n\t\twhile ( (cur = cur.parentNode) ) {\n\t\t\tbp.unshift( cur );\n\t\t}\n\n\t\t// Walk down the tree looking for a discrepancy\n\t\twhile ( ap[i] === bp[i] ) {\n\t\t\ti++;\n\t\t}\n\n\t\treturn i ?\n\t\t\t// Do a sibling check if the nodes have a common ancestor\n\t\t\tsiblingCheck( ap[i], bp[i] ) :\n\n\t\t\t// Otherwise nodes in our document sort first\n\t\t\tap[i] === preferredDoc ? -1 :\n\t\t\tbp[i] === preferredDoc ? 1 :\n\t\t\t0;\n\t};\n\n\treturn doc;\n};\n\nSizzle.matches = function( expr, elements ) {\n\treturn Sizzle( expr, null, null, elements );\n};\n\nSizzle.matchesSelector = function( elem, expr ) {\n\t// Set document vars if needed\n\tif ( ( elem.ownerDocument || elem ) !== document ) {\n\t\tsetDocument( elem );\n\t}\n\n\t// Make sure that attribute selectors are quoted\n\texpr = expr.replace( rattributeQuotes, \"='$1']\" );\n\n\tif ( support.matchesSelector && documentIsHTML &&\n\t\t( !rbuggyMatches || !rbuggyMatches.test( expr ) ) &&\n\t\t( !rbuggyQSA     || !rbuggyQSA.test( expr ) ) ) {\n\n\t\ttry {\n\t\t\tvar ret = matches.call( elem, expr );\n\n\t\t\t// IE 9's matchesSelector returns false on disconnected nodes\n\t\t\tif ( ret || support.disconnectedMatch ||\n\t\t\t\t\t// As well, disconnected nodes are said to be in a document\n\t\t\t\t\t// fragment in IE 9\n\t\t\t\t\telem.document && elem.document.nodeType !== 11 ) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t} catch(e) {}\n\t}\n\n\treturn Sizzle( expr, document, null, [ elem ] ).length > 0;\n};\n\nSizzle.contains = function( context, elem ) {\n\t// Set document vars if needed\n\tif ( ( context.ownerDocument || context ) !== document ) {\n\t\tsetDocument( context );\n\t}\n\treturn contains( context, elem );\n};\n\nSizzle.attr = function( elem, name ) {\n\t// Set document vars if needed\n\tif ( ( elem.ownerDocument || elem ) !== document ) {\n\t\tsetDocument( elem );\n\t}\n\n\tvar fn = Expr.attrHandle[ name.toLowerCase() ],\n\t\t// Don't get fooled by Object.prototype properties (jQuery #13807)\n\t\tval = fn && hasOwn.call( Expr.attrHandle, name.toLowerCase() ) ?\n\t\t\tfn( elem, name, !documentIsHTML ) :\n\t\t\tundefined;\n\n\treturn val !== undefined ?\n\t\tval :\n\t\tsupport.attributes || !documentIsHTML ?\n\t\t\telem.getAttribute( name ) :\n\t\t\t(val = elem.getAttributeNode(name)) && val.specified ?\n\t\t\t\tval.value :\n\t\t\t\tnull;\n};\n\nSizzle.error = function( msg ) {\n\tthrow new Error( \"Syntax error, unrecognized expression: \" + msg );\n};\n\n/**\n * Document sorting and removing duplicates\n * @param {ArrayLike} results\n */\nSizzle.uniqueSort = function( results ) {\n\tvar elem,\n\t\tduplicates = [],\n\t\tj = 0,\n\t\ti = 0;\n\n\t// Unless we *know* we can detect duplicates, assume their presence\n\thasDuplicate = !support.detectDuplicates;\n\tsortInput = !support.sortStable && results.slice( 0 );\n\tresults.sort( sortOrder );\n\n\tif ( hasDuplicate ) {\n\t\twhile ( (elem = results[i++]) ) {\n\t\t\tif ( elem === results[ i ] ) {\n\t\t\t\tj = duplicates.push( i );\n\t\t\t}\n\t\t}\n\t\twhile ( j-- ) {\n\t\t\tresults.splice( duplicates[ j ], 1 );\n\t\t}\n\t}\n\n\t// Clear input after sorting to release objects\n\t// See https://github.com/jquery/sizzle/pull/225\n\tsortInput = null;\n\n\treturn results;\n};\n\n/**\n * Utility function for retrieving the text value of an array of DOM nodes\n * @param {Array|Element} elem\n */\ngetText = Sizzle.getText = function( elem ) {\n\tvar node,\n\t\tret = \"\",\n\t\ti = 0,\n\t\tnodeType = elem.nodeType;\n\n\tif ( !nodeType ) {\n\t\t// If no nodeType, this is expected to be an array\n\t\twhile ( (node = elem[i++]) ) {\n\t\t\t// Do not traverse comment nodes\n\t\t\tret += getText( node );\n\t\t}\n\t} else if ( nodeType === 1 || nodeType === 9 || nodeType === 11 ) {\n\t\t// Use textContent for elements\n\t\t// innerText usage removed for consistency of new lines (jQuery #11153)\n\t\tif ( typeof elem.textContent === \"string\" ) {\n\t\t\treturn elem.textContent;\n\t\t} else {\n\t\t\t// Traverse its children\n\t\t\tfor ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {\n\t\t\t\tret += getText( elem );\n\t\t\t}\n\t\t}\n\t} else if ( nodeType === 3 || nodeType === 4 ) {\n\t\treturn elem.nodeValue;\n\t}\n\t// Do not include comment or processing instruction nodes\n\n\treturn ret;\n};\n\nExpr = Sizzle.selectors = {\n\n\t// Can be adjusted by the user\n\tcacheLength: 50,\n\n\tcreatePseudo: markFunction,\n\n\tmatch: matchExpr,\n\n\tattrHandle: {},\n\n\tfind: {},\n\n\trelative: {\n\t\t\">\": { dir: \"parentNode\", first: true },\n\t\t\" \": { dir: \"parentNode\" },\n\t\t\"+\": { dir: \"previousSibling\", first: true },\n\t\t\"~\": { dir: \"previousSibling\" }\n\t},\n\n\tpreFilter: {\n\t\t\"ATTR\": function( match ) {\n\t\t\tmatch[1] = match[1].replace( runescape, funescape );\n\n\t\t\t// Move the given value to match[3] whether quoted or unquoted\n\t\t\tmatch[3] = ( match[3] || match[4] || match[5] || \"\" ).replace( runescape, funescape );\n\n\t\t\tif ( match[2] === \"~=\" ) {\n\t\t\t\tmatch[3] = \" \" + match[3] + \" \";\n\t\t\t}\n\n\t\t\treturn match.slice( 0, 4 );\n\t\t},\n\n\t\t\"CHILD\": function( match ) {\n\t\t\t/* matches from matchExpr[\"CHILD\"]\n\t\t\t\t1 type (only|nth|...)\n\t\t\t\t2 what (child|of-type)\n\t\t\t\t3 argument (even|odd|\\d*|\\d*n([+-]\\d+)?|...)\n\t\t\t\t4 xn-component of xn+y argument ([+-]?\\d*n|)\n\t\t\t\t5 sign of xn-component\n\t\t\t\t6 x of xn-component\n\t\t\t\t7 sign of y-component\n\t\t\t\t8 y of y-component\n\t\t\t*/\n\t\t\tmatch[1] = match[1].toLowerCase();\n\n\t\t\tif ( match[1].slice( 0, 3 ) === \"nth\" ) {\n\t\t\t\t// nth-* requires argument\n\t\t\t\tif ( !match[3] ) {\n\t\t\t\t\tSizzle.error( match[0] );\n\t\t\t\t}\n\n\t\t\t\t// numeric x and y parameters for Expr.filter.CHILD\n\t\t\t\t// remember that false/true cast respectively to 0/1\n\t\t\t\tmatch[4] = +( match[4] ? match[5] + (match[6] || 1) : 2 * ( match[3] === \"even\" || match[3] === \"odd\" ) );\n\t\t\t\tmatch[5] = +( ( match[7] + match[8] ) || match[3] === \"odd\" );\n\n\t\t\t// other types prohibit arguments\n\t\t\t} else if ( match[3] ) {\n\t\t\t\tSizzle.error( match[0] );\n\t\t\t}\n\n\t\t\treturn match;\n\t\t},\n\n\t\t\"PSEUDO\": function( match ) {\n\t\t\tvar excess,\n\t\t\t\tunquoted = !match[6] && match[2];\n\n\t\t\tif ( matchExpr[\"CHILD\"].test( match[0] ) ) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Accept quoted arguments as-is\n\t\t\tif ( match[3] ) {\n\t\t\t\tmatch[2] = match[4] || match[5] || \"\";\n\n\t\t\t// Strip excess characters from unquoted arguments\n\t\t\t} else if ( unquoted && rpseudo.test( unquoted ) &&\n\t\t\t\t// Get excess from tokenize (recursively)\n\t\t\t\t(excess = tokenize( unquoted, true )) &&\n\t\t\t\t// advance to the next closing parenthesis\n\t\t\t\t(excess = unquoted.indexOf( \")\", unquoted.length - excess ) - unquoted.length) ) {\n\n\t\t\t\t// excess is a negative index\n\t\t\t\tmatch[0] = match[0].slice( 0, excess );\n\t\t\t\tmatch[2] = unquoted.slice( 0, excess );\n\t\t\t}\n\n\t\t\t// Return only captures needed by the pseudo filter method (type and argument)\n\t\t\treturn match.slice( 0, 3 );\n\t\t}\n\t},\n\n\tfilter: {\n\n\t\t\"TAG\": function( nodeNameSelector ) {\n\t\t\tvar nodeName = nodeNameSelector.replace( runescape, funescape ).toLowerCase();\n\t\t\treturn nodeNameSelector === \"*\" ?\n\t\t\t\tfunction() { return true; } :\n\t\t\t\tfunction( elem ) {\n\t\t\t\t\treturn elem.nodeName && elem.nodeName.toLowerCase() === nodeName;\n\t\t\t\t};\n\t\t},\n\n\t\t\"CLASS\": function( className ) {\n\t\t\tvar pattern = classCache[ className + \" \" ];\n\n\t\t\treturn pattern ||\n\t\t\t\t(pattern = new RegExp( \"(^|\" + whitespace + \")\" + className + \"(\" + whitespace + \"|$)\" )) &&\n\t\t\t\tclassCache( className, function( elem ) {\n\t\t\t\t\treturn pattern.test( typeof elem.className === \"string\" && elem.className || typeof elem.getAttribute !== strundefined && elem.getAttribute(\"class\") || \"\" );\n\t\t\t\t});\n\t\t},\n\n\t\t\"ATTR\": function( name, operator, check ) {\n\t\t\treturn function( elem ) {\n\t\t\t\tvar result = Sizzle.attr( elem, name );\n\n\t\t\t\tif ( result == null ) {\n\t\t\t\t\treturn operator === \"!=\";\n\t\t\t\t}\n\t\t\t\tif ( !operator ) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tresult += \"\";\n\n\t\t\t\treturn operator === \"=\" ? result === check :\n\t\t\t\t\toperator === \"!=\" ? result !== check :\n\t\t\t\t\toperator === \"^=\" ? check && result.indexOf( check ) === 0 :\n\t\t\t\t\toperator === \"*=\" ? check && result.indexOf( check ) > -1 :\n\t\t\t\t\toperator === \"$=\" ? check && result.slice( -check.length ) === check :\n\t\t\t\t\toperator === \"~=\" ? ( \" \" + result + \" \" ).indexOf( check ) > -1 :\n\t\t\t\t\toperator === \"|=\" ? result === check || result.slice( 0, check.length + 1 ) === check + \"-\" :\n\t\t\t\t\tfalse;\n\t\t\t};\n\t\t},\n\n\t\t\"CHILD\": function( type, what, argument, first, last ) {\n\t\t\tvar simple = type.slice( 0, 3 ) !== \"nth\",\n\t\t\t\tforward = type.slice( -4 ) !== \"last\",\n\t\t\t\tofType = what === \"of-type\";\n\n\t\t\treturn first === 1 && last === 0 ?\n\n\t\t\t\t// Shortcut for :nth-*(n)\n\t\t\t\tfunction( elem ) {\n\t\t\t\t\treturn !!elem.parentNode;\n\t\t\t\t} :\n\n\t\t\t\tfunction( elem, context, xml ) {\n\t\t\t\t\tvar cache, outerCache, node, diff, nodeIndex, start,\n\t\t\t\t\t\tdir = simple !== forward ? \"nextSibling\" : \"previousSibling\",\n\t\t\t\t\t\tparent = elem.parentNode,\n\t\t\t\t\t\tname = ofType && elem.nodeName.toLowerCase(),\n\t\t\t\t\t\tuseCache = !xml && !ofType;\n\n\t\t\t\t\tif ( parent ) {\n\n\t\t\t\t\t\t// :(first|last|only)-(child|of-type)\n\t\t\t\t\t\tif ( simple ) {\n\t\t\t\t\t\t\twhile ( dir ) {\n\t\t\t\t\t\t\t\tnode = elem;\n\t\t\t\t\t\t\t\twhile ( (node = node[ dir ]) ) {\n\t\t\t\t\t\t\t\t\tif ( ofType ? node.nodeName.toLowerCase() === name : node.nodeType === 1 ) {\n\t\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// Reverse direction for :only-* (if we haven't yet done so)\n\t\t\t\t\t\t\t\tstart = dir = type === \"only\" && !start && \"nextSibling\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tstart = [ forward ? parent.firstChild : parent.lastChild ];\n\n\t\t\t\t\t\t// non-xml :nth-child(...) stores cache data on `parent`\n\t\t\t\t\t\tif ( forward && useCache ) {\n\t\t\t\t\t\t\t// Seek `elem` from a previously-cached index\n\t\t\t\t\t\t\touterCache = parent[ expando ] || (parent[ expando ] = {});\n\t\t\t\t\t\t\tcache = outerCache[ type ] || [];\n\t\t\t\t\t\t\tnodeIndex = cache[0] === dirruns && cache[1];\n\t\t\t\t\t\t\tdiff = cache[0] === dirruns && cache[2];\n\t\t\t\t\t\t\tnode = nodeIndex && parent.childNodes[ nodeIndex ];\n\n\t\t\t\t\t\t\twhile ( (node = ++nodeIndex && node && node[ dir ] ||\n\n\t\t\t\t\t\t\t\t// Fallback to seeking `elem` from the start\n\t\t\t\t\t\t\t\t(diff = nodeIndex = 0) || start.pop()) ) {\n\n\t\t\t\t\t\t\t\t// When found, cache indexes on `parent` and break\n\t\t\t\t\t\t\t\tif ( node.nodeType === 1 && ++diff && node === elem ) {\n\t\t\t\t\t\t\t\t\touterCache[ type ] = [ dirruns, nodeIndex, diff ];\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Use previously-cached element index if available\n\t\t\t\t\t\t} else if ( useCache && (cache = (elem[ expando ] || (elem[ expando ] = {}))[ type ]) && cache[0] === dirruns ) {\n\t\t\t\t\t\t\tdiff = cache[1];\n\n\t\t\t\t\t\t// xml :nth-child(...) or :nth-last-child(...) or :nth(-last)?-of-type(...)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Use the same loop as above to seek `elem` from the start\n\t\t\t\t\t\t\twhile ( (node = ++nodeIndex && node && node[ dir ] ||\n\t\t\t\t\t\t\t\t(diff = nodeIndex = 0) || start.pop()) ) {\n\n\t\t\t\t\t\t\t\tif ( ( ofType ? node.nodeName.toLowerCase() === name : node.nodeType === 1 ) && ++diff ) {\n\t\t\t\t\t\t\t\t\t// Cache the index of each encountered element\n\t\t\t\t\t\t\t\t\tif ( useCache ) {\n\t\t\t\t\t\t\t\t\t\t(node[ expando ] || (node[ expando ] = {}))[ type ] = [ dirruns, diff ];\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif ( node === elem ) {\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Incorporate the offset, then check against cycle size\n\t\t\t\t\t\tdiff -= last;\n\t\t\t\t\t\treturn diff === first || ( diff % first === 0 && diff / first >= 0 );\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t},\n\n\t\t\"PSEUDO\": function( pseudo, argument ) {\n\t\t\t// pseudo-class names are case-insensitive\n\t\t\t// http://www.w3.org/TR/selectors/#pseudo-classes\n\t\t\t// Prioritize by case sensitivity in case custom pseudos are added with uppercase letters\n\t\t\t// Remember that setFilters inherits from pseudos\n\t\t\tvar args,\n\t\t\t\tfn = Expr.pseudos[ pseudo ] || Expr.setFilters[ pseudo.toLowerCase() ] ||\n\t\t\t\t\tSizzle.error( \"unsupported pseudo: \" + pseudo );\n\n\t\t\t// The user may use createPseudo to indicate that\n\t\t\t// arguments are needed to create the filter function\n\t\t\t// just as Sizzle does\n\t\t\tif ( fn[ expando ] ) {\n\t\t\t\treturn fn( argument );\n\t\t\t}\n\n\t\t\t// But maintain support for old signatures\n\t\t\tif ( fn.length > 1 ) {\n\t\t\t\targs = [ pseudo, pseudo, \"\", argument ];\n\t\t\t\treturn Expr.setFilters.hasOwnProperty( pseudo.toLowerCase() ) ?\n\t\t\t\t\tmarkFunction(function( seed, matches ) {\n\t\t\t\t\t\tvar idx,\n\t\t\t\t\t\t\tmatched = fn( seed, argument ),\n\t\t\t\t\t\t\ti = matched.length;\n\t\t\t\t\t\twhile ( i-- ) {\n\t\t\t\t\t\t\tidx = indexOf.call( seed, matched[i] );\n\t\t\t\t\t\t\tseed[ idx ] = !( matches[ idx ] = matched[i] );\n\t\t\t\t\t\t}\n\t\t\t\t\t}) :\n\t\t\t\t\tfunction( elem ) {\n\t\t\t\t\t\treturn fn( elem, 0, args );\n\t\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn fn;\n\t\t}\n\t},\n\n\tpseudos: {\n\t\t// Potentially complex pseudos\n\t\t\"not\": markFunction(function( selector ) {\n\t\t\t// Trim the selector passed to compile\n\t\t\t// to avoid treating leading and trailing\n\t\t\t// spaces as combinators\n\t\t\tvar input = [],\n\t\t\t\tresults = [],\n\t\t\t\tmatcher = compile( selector.replace( rtrim, \"$1\" ) );\n\n\t\t\treturn matcher[ expando ] ?\n\t\t\t\tmarkFunction(function( seed, matches, context, xml ) {\n\t\t\t\t\tvar elem,\n\t\t\t\t\t\tunmatched = matcher( seed, null, xml, [] ),\n\t\t\t\t\t\ti = seed.length;\n\n\t\t\t\t\t// Match elements unmatched by `matcher`\n\t\t\t\t\twhile ( i-- ) {\n\t\t\t\t\t\tif ( (elem = unmatched[i]) ) {\n\t\t\t\t\t\t\tseed[i] = !(matches[i] = elem);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}) :\n\t\t\t\tfunction( elem, context, xml ) {\n\t\t\t\t\tinput[0] = elem;\n\t\t\t\t\tmatcher( input, null, xml, results );\n\t\t\t\t\treturn !results.pop();\n\t\t\t\t};\n\t\t}),\n\n\t\t\"has\": markFunction(function( selector ) {\n\t\t\treturn function( elem ) {\n\t\t\t\treturn Sizzle( selector, elem ).length > 0;\n\t\t\t};\n\t\t}),\n\n\t\t\"contains\": markFunction(function( text ) {\n\t\t\treturn function( elem ) {\n\t\t\t\treturn ( elem.textContent || elem.innerText || getText( elem ) ).indexOf( text ) > -1;\n\t\t\t};\n\t\t}),\n\n\t\t// \"Whether an element is represented by a :lang() selector\n\t\t// is based solely on the element's language value\n\t\t// being equal to the identifier C,\n\t\t// or beginning with the identifier C immediately followed by \"-\".\n\t\t// The matching of C against the element's language value is performed case-insensitively.\n\t\t// The identifier C does not have to be a valid language name.\"\n\t\t// http://www.w3.org/TR/selectors/#lang-pseudo\n\t\t\"lang\": markFunction( function( lang ) {\n\t\t\t// lang value must be a valid identifier\n\t\t\tif ( !ridentifier.test(lang || \"\") ) {\n\t\t\t\tSizzle.error( \"unsupported lang: \" + lang );\n\t\t\t}\n\t\t\tlang = lang.replace( runescape, funescape ).toLowerCase();\n\t\t\treturn function( elem ) {\n\t\t\t\tvar elemLang;\n\t\t\t\tdo {\n\t\t\t\t\tif ( (elemLang = documentIsHTML ?\n\t\t\t\t\t\telem.lang :\n\t\t\t\t\t\telem.getAttribute(\"xml:lang\") || elem.getAttribute(\"lang\")) ) {\n\n\t\t\t\t\t\telemLang = elemLang.toLowerCase();\n\t\t\t\t\t\treturn elemLang === lang || elemLang.indexOf( lang + \"-\" ) === 0;\n\t\t\t\t\t}\n\t\t\t\t} while ( (elem = elem.parentNode) && elem.nodeType === 1 );\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}),\n\n\t\t// Miscellaneous\n\t\t\"target\": function( elem ) {\n\t\t\tvar hash = window.location && window.location.hash;\n\t\t\treturn hash && hash.slice( 1 ) === elem.id;\n\t\t},\n\n\t\t\"root\": function( elem ) {\n\t\t\treturn elem === docElem;\n\t\t},\n\n\t\t\"focus\": function( elem ) {\n\t\t\treturn elem === document.activeElement && (!document.hasFocus || document.hasFocus()) && !!(elem.type || elem.href || ~elem.tabIndex);\n\t\t},\n\n\t\t// Boolean properties\n\t\t\"enabled\": function( elem ) {\n\t\t\treturn elem.disabled === false;\n\t\t},\n\n\t\t\"disabled\": function( elem ) {\n\t\t\treturn elem.disabled === true;\n\t\t},\n\n\t\t\"checked\": function( elem ) {\n\t\t\t// In CSS3, :checked should return both checked and selected elements\n\t\t\t// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked\n\t\t\tvar nodeName = elem.nodeName.toLowerCase();\n\t\t\treturn (nodeName === \"input\" && !!elem.checked) || (nodeName === \"option\" && !!elem.selected);\n\t\t},\n\n\t\t\"selected\": function( elem ) {\n\t\t\t// Accessing this property makes selected-by-default\n\t\t\t// options in Safari work properly\n\t\t\tif ( elem.parentNode ) {\n\t\t\t\telem.parentNode.selectedIndex;\n\t\t\t}\n\n\t\t\treturn elem.selected === true;\n\t\t},\n\n\t\t// Contents\n\t\t\"empty\": function( elem ) {\n\t\t\t// http://www.w3.org/TR/selectors/#empty-pseudo\n\t\t\t// :empty is negated by element (1) or content nodes (text: 3; cdata: 4; entity ref: 5),\n\t\t\t//   but not by others (comment: 8; processing instruction: 7; etc.)\n\t\t\t// nodeType < 6 works because attributes (2) do not appear as children\n\t\t\tfor ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {\n\t\t\t\tif ( elem.nodeType < 6 ) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t},\n\n\t\t\"parent\": function( elem ) {\n\t\t\treturn !Expr.pseudos[\"empty\"]( elem );\n\t\t},\n\n\t\t// Element/input types\n\t\t\"header\": function( elem ) {\n\t\t\treturn rheader.test( elem.nodeName );\n\t\t},\n\n\t\t\"input\": function( elem ) {\n\t\t\treturn rinputs.test( elem.nodeName );\n\t\t},\n\n\t\t\"button\": function( elem ) {\n\t\t\tvar name = elem.nodeName.toLowerCase();\n\t\t\treturn name === \"input\" && elem.type === \"button\" || name === \"button\";\n\t\t},\n\n\t\t\"text\": function( elem ) {\n\t\t\tvar attr;\n\t\t\treturn elem.nodeName.toLowerCase() === \"input\" &&\n\t\t\t\telem.type === \"text\" &&\n\n\t\t\t\t// Support: IE<8\n\t\t\t\t// New HTML5 attribute values (e.g., \"search\") appear with elem.type === \"text\"\n\t\t\t\t( (attr = elem.getAttribute(\"type\")) == null || attr.toLowerCase() === \"text\" );\n\t\t},\n\n\t\t// Position-in-collection\n\t\t\"first\": createPositionalPseudo(function() {\n\t\t\treturn [ 0 ];\n\t\t}),\n\n\t\t\"last\": createPositionalPseudo(function( matchIndexes, length ) {\n\t\t\treturn [ length - 1 ];\n\t\t}),\n\n\t\t\"eq\": createPositionalPseudo(function( matchIndexes, length, argument ) {\n\t\t\treturn [ argument < 0 ? argument + length : argument ];\n\t\t}),\n\n\t\t\"even\": createPositionalPseudo(function( matchIndexes, length ) {\n\t\t\tvar i = 0;\n\t\t\tfor ( ; i < length; i += 2 ) {\n\t\t\t\tmatchIndexes.push( i );\n\t\t\t}\n\t\t\treturn matchIndexes;\n\t\t}),\n\n\t\t\"odd\": createPositionalPseudo(function( matchIndexes, length ) {\n\t\t\tvar i = 1;\n\t\t\tfor ( ; i < length; i += 2 ) {\n\t\t\t\tmatchIndexes.push( i );\n\t\t\t}\n\t\t\treturn matchIndexes;\n\t\t}),\n\n\t\t\"lt\": createPositionalPseudo(function( matchIndexes, length, argument ) {\n\t\t\tvar i = argument < 0 ? argument + length : argument;\n\t\t\tfor ( ; --i >= 0; ) {\n\t\t\t\tmatchIndexes.push( i );\n\t\t\t}\n\t\t\treturn matchIndexes;\n\t\t}),\n\n\t\t\"gt\": createPositionalPseudo(function( matchIndexes, length, argument ) {\n\t\t\tvar i = argument < 0 ? argument + length : argument;\n\t\t\tfor ( ; ++i < length; ) {\n\t\t\t\tmatchIndexes.push( i );\n\t\t\t}\n\t\t\treturn matchIndexes;\n\t\t})\n\t}\n};\n\nExpr.pseudos[\"nth\"] = Expr.pseudos[\"eq\"];\n\n// Add button/input type pseudos\nfor ( i in { radio: true, checkbox: true, file: true, password: true, image: true } ) {\n\tExpr.pseudos[ i ] = createInputPseudo( i );\n}\nfor ( i in { submit: true, reset: true } ) {\n\tExpr.pseudos[ i ] = createButtonPseudo( i );\n}\n\n// Easy API for creating new setFilters\nfunction setFilters() {}\nsetFilters.prototype = Expr.filters = Expr.pseudos;\nExpr.setFilters = new setFilters();\n\ntokenize = Sizzle.tokenize = function( selector, parseOnly ) {\n\tvar matched, match, tokens, type,\n\t\tsoFar, groups, preFilters,\n\t\tcached = tokenCache[ selector + \" \" ];\n\n\tif ( cached ) {\n\t\treturn parseOnly ? 0 : cached.slice( 0 );\n\t}\n\n\tsoFar = selector;\n\tgroups = [];\n\tpreFilters = Expr.preFilter;\n\n\twhile ( soFar ) {\n\n\t\t// Comma and first run\n\t\tif ( !matched || (match = rcomma.exec( soFar )) ) {\n\t\t\tif ( match ) {\n\t\t\t\t// Don't consume trailing commas as valid\n\t\t\t\tsoFar = soFar.slice( match[0].length ) || soFar;\n\t\t\t}\n\t\t\tgroups.push( (tokens = []) );\n\t\t}\n\n\t\tmatched = false;\n\n\t\t// Combinators\n\t\tif ( (match = rcombinators.exec( soFar )) ) {\n\t\t\tmatched = match.shift();\n\t\t\ttokens.push({\n\t\t\t\tvalue: matched,\n\t\t\t\t// Cast descendant combinators to space\n\t\t\t\ttype: match[0].replace( rtrim, \" \" )\n\t\t\t});\n\t\t\tsoFar = soFar.slice( matched.length );\n\t\t}\n\n\t\t// Filters\n\t\tfor ( type in Expr.filter ) {\n\t\t\tif ( (match = matchExpr[ type ].exec( soFar )) && (!preFilters[ type ] ||\n\t\t\t\t(match = preFilters[ type ]( match ))) ) {\n\t\t\t\tmatched = match.shift();\n\t\t\t\ttokens.push({\n\t\t\t\t\tvalue: matched,\n\t\t\t\t\ttype: type,\n\t\t\t\t\tmatches: match\n\t\t\t\t});\n\t\t\t\tsoFar = soFar.slice( matched.length );\n\t\t\t}\n\t\t}\n\n\t\tif ( !matched ) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// Return the length of the invalid excess\n\t// if we're just parsing\n\t// Otherwise, throw an error or return tokens\n\treturn parseOnly ?\n\t\tsoFar.length :\n\t\tsoFar ?\n\t\t\tSizzle.error( selector ) :\n\t\t\t// Cache the tokens\n\t\t\ttokenCache( selector, groups ).slice( 0 );\n};\n\nfunction toSelector( tokens ) {\n\tvar i = 0,\n\t\tlen = tokens.length,\n\t\tselector = \"\";\n\tfor ( ; i < len; i++ ) {\n\t\tselector += tokens[i].value;\n\t}\n\treturn selector;\n}\n\nfunction addCombinator( matcher, combinator, base ) {\n\tvar dir = combinator.dir,\n\t\tcheckNonElements = base && dir === \"parentNode\",\n\t\tdoneName = done++;\n\n\treturn combinator.first ?\n\t\t// Check against closest ancestor/preceding element\n\t\tfunction( elem, context, xml ) {\n\t\t\twhile ( (elem = elem[ dir ]) ) {\n\t\t\t\tif ( elem.nodeType === 1 || checkNonElements ) {\n\t\t\t\t\treturn matcher( elem, context, xml );\n\t\t\t\t}\n\t\t\t}\n\t\t} :\n\n\t\t// Check against all ancestor/preceding elements\n\t\tfunction( elem, context, xml ) {\n\t\t\tvar oldCache, outerCache,\n\t\t\t\tnewCache = [ dirruns, doneName ];\n\n\t\t\t// We can't set arbitrary data on XML nodes, so they don't benefit from dir caching\n\t\t\tif ( xml ) {\n\t\t\t\twhile ( (elem = elem[ dir ]) ) {\n\t\t\t\t\tif ( elem.nodeType === 1 || checkNonElements ) {\n\t\t\t\t\t\tif ( matcher( elem, context, xml ) ) {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\twhile ( (elem = elem[ dir ]) ) {\n\t\t\t\t\tif ( elem.nodeType === 1 || checkNonElements ) {\n\t\t\t\t\t\touterCache = elem[ expando ] || (elem[ expando ] = {});\n\t\t\t\t\t\tif ( (oldCache = outerCache[ dir ]) &&\n\t\t\t\t\t\t\toldCache[ 0 ] === dirruns && oldCache[ 1 ] === doneName ) {\n\n\t\t\t\t\t\t\t// Assign to newCache so results back-propagate to previous elements\n\t\t\t\t\t\t\treturn (newCache[ 2 ] = oldCache[ 2 ]);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Reuse newcache so results back-propagate to previous elements\n\t\t\t\t\t\t\touterCache[ dir ] = newCache;\n\n\t\t\t\t\t\t\t// A match means we're done; a fail means we have to keep checking\n\t\t\t\t\t\t\tif ( (newCache[ 2 ] = matcher( elem, context, xml )) ) {\n\t\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n}\n\nfunction elementMatcher( matchers ) {\n\treturn matchers.length > 1 ?\n\t\tfunction( elem, context, xml ) {\n\t\t\tvar i = matchers.length;\n\t\t\twhile ( i-- ) {\n\t\t\t\tif ( !matchers[i]( elem, context, xml ) ) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t} :\n\t\tmatchers[0];\n}\n\nfunction multipleContexts( selector, contexts, results ) {\n\tvar i = 0,\n\t\tlen = contexts.length;\n\tfor ( ; i < len; i++ ) {\n\t\tSizzle( selector, contexts[i], results );\n\t}\n\treturn results;\n}\n\nfunction condense( unmatched, map, filter, context, xml ) {\n\tvar elem,\n\t\tnewUnmatched = [],\n\t\ti = 0,\n\t\tlen = unmatched.length,\n\t\tmapped = map != null;\n\n\tfor ( ; i < len; i++ ) {\n\t\tif ( (elem = unmatched[i]) ) {\n\t\t\tif ( !filter || filter( elem, context, xml ) ) {\n\t\t\t\tnewUnmatched.push( elem );\n\t\t\t\tif ( mapped ) {\n\t\t\t\t\tmap.push( i );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn newUnmatched;\n}\n\nfunction setMatcher( preFilter, selector, matcher, postFilter, postFinder, postSelector ) {\n\tif ( postFilter && !postFilter[ expando ] ) {\n\t\tpostFilter = setMatcher( postFilter );\n\t}\n\tif ( postFinder && !postFinder[ expando ] ) {\n\t\tpostFinder = setMatcher( postFinder, postSelector );\n\t}\n\treturn markFunction(function( seed, results, context, xml ) {\n\t\tvar temp, i, elem,\n\t\t\tpreMap = [],\n\t\t\tpostMap = [],\n\t\t\tpreexisting = results.length,\n\n\t\t\t// Get initial elements from seed or context\n\t\t\telems = seed || multipleContexts( selector || \"*\", context.nodeType ? [ context ] : context, [] ),\n\n\t\t\t// Prefilter to get matcher input, preserving a map for seed-results synchronization\n\t\t\tmatcherIn = preFilter && ( seed || !selector ) ?\n\t\t\t\tcondense( elems, preMap, preFilter, context, xml ) :\n\t\t\t\telems,\n\n\t\t\tmatcherOut = matcher ?\n\t\t\t\t// If we have a postFinder, or filtered seed, or non-seed postFilter or preexisting results,\n\t\t\t\tpostFinder || ( seed ? preFilter : preexisting || postFilter ) ?\n\n\t\t\t\t\t// ...intermediate processing is necessary\n\t\t\t\t\t[] :\n\n\t\t\t\t\t// ...otherwise use results directly\n\t\t\t\t\tresults :\n\t\t\t\tmatcherIn;\n\n\t\t// Find primary matches\n\t\tif ( matcher ) {\n\t\t\tmatcher( matcherIn, matcherOut, context, xml );\n\t\t}\n\n\t\t// Apply postFilter\n\t\tif ( postFilter ) {\n\t\t\ttemp = condense( matcherOut, postMap );\n\t\t\tpostFilter( temp, [], context, xml );\n\n\t\t\t// Un-match failing elements by moving them back to matcherIn\n\t\t\ti = temp.length;\n\t\t\twhile ( i-- ) {\n\t\t\t\tif ( (elem = temp[i]) ) {\n\t\t\t\t\tmatcherOut[ postMap[i] ] = !(matcherIn[ postMap[i] ] = elem);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ( seed ) {\n\t\t\tif ( postFinder || preFilter ) {\n\t\t\t\tif ( postFinder ) {\n\t\t\t\t\t// Get the final matcherOut by condensing this intermediate into postFinder contexts\n\t\t\t\t\ttemp = [];\n\t\t\t\t\ti = matcherOut.length;\n\t\t\t\t\twhile ( i-- ) {\n\t\t\t\t\t\tif ( (elem = matcherOut[i]) ) {\n\t\t\t\t\t\t\t// Restore matcherIn since elem is not yet a final match\n\t\t\t\t\t\t\ttemp.push( (matcherIn[i] = elem) );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpostFinder( null, (matcherOut = []), temp, xml );\n\t\t\t\t}\n\n\t\t\t\t// Move matched elements from seed to results to keep them synchronized\n\t\t\t\ti = matcherOut.length;\n\t\t\t\twhile ( i-- ) {\n\t\t\t\t\tif ( (elem = matcherOut[i]) &&\n\t\t\t\t\t\t(temp = postFinder ? indexOf.call( seed, elem ) : preMap[i]) > -1 ) {\n\n\t\t\t\t\t\tseed[temp] = !(results[temp] = elem);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t// Add elements to results, through postFinder if defined\n\t\t} else {\n\t\t\tmatcherOut = condense(\n\t\t\t\tmatcherOut === results ?\n\t\t\t\t\tmatcherOut.splice( preexisting, matcherOut.length ) :\n\t\t\t\t\tmatcherOut\n\t\t\t);\n\t\t\tif ( postFinder ) {\n\t\t\t\tpostFinder( null, results, matcherOut, xml );\n\t\t\t} else {\n\t\t\t\tpush.apply( results, matcherOut );\n\t\t\t}\n\t\t}\n\t});\n}\n\nfunction matcherFromTokens( tokens ) {\n\tvar checkContext, matcher, j,\n\t\tlen = tokens.length,\n\t\tleadingRelative = Expr.relative[ tokens[0].type ],\n\t\timplicitRelative = leadingRelative || Expr.relative[\" \"],\n\t\ti = leadingRelative ? 1 : 0,\n\n\t\t// The foundational matcher ensures that elements are reachable from top-level context(s)\n\t\tmatchContext = addCombinator( function( elem ) {\n\t\t\treturn elem === checkContext;\n\t\t}, implicitRelative, true ),\n\t\tmatchAnyContext = addCombinator( function( elem ) {\n\t\t\treturn indexOf.call( checkContext, elem ) > -1;\n\t\t}, implicitRelative, true ),\n\t\tmatchers = [ function( elem, context, xml ) {\n\t\t\treturn ( !leadingRelative && ( xml || context !== outermostContext ) ) || (\n\t\t\t\t(checkContext = context).nodeType ?\n\t\t\t\t\tmatchContext( elem, context, xml ) :\n\t\t\t\t\tmatchAnyContext( elem, context, xml ) );\n\t\t} ];\n\n\tfor ( ; i < len; i++ ) {\n\t\tif ( (matcher = Expr.relative[ tokens[i].type ]) ) {\n\t\t\tmatchers = [ addCombinator(elementMatcher( matchers ), matcher) ];\n\t\t} else {\n\t\t\tmatcher = Expr.filter[ tokens[i].type ].apply( null, tokens[i].matches );\n\n\t\t\t// Return special upon seeing a positional matcher\n\t\t\tif ( matcher[ expando ] ) {\n\t\t\t\t// Find the next relative operator (if any) for proper handling\n\t\t\t\tj = ++i;\n\t\t\t\tfor ( ; j < len; j++ ) {\n\t\t\t\t\tif ( Expr.relative[ tokens[j].type ] ) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn setMatcher(\n\t\t\t\t\ti > 1 && elementMatcher( matchers ),\n\t\t\t\t\ti > 1 && toSelector(\n\t\t\t\t\t\t// If the preceding token was a descendant combinator, insert an implicit any-element `*`\n\t\t\t\t\t\ttokens.slice( 0, i - 1 ).concat({ value: tokens[ i - 2 ].type === \" \" ? \"*\" : \"\" })\n\t\t\t\t\t).replace( rtrim, \"$1\" ),\n\t\t\t\t\tmatcher,\n\t\t\t\t\ti < j && matcherFromTokens( tokens.slice( i, j ) ),\n\t\t\t\t\tj < len && matcherFromTokens( (tokens = tokens.slice( j )) ),\n\t\t\t\t\tj < len && toSelector( tokens )\n\t\t\t\t);\n\t\t\t}\n\t\t\tmatchers.push( matcher );\n\t\t}\n\t}\n\n\treturn elementMatcher( matchers );\n}\n\nfunction matcherFromGroupMatchers( elementMatchers, setMatchers ) {\n\tvar bySet = setMatchers.length > 0,\n\t\tbyElement = elementMatchers.length > 0,\n\t\tsuperMatcher = function( seed, context, xml, results, outermost ) {\n\t\t\tvar elem, j, matcher,\n\t\t\t\tmatchedCount = 0,\n\t\t\t\ti = \"0\",\n\t\t\t\tunmatched = seed && [],\n\t\t\t\tsetMatched = [],\n\t\t\t\tcontextBackup = outermostContext,\n\t\t\t\t// We must always have either seed elements or outermost context\n\t\t\t\telems = seed || byElement && Expr.find[\"TAG\"]( \"*\", outermost ),\n\t\t\t\t// Use integer dirruns iff this is the outermost matcher\n\t\t\t\tdirrunsUnique = (dirruns += contextBackup == null ? 1 : Math.random() || 0.1),\n\t\t\t\tlen = elems.length;\n\n\t\t\tif ( outermost ) {\n\t\t\t\toutermostContext = context !== document && context;\n\t\t\t}\n\n\t\t\t// Add elements passing elementMatchers directly to results\n\t\t\t// Keep `i` a string if there are no elements so `matchedCount` will be \"00\" below\n\t\t\t// Support: IE<9, Safari\n\t\t\t// Tolerate NodeList properties (IE: \"length\"; Safari: <number>) matching elements by id\n\t\t\tfor ( ; i !== len && (elem = elems[i]) != null; i++ ) {\n\t\t\t\tif ( byElement && elem ) {\n\t\t\t\t\tj = 0;\n\t\t\t\t\twhile ( (matcher = elementMatchers[j++]) ) {\n\t\t\t\t\t\tif ( matcher( elem, context, xml ) ) {\n\t\t\t\t\t\t\tresults.push( elem );\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( outermost ) {\n\t\t\t\t\t\tdirruns = dirrunsUnique;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Track unmatched elements for set filters\n\t\t\t\tif ( bySet ) {\n\t\t\t\t\t// They will have gone through all possible matchers\n\t\t\t\t\tif ( (elem = !matcher && elem) ) {\n\t\t\t\t\t\tmatchedCount--;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Lengthen the array for every element, matched or not\n\t\t\t\t\tif ( seed ) {\n\t\t\t\t\t\tunmatched.push( elem );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Apply set filters to unmatched elements\n\t\t\tmatchedCount += i;\n\t\t\tif ( bySet && i !== matchedCount ) {\n\t\t\t\tj = 0;\n\t\t\t\twhile ( (matcher = setMatchers[j++]) ) {\n\t\t\t\t\tmatcher( unmatched, setMatched, context, xml );\n\t\t\t\t}\n\n\t\t\t\tif ( seed ) {\n\t\t\t\t\t// Reintegrate element matches to eliminate the need for sorting\n\t\t\t\t\tif ( matchedCount > 0 ) {\n\t\t\t\t\t\twhile ( i-- ) {\n\t\t\t\t\t\t\tif ( !(unmatched[i] || setMatched[i]) ) {\n\t\t\t\t\t\t\t\tsetMatched[i] = pop.call( results );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Discard index placeholder values to get only actual matches\n\t\t\t\t\tsetMatched = condense( setMatched );\n\t\t\t\t}\n\n\t\t\t\t// Add matches to results\n\t\t\t\tpush.apply( results, setMatched );\n\n\t\t\t\t// Seedless set matches succeeding multiple successful matchers stipulate sorting\n\t\t\t\tif ( outermost && !seed && setMatched.length > 0 &&\n\t\t\t\t\t( matchedCount + setMatchers.length ) > 1 ) {\n\n\t\t\t\t\tSizzle.uniqueSort( results );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Override manipulation of globals by nested matchers\n\t\t\tif ( outermost ) {\n\t\t\t\tdirruns = dirrunsUnique;\n\t\t\t\toutermostContext = contextBackup;\n\t\t\t}\n\n\t\t\treturn unmatched;\n\t\t};\n\n\treturn bySet ?\n\t\tmarkFunction( superMatcher ) :\n\t\tsuperMatcher;\n}\n\ncompile = Sizzle.compile = function( selector, match /* Internal Use Only */ ) {\n\tvar i,\n\t\tsetMatchers = [],\n\t\telementMatchers = [],\n\t\tcached = compilerCache[ selector + \" \" ];\n\n\tif ( !cached ) {\n\t\t// Generate a function of recursive functions that can be used to check each element\n\t\tif ( !match ) {\n\t\t\tmatch = tokenize( selector );\n\t\t}\n\t\ti = match.length;\n\t\twhile ( i-- ) {\n\t\t\tcached = matcherFromTokens( match[i] );\n\t\t\tif ( cached[ expando ] ) {\n\t\t\t\tsetMatchers.push( cached );\n\t\t\t} else {\n\t\t\t\telementMatchers.push( cached );\n\t\t\t}\n\t\t}\n\n\t\t// Cache the compiled function\n\t\tcached = compilerCache( selector, matcherFromGroupMatchers( elementMatchers, setMatchers ) );\n\n\t\t// Save selector and tokenization\n\t\tcached.selector = selector;\n\t}\n\treturn cached;\n};\n\n/**\n * A low-level selection function that works with Sizzle's compiled\n *  selector functions\n * @param {String|Function} selector A selector or a pre-compiled\n *  selector function built with Sizzle.compile\n * @param {Element} context\n * @param {Array} [results]\n * @param {Array} [seed] A set of elements to match against\n */\nselect = Sizzle.select = function( selector, context, results, seed ) {\n\tvar i, tokens, token, type, find,\n\t\tcompiled = typeof selector === \"function\" && selector,\n\t\tmatch = !seed && tokenize( (selector = compiled.selector || selector) );\n\n\tresults = results || [];\n\n\t// Try to minimize operations if there is no seed and only one group\n\tif ( match.length === 1 ) {\n\n\t\t// Take a shortcut and set the context if the root selector is an ID\n\t\ttokens = match[0] = match[0].slice( 0 );\n\t\tif ( tokens.length > 2 && (token = tokens[0]).type === \"ID\" &&\n\t\t\t\tsupport.getById && context.nodeType === 9 && documentIsHTML &&\n\t\t\t\tExpr.relative[ tokens[1].type ] ) {\n\n\t\t\tcontext = ( Expr.find[\"ID\"]( token.matches[0].replace(runescape, funescape), context ) || [] )[0];\n\t\t\tif ( !context ) {\n\t\t\t\treturn results;\n\n\t\t\t// Precompiled matchers will still verify ancestry, so step up a level\n\t\t\t} else if ( compiled ) {\n\t\t\t\tcontext = context.parentNode;\n\t\t\t}\n\n\t\t\tselector = selector.slice( tokens.shift().value.length );\n\t\t}\n\n\t\t// Fetch a seed set for right-to-left matching\n\t\ti = matchExpr[\"needsContext\"].test( selector ) ? 0 : tokens.length;\n\t\twhile ( i-- ) {\n\t\t\ttoken = tokens[i];\n\n\t\t\t// Abort if we hit a combinator\n\t\t\tif ( Expr.relative[ (type = token.type) ] ) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif ( (find = Expr.find[ type ]) ) {\n\t\t\t\t// Search, expanding context for leading sibling combinators\n\t\t\t\tif ( (seed = find(\n\t\t\t\t\ttoken.matches[0].replace( runescape, funescape ),\n\t\t\t\t\trsibling.test( tokens[0].type ) && testContext( context.parentNode ) || context\n\t\t\t\t)) ) {\n\n\t\t\t\t\t// If seed is empty or no tokens remain, we can return early\n\t\t\t\t\ttokens.splice( i, 1 );\n\t\t\t\t\tselector = seed.length && toSelector( tokens );\n\t\t\t\t\tif ( !selector ) {\n\t\t\t\t\t\tpush.apply( results, seed );\n\t\t\t\t\t\treturn results;\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Compile and execute a filtering function if one is not provided\n\t// Provide `match` to avoid retokenization if we modified the selector above\n\t( compiled || compile( selector, match ) )(\n\t\tseed,\n\t\tcontext,\n\t\t!documentIsHTML,\n\t\tresults,\n\t\trsibling.test( selector ) && testContext( context.parentNode ) || context\n\t);\n\treturn results;\n};\n\n// One-time assignments\n\n// Sort stability\nsupport.sortStable = expando.split(\"\").sort( sortOrder ).join(\"\") === expando;\n\n// Support: Chrome<14\n// Always assume duplicates if they aren't passed to the comparison function\nsupport.detectDuplicates = !!hasDuplicate;\n\n// Initialize against the default document\nsetDocument();\n\n// Support: Webkit<537.32 - Safari 6.0.3/Chrome 25 (fixed in Chrome 27)\n// Detached nodes confoundingly follow *each other*\nsupport.sortDetached = assert(function( div1 ) {\n\t// Should return 1, but returns 4 (following)\n\treturn div1.compareDocumentPosition( document.createElement(\"div\") ) & 1;\n});\n\n// Support: IE<8\n// Prevent attribute/property \"interpolation\"\n// http://msdn.microsoft.com/en-us/library/ms536429%28VS.85%29.aspx\nif ( !assert(function( div ) {\n\tdiv.innerHTML = \"<a href='#'></a>\";\n\treturn div.firstChild.getAttribute(\"href\") === \"#\" ;\n}) ) {\n\taddHandle( \"type|href|height|width\", function( elem, name, isXML ) {\n\t\tif ( !isXML ) {\n\t\t\treturn elem.getAttribute( name, name.toLowerCase() === \"type\" ? 1 : 2 );\n\t\t}\n\t});\n}\n\n// Support: IE<9\n// Use defaultValue in place of getAttribute(\"value\")\nif ( !support.attributes || !assert(function( div ) {\n\tdiv.innerHTML = \"<input/>\";\n\tdiv.firstChild.setAttribute( \"value\", \"\" );\n\treturn div.firstChild.getAttribute( \"value\" ) === \"\";\n}) ) {\n\taddHandle( \"value\", function( elem, name, isXML ) {\n\t\tif ( !isXML && elem.nodeName.toLowerCase() === \"input\" ) {\n\t\t\treturn elem.defaultValue;\n\t\t}\n\t});\n}\n\n// Support: IE<9\n// Use getAttributeNode to fetch booleans when getAttribute lies\nif ( !assert(function( div ) {\n\treturn div.getAttribute(\"disabled\") == null;\n}) ) {\n\taddHandle( booleans, function( elem, name, isXML ) {\n\t\tvar val;\n\t\tif ( !isXML ) {\n\t\t\treturn elem[ name ] === true ? name.toLowerCase() :\n\t\t\t\t\t(val = elem.getAttributeNode( name )) && val.specified ?\n\t\t\t\t\tval.value :\n\t\t\t\tnull;\n\t\t}\n\t});\n}\n\nreturn Sizzle;\n\n})( window );\n\n\n\njQuery.find = Sizzle;\njQuery.expr = Sizzle.selectors;\njQuery.expr[\":\"] = jQuery.expr.pseudos;\njQuery.unique = Sizzle.uniqueSort;\njQuery.text = Sizzle.getText;\njQuery.isXMLDoc = Sizzle.isXML;\njQuery.contains = Sizzle.contains;\n\n\n\nvar rneedsContext = jQuery.expr.match.needsContext;\n\nvar rsingleTag = (/^<(\\w+)\\s*\\/?>(?:<\\/\\1>|)$/);\n\n\n\nvar risSimple = /^.[^:#\\[\\.,]*$/;\n\n// Implement the identical functionality for filter and not\nfunction winnow( elements, qualifier, not ) {\n\tif ( jQuery.isFunction( qualifier ) ) {\n\t\treturn jQuery.grep( elements, function( elem, i ) {\n\t\t\t/* jshint -W018 */\n\t\t\treturn !!qualifier.call( elem, i, elem ) !== not;\n\t\t});\n\n\t}\n\n\tif ( qualifier.nodeType ) {\n\t\treturn jQuery.grep( elements, function( elem ) {\n\t\t\treturn ( elem === qualifier ) !== not;\n\t\t});\n\n\t}\n\n\tif ( typeof qualifier === \"string\" ) {\n\t\tif ( risSimple.test( qualifier ) ) {\n\t\t\treturn jQuery.filter( qualifier, elements, not );\n\t\t}\n\n\t\tqualifier = jQuery.filter( qualifier, elements );\n\t}\n\n\treturn jQuery.grep( elements, function( elem ) {\n\t\treturn ( indexOf.call( qualifier, elem ) >= 0 ) !== not;\n\t});\n}\n\njQuery.filter = function( expr, elems, not ) {\n\tvar elem = elems[ 0 ];\n\n\tif ( not ) {\n\t\texpr = \":not(\" + expr + \")\";\n\t}\n\n\treturn elems.length === 1 && elem.nodeType === 1 ?\n\t\tjQuery.find.matchesSelector( elem, expr ) ? [ elem ] : [] :\n\t\tjQuery.find.matches( expr, jQuery.grep( elems, function( elem ) {\n\t\t\treturn elem.nodeType === 1;\n\t\t}));\n};\n\njQuery.fn.extend({\n\tfind: function( selector ) {\n\t\tvar i,\n\t\t\tlen = this.length,\n\t\t\tret = [],\n\t\t\tself = this;\n\n\t\tif ( typeof selector !== \"string\" ) {\n\t\t\treturn this.pushStack( jQuery( selector ).filter(function() {\n\t\t\t\tfor ( i = 0; i < len; i++ ) {\n\t\t\t\t\tif ( jQuery.contains( self[ i ], this ) ) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}) );\n\t\t}\n\n\t\tfor ( i = 0; i < len; i++ ) {\n\t\t\tjQuery.find( selector, self[ i ], ret );\n\t\t}\n\n\t\t// Needed because $( selector, context ) becomes $( context ).find( selector )\n\t\tret = this.pushStack( len > 1 ? jQuery.unique( ret ) : ret );\n\t\tret.selector = this.selector ? this.selector + \" \" + selector : selector;\n\t\treturn ret;\n\t},\n\tfilter: function( selector ) {\n\t\treturn this.pushStack( winnow(this, selector || [], false) );\n\t},\n\tnot: function( selector ) {\n\t\treturn this.pushStack( winnow(this, selector || [], true) );\n\t},\n\tis: function( selector ) {\n\t\treturn !!winnow(\n\t\t\tthis,\n\n\t\t\t// If this is a positional/relative selector, check membership in the returned set\n\t\t\t// so $(\"p:first\").is(\"p:last\") won't return true for a doc with two \"p\".\n\t\t\ttypeof selector === \"string\" && rneedsContext.test( selector ) ?\n\t\t\t\tjQuery( selector ) :\n\t\t\t\tselector || [],\n\t\t\tfalse\n\t\t).length;\n\t}\n});\n\n\n// Initialize a jQuery object\n\n\n// A central reference to the root jQuery(document)\nvar rootjQuery,\n\n\t// A simple way to check for HTML strings\n\t// Prioritize #id over <tag> to avoid XSS via location.hash (#9521)\n\t// Strict HTML recognition (#11290: must start with <)\n\trquickExpr = /^(?:\\s*(<[\\w\\W]+>)[^>]*|#([\\w-]*))$/,\n\n\tinit = jQuery.fn.init = function( selector, context ) {\n\t\tvar match, elem;\n\n\t\t// HANDLE: $(\"\"), $(null), $(undefined), $(false)\n\t\tif ( !selector ) {\n\t\t\treturn this;\n\t\t}\n\n\t\t// Handle HTML strings\n\t\tif ( typeof selector === \"string\" ) {\n\t\t\tif ( selector[0] === \"<\" && selector[ selector.length - 1 ] === \">\" && selector.length >= 3 ) {\n\t\t\t\t// Assume that strings that start and end with <> are HTML and skip the regex check\n\t\t\t\tmatch = [ null, selector, null ];\n\n\t\t\t} else {\n\t\t\t\tmatch = rquickExpr.exec( selector );\n\t\t\t}\n\n\t\t\t// Match html or make sure no context is specified for #id\n\t\t\tif ( match && (match[1] || !context) ) {\n\n\t\t\t\t// HANDLE: $(html) -> $(array)\n\t\t\t\tif ( match[1] ) {\n\t\t\t\t\tcontext = context instanceof jQuery ? context[0] : context;\n\n\t\t\t\t\t// scripts is true for back-compat\n\t\t\t\t\t// Intentionally let the error be thrown if parseHTML is not present\n\t\t\t\t\tjQuery.merge( this, jQuery.parseHTML(\n\t\t\t\t\t\tmatch[1],\n\t\t\t\t\t\tcontext && context.nodeType ? context.ownerDocument || context : document,\n\t\t\t\t\t\ttrue\n\t\t\t\t\t) );\n\n\t\t\t\t\t// HANDLE: $(html, props)\n\t\t\t\t\tif ( rsingleTag.test( match[1] ) && jQuery.isPlainObject( context ) ) {\n\t\t\t\t\t\tfor ( match in context ) {\n\t\t\t\t\t\t\t// Properties of context are called as methods if possible\n\t\t\t\t\t\t\tif ( jQuery.isFunction( this[ match ] ) ) {\n\t\t\t\t\t\t\t\tthis[ match ]( context[ match ] );\n\n\t\t\t\t\t\t\t// ...and otherwise set as attributes\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.attr( match, context[ match ] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this;\n\n\t\t\t\t// HANDLE: $(#id)\n\t\t\t\t} else {\n\t\t\t\t\telem = document.getElementById( match[2] );\n\n\t\t\t\t\t// Check parentNode to catch when Blackberry 4.6 returns\n\t\t\t\t\t// nodes that are no longer in the document #6963\n\t\t\t\t\tif ( elem && elem.parentNode ) {\n\t\t\t\t\t\t// Inject the element directly into the jQuery object\n\t\t\t\t\t\tthis.length = 1;\n\t\t\t\t\t\tthis[0] = elem;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.context = document;\n\t\t\t\t\tthis.selector = selector;\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\n\t\t\t// HANDLE: $(expr, $(...))\n\t\t\t} else if ( !context || context.jquery ) {\n\t\t\t\treturn ( context || rootjQuery ).find( selector );\n\n\t\t\t// HANDLE: $(expr, context)\n\t\t\t// (which is just equivalent to: $(context).find(expr)\n\t\t\t} else {\n\t\t\t\treturn this.constructor( context ).find( selector );\n\t\t\t}\n\n\t\t// HANDLE: $(DOMElement)\n\t\t} else if ( selector.nodeType ) {\n\t\t\tthis.context = this[0] = selector;\n\t\t\tthis.length = 1;\n\t\t\treturn this;\n\n\t\t// HANDLE: $(function)\n\t\t// Shortcut for document ready\n\t\t} else if ( jQuery.isFunction( selector ) ) {\n\t\t\treturn typeof rootjQuery.ready !== \"undefined\" ?\n\t\t\t\trootjQuery.ready( selector ) :\n\t\t\t\t// Execute immediately if ready is not present\n\t\t\t\tselector( jQuery );\n\t\t}\n\n\t\tif ( selector.selector !== undefined ) {\n\t\t\tthis.selector = selector.selector;\n\t\t\tthis.context = selector.context;\n\t\t}\n\n\t\treturn jQuery.makeArray( selector, this );\n\t};\n\n// Give the init function the jQuery prototype for later instantiation\ninit.prototype = jQuery.fn;\n\n// Initialize central reference\nrootjQuery = jQuery( document );\n\n\nvar rparentsprev = /^(?:parents|prev(?:Until|All))/,\n\t// methods guaranteed to produce a unique set when starting from a unique set\n\tguaranteedUnique = {\n\t\tchildren: true,\n\t\tcontents: true,\n\t\tnext: true,\n\t\tprev: true\n\t};\n\njQuery.extend({\n\tdir: function( elem, dir, until ) {\n\t\tvar matched = [],\n\t\t\ttruncate = until !== undefined;\n\n\t\twhile ( (elem = elem[ dir ]) && elem.nodeType !== 9 ) {\n\t\t\tif ( elem.nodeType === 1 ) {\n\t\t\t\tif ( truncate && jQuery( elem ).is( until ) ) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tmatched.push( elem );\n\t\t\t}\n\t\t}\n\t\treturn matched;\n\t},\n\n\tsibling: function( n, elem ) {\n\t\tvar matched = [];\n\n\t\tfor ( ; n; n = n.nextSibling ) {\n\t\t\tif ( n.nodeType === 1 && n !== elem ) {\n\t\t\t\tmatched.push( n );\n\t\t\t}\n\t\t}\n\n\t\treturn matched;\n\t}\n});\n\njQuery.fn.extend({\n\thas: function( target ) {\n\t\tvar targets = jQuery( target, this ),\n\t\t\tl = targets.length;\n\n\t\treturn this.filter(function() {\n\t\t\tvar i = 0;\n\t\t\tfor ( ; i < l; i++ ) {\n\t\t\t\tif ( jQuery.contains( this, targets[i] ) ) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclosest: function( selectors, context ) {\n\t\tvar cur,\n\t\t\ti = 0,\n\t\t\tl = this.length,\n\t\t\tmatched = [],\n\t\t\tpos = rneedsContext.test( selectors ) || typeof selectors !== \"string\" ?\n\t\t\t\tjQuery( selectors, context || this.context ) :\n\t\t\t\t0;\n\n\t\tfor ( ; i < l; i++ ) {\n\t\t\tfor ( cur = this[i]; cur && cur !== context; cur = cur.parentNode ) {\n\t\t\t\t// Always skip document fragments\n\t\t\t\tif ( cur.nodeType < 11 && (pos ?\n\t\t\t\t\tpos.index(cur) > -1 :\n\n\t\t\t\t\t// Don't pass non-elements to Sizzle\n\t\t\t\t\tcur.nodeType === 1 &&\n\t\t\t\t\t\tjQuery.find.matchesSelector(cur, selectors)) ) {\n\n\t\t\t\t\tmatched.push( cur );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this.pushStack( matched.length > 1 ? jQuery.unique( matched ) : matched );\n\t},\n\n\t// Determine the position of an element within\n\t// the matched set of elements\n\tindex: function( elem ) {\n\n\t\t// No argument, return index in parent\n\t\tif ( !elem ) {\n\t\t\treturn ( this[ 0 ] && this[ 0 ].parentNode ) ? this.first().prevAll().length : -1;\n\t\t}\n\n\t\t// index in selector\n\t\tif ( typeof elem === \"string\" ) {\n\t\t\treturn indexOf.call( jQuery( elem ), this[ 0 ] );\n\t\t}\n\n\t\t// Locate the position of the desired element\n\t\treturn indexOf.call( this,\n\n\t\t\t// If it receives a jQuery object, the first element is used\n\t\t\telem.jquery ? elem[ 0 ] : elem\n\t\t);\n\t},\n\n\tadd: function( selector, context ) {\n\t\treturn this.pushStack(\n\t\t\tjQuery.unique(\n\t\t\t\tjQuery.merge( this.get(), jQuery( selector, context ) )\n\t\t\t)\n\t\t);\n\t},\n\n\taddBack: function( selector ) {\n\t\treturn this.add( selector == null ?\n\t\t\tthis.prevObject : this.prevObject.filter(selector)\n\t\t);\n\t}\n});\n\nfunction sibling( cur, dir ) {\n\twhile ( (cur = cur[dir]) && cur.nodeType !== 1 ) {}\n\treturn cur;\n}\n\njQuery.each({\n\tparent: function( elem ) {\n\t\tvar parent = elem.parentNode;\n\t\treturn parent && parent.nodeType !== 11 ? parent : null;\n\t},\n\tparents: function( elem ) {\n\t\treturn jQuery.dir( elem, \"parentNode\" );\n\t},\n\tparentsUntil: function( elem, i, until ) {\n\t\treturn jQuery.dir( elem, \"parentNode\", until );\n\t},\n\tnext: function( elem ) {\n\t\treturn sibling( elem, \"nextSibling\" );\n\t},\n\tprev: function( elem ) {\n\t\treturn sibling( elem, \"previousSibling\" );\n\t},\n\tnextAll: function( elem ) {\n\t\treturn jQuery.dir( elem, \"nextSibling\" );\n\t},\n\tprevAll: function( elem ) {\n\t\treturn jQuery.dir( elem, \"previousSibling\" );\n\t},\n\tnextUntil: function( elem, i, until ) {\n\t\treturn jQuery.dir( elem, \"nextSibling\", until );\n\t},\n\tprevUntil: function( elem, i, until ) {\n\t\treturn jQuery.dir( elem, \"previousSibling\", until );\n\t},\n\tsiblings: function( elem ) {\n\t\treturn jQuery.sibling( ( elem.parentNode || {} ).firstChild, elem );\n\t},\n\tchildren: function( elem ) {\n\t\treturn jQuery.sibling( elem.firstChild );\n\t},\n\tcontents: function( elem ) {\n\t\treturn elem.contentDocument || jQuery.merge( [], elem.childNodes );\n\t}\n}, function( name, fn ) {\n\tjQuery.fn[ name ] = function( until, selector ) {\n\t\tvar matched = jQuery.map( this, fn, until );\n\n\t\tif ( name.slice( -5 ) !== \"Until\" ) {\n\t\t\tselector = until;\n\t\t}\n\n\t\tif ( selector && typeof selector === \"string\" ) {\n\t\t\tmatched = jQuery.filter( selector, matched );\n\t\t}\n\n\t\tif ( this.length > 1 ) {\n\t\t\t// Remove duplicates\n\t\t\tif ( !guaranteedUnique[ name ] ) {\n\t\t\t\tjQuery.unique( matched );\n\t\t\t}\n\n\t\t\t// Reverse order for parents* and prev-derivatives\n\t\t\tif ( rparentsprev.test( name ) ) {\n\t\t\t\tmatched.reverse();\n\t\t\t}\n\t\t}\n\n\t\treturn this.pushStack( matched );\n\t};\n});\nvar rnotwhite = (/\\S+/g);\n\n\n\n// String to Object options format cache\nvar optionsCache = {};\n\n// Convert String-formatted options into Object-formatted ones and store in cache\nfunction createOptions( options ) {\n\tvar object = optionsCache[ options ] = {};\n\tjQuery.each( options.match( rnotwhite ) || [], function( _, flag ) {\n\t\tobject[ flag ] = true;\n\t});\n\treturn object;\n}\n\n/*\n * Create a callback list using the following parameters:\n *\n *\toptions: an optional list of space-separated options that will change how\n *\t\t\tthe callback list behaves or a more traditional option object\n *\n * By default a callback list will act like an event callback list and can be\n * \"fired\" multiple times.\n *\n * Possible options:\n *\n *\tonce:\t\t\twill ensure the callback list can only be fired once (like a Deferred)\n *\n *\tmemory:\t\t\twill keep track of previous values and will call any callback added\n *\t\t\t\t\tafter the list has been fired right away with the latest \"memorized\"\n *\t\t\t\t\tvalues (like a Deferred)\n *\n *\tunique:\t\t\twill ensure a callback can only be added once (no duplicate in the list)\n *\n *\tstopOnFalse:\tinterrupt callings when a callback returns false\n *\n */\njQuery.Callbacks = function( options ) {\n\n\t// Convert options from String-formatted to Object-formatted if needed\n\t// (we check in cache first)\n\toptions = typeof options === \"string\" ?\n\t\t( optionsCache[ options ] || createOptions( options ) ) :\n\t\tjQuery.extend( {}, options );\n\n\tvar // Last fire value (for non-forgettable lists)\n\t\tmemory,\n\t\t// Flag to know if list was already fired\n\t\tfired,\n\t\t// Flag to know if list is currently firing\n\t\tfiring,\n\t\t// First callback to fire (used internally by add and fireWith)\n\t\tfiringStart,\n\t\t// End of the loop when firing\n\t\tfiringLength,\n\t\t// Index of currently firing callback (modified by remove if needed)\n\t\tfiringIndex,\n\t\t// Actual callback list\n\t\tlist = [],\n\t\t// Stack of fire calls for repeatable lists\n\t\tstack = !options.once && [],\n\t\t// Fire callbacks\n\t\tfire = function( data ) {\n\t\t\tmemory = options.memory && data;\n\t\t\tfired = true;\n\t\t\tfiringIndex = firingStart || 0;\n\t\t\tfiringStart = 0;\n\t\t\tfiringLength = list.length;\n\t\t\tfiring = true;\n\t\t\tfor ( ; list && firingIndex < firingLength; firingIndex++ ) {\n\t\t\t\tif ( list[ firingIndex ].apply( data[ 0 ], data[ 1 ] ) === false && options.stopOnFalse ) {\n\t\t\t\t\tmemory = false; // To prevent further calls using add\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tfiring = false;\n\t\t\tif ( list ) {\n\t\t\t\tif ( stack ) {\n\t\t\t\t\tif ( stack.length ) {\n\t\t\t\t\t\tfire( stack.shift() );\n\t\t\t\t\t}\n\t\t\t\t} else if ( memory ) {\n\t\t\t\t\tlist = [];\n\t\t\t\t} else {\n\t\t\t\t\tself.disable();\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t// Actual Callbacks object\n\t\tself = {\n\t\t\t// Add a callback or a collection of callbacks to the list\n\t\t\tadd: function() {\n\t\t\t\tif ( list ) {\n\t\t\t\t\t// First, we save the current length\n\t\t\t\t\tvar start = list.length;\n\t\t\t\t\t(function add( args ) {\n\t\t\t\t\t\tjQuery.each( args, function( _, arg ) {\n\t\t\t\t\t\t\tvar type = jQuery.type( arg );\n\t\t\t\t\t\t\tif ( type === \"function\" ) {\n\t\t\t\t\t\t\t\tif ( !options.unique || !self.has( arg ) ) {\n\t\t\t\t\t\t\t\t\tlist.push( arg );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if ( arg && arg.length && type !== \"string\" ) {\n\t\t\t\t\t\t\t\t// Inspect recursively\n\t\t\t\t\t\t\t\tadd( arg );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t})( arguments );\n\t\t\t\t\t// Do we need to add the callbacks to the\n\t\t\t\t\t// current firing batch?\n\t\t\t\t\tif ( firing ) {\n\t\t\t\t\t\tfiringLength = list.length;\n\t\t\t\t\t// With memory, if we're not firing then\n\t\t\t\t\t// we should call right away\n\t\t\t\t\t} else if ( memory ) {\n\t\t\t\t\t\tfiringStart = start;\n\t\t\t\t\t\tfire( memory );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Remove a callback from the list\n\t\t\tremove: function() {\n\t\t\t\tif ( list ) {\n\t\t\t\t\tjQuery.each( arguments, function( _, arg ) {\n\t\t\t\t\t\tvar index;\n\t\t\t\t\t\twhile ( ( index = jQuery.inArray( arg, list, index ) ) > -1 ) {\n\t\t\t\t\t\t\tlist.splice( index, 1 );\n\t\t\t\t\t\t\t// Handle firing indexes\n\t\t\t\t\t\t\tif ( firing ) {\n\t\t\t\t\t\t\t\tif ( index <= firingLength ) {\n\t\t\t\t\t\t\t\t\tfiringLength--;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( index <= firingIndex ) {\n\t\t\t\t\t\t\t\t\tfiringIndex--;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Check if a given callback is in the list.\n\t\t\t// If no argument is given, return whether or not list has callbacks attached.\n\t\t\thas: function( fn ) {\n\t\t\t\treturn fn ? jQuery.inArray( fn, list ) > -1 : !!( list && list.length );\n\t\t\t},\n\t\t\t// Remove all callbacks from the list\n\t\t\tempty: function() {\n\t\t\t\tlist = [];\n\t\t\t\tfiringLength = 0;\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Have the list do nothing anymore\n\t\t\tdisable: function() {\n\t\t\t\tlist = stack = memory = undefined;\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Is it disabled?\n\t\t\tdisabled: function() {\n\t\t\t\treturn !list;\n\t\t\t},\n\t\t\t// Lock the list in its current state\n\t\t\tlock: function() {\n\t\t\t\tstack = undefined;\n\t\t\t\tif ( !memory ) {\n\t\t\t\t\tself.disable();\n\t\t\t\t}\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Is it locked?\n\t\t\tlocked: function() {\n\t\t\t\treturn !stack;\n\t\t\t},\n\t\t\t// Call all callbacks with the given context and arguments\n\t\t\tfireWith: function( context, args ) {\n\t\t\t\tif ( list && ( !fired || stack ) ) {\n\t\t\t\t\targs = args || [];\n\t\t\t\t\targs = [ context, args.slice ? args.slice() : args ];\n\t\t\t\t\tif ( firing ) {\n\t\t\t\t\t\tstack.push( args );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfire( args );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// Call all the callbacks with the given arguments\n\t\t\tfire: function() {\n\t\t\t\tself.fireWith( this, arguments );\n\t\t\t\treturn this;\n\t\t\t},\n\t\t\t// To know if the callbacks have already been called at least once\n\t\t\tfired: function() {\n\t\t\t\treturn !!fired;\n\t\t\t}\n\t\t};\n\n\treturn self;\n};\n\n\njQuery.extend({\n\n\tDeferred: function( func ) {\n\t\tvar tuples = [\n\t\t\t\t// action, add listener, listener list, final state\n\t\t\t\t[ \"resolve\", \"done\", jQuery.Callbacks(\"once memory\"), \"resolved\" ],\n\t\t\t\t[ \"reject\", \"fail\", jQuery.Callbacks(\"once memory\"), \"rejected\" ],\n\t\t\t\t[ \"notify\", \"progress\", jQuery.Callbacks(\"memory\") ]\n\t\t\t],\n\t\t\tstate = \"pending\",\n\t\t\tpromise = {\n\t\t\t\tstate: function() {\n\t\t\t\t\treturn state;\n\t\t\t\t},\n\t\t\t\talways: function() {\n\t\t\t\t\tdeferred.done( arguments ).fail( arguments );\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tthen: function( /* fnDone, fnFail, fnProgress */ ) {\n\t\t\t\t\tvar fns = arguments;\n\t\t\t\t\treturn jQuery.Deferred(function( newDefer ) {\n\t\t\t\t\t\tjQuery.each( tuples, function( i, tuple ) {\n\t\t\t\t\t\t\tvar fn = jQuery.isFunction( fns[ i ] ) && fns[ i ];\n\t\t\t\t\t\t\t// deferred[ done | fail | progress ] for forwarding actions to newDefer\n\t\t\t\t\t\t\tdeferred[ tuple[1] ](function() {\n\t\t\t\t\t\t\t\tvar returned = fn && fn.apply( this, arguments );\n\t\t\t\t\t\t\t\tif ( returned && jQuery.isFunction( returned.promise ) ) {\n\t\t\t\t\t\t\t\t\treturned.promise()\n\t\t\t\t\t\t\t\t\t\t.done( newDefer.resolve )\n\t\t\t\t\t\t\t\t\t\t.fail( newDefer.reject )\n\t\t\t\t\t\t\t\t\t\t.progress( newDefer.notify );\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tnewDefer[ tuple[ 0 ] + \"With\" ]( this === promise ? newDefer.promise() : this, fn ? [ returned ] : arguments );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfns = null;\n\t\t\t\t\t}).promise();\n\t\t\t\t},\n\t\t\t\t// Get a promise for this deferred\n\t\t\t\t// If obj is provided, the promise aspect is added to the object\n\t\t\t\tpromise: function( obj ) {\n\t\t\t\t\treturn obj != null ? jQuery.extend( obj, promise ) : promise;\n\t\t\t\t}\n\t\t\t},\n\t\t\tdeferred = {};\n\n\t\t// Keep pipe for back-compat\n\t\tpromise.pipe = promise.then;\n\n\t\t// Add list-specific methods\n\t\tjQuery.each( tuples, function( i, tuple ) {\n\t\t\tvar list = tuple[ 2 ],\n\t\t\t\tstateString = tuple[ 3 ];\n\n\t\t\t// promise[ done | fail | progress ] = list.add\n\t\t\tpromise[ tuple[1] ] = list.add;\n\n\t\t\t// Handle state\n\t\t\tif ( stateString ) {\n\t\t\t\tlist.add(function() {\n\t\t\t\t\t// state = [ resolved | rejected ]\n\t\t\t\t\tstate = stateString;\n\n\t\t\t\t// [ reject_list | resolve_list ].disable; progress_list.lock\n\t\t\t\t}, tuples[ i ^ 1 ][ 2 ].disable, tuples[ 2 ][ 2 ].lock );\n\t\t\t}\n\n\t\t\t// deferred[ resolve | reject | notify ]\n\t\t\tdeferred[ tuple[0] ] = function() {\n\t\t\t\tdeferred[ tuple[0] + \"With\" ]( this === deferred ? promise : this, arguments );\n\t\t\t\treturn this;\n\t\t\t};\n\t\t\tdeferred[ tuple[0] + \"With\" ] = list.fireWith;\n\t\t});\n\n\t\t// Make the deferred a promise\n\t\tpromise.promise( deferred );\n\n\t\t// Call given func if any\n\t\tif ( func ) {\n\t\t\tfunc.call( deferred, deferred );\n\t\t}\n\n\t\t// All done!\n\t\treturn deferred;\n\t},\n\n\t// Deferred helper\n\twhen: function( subordinate /* , ..., subordinateN */ ) {\n\t\tvar i = 0,\n\t\t\tresolveValues = slice.call( arguments ),\n\t\t\tlength = resolveValues.length,\n\n\t\t\t// the count of uncompleted subordinates\n\t\t\tremaining = length !== 1 || ( subordinate && jQuery.isFunction( subordinate.promise ) ) ? length : 0,\n\n\t\t\t// the master Deferred. If resolveValues consist of only a single Deferred, just use that.\n\t\t\tdeferred = remaining === 1 ? subordinate : jQuery.Deferred(),\n\n\t\t\t// Update function for both resolve and progress values\n\t\t\tupdateFunc = function( i, contexts, values ) {\n\t\t\t\treturn function( value ) {\n\t\t\t\t\tcontexts[ i ] = this;\n\t\t\t\t\tvalues[ i ] = arguments.length > 1 ? slice.call( arguments ) : value;\n\t\t\t\t\tif ( values === progressValues ) {\n\t\t\t\t\t\tdeferred.notifyWith( contexts, values );\n\t\t\t\t\t} else if ( !( --remaining ) ) {\n\t\t\t\t\t\tdeferred.resolveWith( contexts, values );\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\n\t\t\tprogressValues, progressContexts, resolveContexts;\n\n\t\t// add listeners to Deferred subordinates; treat others as resolved\n\t\tif ( length > 1 ) {\n\t\t\tprogressValues = new Array( length );\n\t\t\tprogressContexts = new Array( length );\n\t\t\tresolveContexts = new Array( length );\n\t\t\tfor ( ; i < length; i++ ) {\n\t\t\t\tif ( resolveValues[ i ] && jQuery.isFunction( resolveValues[ i ].promise ) ) {\n\t\t\t\t\tresolveValues[ i ].promise()\n\t\t\t\t\t\t.done( updateFunc( i, resolveContexts, resolveValues ) )\n\t\t\t\t\t\t.fail( deferred.reject )\n\t\t\t\t\t\t.progress( updateFunc( i, progressContexts, progressValues ) );\n\t\t\t\t} else {\n\t\t\t\t\t--remaining;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// if we're not waiting on anything, resolve the master\n\t\tif ( !remaining ) {\n\t\t\tdeferred.resolveWith( resolveContexts, resolveValues );\n\t\t}\n\n\t\treturn deferred.promise();\n\t}\n});\n\n\n// The deferred used on DOM ready\nvar readyList;\n\njQuery.fn.ready = function( fn ) {\n\t// Add the callback\n\tjQuery.ready.promise().done( fn );\n\n\treturn this;\n};\n\njQuery.extend({\n\t// Is the DOM ready to be used? Set to true once it occurs.\n\tisReady: false,\n\n\t// A counter to track how many items to wait for before\n\t// the ready event fires. See #6781\n\treadyWait: 1,\n\n\t// Hold (or release) the ready event\n\tholdReady: function( hold ) {\n\t\tif ( hold ) {\n\t\t\tjQuery.readyWait++;\n\t\t} else {\n\t\t\tjQuery.ready( true );\n\t\t}\n\t},\n\n\t// Handle when the DOM is ready\n\tready: function( wait ) {\n\n\t\t// Abort if there are pending holds or we're already ready\n\t\tif ( wait === true ? --jQuery.readyWait : jQuery.isReady ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Remember that the DOM is ready\n\t\tjQuery.isReady = true;\n\n\t\t// If a normal DOM Ready event fired, decrement, and wait if need be\n\t\tif ( wait !== true && --jQuery.readyWait > 0 ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If there are functions bound, to execute\n\t\treadyList.resolveWith( document, [ jQuery ] );\n\n\t\t// Trigger any bound ready events\n\t\tif ( jQuery.fn.triggerHandler ) {\n\t\t\tjQuery( document ).triggerHandler( \"ready\" );\n\t\t\tjQuery( document ).off( \"ready\" );\n\t\t}\n\t}\n});\n\n/**\n * The ready event handler and self cleanup method\n */\nfunction completed() {\n\tdocument.removeEventListener( \"DOMContentLoaded\", completed, false );\n\twindow.removeEventListener( \"load\", completed, false );\n\tjQuery.ready();\n}\n\njQuery.ready.promise = function( obj ) {\n\tif ( !readyList ) {\n\n\t\treadyList = jQuery.Deferred();\n\n\t\t// Catch cases where $(document).ready() is called after the browser event has already occurred.\n\t\t// we once tried to use readyState \"interactive\" here, but it caused issues like the one\n\t\t// discovered by ChrisS here: http://bugs.jquery.com/ticket/12282#comment:15\n\t\tif ( document.readyState === \"complete\" ) {\n\t\t\t// Handle it asynchronously to allow scripts the opportunity to delay ready\n\t\t\tsetTimeout( jQuery.ready );\n\n\t\t} else {\n\n\t\t\t// Use the handy event callback\n\t\t\tdocument.addEventListener( \"DOMContentLoaded\", completed, false );\n\n\t\t\t// A fallback to window.onload, that will always work\n\t\t\twindow.addEventListener( \"load\", completed, false );\n\t\t}\n\t}\n\treturn readyList.promise( obj );\n};\n\n// Kick off the DOM ready check even if the user does not\njQuery.ready.promise();\n\n\n\n\n// Multifunctional method to get and set values of a collection\n// The value/s can optionally be executed if it's a function\nvar access = jQuery.access = function( elems, fn, key, value, chainable, emptyGet, raw ) {\n\tvar i = 0,\n\t\tlen = elems.length,\n\t\tbulk = key == null;\n\n\t// Sets many values\n\tif ( jQuery.type( key ) === \"object\" ) {\n\t\tchainable = true;\n\t\tfor ( i in key ) {\n\t\t\tjQuery.access( elems, fn, i, key[i], true, emptyGet, raw );\n\t\t}\n\n\t// Sets one value\n\t} else if ( value !== undefined ) {\n\t\tchainable = true;\n\n\t\tif ( !jQuery.isFunction( value ) ) {\n\t\t\traw = true;\n\t\t}\n\n\t\tif ( bulk ) {\n\t\t\t// Bulk operations run against the entire set\n\t\t\tif ( raw ) {\n\t\t\t\tfn.call( elems, value );\n\t\t\t\tfn = null;\n\n\t\t\t// ...except when executing function values\n\t\t\t} else {\n\t\t\t\tbulk = fn;\n\t\t\t\tfn = function( elem, key, value ) {\n\t\t\t\t\treturn bulk.call( jQuery( elem ), value );\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tif ( fn ) {\n\t\t\tfor ( ; i < len; i++ ) {\n\t\t\t\tfn( elems[i], key, raw ? value : value.call( elems[i], i, fn( elems[i], key ) ) );\n\t\t\t}\n\t\t}\n\t}\n\n\treturn chainable ?\n\t\telems :\n\n\t\t// Gets\n\t\tbulk ?\n\t\t\tfn.call( elems ) :\n\t\t\tlen ? fn( elems[0], key ) : emptyGet;\n};\n\n\n/**\n * Determines whether an object can have data\n */\njQuery.acceptData = function( owner ) {\n\t// Accepts only:\n\t//  - Node\n\t//    - Node.ELEMENT_NODE\n\t//    - Node.DOCUMENT_NODE\n\t//  - Object\n\t//    - Any\n\t/* jshint -W018 */\n\treturn owner.nodeType === 1 || owner.nodeType === 9 || !( +owner.nodeType );\n};\n\n\nfunction Data() {\n\t// Support: Android < 4,\n\t// Old WebKit does not have Object.preventExtensions/freeze method,\n\t// return new empty object instead with no [[set]] accessor\n\tObject.defineProperty( this.cache = {}, 0, {\n\t\tget: function() {\n\t\t\treturn {};\n\t\t}\n\t});\n\n\tthis.expando = jQuery.expando + Math.random();\n}\n\nData.uid = 1;\nData.accepts = jQuery.acceptData;\n\nData.prototype = {\n\tkey: function( owner ) {\n\t\t// We can accept data for non-element nodes in modern browsers,\n\t\t// but we should not, see #8335.\n\t\t// Always return the key for a frozen object.\n\t\tif ( !Data.accepts( owner ) ) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tvar descriptor = {},\n\t\t\t// Check if the owner object already has a cache key\n\t\t\tunlock = owner[ this.expando ];\n\n\t\t// If not, create one\n\t\tif ( !unlock ) {\n\t\t\tunlock = Data.uid++;\n\n\t\t\t// Secure it in a non-enumerable, non-writable property\n\t\t\ttry {\n\t\t\t\tdescriptor[ this.expando ] = { value: unlock };\n\t\t\t\tObject.defineProperties( owner, descriptor );\n\n\t\t\t// Support: Android < 4\n\t\t\t// Fallback to a less secure definition\n\t\t\t} catch ( e ) {\n\t\t\t\tdescriptor[ this.expando ] = unlock;\n\t\t\t\tjQuery.extend( owner, descriptor );\n\t\t\t}\n\t\t}\n\n\t\t// Ensure the cache object\n\t\tif ( !this.cache[ unlock ] ) {\n\t\t\tthis.cache[ unlock ] = {};\n\t\t}\n\n\t\treturn unlock;\n\t},\n\tset: function( owner, data, value ) {\n\t\tvar prop,\n\t\t\t// There may be an unlock assigned to this node,\n\t\t\t// if there is no entry for this \"owner\", create one inline\n\t\t\t// and set the unlock as though an owner entry had always existed\n\t\t\tunlock = this.key( owner ),\n\t\t\tcache = this.cache[ unlock ];\n\n\t\t// Handle: [ owner, key, value ] args\n\t\tif ( typeof data === \"string\" ) {\n\t\t\tcache[ data ] = value;\n\n\t\t// Handle: [ owner, { properties } ] args\n\t\t} else {\n\t\t\t// Fresh assignments by object are shallow copied\n\t\t\tif ( jQuery.isEmptyObject( cache ) ) {\n\t\t\t\tjQuery.extend( this.cache[ unlock ], data );\n\t\t\t// Otherwise, copy the properties one-by-one to the cache object\n\t\t\t} else {\n\t\t\t\tfor ( prop in data ) {\n\t\t\t\t\tcache[ prop ] = data[ prop ];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn cache;\n\t},\n\tget: function( owner, key ) {\n\t\t// Either a valid cache is found, or will be created.\n\t\t// New caches will be created and the unlock returned,\n\t\t// allowing direct access to the newly created\n\t\t// empty data object. A valid owner object must be provided.\n\t\tvar cache = this.cache[ this.key( owner ) ];\n\n\t\treturn key === undefined ?\n\t\t\tcache : cache[ key ];\n\t},\n\taccess: function( owner, key, value ) {\n\t\tvar stored;\n\t\t// In cases where either:\n\t\t//\n\t\t//   1. No key was specified\n\t\t//   2. A string key was specified, but no value provided\n\t\t//\n\t\t// Take the \"read\" path and allow the get method to determine\n\t\t// which value to return, respectively either:\n\t\t//\n\t\t//   1. The entire cache object\n\t\t//   2. The data stored at the key\n\t\t//\n\t\tif ( key === undefined ||\n\t\t\t\t((key && typeof key === \"string\") && value === undefined) ) {\n\n\t\t\tstored = this.get( owner, key );\n\n\t\t\treturn stored !== undefined ?\n\t\t\t\tstored : this.get( owner, jQuery.camelCase(key) );\n\t\t}\n\n\t\t// [*]When the key is not a string, or both a key and value\n\t\t// are specified, set or extend (existing objects) with either:\n\t\t//\n\t\t//   1. An object of properties\n\t\t//   2. A key and value\n\t\t//\n\t\tthis.set( owner, key, value );\n\n\t\t// Since the \"set\" path can have two possible entry points\n\t\t// return the expected data based on which path was taken[*]\n\t\treturn value !== undefined ? value : key;\n\t},\n\tremove: function( owner, key ) {\n\t\tvar i, name, camel,\n\t\t\tunlock = this.key( owner ),\n\t\t\tcache = this.cache[ unlock ];\n\n\t\tif ( key === undefined ) {\n\t\t\tthis.cache[ unlock ] = {};\n\n\t\t} else {\n\t\t\t// Support array or space separated string of keys\n\t\t\tif ( jQuery.isArray( key ) ) {\n\t\t\t\t// If \"name\" is an array of keys...\n\t\t\t\t// When data is initially created, via (\"key\", \"val\") signature,\n\t\t\t\t// keys will be converted to camelCase.\n\t\t\t\t// Since there is no way to tell _how_ a key was added, remove\n\t\t\t\t// both plain key and camelCase key. #12786\n\t\t\t\t// This will only penalize the array argument path.\n\t\t\t\tname = key.concat( key.map( jQuery.camelCase ) );\n\t\t\t} else {\n\t\t\t\tcamel = jQuery.camelCase( key );\n\t\t\t\t// Try the string as a key before any manipulation\n\t\t\t\tif ( key in cache ) {\n\t\t\t\t\tname = [ key, camel ];\n\t\t\t\t} else {\n\t\t\t\t\t// If a key with the spaces exists, use it.\n\t\t\t\t\t// Otherwise, create an array by matching non-whitespace\n\t\t\t\t\tname = camel;\n\t\t\t\t\tname = name in cache ?\n\t\t\t\t\t\t[ name ] : ( name.match( rnotwhite ) || [] );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ti = name.length;\n\t\t\twhile ( i-- ) {\n\t\t\t\tdelete cache[ name[ i ] ];\n\t\t\t}\n\t\t}\n\t},\n\thasData: function( owner ) {\n\t\treturn !jQuery.isEmptyObject(\n\t\t\tthis.cache[ owner[ this.expando ] ] || {}\n\t\t);\n\t},\n\tdiscard: function( owner ) {\n\t\tif ( owner[ this.expando ] ) {\n\t\t\tdelete this.cache[ owner[ this.expando ] ];\n\t\t}\n\t}\n};\nvar data_priv = new Data();\n\nvar data_user = new Data();\n\n\n\n/*\n\tImplementation Summary\n\n\t1. Enforce API surface and semantic compatibility with 1.9.x branch\n\t2. Improve the module's maintainability by reducing the storage\n\t\tpaths to a single mechanism.\n\t3. Use the same single mechanism to support \"private\" and \"user\" data.\n\t4. _Never_ expose \"private\" data to user code (TODO: Drop _data, _removeData)\n\t5. Avoid exposing implementation details on user objects (eg. expando properties)\n\t6. Provide a clear path for implementation upgrade to WeakMap in 2014\n*/\nvar rbrace = /^(?:\\{[\\w\\W]*\\}|\\[[\\w\\W]*\\])$/,\n\trmultiDash = /([A-Z])/g;\n\nfunction dataAttr( elem, key, data ) {\n\tvar name;\n\n\t// If nothing was found internally, try to fetch any\n\t// data from the HTML5 data-* attribute\n\tif ( data === undefined && elem.nodeType === 1 ) {\n\t\tname = \"data-\" + key.replace( rmultiDash, \"-$1\" ).toLowerCase();\n\t\tdata = elem.getAttribute( name );\n\n\t\tif ( typeof data === \"string\" ) {\n\t\t\ttry {\n\t\t\t\tdata = data === \"true\" ? true :\n\t\t\t\t\tdata === \"false\" ? false :\n\t\t\t\t\tdata === \"null\" ? null :\n\t\t\t\t\t// Only convert to a number if it doesn't change the string\n\t\t\t\t\t+data + \"\" === data ? +data :\n\t\t\t\t\trbrace.test( data ) ? jQuery.parseJSON( data ) :\n\t\t\t\t\tdata;\n\t\t\t} catch( e ) {}\n\n\t\t\t// Make sure we set the data so it isn't changed later\n\t\t\tdata_user.set( elem, key, data );\n\t\t} else {\n\t\t\tdata = undefined;\n\t\t}\n\t}\n\treturn data;\n}\n\njQuery.extend({\n\thasData: function( elem ) {\n\t\treturn data_user.hasData( elem ) || data_priv.hasData( elem );\n\t},\n\n\tdata: function( elem, name, data ) {\n\t\treturn data_user.access( elem, name, data );\n\t},\n\n\tremoveData: function( elem, name ) {\n\t\tdata_user.remove( elem, name );\n\t},\n\n\t// TODO: Now that all calls to _data and _removeData have been replaced\n\t// with direct calls to data_priv methods, these can be deprecated.\n\t_data: function( elem, name, data ) {\n\t\treturn data_priv.access( elem, name, data );\n\t},\n\n\t_removeData: function( elem, name ) {\n\t\tdata_priv.remove( elem, name );\n\t}\n});\n\njQuery.fn.extend({\n\tdata: function( key, value ) {\n\t\tvar i, name, data,\n\t\t\telem = this[ 0 ],\n\t\t\tattrs = elem && elem.attributes;\n\n\t\t// Gets all values\n\t\tif ( key === undefined ) {\n\t\t\tif ( this.length ) {\n\t\t\t\tdata = data_user.get( elem );\n\n\t\t\t\tif ( elem.nodeType === 1 && !data_priv.get( elem, \"hasDataAttrs\" ) ) {\n\t\t\t\t\ti = attrs.length;\n\t\t\t\t\twhile ( i-- ) {\n\n\t\t\t\t\t\t// Support: IE11+\n\t\t\t\t\t\t// The attrs elements can be null (#14894)\n\t\t\t\t\t\tif ( attrs[ i ] ) {\n\t\t\t\t\t\t\tname = attrs[ i ].name;\n\t\t\t\t\t\t\tif ( name.indexOf( \"data-\" ) === 0 ) {\n\t\t\t\t\t\t\t\tname = jQuery.camelCase( name.slice(5) );\n\t\t\t\t\t\t\t\tdataAttr( elem, name, data[ name ] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tdata_priv.set( elem, \"hasDataAttrs\", true );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn data;\n\t\t}\n\n\t\t// Sets multiple values\n\t\tif ( typeof key === \"object\" ) {\n\t\t\treturn this.each(function() {\n\t\t\t\tdata_user.set( this, key );\n\t\t\t});\n\t\t}\n\n\t\treturn access( this, function( value ) {\n\t\t\tvar data,\n\t\t\t\tcamelKey = jQuery.camelCase( key );\n\n\t\t\t// The calling jQuery object (element matches) is not empty\n\t\t\t// (and therefore has an element appears at this[ 0 ]) and the\n\t\t\t// `value` parameter was not undefined. An empty jQuery object\n\t\t\t// will result in `undefined` for elem = this[ 0 ] which will\n\t\t\t// throw an exception if an attempt to read a data cache is made.\n\t\t\tif ( elem && value === undefined ) {\n\t\t\t\t// Attempt to get data from the cache\n\t\t\t\t// with the key as-is\n\t\t\t\tdata = data_user.get( elem, key );\n\t\t\t\tif ( data !== undefined ) {\n\t\t\t\t\treturn data;\n\t\t\t\t}\n\n\t\t\t\t// Attempt to get data from the cache\n\t\t\t\t// with the key camelized\n\t\t\t\tdata = data_user.get( elem, camelKey );\n\t\t\t\tif ( data !== undefined ) {\n\t\t\t\t\treturn data;\n\t\t\t\t}\n\n\t\t\t\t// Attempt to \"discover\" the data in\n\t\t\t\t// HTML5 custom data-* attrs\n\t\t\t\tdata = dataAttr( elem, camelKey, undefined );\n\t\t\t\tif ( data !== undefined ) {\n\t\t\t\t\treturn data;\n\t\t\t\t}\n\n\t\t\t\t// We tried really hard, but the data doesn't exist.\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Set the data...\n\t\t\tthis.each(function() {\n\t\t\t\t// First, attempt to store a copy or reference of any\n\t\t\t\t// data that might've been store with a camelCased key.\n\t\t\t\tvar data = data_user.get( this, camelKey );\n\n\t\t\t\t// For HTML5 data-* attribute interop, we have to\n\t\t\t\t// store property names with dashes in a camelCase form.\n\t\t\t\t// This might not apply to all properties...*\n\t\t\t\tdata_user.set( this, camelKey, value );\n\n\t\t\t\t// *... In the case of properties that might _actually_\n\t\t\t\t// have dashes, we need to also store a copy of that\n\t\t\t\t// unchanged property.\n\t\t\t\tif ( key.indexOf(\"-\") !== -1 && data !== undefined ) {\n\t\t\t\t\tdata_user.set( this, key, value );\n\t\t\t\t}\n\t\t\t});\n\t\t}, null, value, arguments.length > 1, null, true );\n\t},\n\n\tremoveData: function( key ) {\n\t\treturn this.each(function() {\n\t\t\tdata_user.remove( this, key );\n\t\t});\n\t}\n});\n\n\njQuery.extend({\n\tqueue: function( elem, type, data ) {\n\t\tvar queue;\n\n\t\tif ( elem ) {\n\t\t\ttype = ( type || \"fx\" ) + \"queue\";\n\t\t\tqueue = data_priv.get( elem, type );\n\n\t\t\t// Speed up dequeue by getting out quickly if this is just a lookup\n\t\t\tif ( data ) {\n\t\t\t\tif ( !queue || jQuery.isArray( data ) ) {\n\t\t\t\t\tqueue = data_priv.access( elem, type, jQuery.makeArray(data) );\n\t\t\t\t} else {\n\t\t\t\t\tqueue.push( data );\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn queue || [];\n\t\t}\n\t},\n\n\tdequeue: function( elem, type ) {\n\t\ttype = type || \"fx\";\n\n\t\tvar queue = jQuery.queue( elem, type ),\n\t\t\tstartLength = queue.length,\n\t\t\tfn = queue.shift(),\n\t\t\thooks = jQuery._queueHooks( elem, type ),\n\t\t\tnext = function() {\n\t\t\t\tjQuery.dequeue( elem, type );\n\t\t\t};\n\n\t\t// If the fx queue is dequeued, always remove the progress sentinel\n\t\tif ( fn === \"inprogress\" ) {\n\t\t\tfn = queue.shift();\n\t\t\tstartLength--;\n\t\t}\n\n\t\tif ( fn ) {\n\n\t\t\t// Add a progress sentinel to prevent the fx queue from being\n\t\t\t// automatically dequeued\n\t\t\tif ( type === \"fx\" ) {\n\t\t\t\tqueue.unshift( \"inprogress\" );\n\t\t\t}\n\n\t\t\t// clear up the last queue stop function\n\t\t\tdelete hooks.stop;\n\t\t\tfn.call( elem, next, hooks );\n\t\t}\n\n\t\tif ( !startLength && hooks ) {\n\t\t\thooks.empty.fire();\n\t\t}\n\t},\n\n\t// not intended for public consumption - generates a queueHooks object, or returns the current one\n\t_queueHooks: function( elem, type ) {\n\t\tvar key = type + \"queueHooks\";\n\t\treturn data_priv.get( elem, key ) || data_priv.access( elem, key, {\n\t\t\tempty: jQuery.Callbacks(\"once memory\").add(function() {\n\t\t\t\tdata_priv.remove( elem, [ type + \"queue\", key ] );\n\t\t\t})\n\t\t});\n\t}\n});\n\njQuery.fn.extend({\n\tqueue: function( type, data ) {\n\t\tvar setter = 2;\n\n\t\tif ( typeof type !== \"string\" ) {\n\t\t\tdata = type;\n\t\t\ttype = \"fx\";\n\t\t\tsetter--;\n\t\t}\n\n\t\tif ( arguments.length < setter ) {\n\t\t\treturn jQuery.queue( this[0], type );\n\t\t}\n\n\t\treturn data === undefined ?\n\t\t\tthis :\n\t\t\tthis.each(function() {\n\t\t\t\tvar queue = jQuery.queue( this, type, data );\n\n\t\t\t\t// ensure a hooks for this queue\n\t\t\t\tjQuery._queueHooks( this, type );\n\n\t\t\t\tif ( type === \"fx\" && queue[0] !== \"inprogress\" ) {\n\t\t\t\t\tjQuery.dequeue( this, type );\n\t\t\t\t}\n\t\t\t});\n\t},\n\tdequeue: function( type ) {\n\t\treturn this.each(function() {\n\t\t\tjQuery.dequeue( this, type );\n\t\t});\n\t},\n\tclearQueue: function( type ) {\n\t\treturn this.queue( type || \"fx\", [] );\n\t},\n\t// Get a promise resolved when queues of a certain type\n\t// are emptied (fx is the type by default)\n\tpromise: function( type, obj ) {\n\t\tvar tmp,\n\t\t\tcount = 1,\n\t\t\tdefer = jQuery.Deferred(),\n\t\t\telements = this,\n\t\t\ti = this.length,\n\t\t\tresolve = function() {\n\t\t\t\tif ( !( --count ) ) {\n\t\t\t\t\tdefer.resolveWith( elements, [ elements ] );\n\t\t\t\t}\n\t\t\t};\n\n\t\tif ( typeof type !== \"string\" ) {\n\t\t\tobj = type;\n\t\t\ttype = undefined;\n\t\t}\n\t\ttype = type || \"fx\";\n\n\t\twhile ( i-- ) {\n\t\t\ttmp = data_priv.get( elements[ i ], type + \"queueHooks\" );\n\t\t\tif ( tmp && tmp.empty ) {\n\t\t\t\tcount++;\n\t\t\t\ttmp.empty.add( resolve );\n\t\t\t}\n\t\t}\n\t\tresolve();\n\t\treturn defer.promise( obj );\n\t}\n});\nvar pnum = (/[+-]?(?:\\d*\\.|)\\d+(?:[eE][+-]?\\d+|)/).source;\n\nvar cssExpand = [ \"Top\", \"Right\", \"Bottom\", \"Left\" ];\n\nvar isHidden = function( elem, el ) {\n\t\t// isHidden might be called from jQuery#filter function;\n\t\t// in that case, element will be second argument\n\t\telem = el || elem;\n\t\treturn jQuery.css( elem, \"display\" ) === \"none\" || !jQuery.contains( elem.ownerDocument, elem );\n\t};\n\nvar rcheckableType = (/^(?:checkbox|radio)$/i);\n\n\n\n(function() {\n\tvar fragment = document.createDocumentFragment(),\n\t\tdiv = fragment.appendChild( document.createElement( \"div\" ) ),\n\t\tinput = document.createElement( \"input\" );\n\n\t// #11217 - WebKit loses check when the name is after the checked attribute\n\t// Support: Windows Web Apps (WWA)\n\t// `name` and `type` need .setAttribute for WWA\n\tinput.setAttribute( \"type\", \"radio\" );\n\tinput.setAttribute( \"checked\", \"checked\" );\n\tinput.setAttribute( \"name\", \"t\" );\n\n\tdiv.appendChild( input );\n\n\t// Support: Safari 5.1, iOS 5.1, Android 4.x, Android 2.3\n\t// old WebKit doesn't clone checked state correctly in fragments\n\tsupport.checkClone = div.cloneNode( true ).cloneNode( true ).lastChild.checked;\n\n\t// Make sure textarea (and checkbox) defaultValue is properly cloned\n\t// Support: IE9-IE11+\n\tdiv.innerHTML = \"<textarea>x</textarea>\";\n\tsupport.noCloneChecked = !!div.cloneNode( true ).lastChild.defaultValue;\n})();\nvar strundefined = typeof undefined;\n\n\n\nsupport.focusinBubbles = \"onfocusin\" in window;\n\n\nvar\n\trkeyEvent = /^key/,\n\trmouseEvent = /^(?:mouse|pointer|contextmenu)|click/,\n\trfocusMorph = /^(?:focusinfocus|focusoutblur)$/,\n\trtypenamespace = /^([^.]*)(?:\\.(.+)|)$/;\n\nfunction returnTrue() {\n\treturn true;\n}\n\nfunction returnFalse() {\n\treturn false;\n}\n\nfunction safeActiveElement() {\n\ttry {\n\t\treturn document.activeElement;\n\t} catch ( err ) { }\n}\n\n/*\n * Helper functions for managing events -- not part of the public interface.\n * Props to Dean Edwards' addEvent library for many of the ideas.\n */\njQuery.event = {\n\n\tglobal: {},\n\n\tadd: function( elem, types, handler, data, selector ) {\n\n\t\tvar handleObjIn, eventHandle, tmp,\n\t\t\tevents, t, handleObj,\n\t\t\tspecial, handlers, type, namespaces, origType,\n\t\t\telemData = data_priv.get( elem );\n\n\t\t// Don't attach events to noData or text/comment nodes (but allow plain objects)\n\t\tif ( !elemData ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Caller can pass in an object of custom data in lieu of the handler\n\t\tif ( handler.handler ) {\n\t\t\thandleObjIn = handler;\n\t\t\thandler = handleObjIn.handler;\n\t\t\tselector = handleObjIn.selector;\n\t\t}\n\n\t\t// Make sure that the handler has a unique ID, used to find/remove it later\n\t\tif ( !handler.guid ) {\n\t\t\thandler.guid = jQuery.guid++;\n\t\t}\n\n\t\t// Init the element's event structure and main handler, if this is the first\n\t\tif ( !(events = elemData.events) ) {\n\t\t\tevents = elemData.events = {};\n\t\t}\n\t\tif ( !(eventHandle = elemData.handle) ) {\n\t\t\teventHandle = elemData.handle = function( e ) {\n\t\t\t\t// Discard the second event of a jQuery.event.trigger() and\n\t\t\t\t// when an event is called after a page has unloaded\n\t\t\t\treturn typeof jQuery !== strundefined && jQuery.event.triggered !== e.type ?\n\t\t\t\t\tjQuery.event.dispatch.apply( elem, arguments ) : undefined;\n\t\t\t};\n\t\t}\n\n\t\t// Handle multiple events separated by a space\n\t\ttypes = ( types || \"\" ).match( rnotwhite ) || [ \"\" ];\n\t\tt = types.length;\n\t\twhile ( t-- ) {\n\t\t\ttmp = rtypenamespace.exec( types[t] ) || [];\n\t\t\ttype = origType = tmp[1];\n\t\t\tnamespaces = ( tmp[2] || \"\" ).split( \".\" ).sort();\n\n\t\t\t// There *must* be a type, no attaching namespace-only handlers\n\t\t\tif ( !type ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// If event changes its type, use the special event handlers for the changed type\n\t\t\tspecial = jQuery.event.special[ type ] || {};\n\n\t\t\t// If selector defined, determine special event api type, otherwise given type\n\t\t\ttype = ( selector ? special.delegateType : special.bindType ) || type;\n\n\t\t\t// Update special based on newly reset type\n\t\t\tspecial = jQuery.event.special[ type ] || {};\n\n\t\t\t// handleObj is passed to all event handlers\n\t\t\thandleObj = jQuery.extend({\n\t\t\t\ttype: type,\n\t\t\t\torigType: origType,\n\t\t\t\tdata: data,\n\t\t\t\thandler: handler,\n\t\t\t\tguid: handler.guid,\n\t\t\t\tselector: selector,\n\t\t\t\tneedsContext: selector && jQuery.expr.match.needsContext.test( selector ),\n\t\t\t\tnamespace: namespaces.join(\".\")\n\t\t\t}, handleObjIn );\n\n\t\t\t// Init the event handler queue if we're the first\n\t\t\tif ( !(handlers = events[ type ]) ) {\n\t\t\t\thandlers = events[ type ] = [];\n\t\t\t\thandlers.delegateCount = 0;\n\n\t\t\t\t// Only use addEventListener if the special events handler returns false\n\t\t\t\tif ( !special.setup || special.setup.call( elem, data, namespaces, eventHandle ) === false ) {\n\t\t\t\t\tif ( elem.addEventListener ) {\n\t\t\t\t\t\telem.addEventListener( type, eventHandle, false );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( special.add ) {\n\t\t\t\tspecial.add.call( elem, handleObj );\n\n\t\t\t\tif ( !handleObj.handler.guid ) {\n\t\t\t\t\thandleObj.handler.guid = handler.guid;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add to the element's handler list, delegates in front\n\t\t\tif ( selector ) {\n\t\t\t\thandlers.splice( handlers.delegateCount++, 0, handleObj );\n\t\t\t} else {\n\t\t\t\thandlers.push( handleObj );\n\t\t\t}\n\n\t\t\t// Keep track of which events have ever been used, for event optimization\n\t\t\tjQuery.event.global[ type ] = true;\n\t\t}\n\n\t},\n\n\t// Detach an event or set of events from an element\n\tremove: function( elem, types, handler, selector, mappedTypes ) {\n\n\t\tvar j, origCount, tmp,\n\t\t\tevents, t, handleObj,\n\t\t\tspecial, handlers, type, namespaces, origType,\n\t\t\telemData = data_priv.hasData( elem ) && data_priv.get( elem );\n\n\t\tif ( !elemData || !(events = elemData.events) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Once for each type.namespace in types; type may be omitted\n\t\ttypes = ( types || \"\" ).match( rnotwhite ) || [ \"\" ];\n\t\tt = types.length;\n\t\twhile ( t-- ) {\n\t\t\ttmp = rtypenamespace.exec( types[t] ) || [];\n\t\t\ttype = origType = tmp[1];\n\t\t\tnamespaces = ( tmp[2] || \"\" ).split( \".\" ).sort();\n\n\t\t\t// Unbind all events (on this namespace, if provided) for the element\n\t\t\tif ( !type ) {\n\t\t\t\tfor ( type in events ) {\n\t\t\t\t\tjQuery.event.remove( elem, type + types[ t ], handler, selector, true );\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tspecial = jQuery.event.special[ type ] || {};\n\t\t\ttype = ( selector ? special.delegateType : special.bindType ) || type;\n\t\t\thandlers = events[ type ] || [];\n\t\t\ttmp = tmp[2] && new RegExp( \"(^|\\\\.)\" + namespaces.join(\"\\\\.(?:.*\\\\.|)\") + \"(\\\\.|$)\" );\n\n\t\t\t// Remove matching events\n\t\t\torigCount = j = handlers.length;\n\t\t\twhile ( j-- ) {\n\t\t\t\thandleObj = handlers[ j ];\n\n\t\t\t\tif ( ( mappedTypes || origType === handleObj.origType ) &&\n\t\t\t\t\t( !handler || handler.guid === handleObj.guid ) &&\n\t\t\t\t\t( !tmp || tmp.test( handleObj.namespace ) ) &&\n\t\t\t\t\t( !selector || selector === handleObj.selector || selector === \"**\" && handleObj.selector ) ) {\n\t\t\t\t\thandlers.splice( j, 1 );\n\n\t\t\t\t\tif ( handleObj.selector ) {\n\t\t\t\t\t\thandlers.delegateCount--;\n\t\t\t\t\t}\n\t\t\t\t\tif ( special.remove ) {\n\t\t\t\t\t\tspecial.remove.call( elem, handleObj );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Remove generic event handler if we removed something and no more handlers exist\n\t\t\t// (avoids potential for endless recursion during removal of special event handlers)\n\t\t\tif ( origCount && !handlers.length ) {\n\t\t\t\tif ( !special.teardown || special.teardown.call( elem, namespaces, elemData.handle ) === false ) {\n\t\t\t\t\tjQuery.removeEvent( elem, type, elemData.handle );\n\t\t\t\t}\n\n\t\t\t\tdelete events[ type ];\n\t\t\t}\n\t\t}\n\n\t\t// Remove the expando if it's no longer used\n\t\tif ( jQuery.isEmptyObject( events ) ) {\n\t\t\tdelete elemData.handle;\n\t\t\tdata_priv.remove( elem, \"events\" );\n\t\t}\n\t},\n\n\ttrigger: function( event, data, elem, onlyHandlers ) {\n\n\t\tvar i, cur, tmp, bubbleType, ontype, handle, special,\n\t\t\teventPath = [ elem || document ],\n\t\t\ttype = hasOwn.call( event, \"type\" ) ? event.type : event,\n\t\t\tnamespaces = hasOwn.call( event, \"namespace\" ) ? event.namespace.split(\".\") : [];\n\n\t\tcur = tmp = elem = elem || document;\n\n\t\t// Don't do events on text and comment nodes\n\t\tif ( elem.nodeType === 3 || elem.nodeType === 8 ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// focus/blur morphs to focusin/out; ensure we're not firing them right now\n\t\tif ( rfocusMorph.test( type + jQuery.event.triggered ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( type.indexOf(\".\") >= 0 ) {\n\t\t\t// Namespaced trigger; create a regexp to match event type in handle()\n\t\t\tnamespaces = type.split(\".\");\n\t\t\ttype = namespaces.shift();\n\t\t\tnamespaces.sort();\n\t\t}\n\t\tontype = type.indexOf(\":\") < 0 && \"on\" + type;\n\n\t\t// Caller can pass in a jQuery.Event object, Object, or just an event type string\n\t\tevent = event[ jQuery.expando ] ?\n\t\t\tevent :\n\t\t\tnew jQuery.Event( type, typeof event === \"object\" && event );\n\n\t\t// Trigger bitmask: & 1 for native handlers; & 2 for jQuery (always true)\n\t\tevent.isTrigger = onlyHandlers ? 2 : 3;\n\t\tevent.namespace = namespaces.join(\".\");\n\t\tevent.namespace_re = event.namespace ?\n\t\t\tnew RegExp( \"(^|\\\\.)\" + namespaces.join(\"\\\\.(?:.*\\\\.|)\") + \"(\\\\.|$)\" ) :\n\t\t\tnull;\n\n\t\t// Clean up the event in case it is being reused\n\t\tevent.result = undefined;\n\t\tif ( !event.target ) {\n\t\t\tevent.target = elem;\n\t\t}\n\n\t\t// Clone any incoming data and prepend the event, creating the handler arg list\n\t\tdata = data == null ?\n\t\t\t[ event ] :\n\t\t\tjQuery.makeArray( data, [ event ] );\n\n\t\t// Allow special events to draw outside the lines\n\t\tspecial = jQuery.event.special[ type ] || {};\n\t\tif ( !onlyHandlers && special.trigger && special.trigger.apply( elem, data ) === false ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine event propagation path in advance, per W3C events spec (#9951)\n\t\t// Bubble up to document, then to window; watch for a global ownerDocument var (#9724)\n\t\tif ( !onlyHandlers && !special.noBubble && !jQuery.isWindow( elem ) ) {\n\n\t\t\tbubbleType = special.delegateType || type;\n\t\t\tif ( !rfocusMorph.test( bubbleType + type ) ) {\n\t\t\t\tcur = cur.parentNode;\n\t\t\t}\n\t\t\tfor ( ; cur; cur = cur.parentNode ) {\n\t\t\t\teventPath.push( cur );\n\t\t\t\ttmp = cur;\n\t\t\t}\n\n\t\t\t// Only add window if we got to document (e.g., not plain obj or detached DOM)\n\t\t\tif ( tmp === (elem.ownerDocument || document) ) {\n\t\t\t\teventPath.push( tmp.defaultView || tmp.parentWindow || window );\n\t\t\t}\n\t\t}\n\n\t\t// Fire handlers on the event path\n\t\ti = 0;\n\t\twhile ( (cur = eventPath[i++]) && !event.isPropagationStopped() ) {\n\n\t\t\tevent.type = i > 1 ?\n\t\t\t\tbubbleType :\n\t\t\t\tspecial.bindType || type;\n\n\t\t\t// jQuery handler\n\t\t\thandle = ( data_priv.get( cur, \"events\" ) || {} )[ event.type ] && data_priv.get( cur, \"handle\" );\n\t\t\tif ( handle ) {\n\t\t\t\thandle.apply( cur, data );\n\t\t\t}\n\n\t\t\t// Native handler\n\t\t\thandle = ontype && cur[ ontype ];\n\t\t\tif ( handle && handle.apply && jQuery.acceptData( cur ) ) {\n\t\t\t\tevent.result = handle.apply( cur, data );\n\t\t\t\tif ( event.result === false ) {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tevent.type = type;\n\n\t\t// If nobody prevented the default action, do it now\n\t\tif ( !onlyHandlers && !event.isDefaultPrevented() ) {\n\n\t\t\tif ( (!special._default || special._default.apply( eventPath.pop(), data ) === false) &&\n\t\t\t\tjQuery.acceptData( elem ) ) {\n\n\t\t\t\t// Call a native DOM method on the target with the same name name as the event.\n\t\t\t\t// Don't do default actions on window, that's where global variables be (#6170)\n\t\t\t\tif ( ontype && jQuery.isFunction( elem[ type ] ) && !jQuery.isWindow( elem ) ) {\n\n\t\t\t\t\t// Don't re-trigger an onFOO event when we call its FOO() method\n\t\t\t\t\ttmp = elem[ ontype ];\n\n\t\t\t\t\tif ( tmp ) {\n\t\t\t\t\t\telem[ ontype ] = null;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Prevent re-triggering of the same event, since we already bubbled it above\n\t\t\t\t\tjQuery.event.triggered = type;\n\t\t\t\t\telem[ type ]();\n\t\t\t\t\tjQuery.event.triggered = undefined;\n\n\t\t\t\t\tif ( tmp ) {\n\t\t\t\t\t\telem[ ontype ] = tmp;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn event.result;\n\t},\n\n\tdispatch: function( event ) {\n\n\t\t// Make a writable jQuery.Event from the native event object\n\t\tevent = jQuery.event.fix( event );\n\n\t\tvar i, j, ret, matched, handleObj,\n\t\t\thandlerQueue = [],\n\t\t\targs = slice.call( arguments ),\n\t\t\thandlers = ( data_priv.get( this, \"events\" ) || {} )[ event.type ] || [],\n\t\t\tspecial = jQuery.event.special[ event.type ] || {};\n\n\t\t// Use the fix-ed jQuery.Event rather than the (read-only) native event\n\t\targs[0] = event;\n\t\tevent.delegateTarget = this;\n\n\t\t// Call the preDispatch hook for the mapped type, and let it bail if desired\n\t\tif ( special.preDispatch && special.preDispatch.call( this, event ) === false ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Determine handlers\n\t\thandlerQueue = jQuery.event.handlers.call( this, event, handlers );\n\n\t\t// Run delegates first; they may want to stop propagation beneath us\n\t\ti = 0;\n\t\twhile ( (matched = handlerQueue[ i++ ]) && !event.isPropagationStopped() ) {\n\t\t\tevent.currentTarget = matched.elem;\n\n\t\t\tj = 0;\n\t\t\twhile ( (handleObj = matched.handlers[ j++ ]) && !event.isImmediatePropagationStopped() ) {\n\n\t\t\t\t// Triggered event must either 1) have no namespace, or\n\t\t\t\t// 2) have namespace(s) a subset or equal to those in the bound event (both can have no namespace).\n\t\t\t\tif ( !event.namespace_re || event.namespace_re.test( handleObj.namespace ) ) {\n\n\t\t\t\t\tevent.handleObj = handleObj;\n\t\t\t\t\tevent.data = handleObj.data;\n\n\t\t\t\t\tret = ( (jQuery.event.special[ handleObj.origType ] || {}).handle || handleObj.handler )\n\t\t\t\t\t\t\t.apply( matched.elem, args );\n\n\t\t\t\t\tif ( ret !== undefined ) {\n\t\t\t\t\t\tif ( (event.result = ret) === false ) {\n\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\tevent.stopPropagation();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Call the postDispatch hook for the mapped type\n\t\tif ( special.postDispatch ) {\n\t\t\tspecial.postDispatch.call( this, event );\n\t\t}\n\n\t\treturn event.result;\n\t},\n\n\thandlers: function( event, handlers ) {\n\t\tvar i, matches, sel, handleObj,\n\t\t\thandlerQueue = [],\n\t\t\tdelegateCount = handlers.delegateCount,\n\t\t\tcur = event.target;\n\n\t\t// Find delegate handlers\n\t\t// Black-hole SVG <use> instance trees (#13180)\n\t\t// Avoid non-left-click bubbling in Firefox (#3861)\n\t\tif ( delegateCount && cur.nodeType && (!event.button || event.type !== \"click\") ) {\n\n\t\t\tfor ( ; cur !== this; cur = cur.parentNode || this ) {\n\n\t\t\t\t// Don't process clicks on disabled elements (#6911, #8165, #11382, #11764)\n\t\t\t\tif ( cur.disabled !== true || event.type !== \"click\" ) {\n\t\t\t\t\tmatches = [];\n\t\t\t\t\tfor ( i = 0; i < delegateCount; i++ ) {\n\t\t\t\t\t\thandleObj = handlers[ i ];\n\n\t\t\t\t\t\t// Don't conflict with Object.prototype properties (#13203)\n\t\t\t\t\t\tsel = handleObj.selector + \" \";\n\n\t\t\t\t\t\tif ( matches[ sel ] === undefined ) {\n\t\t\t\t\t\t\tmatches[ sel ] = handleObj.needsContext ?\n\t\t\t\t\t\t\t\tjQuery( sel, this ).index( cur ) >= 0 :\n\t\t\t\t\t\t\t\tjQuery.find( sel, this, null, [ cur ] ).length;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( matches[ sel ] ) {\n\t\t\t\t\t\t\tmatches.push( handleObj );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( matches.length ) {\n\t\t\t\t\t\thandlerQueue.push({ elem: cur, handlers: matches });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Add the remaining (directly-bound) handlers\n\t\tif ( delegateCount < handlers.length ) {\n\t\t\thandlerQueue.push({ elem: this, handlers: handlers.slice( delegateCount ) });\n\t\t}\n\n\t\treturn handlerQueue;\n\t},\n\n\t// Includes some event props shared by KeyEvent and MouseEvent\n\tprops: \"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which\".split(\" \"),\n\n\tfixHooks: {},\n\n\tkeyHooks: {\n\t\tprops: \"char charCode key keyCode\".split(\" \"),\n\t\tfilter: function( event, original ) {\n\n\t\t\t// Add which for key events\n\t\t\tif ( event.which == null ) {\n\t\t\t\tevent.which = original.charCode != null ? original.charCode : original.keyCode;\n\t\t\t}\n\n\t\t\treturn event;\n\t\t}\n\t},\n\n\tmouseHooks: {\n\t\tprops: \"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement\".split(\" \"),\n\t\tfilter: function( event, original ) {\n\t\t\tvar eventDoc, doc, body,\n\t\t\t\tbutton = original.button;\n\n\t\t\t// Calculate pageX/Y if missing and clientX/Y available\n\t\t\tif ( event.pageX == null && original.clientX != null ) {\n\t\t\t\teventDoc = event.target.ownerDocument || document;\n\t\t\t\tdoc = eventDoc.documentElement;\n\t\t\t\tbody = eventDoc.body;\n\n\t\t\t\tevent.pageX = original.clientX + ( doc && doc.scrollLeft || body && body.scrollLeft || 0 ) - ( doc && doc.clientLeft || body && body.clientLeft || 0 );\n\t\t\t\tevent.pageY = original.clientY + ( doc && doc.scrollTop  || body && body.scrollTop  || 0 ) - ( doc && doc.clientTop  || body && body.clientTop  || 0 );\n\t\t\t}\n\n\t\t\t// Add which for click: 1 === left; 2 === middle; 3 === right\n\t\t\t// Note: button is not normalized, so don't use it\n\t\t\tif ( !event.which && button !== undefined ) {\n\t\t\t\tevent.which = ( button & 1 ? 1 : ( button & 2 ? 3 : ( button & 4 ? 2 : 0 ) ) );\n\t\t\t}\n\n\t\t\treturn event;\n\t\t}\n\t},\n\n\tfix: function( event ) {\n\t\tif ( event[ jQuery.expando ] ) {\n\t\t\treturn event;\n\t\t}\n\n\t\t// Create a writable copy of the event object and normalize some properties\n\t\tvar i, prop, copy,\n\t\t\ttype = event.type,\n\t\t\toriginalEvent = event,\n\t\t\tfixHook = this.fixHooks[ type ];\n\n\t\tif ( !fixHook ) {\n\t\t\tthis.fixHooks[ type ] = fixHook =\n\t\t\t\trmouseEvent.test( type ) ? this.mouseHooks :\n\t\t\t\trkeyEvent.test( type ) ? this.keyHooks :\n\t\t\t\t{};\n\t\t}\n\t\tcopy = fixHook.props ? this.props.concat( fixHook.props ) : this.props;\n\n\t\tevent = new jQuery.Event( originalEvent );\n\n\t\ti = copy.length;\n\t\twhile ( i-- ) {\n\t\t\tprop = copy[ i ];\n\t\t\tevent[ prop ] = originalEvent[ prop ];\n\t\t}\n\n\t\t// Support: Cordova 2.5 (WebKit) (#13255)\n\t\t// All events should have a target; Cordova deviceready doesn't\n\t\tif ( !event.target ) {\n\t\t\tevent.target = document;\n\t\t}\n\n\t\t// Support: Safari 6.0+, Chrome < 28\n\t\t// Target should not be a text node (#504, #13143)\n\t\tif ( event.target.nodeType === 3 ) {\n\t\t\tevent.target = event.target.parentNode;\n\t\t}\n\n\t\treturn fixHook.filter ? fixHook.filter( event, originalEvent ) : event;\n\t},\n\n\tspecial: {\n\t\tload: {\n\t\t\t// Prevent triggered image.load events from bubbling to window.load\n\t\t\tnoBubble: true\n\t\t},\n\t\tfocus: {\n\t\t\t// Fire native event if possible so blur/focus sequence is correct\n\t\t\ttrigger: function() {\n\t\t\t\tif ( this !== safeActiveElement() && this.focus ) {\n\t\t\t\t\tthis.focus();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t},\n\t\t\tdelegateType: \"focusin\"\n\t\t},\n\t\tblur: {\n\t\t\ttrigger: function() {\n\t\t\t\tif ( this === safeActiveElement() && this.blur ) {\n\t\t\t\t\tthis.blur();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t},\n\t\t\tdelegateType: \"focusout\"\n\t\t},\n\t\tclick: {\n\t\t\t// For checkbox, fire native event so checked state will be right\n\t\t\ttrigger: function() {\n\t\t\t\tif ( this.type === \"checkbox\" && this.click && jQuery.nodeName( this, \"input\" ) ) {\n\t\t\t\t\tthis.click();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t// For cross-browser consistency, don't fire native .click() on links\n\t\t\t_default: function( event ) {\n\t\t\t\treturn jQuery.nodeName( event.target, \"a\" );\n\t\t\t}\n\t\t},\n\n\t\tbeforeunload: {\n\t\t\tpostDispatch: function( event ) {\n\n\t\t\t\t// Support: Firefox 20+\n\t\t\t\t// Firefox doesn't alert if the returnValue field is not set.\n\t\t\t\tif ( event.result !== undefined && event.originalEvent ) {\n\t\t\t\t\tevent.originalEvent.returnValue = event.result;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tsimulate: function( type, elem, event, bubble ) {\n\t\t// Piggyback on a donor event to simulate a different one.\n\t\t// Fake originalEvent to avoid donor's stopPropagation, but if the\n\t\t// simulated event prevents default then we do the same on the donor.\n\t\tvar e = jQuery.extend(\n\t\t\tnew jQuery.Event(),\n\t\t\tevent,\n\t\t\t{\n\t\t\t\ttype: type,\n\t\t\t\tisSimulated: true,\n\t\t\t\toriginalEvent: {}\n\t\t\t}\n\t\t);\n\t\tif ( bubble ) {\n\t\t\tjQuery.event.trigger( e, null, elem );\n\t\t} else {\n\t\t\tjQuery.event.dispatch.call( elem, e );\n\t\t}\n\t\tif ( e.isDefaultPrevented() ) {\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n};\n\njQuery.removeEvent = function( elem, type, handle ) {\n\tif ( elem.removeEventListener ) {\n\t\telem.removeEventListener( type, handle, false );\n\t}\n};\n\njQuery.Event = function( src, props ) {\n\t// Allow instantiation without the 'new' keyword\n\tif ( !(this instanceof jQuery.Event) ) {\n\t\treturn new jQuery.Event( src, props );\n\t}\n\n\t// Event object\n\tif ( src && src.type ) {\n\t\tthis.originalEvent = src;\n\t\tthis.type = src.type;\n\n\t\t// Events bubbling up the document may have been marked as prevented\n\t\t// by a handler lower down the tree; reflect the correct value.\n\t\tthis.isDefaultPrevented = src.defaultPrevented ||\n\t\t\t\tsrc.defaultPrevented === undefined &&\n\t\t\t\t// Support: Android < 4.0\n\t\t\t\tsrc.returnValue === false ?\n\t\t\treturnTrue :\n\t\t\treturnFalse;\n\n\t// Event type\n\t} else {\n\t\tthis.type = src;\n\t}\n\n\t// Put explicitly provided properties onto the event object\n\tif ( props ) {\n\t\tjQuery.extend( this, props );\n\t}\n\n\t// Create a timestamp if incoming event doesn't have one\n\tthis.timeStamp = src && src.timeStamp || jQuery.now();\n\n\t// Mark it as fixed\n\tthis[ jQuery.expando ] = true;\n};\n\n// jQuery.Event is based on DOM3 Events as specified by the ECMAScript Language Binding\n// http://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html\njQuery.Event.prototype = {\n\tisDefaultPrevented: returnFalse,\n\tisPropagationStopped: returnFalse,\n\tisImmediatePropagationStopped: returnFalse,\n\n\tpreventDefault: function() {\n\t\tvar e = this.originalEvent;\n\n\t\tthis.isDefaultPrevented = returnTrue;\n\n\t\tif ( e && e.preventDefault ) {\n\t\t\te.preventDefault();\n\t\t}\n\t},\n\tstopPropagation: function() {\n\t\tvar e = this.originalEvent;\n\n\t\tthis.isPropagationStopped = returnTrue;\n\n\t\tif ( e && e.stopPropagation ) {\n\t\t\te.stopPropagation();\n\t\t}\n\t},\n\tstopImmediatePropagation: function() {\n\t\tvar e = this.originalEvent;\n\n\t\tthis.isImmediatePropagationStopped = returnTrue;\n\n\t\tif ( e && e.stopImmediatePropagation ) {\n\t\t\te.stopImmediatePropagation();\n\t\t}\n\n\t\tthis.stopPropagation();\n\t}\n};\n\n// Create mouseenter/leave events using mouseover/out and event-time checks\n// Support: Chrome 15+\njQuery.each({\n\tmouseenter: \"mouseover\",\n\tmouseleave: \"mouseout\",\n\tpointerenter: \"pointerover\",\n\tpointerleave: \"pointerout\"\n}, function( orig, fix ) {\n\tjQuery.event.special[ orig ] = {\n\t\tdelegateType: fix,\n\t\tbindType: fix,\n\n\t\thandle: function( event ) {\n\t\t\tvar ret,\n\t\t\t\ttarget = this,\n\t\t\t\trelated = event.relatedTarget,\n\t\t\t\thandleObj = event.handleObj;\n\n\t\t\t// For mousenter/leave call the handler if related is outside the target.\n\t\t\t// NB: No relatedTarget if the mouse left/entered the browser window\n\t\t\tif ( !related || (related !== target && !jQuery.contains( target, related )) ) {\n\t\t\t\tevent.type = handleObj.origType;\n\t\t\t\tret = handleObj.handler.apply( this, arguments );\n\t\t\t\tevent.type = fix;\n\t\t\t}\n\t\t\treturn ret;\n\t\t}\n\t};\n});\n\n// Create \"bubbling\" focus and blur events\n// Support: Firefox, Chrome, Safari\nif ( !support.focusinBubbles ) {\n\tjQuery.each({ focus: \"focusin\", blur: \"focusout\" }, function( orig, fix ) {\n\n\t\t// Attach a single capturing handler on the document while someone wants focusin/focusout\n\t\tvar handler = function( event ) {\n\t\t\t\tjQuery.event.simulate( fix, event.target, jQuery.event.fix( event ), true );\n\t\t\t};\n\n\t\tjQuery.event.special[ fix ] = {\n\t\t\tsetup: function() {\n\t\t\t\tvar doc = this.ownerDocument || this,\n\t\t\t\t\tattaches = data_priv.access( doc, fix );\n\n\t\t\t\tif ( !attaches ) {\n\t\t\t\t\tdoc.addEventListener( orig, handler, true );\n\t\t\t\t}\n\t\t\t\tdata_priv.access( doc, fix, ( attaches || 0 ) + 1 );\n\t\t\t},\n\t\t\tteardown: function() {\n\t\t\t\tvar doc = this.ownerDocument || this,\n\t\t\t\t\tattaches = data_priv.access( doc, fix ) - 1;\n\n\t\t\t\tif ( !attaches ) {\n\t\t\t\t\tdoc.removeEventListener( orig, handler, true );\n\t\t\t\t\tdata_priv.remove( doc, fix );\n\n\t\t\t\t} else {\n\t\t\t\t\tdata_priv.access( doc, fix, attaches );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t});\n}\n\njQuery.fn.extend({\n\n\ton: function( types, selector, data, fn, /*INTERNAL*/ one ) {\n\t\tvar origFn, type;\n\n\t\t// Types can be a map of types/handlers\n\t\tif ( typeof types === \"object\" ) {\n\t\t\t// ( types-Object, selector, data )\n\t\t\tif ( typeof selector !== \"string\" ) {\n\t\t\t\t// ( types-Object, data )\n\t\t\t\tdata = data || selector;\n\t\t\t\tselector = undefined;\n\t\t\t}\n\t\t\tfor ( type in types ) {\n\t\t\t\tthis.on( type, selector, data, types[ type ], one );\n\t\t\t}\n\t\t\treturn this;\n\t\t}\n\n\t\tif ( data == null && fn == null ) {\n\t\t\t// ( types, fn )\n\t\t\tfn = selector;\n\t\t\tdata = selector = undefined;\n\t\t} else if ( fn == null ) {\n\t\t\tif ( typeof selector === \"string\" ) {\n\t\t\t\t// ( types, selector, fn )\n\t\t\t\tfn = data;\n\t\t\t\tdata = undefined;\n\t\t\t} else {\n\t\t\t\t// ( types, data, fn )\n\t\t\t\tfn = data;\n\t\t\t\tdata = selector;\n\t\t\t\tselector = undefined;\n\t\t\t}\n\t\t}\n\t\tif ( fn === false ) {\n\t\t\tfn = returnFalse;\n\t\t} else if ( !fn ) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif ( one === 1 ) {\n\t\t\torigFn = fn;\n\t\t\tfn = function( event ) {\n\t\t\t\t// Can use an empty set, since event contains the info\n\t\t\t\tjQuery().off( event );\n\t\t\t\treturn origFn.apply( this, arguments );\n\t\t\t};\n\t\t\t// Use same guid so caller can remove using origFn\n\t\t\tfn.guid = origFn.guid || ( origFn.guid = jQuery.guid++ );\n\t\t}\n\t\treturn this.each( function() {\n\t\t\tjQuery.event.add( this, types, fn, data, selector );\n\t\t});\n\t},\n\tone: function( types, selector, data, fn ) {\n\t\treturn this.on( types, selector, data, fn, 1 );\n\t},\n\toff: function( types, selector, fn ) {\n\t\tvar handleObj, type;\n\t\tif ( types && types.preventDefault && types.handleObj ) {\n\t\t\t// ( event )  dispatched jQuery.Event\n\t\t\thandleObj = types.handleObj;\n\t\t\tjQuery( types.delegateTarget ).off(\n\t\t\t\thandleObj.namespace ? handleObj.origType + \".\" + handleObj.namespace : handleObj.origType,\n\t\t\t\thandleObj.selector,\n\t\t\t\thandleObj.handler\n\t\t\t);\n\t\t\treturn this;\n\t\t}\n\t\tif ( typeof types === \"object\" ) {\n\t\t\t// ( types-object [, selector] )\n\t\t\tfor ( type in types ) {\n\t\t\t\tthis.off( type, selector, types[ type ] );\n\t\t\t}\n\t\t\treturn this;\n\t\t}\n\t\tif ( selector === false || typeof selector === \"function\" ) {\n\t\t\t// ( types [, fn] )\n\t\t\tfn = selector;\n\t\t\tselector = undefined;\n\t\t}\n\t\tif ( fn === false ) {\n\t\t\tfn = returnFalse;\n\t\t}\n\t\treturn this.each(function() {\n\t\t\tjQuery.event.remove( this, types, fn, selector );\n\t\t});\n\t},\n\n\ttrigger: function( type, data ) {\n\t\treturn this.each(function() {\n\t\t\tjQuery.event.trigger( type, data, this );\n\t\t});\n\t},\n\ttriggerHandler: function( type, data ) {\n\t\tvar elem = this[0];\n\t\tif ( elem ) {\n\t\t\treturn jQuery.event.trigger( type, data, elem, true );\n\t\t}\n\t}\n});\n\n\nvar\n\trxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\\w:]+)[^>]*)\\/>/gi,\n\trtagName = /<([\\w:]+)/,\n\trhtml = /<|&#?\\w+;/,\n\trnoInnerhtml = /<(?:script|style|link)/i,\n\t// checked=\"checked\" or checked\n\trchecked = /checked\\s*(?:[^=]|=\\s*.checked.)/i,\n\trscriptType = /^$|\\/(?:java|ecma)script/i,\n\trscriptTypeMasked = /^true\\/(.*)/,\n\trcleanScript = /^\\s*<!(?:\\[CDATA\\[|--)|(?:\\]\\]|--)>\\s*$/g,\n\n\t// We have to close these tags to support XHTML (#13200)\n\twrapMap = {\n\n\t\t// Support: IE 9\n\t\toption: [ 1, \"<select multiple='multiple'>\", \"</select>\" ],\n\n\t\tthead: [ 1, \"<table>\", \"</table>\" ],\n\t\tcol: [ 2, \"<table><colgroup>\", \"</colgroup></table>\" ],\n\t\ttr: [ 2, \"<table><tbody>\", \"</tbody></table>\" ],\n\t\ttd: [ 3, \"<table><tbody><tr>\", \"</tr></tbody></table>\" ],\n\n\t\t_default: [ 0, \"\", \"\" ]\n\t};\n\n// Support: IE 9\nwrapMap.optgroup = wrapMap.option;\n\nwrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;\nwrapMap.th = wrapMap.td;\n\n// Support: 1.x compatibility\n// Manipulating tables requires a tbody\nfunction manipulationTarget( elem, content ) {\n\treturn jQuery.nodeName( elem, \"table\" ) &&\n\t\tjQuery.nodeName( content.nodeType !== 11 ? content : content.firstChild, \"tr\" ) ?\n\n\t\telem.getElementsByTagName(\"tbody\")[0] ||\n\t\t\telem.appendChild( elem.ownerDocument.createElement(\"tbody\") ) :\n\t\telem;\n}\n\n// Replace/restore the type attribute of script elements for safe DOM manipulation\nfunction disableScript( elem ) {\n\telem.type = (elem.getAttribute(\"type\") !== null) + \"/\" + elem.type;\n\treturn elem;\n}\nfunction restoreScript( elem ) {\n\tvar match = rscriptTypeMasked.exec( elem.type );\n\n\tif ( match ) {\n\t\telem.type = match[ 1 ];\n\t} else {\n\t\telem.removeAttribute(\"type\");\n\t}\n\n\treturn elem;\n}\n\n// Mark scripts as having already been evaluated\nfunction setGlobalEval( elems, refElements ) {\n\tvar i = 0,\n\t\tl = elems.length;\n\n\tfor ( ; i < l; i++ ) {\n\t\tdata_priv.set(\n\t\t\telems[ i ], \"globalEval\", !refElements || data_priv.get( refElements[ i ], \"globalEval\" )\n\t\t);\n\t}\n}\n\nfunction cloneCopyEvent( src, dest ) {\n\tvar i, l, type, pdataOld, pdataCur, udataOld, udataCur, events;\n\n\tif ( dest.nodeType !== 1 ) {\n\t\treturn;\n\t}\n\n\t// 1. Copy private data: events, handlers, etc.\n\tif ( data_priv.hasData( src ) ) {\n\t\tpdataOld = data_priv.access( src );\n\t\tpdataCur = data_priv.set( dest, pdataOld );\n\t\tevents = pdataOld.events;\n\n\t\tif ( events ) {\n\t\t\tdelete pdataCur.handle;\n\t\t\tpdataCur.events = {};\n\n\t\t\tfor ( type in events ) {\n\t\t\t\tfor ( i = 0, l = events[ type ].length; i < l; i++ ) {\n\t\t\t\t\tjQuery.event.add( dest, type, events[ type ][ i ] );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// 2. Copy user data\n\tif ( data_user.hasData( src ) ) {\n\t\tudataOld = data_user.access( src );\n\t\tudataCur = jQuery.extend( {}, udataOld );\n\n\t\tdata_user.set( dest, udataCur );\n\t}\n}\n\nfunction getAll( context, tag ) {\n\tvar ret = context.getElementsByTagName ? context.getElementsByTagName( tag || \"*\" ) :\n\t\t\tcontext.querySelectorAll ? context.querySelectorAll( tag || \"*\" ) :\n\t\t\t[];\n\n\treturn tag === undefined || tag && jQuery.nodeName( context, tag ) ?\n\t\tjQuery.merge( [ context ], ret ) :\n\t\tret;\n}\n\n// Support: IE >= 9\nfunction fixInput( src, dest ) {\n\tvar nodeName = dest.nodeName.toLowerCase();\n\n\t// Fails to persist the checked state of a cloned checkbox or radio button.\n\tif ( nodeName === \"input\" && rcheckableType.test( src.type ) ) {\n\t\tdest.checked = src.checked;\n\n\t// Fails to return the selected option to the default selected state when cloning options\n\t} else if ( nodeName === \"input\" || nodeName === \"textarea\" ) {\n\t\tdest.defaultValue = src.defaultValue;\n\t}\n}\n\njQuery.extend({\n\tclone: function( elem, dataAndEvents, deepDataAndEvents ) {\n\t\tvar i, l, srcElements, destElements,\n\t\t\tclone = elem.cloneNode( true ),\n\t\t\tinPage = jQuery.contains( elem.ownerDocument, elem );\n\n\t\t// Support: IE >= 9\n\t\t// Fix Cloning issues\n\t\tif ( !support.noCloneChecked && ( elem.nodeType === 1 || elem.nodeType === 11 ) &&\n\t\t\t\t!jQuery.isXMLDoc( elem ) ) {\n\n\t\t\t// We eschew Sizzle here for performance reasons: http://jsperf.com/getall-vs-sizzle/2\n\t\t\tdestElements = getAll( clone );\n\t\t\tsrcElements = getAll( elem );\n\n\t\t\tfor ( i = 0, l = srcElements.length; i < l; i++ ) {\n\t\t\t\tfixInput( srcElements[ i ], destElements[ i ] );\n\t\t\t}\n\t\t}\n\n\t\t// Copy the events from the original to the clone\n\t\tif ( dataAndEvents ) {\n\t\t\tif ( deepDataAndEvents ) {\n\t\t\t\tsrcElements = srcElements || getAll( elem );\n\t\t\t\tdestElements = destElements || getAll( clone );\n\n\t\t\t\tfor ( i = 0, l = srcElements.length; i < l; i++ ) {\n\t\t\t\t\tcloneCopyEvent( srcElements[ i ], destElements[ i ] );\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcloneCopyEvent( elem, clone );\n\t\t\t}\n\t\t}\n\n\t\t// Preserve script evaluation history\n\t\tdestElements = getAll( clone, \"script\" );\n\t\tif ( destElements.length > 0 ) {\n\t\t\tsetGlobalEval( destElements, !inPage && getAll( elem, \"script\" ) );\n\t\t}\n\n\t\t// Return the cloned set\n\t\treturn clone;\n\t},\n\n\tbuildFragment: function( elems, context, scripts, selection ) {\n\t\tvar elem, tmp, tag, wrap, contains, j,\n\t\t\tfragment = context.createDocumentFragment(),\n\t\t\tnodes = [],\n\t\t\ti = 0,\n\t\t\tl = elems.length;\n\n\t\tfor ( ; i < l; i++ ) {\n\t\t\telem = elems[ i ];\n\n\t\t\tif ( elem || elem === 0 ) {\n\n\t\t\t\t// Add nodes directly\n\t\t\t\tif ( jQuery.type( elem ) === \"object\" ) {\n\t\t\t\t\t// Support: QtWebKit\n\t\t\t\t\t// jQuery.merge because push.apply(_, arraylike) throws\n\t\t\t\t\tjQuery.merge( nodes, elem.nodeType ? [ elem ] : elem );\n\n\t\t\t\t// Convert non-html into a text node\n\t\t\t\t} else if ( !rhtml.test( elem ) ) {\n\t\t\t\t\tnodes.push( context.createTextNode( elem ) );\n\n\t\t\t\t// Convert html into DOM nodes\n\t\t\t\t} else {\n\t\t\t\t\ttmp = tmp || fragment.appendChild( context.createElement(\"div\") );\n\n\t\t\t\t\t// Deserialize a standard representation\n\t\t\t\t\ttag = ( rtagName.exec( elem ) || [ \"\", \"\" ] )[ 1 ].toLowerCase();\n\t\t\t\t\twrap = wrapMap[ tag ] || wrapMap._default;\n\t\t\t\t\ttmp.innerHTML = wrap[ 1 ] + elem.replace( rxhtmlTag, \"<$1></$2>\" ) + wrap[ 2 ];\n\n\t\t\t\t\t// Descend through wrappers to the right content\n\t\t\t\t\tj = wrap[ 0 ];\n\t\t\t\t\twhile ( j-- ) {\n\t\t\t\t\t\ttmp = tmp.lastChild;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Support: QtWebKit\n\t\t\t\t\t// jQuery.merge because push.apply(_, arraylike) throws\n\t\t\t\t\tjQuery.merge( nodes, tmp.childNodes );\n\n\t\t\t\t\t// Remember the top-level container\n\t\t\t\t\ttmp = fragment.firstChild;\n\n\t\t\t\t\t// Fixes #12346\n\t\t\t\t\t// Support: Webkit, IE\n\t\t\t\t\ttmp.textContent = \"\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Remove wrapper from fragment\n\t\tfragment.textContent = \"\";\n\n\t\ti = 0;\n\t\twhile ( (elem = nodes[ i++ ]) ) {\n\n\t\t\t// #4087 - If origin and destination elements are the same, and this is\n\t\t\t// that element, do not do anything\n\t\t\tif ( selection && jQuery.inArray( elem, selection ) !== -1 ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcontains = jQuery.contains( elem.ownerDocument, elem );\n\n\t\t\t// Append to fragment\n\t\t\ttmp = getAll( fragment.appendChild( elem ), \"script\" );\n\n\t\t\t// Preserve script evaluation history\n\t\t\tif ( contains ) {\n\t\t\t\tsetGlobalEval( tmp );\n\t\t\t}\n\n\t\t\t// Capture executables\n\t\t\tif ( scripts ) {\n\t\t\t\tj = 0;\n\t\t\t\twhile ( (elem = tmp[ j++ ]) ) {\n\t\t\t\t\tif ( rscriptType.test( elem.type || \"\" ) ) {\n\t\t\t\t\t\tscripts.push( elem );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn fragment;\n\t},\n\n\tcleanData: function( elems ) {\n\t\tvar data, elem, type, key,\n\t\t\tspecial = jQuery.event.special,\n\t\t\ti = 0;\n\n\t\tfor ( ; (elem = elems[ i ]) !== undefined; i++ ) {\n\t\t\tif ( jQuery.acceptData( elem ) ) {\n\t\t\t\tkey = elem[ data_priv.expando ];\n\n\t\t\t\tif ( key && (data = data_priv.cache[ key ]) ) {\n\t\t\t\t\tif ( data.events ) {\n\t\t\t\t\t\tfor ( type in data.events ) {\n\t\t\t\t\t\t\tif ( special[ type ] ) {\n\t\t\t\t\t\t\t\tjQuery.event.remove( elem, type );\n\n\t\t\t\t\t\t\t// This is a shortcut to avoid jQuery.event.remove's overhead\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tjQuery.removeEvent( elem, type, data.handle );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( data_priv.cache[ key ] ) {\n\t\t\t\t\t\t// Discard any remaining `private` data\n\t\t\t\t\t\tdelete data_priv.cache[ key ];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Discard any remaining `user` data\n\t\t\tdelete data_user.cache[ elem[ data_user.expando ] ];\n\t\t}\n\t}\n});\n\njQuery.fn.extend({\n\ttext: function( value ) {\n\t\treturn access( this, function( value ) {\n\t\t\treturn value === undefined ?\n\t\t\t\tjQuery.text( this ) :\n\t\t\t\tthis.empty().each(function() {\n\t\t\t\t\tif ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {\n\t\t\t\t\t\tthis.textContent = value;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t}, null, value, arguments.length );\n\t},\n\n\tappend: function() {\n\t\treturn this.domManip( arguments, function( elem ) {\n\t\t\tif ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {\n\t\t\t\tvar target = manipulationTarget( this, elem );\n\t\t\t\ttarget.appendChild( elem );\n\t\t\t}\n\t\t});\n\t},\n\n\tprepend: function() {\n\t\treturn this.domManip( arguments, function( elem ) {\n\t\t\tif ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {\n\t\t\t\tvar target = manipulationTarget( this, elem );\n\t\t\t\ttarget.insertBefore( elem, target.firstChild );\n\t\t\t}\n\t\t});\n\t},\n\n\tbefore: function() {\n\t\treturn this.domManip( arguments, function( elem ) {\n\t\t\tif ( this.parentNode ) {\n\t\t\t\tthis.parentNode.insertBefore( elem, this );\n\t\t\t}\n\t\t});\n\t},\n\n\tafter: function() {\n\t\treturn this.domManip( arguments, function( elem ) {\n\t\t\tif ( this.parentNode ) {\n\t\t\t\tthis.parentNode.insertBefore( elem, this.nextSibling );\n\t\t\t}\n\t\t});\n\t},\n\n\tremove: function( selector, keepData /* Internal Use Only */ ) {\n\t\tvar elem,\n\t\t\telems = selector ? jQuery.filter( selector, this ) : this,\n\t\t\ti = 0;\n\n\t\tfor ( ; (elem = elems[i]) != null; i++ ) {\n\t\t\tif ( !keepData && elem.nodeType === 1 ) {\n\t\t\t\tjQuery.cleanData( getAll( elem ) );\n\t\t\t}\n\n\t\t\tif ( elem.parentNode ) {\n\t\t\t\tif ( keepData && jQuery.contains( elem.ownerDocument, elem ) ) {\n\t\t\t\t\tsetGlobalEval( getAll( elem, \"script\" ) );\n\t\t\t\t}\n\t\t\t\telem.parentNode.removeChild( elem );\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t},\n\n\tempty: function() {\n\t\tvar elem,\n\t\t\ti = 0;\n\n\t\tfor ( ; (elem = this[i]) != null; i++ ) {\n\t\t\tif ( elem.nodeType === 1 ) {\n\n\t\t\t\t// Prevent memory leaks\n\t\t\t\tjQuery.cleanData( getAll( elem, false ) );\n\n\t\t\t\t// Remove any remaining nodes\n\t\t\t\telem.textContent = \"\";\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t},\n\n\tclone: function( dataAndEvents, deepDataAndEvents ) {\n\t\tdataAndEvents = dataAndEvents == null ? false : dataAndEvents;\n\t\tdeepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;\n\n\t\treturn this.map(function() {\n\t\t\treturn jQuery.clone( this, dataAndEvents, deepDataAndEvents );\n\t\t});\n\t},\n\n\thtml: function( value ) {\n\t\treturn access( this, function( value ) {\n\t\t\tvar elem = this[ 0 ] || {},\n\t\t\t\ti = 0,\n\t\t\t\tl = this.length;\n\n\t\t\tif ( value === undefined && elem.nodeType === 1 ) {\n\t\t\t\treturn elem.innerHTML;\n\t\t\t}\n\n\t\t\t// See if we can take a shortcut and just use innerHTML\n\t\t\tif ( typeof value === \"string\" && !rnoInnerhtml.test( value ) &&\n\t\t\t\t!wrapMap[ ( rtagName.exec( value ) || [ \"\", \"\" ] )[ 1 ].toLowerCase() ] ) {\n\n\t\t\t\tvalue = value.replace( rxhtmlTag, \"<$1></$2>\" );\n\n\t\t\t\ttry {\n\t\t\t\t\tfor ( ; i < l; i++ ) {\n\t\t\t\t\t\telem = this[ i ] || {};\n\n\t\t\t\t\t\t// Remove element nodes and prevent memory leaks\n\t\t\t\t\t\tif ( elem.nodeType === 1 ) {\n\t\t\t\t\t\t\tjQuery.cleanData( getAll( elem, false ) );\n\t\t\t\t\t\t\telem.innerHTML = value;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\telem = 0;\n\n\t\t\t\t// If using innerHTML throws an exception, use the fallback method\n\t\t\t\t} catch( e ) {}\n\t\t\t}\n\n\t\t\tif ( elem ) {\n\t\t\t\tthis.empty().append( value );\n\t\t\t}\n\t\t}, null, value, arguments.length );\n\t},\n\n\treplaceWith: function() {\n\t\tvar arg = arguments[ 0 ];\n\n\t\t// Make the changes, replacing each context element with the new content\n\t\tthis.domManip( arguments, function( elem ) {\n\t\t\targ = this.parentNode;\n\n\t\t\tjQuery.cleanData( getAll( this ) );\n\n\t\t\tif ( arg ) {\n\t\t\t\targ.replaceChild( elem, this );\n\t\t\t}\n\t\t});\n\n\t\t// Force removal if there was no new content (e.g., from empty arguments)\n\t\treturn arg && (arg.length || arg.nodeType) ? this : this.remove();\n\t},\n\n\tdetach: function( selector ) {\n\t\treturn this.remove( selector, true );\n\t},\n\n\tdomManip: function( args, callback ) {\n\n\t\t// Flatten any nested arrays\n\t\targs = concat.apply( [], args );\n\n\t\tvar fragment, first, scripts, hasScripts, node, doc,\n\t\t\ti = 0,\n\t\t\tl = this.length,\n\t\t\tset = this,\n\t\t\tiNoClone = l - 1,\n\t\t\tvalue = args[ 0 ],\n\t\t\tisFunction = jQuery.isFunction( value );\n\n\t\t// We can't cloneNode fragments that contain checked, in WebKit\n\t\tif ( isFunction ||\n\t\t\t\t( l > 1 && typeof value === \"string\" &&\n\t\t\t\t\t!support.checkClone && rchecked.test( value ) ) ) {\n\t\t\treturn this.each(function( index ) {\n\t\t\t\tvar self = set.eq( index );\n\t\t\t\tif ( isFunction ) {\n\t\t\t\t\targs[ 0 ] = value.call( this, index, self.html() );\n\t\t\t\t}\n\t\t\t\tself.domManip( args, callback );\n\t\t\t});\n\t\t}\n\n\t\tif ( l ) {\n\t\t\tfragment = jQuery.buildFragment( args, this[ 0 ].ownerDocument, false, this );\n\t\t\tfirst = fragment.firstChild;\n\n\t\t\tif ( fragment.childNodes.length === 1 ) {\n\t\t\t\tfragment = first;\n\t\t\t}\n\n\t\t\tif ( first ) {\n\t\t\t\tscripts = jQuery.map( getAll( fragment, \"script\" ), disableScript );\n\t\t\t\thasScripts = scripts.length;\n\n\t\t\t\t// Use the original fragment for the last item instead of the first because it can end up\n\t\t\t\t// being emptied incorrectly in certain situations (#8070).\n\t\t\t\tfor ( ; i < l; i++ ) {\n\t\t\t\t\tnode = fragment;\n\n\t\t\t\t\tif ( i !== iNoClone ) {\n\t\t\t\t\t\tnode = jQuery.clone( node, true, true );\n\n\t\t\t\t\t\t// Keep references to cloned scripts for later restoration\n\t\t\t\t\t\tif ( hasScripts ) {\n\t\t\t\t\t\t\t// Support: QtWebKit\n\t\t\t\t\t\t\t// jQuery.merge because push.apply(_, arraylike) throws\n\t\t\t\t\t\t\tjQuery.merge( scripts, getAll( node, \"script\" ) );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback.call( this[ i ], node, i );\n\t\t\t\t}\n\n\t\t\t\tif ( hasScripts ) {\n\t\t\t\t\tdoc = scripts[ scripts.length - 1 ].ownerDocument;\n\n\t\t\t\t\t// Reenable scripts\n\t\t\t\t\tjQuery.map( scripts, restoreScript );\n\n\t\t\t\t\t// Evaluate executable scripts on first document insertion\n\t\t\t\t\tfor ( i = 0; i < hasScripts; i++ ) {\n\t\t\t\t\t\tnode = scripts[ i ];\n\t\t\t\t\t\tif ( rscriptType.test( node.type || \"\" ) &&\n\t\t\t\t\t\t\t!data_priv.access( node, \"globalEval\" ) && jQuery.contains( doc, node ) ) {\n\n\t\t\t\t\t\t\tif ( node.src ) {\n\t\t\t\t\t\t\t\t// Optional AJAX dependency, but won't run scripts if not present\n\t\t\t\t\t\t\t\tif ( jQuery._evalUrl ) {\n\t\t\t\t\t\t\t\t\tjQuery._evalUrl( node.src );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tjQuery.globalEval( node.textContent.replace( rcleanScript, \"\" ) );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n});\n\njQuery.each({\n\tappendTo: \"append\",\n\tprependTo: \"prepend\",\n\tinsertBefore: \"before\",\n\tinsertAfter: \"after\",\n\treplaceAll: \"replaceWith\"\n}, function( name, original ) {\n\tjQuery.fn[ name ] = function( selector ) {\n\t\tvar elems,\n\t\t\tret = [],\n\t\t\tinsert = jQuery( selector ),\n\t\t\tlast = insert.length - 1,\n\t\t\ti = 0;\n\n\t\tfor ( ; i <= last; i++ ) {\n\t\t\telems = i === last ? this : this.clone( true );\n\t\t\tjQuery( insert[ i ] )[ original ]( elems );\n\n\t\t\t// Support: QtWebKit\n\t\t\t// .get() because push.apply(_, arraylike) throws\n\t\t\tpush.apply( ret, elems.get() );\n\t\t}\n\n\t\treturn this.pushStack( ret );\n\t};\n});\n\n\nvar iframe,\n\telemdisplay = {};\n\n/**\n * Retrieve the actual display of a element\n * @param {String} name nodeName of the element\n * @param {Object} doc Document object\n */\n// Called only from within defaultDisplay\nfunction actualDisplay( name, doc ) {\n\tvar style,\n\t\telem = jQuery( doc.createElement( name ) ).appendTo( doc.body ),\n\n\t\t// getDefaultComputedStyle might be reliably used only on attached element\n\t\tdisplay = window.getDefaultComputedStyle && ( style = window.getDefaultComputedStyle( elem[ 0 ] ) ) ?\n\n\t\t\t// Use of this method is a temporary fix (more like optmization) until something better comes along,\n\t\t\t// since it was removed from specification and supported only in FF\n\t\t\tstyle.display : jQuery.css( elem[ 0 ], \"display\" );\n\n\t// We don't have any data stored on the element,\n\t// so use \"detach\" method as fast way to get rid of the element\n\telem.detach();\n\n\treturn display;\n}\n\n/**\n * Try to determine the default display value of an element\n * @param {String} nodeName\n */\nfunction defaultDisplay( nodeName ) {\n\tvar doc = document,\n\t\tdisplay = elemdisplay[ nodeName ];\n\n\tif ( !display ) {\n\t\tdisplay = actualDisplay( nodeName, doc );\n\n\t\t// If the simple way fails, read from inside an iframe\n\t\tif ( display === \"none\" || !display ) {\n\n\t\t\t// Use the already-created iframe if possible\n\t\t\tiframe = (iframe || jQuery( \"<iframe frameborder='0' width='0' height='0'/>\" )).appendTo( doc.documentElement );\n\n\t\t\t// Always write a new HTML skeleton so Webkit and Firefox don't choke on reuse\n\t\t\tdoc = iframe[ 0 ].contentDocument;\n\n\t\t\t// Support: IE\n\t\t\tdoc.write();\n\t\t\tdoc.close();\n\n\t\t\tdisplay = actualDisplay( nodeName, doc );\n\t\t\tiframe.detach();\n\t\t}\n\n\t\t// Store the correct default display\n\t\telemdisplay[ nodeName ] = display;\n\t}\n\n\treturn display;\n}\nvar rmargin = (/^margin/);\n\nvar rnumnonpx = new RegExp( \"^(\" + pnum + \")(?!px)[a-z%]+$\", \"i\" );\n\nvar getStyles = function( elem ) {\n\t\treturn elem.ownerDocument.defaultView.getComputedStyle( elem, null );\n\t};\n\n\n\nfunction curCSS( elem, name, computed ) {\n\tvar width, minWidth, maxWidth, ret,\n\t\tstyle = elem.style;\n\n\tcomputed = computed || getStyles( elem );\n\n\t// Support: IE9\n\t// getPropertyValue is only needed for .css('filter') in IE9, see #12537\n\tif ( computed ) {\n\t\tret = computed.getPropertyValue( name ) || computed[ name ];\n\t}\n\n\tif ( computed ) {\n\n\t\tif ( ret === \"\" && !jQuery.contains( elem.ownerDocument, elem ) ) {\n\t\t\tret = jQuery.style( elem, name );\n\t\t}\n\n\t\t// Support: iOS < 6\n\t\t// A tribute to the \"awesome hack by Dean Edwards\"\n\t\t// iOS < 6 (at least) returns percentage for a larger set of values, but width seems to be reliably pixels\n\t\t// this is against the CSSOM draft spec: http://dev.w3.org/csswg/cssom/#resolved-values\n\t\tif ( rnumnonpx.test( ret ) && rmargin.test( name ) ) {\n\n\t\t\t// Remember the original values\n\t\t\twidth = style.width;\n\t\t\tminWidth = style.minWidth;\n\t\t\tmaxWidth = style.maxWidth;\n\n\t\t\t// Put in the new values to get a computed value out\n\t\t\tstyle.minWidth = style.maxWidth = style.width = ret;\n\t\t\tret = computed.width;\n\n\t\t\t// Revert the changed values\n\t\t\tstyle.width = width;\n\t\t\tstyle.minWidth = minWidth;\n\t\t\tstyle.maxWidth = maxWidth;\n\t\t}\n\t}\n\n\treturn ret !== undefined ?\n\t\t// Support: IE\n\t\t// IE returns zIndex value as an integer.\n\t\tret + \"\" :\n\t\tret;\n}\n\n\nfunction addGetHookIf( conditionFn, hookFn ) {\n\t// Define the hook, we'll check on the first run if it's really needed.\n\treturn {\n\t\tget: function() {\n\t\t\tif ( conditionFn() ) {\n\t\t\t\t// Hook not needed (or it's not possible to use it due to missing dependency),\n\t\t\t\t// remove it.\n\t\t\t\t// Since there are no other hooks for marginRight, remove the whole object.\n\t\t\t\tdelete this.get;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Hook needed; redefine it so that the support test is not executed again.\n\n\t\t\treturn (this.get = hookFn).apply( this, arguments );\n\t\t}\n\t};\n}\n\n\n(function() {\n\tvar pixelPositionVal, boxSizingReliableVal,\n\t\tdocElem = document.documentElement,\n\t\tcontainer = document.createElement( \"div\" ),\n\t\tdiv = document.createElement( \"div\" );\n\n\tif ( !div.style ) {\n\t\treturn;\n\t}\n\n\tdiv.style.backgroundClip = \"content-box\";\n\tdiv.cloneNode( true ).style.backgroundClip = \"\";\n\tsupport.clearCloneStyle = div.style.backgroundClip === \"content-box\";\n\n\tcontainer.style.cssText = \"border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;\" +\n\t\t\"position:absolute\";\n\tcontainer.appendChild( div );\n\n\t// Executing both pixelPosition & boxSizingReliable tests require only one layout\n\t// so they're executed at the same time to save the second computation.\n\tfunction computePixelPositionAndBoxSizingReliable() {\n\t\tdiv.style.cssText =\n\t\t\t// Support: Firefox<29, Android 2.3\n\t\t\t// Vendor-prefix box-sizing\n\t\t\t\"-webkit-box-sizing:border-box;-moz-box-sizing:border-box;\" +\n\t\t\t\"box-sizing:border-box;display:block;margin-top:1%;top:1%;\" +\n\t\t\t\"border:1px;padding:1px;width:4px;position:absolute\";\n\t\tdiv.innerHTML = \"\";\n\t\tdocElem.appendChild( container );\n\n\t\tvar divStyle = window.getComputedStyle( div, null );\n\t\tpixelPositionVal = divStyle.top !== \"1%\";\n\t\tboxSizingReliableVal = divStyle.width === \"4px\";\n\n\t\tdocElem.removeChild( container );\n\t}\n\n\t// Support: node.js jsdom\n\t// Don't assume that getComputedStyle is a property of the global object\n\tif ( window.getComputedStyle ) {\n\t\tjQuery.extend( support, {\n\t\t\tpixelPosition: function() {\n\t\t\t\t// This test is executed only once but we still do memoizing\n\t\t\t\t// since we can use the boxSizingReliable pre-computing.\n\t\t\t\t// No need to check if the test was already performed, though.\n\t\t\t\tcomputePixelPositionAndBoxSizingReliable();\n\t\t\t\treturn pixelPositionVal;\n\t\t\t},\n\t\t\tboxSizingReliable: function() {\n\t\t\t\tif ( boxSizingReliableVal == null ) {\n\t\t\t\t\tcomputePixelPositionAndBoxSizingReliable();\n\t\t\t\t}\n\t\t\t\treturn boxSizingReliableVal;\n\t\t\t},\n\t\t\treliableMarginRight: function() {\n\t\t\t\t// Support: Android 2.3\n\t\t\t\t// Check if div with explicit width and no margin-right incorrectly\n\t\t\t\t// gets computed margin-right based on width of container. (#3333)\n\t\t\t\t// WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right\n\t\t\t\t// This support function is only executed once so no memoizing is needed.\n\t\t\t\tvar ret,\n\t\t\t\t\tmarginDiv = div.appendChild( document.createElement( \"div\" ) );\n\n\t\t\t\t// Reset CSS: box-sizing; display; margin; border; padding\n\t\t\t\tmarginDiv.style.cssText = div.style.cssText =\n\t\t\t\t\t// Support: Firefox<29, Android 2.3\n\t\t\t\t\t// Vendor-prefix box-sizing\n\t\t\t\t\t\"-webkit-box-sizing:content-box;-moz-box-sizing:content-box;\" +\n\t\t\t\t\t\"box-sizing:content-box;display:block;margin:0;border:0;padding:0\";\n\t\t\t\tmarginDiv.style.marginRight = marginDiv.style.width = \"0\";\n\t\t\t\tdiv.style.width = \"1px\";\n\t\t\t\tdocElem.appendChild( container );\n\n\t\t\t\tret = !parseFloat( window.getComputedStyle( marginDiv, null ).marginRight );\n\n\t\t\t\tdocElem.removeChild( container );\n\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t});\n\t}\n})();\n\n\n// A method for quickly swapping in/out CSS properties to get correct calculations.\njQuery.swap = function( elem, options, callback, args ) {\n\tvar ret, name,\n\t\told = {};\n\n\t// Remember the old values, and insert the new ones\n\tfor ( name in options ) {\n\t\told[ name ] = elem.style[ name ];\n\t\telem.style[ name ] = options[ name ];\n\t}\n\n\tret = callback.apply( elem, args || [] );\n\n\t// Revert the old values\n\tfor ( name in options ) {\n\t\telem.style[ name ] = old[ name ];\n\t}\n\n\treturn ret;\n};\n\n\nvar\n\t// swappable if display is none or starts with table except \"table\", \"table-cell\", or \"table-caption\"\n\t// see here for display values: https://developer.mozilla.org/en-US/docs/CSS/display\n\trdisplayswap = /^(none|table(?!-c[ea]).+)/,\n\trnumsplit = new RegExp( \"^(\" + pnum + \")(.*)$\", \"i\" ),\n\trrelNum = new RegExp( \"^([+-])=(\" + pnum + \")\", \"i\" ),\n\n\tcssShow = { position: \"absolute\", visibility: \"hidden\", display: \"block\" },\n\tcssNormalTransform = {\n\t\tletterSpacing: \"0\",\n\t\tfontWeight: \"400\"\n\t},\n\n\tcssPrefixes = [ \"Webkit\", \"O\", \"Moz\", \"ms\" ];\n\n// return a css property mapped to a potentially vendor prefixed property\nfunction vendorPropName( style, name ) {\n\n\t// shortcut for names that are not vendor prefixed\n\tif ( name in style ) {\n\t\treturn name;\n\t}\n\n\t// check for vendor prefixed names\n\tvar capName = name[0].toUpperCase() + name.slice(1),\n\t\torigName = name,\n\t\ti = cssPrefixes.length;\n\n\twhile ( i-- ) {\n\t\tname = cssPrefixes[ i ] + capName;\n\t\tif ( name in style ) {\n\t\t\treturn name;\n\t\t}\n\t}\n\n\treturn origName;\n}\n\nfunction setPositiveNumber( elem, value, subtract ) {\n\tvar matches = rnumsplit.exec( value );\n\treturn matches ?\n\t\t// Guard against undefined \"subtract\", e.g., when used as in cssHooks\n\t\tMath.max( 0, matches[ 1 ] - ( subtract || 0 ) ) + ( matches[ 2 ] || \"px\" ) :\n\t\tvalue;\n}\n\nfunction augmentWidthOrHeight( elem, name, extra, isBorderBox, styles ) {\n\tvar i = extra === ( isBorderBox ? \"border\" : \"content\" ) ?\n\t\t// If we already have the right measurement, avoid augmentation\n\t\t4 :\n\t\t// Otherwise initialize for horizontal or vertical properties\n\t\tname === \"width\" ? 1 : 0,\n\n\t\tval = 0;\n\n\tfor ( ; i < 4; i += 2 ) {\n\t\t// both box models exclude margin, so add it if we want it\n\t\tif ( extra === \"margin\" ) {\n\t\t\tval += jQuery.css( elem, extra + cssExpand[ i ], true, styles );\n\t\t}\n\n\t\tif ( isBorderBox ) {\n\t\t\t// border-box includes padding, so remove it if we want content\n\t\t\tif ( extra === \"content\" ) {\n\t\t\t\tval -= jQuery.css( elem, \"padding\" + cssExpand[ i ], true, styles );\n\t\t\t}\n\n\t\t\t// at this point, extra isn't border nor margin, so remove border\n\t\t\tif ( extra !== \"margin\" ) {\n\t\t\t\tval -= jQuery.css( elem, \"border\" + cssExpand[ i ] + \"Width\", true, styles );\n\t\t\t}\n\t\t} else {\n\t\t\t// at this point, extra isn't content, so add padding\n\t\t\tval += jQuery.css( elem, \"padding\" + cssExpand[ i ], true, styles );\n\n\t\t\t// at this point, extra isn't content nor padding, so add border\n\t\t\tif ( extra !== \"padding\" ) {\n\t\t\t\tval += jQuery.css( elem, \"border\" + cssExpand[ i ] + \"Width\", true, styles );\n\t\t\t}\n\t\t}\n\t}\n\n\treturn val;\n}\n\nfunction getWidthOrHeight( elem, name, extra ) {\n\n\t// Start with offset property, which is equivalent to the border-box value\n\tvar valueIsBorderBox = true,\n\t\tval = name === \"width\" ? elem.offsetWidth : elem.offsetHeight,\n\t\tstyles = getStyles( elem ),\n\t\tisBorderBox = jQuery.css( elem, \"boxSizing\", false, styles ) === \"border-box\";\n\n\t// some non-html elements return undefined for offsetWidth, so check for null/undefined\n\t// svg - https://bugzilla.mozilla.org/show_bug.cgi?id=649285\n\t// MathML - https://bugzilla.mozilla.org/show_bug.cgi?id=491668\n\tif ( val <= 0 || val == null ) {\n\t\t// Fall back to computed then uncomputed css if necessary\n\t\tval = curCSS( elem, name, styles );\n\t\tif ( val < 0 || val == null ) {\n\t\t\tval = elem.style[ name ];\n\t\t}\n\n\t\t// Computed unit is not pixels. Stop here and return.\n\t\tif ( rnumnonpx.test(val) ) {\n\t\t\treturn val;\n\t\t}\n\n\t\t// we need the check for style in case a browser which returns unreliable values\n\t\t// for getComputedStyle silently falls back to the reliable elem.style\n\t\tvalueIsBorderBox = isBorderBox &&\n\t\t\t( support.boxSizingReliable() || val === elem.style[ name ] );\n\n\t\t// Normalize \"\", auto, and prepare for extra\n\t\tval = parseFloat( val ) || 0;\n\t}\n\n\t// use the active box-sizing model to add/subtract irrelevant styles\n\treturn ( val +\n\t\taugmentWidthOrHeight(\n\t\t\telem,\n\t\t\tname,\n\t\t\textra || ( isBorderBox ? \"border\" : \"content\" ),\n\t\t\tvalueIsBorderBox,\n\t\t\tstyles\n\t\t)\n\t) + \"px\";\n}\n\nfunction showHide( elements, show ) {\n\tvar display, elem, hidden,\n\t\tvalues = [],\n\t\tindex = 0,\n\t\tlength = elements.length;\n\n\tfor ( ; index < length; index++ ) {\n\t\telem = elements[ index ];\n\t\tif ( !elem.style ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tvalues[ index ] = data_priv.get( elem, \"olddisplay\" );\n\t\tdisplay = elem.style.display;\n\t\tif ( show ) {\n\t\t\t// Reset the inline display of this element to learn if it is\n\t\t\t// being hidden by cascaded rules or not\n\t\t\tif ( !values[ index ] && display === \"none\" ) {\n\t\t\t\telem.style.display = \"\";\n\t\t\t}\n\n\t\t\t// Set elements which have been overridden with display: none\n\t\t\t// in a stylesheet to whatever the default browser style is\n\t\t\t// for such an element\n\t\t\tif ( elem.style.display === \"\" && isHidden( elem ) ) {\n\t\t\t\tvalues[ index ] = data_priv.access( elem, \"olddisplay\", defaultDisplay(elem.nodeName) );\n\t\t\t}\n\t\t} else {\n\t\t\thidden = isHidden( elem );\n\n\t\t\tif ( display !== \"none\" || !hidden ) {\n\t\t\t\tdata_priv.set( elem, \"olddisplay\", hidden ? display : jQuery.css( elem, \"display\" ) );\n\t\t\t}\n\t\t}\n\t}\n\n\t// Set the display of most of the elements in a second loop\n\t// to avoid the constant reflow\n\tfor ( index = 0; index < length; index++ ) {\n\t\telem = elements[ index ];\n\t\tif ( !elem.style ) {\n\t\t\tcontinue;\n\t\t}\n\t\tif ( !show || elem.style.display === \"none\" || elem.style.display === \"\" ) {\n\t\t\telem.style.display = show ? values[ index ] || \"\" : \"none\";\n\t\t}\n\t}\n\n\treturn elements;\n}\n\njQuery.extend({\n\t// Add in style property hooks for overriding the default\n\t// behavior of getting and setting a style property\n\tcssHooks: {\n\t\topacity: {\n\t\t\tget: function( elem, computed ) {\n\t\t\t\tif ( computed ) {\n\t\t\t\t\t// We should always get a number back from opacity\n\t\t\t\t\tvar ret = curCSS( elem, \"opacity\" );\n\t\t\t\t\treturn ret === \"\" ? \"1\" : ret;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t// Don't automatically add \"px\" to these possibly-unitless properties\n\tcssNumber: {\n\t\t\"columnCount\": true,\n\t\t\"fillOpacity\": true,\n\t\t\"flexGrow\": true,\n\t\t\"flexShrink\": true,\n\t\t\"fontWeight\": true,\n\t\t\"lineHeight\": true,\n\t\t\"opacity\": true,\n\t\t\"order\": true,\n\t\t\"orphans\": true,\n\t\t\"widows\": true,\n\t\t\"zIndex\": true,\n\t\t\"zoom\": true\n\t},\n\n\t// Add in properties whose names you wish to fix before\n\t// setting or getting the value\n\tcssProps: {\n\t\t// normalize float css property\n\t\t\"float\": \"cssFloat\"\n\t},\n\n\t// Get and set the style property on a DOM Node\n\tstyle: function( elem, name, value, extra ) {\n\t\t// Don't set styles on text and comment nodes\n\t\tif ( !elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Make sure that we're working with the right name\n\t\tvar ret, type, hooks,\n\t\t\torigName = jQuery.camelCase( name ),\n\t\t\tstyle = elem.style;\n\n\t\tname = jQuery.cssProps[ origName ] || ( jQuery.cssProps[ origName ] = vendorPropName( style, origName ) );\n\n\t\t// gets hook for the prefixed version\n\t\t// followed by the unprefixed version\n\t\thooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];\n\n\t\t// Check if we're setting a value\n\t\tif ( value !== undefined ) {\n\t\t\ttype = typeof value;\n\n\t\t\t// convert relative number strings (+= or -=) to relative numbers. #7345\n\t\t\tif ( type === \"string\" && (ret = rrelNum.exec( value )) ) {\n\t\t\t\tvalue = ( ret[1] + 1 ) * ret[2] + parseFloat( jQuery.css( elem, name ) );\n\t\t\t\t// Fixes bug #9237\n\t\t\t\ttype = \"number\";\n\t\t\t}\n\n\t\t\t// Make sure that null and NaN values aren't set. See: #7116\n\t\t\tif ( value == null || value !== value ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If a number was passed in, add 'px' to the (except for certain CSS properties)\n\t\t\tif ( type === \"number\" && !jQuery.cssNumber[ origName ] ) {\n\t\t\t\tvalue += \"px\";\n\t\t\t}\n\n\t\t\t// Fixes #8908, it can be done more correctly by specifying setters in cssHooks,\n\t\t\t// but it would mean to define eight (for every problematic property) identical functions\n\t\t\tif ( !support.clearCloneStyle && value === \"\" && name.indexOf( \"background\" ) === 0 ) {\n\t\t\t\tstyle[ name ] = \"inherit\";\n\t\t\t}\n\n\t\t\t// If a hook was provided, use that value, otherwise just set the specified value\n\t\t\tif ( !hooks || !(\"set\" in hooks) || (value = hooks.set( elem, value, extra )) !== undefined ) {\n\t\t\t\tstyle[ name ] = value;\n\t\t\t}\n\n\t\t} else {\n\t\t\t// If a hook was provided get the non-computed value from there\n\t\t\tif ( hooks && \"get\" in hooks && (ret = hooks.get( elem, false, extra )) !== undefined ) {\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\t// Otherwise just get the value from the style object\n\t\t\treturn style[ name ];\n\t\t}\n\t},\n\n\tcss: function( elem, name, extra, styles ) {\n\t\tvar val, num, hooks,\n\t\t\torigName = jQuery.camelCase( name );\n\n\t\t// Make sure that we're working with the right name\n\t\tname = jQuery.cssProps[ origName ] || ( jQuery.cssProps[ origName ] = vendorPropName( elem.style, origName ) );\n\n\t\t// gets hook for the prefixed version\n\t\t// followed by the unprefixed version\n\t\thooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];\n\n\t\t// If a hook was provided get the computed value from there\n\t\tif ( hooks && \"get\" in hooks ) {\n\t\t\tval = hooks.get( elem, true, extra );\n\t\t}\n\n\t\t// Otherwise, if a way to get the computed value exists, use that\n\t\tif ( val === undefined ) {\n\t\t\tval = curCSS( elem, name, styles );\n\t\t}\n\n\t\t//convert \"normal\" to computed value\n\t\tif ( val === \"normal\" && name in cssNormalTransform ) {\n\t\t\tval = cssNormalTransform[ name ];\n\t\t}\n\n\t\t// Return, converting to number if forced or a qualifier was provided and val looks numeric\n\t\tif ( extra === \"\" || extra ) {\n\t\t\tnum = parseFloat( val );\n\t\t\treturn extra === true || jQuery.isNumeric( num ) ? num || 0 : val;\n\t\t}\n\t\treturn val;\n\t}\n});\n\njQuery.each([ \"height\", \"width\" ], function( i, name ) {\n\tjQuery.cssHooks[ name ] = {\n\t\tget: function( elem, computed, extra ) {\n\t\t\tif ( computed ) {\n\t\t\t\t// certain elements can have dimension info if we invisibly show them\n\t\t\t\t// however, it must have a current display style that would benefit from this\n\t\t\t\treturn rdisplayswap.test( jQuery.css( elem, \"display\" ) ) && elem.offsetWidth === 0 ?\n\t\t\t\t\tjQuery.swap( elem, cssShow, function() {\n\t\t\t\t\t\treturn getWidthOrHeight( elem, name, extra );\n\t\t\t\t\t}) :\n\t\t\t\t\tgetWidthOrHeight( elem, name, extra );\n\t\t\t}\n\t\t},\n\n\t\tset: function( elem, value, extra ) {\n\t\t\tvar styles = extra && getStyles( elem );\n\t\t\treturn setPositiveNumber( elem, value, extra ?\n\t\t\t\taugmentWidthOrHeight(\n\t\t\t\t\telem,\n\t\t\t\t\tname,\n\t\t\t\t\textra,\n\t\t\t\t\tjQuery.css( elem, \"boxSizing\", false, styles ) === \"border-box\",\n\t\t\t\t\tstyles\n\t\t\t\t) : 0\n\t\t\t);\n\t\t}\n\t};\n});\n\n// Support: Android 2.3\njQuery.cssHooks.marginRight = addGetHookIf( support.reliableMarginRight,\n\tfunction( elem, computed ) {\n\t\tif ( computed ) {\n\t\t\t// WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right\n\t\t\t// Work around by temporarily setting element display to inline-block\n\t\t\treturn jQuery.swap( elem, { \"display\": \"inline-block\" },\n\t\t\t\tcurCSS, [ elem, \"marginRight\" ] );\n\t\t}\n\t}\n);\n\n// These hooks are used by animate to expand properties\njQuery.each({\n\tmargin: \"\",\n\tpadding: \"\",\n\tborder: \"Width\"\n}, function( prefix, suffix ) {\n\tjQuery.cssHooks[ prefix + suffix ] = {\n\t\texpand: function( value ) {\n\t\t\tvar i = 0,\n\t\t\t\texpanded = {},\n\n\t\t\t\t// assumes a single number if not a string\n\t\t\t\tparts = typeof value === \"string\" ? value.split(\" \") : [ value ];\n\n\t\t\tfor ( ; i < 4; i++ ) {\n\t\t\t\texpanded[ prefix + cssExpand[ i ] + suffix ] =\n\t\t\t\t\tparts[ i ] || parts[ i - 2 ] || parts[ 0 ];\n\t\t\t}\n\n\t\t\treturn expanded;\n\t\t}\n\t};\n\n\tif ( !rmargin.test( prefix ) ) {\n\t\tjQuery.cssHooks[ prefix + suffix ].set = setPositiveNumber;\n\t}\n});\n\njQuery.fn.extend({\n\tcss: function( name, value ) {\n\t\treturn access( this, function( elem, name, value ) {\n\t\t\tvar styles, len,\n\t\t\t\tmap = {},\n\t\t\t\ti = 0;\n\n\t\t\tif ( jQuery.isArray( name ) ) {\n\t\t\t\tstyles = getStyles( elem );\n\t\t\t\tlen = name.length;\n\n\t\t\t\tfor ( ; i < len; i++ ) {\n\t\t\t\t\tmap[ name[ i ] ] = jQuery.css( elem, name[ i ], false, styles );\n\t\t\t\t}\n\n\t\t\t\treturn map;\n\t\t\t}\n\n\t\t\treturn value !== undefined ?\n\t\t\t\tjQuery.style( elem, name, value ) :\n\t\t\t\tjQuery.css( elem, name );\n\t\t}, name, value, arguments.length > 1 );\n\t},\n\tshow: function() {\n\t\treturn showHide( this, true );\n\t},\n\thide: function() {\n\t\treturn showHide( this );\n\t},\n\ttoggle: function( state ) {\n\t\tif ( typeof state === \"boolean\" ) {\n\t\t\treturn state ? this.show() : this.hide();\n\t\t}\n\n\t\treturn this.each(function() {\n\t\t\tif ( isHidden( this ) ) {\n\t\t\t\tjQuery( this ).show();\n\t\t\t} else {\n\t\t\t\tjQuery( this ).hide();\n\t\t\t}\n\t\t});\n\t}\n});\n\n\nfunction Tween( elem, options, prop, end, easing ) {\n\treturn new Tween.prototype.init( elem, options, prop, end, easing );\n}\njQuery.Tween = Tween;\n\nTween.prototype = {\n\tconstructor: Tween,\n\tinit: function( elem, options, prop, end, easing, unit ) {\n\t\tthis.elem = elem;\n\t\tthis.prop = prop;\n\t\tthis.easing = easing || \"swing\";\n\t\tthis.options = options;\n\t\tthis.start = this.now = this.cur();\n\t\tthis.end = end;\n\t\tthis.unit = unit || ( jQuery.cssNumber[ prop ] ? \"\" : \"px\" );\n\t},\n\tcur: function() {\n\t\tvar hooks = Tween.propHooks[ this.prop ];\n\n\t\treturn hooks && hooks.get ?\n\t\t\thooks.get( this ) :\n\t\t\tTween.propHooks._default.get( this );\n\t},\n\trun: function( percent ) {\n\t\tvar eased,\n\t\t\thooks = Tween.propHooks[ this.prop ];\n\n\t\tif ( this.options.duration ) {\n\t\t\tthis.pos = eased = jQuery.easing[ this.easing ](\n\t\t\t\tpercent, this.options.duration * percent, 0, 1, this.options.duration\n\t\t\t);\n\t\t} else {\n\t\t\tthis.pos = eased = percent;\n\t\t}\n\t\tthis.now = ( this.end - this.start ) * eased + this.start;\n\n\t\tif ( this.options.step ) {\n\t\t\tthis.options.step.call( this.elem, this.now, this );\n\t\t}\n\n\t\tif ( hooks && hooks.set ) {\n\t\t\thooks.set( this );\n\t\t} else {\n\t\t\tTween.propHooks._default.set( this );\n\t\t}\n\t\treturn this;\n\t}\n};\n\nTween.prototype.init.prototype = Tween.prototype;\n\nTween.propHooks = {\n\t_default: {\n\t\tget: function( tween ) {\n\t\t\tvar result;\n\n\t\t\tif ( tween.elem[ tween.prop ] != null &&\n\t\t\t\t(!tween.elem.style || tween.elem.style[ tween.prop ] == null) ) {\n\t\t\t\treturn tween.elem[ tween.prop ];\n\t\t\t}\n\n\t\t\t// passing an empty string as a 3rd parameter to .css will automatically\n\t\t\t// attempt a parseFloat and fallback to a string if the parse fails\n\t\t\t// so, simple values such as \"10px\" are parsed to Float.\n\t\t\t// complex values such as \"rotate(1rad)\" are returned as is.\n\t\t\tresult = jQuery.css( tween.elem, tween.prop, \"\" );\n\t\t\t// Empty strings, null, undefined and \"auto\" are converted to 0.\n\t\t\treturn !result || result === \"auto\" ? 0 : result;\n\t\t},\n\t\tset: function( tween ) {\n\t\t\t// use step hook for back compat - use cssHook if its there - use .style if its\n\t\t\t// available and use plain properties where available\n\t\t\tif ( jQuery.fx.step[ tween.prop ] ) {\n\t\t\t\tjQuery.fx.step[ tween.prop ]( tween );\n\t\t\t} else if ( tween.elem.style && ( tween.elem.style[ jQuery.cssProps[ tween.prop ] ] != null || jQuery.cssHooks[ tween.prop ] ) ) {\n\t\t\t\tjQuery.style( tween.elem, tween.prop, tween.now + tween.unit );\n\t\t\t} else {\n\t\t\t\ttween.elem[ tween.prop ] = tween.now;\n\t\t\t}\n\t\t}\n\t}\n};\n\n// Support: IE9\n// Panic based approach to setting things on disconnected nodes\n\nTween.propHooks.scrollTop = Tween.propHooks.scrollLeft = {\n\tset: function( tween ) {\n\t\tif ( tween.elem.nodeType && tween.elem.parentNode ) {\n\t\t\ttween.elem[ tween.prop ] = tween.now;\n\t\t}\n\t}\n};\n\njQuery.easing = {\n\tlinear: function( p ) {\n\t\treturn p;\n\t},\n\tswing: function( p ) {\n\t\treturn 0.5 - Math.cos( p * Math.PI ) / 2;\n\t}\n};\n\njQuery.fx = Tween.prototype.init;\n\n// Back Compat <1.8 extension point\njQuery.fx.step = {};\n\n\n\n\nvar\n\tfxNow, timerId,\n\trfxtypes = /^(?:toggle|show|hide)$/,\n\trfxnum = new RegExp( \"^(?:([+-])=|)(\" + pnum + \")([a-z%]*)$\", \"i\" ),\n\trrun = /queueHooks$/,\n\tanimationPrefilters = [ defaultPrefilter ],\n\ttweeners = {\n\t\t\"*\": [ function( prop, value ) {\n\t\t\tvar tween = this.createTween( prop, value ),\n\t\t\t\ttarget = tween.cur(),\n\t\t\t\tparts = rfxnum.exec( value ),\n\t\t\t\tunit = parts && parts[ 3 ] || ( jQuery.cssNumber[ prop ] ? \"\" : \"px\" ),\n\n\t\t\t\t// Starting value computation is required for potential unit mismatches\n\t\t\t\tstart = ( jQuery.cssNumber[ prop ] || unit !== \"px\" && +target ) &&\n\t\t\t\t\trfxnum.exec( jQuery.css( tween.elem, prop ) ),\n\t\t\t\tscale = 1,\n\t\t\t\tmaxIterations = 20;\n\n\t\t\tif ( start && start[ 3 ] !== unit ) {\n\t\t\t\t// Trust units reported by jQuery.css\n\t\t\t\tunit = unit || start[ 3 ];\n\n\t\t\t\t// Make sure we update the tween properties later on\n\t\t\t\tparts = parts || [];\n\n\t\t\t\t// Iteratively approximate from a nonzero starting point\n\t\t\t\tstart = +target || 1;\n\n\t\t\t\tdo {\n\t\t\t\t\t// If previous iteration zeroed out, double until we get *something*\n\t\t\t\t\t// Use a string for doubling factor so we don't accidentally see scale as unchanged below\n\t\t\t\t\tscale = scale || \".5\";\n\n\t\t\t\t\t// Adjust and apply\n\t\t\t\t\tstart = start / scale;\n\t\t\t\t\tjQuery.style( tween.elem, prop, start + unit );\n\n\t\t\t\t// Update scale, tolerating zero or NaN from tween.cur()\n\t\t\t\t// And breaking the loop if scale is unchanged or perfect, or if we've just had enough\n\t\t\t\t} while ( scale !== (scale = tween.cur() / target) && scale !== 1 && --maxIterations );\n\t\t\t}\n\n\t\t\t// Update tween properties\n\t\t\tif ( parts ) {\n\t\t\t\tstart = tween.start = +start || +target || 0;\n\t\t\t\ttween.unit = unit;\n\t\t\t\t// If a +=/-= token was provided, we're doing a relative animation\n\t\t\t\ttween.end = parts[ 1 ] ?\n\t\t\t\t\tstart + ( parts[ 1 ] + 1 ) * parts[ 2 ] :\n\t\t\t\t\t+parts[ 2 ];\n\t\t\t}\n\n\t\t\treturn tween;\n\t\t} ]\n\t};\n\n// Animations created synchronously will run synchronously\nfunction createFxNow() {\n\tsetTimeout(function() {\n\t\tfxNow = undefined;\n\t});\n\treturn ( fxNow = jQuery.now() );\n}\n\n// Generate parameters to create a standard animation\nfunction genFx( type, includeWidth ) {\n\tvar which,\n\t\ti = 0,\n\t\tattrs = { height: type };\n\n\t// if we include width, step value is 1 to do all cssExpand values,\n\t// if we don't include width, step value is 2 to skip over Left and Right\n\tincludeWidth = includeWidth ? 1 : 0;\n\tfor ( ; i < 4 ; i += 2 - includeWidth ) {\n\t\twhich = cssExpand[ i ];\n\t\tattrs[ \"margin\" + which ] = attrs[ \"padding\" + which ] = type;\n\t}\n\n\tif ( includeWidth ) {\n\t\tattrs.opacity = attrs.width = type;\n\t}\n\n\treturn attrs;\n}\n\nfunction createTween( value, prop, animation ) {\n\tvar tween,\n\t\tcollection = ( tweeners[ prop ] || [] ).concat( tweeners[ \"*\" ] ),\n\t\tindex = 0,\n\t\tlength = collection.length;\n\tfor ( ; index < length; index++ ) {\n\t\tif ( (tween = collection[ index ].call( animation, prop, value )) ) {\n\n\t\t\t// we're done with this property\n\t\t\treturn tween;\n\t\t}\n\t}\n}\n\nfunction defaultPrefilter( elem, props, opts ) {\n\t/* jshint validthis: true */\n\tvar prop, value, toggle, tween, hooks, oldfire, display, checkDisplay,\n\t\tanim = this,\n\t\torig = {},\n\t\tstyle = elem.style,\n\t\thidden = elem.nodeType && isHidden( elem ),\n\t\tdataShow = data_priv.get( elem, \"fxshow\" );\n\n\t// handle queue: false promises\n\tif ( !opts.queue ) {\n\t\thooks = jQuery._queueHooks( elem, \"fx\" );\n\t\tif ( hooks.unqueued == null ) {\n\t\t\thooks.unqueued = 0;\n\t\t\toldfire = hooks.empty.fire;\n\t\t\thooks.empty.fire = function() {\n\t\t\t\tif ( !hooks.unqueued ) {\n\t\t\t\t\toldfire();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\thooks.unqueued++;\n\n\t\tanim.always(function() {\n\t\t\t// doing this makes sure that the complete handler will be called\n\t\t\t// before this completes\n\t\t\tanim.always(function() {\n\t\t\t\thooks.unqueued--;\n\t\t\t\tif ( !jQuery.queue( elem, \"fx\" ).length ) {\n\t\t\t\t\thooks.empty.fire();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t// height/width overflow pass\n\tif ( elem.nodeType === 1 && ( \"height\" in props || \"width\" in props ) ) {\n\t\t// Make sure that nothing sneaks out\n\t\t// Record all 3 overflow attributes because IE9-10 do not\n\t\t// change the overflow attribute when overflowX and\n\t\t// overflowY are set to the same value\n\t\topts.overflow = [ style.overflow, style.overflowX, style.overflowY ];\n\n\t\t// Set display property to inline-block for height/width\n\t\t// animations on inline elements that are having width/height animated\n\t\tdisplay = jQuery.css( elem, \"display\" );\n\n\t\t// Test default display if display is currently \"none\"\n\t\tcheckDisplay = display === \"none\" ?\n\t\t\tdata_priv.get( elem, \"olddisplay\" ) || defaultDisplay( elem.nodeName ) : display;\n\n\t\tif ( checkDisplay === \"inline\" && jQuery.css( elem, \"float\" ) === \"none\" ) {\n\t\t\tstyle.display = \"inline-block\";\n\t\t}\n\t}\n\n\tif ( opts.overflow ) {\n\t\tstyle.overflow = \"hidden\";\n\t\tanim.always(function() {\n\t\t\tstyle.overflow = opts.overflow[ 0 ];\n\t\t\tstyle.overflowX = opts.overflow[ 1 ];\n\t\t\tstyle.overflowY = opts.overflow[ 2 ];\n\t\t});\n\t}\n\n\t// show/hide pass\n\tfor ( prop in props ) {\n\t\tvalue = props[ prop ];\n\t\tif ( rfxtypes.exec( value ) ) {\n\t\t\tdelete props[ prop ];\n\t\t\ttoggle = toggle || value === \"toggle\";\n\t\t\tif ( value === ( hidden ? \"hide\" : \"show\" ) ) {\n\n\t\t\t\t// If there is dataShow left over from a stopped hide or show and we are going to proceed with show, we should pretend to be hidden\n\t\t\t\tif ( value === \"show\" && dataShow && dataShow[ prop ] !== undefined ) {\n\t\t\t\t\thidden = true;\n\t\t\t\t} else {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\torig[ prop ] = dataShow && dataShow[ prop ] || jQuery.style( elem, prop );\n\n\t\t// Any non-fx value stops us from restoring the original display value\n\t\t} else {\n\t\t\tdisplay = undefined;\n\t\t}\n\t}\n\n\tif ( !jQuery.isEmptyObject( orig ) ) {\n\t\tif ( dataShow ) {\n\t\t\tif ( \"hidden\" in dataShow ) {\n\t\t\t\thidden = dataShow.hidden;\n\t\t\t}\n\t\t} else {\n\t\t\tdataShow = data_priv.access( elem, \"fxshow\", {} );\n\t\t}\n\n\t\t// store state if its toggle - enables .stop().toggle() to \"reverse\"\n\t\tif ( toggle ) {\n\t\t\tdataShow.hidden = !hidden;\n\t\t}\n\t\tif ( hidden ) {\n\t\t\tjQuery( elem ).show();\n\t\t} else {\n\t\t\tanim.done(function() {\n\t\t\t\tjQuery( elem ).hide();\n\t\t\t});\n\t\t}\n\t\tanim.done(function() {\n\t\t\tvar prop;\n\n\t\t\tdata_priv.remove( elem, \"fxshow\" );\n\t\t\tfor ( prop in orig ) {\n\t\t\t\tjQuery.style( elem, prop, orig[ prop ] );\n\t\t\t}\n\t\t});\n\t\tfor ( prop in orig ) {\n\t\t\ttween = createTween( hidden ? dataShow[ prop ] : 0, prop, anim );\n\n\t\t\tif ( !( prop in dataShow ) ) {\n\t\t\t\tdataShow[ prop ] = tween.start;\n\t\t\t\tif ( hidden ) {\n\t\t\t\t\ttween.end = tween.start;\n\t\t\t\t\ttween.start = prop === \"width\" || prop === \"height\" ? 1 : 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t// If this is a noop like .hide().hide(), restore an overwritten display value\n\t} else if ( (display === \"none\" ? defaultDisplay( elem.nodeName ) : display) === \"inline\" ) {\n\t\tstyle.display = display;\n\t}\n}\n\nfunction propFilter( props, specialEasing ) {\n\tvar index, name, easing, value, hooks;\n\n\t// camelCase, specialEasing and expand cssHook pass\n\tfor ( index in props ) {\n\t\tname = jQuery.camelCase( index );\n\t\teasing = specialEasing[ name ];\n\t\tvalue = props[ index ];\n\t\tif ( jQuery.isArray( value ) ) {\n\t\t\teasing = value[ 1 ];\n\t\t\tvalue = props[ index ] = value[ 0 ];\n\t\t}\n\n\t\tif ( index !== name ) {\n\t\t\tprops[ name ] = value;\n\t\t\tdelete props[ index ];\n\t\t}\n\n\t\thooks = jQuery.cssHooks[ name ];\n\t\tif ( hooks && \"expand\" in hooks ) {\n\t\t\tvalue = hooks.expand( value );\n\t\t\tdelete props[ name ];\n\n\t\t\t// not quite $.extend, this wont overwrite keys already present.\n\t\t\t// also - reusing 'index' from above because we have the correct \"name\"\n\t\t\tfor ( index in value ) {\n\t\t\t\tif ( !( index in props ) ) {\n\t\t\t\t\tprops[ index ] = value[ index ];\n\t\t\t\t\tspecialEasing[ index ] = easing;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tspecialEasing[ name ] = easing;\n\t\t}\n\t}\n}\n\nfunction Animation( elem, properties, options ) {\n\tvar result,\n\t\tstopped,\n\t\tindex = 0,\n\t\tlength = animationPrefilters.length,\n\t\tdeferred = jQuery.Deferred().always( function() {\n\t\t\t// don't match elem in the :animated selector\n\t\t\tdelete tick.elem;\n\t\t}),\n\t\ttick = function() {\n\t\t\tif ( stopped ) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar currentTime = fxNow || createFxNow(),\n\t\t\t\tremaining = Math.max( 0, animation.startTime + animation.duration - currentTime ),\n\t\t\t\t// archaic crash bug won't allow us to use 1 - ( 0.5 || 0 ) (#12497)\n\t\t\t\ttemp = remaining / animation.duration || 0,\n\t\t\t\tpercent = 1 - temp,\n\t\t\t\tindex = 0,\n\t\t\t\tlength = animation.tweens.length;\n\n\t\t\tfor ( ; index < length ; index++ ) {\n\t\t\t\tanimation.tweens[ index ].run( percent );\n\t\t\t}\n\n\t\t\tdeferred.notifyWith( elem, [ animation, percent, remaining ]);\n\n\t\t\tif ( percent < 1 && length ) {\n\t\t\t\treturn remaining;\n\t\t\t} else {\n\t\t\t\tdeferred.resolveWith( elem, [ animation ] );\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tanimation = deferred.promise({\n\t\t\telem: elem,\n\t\t\tprops: jQuery.extend( {}, properties ),\n\t\t\topts: jQuery.extend( true, { specialEasing: {} }, options ),\n\t\t\toriginalProperties: properties,\n\t\t\toriginalOptions: options,\n\t\t\tstartTime: fxNow || createFxNow(),\n\t\t\tduration: options.duration,\n\t\t\ttweens: [],\n\t\t\tcreateTween: function( prop, end ) {\n\t\t\t\tvar tween = jQuery.Tween( elem, animation.opts, prop, end,\n\t\t\t\t\t\tanimation.opts.specialEasing[ prop ] || animation.opts.easing );\n\t\t\t\tanimation.tweens.push( tween );\n\t\t\t\treturn tween;\n\t\t\t},\n\t\t\tstop: function( gotoEnd ) {\n\t\t\t\tvar index = 0,\n\t\t\t\t\t// if we are going to the end, we want to run all the tweens\n\t\t\t\t\t// otherwise we skip this part\n\t\t\t\t\tlength = gotoEnd ? animation.tweens.length : 0;\n\t\t\t\tif ( stopped ) {\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\t\t\t\tstopped = true;\n\t\t\t\tfor ( ; index < length ; index++ ) {\n\t\t\t\t\tanimation.tweens[ index ].run( 1 );\n\t\t\t\t}\n\n\t\t\t\t// resolve when we played the last frame\n\t\t\t\t// otherwise, reject\n\t\t\t\tif ( gotoEnd ) {\n\t\t\t\t\tdeferred.resolveWith( elem, [ animation, gotoEnd ] );\n\t\t\t\t} else {\n\t\t\t\t\tdeferred.rejectWith( elem, [ animation, gotoEnd ] );\n\t\t\t\t}\n\t\t\t\treturn this;\n\t\t\t}\n\t\t}),\n\t\tprops = animation.props;\n\n\tpropFilter( props, animation.opts.specialEasing );\n\n\tfor ( ; index < length ; index++ ) {\n\t\tresult = animationPrefilters[ index ].call( animation, elem, props, animation.opts );\n\t\tif ( result ) {\n\t\t\treturn result;\n\t\t}\n\t}\n\n\tjQuery.map( props, createTween, animation );\n\n\tif ( jQuery.isFunction( animation.opts.start ) ) {\n\t\tanimation.opts.start.call( elem, animation );\n\t}\n\n\tjQuery.fx.timer(\n\t\tjQuery.extend( tick, {\n\t\t\telem: elem,\n\t\t\tanim: animation,\n\t\t\tqueue: animation.opts.queue\n\t\t})\n\t);\n\n\t// attach callbacks from options\n\treturn animation.progress( animation.opts.progress )\n\t\t.done( animation.opts.done, animation.opts.complete )\n\t\t.fail( animation.opts.fail )\n\t\t.always( animation.opts.always );\n}\n\njQuery.Animation = jQuery.extend( Animation, {\n\n\ttweener: function( props, callback ) {\n\t\tif ( jQuery.isFunction( props ) ) {\n\t\t\tcallback = props;\n\t\t\tprops = [ \"*\" ];\n\t\t} else {\n\t\t\tprops = props.split(\" \");\n\t\t}\n\n\t\tvar prop,\n\t\t\tindex = 0,\n\t\t\tlength = props.length;\n\n\t\tfor ( ; index < length ; index++ ) {\n\t\t\tprop = props[ index ];\n\t\t\ttweeners[ prop ] = tweeners[ prop ] || [];\n\t\t\ttweeners[ prop ].unshift( callback );\n\t\t}\n\t},\n\n\tprefilter: function( callback, prepend ) {\n\t\tif ( prepend ) {\n\t\t\tanimationPrefilters.unshift( callback );\n\t\t} else {\n\t\t\tanimationPrefilters.push( callback );\n\t\t}\n\t}\n});\n\njQuery.speed = function( speed, easing, fn ) {\n\tvar opt = speed && typeof speed === \"object\" ? jQuery.extend( {}, speed ) : {\n\t\tcomplete: fn || !fn && easing ||\n\t\t\tjQuery.isFunction( speed ) && speed,\n\t\tduration: speed,\n\t\teasing: fn && easing || easing && !jQuery.isFunction( easing ) && easing\n\t};\n\n\topt.duration = jQuery.fx.off ? 0 : typeof opt.duration === \"number\" ? opt.duration :\n\t\topt.duration in jQuery.fx.speeds ? jQuery.fx.speeds[ opt.duration ] : jQuery.fx.speeds._default;\n\n\t// normalize opt.queue - true/undefined/null -> \"fx\"\n\tif ( opt.queue == null || opt.queue === true ) {\n\t\topt.queue = \"fx\";\n\t}\n\n\t// Queueing\n\topt.old = opt.complete;\n\n\topt.complete = function() {\n\t\tif ( jQuery.isFunction( opt.old ) ) {\n\t\t\topt.old.call( this );\n\t\t}\n\n\t\tif ( opt.queue ) {\n\t\t\tjQuery.dequeue( this, opt.queue );\n\t\t}\n\t};\n\n\treturn opt;\n};\n\njQuery.fn.extend({\n\tfadeTo: function( speed, to, easing, callback ) {\n\n\t\t// show any hidden elements after setting opacity to 0\n\t\treturn this.filter( isHidden ).css( \"opacity\", 0 ).show()\n\n\t\t\t// animate to the value specified\n\t\t\t.end().animate({ opacity: to }, speed, easing, callback );\n\t},\n\tanimate: function( prop, speed, easing, callback ) {\n\t\tvar empty = jQuery.isEmptyObject( prop ),\n\t\t\toptall = jQuery.speed( speed, easing, callback ),\n\t\t\tdoAnimation = function() {\n\t\t\t\t// Operate on a copy of prop so per-property easing won't be lost\n\t\t\t\tvar anim = Animation( this, jQuery.extend( {}, prop ), optall );\n\n\t\t\t\t// Empty animations, or finishing resolves immediately\n\t\t\t\tif ( empty || data_priv.get( this, \"finish\" ) ) {\n\t\t\t\t\tanim.stop( true );\n\t\t\t\t}\n\t\t\t};\n\t\t\tdoAnimation.finish = doAnimation;\n\n\t\treturn empty || optall.queue === false ?\n\t\t\tthis.each( doAnimation ) :\n\t\t\tthis.queue( optall.queue, doAnimation );\n\t},\n\tstop: function( type, clearQueue, gotoEnd ) {\n\t\tvar stopQueue = function( hooks ) {\n\t\t\tvar stop = hooks.stop;\n\t\t\tdelete hooks.stop;\n\t\t\tstop( gotoEnd );\n\t\t};\n\n\t\tif ( typeof type !== \"string\" ) {\n\t\t\tgotoEnd = clearQueue;\n\t\t\tclearQueue = type;\n\t\t\ttype = undefined;\n\t\t}\n\t\tif ( clearQueue && type !== false ) {\n\t\t\tthis.queue( type || \"fx\", [] );\n\t\t}\n\n\t\treturn this.each(function() {\n\t\t\tvar dequeue = true,\n\t\t\t\tindex = type != null && type + \"queueHooks\",\n\t\t\t\ttimers = jQuery.timers,\n\t\t\t\tdata = data_priv.get( this );\n\n\t\t\tif ( index ) {\n\t\t\t\tif ( data[ index ] && data[ index ].stop ) {\n\t\t\t\t\tstopQueue( data[ index ] );\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor ( index in data ) {\n\t\t\t\t\tif ( data[ index ] && data[ index ].stop && rrun.test( index ) ) {\n\t\t\t\t\t\tstopQueue( data[ index ] );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor ( index = timers.length; index--; ) {\n\t\t\t\tif ( timers[ index ].elem === this && (type == null || timers[ index ].queue === type) ) {\n\t\t\t\t\ttimers[ index ].anim.stop( gotoEnd );\n\t\t\t\t\tdequeue = false;\n\t\t\t\t\ttimers.splice( index, 1 );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// start the next in the queue if the last step wasn't forced\n\t\t\t// timers currently will call their complete callbacks, which will dequeue\n\t\t\t// but only if they were gotoEnd\n\t\t\tif ( dequeue || !gotoEnd ) {\n\t\t\t\tjQuery.dequeue( this, type );\n\t\t\t}\n\t\t});\n\t},\n\tfinish: function( type ) {\n\t\tif ( type !== false ) {\n\t\t\ttype = type || \"fx\";\n\t\t}\n\t\treturn this.each(function() {\n\t\t\tvar index,\n\t\t\t\tdata = data_priv.get( this ),\n\t\t\t\tqueue = data[ type + \"queue\" ],\n\t\t\t\thooks = data[ type + \"queueHooks\" ],\n\t\t\t\ttimers = jQuery.timers,\n\t\t\t\tlength = queue ? queue.length : 0;\n\n\t\t\t// enable finishing flag on private data\n\t\t\tdata.finish = true;\n\n\t\t\t// empty the queue first\n\t\t\tjQuery.queue( this, type, [] );\n\n\t\t\tif ( hooks && hooks.stop ) {\n\t\t\t\thooks.stop.call( this, true );\n\t\t\t}\n\n\t\t\t// look for any active animations, and finish them\n\t\t\tfor ( index = timers.length; index--; ) {\n\t\t\t\tif ( timers[ index ].elem === this && timers[ index ].queue === type ) {\n\t\t\t\t\ttimers[ index ].anim.stop( true );\n\t\t\t\t\ttimers.splice( index, 1 );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// look for any animations in the old queue and finish them\n\t\t\tfor ( index = 0; index < length; index++ ) {\n\t\t\t\tif ( queue[ index ] && queue[ index ].finish ) {\n\t\t\t\t\tqueue[ index ].finish.call( this );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// turn off finishing flag\n\t\t\tdelete data.finish;\n\t\t});\n\t}\n});\n\njQuery.each([ \"toggle\", \"show\", \"hide\" ], function( i, name ) {\n\tvar cssFn = jQuery.fn[ name ];\n\tjQuery.fn[ name ] = function( speed, easing, callback ) {\n\t\treturn speed == null || typeof speed === \"boolean\" ?\n\t\t\tcssFn.apply( this, arguments ) :\n\t\t\tthis.animate( genFx( name, true ), speed, easing, callback );\n\t};\n});\n\n// Generate shortcuts for custom animations\njQuery.each({\n\tslideDown: genFx(\"show\"),\n\tslideUp: genFx(\"hide\"),\n\tslideToggle: genFx(\"toggle\"),\n\tfadeIn: { opacity: \"show\" },\n\tfadeOut: { opacity: \"hide\" },\n\tfadeToggle: { opacity: \"toggle\" }\n}, function( name, props ) {\n\tjQuery.fn[ name ] = function( speed, easing, callback ) {\n\t\treturn this.animate( props, speed, easing, callback );\n\t};\n});\n\njQuery.timers = [];\njQuery.fx.tick = function() {\n\tvar timer,\n\t\ti = 0,\n\t\ttimers = jQuery.timers;\n\n\tfxNow = jQuery.now();\n\n\tfor ( ; i < timers.length; i++ ) {\n\t\ttimer = timers[ i ];\n\t\t// Checks the timer has not already been removed\n\t\tif ( !timer() && timers[ i ] === timer ) {\n\t\t\ttimers.splice( i--, 1 );\n\t\t}\n\t}\n\n\tif ( !timers.length ) {\n\t\tjQuery.fx.stop();\n\t}\n\tfxNow = undefined;\n};\n\njQuery.fx.timer = function( timer ) {\n\tjQuery.timers.push( timer );\n\tif ( timer() ) {\n\t\tjQuery.fx.start();\n\t} else {\n\t\tjQuery.timers.pop();\n\t}\n};\n\njQuery.fx.interval = 13;\n\njQuery.fx.start = function() {\n\tif ( !timerId ) {\n\t\ttimerId = setInterval( jQuery.fx.tick, jQuery.fx.interval );\n\t}\n};\n\njQuery.fx.stop = function() {\n\tclearInterval( timerId );\n\ttimerId = null;\n};\n\njQuery.fx.speeds = {\n\tslow: 600,\n\tfast: 200,\n\t// Default speed\n\t_default: 400\n};\n\n\n// Based off of the plugin by Clint Helfers, with permission.\n// http://blindsignals.com/index.php/2009/07/jquery-delay/\njQuery.fn.delay = function( time, type ) {\n\ttime = jQuery.fx ? jQuery.fx.speeds[ time ] || time : time;\n\ttype = type || \"fx\";\n\n\treturn this.queue( type, function( next, hooks ) {\n\t\tvar timeout = setTimeout( next, time );\n\t\thooks.stop = function() {\n\t\t\tclearTimeout( timeout );\n\t\t};\n\t});\n};\n\n\n(function() {\n\tvar input = document.createElement( \"input\" ),\n\t\tselect = document.createElement( \"select\" ),\n\t\topt = select.appendChild( document.createElement( \"option\" ) );\n\n\tinput.type = \"checkbox\";\n\n\t// Support: iOS 5.1, Android 4.x, Android 2.3\n\t// Check the default checkbox/radio value (\"\" on old WebKit; \"on\" elsewhere)\n\tsupport.checkOn = input.value !== \"\";\n\n\t// Must access the parent to make an option select properly\n\t// Support: IE9, IE10\n\tsupport.optSelected = opt.selected;\n\n\t// Make sure that the options inside disabled selects aren't marked as disabled\n\t// (WebKit marks them as disabled)\n\tselect.disabled = true;\n\tsupport.optDisabled = !opt.disabled;\n\n\t// Check if an input maintains its value after becoming a radio\n\t// Support: IE9, IE10\n\tinput = document.createElement( \"input\" );\n\tinput.value = \"t\";\n\tinput.type = \"radio\";\n\tsupport.radioValue = input.value === \"t\";\n})();\n\n\nvar nodeHook, boolHook,\n\tattrHandle = jQuery.expr.attrHandle;\n\njQuery.fn.extend({\n\tattr: function( name, value ) {\n\t\treturn access( this, jQuery.attr, name, value, arguments.length > 1 );\n\t},\n\n\tremoveAttr: function( name ) {\n\t\treturn this.each(function() {\n\t\t\tjQuery.removeAttr( this, name );\n\t\t});\n\t}\n});\n\njQuery.extend({\n\tattr: function( elem, name, value ) {\n\t\tvar hooks, ret,\n\t\t\tnType = elem.nodeType;\n\n\t\t// don't get/set attributes on text, comment and attribute nodes\n\t\tif ( !elem || nType === 3 || nType === 8 || nType === 2 ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Fallback to prop when attributes are not supported\n\t\tif ( typeof elem.getAttribute === strundefined ) {\n\t\t\treturn jQuery.prop( elem, name, value );\n\t\t}\n\n\t\t// All attributes are lowercase\n\t\t// Grab necessary hook if one is defined\n\t\tif ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {\n\t\t\tname = name.toLowerCase();\n\t\t\thooks = jQuery.attrHooks[ name ] ||\n\t\t\t\t( jQuery.expr.match.bool.test( name ) ? boolHook : nodeHook );\n\t\t}\n\n\t\tif ( value !== undefined ) {\n\n\t\t\tif ( value === null ) {\n\t\t\t\tjQuery.removeAttr( elem, name );\n\n\t\t\t} else if ( hooks && \"set\" in hooks && (ret = hooks.set( elem, value, name )) !== undefined ) {\n\t\t\t\treturn ret;\n\n\t\t\t} else {\n\t\t\t\telem.setAttribute( name, value + \"\" );\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t} else if ( hooks && \"get\" in hooks && (ret = hooks.get( elem, name )) !== null ) {\n\t\t\treturn ret;\n\n\t\t} else {\n\t\t\tret = jQuery.find.attr( elem, name );\n\n\t\t\t// Non-existent attributes return null, we normalize to undefined\n\t\t\treturn ret == null ?\n\t\t\t\tundefined :\n\t\t\t\tret;\n\t\t}\n\t},\n\n\tremoveAttr: function( elem, value ) {\n\t\tvar name, propName,\n\t\t\ti = 0,\n\t\t\tattrNames = value && value.match( rnotwhite );\n\n\t\tif ( attrNames && elem.nodeType === 1 ) {\n\t\t\twhile ( (name = attrNames[i++]) ) {\n\t\t\t\tpropName = jQuery.propFix[ name ] || name;\n\n\t\t\t\t// Boolean attributes get special treatment (#10870)\n\t\t\t\tif ( jQuery.expr.match.bool.test( name ) ) {\n\t\t\t\t\t// Set corresponding property to false\n\t\t\t\t\telem[ propName ] = false;\n\t\t\t\t}\n\n\t\t\t\telem.removeAttribute( name );\n\t\t\t}\n\t\t}\n\t},\n\n\tattrHooks: {\n\t\ttype: {\n\t\t\tset: function( elem, value ) {\n\t\t\t\tif ( !support.radioValue && value === \"radio\" &&\n\t\t\t\t\tjQuery.nodeName( elem, \"input\" ) ) {\n\t\t\t\t\t// Setting the type on a radio button after the value resets the value in IE6-9\n\t\t\t\t\t// Reset value to default in case type is set after value during creation\n\t\t\t\t\tvar val = elem.value;\n\t\t\t\t\telem.setAttribute( \"type\", value );\n\t\t\t\t\tif ( val ) {\n\t\t\t\t\t\telem.value = val;\n\t\t\t\t\t}\n\t\t\t\t\treturn value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Hooks for boolean attributes\nboolHook = {\n\tset: function( elem, value, name ) {\n\t\tif ( value === false ) {\n\t\t\t// Remove boolean attributes when set to false\n\t\t\tjQuery.removeAttr( elem, name );\n\t\t} else {\n\t\t\telem.setAttribute( name, name );\n\t\t}\n\t\treturn name;\n\t}\n};\njQuery.each( jQuery.expr.match.bool.source.match( /\\w+/g ), function( i, name ) {\n\tvar getter = attrHandle[ name ] || jQuery.find.attr;\n\n\tattrHandle[ name ] = function( elem, name, isXML ) {\n\t\tvar ret, handle;\n\t\tif ( !isXML ) {\n\t\t\t// Avoid an infinite loop by temporarily removing this function from the getter\n\t\t\thandle = attrHandle[ name ];\n\t\t\tattrHandle[ name ] = ret;\n\t\t\tret = getter( elem, name, isXML ) != null ?\n\t\t\t\tname.toLowerCase() :\n\t\t\t\tnull;\n\t\t\tattrHandle[ name ] = handle;\n\t\t}\n\t\treturn ret;\n\t};\n});\n\n\n\n\nvar rfocusable = /^(?:input|select|textarea|button)$/i;\n\njQuery.fn.extend({\n\tprop: function( name, value ) {\n\t\treturn access( this, jQuery.prop, name, value, arguments.length > 1 );\n\t},\n\n\tremoveProp: function( name ) {\n\t\treturn this.each(function() {\n\t\t\tdelete this[ jQuery.propFix[ name ] || name ];\n\t\t});\n\t}\n});\n\njQuery.extend({\n\tpropFix: {\n\t\t\"for\": \"htmlFor\",\n\t\t\"class\": \"className\"\n\t},\n\n\tprop: function( elem, name, value ) {\n\t\tvar ret, hooks, notxml,\n\t\t\tnType = elem.nodeType;\n\n\t\t// don't get/set properties on text, comment and attribute nodes\n\t\tif ( !elem || nType === 3 || nType === 8 || nType === 2 ) {\n\t\t\treturn;\n\t\t}\n\n\t\tnotxml = nType !== 1 || !jQuery.isXMLDoc( elem );\n\n\t\tif ( notxml ) {\n\t\t\t// Fix name and attach hooks\n\t\t\tname = jQuery.propFix[ name ] || name;\n\t\t\thooks = jQuery.propHooks[ name ];\n\t\t}\n\n\t\tif ( value !== undefined ) {\n\t\t\treturn hooks && \"set\" in hooks && (ret = hooks.set( elem, value, name )) !== undefined ?\n\t\t\t\tret :\n\t\t\t\t( elem[ name ] = value );\n\n\t\t} else {\n\t\t\treturn hooks && \"get\" in hooks && (ret = hooks.get( elem, name )) !== null ?\n\t\t\t\tret :\n\t\t\t\telem[ name ];\n\t\t}\n\t},\n\n\tpropHooks: {\n\t\ttabIndex: {\n\t\t\tget: function( elem ) {\n\t\t\t\treturn elem.hasAttribute( \"tabindex\" ) || rfocusable.test( elem.nodeName ) || elem.href ?\n\t\t\t\t\telem.tabIndex :\n\t\t\t\t\t-1;\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Support: IE9+\n// Selectedness for an option in an optgroup can be inaccurate\nif ( !support.optSelected ) {\n\tjQuery.propHooks.selected = {\n\t\tget: function( elem ) {\n\t\t\tvar parent = elem.parentNode;\n\t\t\tif ( parent && parent.parentNode ) {\n\t\t\t\tparent.parentNode.selectedIndex;\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t};\n}\n\njQuery.each([\n\t\"tabIndex\",\n\t\"readOnly\",\n\t\"maxLength\",\n\t\"cellSpacing\",\n\t\"cellPadding\",\n\t\"rowSpan\",\n\t\"colSpan\",\n\t\"useMap\",\n\t\"frameBorder\",\n\t\"contentEditable\"\n], function() {\n\tjQuery.propFix[ this.toLowerCase() ] = this;\n});\n\n\n\n\nvar rclass = /[\\t\\r\\n\\f]/g;\n\njQuery.fn.extend({\n\taddClass: function( value ) {\n\t\tvar classes, elem, cur, clazz, j, finalValue,\n\t\t\tproceed = typeof value === \"string\" && value,\n\t\t\ti = 0,\n\t\t\tlen = this.length;\n\n\t\tif ( jQuery.isFunction( value ) ) {\n\t\t\treturn this.each(function( j ) {\n\t\t\t\tjQuery( this ).addClass( value.call( this, j, this.className ) );\n\t\t\t});\n\t\t}\n\n\t\tif ( proceed ) {\n\t\t\t// The disjunction here is for better compressibility (see removeClass)\n\t\t\tclasses = ( value || \"\" ).match( rnotwhite ) || [];\n\n\t\t\tfor ( ; i < len; i++ ) {\n\t\t\t\telem = this[ i ];\n\t\t\t\tcur = elem.nodeType === 1 && ( elem.className ?\n\t\t\t\t\t( \" \" + elem.className + \" \" ).replace( rclass, \" \" ) :\n\t\t\t\t\t\" \"\n\t\t\t\t);\n\n\t\t\t\tif ( cur ) {\n\t\t\t\t\tj = 0;\n\t\t\t\t\twhile ( (clazz = classes[j++]) ) {\n\t\t\t\t\t\tif ( cur.indexOf( \" \" + clazz + \" \" ) < 0 ) {\n\t\t\t\t\t\t\tcur += clazz + \" \";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// only assign if different to avoid unneeded rendering.\n\t\t\t\t\tfinalValue = jQuery.trim( cur );\n\t\t\t\t\tif ( elem.className !== finalValue ) {\n\t\t\t\t\t\telem.className = finalValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t},\n\n\tremoveClass: function( value ) {\n\t\tvar classes, elem, cur, clazz, j, finalValue,\n\t\t\tproceed = arguments.length === 0 || typeof value === \"string\" && value,\n\t\t\ti = 0,\n\t\t\tlen = this.length;\n\n\t\tif ( jQuery.isFunction( value ) ) {\n\t\t\treturn this.each(function( j ) {\n\t\t\t\tjQuery( this ).removeClass( value.call( this, j, this.className ) );\n\t\t\t});\n\t\t}\n\t\tif ( proceed ) {\n\t\t\tclasses = ( value || \"\" ).match( rnotwhite ) || [];\n\n\t\t\tfor ( ; i < len; i++ ) {\n\t\t\t\telem = this[ i ];\n\t\t\t\t// This expression is here for better compressibility (see addClass)\n\t\t\t\tcur = elem.nodeType === 1 && ( elem.className ?\n\t\t\t\t\t( \" \" + elem.className + \" \" ).replace( rclass, \" \" ) :\n\t\t\t\t\t\"\"\n\t\t\t\t);\n\n\t\t\t\tif ( cur ) {\n\t\t\t\t\tj = 0;\n\t\t\t\t\twhile ( (clazz = classes[j++]) ) {\n\t\t\t\t\t\t// Remove *all* instances\n\t\t\t\t\t\twhile ( cur.indexOf( \" \" + clazz + \" \" ) >= 0 ) {\n\t\t\t\t\t\t\tcur = cur.replace( \" \" + clazz + \" \", \" \" );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// only assign if different to avoid unneeded rendering.\n\t\t\t\t\tfinalValue = value ? jQuery.trim( cur ) : \"\";\n\t\t\t\t\tif ( elem.className !== finalValue ) {\n\t\t\t\t\t\telem.className = finalValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t},\n\n\ttoggleClass: function( value, stateVal ) {\n\t\tvar type = typeof value;\n\n\t\tif ( typeof stateVal === \"boolean\" && type === \"string\" ) {\n\t\t\treturn stateVal ? this.addClass( value ) : this.removeClass( value );\n\t\t}\n\n\t\tif ( jQuery.isFunction( value ) ) {\n\t\t\treturn this.each(function( i ) {\n\t\t\t\tjQuery( this ).toggleClass( value.call(this, i, this.className, stateVal), stateVal );\n\t\t\t});\n\t\t}\n\n\t\treturn this.each(function() {\n\t\t\tif ( type === \"string\" ) {\n\t\t\t\t// toggle individual class names\n\t\t\t\tvar className,\n\t\t\t\t\ti = 0,\n\t\t\t\t\tself = jQuery( this ),\n\t\t\t\t\tclassNames = value.match( rnotwhite ) || [];\n\n\t\t\t\twhile ( (className = classNames[ i++ ]) ) {\n\t\t\t\t\t// check each className given, space separated list\n\t\t\t\t\tif ( self.hasClass( className ) ) {\n\t\t\t\t\t\tself.removeClass( className );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tself.addClass( className );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t// Toggle whole class name\n\t\t\t} else if ( type === strundefined || type === \"boolean\" ) {\n\t\t\t\tif ( this.className ) {\n\t\t\t\t\t// store className if set\n\t\t\t\t\tdata_priv.set( this, \"__className__\", this.className );\n\t\t\t\t}\n\n\t\t\t\t// If the element has a class name or if we're passed \"false\",\n\t\t\t\t// then remove the whole classname (if there was one, the above saved it).\n\t\t\t\t// Otherwise bring back whatever was previously saved (if anything),\n\t\t\t\t// falling back to the empty string if nothing was stored.\n\t\t\t\tthis.className = this.className || value === false ? \"\" : data_priv.get( this, \"__className__\" ) || \"\";\n\t\t\t}\n\t\t});\n\t},\n\n\thasClass: function( selector ) {\n\t\tvar className = \" \" + selector + \" \",\n\t\t\ti = 0,\n\t\t\tl = this.length;\n\t\tfor ( ; i < l; i++ ) {\n\t\t\tif ( this[i].nodeType === 1 && (\" \" + this[i].className + \" \").replace(rclass, \" \").indexOf( className ) >= 0 ) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n});\n\n\n\n\nvar rreturn = /\\r/g;\n\njQuery.fn.extend({\n\tval: function( value ) {\n\t\tvar hooks, ret, isFunction,\n\t\t\telem = this[0];\n\n\t\tif ( !arguments.length ) {\n\t\t\tif ( elem ) {\n\t\t\t\thooks = jQuery.valHooks[ elem.type ] || jQuery.valHooks[ elem.nodeName.toLowerCase() ];\n\n\t\t\t\tif ( hooks && \"get\" in hooks && (ret = hooks.get( elem, \"value\" )) !== undefined ) {\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\n\t\t\t\tret = elem.value;\n\n\t\t\t\treturn typeof ret === \"string\" ?\n\t\t\t\t\t// handle most common string cases\n\t\t\t\t\tret.replace(rreturn, \"\") :\n\t\t\t\t\t// handle cases where value is null/undef or number\n\t\t\t\t\tret == null ? \"\" : ret;\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tisFunction = jQuery.isFunction( value );\n\n\t\treturn this.each(function( i ) {\n\t\t\tvar val;\n\n\t\t\tif ( this.nodeType !== 1 ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( isFunction ) {\n\t\t\t\tval = value.call( this, i, jQuery( this ).val() );\n\t\t\t} else {\n\t\t\t\tval = value;\n\t\t\t}\n\n\t\t\t// Treat null/undefined as \"\"; convert numbers to string\n\t\t\tif ( val == null ) {\n\t\t\t\tval = \"\";\n\n\t\t\t} else if ( typeof val === \"number\" ) {\n\t\t\t\tval += \"\";\n\n\t\t\t} else if ( jQuery.isArray( val ) ) {\n\t\t\t\tval = jQuery.map( val, function( value ) {\n\t\t\t\t\treturn value == null ? \"\" : value + \"\";\n\t\t\t\t});\n\t\t\t}\n\n\t\t\thooks = jQuery.valHooks[ this.type ] || jQuery.valHooks[ this.nodeName.toLowerCase() ];\n\n\t\t\t// If set returns undefined, fall back to normal setting\n\t\t\tif ( !hooks || !(\"set\" in hooks) || hooks.set( this, val, \"value\" ) === undefined ) {\n\t\t\t\tthis.value = val;\n\t\t\t}\n\t\t});\n\t}\n});\n\njQuery.extend({\n\tvalHooks: {\n\t\toption: {\n\t\t\tget: function( elem ) {\n\t\t\t\tvar val = jQuery.find.attr( elem, \"value\" );\n\t\t\t\treturn val != null ?\n\t\t\t\t\tval :\n\t\t\t\t\t// Support: IE10-11+\n\t\t\t\t\t// option.text throws exceptions (#14686, #14858)\n\t\t\t\t\tjQuery.trim( jQuery.text( elem ) );\n\t\t\t}\n\t\t},\n\t\tselect: {\n\t\t\tget: function( elem ) {\n\t\t\t\tvar value, option,\n\t\t\t\t\toptions = elem.options,\n\t\t\t\t\tindex = elem.selectedIndex,\n\t\t\t\t\tone = elem.type === \"select-one\" || index < 0,\n\t\t\t\t\tvalues = one ? null : [],\n\t\t\t\t\tmax = one ? index + 1 : options.length,\n\t\t\t\t\ti = index < 0 ?\n\t\t\t\t\t\tmax :\n\t\t\t\t\t\tone ? index : 0;\n\n\t\t\t\t// Loop through all the selected options\n\t\t\t\tfor ( ; i < max; i++ ) {\n\t\t\t\t\toption = options[ i ];\n\n\t\t\t\t\t// IE6-9 doesn't update selected after form reset (#2551)\n\t\t\t\t\tif ( ( option.selected || i === index ) &&\n\t\t\t\t\t\t\t// Don't return options that are disabled or in a disabled optgroup\n\t\t\t\t\t\t\t( support.optDisabled ? !option.disabled : option.getAttribute( \"disabled\" ) === null ) &&\n\t\t\t\t\t\t\t( !option.parentNode.disabled || !jQuery.nodeName( option.parentNode, \"optgroup\" ) ) ) {\n\n\t\t\t\t\t\t// Get the specific value for the option\n\t\t\t\t\t\tvalue = jQuery( option ).val();\n\n\t\t\t\t\t\t// We don't need an array for one selects\n\t\t\t\t\t\tif ( one ) {\n\t\t\t\t\t\t\treturn value;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Multi-Selects return an array\n\t\t\t\t\t\tvalues.push( value );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn values;\n\t\t\t},\n\n\t\t\tset: function( elem, value ) {\n\t\t\t\tvar optionSet, option,\n\t\t\t\t\toptions = elem.options,\n\t\t\t\t\tvalues = jQuery.makeArray( value ),\n\t\t\t\t\ti = options.length;\n\n\t\t\t\twhile ( i-- ) {\n\t\t\t\t\toption = options[ i ];\n\t\t\t\t\tif ( (option.selected = jQuery.inArray( option.value, values ) >= 0) ) {\n\t\t\t\t\t\toptionSet = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// force browsers to behave consistently when non-matching value is set\n\t\t\t\tif ( !optionSet ) {\n\t\t\t\t\telem.selectedIndex = -1;\n\t\t\t\t}\n\t\t\t\treturn values;\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Radios and checkboxes getter/setter\njQuery.each([ \"radio\", \"checkbox\" ], function() {\n\tjQuery.valHooks[ this ] = {\n\t\tset: function( elem, value ) {\n\t\t\tif ( jQuery.isArray( value ) ) {\n\t\t\t\treturn ( elem.checked = jQuery.inArray( jQuery(elem).val(), value ) >= 0 );\n\t\t\t}\n\t\t}\n\t};\n\tif ( !support.checkOn ) {\n\t\tjQuery.valHooks[ this ].get = function( elem ) {\n\t\t\t// Support: Webkit\n\t\t\t// \"\" is returned instead of \"on\" if a value isn't specified\n\t\t\treturn elem.getAttribute(\"value\") === null ? \"on\" : elem.value;\n\t\t};\n\t}\n});\n\n\n\n\n// Return jQuery for attributes-only inclusion\n\n\njQuery.each( (\"blur focus focusin focusout load resize scroll unload click dblclick \" +\n\t\"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave \" +\n\t\"change select submit keydown keypress keyup error contextmenu\").split(\" \"), function( i, name ) {\n\n\t// Handle event binding\n\tjQuery.fn[ name ] = function( data, fn ) {\n\t\treturn arguments.length > 0 ?\n\t\t\tthis.on( name, null, data, fn ) :\n\t\t\tthis.trigger( name );\n\t};\n});\n\njQuery.fn.extend({\n\thover: function( fnOver, fnOut ) {\n\t\treturn this.mouseenter( fnOver ).mouseleave( fnOut || fnOver );\n\t},\n\n\tbind: function( types, data, fn ) {\n\t\treturn this.on( types, null, data, fn );\n\t},\n\tunbind: function( types, fn ) {\n\t\treturn this.off( types, null, fn );\n\t},\n\n\tdelegate: function( selector, types, data, fn ) {\n\t\treturn this.on( types, selector, data, fn );\n\t},\n\tundelegate: function( selector, types, fn ) {\n\t\t// ( namespace ) or ( selector, types [, fn] )\n\t\treturn arguments.length === 1 ? this.off( selector, \"**\" ) : this.off( types, selector || \"**\", fn );\n\t}\n});\n\n\nvar nonce = jQuery.now();\n\nvar rquery = (/\\?/);\n\n\n\n// Support: Android 2.3\n// Workaround failure to string-cast null input\njQuery.parseJSON = function( data ) {\n\treturn JSON.parse( data + \"\" );\n};\n\n\n// Cross-browser xml parsing\njQuery.parseXML = function( data ) {\n\tvar xml, tmp;\n\tif ( !data || typeof data !== \"string\" ) {\n\t\treturn null;\n\t}\n\n\t// Support: IE9\n\ttry {\n\t\ttmp = new DOMParser();\n\t\txml = tmp.parseFromString( data, \"text/xml\" );\n\t} catch ( e ) {\n\t\txml = undefined;\n\t}\n\n\tif ( !xml || xml.getElementsByTagName( \"parsererror\" ).length ) {\n\t\tjQuery.error( \"Invalid XML: \" + data );\n\t}\n\treturn xml;\n};\n\n\nvar\n\t// Document location\n\tajaxLocParts,\n\tajaxLocation,\n\n\trhash = /#.*$/,\n\trts = /([?&])_=[^&]*/,\n\trheaders = /^(.*?):[ \\t]*([^\\r\\n]*)$/mg,\n\t// #7653, #8125, #8152: local protocol detection\n\trlocalProtocol = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/,\n\trnoContent = /^(?:GET|HEAD)$/,\n\trprotocol = /^\\/\\//,\n\trurl = /^([\\w.+-]+:)(?:\\/\\/(?:[^\\/?#]*@|)([^\\/?#:]*)(?::(\\d+)|)|)/,\n\n\t/* Prefilters\n\t * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)\n\t * 2) These are called:\n\t *    - BEFORE asking for a transport\n\t *    - AFTER param serialization (s.data is a string if s.processData is true)\n\t * 3) key is the dataType\n\t * 4) the catchall symbol \"*\" can be used\n\t * 5) execution will start with transport dataType and THEN continue down to \"*\" if needed\n\t */\n\tprefilters = {},\n\n\t/* Transports bindings\n\t * 1) key is the dataType\n\t * 2) the catchall symbol \"*\" can be used\n\t * 3) selection will start with transport dataType and THEN go to \"*\" if needed\n\t */\n\ttransports = {},\n\n\t// Avoid comment-prolog char sequence (#10098); must appease lint and evade compression\n\tallTypes = \"*/\".concat(\"*\");\n\n// #8138, IE may throw an exception when accessing\n// a field from window.location if document.domain has been set\ntry {\n\tajaxLocation = location.href;\n} catch( e ) {\n\t// Use the href attribute of an A element\n\t// since IE will modify it given document.location\n\tajaxLocation = document.createElement( \"a\" );\n\tajaxLocation.href = \"\";\n\tajaxLocation = ajaxLocation.href;\n}\n\n// Segment location into parts\najaxLocParts = rurl.exec( ajaxLocation.toLowerCase() ) || [];\n\n// Base \"constructor\" for jQuery.ajaxPrefilter and jQuery.ajaxTransport\nfunction addToPrefiltersOrTransports( structure ) {\n\n\t// dataTypeExpression is optional and defaults to \"*\"\n\treturn function( dataTypeExpression, func ) {\n\n\t\tif ( typeof dataTypeExpression !== \"string\" ) {\n\t\t\tfunc = dataTypeExpression;\n\t\t\tdataTypeExpression = \"*\";\n\t\t}\n\n\t\tvar dataType,\n\t\t\ti = 0,\n\t\t\tdataTypes = dataTypeExpression.toLowerCase().match( rnotwhite ) || [];\n\n\t\tif ( jQuery.isFunction( func ) ) {\n\t\t\t// For each dataType in the dataTypeExpression\n\t\t\twhile ( (dataType = dataTypes[i++]) ) {\n\t\t\t\t// Prepend if requested\n\t\t\t\tif ( dataType[0] === \"+\" ) {\n\t\t\t\t\tdataType = dataType.slice( 1 ) || \"*\";\n\t\t\t\t\t(structure[ dataType ] = structure[ dataType ] || []).unshift( func );\n\n\t\t\t\t// Otherwise append\n\t\t\t\t} else {\n\t\t\t\t\t(structure[ dataType ] = structure[ dataType ] || []).push( func );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n\n// Base inspection function for prefilters and transports\nfunction inspectPrefiltersOrTransports( structure, options, originalOptions, jqXHR ) {\n\n\tvar inspected = {},\n\t\tseekingTransport = ( structure === transports );\n\n\tfunction inspect( dataType ) {\n\t\tvar selected;\n\t\tinspected[ dataType ] = true;\n\t\tjQuery.each( structure[ dataType ] || [], function( _, prefilterOrFactory ) {\n\t\t\tvar dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );\n\t\t\tif ( typeof dataTypeOrTransport === \"string\" && !seekingTransport && !inspected[ dataTypeOrTransport ] ) {\n\t\t\t\toptions.dataTypes.unshift( dataTypeOrTransport );\n\t\t\t\tinspect( dataTypeOrTransport );\n\t\t\t\treturn false;\n\t\t\t} else if ( seekingTransport ) {\n\t\t\t\treturn !( selected = dataTypeOrTransport );\n\t\t\t}\n\t\t});\n\t\treturn selected;\n\t}\n\n\treturn inspect( options.dataTypes[ 0 ] ) || !inspected[ \"*\" ] && inspect( \"*\" );\n}\n\n// A special extend for ajax options\n// that takes \"flat\" options (not to be deep extended)\n// Fixes #9887\nfunction ajaxExtend( target, src ) {\n\tvar key, deep,\n\t\tflatOptions = jQuery.ajaxSettings.flatOptions || {};\n\n\tfor ( key in src ) {\n\t\tif ( src[ key ] !== undefined ) {\n\t\t\t( flatOptions[ key ] ? target : ( deep || (deep = {}) ) )[ key ] = src[ key ];\n\t\t}\n\t}\n\tif ( deep ) {\n\t\tjQuery.extend( true, target, deep );\n\t}\n\n\treturn target;\n}\n\n/* Handles responses to an ajax request:\n * - finds the right dataType (mediates between content-type and expected dataType)\n * - returns the corresponding response\n */\nfunction ajaxHandleResponses( s, jqXHR, responses ) {\n\n\tvar ct, type, finalDataType, firstDataType,\n\t\tcontents = s.contents,\n\t\tdataTypes = s.dataTypes;\n\n\t// Remove auto dataType and get content-type in the process\n\twhile ( dataTypes[ 0 ] === \"*\" ) {\n\t\tdataTypes.shift();\n\t\tif ( ct === undefined ) {\n\t\t\tct = s.mimeType || jqXHR.getResponseHeader(\"Content-Type\");\n\t\t}\n\t}\n\n\t// Check if we're dealing with a known content-type\n\tif ( ct ) {\n\t\tfor ( type in contents ) {\n\t\t\tif ( contents[ type ] && contents[ type ].test( ct ) ) {\n\t\t\t\tdataTypes.unshift( type );\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check to see if we have a response for the expected dataType\n\tif ( dataTypes[ 0 ] in responses ) {\n\t\tfinalDataType = dataTypes[ 0 ];\n\t} else {\n\t\t// Try convertible dataTypes\n\t\tfor ( type in responses ) {\n\t\t\tif ( !dataTypes[ 0 ] || s.converters[ type + \" \" + dataTypes[0] ] ) {\n\t\t\t\tfinalDataType = type;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif ( !firstDataType ) {\n\t\t\t\tfirstDataType = type;\n\t\t\t}\n\t\t}\n\t\t// Or just use first one\n\t\tfinalDataType = finalDataType || firstDataType;\n\t}\n\n\t// If we found a dataType\n\t// We add the dataType to the list if needed\n\t// and return the corresponding response\n\tif ( finalDataType ) {\n\t\tif ( finalDataType !== dataTypes[ 0 ] ) {\n\t\t\tdataTypes.unshift( finalDataType );\n\t\t}\n\t\treturn responses[ finalDataType ];\n\t}\n}\n\n/* Chain conversions given the request and the original response\n * Also sets the responseXXX fields on the jqXHR instance\n */\nfunction ajaxConvert( s, response, jqXHR, isSuccess ) {\n\tvar conv2, current, conv, tmp, prev,\n\t\tconverters = {},\n\t\t// Work with a copy of dataTypes in case we need to modify it for conversion\n\t\tdataTypes = s.dataTypes.slice();\n\n\t// Create converters map with lowercased keys\n\tif ( dataTypes[ 1 ] ) {\n\t\tfor ( conv in s.converters ) {\n\t\t\tconverters[ conv.toLowerCase() ] = s.converters[ conv ];\n\t\t}\n\t}\n\n\tcurrent = dataTypes.shift();\n\n\t// Convert to each sequential dataType\n\twhile ( current ) {\n\n\t\tif ( s.responseFields[ current ] ) {\n\t\t\tjqXHR[ s.responseFields[ current ] ] = response;\n\t\t}\n\n\t\t// Apply the dataFilter if provided\n\t\tif ( !prev && isSuccess && s.dataFilter ) {\n\t\t\tresponse = s.dataFilter( response, s.dataType );\n\t\t}\n\n\t\tprev = current;\n\t\tcurrent = dataTypes.shift();\n\n\t\tif ( current ) {\n\n\t\t// There's only work to do if current dataType is non-auto\n\t\t\tif ( current === \"*\" ) {\n\n\t\t\t\tcurrent = prev;\n\n\t\t\t// Convert response if prev dataType is non-auto and differs from current\n\t\t\t} else if ( prev !== \"*\" && prev !== current ) {\n\n\t\t\t\t// Seek a direct converter\n\t\t\t\tconv = converters[ prev + \" \" + current ] || converters[ \"* \" + current ];\n\n\t\t\t\t// If none found, seek a pair\n\t\t\t\tif ( !conv ) {\n\t\t\t\t\tfor ( conv2 in converters ) {\n\n\t\t\t\t\t\t// If conv2 outputs current\n\t\t\t\t\t\ttmp = conv2.split( \" \" );\n\t\t\t\t\t\tif ( tmp[ 1 ] === current ) {\n\n\t\t\t\t\t\t\t// If prev can be converted to accepted input\n\t\t\t\t\t\t\tconv = converters[ prev + \" \" + tmp[ 0 ] ] ||\n\t\t\t\t\t\t\t\tconverters[ \"* \" + tmp[ 0 ] ];\n\t\t\t\t\t\t\tif ( conv ) {\n\t\t\t\t\t\t\t\t// Condense equivalence converters\n\t\t\t\t\t\t\t\tif ( conv === true ) {\n\t\t\t\t\t\t\t\t\tconv = converters[ conv2 ];\n\n\t\t\t\t\t\t\t\t// Otherwise, insert the intermediate dataType\n\t\t\t\t\t\t\t\t} else if ( converters[ conv2 ] !== true ) {\n\t\t\t\t\t\t\t\t\tcurrent = tmp[ 0 ];\n\t\t\t\t\t\t\t\t\tdataTypes.unshift( tmp[ 1 ] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Apply converter (if not an equivalence)\n\t\t\t\tif ( conv !== true ) {\n\n\t\t\t\t\t// Unless errors are allowed to bubble, catch and return them\n\t\t\t\t\tif ( conv && s[ \"throws\" ] ) {\n\t\t\t\t\t\tresponse = conv( response );\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresponse = conv( response );\n\t\t\t\t\t\t} catch ( e ) {\n\t\t\t\t\t\t\treturn { state: \"parsererror\", error: conv ? e : \"No conversion from \" + prev + \" to \" + current };\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn { state: \"success\", data: response };\n}\n\njQuery.extend({\n\n\t// Counter for holding the number of active queries\n\tactive: 0,\n\n\t// Last-Modified header cache for next request\n\tlastModified: {},\n\tetag: {},\n\n\tajaxSettings: {\n\t\turl: ajaxLocation,\n\t\ttype: \"GET\",\n\t\tisLocal: rlocalProtocol.test( ajaxLocParts[ 1 ] ),\n\t\tglobal: true,\n\t\tprocessData: true,\n\t\tasync: true,\n\t\tcontentType: \"application/x-www-form-urlencoded; charset=UTF-8\",\n\t\t/*\n\t\ttimeout: 0,\n\t\tdata: null,\n\t\tdataType: null,\n\t\tusername: null,\n\t\tpassword: null,\n\t\tcache: null,\n\t\tthrows: false,\n\t\ttraditional: false,\n\t\theaders: {},\n\t\t*/\n\n\t\taccepts: {\n\t\t\t\"*\": allTypes,\n\t\t\ttext: \"text/plain\",\n\t\t\thtml: \"text/html\",\n\t\t\txml: \"application/xml, text/xml\",\n\t\t\tjson: \"application/json, text/javascript\"\n\t\t},\n\n\t\tcontents: {\n\t\t\txml: /xml/,\n\t\t\thtml: /html/,\n\t\t\tjson: /json/\n\t\t},\n\n\t\tresponseFields: {\n\t\t\txml: \"responseXML\",\n\t\t\ttext: \"responseText\",\n\t\t\tjson: \"responseJSON\"\n\t\t},\n\n\t\t// Data converters\n\t\t// Keys separate source (or catchall \"*\") and destination types with a single space\n\t\tconverters: {\n\n\t\t\t// Convert anything to text\n\t\t\t\"* text\": String,\n\n\t\t\t// Text to html (true = no transformation)\n\t\t\t\"text html\": true,\n\n\t\t\t// Evaluate text as a json expression\n\t\t\t\"text json\": jQuery.parseJSON,\n\n\t\t\t// Parse text as xml\n\t\t\t\"text xml\": jQuery.parseXML\n\t\t},\n\n\t\t// For options that shouldn't be deep extended:\n\t\t// you can add your own custom options here if\n\t\t// and when you create one that shouldn't be\n\t\t// deep extended (see ajaxExtend)\n\t\tflatOptions: {\n\t\t\turl: true,\n\t\t\tcontext: true\n\t\t}\n\t},\n\n\t// Creates a full fledged settings object into target\n\t// with both ajaxSettings and settings fields.\n\t// If target is omitted, writes into ajaxSettings.\n\tajaxSetup: function( target, settings ) {\n\t\treturn settings ?\n\n\t\t\t// Building a settings object\n\t\t\tajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings ) :\n\n\t\t\t// Extending ajaxSettings\n\t\t\tajaxExtend( jQuery.ajaxSettings, target );\n\t},\n\n\tajaxPrefilter: addToPrefiltersOrTransports( prefilters ),\n\tajaxTransport: addToPrefiltersOrTransports( transports ),\n\n\t// Main method\n\tajax: function( url, options ) {\n\n\t\t// If url is an object, simulate pre-1.5 signature\n\t\tif ( typeof url === \"object\" ) {\n\t\t\toptions = url;\n\t\t\turl = undefined;\n\t\t}\n\n\t\t// Force options to be an object\n\t\toptions = options || {};\n\n\t\tvar transport,\n\t\t\t// URL without anti-cache param\n\t\t\tcacheURL,\n\t\t\t// Response headers\n\t\t\tresponseHeadersString,\n\t\t\tresponseHeaders,\n\t\t\t// timeout handle\n\t\t\ttimeoutTimer,\n\t\t\t// Cross-domain detection vars\n\t\t\tparts,\n\t\t\t// To know if global events are to be dispatched\n\t\t\tfireGlobals,\n\t\t\t// Loop variable\n\t\t\ti,\n\t\t\t// Create the final options object\n\t\t\ts = jQuery.ajaxSetup( {}, options ),\n\t\t\t// Callbacks context\n\t\t\tcallbackContext = s.context || s,\n\t\t\t// Context for global events is callbackContext if it is a DOM node or jQuery collection\n\t\t\tglobalEventContext = s.context && ( callbackContext.nodeType || callbackContext.jquery ) ?\n\t\t\t\tjQuery( callbackContext ) :\n\t\t\t\tjQuery.event,\n\t\t\t// Deferreds\n\t\t\tdeferred = jQuery.Deferred(),\n\t\t\tcompleteDeferred = jQuery.Callbacks(\"once memory\"),\n\t\t\t// Status-dependent callbacks\n\t\t\tstatusCode = s.statusCode || {},\n\t\t\t// Headers (they are sent all at once)\n\t\t\trequestHeaders = {},\n\t\t\trequestHeadersNames = {},\n\t\t\t// The jqXHR state\n\t\t\tstate = 0,\n\t\t\t// Default abort message\n\t\t\tstrAbort = \"canceled\",\n\t\t\t// Fake xhr\n\t\t\tjqXHR = {\n\t\t\t\treadyState: 0,\n\n\t\t\t\t// Builds headers hashtable if needed\n\t\t\t\tgetResponseHeader: function( key ) {\n\t\t\t\t\tvar match;\n\t\t\t\t\tif ( state === 2 ) {\n\t\t\t\t\t\tif ( !responseHeaders ) {\n\t\t\t\t\t\t\tresponseHeaders = {};\n\t\t\t\t\t\t\twhile ( (match = rheaders.exec( responseHeadersString )) ) {\n\t\t\t\t\t\t\t\tresponseHeaders[ match[1].toLowerCase() ] = match[ 2 ];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmatch = responseHeaders[ key.toLowerCase() ];\n\t\t\t\t\t}\n\t\t\t\t\treturn match == null ? null : match;\n\t\t\t\t},\n\n\t\t\t\t// Raw string\n\t\t\t\tgetAllResponseHeaders: function() {\n\t\t\t\t\treturn state === 2 ? responseHeadersString : null;\n\t\t\t\t},\n\n\t\t\t\t// Caches the header\n\t\t\t\tsetRequestHeader: function( name, value ) {\n\t\t\t\t\tvar lname = name.toLowerCase();\n\t\t\t\t\tif ( !state ) {\n\t\t\t\t\t\tname = requestHeadersNames[ lname ] = requestHeadersNames[ lname ] || name;\n\t\t\t\t\t\trequestHeaders[ name ] = value;\n\t\t\t\t\t}\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\n\t\t\t\t// Overrides response content-type header\n\t\t\t\toverrideMimeType: function( type ) {\n\t\t\t\t\tif ( !state ) {\n\t\t\t\t\t\ts.mimeType = type;\n\t\t\t\t\t}\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\n\t\t\t\t// Status-dependent callbacks\n\t\t\t\tstatusCode: function( map ) {\n\t\t\t\t\tvar code;\n\t\t\t\t\tif ( map ) {\n\t\t\t\t\t\tif ( state < 2 ) {\n\t\t\t\t\t\t\tfor ( code in map ) {\n\t\t\t\t\t\t\t\t// Lazy-add the new callback in a way that preserves old ones\n\t\t\t\t\t\t\t\tstatusCode[ code ] = [ statusCode[ code ], map[ code ] ];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Execute the appropriate callbacks\n\t\t\t\t\t\t\tjqXHR.always( map[ jqXHR.status ] );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\n\t\t\t\t// Cancel the request\n\t\t\t\tabort: function( statusText ) {\n\t\t\t\t\tvar finalText = statusText || strAbort;\n\t\t\t\t\tif ( transport ) {\n\t\t\t\t\t\ttransport.abort( finalText );\n\t\t\t\t\t}\n\t\t\t\t\tdone( 0, finalText );\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\t\t\t};\n\n\t\t// Attach deferreds\n\t\tdeferred.promise( jqXHR ).complete = completeDeferred.add;\n\t\tjqXHR.success = jqXHR.done;\n\t\tjqXHR.error = jqXHR.fail;\n\n\t\t// Remove hash character (#7531: and string promotion)\n\t\t// Add protocol if not provided (prefilters might expect it)\n\t\t// Handle falsy url in the settings object (#10093: consistency with old signature)\n\t\t// We also use the url parameter if available\n\t\ts.url = ( ( url || s.url || ajaxLocation ) + \"\" ).replace( rhash, \"\" )\n\t\t\t.replace( rprotocol, ajaxLocParts[ 1 ] + \"//\" );\n\n\t\t// Alias method option to type as per ticket #12004\n\t\ts.type = options.method || options.type || s.method || s.type;\n\n\t\t// Extract dataTypes list\n\t\ts.dataTypes = jQuery.trim( s.dataType || \"*\" ).toLowerCase().match( rnotwhite ) || [ \"\" ];\n\n\t\t// A cross-domain request is in order when we have a protocol:host:port mismatch\n\t\tif ( s.crossDomain == null ) {\n\t\t\tparts = rurl.exec( s.url.toLowerCase() );\n\t\t\ts.crossDomain = !!( parts &&\n\t\t\t\t( parts[ 1 ] !== ajaxLocParts[ 1 ] || parts[ 2 ] !== ajaxLocParts[ 2 ] ||\n\t\t\t\t\t( parts[ 3 ] || ( parts[ 1 ] === \"http:\" ? \"80\" : \"443\" ) ) !==\n\t\t\t\t\t\t( ajaxLocParts[ 3 ] || ( ajaxLocParts[ 1 ] === \"http:\" ? \"80\" : \"443\" ) ) )\n\t\t\t);\n\t\t}\n\n\t\t// Convert data if not already a string\n\t\tif ( s.data && s.processData && typeof s.data !== \"string\" ) {\n\t\t\ts.data = jQuery.param( s.data, s.traditional );\n\t\t}\n\n\t\t// Apply prefilters\n\t\tinspectPrefiltersOrTransports( prefilters, s, options, jqXHR );\n\n\t\t// If request was aborted inside a prefilter, stop there\n\t\tif ( state === 2 ) {\n\t\t\treturn jqXHR;\n\t\t}\n\n\t\t// We can fire global events as of now if asked to\n\t\tfireGlobals = s.global;\n\n\t\t// Watch for a new set of requests\n\t\tif ( fireGlobals && jQuery.active++ === 0 ) {\n\t\t\tjQuery.event.trigger(\"ajaxStart\");\n\t\t}\n\n\t\t// Uppercase the type\n\t\ts.type = s.type.toUpperCase();\n\n\t\t// Determine if request has content\n\t\ts.hasContent = !rnoContent.test( s.type );\n\n\t\t// Save the URL in case we're toying with the If-Modified-Since\n\t\t// and/or If-None-Match header later on\n\t\tcacheURL = s.url;\n\n\t\t// More options handling for requests with no content\n\t\tif ( !s.hasContent ) {\n\n\t\t\t// If data is available, append data to url\n\t\t\tif ( s.data ) {\n\t\t\t\tcacheURL = ( s.url += ( rquery.test( cacheURL ) ? \"&\" : \"?\" ) + s.data );\n\t\t\t\t// #9682: remove data so that it's not used in an eventual retry\n\t\t\t\tdelete s.data;\n\t\t\t}\n\n\t\t\t// Add anti-cache in url if needed\n\t\t\tif ( s.cache === false ) {\n\t\t\t\ts.url = rts.test( cacheURL ) ?\n\n\t\t\t\t\t// If there is already a '_' parameter, set its value\n\t\t\t\t\tcacheURL.replace( rts, \"$1_=\" + nonce++ ) :\n\n\t\t\t\t\t// Otherwise add one to the end\n\t\t\t\t\tcacheURL + ( rquery.test( cacheURL ) ? \"&\" : \"?\" ) + \"_=\" + nonce++;\n\t\t\t}\n\t\t}\n\n\t\t// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.\n\t\tif ( s.ifModified ) {\n\t\t\tif ( jQuery.lastModified[ cacheURL ] ) {\n\t\t\t\tjqXHR.setRequestHeader( \"If-Modified-Since\", jQuery.lastModified[ cacheURL ] );\n\t\t\t}\n\t\t\tif ( jQuery.etag[ cacheURL ] ) {\n\t\t\t\tjqXHR.setRequestHeader( \"If-None-Match\", jQuery.etag[ cacheURL ] );\n\t\t\t}\n\t\t}\n\n\t\t// Set the correct header, if data is being sent\n\t\tif ( s.data && s.hasContent && s.contentType !== false || options.contentType ) {\n\t\t\tjqXHR.setRequestHeader( \"Content-Type\", s.contentType );\n\t\t}\n\n\t\t// Set the Accepts header for the server, depending on the dataType\n\t\tjqXHR.setRequestHeader(\n\t\t\t\"Accept\",\n\t\t\ts.dataTypes[ 0 ] && s.accepts[ s.dataTypes[0] ] ?\n\t\t\t\ts.accepts[ s.dataTypes[0] ] + ( s.dataTypes[ 0 ] !== \"*\" ? \", \" + allTypes + \"; q=0.01\" : \"\" ) :\n\t\t\t\ts.accepts[ \"*\" ]\n\t\t);\n\n\t\t// Check for headers option\n\t\tfor ( i in s.headers ) {\n\t\t\tjqXHR.setRequestHeader( i, s.headers[ i ] );\n\t\t}\n\n\t\t// Allow custom headers/mimetypes and early abort\n\t\tif ( s.beforeSend && ( s.beforeSend.call( callbackContext, jqXHR, s ) === false || state === 2 ) ) {\n\t\t\t// Abort if not done already and return\n\t\t\treturn jqXHR.abort();\n\t\t}\n\n\t\t// aborting is no longer a cancellation\n\t\tstrAbort = \"abort\";\n\n\t\t// Install callbacks on deferreds\n\t\tfor ( i in { success: 1, error: 1, complete: 1 } ) {\n\t\t\tjqXHR[ i ]( s[ i ] );\n\t\t}\n\n\t\t// Get transport\n\t\ttransport = inspectPrefiltersOrTransports( transports, s, options, jqXHR );\n\n\t\t// If no transport, we auto-abort\n\t\tif ( !transport ) {\n\t\t\tdone( -1, \"No Transport\" );\n\t\t} else {\n\t\t\tjqXHR.readyState = 1;\n\n\t\t\t// Send global event\n\t\t\tif ( fireGlobals ) {\n\t\t\t\tglobalEventContext.trigger( \"ajaxSend\", [ jqXHR, s ] );\n\t\t\t}\n\t\t\t// Timeout\n\t\t\tif ( s.async && s.timeout > 0 ) {\n\t\t\t\ttimeoutTimer = setTimeout(function() {\n\t\t\t\t\tjqXHR.abort(\"timeout\");\n\t\t\t\t}, s.timeout );\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tstate = 1;\n\t\t\t\ttransport.send( requestHeaders, done );\n\t\t\t} catch ( e ) {\n\t\t\t\t// Propagate exception as error if not done\n\t\t\t\tif ( state < 2 ) {\n\t\t\t\t\tdone( -1, e );\n\t\t\t\t// Simply rethrow otherwise\n\t\t\t\t} else {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Callback for when everything is done\n\t\tfunction done( status, nativeStatusText, responses, headers ) {\n\t\t\tvar isSuccess, success, error, response, modified,\n\t\t\t\tstatusText = nativeStatusText;\n\n\t\t\t// Called once\n\t\t\tif ( state === 2 ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// State is \"done\" now\n\t\t\tstate = 2;\n\n\t\t\t// Clear timeout if it exists\n\t\t\tif ( timeoutTimer ) {\n\t\t\t\tclearTimeout( timeoutTimer );\n\t\t\t}\n\n\t\t\t// Dereference transport for early garbage collection\n\t\t\t// (no matter how long the jqXHR object will be used)\n\t\t\ttransport = undefined;\n\n\t\t\t// Cache response headers\n\t\t\tresponseHeadersString = headers || \"\";\n\n\t\t\t// Set readyState\n\t\t\tjqXHR.readyState = status > 0 ? 4 : 0;\n\n\t\t\t// Determine if successful\n\t\t\tisSuccess = status >= 200 && status < 300 || status === 304;\n\n\t\t\t// Get response data\n\t\t\tif ( responses ) {\n\t\t\t\tresponse = ajaxHandleResponses( s, jqXHR, responses );\n\t\t\t}\n\n\t\t\t// Convert no matter what (that way responseXXX fields are always set)\n\t\t\tresponse = ajaxConvert( s, response, jqXHR, isSuccess );\n\n\t\t\t// If successful, handle type chaining\n\t\t\tif ( isSuccess ) {\n\n\t\t\t\t// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.\n\t\t\t\tif ( s.ifModified ) {\n\t\t\t\t\tmodified = jqXHR.getResponseHeader(\"Last-Modified\");\n\t\t\t\t\tif ( modified ) {\n\t\t\t\t\t\tjQuery.lastModified[ cacheURL ] = modified;\n\t\t\t\t\t}\n\t\t\t\t\tmodified = jqXHR.getResponseHeader(\"etag\");\n\t\t\t\t\tif ( modified ) {\n\t\t\t\t\t\tjQuery.etag[ cacheURL ] = modified;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// if no content\n\t\t\t\tif ( status === 204 || s.type === \"HEAD\" ) {\n\t\t\t\t\tstatusText = \"nocontent\";\n\n\t\t\t\t// if not modified\n\t\t\t\t} else if ( status === 304 ) {\n\t\t\t\t\tstatusText = \"notmodified\";\n\n\t\t\t\t// If we have data, let's convert it\n\t\t\t\t} else {\n\t\t\t\t\tstatusText = response.state;\n\t\t\t\t\tsuccess = response.data;\n\t\t\t\t\terror = response.error;\n\t\t\t\t\tisSuccess = !error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// We extract error from statusText\n\t\t\t\t// then normalize statusText and status for non-aborts\n\t\t\t\terror = statusText;\n\t\t\t\tif ( status || !statusText ) {\n\t\t\t\t\tstatusText = \"error\";\n\t\t\t\t\tif ( status < 0 ) {\n\t\t\t\t\t\tstatus = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Set data for the fake xhr object\n\t\t\tjqXHR.status = status;\n\t\t\tjqXHR.statusText = ( nativeStatusText || statusText ) + \"\";\n\n\t\t\t// Success/Error\n\t\t\tif ( isSuccess ) {\n\t\t\t\tdeferred.resolveWith( callbackContext, [ success, statusText, jqXHR ] );\n\t\t\t} else {\n\t\t\t\tdeferred.rejectWith( callbackContext, [ jqXHR, statusText, error ] );\n\t\t\t}\n\n\t\t\t// Status-dependent callbacks\n\t\t\tjqXHR.statusCode( statusCode );\n\t\t\tstatusCode = undefined;\n\n\t\t\tif ( fireGlobals ) {\n\t\t\t\tglobalEventContext.trigger( isSuccess ? \"ajaxSuccess\" : \"ajaxError\",\n\t\t\t\t\t[ jqXHR, s, isSuccess ? success : error ] );\n\t\t\t}\n\n\t\t\t// Complete\n\t\t\tcompleteDeferred.fireWith( callbackContext, [ jqXHR, statusText ] );\n\n\t\t\tif ( fireGlobals ) {\n\t\t\t\tglobalEventContext.trigger( \"ajaxComplete\", [ jqXHR, s ] );\n\t\t\t\t// Handle the global AJAX counter\n\t\t\t\tif ( !( --jQuery.active ) ) {\n\t\t\t\t\tjQuery.event.trigger(\"ajaxStop\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn jqXHR;\n\t},\n\n\tgetJSON: function( url, data, callback ) {\n\t\treturn jQuery.get( url, data, callback, \"json\" );\n\t},\n\n\tgetScript: function( url, callback ) {\n\t\treturn jQuery.get( url, undefined, callback, \"script\" );\n\t}\n});\n\njQuery.each( [ \"get\", \"post\" ], function( i, method ) {\n\tjQuery[ method ] = function( url, data, callback, type ) {\n\t\t// shift arguments if data argument was omitted\n\t\tif ( jQuery.isFunction( data ) ) {\n\t\t\ttype = type || callback;\n\t\t\tcallback = data;\n\t\t\tdata = undefined;\n\t\t}\n\n\t\treturn jQuery.ajax({\n\t\t\turl: url,\n\t\t\ttype: method,\n\t\t\tdataType: type,\n\t\t\tdata: data,\n\t\t\tsuccess: callback\n\t\t});\n\t};\n});\n\n// Attach a bunch of functions for handling common AJAX events\njQuery.each( [ \"ajaxStart\", \"ajaxStop\", \"ajaxComplete\", \"ajaxError\", \"ajaxSuccess\", \"ajaxSend\" ], function( i, type ) {\n\tjQuery.fn[ type ] = function( fn ) {\n\t\treturn this.on( type, fn );\n\t};\n});\n\n\njQuery._evalUrl = function( url ) {\n\treturn jQuery.ajax({\n\t\turl: url,\n\t\ttype: \"GET\",\n\t\tdataType: \"script\",\n\t\tasync: false,\n\t\tglobal: false,\n\t\t\"throws\": true\n\t});\n};\n\n\njQuery.fn.extend({\n\twrapAll: function( html ) {\n\t\tvar wrap;\n\n\t\tif ( jQuery.isFunction( html ) ) {\n\t\t\treturn this.each(function( i ) {\n\t\t\t\tjQuery( this ).wrapAll( html.call(this, i) );\n\t\t\t});\n\t\t}\n\n\t\tif ( this[ 0 ] ) {\n\n\t\t\t// The elements to wrap the target around\n\t\t\twrap = jQuery( html, this[ 0 ].ownerDocument ).eq( 0 ).clone( true );\n\n\t\t\tif ( this[ 0 ].parentNode ) {\n\t\t\t\twrap.insertBefore( this[ 0 ] );\n\t\t\t}\n\n\t\t\twrap.map(function() {\n\t\t\t\tvar elem = this;\n\n\t\t\t\twhile ( elem.firstElementChild ) {\n\t\t\t\t\telem = elem.firstElementChild;\n\t\t\t\t}\n\n\t\t\t\treturn elem;\n\t\t\t}).append( this );\n\t\t}\n\n\t\treturn this;\n\t},\n\n\twrapInner: function( html ) {\n\t\tif ( jQuery.isFunction( html ) ) {\n\t\t\treturn this.each(function( i ) {\n\t\t\t\tjQuery( this ).wrapInner( html.call(this, i) );\n\t\t\t});\n\t\t}\n\n\t\treturn this.each(function() {\n\t\t\tvar self = jQuery( this ),\n\t\t\t\tcontents = self.contents();\n\n\t\t\tif ( contents.length ) {\n\t\t\t\tcontents.wrapAll( html );\n\n\t\t\t} else {\n\t\t\t\tself.append( html );\n\t\t\t}\n\t\t});\n\t},\n\n\twrap: function( html ) {\n\t\tvar isFunction = jQuery.isFunction( html );\n\n\t\treturn this.each(function( i ) {\n\t\t\tjQuery( this ).wrapAll( isFunction ? html.call(this, i) : html );\n\t\t});\n\t},\n\n\tunwrap: function() {\n\t\treturn this.parent().each(function() {\n\t\t\tif ( !jQuery.nodeName( this, \"body\" ) ) {\n\t\t\t\tjQuery( this ).replaceWith( this.childNodes );\n\t\t\t}\n\t\t}).end();\n\t}\n});\n\n\njQuery.expr.filters.hidden = function( elem ) {\n\t// Support: Opera <= 12.12\n\t// Opera reports offsetWidths and offsetHeights less than zero on some elements\n\treturn elem.offsetWidth <= 0 && elem.offsetHeight <= 0;\n};\njQuery.expr.filters.visible = function( elem ) {\n\treturn !jQuery.expr.filters.hidden( elem );\n};\n\n\n\n\nvar r20 = /%20/g,\n\trbracket = /\\[\\]$/,\n\trCRLF = /\\r?\\n/g,\n\trsubmitterTypes = /^(?:submit|button|image|reset|file)$/i,\n\trsubmittable = /^(?:input|select|textarea|keygen)/i;\n\nfunction buildParams( prefix, obj, traditional, add ) {\n\tvar name;\n\n\tif ( jQuery.isArray( obj ) ) {\n\t\t// Serialize array item.\n\t\tjQuery.each( obj, function( i, v ) {\n\t\t\tif ( traditional || rbracket.test( prefix ) ) {\n\t\t\t\t// Treat each array item as a scalar.\n\t\t\t\tadd( prefix, v );\n\n\t\t\t} else {\n\t\t\t\t// Item is non-scalar (array or object), encode its numeric index.\n\t\t\t\tbuildParams( prefix + \"[\" + ( typeof v === \"object\" ? i : \"\" ) + \"]\", v, traditional, add );\n\t\t\t}\n\t\t});\n\n\t} else if ( !traditional && jQuery.type( obj ) === \"object\" ) {\n\t\t// Serialize object item.\n\t\tfor ( name in obj ) {\n\t\t\tbuildParams( prefix + \"[\" + name + \"]\", obj[ name ], traditional, add );\n\t\t}\n\n\t} else {\n\t\t// Serialize scalar item.\n\t\tadd( prefix, obj );\n\t}\n}\n\n// Serialize an array of form elements or a set of\n// key/values into a query string\njQuery.param = function( a, traditional ) {\n\tvar prefix,\n\t\ts = [],\n\t\tadd = function( key, value ) {\n\t\t\t// If value is a function, invoke it and return its value\n\t\t\tvalue = jQuery.isFunction( value ) ? value() : ( value == null ? \"\" : value );\n\t\t\ts[ s.length ] = encodeURIComponent( key ) + \"=\" + encodeURIComponent( value );\n\t\t};\n\n\t// Set traditional to true for jQuery <= 1.3.2 behavior.\n\tif ( traditional === undefined ) {\n\t\ttraditional = jQuery.ajaxSettings && jQuery.ajaxSettings.traditional;\n\t}\n\n\t// If an array was passed in, assume that it is an array of form elements.\n\tif ( jQuery.isArray( a ) || ( a.jquery && !jQuery.isPlainObject( a ) ) ) {\n\t\t// Serialize the form elements\n\t\tjQuery.each( a, function() {\n\t\t\tadd( this.name, this.value );\n\t\t});\n\n\t} else {\n\t\t// If traditional, encode the \"old\" way (the way 1.3.2 or older\n\t\t// did it), otherwise encode params recursively.\n\t\tfor ( prefix in a ) {\n\t\t\tbuildParams( prefix, a[ prefix ], traditional, add );\n\t\t}\n\t}\n\n\t// Return the resulting serialization\n\treturn s.join( \"&\" ).replace( r20, \"+\" );\n};\n\njQuery.fn.extend({\n\tserialize: function() {\n\t\treturn jQuery.param( this.serializeArray() );\n\t},\n\tserializeArray: function() {\n\t\treturn this.map(function() {\n\t\t\t// Can add propHook for \"elements\" to filter or add form elements\n\t\t\tvar elements = jQuery.prop( this, \"elements\" );\n\t\t\treturn elements ? jQuery.makeArray( elements ) : this;\n\t\t})\n\t\t.filter(function() {\n\t\t\tvar type = this.type;\n\n\t\t\t// Use .is( \":disabled\" ) so that fieldset[disabled] works\n\t\t\treturn this.name && !jQuery( this ).is( \":disabled\" ) &&\n\t\t\t\trsubmittable.test( this.nodeName ) && !rsubmitterTypes.test( type ) &&\n\t\t\t\t( this.checked || !rcheckableType.test( type ) );\n\t\t})\n\t\t.map(function( i, elem ) {\n\t\t\tvar val = jQuery( this ).val();\n\n\t\t\treturn val == null ?\n\t\t\t\tnull :\n\t\t\t\tjQuery.isArray( val ) ?\n\t\t\t\t\tjQuery.map( val, function( val ) {\n\t\t\t\t\t\treturn { name: elem.name, value: val.replace( rCRLF, \"\\r\\n\" ) };\n\t\t\t\t\t}) :\n\t\t\t\t\t{ name: elem.name, value: val.replace( rCRLF, \"\\r\\n\" ) };\n\t\t}).get();\n\t}\n});\n\n\njQuery.ajaxSettings.xhr = function() {\n\ttry {\n\t\treturn new XMLHttpRequest();\n\t} catch( e ) {}\n};\n\nvar xhrId = 0,\n\txhrCallbacks = {},\n\txhrSuccessStatus = {\n\t\t// file protocol always yields status code 0, assume 200\n\t\t0: 200,\n\t\t// Support: IE9\n\t\t// #1450: sometimes IE returns 1223 when it should be 204\n\t\t1223: 204\n\t},\n\txhrSupported = jQuery.ajaxSettings.xhr();\n\n// Support: IE9\n// Open requests must be manually aborted on unload (#5280)\nif ( window.ActiveXObject ) {\n\tjQuery( window ).on( \"unload\", function() {\n\t\tfor ( var key in xhrCallbacks ) {\n\t\t\txhrCallbacks[ key ]();\n\t\t}\n\t});\n}\n\nsupport.cors = !!xhrSupported && ( \"withCredentials\" in xhrSupported );\nsupport.ajax = xhrSupported = !!xhrSupported;\n\njQuery.ajaxTransport(function( options ) {\n\tvar callback;\n\n\t// Cross domain only allowed if supported through XMLHttpRequest\n\tif ( support.cors || xhrSupported && !options.crossDomain ) {\n\t\treturn {\n\t\t\tsend: function( headers, complete ) {\n\t\t\t\tvar i,\n\t\t\t\t\txhr = options.xhr(),\n\t\t\t\t\tid = ++xhrId;\n\n\t\t\t\txhr.open( options.type, options.url, options.async, options.username, options.password );\n\n\t\t\t\t// Apply custom fields if provided\n\t\t\t\tif ( options.xhrFields ) {\n\t\t\t\t\tfor ( i in options.xhrFields ) {\n\t\t\t\t\t\txhr[ i ] = options.xhrFields[ i ];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Override mime type if needed\n\t\t\t\tif ( options.mimeType && xhr.overrideMimeType ) {\n\t\t\t\t\txhr.overrideMimeType( options.mimeType );\n\t\t\t\t}\n\n\t\t\t\t// X-Requested-With header\n\t\t\t\t// For cross-domain requests, seeing as conditions for a preflight are\n\t\t\t\t// akin to a jigsaw puzzle, we simply never set it to be sure.\n\t\t\t\t// (it can always be set on a per-request basis or even using ajaxSetup)\n\t\t\t\t// For same-domain requests, won't change header if already provided.\n\t\t\t\tif ( !options.crossDomain && !headers[\"X-Requested-With\"] ) {\n\t\t\t\t\theaders[\"X-Requested-With\"] = \"XMLHttpRequest\";\n\t\t\t\t}\n\n\t\t\t\t// Set headers\n\t\t\t\tfor ( i in headers ) {\n\t\t\t\t\txhr.setRequestHeader( i, headers[ i ] );\n\t\t\t\t}\n\n\t\t\t\t// Callback\n\t\t\t\tcallback = function( type ) {\n\t\t\t\t\treturn function() {\n\t\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\t\tdelete xhrCallbacks[ id ];\n\t\t\t\t\t\t\tcallback = xhr.onload = xhr.onerror = null;\n\n\t\t\t\t\t\t\tif ( type === \"abort\" ) {\n\t\t\t\t\t\t\t\txhr.abort();\n\t\t\t\t\t\t\t} else if ( type === \"error\" ) {\n\t\t\t\t\t\t\t\tcomplete(\n\t\t\t\t\t\t\t\t\t// file: protocol always yields status 0; see #8605, #14207\n\t\t\t\t\t\t\t\t\txhr.status,\n\t\t\t\t\t\t\t\t\txhr.statusText\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tcomplete(\n\t\t\t\t\t\t\t\t\txhrSuccessStatus[ xhr.status ] || xhr.status,\n\t\t\t\t\t\t\t\t\txhr.statusText,\n\t\t\t\t\t\t\t\t\t// Support: IE9\n\t\t\t\t\t\t\t\t\t// Accessing binary-data responseText throws an exception\n\t\t\t\t\t\t\t\t\t// (#11426)\n\t\t\t\t\t\t\t\t\ttypeof xhr.responseText === \"string\" ? {\n\t\t\t\t\t\t\t\t\t\ttext: xhr.responseText\n\t\t\t\t\t\t\t\t\t} : undefined,\n\t\t\t\t\t\t\t\t\txhr.getAllResponseHeaders()\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t};\n\n\t\t\t\t// Listen to events\n\t\t\t\txhr.onload = callback();\n\t\t\t\txhr.onerror = callback(\"error\");\n\n\t\t\t\t// Create the abort callback\n\t\t\t\tcallback = xhrCallbacks[ id ] = callback(\"abort\");\n\n\t\t\t\ttry {\n\t\t\t\t\t// Do send the request (this may raise an exception)\n\t\t\t\t\txhr.send( options.hasContent && options.data || null );\n\t\t\t\t} catch ( e ) {\n\t\t\t\t\t// #14683: Only rethrow if this hasn't been notified as an error yet\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tabort: function() {\n\t\t\t\tif ( callback ) {\n\t\t\t\t\tcallback();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n});\n\n\n\n\n// Install script dataType\njQuery.ajaxSetup({\n\taccepts: {\n\t\tscript: \"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript\"\n\t},\n\tcontents: {\n\t\tscript: /(?:java|ecma)script/\n\t},\n\tconverters: {\n\t\t\"text script\": function( text ) {\n\t\t\tjQuery.globalEval( text );\n\t\t\treturn text;\n\t\t}\n\t}\n});\n\n// Handle cache's special case and crossDomain\njQuery.ajaxPrefilter( \"script\", function( s ) {\n\tif ( s.cache === undefined ) {\n\t\ts.cache = false;\n\t}\n\tif ( s.crossDomain ) {\n\t\ts.type = \"GET\";\n\t}\n});\n\n// Bind script tag hack transport\njQuery.ajaxTransport( \"script\", function( s ) {\n\t// This transport only deals with cross domain requests\n\tif ( s.crossDomain ) {\n\t\tvar script, callback;\n\t\treturn {\n\t\t\tsend: function( _, complete ) {\n\t\t\t\tscript = jQuery(\"<script>\").prop({\n\t\t\t\t\tasync: true,\n\t\t\t\t\tcharset: s.scriptCharset,\n\t\t\t\t\tsrc: s.url\n\t\t\t\t}).on(\n\t\t\t\t\t\"load error\",\n\t\t\t\t\tcallback = function( evt ) {\n\t\t\t\t\t\tscript.remove();\n\t\t\t\t\t\tcallback = null;\n\t\t\t\t\t\tif ( evt ) {\n\t\t\t\t\t\t\tcomplete( evt.type === \"error\" ? 404 : 200, evt.type );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\tdocument.head.appendChild( script[ 0 ] );\n\t\t\t},\n\t\t\tabort: function() {\n\t\t\t\tif ( callback ) {\n\t\t\t\t\tcallback();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n});\n\n\n\n\nvar oldCallbacks = [],\n\trjsonp = /(=)\\?(?=&|$)|\\?\\?/;\n\n// Default jsonp settings\njQuery.ajaxSetup({\n\tjsonp: \"callback\",\n\tjsonpCallback: function() {\n\t\tvar callback = oldCallbacks.pop() || ( jQuery.expando + \"_\" + ( nonce++ ) );\n\t\tthis[ callback ] = true;\n\t\treturn callback;\n\t}\n});\n\n// Detect, normalize options and install callbacks for jsonp requests\njQuery.ajaxPrefilter( \"json jsonp\", function( s, originalSettings, jqXHR ) {\n\n\tvar callbackName, overwritten, responseContainer,\n\t\tjsonProp = s.jsonp !== false && ( rjsonp.test( s.url ) ?\n\t\t\t\"url\" :\n\t\t\ttypeof s.data === \"string\" && !( s.contentType || \"\" ).indexOf(\"application/x-www-form-urlencoded\") && rjsonp.test( s.data ) && \"data\"\n\t\t);\n\n\t// Handle iff the expected data type is \"jsonp\" or we have a parameter to set\n\tif ( jsonProp || s.dataTypes[ 0 ] === \"jsonp\" ) {\n\n\t\t// Get callback name, remembering preexisting value associated with it\n\t\tcallbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?\n\t\t\ts.jsonpCallback() :\n\t\t\ts.jsonpCallback;\n\n\t\t// Insert callback into url or form data\n\t\tif ( jsonProp ) {\n\t\t\ts[ jsonProp ] = s[ jsonProp ].replace( rjsonp, \"$1\" + callbackName );\n\t\t} else if ( s.jsonp !== false ) {\n\t\t\ts.url += ( rquery.test( s.url ) ? \"&\" : \"?\" ) + s.jsonp + \"=\" + callbackName;\n\t\t}\n\n\t\t// Use data converter to retrieve json after script execution\n\t\ts.converters[\"script json\"] = function() {\n\t\t\tif ( !responseContainer ) {\n\t\t\t\tjQuery.error( callbackName + \" was not called\" );\n\t\t\t}\n\t\t\treturn responseContainer[ 0 ];\n\t\t};\n\n\t\t// force json dataType\n\t\ts.dataTypes[ 0 ] = \"json\";\n\n\t\t// Install callback\n\t\toverwritten = window[ callbackName ];\n\t\twindow[ callbackName ] = function() {\n\t\t\tresponseContainer = arguments;\n\t\t};\n\n\t\t// Clean-up function (fires after converters)\n\t\tjqXHR.always(function() {\n\t\t\t// Restore preexisting value\n\t\t\twindow[ callbackName ] = overwritten;\n\n\t\t\t// Save back as free\n\t\t\tif ( s[ callbackName ] ) {\n\t\t\t\t// make sure that re-using the options doesn't screw things around\n\t\t\t\ts.jsonpCallback = originalSettings.jsonpCallback;\n\n\t\t\t\t// save the callback name for future use\n\t\t\t\toldCallbacks.push( callbackName );\n\t\t\t}\n\n\t\t\t// Call if it was a function and we have a response\n\t\t\tif ( responseContainer && jQuery.isFunction( overwritten ) ) {\n\t\t\t\toverwritten( responseContainer[ 0 ] );\n\t\t\t}\n\n\t\t\tresponseContainer = overwritten = undefined;\n\t\t});\n\n\t\t// Delegate to script\n\t\treturn \"script\";\n\t}\n});\n\n\n\n\n// data: string of html\n// context (optional): If specified, the fragment will be created in this context, defaults to document\n// keepScripts (optional): If true, will include scripts passed in the html string\njQuery.parseHTML = function( data, context, keepScripts ) {\n\tif ( !data || typeof data !== \"string\" ) {\n\t\treturn null;\n\t}\n\tif ( typeof context === \"boolean\" ) {\n\t\tkeepScripts = context;\n\t\tcontext = false;\n\t}\n\tcontext = context || document;\n\n\tvar parsed = rsingleTag.exec( data ),\n\t\tscripts = !keepScripts && [];\n\n\t// Single tag\n\tif ( parsed ) {\n\t\treturn [ context.createElement( parsed[1] ) ];\n\t}\n\n\tparsed = jQuery.buildFragment( [ data ], context, scripts );\n\n\tif ( scripts && scripts.length ) {\n\t\tjQuery( scripts ).remove();\n\t}\n\n\treturn jQuery.merge( [], parsed.childNodes );\n};\n\n\n// Keep a copy of the old load method\nvar _load = jQuery.fn.load;\n\n/**\n * Load a url into a page\n */\njQuery.fn.load = function( url, params, callback ) {\n\tif ( typeof url !== \"string\" && _load ) {\n\t\treturn _load.apply( this, arguments );\n\t}\n\n\tvar selector, type, response,\n\t\tself = this,\n\t\toff = url.indexOf(\" \");\n\n\tif ( off >= 0 ) {\n\t\tselector = jQuery.trim( url.slice( off ) );\n\t\turl = url.slice( 0, off );\n\t}\n\n\t// If it's a function\n\tif ( jQuery.isFunction( params ) ) {\n\n\t\t// We assume that it's the callback\n\t\tcallback = params;\n\t\tparams = undefined;\n\n\t// Otherwise, build a param string\n\t} else if ( params && typeof params === \"object\" ) {\n\t\ttype = \"POST\";\n\t}\n\n\t// If we have elements to modify, make the request\n\tif ( self.length > 0 ) {\n\t\tjQuery.ajax({\n\t\t\turl: url,\n\n\t\t\t// if \"type\" variable is undefined, then \"GET\" method will be used\n\t\t\ttype: type,\n\t\t\tdataType: \"html\",\n\t\t\tdata: params\n\t\t}).done(function( responseText ) {\n\n\t\t\t// Save response for use in complete callback\n\t\t\tresponse = arguments;\n\n\t\t\tself.html( selector ?\n\n\t\t\t\t// If a selector was specified, locate the right elements in a dummy div\n\t\t\t\t// Exclude scripts to avoid IE 'Permission Denied' errors\n\t\t\t\tjQuery(\"<div>\").append( jQuery.parseHTML( responseText ) ).find( selector ) :\n\n\t\t\t\t// Otherwise use the full result\n\t\t\t\tresponseText );\n\n\t\t}).complete( callback && function( jqXHR, status ) {\n\t\t\tself.each( callback, response || [ jqXHR.responseText, status, jqXHR ] );\n\t\t});\n\t}\n\n\treturn this;\n};\n\n\n\n\njQuery.expr.filters.animated = function( elem ) {\n\treturn jQuery.grep(jQuery.timers, function( fn ) {\n\t\treturn elem === fn.elem;\n\t}).length;\n};\n\n\n\n\nvar docElem = window.document.documentElement;\n\n/**\n * Gets a window from an element\n */\nfunction getWindow( elem ) {\n\treturn jQuery.isWindow( elem ) ? elem : elem.nodeType === 9 && elem.defaultView;\n}\n\njQuery.offset = {\n\tsetOffset: function( elem, options, i ) {\n\t\tvar curPosition, curLeft, curCSSTop, curTop, curOffset, curCSSLeft, calculatePosition,\n\t\t\tposition = jQuery.css( elem, \"position\" ),\n\t\t\tcurElem = jQuery( elem ),\n\t\t\tprops = {};\n\n\t\t// Set position first, in-case top/left are set even on static elem\n\t\tif ( position === \"static\" ) {\n\t\t\telem.style.position = \"relative\";\n\t\t}\n\n\t\tcurOffset = curElem.offset();\n\t\tcurCSSTop = jQuery.css( elem, \"top\" );\n\t\tcurCSSLeft = jQuery.css( elem, \"left\" );\n\t\tcalculatePosition = ( position === \"absolute\" || position === \"fixed\" ) &&\n\t\t\t( curCSSTop + curCSSLeft ).indexOf(\"auto\") > -1;\n\n\t\t// Need to be able to calculate position if either top or left is auto and position is either absolute or fixed\n\t\tif ( calculatePosition ) {\n\t\t\tcurPosition = curElem.position();\n\t\t\tcurTop = curPosition.top;\n\t\t\tcurLeft = curPosition.left;\n\n\t\t} else {\n\t\t\tcurTop = parseFloat( curCSSTop ) || 0;\n\t\t\tcurLeft = parseFloat( curCSSLeft ) || 0;\n\t\t}\n\n\t\tif ( jQuery.isFunction( options ) ) {\n\t\t\toptions = options.call( elem, i, curOffset );\n\t\t}\n\n\t\tif ( options.top != null ) {\n\t\t\tprops.top = ( options.top - curOffset.top ) + curTop;\n\t\t}\n\t\tif ( options.left != null ) {\n\t\t\tprops.left = ( options.left - curOffset.left ) + curLeft;\n\t\t}\n\n\t\tif ( \"using\" in options ) {\n\t\t\toptions.using.call( elem, props );\n\n\t\t} else {\n\t\t\tcurElem.css( props );\n\t\t}\n\t}\n};\n\njQuery.fn.extend({\n\toffset: function( options ) {\n\t\tif ( arguments.length ) {\n\t\t\treturn options === undefined ?\n\t\t\t\tthis :\n\t\t\t\tthis.each(function( i ) {\n\t\t\t\t\tjQuery.offset.setOffset( this, options, i );\n\t\t\t\t});\n\t\t}\n\n\t\tvar docElem, win,\n\t\t\telem = this[ 0 ],\n\t\t\tbox = { top: 0, left: 0 },\n\t\t\tdoc = elem && elem.ownerDocument;\n\n\t\tif ( !doc ) {\n\t\t\treturn;\n\t\t}\n\n\t\tdocElem = doc.documentElement;\n\n\t\t// Make sure it's not a disconnected DOM node\n\t\tif ( !jQuery.contains( docElem, elem ) ) {\n\t\t\treturn box;\n\t\t}\n\n\t\t// If we don't have gBCR, just use 0,0 rather than error\n\t\t// BlackBerry 5, iOS 3 (original iPhone)\n\t\tif ( typeof elem.getBoundingClientRect !== strundefined ) {\n\t\t\tbox = elem.getBoundingClientRect();\n\t\t}\n\t\twin = getWindow( doc );\n\t\treturn {\n\t\t\ttop: box.top + win.pageYOffset - docElem.clientTop,\n\t\t\tleft: box.left + win.pageXOffset - docElem.clientLeft\n\t\t};\n\t},\n\n\tposition: function() {\n\t\tif ( !this[ 0 ] ) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar offsetParent, offset,\n\t\t\telem = this[ 0 ],\n\t\t\tparentOffset = { top: 0, left: 0 };\n\n\t\t// Fixed elements are offset from window (parentOffset = {top:0, left: 0}, because it is its only offset parent\n\t\tif ( jQuery.css( elem, \"position\" ) === \"fixed\" ) {\n\t\t\t// We assume that getBoundingClientRect is available when computed position is fixed\n\t\t\toffset = elem.getBoundingClientRect();\n\n\t\t} else {\n\t\t\t// Get *real* offsetParent\n\t\t\toffsetParent = this.offsetParent();\n\n\t\t\t// Get correct offsets\n\t\t\toffset = this.offset();\n\t\t\tif ( !jQuery.nodeName( offsetParent[ 0 ], \"html\" ) ) {\n\t\t\t\tparentOffset = offsetParent.offset();\n\t\t\t}\n\n\t\t\t// Add offsetParent borders\n\t\t\tparentOffset.top += jQuery.css( offsetParent[ 0 ], \"borderTopWidth\", true );\n\t\t\tparentOffset.left += jQuery.css( offsetParent[ 0 ], \"borderLeftWidth\", true );\n\t\t}\n\n\t\t// Subtract parent offsets and element margins\n\t\treturn {\n\t\t\ttop: offset.top - parentOffset.top - jQuery.css( elem, \"marginTop\", true ),\n\t\t\tleft: offset.left - parentOffset.left - jQuery.css( elem, \"marginLeft\", true )\n\t\t};\n\t},\n\n\toffsetParent: function() {\n\t\treturn this.map(function() {\n\t\t\tvar offsetParent = this.offsetParent || docElem;\n\n\t\t\twhile ( offsetParent && ( !jQuery.nodeName( offsetParent, \"html\" ) && jQuery.css( offsetParent, \"position\" ) === \"static\" ) ) {\n\t\t\t\toffsetParent = offsetParent.offsetParent;\n\t\t\t}\n\n\t\t\treturn offsetParent || docElem;\n\t\t});\n\t}\n});\n\n// Create scrollLeft and scrollTop methods\njQuery.each( { scrollLeft: \"pageXOffset\", scrollTop: \"pageYOffset\" }, function( method, prop ) {\n\tvar top = \"pageYOffset\" === prop;\n\n\tjQuery.fn[ method ] = function( val ) {\n\t\treturn access( this, function( elem, method, val ) {\n\t\t\tvar win = getWindow( elem );\n\n\t\t\tif ( val === undefined ) {\n\t\t\t\treturn win ? win[ prop ] : elem[ method ];\n\t\t\t}\n\n\t\t\tif ( win ) {\n\t\t\t\twin.scrollTo(\n\t\t\t\t\t!top ? val : window.pageXOffset,\n\t\t\t\t\ttop ? val : window.pageYOffset\n\t\t\t\t);\n\n\t\t\t} else {\n\t\t\t\telem[ method ] = val;\n\t\t\t}\n\t\t}, method, val, arguments.length, null );\n\t};\n});\n\n// Add the top/left cssHooks using jQuery.fn.position\n// Webkit bug: https://bugs.webkit.org/show_bug.cgi?id=29084\n// getComputedStyle returns percent when specified for top/left/bottom/right\n// rather than make the css module depend on the offset module, we just check for it here\njQuery.each( [ \"top\", \"left\" ], function( i, prop ) {\n\tjQuery.cssHooks[ prop ] = addGetHookIf( support.pixelPosition,\n\t\tfunction( elem, computed ) {\n\t\t\tif ( computed ) {\n\t\t\t\tcomputed = curCSS( elem, prop );\n\t\t\t\t// if curCSS returns percentage, fallback to offset\n\t\t\t\treturn rnumnonpx.test( computed ) ?\n\t\t\t\t\tjQuery( elem ).position()[ prop ] + \"px\" :\n\t\t\t\t\tcomputed;\n\t\t\t}\n\t\t}\n\t);\n});\n\n\n// Create innerHeight, innerWidth, height, width, outerHeight and outerWidth methods\njQuery.each( { Height: \"height\", Width: \"width\" }, function( name, type ) {\n\tjQuery.each( { padding: \"inner\" + name, content: type, \"\": \"outer\" + name }, function( defaultExtra, funcName ) {\n\t\t// margin is only for outerHeight, outerWidth\n\t\tjQuery.fn[ funcName ] = function( margin, value ) {\n\t\t\tvar chainable = arguments.length && ( defaultExtra || typeof margin !== \"boolean\" ),\n\t\t\t\textra = defaultExtra || ( margin === true || value === true ? \"margin\" : \"border\" );\n\n\t\t\treturn access( this, function( elem, type, value ) {\n\t\t\t\tvar doc;\n\n\t\t\t\tif ( jQuery.isWindow( elem ) ) {\n\t\t\t\t\t// As of 5/8/2012 this will yield incorrect results for Mobile Safari, but there\n\t\t\t\t\t// isn't a whole lot we can do. See pull request at this URL for discussion:\n\t\t\t\t\t// https://github.com/jquery/jquery/pull/764\n\t\t\t\t\treturn elem.document.documentElement[ \"client\" + name ];\n\t\t\t\t}\n\n\t\t\t\t// Get document width or height\n\t\t\t\tif ( elem.nodeType === 9 ) {\n\t\t\t\t\tdoc = elem.documentElement;\n\n\t\t\t\t\t// Either scroll[Width/Height] or offset[Width/Height] or client[Width/Height],\n\t\t\t\t\t// whichever is greatest\n\t\t\t\t\treturn Math.max(\n\t\t\t\t\t\telem.body[ \"scroll\" + name ], doc[ \"scroll\" + name ],\n\t\t\t\t\t\telem.body[ \"offset\" + name ], doc[ \"offset\" + name ],\n\t\t\t\t\t\tdoc[ \"client\" + name ]\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn value === undefined ?\n\t\t\t\t\t// Get width or height on the element, requesting but not forcing parseFloat\n\t\t\t\t\tjQuery.css( elem, type, extra ) :\n\n\t\t\t\t\t// Set width or height on the element\n\t\t\t\t\tjQuery.style( elem, type, value, extra );\n\t\t\t}, type, chainable ? margin : undefined, chainable, null );\n\t\t};\n\t});\n});\n\n\n// The number of elements contained in the matched element set\njQuery.fn.size = function() {\n\treturn this.length;\n};\n\njQuery.fn.andSelf = jQuery.fn.addBack;\n\n\n\n\n// Register as a named AMD module, since jQuery can be concatenated with other\n// files that may use define, but not via a proper concatenation script that\n// understands anonymous AMD modules. A named AMD is safest and most robust\n// way to register. Lowercase jquery is used because AMD module names are\n// derived from file names, and jQuery is normally delivered in a lowercase\n// file name. Do this after creating the global so that if an AMD module wants\n// to call noConflict to hide this version of jQuery, it will work.\n\n// Note that for maximum portability, libraries that are not jQuery should\n// declare themselves as anonymous modules, and avoid setting a global if an\n// AMD loader is present. jQuery is a special case. For more information, see\n// https://github.com/jrburke/requirejs/wiki/Updating-existing-libraries#wiki-anon\n\n//if ( typeof define === \"function\" && define.amd ) {\n//\tdefine( \"jquery\", [], function() {\n//\t\treturn jQuery;\n//\t});\n//}\n\n\n\n\nvar\n\t// Map over jQuery in case of overwrite\n\t_jQuery = window.jQuery,\n\n\t// Map over the $ in case of overwrite\n\t_$ = window.$;\n\njQuery.noConflict = function( deep ) {\n\tif ( window.$ === jQuery ) {\n\t\twindow.$ = _$;\n\t}\n\n\tif ( deep && window.jQuery === jQuery ) {\n\t\twindow.jQuery = _jQuery;\n\t}\n\n\treturn jQuery;\n};\n\n// Expose jQuery and $ identifiers, even in\n// AMD (#7102#comment:10, https://github.com/jquery/jquery/pull/557)\n// and CommonJS for browser emulators (#13566)\nif ( typeof noGlobal === strundefined ) {\n\twindow.jQuery = window.$ = jQuery;\n}\n\n\n\n\nreturn jQuery;\n\n}));\n\n// END JQUERY SOURCE\nreturn jQuery.noConflict(true);\n});\n",
    "define('taoQtiItem/portableLib/OAT/util/xml',[],function(){\n    \n    return {\n        addNamespace : function addMarkupNamespace(xml, ns){\n            return ns ? xml.replace(/<(\\/)?([^!\\/:>]+)(\\/)?>/g, '<$1' + ns + ':$2$3>') : xml;\n        },\n        removeNamespace : function removeNamespace(markup){\n            return markup.replace(/<(\\/)?(\\w*):([^>]*)>/g, '<$1$3>');\n        }\n    };\n});\n",
    "define('taoQtiItem/portableLib/OAT/util/math',['taoQtiItem/portableLib/jquery_2_1_1', 'mathJax'], function($, MathJax){\n    'use strict';\n    return {\n        render : function render($container){\n            if(MathJax){\n                $container.find('math').each(function(){\n                    var $wrap;\n                    var $math = $(this);\n                    $math.wrap($('<span>', {'class' : 'math-renderer'}));\n                    $wrap = $math.parent('.math-renderer');\n                    MathJax.Hub.Queue([\"Typeset\", MathJax.Hub, $wrap[0]]);\n                });\n            }\n        }\n    };\n});\n",
    "/*\n * qTip2 - Pretty powerful tooltips - v3.0.3\n * http://qtip2.com\n *\n * Copyright (c) 2016\n * Released under the MIT licenses\n * http://jquery.org/license\n *\n * Date: Wed May 11 2016 10:31 GMT+0100+0100\n * Plugins: tips modal viewport svg imagemap ie6\n * Styles: core basic css3\n *\n * =====================================================================\n * OAT WARNING : Line 25 has been changed from the original source code.\n * =====================================================================\n */\n/*global window: false, jQuery: false, console: false, define: false */\n/* Cache window, document, undefined */\n(function( window, document, undefined ) {\n\n// Uses AMD or browser globals to create a jQuery plugin.\n\t(function( factory ) {\n\t\t\"use strict\";\n\t\tif(typeof define === 'function' && define.amd) {\n\t\t\tdefine('taoQtiItem/portableLib/jquery.qtip',['taoQtiItem/portableLib/jquery_2_1_1'], factory);\n\t\t}\n\t\telse if(jQuery && !jQuery.fn.qtip) {\n\t\t\tfactory(jQuery);\n\t\t}\n\t}\n\t(function($) {\n\t\t\"use strict\"; // Enable ECMAScript \"strict\" operation for this function. See more: http://ejohn.org/blog/ecmascript-5-strict-mode-json-and-more/\n\t\t;// Munge the primitives - Paul Irish tip\n\t\tvar TRUE = true,\n\t\t\tFALSE = false,\n\t\t\tNULL = null,\n\n// Common variables\n\t\t\tX = 'x', Y = 'y',\n\t\t\tWIDTH = 'width',\n\t\t\tHEIGHT = 'height',\n\n// Positioning sides\n\t\t\tTOP = 'top',\n\t\t\tLEFT = 'left',\n\t\t\tBOTTOM = 'bottom',\n\t\t\tRIGHT = 'right',\n\t\t\tCENTER = 'center',\n\n// Position adjustment types\n\t\t\tFLIP = 'flip',\n\t\t\tFLIPINVERT = 'flipinvert',\n\t\t\tSHIFT = 'shift',\n\n// Shortcut vars\n\t\t\tQTIP, PROTOTYPE, CORNER, CHECKS,\n\t\t\tPLUGINS = {},\n\t\t\tNAMESPACE = 'qtip',\n\t\t\tATTR_HAS = 'data-hasqtip',\n\t\t\tATTR_ID = 'data-qtip-id',\n\t\t\tWIDGET = ['ui-widget', 'ui-tooltip'],\n\t\t\tSELECTOR = '.'+NAMESPACE,\n\t\t\tINACTIVE_EVENTS = 'click dblclick mousedown mouseup mousemove mouseleave mouseenter'.split(' '),\n\n\t\t\tCLASS_FIXED = NAMESPACE+'-fixed',\n\t\t\tCLASS_DEFAULT = NAMESPACE + '-default',\n\t\t\tCLASS_FOCUS = NAMESPACE + '-focus',\n\t\t\tCLASS_HOVER = NAMESPACE + '-hover',\n\t\t\tCLASS_DISABLED = NAMESPACE+'-disabled',\n\n\t\t\treplaceSuffix = '_replacedByqTip',\n\t\t\toldtitle = 'oldtitle',\n\t\t\ttrackingBound,\n\n// Browser detection\n\t\t\tBROWSER = {\n\t\t\t\t/*\n\t\t\t\t * IE version detection\n\t\t\t\t *\n\t\t\t\t * Adapted from: http://ajaxian.com/archives/attack-of-the-ie-conditional-comment\n\t\t\t\t * Credit to James Padolsey for the original implemntation!\n\t\t\t\t */\n\t\t\t\tie: (function() {\n\t\t\t\t\t/* eslint-disable no-empty */\n\t\t\t\t\tvar v, i;\n\t\t\t\t\tfor (\n\t\t\t\t\t\tv = 4, i = document.createElement('div');\n\t\t\t\t\t\t(i.innerHTML = '<!--[if gt IE ' + v + ']><i></i><![endif]-->') && i.getElementsByTagName('i')[0];\n\t\t\t\t\t\tv+=1\n\t\t\t\t\t) {}\n\t\t\t\t\treturn v > 4 ? v : NaN;\n\t\t\t\t\t/* eslint-enable no-empty */\n\t\t\t\t})(),\n\n\t\t\t\t/*\n\t\t\t\t * iOS version detection\n\t\t\t\t */\n\t\t\t\tiOS: parseFloat(\n\t\t\t\t\t('' + (/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent) || [0,''])[1])\n\t\t\t\t\t\t.replace('undefined', '3_2').replace('_', '.').replace('_', '')\n\t\t\t\t) || FALSE\n\t\t\t};\n\t\t;function QTip(target, options, id, attr) {\n\t\t\t// Elements and ID\n\t\t\tthis.id = id;\n\t\t\tthis.target = target;\n\t\t\tthis.tooltip = NULL;\n\t\t\tthis.elements = { target: target };\n\n\t\t\t// Internal constructs\n\t\t\tthis._id = NAMESPACE + '-' + id;\n\t\t\tthis.timers = { img: {} };\n\t\t\tthis.options = options;\n\t\t\tthis.plugins = {};\n\n\t\t\t// Cache object\n\t\t\tthis.cache = {\n\t\t\t\tevent: {},\n\t\t\t\ttarget: $(),\n\t\t\t\tdisabled: FALSE,\n\t\t\t\tattr: attr,\n\t\t\t\tonTooltip: FALSE,\n\t\t\t\tlastClass: ''\n\t\t\t};\n\n\t\t\t// Set the initial flags\n\t\t\tthis.rendered = this.destroyed = this.disabled = this.waiting =\n\t\t\t\tthis.hiddenDuringWait = this.positioning = this.triggering = FALSE;\n\t\t}\n\t\tPROTOTYPE = QTip.prototype;\n\n\t\tPROTOTYPE._when = function(deferreds) {\n\t\t\treturn $.when.apply($, deferreds);\n\t\t};\n\n\t\tPROTOTYPE.render = function(show) {\n\t\t\tif(this.rendered || this.destroyed) { return this; } // If tooltip has already been rendered, exit\n\n\t\t\tvar self = this,\n\t\t\t\toptions = this.options,\n\t\t\t\tcache = this.cache,\n\t\t\t\telements = this.elements,\n\t\t\t\ttext = options.content.text,\n\t\t\t\ttitle = options.content.title,\n\t\t\t\tbutton = options.content.button,\n\t\t\t\tposOptions = options.position,\n\t\t\t\tdeferreds = [];\n\n\t\t\t// Add ARIA attributes to target\n\t\t\t$.attr(this.target[0], 'aria-describedby', this._id);\n\n\t\t\t// Create public position object that tracks current position corners\n\t\t\tcache.posClass = this._createPosClass(\n\t\t\t\t(this.position = { my: posOptions.my, at: posOptions.at }).my\n\t\t\t);\n\n\t\t\t// Create tooltip element\n\t\t\tthis.tooltip = elements.tooltip = $('<div/>', {\n\t\t\t\t'id': this._id,\n\t\t\t\t'class': [ NAMESPACE, CLASS_DEFAULT, options.style.classes, cache.posClass ].join(' '),\n\t\t\t\t'width': options.style.width || '',\n\t\t\t\t'height': options.style.height || '',\n\t\t\t\t'tracking': posOptions.target === 'mouse' && posOptions.adjust.mouse,\n\n\t\t\t\t/* ARIA specific attributes */\n\t\t\t\t'role': 'alert',\n\t\t\t\t'aria-live': 'polite',\n\t\t\t\t'aria-atomic': FALSE,\n\t\t\t\t'aria-describedby': this._id + '-content',\n\t\t\t\t'aria-hidden': TRUE\n\t\t\t})\n\t\t\t\t.toggleClass(CLASS_DISABLED, this.disabled)\n\t\t\t\t.attr(ATTR_ID, this.id)\n\t\t\t\t.data(NAMESPACE, this)\n\t\t\t\t.appendTo(posOptions.container)\n\t\t\t\t.append(\n\t\t\t\t\t// Create content element\n\t\t\t\t\telements.content = $('<div />', {\n\t\t\t\t\t\t'class': NAMESPACE + '-content',\n\t\t\t\t\t\t'id': this._id + '-content',\n\t\t\t\t\t\t'aria-atomic': TRUE\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t// Set rendered flag and prevent redundant reposition calls for now\n\t\t\tthis.rendered = -1;\n\t\t\tthis.positioning = TRUE;\n\n\t\t\t// Create title...\n\t\t\tif(title) {\n\t\t\t\tthis._createTitle();\n\n\t\t\t\t// Update title only if its not a callback (called in toggle if so)\n\t\t\t\tif(!$.isFunction(title)) {\n\t\t\t\t\tdeferreds.push( this._updateTitle(title, FALSE) );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Create button\n\t\t\tif(button) { this._createButton(); }\n\n\t\t\t// Set proper rendered flag and update content if not a callback function (called in toggle)\n\t\t\tif(!$.isFunction(text)) {\n\t\t\t\tdeferreds.push( this._updateContent(text, FALSE) );\n\t\t\t}\n\t\t\tthis.rendered = TRUE;\n\n\t\t\t// Setup widget classes\n\t\t\tthis._setWidget();\n\n\t\t\t// Initialize 'render' plugins\n\t\t\t$.each(PLUGINS, function(name) {\n\t\t\t\tvar instance;\n\t\t\t\tif(this.initialize === 'render' && (instance = this(self))) {\n\t\t\t\t\tself.plugins[name] = instance;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Unassign initial events and assign proper events\n\t\t\tthis._unassignEvents();\n\t\t\tthis._assignEvents();\n\n\t\t\t// When deferreds have completed\n\t\t\tthis._when(deferreds).then(function() {\n\t\t\t\t// tooltiprender event\n\t\t\t\tself._trigger('render');\n\n\t\t\t\t// Reset flags\n\t\t\t\tself.positioning = FALSE;\n\n\t\t\t\t// Show tooltip if not hidden during wait period\n\t\t\t\tif(!self.hiddenDuringWait && (options.show.ready || show)) {\n\t\t\t\t\tself.toggle(TRUE, cache.event, FALSE);\n\t\t\t\t}\n\t\t\t\tself.hiddenDuringWait = FALSE;\n\t\t\t});\n\n\t\t\t// Expose API\n\t\t\tQTIP.api[this.id] = this;\n\n\t\t\treturn this;\n\t\t};\n\n\t\tPROTOTYPE.destroy = function(immediate) {\n\t\t\t// Set flag the signify destroy is taking place to plugins\n\t\t\t// and ensure it only gets destroyed once!\n\t\t\tif(this.destroyed) { return this.target; }\n\n\t\t\tfunction process() {\n\t\t\t\tif(this.destroyed) { return; }\n\t\t\t\tthis.destroyed = TRUE;\n\n\t\t\t\tvar target = this.target,\n\t\t\t\t\ttitle = target.attr(oldtitle),\n\t\t\t\t\ttimer;\n\n\t\t\t\t// Destroy tooltip if rendered\n\t\t\t\tif(this.rendered) {\n\t\t\t\t\tthis.tooltip.stop(1,0).find('*').remove().end().remove();\n\t\t\t\t}\n\n\t\t\t\t// Destroy all plugins\n\t\t\t\t$.each(this.plugins, function() {\n\t\t\t\t\tthis.destroy && this.destroy();\n\t\t\t\t});\n\n\t\t\t\t// Clear timers\n\t\t\t\tfor (timer in this.timers) {\n\t\t\t\t\tif (this.timers.hasOwnProperty(timer)) {\n\t\t\t\t\t\tclearTimeout(this.timers[timer]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Remove api object and ARIA attributes\n\t\t\t\ttarget.removeData(NAMESPACE)\n\t\t\t\t\t.removeAttr(ATTR_ID)\n\t\t\t\t\t.removeAttr(ATTR_HAS)\n\t\t\t\t\t.removeAttr('aria-describedby');\n\n\t\t\t\t// Reset old title attribute if removed\n\t\t\t\tif(this.options.suppress && title) {\n\t\t\t\t\ttarget.attr('title', title).removeAttr(oldtitle);\n\t\t\t\t}\n\n\t\t\t\t// Remove qTip events associated with this API\n\t\t\t\tthis._unassignEvents();\n\n\t\t\t\t// Remove ID from used id objects, and delete object references\n\t\t\t\t// for better garbage collection and leak protection\n\t\t\t\tthis.options = this.elements = this.cache = this.timers =\n\t\t\t\t\tthis.plugins = this.mouse = NULL;\n\n\t\t\t\t// Delete epoxsed API object\n\t\t\t\tdelete QTIP.api[this.id];\n\t\t\t}\n\n\t\t\t// If an immediate destroy is needed\n\t\t\tif((immediate !== TRUE || this.triggering === 'hide') && this.rendered) {\n\t\t\t\tthis.tooltip.one('tooltiphidden', $.proxy(process, this));\n\t\t\t\t!this.triggering && this.hide();\n\t\t\t}\n\n\t\t\t// If we're not in the process of hiding... process\n\t\t\telse { process.call(this); }\n\n\t\t\treturn this.target;\n\t\t};\n\t\t;function invalidOpt(a) {\n\t\t\treturn a === NULL || $.type(a) !== 'object';\n\t\t}\n\n\t\tfunction invalidContent(c) {\n\t\t\treturn !($.isFunction(c) ||\n\t\t\tc && c.attr ||\n\t\t\tc.length ||\n\t\t\t$.type(c) === 'object' && (c.jquery || c.then));\n\t\t}\n\n// Option object sanitizer\n\t\tfunction sanitizeOptions(opts) {\n\t\t\tvar content, text, ajax, once;\n\n\t\t\tif(invalidOpt(opts)) { return FALSE; }\n\n\t\t\tif(invalidOpt(opts.metadata)) {\n\t\t\t\topts.metadata = { type: opts.metadata };\n\t\t\t}\n\n\t\t\tif('content' in opts) {\n\t\t\t\tcontent = opts.content;\n\n\t\t\t\tif(invalidOpt(content) || content.jquery || content.done) {\n\t\t\t\t\ttext = invalidContent(content) ? FALSE : content;\n\t\t\t\t\tcontent = opts.content = {\n\t\t\t\t\t\ttext: text\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\telse { text = content.text; }\n\n\t\t\t\t// DEPRECATED - Old content.ajax plugin functionality\n\t\t\t\t// Converts it into the proper Deferred syntax\n\t\t\t\tif('ajax' in content) {\n\t\t\t\t\tajax = content.ajax;\n\t\t\t\t\tonce = ajax && ajax.once !== FALSE;\n\t\t\t\t\tdelete content.ajax;\n\n\t\t\t\t\tcontent.text = function(event, api) {\n\t\t\t\t\t\tvar loading = text || $(this).attr(api.options.content.attr) || 'Loading...',\n\n\t\t\t\t\t\t\tdeferred = $.ajax(\n\t\t\t\t\t\t\t\t$.extend({}, ajax, { context: api })\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.then(ajax.success, NULL, ajax.error)\n\t\t\t\t\t\t\t\t.then(function(newContent) {\n\t\t\t\t\t\t\t\t\t\tif(newContent && once) { api.set('content.text', newContent); }\n\t\t\t\t\t\t\t\t\t\treturn newContent;\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tfunction(xhr, status, error) {\n\t\t\t\t\t\t\t\t\t\tif(api.destroyed || xhr.status === 0) { return; }\n\t\t\t\t\t\t\t\t\t\tapi.set('content.text', status + ': ' + error);\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn !once ? (api.set('content.text', loading), deferred) : loading;\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif('title' in content) {\n\t\t\t\t\tif($.isPlainObject(content.title)) {\n\t\t\t\t\t\tcontent.button = content.title.button;\n\t\t\t\t\t\tcontent.title = content.title.text;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(invalidContent(content.title || FALSE)) {\n\t\t\t\t\t\tcontent.title = FALSE;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif('position' in opts && invalidOpt(opts.position)) {\n\t\t\t\topts.position = { my: opts.position, at: opts.position };\n\t\t\t}\n\n\t\t\tif('show' in opts && invalidOpt(opts.show)) {\n\t\t\t\topts.show = opts.show.jquery ? { target: opts.show } :\n\t\t\t\t\topts.show === TRUE ? { ready: TRUE } : { event: opts.show };\n\t\t\t}\n\n\t\t\tif('hide' in opts && invalidOpt(opts.hide)) {\n\t\t\t\topts.hide = opts.hide.jquery ? { target: opts.hide } : { event: opts.hide };\n\t\t\t}\n\n\t\t\tif('style' in opts && invalidOpt(opts.style)) {\n\t\t\t\topts.style = { classes: opts.style };\n\t\t\t}\n\n\t\t\t// Sanitize plugin options\n\t\t\t$.each(PLUGINS, function() {\n\t\t\t\tthis.sanitize && this.sanitize(opts);\n\t\t\t});\n\n\t\t\treturn opts;\n\t\t}\n\n// Setup builtin .set() option checks\n\t\tCHECKS = PROTOTYPE.checks = {\n\t\t\tbuiltin: {\n\t\t\t\t// Core checks\n\t\t\t\t'^id$': function(obj, o, v, prev) {\n\t\t\t\t\tvar id = v === TRUE ? QTIP.nextid : v,\n\t\t\t\t\t\tnewId = NAMESPACE + '-' + id;\n\n\t\t\t\t\tif(id !== FALSE && id.length > 0 && !$('#'+newId).length) {\n\t\t\t\t\t\tthis._id = newId;\n\n\t\t\t\t\t\tif(this.rendered) {\n\t\t\t\t\t\t\tthis.tooltip[0].id = this._id;\n\t\t\t\t\t\t\tthis.elements.content[0].id = this._id + '-content';\n\t\t\t\t\t\t\tthis.elements.title[0].id = this._id + '-title';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse { obj[o] = prev; }\n\t\t\t\t},\n\t\t\t\t'^prerender': function(obj, o, v) {\n\t\t\t\t\tv && !this.rendered && this.render(this.options.show.ready);\n\t\t\t\t},\n\n\t\t\t\t// Content checks\n\t\t\t\t'^content.text$': function(obj, o, v) {\n\t\t\t\t\tthis._updateContent(v);\n\t\t\t\t},\n\t\t\t\t'^content.attr$': function(obj, o, v, prev) {\n\t\t\t\t\tif(this.options.content.text === this.target.attr(prev)) {\n\t\t\t\t\t\tthis._updateContent( this.target.attr(v) );\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t'^content.title$': function(obj, o, v) {\n\t\t\t\t\t// Remove title if content is null\n\t\t\t\t\tif(!v) { return this._removeTitle(); }\n\n\t\t\t\t\t// If title isn't already created, create it now and update\n\t\t\t\t\tv && !this.elements.title && this._createTitle();\n\t\t\t\t\tthis._updateTitle(v);\n\t\t\t\t},\n\t\t\t\t'^content.button$': function(obj, o, v) {\n\t\t\t\t\tthis._updateButton(v);\n\t\t\t\t},\n\t\t\t\t'^content.title.(text|button)$': function(obj, o, v) {\n\t\t\t\t\tthis.set('content.'+o, v); // Backwards title.text/button compat\n\t\t\t\t},\n\n\t\t\t\t// Position checks\n\t\t\t\t'^position.(my|at)$': function(obj, o, v){\n\t\t\t\t\tif('string' === typeof v) {\n\t\t\t\t\t\tthis.position[o] = obj[o] = new CORNER(v, o === 'at');\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t'^position.container$': function(obj, o, v){\n\t\t\t\t\tthis.rendered && this.tooltip.appendTo(v);\n\t\t\t\t},\n\n\t\t\t\t// Show checks\n\t\t\t\t'^show.ready$': function(obj, o, v) {\n\t\t\t\t\tv && (!this.rendered && this.render(TRUE) || this.toggle(TRUE));\n\t\t\t\t},\n\n\t\t\t\t// Style checks\n\t\t\t\t'^style.classes$': function(obj, o, v, p) {\n\t\t\t\t\tthis.rendered && this.tooltip.removeClass(p).addClass(v);\n\t\t\t\t},\n\t\t\t\t'^style.(width|height)': function(obj, o, v) {\n\t\t\t\t\tthis.rendered && this.tooltip.css(o, v);\n\t\t\t\t},\n\t\t\t\t'^style.widget|content.title': function() {\n\t\t\t\t\tthis.rendered && this._setWidget();\n\t\t\t\t},\n\t\t\t\t'^style.def': function(obj, o, v) {\n\t\t\t\t\tthis.rendered && this.tooltip.toggleClass(CLASS_DEFAULT, !!v);\n\t\t\t\t},\n\n\t\t\t\t// Events check\n\t\t\t\t'^events.(render|show|move|hide|focus|blur)$': function(obj, o, v) {\n\t\t\t\t\tthis.rendered && this.tooltip[($.isFunction(v) ? '' : 'un') + 'bind']('tooltip'+o, v);\n\t\t\t\t},\n\n\t\t\t\t// Properties which require event reassignment\n\t\t\t\t'^(show|hide|position).(event|target|fixed|inactive|leave|distance|viewport|adjust)': function() {\n\t\t\t\t\tif(!this.rendered) { return; }\n\n\t\t\t\t\t// Set tracking flag\n\t\t\t\t\tvar posOptions = this.options.position;\n\t\t\t\t\tthis.tooltip.attr('tracking', posOptions.target === 'mouse' && posOptions.adjust.mouse);\n\n\t\t\t\t\t// Reassign events\n\t\t\t\t\tthis._unassignEvents();\n\t\t\t\t\tthis._assignEvents();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n// Dot notation converter\n\t\tfunction convertNotation(options, notation) {\n\t\t\tvar i = 0, obj, option = options,\n\n\t\t\t\t// Split notation into array\n\t\t\t\tlevels = notation.split('.');\n\n\t\t\t// Loop through\n\t\t\twhile(option = option[ levels[i++] ]) {\n\t\t\t\tif(i < levels.length) { obj = option; }\n\t\t\t}\n\n\t\t\treturn [obj || options, levels.pop()];\n\t\t}\n\n\t\tPROTOTYPE.get = function(notation) {\n\t\t\tif(this.destroyed) { return this; }\n\n\t\t\tvar o = convertNotation(this.options, notation.toLowerCase()),\n\t\t\t\tresult = o[0][ o[1] ];\n\n\t\t\treturn result.precedance ? result.string() : result;\n\t\t};\n\n\t\tfunction setCallback(notation, args) {\n\t\t\tvar category, rule, match;\n\n\t\t\tfor(category in this.checks) {\n\t\t\t\tif (!this.checks.hasOwnProperty(category)) { continue; }\n\n\t\t\t\tfor(rule in this.checks[category]) {\n\t\t\t\t\tif (!this.checks[category].hasOwnProperty(rule)) { continue; }\n\n\t\t\t\t\tif(match = (new RegExp(rule, 'i')).exec(notation)) {\n\t\t\t\t\t\targs.push(match);\n\n\t\t\t\t\t\tif(category === 'builtin' || this.plugins[category]) {\n\t\t\t\t\t\t\tthis.checks[category][rule].apply(\n\t\t\t\t\t\t\t\tthis.plugins[category] || this, args\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar rmove = /^position\\.(my|at|adjust|target|container|viewport)|style|content|show\\.ready/i,\n\t\t\trrender = /^prerender|show\\.ready/i;\n\n\t\tPROTOTYPE.set = function(option, value) {\n\t\t\tif(this.destroyed) { return this; }\n\n\t\t\tvar rendered = this.rendered,\n\t\t\t\treposition = FALSE,\n\t\t\t\toptions = this.options,\n\t\t\t\tname;\n\n\t\t\t// Convert singular option/value pair into object form\n\t\t\tif('string' === typeof option) {\n\t\t\t\tname = option; option = {}; option[name] = value;\n\t\t\t}\n\t\t\telse { option = $.extend({}, option); }\n\n\t\t\t// Set all of the defined options to their new values\n\t\t\t$.each(option, function(notation, val) {\n\t\t\t\tif(rendered && rrender.test(notation)) {\n\t\t\t\t\tdelete option[notation]; return;\n\t\t\t\t}\n\n\t\t\t\t// Set new obj value\n\t\t\t\tvar obj = convertNotation(options, notation.toLowerCase()), previous;\n\t\t\t\tprevious = obj[0][ obj[1] ];\n\t\t\t\tobj[0][ obj[1] ] = val && val.nodeType ? $(val) : val;\n\n\t\t\t\t// Also check if we need to reposition\n\t\t\t\treposition = rmove.test(notation) || reposition;\n\n\t\t\t\t// Set the new params for the callback\n\t\t\t\toption[notation] = [obj[0], obj[1], val, previous];\n\t\t\t});\n\n\t\t\t// Re-sanitize options\n\t\t\tsanitizeOptions(options);\n\n\t\t\t/*\n\t\t\t * Execute any valid callbacks for the set options\n\t\t\t * Also set positioning flag so we don't get loads of redundant repositioning calls.\n\t\t\t */\n\t\t\tthis.positioning = TRUE;\n\t\t\t$.each(option, $.proxy(setCallback, this));\n\t\t\tthis.positioning = FALSE;\n\n\t\t\t// Update position if needed\n\t\t\tif(this.rendered && this.tooltip[0].offsetWidth > 0 && reposition) {\n\t\t\t\tthis.reposition( options.position.target === 'mouse' ? NULL : this.cache.event );\n\t\t\t}\n\n\t\t\treturn this;\n\t\t};\n\t\t;PROTOTYPE._update = function(content, element) {\n\t\t\tvar self = this,\n\t\t\t\tcache = this.cache;\n\n\t\t\t// Make sure tooltip is rendered and content is defined. If not return\n\t\t\tif(!this.rendered || !content) { return FALSE; }\n\n\t\t\t// Use function to parse content\n\t\t\tif($.isFunction(content)) {\n\t\t\t\tcontent = content.call(this.elements.target, cache.event, this) || '';\n\t\t\t}\n\n\t\t\t// Handle deferred content\n\t\t\tif($.isFunction(content.then)) {\n\t\t\t\tcache.waiting = TRUE;\n\t\t\t\treturn content.then(function(c) {\n\t\t\t\t\tcache.waiting = FALSE;\n\t\t\t\t\treturn self._update(c, element);\n\t\t\t\t}, NULL, function(e) {\n\t\t\t\t\treturn self._update(e, element);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// If content is null... return false\n\t\t\tif(content === FALSE || !content && content !== '') { return FALSE; }\n\n\t\t\t// Append new content if its a DOM array and show it if hidden\n\t\t\tif(content.jquery && content.length > 0) {\n\t\t\t\telement.empty().append(\n\t\t\t\t\tcontent.css({ display: 'block', visibility: 'visible' })\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Content is a regular string, insert the new content\n\t\t\telse { element.html(content); }\n\n\t\t\t// Wait for content to be loaded, and reposition\n\t\t\treturn this._waitForContent(element).then(function(images) {\n\t\t\t\tif(self.rendered && self.tooltip[0].offsetWidth > 0) {\n\t\t\t\t\tself.reposition(cache.event, !images.length);\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\tPROTOTYPE._waitForContent = function(element) {\n\t\t\tvar cache = this.cache;\n\n\t\t\t// Set flag\n\t\t\tcache.waiting = TRUE;\n\n\t\t\t// If imagesLoaded is included, ensure images have loaded and return promise\n\t\t\treturn ( $.fn.imagesLoaded ? element.imagesLoaded() : new $.Deferred().resolve([]) )\n\t\t\t\t.done(function() { cache.waiting = FALSE; })\n\t\t\t\t.promise();\n\t\t};\n\n\t\tPROTOTYPE._updateContent = function(content, reposition) {\n\t\t\tthis._update(content, this.elements.content, reposition);\n\t\t};\n\n\t\tPROTOTYPE._updateTitle = function(content, reposition) {\n\t\t\tif(this._update(content, this.elements.title, reposition) === FALSE) {\n\t\t\t\tthis._removeTitle(FALSE);\n\t\t\t}\n\t\t};\n\n\t\tPROTOTYPE._createTitle = function()\n\t\t{\n\t\t\tvar elements = this.elements,\n\t\t\t\tid = this._id+'-title';\n\n\t\t\t// Destroy previous title element, if present\n\t\t\tif(elements.titlebar) { this._removeTitle(); }\n\n\t\t\t// Create title bar and title elements\n\t\t\telements.titlebar = $('<div />', {\n\t\t\t\t'class': NAMESPACE + '-titlebar ' + (this.options.style.widget ? createWidgetClass('header') : '')\n\t\t\t})\n\t\t\t\t.append(\n\t\t\t\t\telements.title = $('<div />', {\n\t\t\t\t\t\t'id': id,\n\t\t\t\t\t\t'class': NAMESPACE + '-title',\n\t\t\t\t\t\t'aria-atomic': TRUE\n\t\t\t\t\t})\n\t\t\t\t)\n\t\t\t\t.insertBefore(elements.content)\n\n\t\t\t\t// Button-specific events\n\t\t\t\t.delegate('.qtip-close', 'mousedown keydown mouseup keyup mouseout', function(event) {\n\t\t\t\t\t$(this).toggleClass('ui-state-active ui-state-focus', event.type.substr(-4) === 'down');\n\t\t\t\t})\n\t\t\t\t.delegate('.qtip-close', 'mouseover mouseout', function(event){\n\t\t\t\t\t$(this).toggleClass('ui-state-hover', event.type === 'mouseover');\n\t\t\t\t});\n\n\t\t\t// Create button if enabled\n\t\t\tif(this.options.content.button) { this._createButton(); }\n\t\t};\n\n\t\tPROTOTYPE._removeTitle = function(reposition)\n\t\t{\n\t\t\tvar elements = this.elements;\n\n\t\t\tif(elements.title) {\n\t\t\t\telements.titlebar.remove();\n\t\t\t\telements.titlebar = elements.title = elements.button = NULL;\n\n\t\t\t\t// Reposition if enabled\n\t\t\t\tif(reposition !== FALSE) { this.reposition(); }\n\t\t\t}\n\t\t};\n\t\t;PROTOTYPE._createPosClass = function(my) {\n\t\t\treturn NAMESPACE + '-pos-' + (my || this.options.position.my).abbrev();\n\t\t};\n\n\t\tPROTOTYPE.reposition = function(event, effect) {\n\t\t\tif(!this.rendered || this.positioning || this.destroyed) { return this; }\n\n\t\t\t// Set positioning flag\n\t\t\tthis.positioning = TRUE;\n\n\t\t\tvar cache = this.cache,\n\t\t\t\ttooltip = this.tooltip,\n\t\t\t\tposOptions = this.options.position,\n\t\t\t\ttarget = posOptions.target,\n\t\t\t\tmy = posOptions.my,\n\t\t\t\tat = posOptions.at,\n\t\t\t\tviewport = posOptions.viewport,\n\t\t\t\tcontainer = posOptions.container,\n\t\t\t\tadjust = posOptions.adjust,\n\t\t\t\tmethod = adjust.method.split(' '),\n\t\t\t\ttooltipWidth = tooltip.outerWidth(FALSE),\n\t\t\t\ttooltipHeight = tooltip.outerHeight(FALSE),\n\t\t\t\ttargetWidth = 0,\n\t\t\t\ttargetHeight = 0,\n\t\t\t\ttype = tooltip.css('position'),\n\t\t\t\tposition = { left: 0, top: 0 },\n\t\t\t\tvisible = tooltip[0].offsetWidth > 0,\n\t\t\t\tisScroll = event && event.type === 'scroll',\n\t\t\t\twin = $(window),\n\t\t\t\tdoc = container[0].ownerDocument,\n\t\t\t\tmouse = this.mouse,\n\t\t\t\tpluginCalculations, offset, adjusted, newClass;\n\n\t\t\t// Check if absolute position was passed\n\t\t\tif($.isArray(target) && target.length === 2) {\n\t\t\t\t// Force left top and set position\n\t\t\t\tat = { x: LEFT, y: TOP };\n\t\t\t\tposition = { left: target[0], top: target[1] };\n\t\t\t}\n\n\t\t\t// Check if mouse was the target\n\t\t\telse if(target === 'mouse') {\n\t\t\t\t// Force left top to allow flipping\n\t\t\t\tat = { x: LEFT, y: TOP };\n\n\t\t\t\t// Use the mouse origin that caused the show event, if distance hiding is enabled\n\t\t\t\tif((!adjust.mouse || this.options.hide.distance) && cache.origin && cache.origin.pageX) {\n\t\t\t\t\tevent =  cache.origin;\n\t\t\t\t}\n\n\t\t\t\t// Use cached event for resize/scroll events\n\t\t\t\telse if(!event || event && (event.type === 'resize' || event.type === 'scroll')) {\n\t\t\t\t\tevent = cache.event;\n\t\t\t\t}\n\n\t\t\t\t// Otherwise, use the cached mouse coordinates if available\n\t\t\t\telse if(mouse && mouse.pageX) {\n\t\t\t\t\tevent = mouse;\n\t\t\t\t}\n\n\t\t\t\t// Calculate body and container offset and take them into account below\n\t\t\t\tif(type !== 'static') { position = container.offset(); }\n\t\t\t\tif(doc.body.offsetWidth !== (window.innerWidth || doc.documentElement.clientWidth)) {\n\t\t\t\t\toffset = $(document.body).offset();\n\t\t\t\t}\n\n\t\t\t\t// Use event coordinates for position\n\t\t\t\tposition = {\n\t\t\t\t\tleft: event.pageX - position.left + (offset && offset.left || 0),\n\t\t\t\t\ttop: event.pageY - position.top + (offset && offset.top || 0)\n\t\t\t\t};\n\n\t\t\t\t// Scroll events are a pain, some browsers\n\t\t\t\tif(adjust.mouse && isScroll && mouse) {\n\t\t\t\t\tposition.left -= (mouse.scrollX || 0) - win.scrollLeft();\n\t\t\t\t\tposition.top -= (mouse.scrollY || 0) - win.scrollTop();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Target wasn't mouse or absolute...\n\t\t\telse {\n\t\t\t\t// Check if event targetting is being used\n\t\t\t\tif(target === 'event') {\n\t\t\t\t\tif(event && event.target && event.type !== 'scroll' && event.type !== 'resize') {\n\t\t\t\t\t\tcache.target = $(event.target);\n\t\t\t\t\t}\n\t\t\t\t\telse if(!event.target) {\n\t\t\t\t\t\tcache.target = this.elements.target;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if(target !== 'event'){\n\t\t\t\t\tcache.target = $(target.jquery ? target : this.elements.target);\n\t\t\t\t}\n\t\t\t\ttarget = cache.target;\n\n\t\t\t\t// Parse the target into a jQuery object and make sure there's an element present\n\t\t\t\ttarget = $(target).eq(0);\n\t\t\t\tif(target.length === 0) { return this; }\n\n\t\t\t\t// Check if window or document is the target\n\t\t\t\telse if(target[0] === document || target[0] === window) {\n\t\t\t\t\ttargetWidth = BROWSER.iOS ? window.innerWidth : target.width();\n\t\t\t\t\ttargetHeight = BROWSER.iOS ? window.innerHeight : target.height();\n\n\t\t\t\t\tif(target[0] === window) {\n\t\t\t\t\t\tposition = {\n\t\t\t\t\t\t\ttop: (viewport || target).scrollTop(),\n\t\t\t\t\t\t\tleft: (viewport || target).scrollLeft()\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Check if the target is an <AREA> element\n\t\t\t\telse if(PLUGINS.imagemap && target.is('area')) {\n\t\t\t\t\tpluginCalculations = PLUGINS.imagemap(this, target, at, PLUGINS.viewport ? method : FALSE);\n\t\t\t\t}\n\n\t\t\t\t// Check if the target is an SVG element\n\t\t\t\telse if(PLUGINS.svg && target && target[0].ownerSVGElement) {\n\t\t\t\t\tpluginCalculations = PLUGINS.svg(this, target, at, PLUGINS.viewport ? method : FALSE);\n\t\t\t\t}\n\n\t\t\t\t// Otherwise use regular jQuery methods\n\t\t\t\telse {\n\t\t\t\t\ttargetWidth = target.outerWidth(FALSE);\n\t\t\t\t\ttargetHeight = target.outerHeight(FALSE);\n\t\t\t\t\tposition = target.offset();\n\t\t\t\t}\n\n\t\t\t\t// Parse returned plugin values into proper variables\n\t\t\t\tif(pluginCalculations) {\n\t\t\t\t\ttargetWidth = pluginCalculations.width;\n\t\t\t\t\ttargetHeight = pluginCalculations.height;\n\t\t\t\t\toffset = pluginCalculations.offset;\n\t\t\t\t\tposition = pluginCalculations.position;\n\t\t\t\t}\n\n\t\t\t\t// Adjust position to take into account offset parents\n\t\t\t\tposition = this.reposition.offset(target, position, container);\n\n\t\t\t\t// Adjust for position.fixed tooltips (and also iOS scroll bug in v3.2-4.0 & v4.3-4.3.2)\n\t\t\t\tif(BROWSER.iOS > 3.1 && BROWSER.iOS < 4.1 ||\n\t\t\t\t\tBROWSER.iOS >= 4.3 && BROWSER.iOS < 4.33 ||\n\t\t\t\t\t!BROWSER.iOS && type === 'fixed'\n\t\t\t\t){\n\t\t\t\t\tposition.left -= win.scrollLeft();\n\t\t\t\t\tposition.top -= win.scrollTop();\n\t\t\t\t}\n\n\t\t\t\t// Adjust position relative to target\n\t\t\t\tif(!pluginCalculations || pluginCalculations && pluginCalculations.adjustable !== FALSE) {\n\t\t\t\t\tposition.left += at.x === RIGHT ? targetWidth : at.x === CENTER ? targetWidth / 2 : 0;\n\t\t\t\t\tposition.top += at.y === BOTTOM ? targetHeight : at.y === CENTER ? targetHeight / 2 : 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Adjust position relative to tooltip\n\t\t\tposition.left += adjust.x + (my.x === RIGHT ? -tooltipWidth : my.x === CENTER ? -tooltipWidth / 2 : 0);\n\t\t\tposition.top += adjust.y + (my.y === BOTTOM ? -tooltipHeight : my.y === CENTER ? -tooltipHeight / 2 : 0);\n\n\t\t\t// Use viewport adjustment plugin if enabled\n\t\t\tif(PLUGINS.viewport) {\n\t\t\t\tadjusted = position.adjusted = PLUGINS.viewport(\n\t\t\t\t\tthis, position, posOptions, targetWidth, targetHeight, tooltipWidth, tooltipHeight\n\t\t\t\t);\n\n\t\t\t\t// Apply offsets supplied by positioning plugin (if used)\n\t\t\t\tif(offset && adjusted.left) { position.left += offset.left; }\n\t\t\t\tif(offset && adjusted.top) {  position.top += offset.top; }\n\n\t\t\t\t// Apply any new 'my' position\n\t\t\t\tif(adjusted.my) { this.position.my = adjusted.my; }\n\t\t\t}\n\n\t\t\t// Viewport adjustment is disabled, set values to zero\n\t\t\telse { position.adjusted = { left: 0, top: 0 }; }\n\n\t\t\t// Set tooltip position class if it's changed\n\t\t\tif(cache.posClass !== (newClass = this._createPosClass(this.position.my))) {\n\t\t\t\tcache.posClass = newClass;\n\t\t\t\ttooltip.removeClass(cache.posClass).addClass(newClass);\n\t\t\t}\n\n\t\t\t// tooltipmove event\n\t\t\tif(!this._trigger('move', [position, viewport.elem || viewport], event)) { return this; }\n\t\t\tdelete position.adjusted;\n\n\t\t\t// If effect is disabled, target it mouse, no animation is defined or positioning gives NaN out, set CSS directly\n\t\t\tif(effect === FALSE || !visible || isNaN(position.left) || isNaN(position.top) || target === 'mouse' || !$.isFunction(posOptions.effect)) {\n\t\t\t\ttooltip.css(position);\n\t\t\t}\n\n\t\t\t// Use custom function if provided\n\t\t\telse if($.isFunction(posOptions.effect)) {\n\t\t\t\tposOptions.effect.call(tooltip, this, $.extend({}, position));\n\t\t\t\ttooltip.queue(function(next) {\n\t\t\t\t\t// Reset attributes to avoid cross-browser rendering bugs\n\t\t\t\t\t$(this).css({ opacity: '', height: '' });\n\t\t\t\t\tif(BROWSER.ie) { this.style.removeAttribute('filter'); }\n\n\t\t\t\t\tnext();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Set positioning flag\n\t\t\tthis.positioning = FALSE;\n\n\t\t\treturn this;\n\t\t};\n\n// Custom (more correct for qTip!) offset calculator\n\t\tPROTOTYPE.reposition.offset = function(elem, pos, container) {\n\t\t\tif(!container[0]) { return pos; }\n\n\t\t\tvar ownerDocument = $(elem[0].ownerDocument),\n\t\t\t\tquirks = !!BROWSER.ie && document.compatMode !== 'CSS1Compat',\n\t\t\t\tparent = container[0],\n\t\t\t\tscrolled, position, parentOffset, overflow;\n\n\t\t\tfunction scroll(e, i) {\n\t\t\t\tpos.left += i * e.scrollLeft();\n\t\t\t\tpos.top += i * e.scrollTop();\n\t\t\t}\n\n\t\t\t// Compensate for non-static containers offset\n\t\t\tdo {\n\t\t\t\tif((position = $.css(parent, 'position')) !== 'static') {\n\t\t\t\t\tif(position === 'fixed') {\n\t\t\t\t\t\tparentOffset = parent.getBoundingClientRect();\n\t\t\t\t\t\tscroll(ownerDocument, -1);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tparentOffset = $(parent).position();\n\t\t\t\t\t\tparentOffset.left += parseFloat($.css(parent, 'borderLeftWidth')) || 0;\n\t\t\t\t\t\tparentOffset.top += parseFloat($.css(parent, 'borderTopWidth')) || 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tpos.left -= parentOffset.left + (parseFloat($.css(parent, 'marginLeft')) || 0);\n\t\t\t\t\tpos.top -= parentOffset.top + (parseFloat($.css(parent, 'marginTop')) || 0);\n\n\t\t\t\t\t// If this is the first parent element with an overflow of \"scroll\" or \"auto\", store it\n\t\t\t\t\tif(!scrolled && (overflow = $.css(parent, 'overflow')) !== 'hidden' && overflow !== 'visible') { scrolled = $(parent); }\n\t\t\t\t}\n\t\t\t}\n\t\t\twhile(parent = parent.offsetParent);\n\n\t\t\t// Compensate for containers scroll if it also has an offsetParent (or in IE quirks mode)\n\t\t\tif(scrolled && (scrolled[0] !== ownerDocument[0] || quirks)) {\n\t\t\t\tscroll(scrolled, 1);\n\t\t\t}\n\n\t\t\treturn pos;\n\t\t};\n\n// Corner class\n\t\tvar C = (CORNER = PROTOTYPE.reposition.Corner = function(corner, forceY) {\n\t\t\tcorner = ('' + corner).replace(/([A-Z])/, ' $1').replace(/middle/gi, CENTER).toLowerCase();\n\t\t\tthis.x = (corner.match(/left|right/i) || corner.match(/center/) || ['inherit'])[0].toLowerCase();\n\t\t\tthis.y = (corner.match(/top|bottom|center/i) || ['inherit'])[0].toLowerCase();\n\t\t\tthis.forceY = !!forceY;\n\n\t\t\tvar f = corner.charAt(0);\n\t\t\tthis.precedance = f === 't' || f === 'b' ? Y : X;\n\t\t}).prototype;\n\n\t\tC.invert = function(z, center) {\n\t\t\tthis[z] = this[z] === LEFT ? RIGHT : this[z] === RIGHT ? LEFT : center || this[z];\n\t\t};\n\n\t\tC.string = function(join) {\n\t\t\tvar x = this.x, y = this.y;\n\n\t\t\tvar result = x !== y ?\n\t\t\t\tx === 'center' || y !== 'center' && (this.precedance === Y || this.forceY) ?\n\t\t\t\t\t[y,x] :\n\t\t\t\t\t[x,y] :\n\t\t\t\t[x];\n\n\t\t\treturn join !== false ? result.join(' ') : result;\n\t\t};\n\n\t\tC.abbrev = function() {\n\t\t\tvar result = this.string(false);\n\t\t\treturn result[0].charAt(0) + (result[1] && result[1].charAt(0) || '');\n\t\t};\n\n\t\tC.clone = function() {\n\t\t\treturn new CORNER( this.string(), this.forceY );\n\t\t};\n\n\t\t;\n\t\tPROTOTYPE.toggle = function(state, event) {\n\t\t\tvar cache = this.cache,\n\t\t\t\toptions = this.options,\n\t\t\t\ttooltip = this.tooltip;\n\n\t\t\t// Try to prevent flickering when tooltip overlaps show element\n\t\t\tif(event) {\n\t\t\t\tif((/over|enter/).test(event.type) && cache.event && (/out|leave/).test(cache.event.type) &&\n\t\t\t\t\toptions.show.target.add(event.target).length === options.show.target.length &&\n\t\t\t\t\ttooltip.has(event.relatedTarget).length) {\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\n\t\t\t\t// Cache event\n\t\t\t\tcache.event = $.event.fix(event);\n\t\t\t}\n\n\t\t\t// If we're currently waiting and we've just hidden... stop it\n\t\t\tthis.waiting && !state && (this.hiddenDuringWait = TRUE);\n\n\t\t\t// Render the tooltip if showing and it isn't already\n\t\t\tif(!this.rendered) { return state ? this.render(1) : this; }\n\t\t\telse if(this.destroyed || this.disabled) { return this; }\n\n\t\t\tvar type = state ? 'show' : 'hide',\n\t\t\t\topts = this.options[type],\n\t\t\t\tposOptions = this.options.position,\n\t\t\t\tcontentOptions = this.options.content,\n\t\t\t\twidth = this.tooltip.css('width'),\n\t\t\t\tvisible = this.tooltip.is(':visible'),\n\t\t\t\tanimate = state || opts.target.length === 1,\n\t\t\t\tsameTarget = !event || opts.target.length < 2 || cache.target[0] === event.target,\n\t\t\t\tidenticalState, allow, after;\n\n\t\t\t// Detect state if valid one isn't provided\n\t\t\tif((typeof state).search('boolean|number')) { state = !visible; }\n\n\t\t\t// Check if the tooltip is in an identical state to the new would-be state\n\t\t\tidenticalState = !tooltip.is(':animated') && visible === state && sameTarget;\n\n\t\t\t// Fire tooltip(show/hide) event and check if destroyed\n\t\t\tallow = !identicalState ? !!this._trigger(type, [90]) : NULL;\n\n\t\t\t// Check to make sure the tooltip wasn't destroyed in the callback\n\t\t\tif(this.destroyed) { return this; }\n\n\t\t\t// If the user didn't stop the method prematurely and we're showing the tooltip, focus it\n\t\t\tif(allow !== FALSE && state) { this.focus(event); }\n\n\t\t\t// If the state hasn't changed or the user stopped it, return early\n\t\t\tif(!allow || identicalState) { return this; }\n\n\t\t\t// Set ARIA hidden attribute\n\t\t\t$.attr(tooltip[0], 'aria-hidden', !!!state);\n\n\t\t\t// Execute state specific properties\n\t\t\tif(state) {\n\t\t\t\t// Store show origin coordinates\n\t\t\t\tthis.mouse && (cache.origin = $.event.fix(this.mouse));\n\n\t\t\t\t// Update tooltip content & title if it's a dynamic function\n\t\t\t\tif($.isFunction(contentOptions.text)) { this._updateContent(contentOptions.text, FALSE); }\n\t\t\t\tif($.isFunction(contentOptions.title)) { this._updateTitle(contentOptions.title, FALSE); }\n\n\t\t\t\t// Cache mousemove events for positioning purposes (if not already tracking)\n\t\t\t\tif(!trackingBound && posOptions.target === 'mouse' && posOptions.adjust.mouse) {\n\t\t\t\t\t$(document).bind('mousemove.'+NAMESPACE, this._storeMouse);\n\t\t\t\t\ttrackingBound = TRUE;\n\t\t\t\t}\n\n\t\t\t\t// Update the tooltip position (set width first to prevent viewport/max-width issues)\n\t\t\t\tif(!width) { tooltip.css('width', tooltip.outerWidth(FALSE)); }\n\t\t\t\tthis.reposition(event, arguments[2]);\n\t\t\t\tif(!width) { tooltip.css('width', ''); }\n\n\t\t\t\t// Hide other tooltips if tooltip is solo\n\t\t\t\tif(!!opts.solo) {\n\t\t\t\t\t(typeof opts.solo === 'string' ? $(opts.solo) : $(SELECTOR, opts.solo))\n\t\t\t\t\t\t.not(tooltip).not(opts.target).qtip('hide', new $.Event('tooltipsolo'));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Clear show timer if we're hiding\n\t\t\t\tclearTimeout(this.timers.show);\n\n\t\t\t\t// Remove cached origin on hide\n\t\t\t\tdelete cache.origin;\n\n\t\t\t\t// Remove mouse tracking event if not needed (all tracking qTips are hidden)\n\t\t\t\tif(trackingBound && !$(SELECTOR+'[tracking=\"true\"]:visible', opts.solo).not(tooltip).length) {\n\t\t\t\t\t$(document).unbind('mousemove.'+NAMESPACE);\n\t\t\t\t\ttrackingBound = FALSE;\n\t\t\t\t}\n\n\t\t\t\t// Blur the tooltip\n\t\t\t\tthis.blur(event);\n\t\t\t}\n\n\t\t\t// Define post-animation, state specific properties\n\t\t\tafter = $.proxy(function() {\n\t\t\t\tif(state) {\n\t\t\t\t\t// Prevent antialias from disappearing in IE by removing filter\n\t\t\t\t\tif(BROWSER.ie) { tooltip[0].style.removeAttribute('filter'); }\n\n\t\t\t\t\t// Remove overflow setting to prevent tip bugs\n\t\t\t\t\ttooltip.css('overflow', '');\n\n\t\t\t\t\t// Autofocus elements if enabled\n\t\t\t\t\tif('string' === typeof opts.autofocus) {\n\t\t\t\t\t\t$(this.options.show.autofocus, tooltip).focus();\n\t\t\t\t\t}\n\n\t\t\t\t\t// If set, hide tooltip when inactive for delay period\n\t\t\t\t\tthis.options.show.target.trigger('qtip-'+this.id+'-inactive');\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Reset CSS states\n\t\t\t\t\ttooltip.css({\n\t\t\t\t\t\tdisplay: '',\n\t\t\t\t\t\tvisibility: '',\n\t\t\t\t\t\topacity: '',\n\t\t\t\t\t\tleft: '',\n\t\t\t\t\t\ttop: ''\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// tooltipvisible/tooltiphidden events\n\t\t\t\tthis._trigger(state ? 'visible' : 'hidden');\n\t\t\t}, this);\n\n\t\t\t// If no effect type is supplied, use a simple toggle\n\t\t\tif(opts.effect === FALSE || animate === FALSE) {\n\t\t\t\ttooltip[ type ]();\n\t\t\t\tafter();\n\t\t\t}\n\n\t\t\t// Use custom function if provided\n\t\t\telse if($.isFunction(opts.effect)) {\n\t\t\t\ttooltip.stop(1, 1);\n\t\t\t\topts.effect.call(tooltip, this);\n\t\t\t\ttooltip.queue('fx', function(n) {\n\t\t\t\t\tafter(); n();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Use basic fade function by default\n\t\t\telse { tooltip.fadeTo(90, state ? 1 : 0, after); }\n\n\t\t\t// If inactive hide method is set, active it\n\t\t\tif(state) { opts.target.trigger('qtip-'+this.id+'-inactive'); }\n\n\t\t\treturn this;\n\t\t};\n\n\t\tPROTOTYPE.show = function(event) { return this.toggle(TRUE, event); };\n\n\t\tPROTOTYPE.hide = function(event) { return this.toggle(FALSE, event); };\n\t\t;PROTOTYPE.focus = function(event) {\n\t\t\tif(!this.rendered || this.destroyed) { return this; }\n\n\t\t\tvar qtips = $(SELECTOR),\n\t\t\t\ttooltip = this.tooltip,\n\t\t\t\tcurIndex = parseInt(tooltip[0].style.zIndex, 10),\n\t\t\t\tnewIndex = QTIP.zindex + qtips.length;\n\n\t\t\t// Only update the z-index if it has changed and tooltip is not already focused\n\t\t\tif(!tooltip.hasClass(CLASS_FOCUS)) {\n\t\t\t\t// tooltipfocus event\n\t\t\t\tif(this._trigger('focus', [newIndex], event)) {\n\t\t\t\t\t// Only update z-index's if they've changed\n\t\t\t\t\tif(curIndex !== newIndex) {\n\t\t\t\t\t\t// Reduce our z-index's and keep them properly ordered\n\t\t\t\t\t\tqtips.each(function() {\n\t\t\t\t\t\t\tif(this.style.zIndex > curIndex) {\n\t\t\t\t\t\t\t\tthis.style.zIndex = this.style.zIndex - 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// Fire blur event for focused tooltip\n\t\t\t\t\t\tqtips.filter('.' + CLASS_FOCUS).qtip('blur', event);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Set the new z-index\n\t\t\t\t\ttooltip.addClass(CLASS_FOCUS)[0].style.zIndex = newIndex;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this;\n\t\t};\n\n\t\tPROTOTYPE.blur = function(event) {\n\t\t\tif(!this.rendered || this.destroyed) { return this; }\n\n\t\t\t// Set focused status to FALSE\n\t\t\tthis.tooltip.removeClass(CLASS_FOCUS);\n\n\t\t\t// tooltipblur event\n\t\t\tthis._trigger('blur', [ this.tooltip.css('zIndex') ], event);\n\n\t\t\treturn this;\n\t\t};\n\t\t;PROTOTYPE.disable = function(state) {\n\t\t\tif(this.destroyed) { return this; }\n\n\t\t\t// If 'toggle' is passed, toggle the current state\n\t\t\tif(state === 'toggle') {\n\t\t\t\tstate = !(this.rendered ? this.tooltip.hasClass(CLASS_DISABLED) : this.disabled);\n\t\t\t}\n\n\t\t\t// Disable if no state passed\n\t\t\telse if('boolean' !== typeof state) {\n\t\t\t\tstate = TRUE;\n\t\t\t}\n\n\t\t\tif(this.rendered) {\n\t\t\t\tthis.tooltip.toggleClass(CLASS_DISABLED, state)\n\t\t\t\t\t.attr('aria-disabled', state);\n\t\t\t}\n\n\t\t\tthis.disabled = !!state;\n\n\t\t\treturn this;\n\t\t};\n\n\t\tPROTOTYPE.enable = function() { return this.disable(FALSE); };\n\t\t;PROTOTYPE._createButton = function()\n\t\t{\n\t\t\tvar self = this,\n\t\t\t\telements = this.elements,\n\t\t\t\ttooltip = elements.tooltip,\n\t\t\t\tbutton = this.options.content.button,\n\t\t\t\tisString = typeof button === 'string',\n\t\t\t\tclose = isString ? button : 'Close tooltip';\n\n\t\t\tif(elements.button) { elements.button.remove(); }\n\n\t\t\t// Use custom button if one was supplied by user, else use default\n\t\t\tif(button.jquery) {\n\t\t\t\telements.button = button;\n\t\t\t}\n\t\t\telse {\n\t\t\t\telements.button = $('<a />', {\n\t\t\t\t\t'class': 'qtip-close ' + (this.options.style.widget ? '' : NAMESPACE+'-icon'),\n\t\t\t\t\t'title': close,\n\t\t\t\t\t'aria-label': close\n\t\t\t\t})\n\t\t\t\t\t.prepend(\n\t\t\t\t\t\t$('<span />', {\n\t\t\t\t\t\t\t'class': 'ui-icon ui-icon-close',\n\t\t\t\t\t\t\t'html': '&times;'\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Create button and setup attributes\n\t\t\telements.button.appendTo(elements.titlebar || tooltip)\n\t\t\t\t.attr('role', 'button')\n\t\t\t\t.click(function(event) {\n\t\t\t\t\tif(!tooltip.hasClass(CLASS_DISABLED)) { self.hide(event); }\n\t\t\t\t\treturn FALSE;\n\t\t\t\t});\n\t\t};\n\n\t\tPROTOTYPE._updateButton = function(button)\n\t\t{\n\t\t\t// Make sure tooltip is rendered and if not, return\n\t\t\tif(!this.rendered) { return FALSE; }\n\n\t\t\tvar elem = this.elements.button;\n\t\t\tif(button) { this._createButton(); }\n\t\t\telse { elem.remove(); }\n\t\t};\n\t\t;// Widget class creator\n\t\tfunction createWidgetClass(cls) {\n\t\t\treturn WIDGET.concat('').join(cls ? '-'+cls+' ' : ' ');\n\t\t}\n\n// Widget class setter method\n\t\tPROTOTYPE._setWidget = function()\n\t\t{\n\t\t\tvar on = this.options.style.widget,\n\t\t\t\telements = this.elements,\n\t\t\t\ttooltip = elements.tooltip,\n\t\t\t\tdisabled = tooltip.hasClass(CLASS_DISABLED);\n\n\t\t\ttooltip.removeClass(CLASS_DISABLED);\n\t\t\tCLASS_DISABLED = on ? 'ui-state-disabled' : 'qtip-disabled';\n\t\t\ttooltip.toggleClass(CLASS_DISABLED, disabled);\n\n\t\t\ttooltip.toggleClass('ui-helper-reset '+createWidgetClass(), on).toggleClass(CLASS_DEFAULT, this.options.style.def && !on);\n\n\t\t\tif(elements.content) {\n\t\t\t\telements.content.toggleClass( createWidgetClass('content'), on);\n\t\t\t}\n\t\t\tif(elements.titlebar) {\n\t\t\t\telements.titlebar.toggleClass( createWidgetClass('header'), on);\n\t\t\t}\n\t\t\tif(elements.button) {\n\t\t\t\telements.button.toggleClass(NAMESPACE+'-icon', !on);\n\t\t\t}\n\t\t};\n\t\t;function delay(callback, duration) {\n\t\t\t// If tooltip has displayed, start hide timer\n\t\t\tif(duration > 0) {\n\t\t\t\treturn setTimeout(\n\t\t\t\t\t$.proxy(callback, this), duration\n\t\t\t\t);\n\t\t\t}\n\t\t\telse{ callback.call(this); }\n\t\t}\n\n\t\tfunction showMethod(event) {\n\t\t\tif(this.tooltip.hasClass(CLASS_DISABLED)) { return; }\n\n\t\t\t// Clear hide timers\n\t\t\tclearTimeout(this.timers.show);\n\t\t\tclearTimeout(this.timers.hide);\n\n\t\t\t// Start show timer\n\t\t\tthis.timers.show = delay.call(this,\n\t\t\t\tfunction() { this.toggle(TRUE, event); },\n\t\t\t\tthis.options.show.delay\n\t\t\t);\n\t\t}\n\n\t\tfunction hideMethod(event) {\n\t\t\tif(this.tooltip.hasClass(CLASS_DISABLED) || this.destroyed) { return; }\n\n\t\t\t// Check if new target was actually the tooltip element\n\t\t\tvar relatedTarget = $(event.relatedTarget),\n\t\t\t\tontoTooltip = relatedTarget.closest(SELECTOR)[0] === this.tooltip[0],\n\t\t\t\tontoTarget = relatedTarget[0] === this.options.show.target[0];\n\n\t\t\t// Clear timers and stop animation queue\n\t\t\tclearTimeout(this.timers.show);\n\t\t\tclearTimeout(this.timers.hide);\n\n\t\t\t// Prevent hiding if tooltip is fixed and event target is the tooltip.\n\t\t\t// Or if mouse positioning is enabled and cursor momentarily overlaps\n\t\t\tif(this !== relatedTarget[0] &&\n\t\t\t\t(this.options.position.target === 'mouse' && ontoTooltip) ||\n\t\t\t\tthis.options.hide.fixed && (\n\t\t\t\t(/mouse(out|leave|move)/).test(event.type) && (ontoTooltip || ontoTarget))\n\t\t\t)\n\t\t\t{\n\t\t\t\t/* eslint-disable no-empty */\n\t\t\t\ttry {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tevent.stopImmediatePropagation();\n\t\t\t\t} catch(e) {}\n\t\t\t\t/* eslint-enable no-empty */\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If tooltip has displayed, start hide timer\n\t\t\tthis.timers.hide = delay.call(this,\n\t\t\t\tfunction() { this.toggle(FALSE, event); },\n\t\t\t\tthis.options.hide.delay,\n\t\t\t\tthis\n\t\t\t);\n\t\t}\n\n\t\tfunction inactiveMethod(event) {\n\t\t\tif(this.tooltip.hasClass(CLASS_DISABLED) || !this.options.hide.inactive) { return; }\n\n\t\t\t// Clear timer\n\t\t\tclearTimeout(this.timers.inactive);\n\n\t\t\tthis.timers.inactive = delay.call(this,\n\t\t\t\tfunction(){ this.hide(event); },\n\t\t\t\tthis.options.hide.inactive\n\t\t\t);\n\t\t}\n\n\t\tfunction repositionMethod(event) {\n\t\t\tif(this.rendered && this.tooltip[0].offsetWidth > 0) { this.reposition(event); }\n\t\t}\n\n// Store mouse coordinates\n\t\tPROTOTYPE._storeMouse = function(event) {\n\t\t\t(this.mouse = $.event.fix(event)).type = 'mousemove';\n\t\t\treturn this;\n\t\t};\n\n// Bind events\n\t\tPROTOTYPE._bind = function(targets, events, method, suffix, context) {\n\t\t\tif(!targets || !method || !events.length) { return; }\n\t\t\tvar ns = '.' + this._id + (suffix ? '-'+suffix : '');\n\t\t\t$(targets).bind(\n\t\t\t\t(events.split ? events : events.join(ns + ' ')) + ns,\n\t\t\t\t$.proxy(method, context || this)\n\t\t\t);\n\t\t\treturn this;\n\t\t};\n\t\tPROTOTYPE._unbind = function(targets, suffix) {\n\t\t\ttargets && $(targets).unbind('.' + this._id + (suffix ? '-'+suffix : ''));\n\t\t\treturn this;\n\t\t};\n\n// Global delegation helper\n\t\tfunction delegate(selector, events, method) {\n\t\t\t$(document.body).delegate(selector,\n\t\t\t\t(events.split ? events : events.join('.'+NAMESPACE + ' ')) + '.'+NAMESPACE,\n\t\t\t\tfunction() {\n\t\t\t\t\tvar api = QTIP.api[ $.attr(this, ATTR_ID) ];\n\t\t\t\t\tapi && !api.disabled && method.apply(api, arguments);\n\t\t\t\t}\n\t\t\t);\n\t\t}\n// Event trigger\n\t\tPROTOTYPE._trigger = function(type, args, event) {\n\t\t\tvar callback = new $.Event('tooltip'+type);\n\t\t\tcallback.originalEvent = event && $.extend({}, event) || this.cache.event || NULL;\n\n\t\t\tthis.triggering = type;\n\t\t\tthis.tooltip.trigger(callback, [this].concat(args || []));\n\t\t\tthis.triggering = FALSE;\n\n\t\t\treturn !callback.isDefaultPrevented();\n\t\t};\n\n\t\tPROTOTYPE._bindEvents = function(showEvents, hideEvents, showTargets, hideTargets, showCallback, hideCallback) {\n\t\t\t// Get tasrgets that lye within both\n\t\t\tvar similarTargets = showTargets.filter( hideTargets ).add( hideTargets.filter(showTargets) ),\n\t\t\t\ttoggleEvents = [];\n\n\t\t\t// If hide and show targets are the same...\n\t\t\tif(similarTargets.length) {\n\n\t\t\t\t// Filter identical show/hide events\n\t\t\t\t$.each(hideEvents, function(i, type) {\n\t\t\t\t\tvar showIndex = $.inArray(type, showEvents);\n\n\t\t\t\t\t// Both events are identical, remove from both hide and show events\n\t\t\t\t\t// and append to toggleEvents\n\t\t\t\t\tshowIndex > -1 && toggleEvents.push( showEvents.splice( showIndex, 1 )[0] );\n\t\t\t\t});\n\n\t\t\t\t// Toggle events are special case of identical show/hide events, which happen in sequence\n\t\t\t\tif(toggleEvents.length) {\n\t\t\t\t\t// Bind toggle events to the similar targets\n\t\t\t\t\tthis._bind(similarTargets, toggleEvents, function(event) {\n\t\t\t\t\t\tvar state = this.rendered ? this.tooltip[0].offsetWidth > 0 : false;\n\t\t\t\t\t\t(state ? hideCallback : showCallback).call(this, event);\n\t\t\t\t\t});\n\n\t\t\t\t\t// Remove the similar targets from the regular show/hide bindings\n\t\t\t\t\tshowTargets = showTargets.not(similarTargets);\n\t\t\t\t\thideTargets = hideTargets.not(similarTargets);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Apply show/hide/toggle events\n\t\t\tthis._bind(showTargets, showEvents, showCallback);\n\t\t\tthis._bind(hideTargets, hideEvents, hideCallback);\n\t\t};\n\n\t\tPROTOTYPE._assignInitialEvents = function(event) {\n\t\t\tvar options = this.options,\n\t\t\t\tshowTarget = options.show.target,\n\t\t\t\thideTarget = options.hide.target,\n\t\t\t\tshowEvents = options.show.event ? $.trim('' + options.show.event).split(' ') : [],\n\t\t\t\thideEvents = options.hide.event ? $.trim('' + options.hide.event).split(' ') : [];\n\n\t\t\t// Catch remove/removeqtip events on target element to destroy redundant tooltips\n\t\t\tthis._bind(this.elements.target, ['remove', 'removeqtip'], function() {\n\t\t\t\tthis.destroy(true);\n\t\t\t}, 'destroy');\n\n\t\t\t/*\n\t\t\t * Make sure hoverIntent functions properly by using mouseleave as a hide event if\n\t\t\t * mouseenter/mouseout is used for show.event, even if it isn't in the users options.\n\t\t\t */\n\t\t\tif(/mouse(over|enter)/i.test(options.show.event) && !/mouse(out|leave)/i.test(options.hide.event)) {\n\t\t\t\thideEvents.push('mouseleave');\n\t\t\t}\n\n\t\t\t/*\n\t\t\t * Also make sure initial mouse targetting works correctly by caching mousemove coords\n\t\t\t * on show targets before the tooltip has rendered. Also set onTarget when triggered to\n\t\t\t * keep mouse tracking working.\n\t\t\t */\n\t\t\tthis._bind(showTarget, 'mousemove', function(moveEvent) {\n\t\t\t\tthis._storeMouse(moveEvent);\n\t\t\t\tthis.cache.onTarget = TRUE;\n\t\t\t});\n\n\t\t\t// Define hoverIntent function\n\t\t\tfunction hoverIntent(hoverEvent) {\n\t\t\t\t// Only continue if tooltip isn't disabled\n\t\t\t\tif(this.disabled || this.destroyed) { return FALSE; }\n\n\t\t\t\t// Cache the event data\n\t\t\t\tthis.cache.event = hoverEvent && $.event.fix(hoverEvent);\n\t\t\t\tthis.cache.target = hoverEvent && $(hoverEvent.target);\n\n\t\t\t\t// Start the event sequence\n\t\t\t\tclearTimeout(this.timers.show);\n\t\t\t\tthis.timers.show = delay.call(this,\n\t\t\t\t\tfunction() { this.render(typeof hoverEvent === 'object' || options.show.ready); },\n\t\t\t\t\toptions.prerender ? 0 : options.show.delay\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Filter and bind events\n\t\t\tthis._bindEvents(showEvents, hideEvents, showTarget, hideTarget, hoverIntent, function() {\n\t\t\t\tif(!this.timers) { return FALSE; }\n\t\t\t\tclearTimeout(this.timers.show);\n\t\t\t});\n\n\t\t\t// Prerendering is enabled, create tooltip now\n\t\t\tif(options.show.ready || options.prerender) { hoverIntent.call(this, event); }\n\t\t};\n\n// Event assignment method\n\t\tPROTOTYPE._assignEvents = function() {\n\t\t\tvar self = this,\n\t\t\t\toptions = this.options,\n\t\t\t\tposOptions = options.position,\n\n\t\t\t\ttooltip = this.tooltip,\n\t\t\t\tshowTarget = options.show.target,\n\t\t\t\thideTarget = options.hide.target,\n\t\t\t\tcontainerTarget = posOptions.container,\n\t\t\t\tviewportTarget = posOptions.viewport,\n\t\t\t\tdocumentTarget = $(document),\n\t\t\t\twindowTarget = $(window),\n\n\t\t\t\tshowEvents = options.show.event ? $.trim('' + options.show.event).split(' ') : [],\n\t\t\t\thideEvents = options.hide.event ? $.trim('' + options.hide.event).split(' ') : [];\n\n\n\t\t\t// Assign passed event callbacks\n\t\t\t$.each(options.events, function(name, callback) {\n\t\t\t\tself._bind(tooltip, name === 'toggle' ? ['tooltipshow','tooltiphide'] : ['tooltip'+name], callback, null, tooltip);\n\t\t\t});\n\n\t\t\t// Hide tooltips when leaving current window/frame (but not select/option elements)\n\t\t\tif(/mouse(out|leave)/i.test(options.hide.event) && options.hide.leave === 'window') {\n\t\t\t\tthis._bind(documentTarget, ['mouseout', 'blur'], function(event) {\n\t\t\t\t\tif(!/select|option/.test(event.target.nodeName) && !event.relatedTarget) {\n\t\t\t\t\t\tthis.hide(event);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Enable hide.fixed by adding appropriate class\n\t\t\tif(options.hide.fixed) {\n\t\t\t\thideTarget = hideTarget.add( tooltip.addClass(CLASS_FIXED) );\n\t\t\t}\n\n\t\t\t/*\n\t\t\t * Make sure hoverIntent functions properly by using mouseleave to clear show timer if\n\t\t\t * mouseenter/mouseout is used for show.event, even if it isn't in the users options.\n\t\t\t */\n\t\t\telse if(/mouse(over|enter)/i.test(options.show.event)) {\n\t\t\t\tthis._bind(hideTarget, 'mouseleave', function() {\n\t\t\t\t\tclearTimeout(this.timers.show);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Hide tooltip on document mousedown if unfocus events are enabled\n\t\t\tif(('' + options.hide.event).indexOf('unfocus') > -1) {\n\t\t\t\tthis._bind(containerTarget.closest('html'), ['mousedown', 'touchstart'], function(event) {\n\t\t\t\t\tvar elem = $(event.target),\n\t\t\t\t\t\tenabled = this.rendered && !this.tooltip.hasClass(CLASS_DISABLED) && this.tooltip[0].offsetWidth > 0,\n\t\t\t\t\t\tisAncestor = elem.parents(SELECTOR).filter(this.tooltip[0]).length > 0;\n\n\t\t\t\t\tif(elem[0] !== this.target[0] && elem[0] !== this.tooltip[0] && !isAncestor &&\n\t\t\t\t\t\t!this.target.has(elem[0]).length && enabled\n\t\t\t\t\t) {\n\t\t\t\t\t\tthis.hide(event);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Check if the tooltip hides when inactive\n\t\t\tif('number' === typeof options.hide.inactive) {\n\t\t\t\t// Bind inactive method to show target(s) as a custom event\n\t\t\t\tthis._bind(showTarget, 'qtip-'+this.id+'-inactive', inactiveMethod, 'inactive');\n\n\t\t\t\t// Define events which reset the 'inactive' event handler\n\t\t\t\tthis._bind(hideTarget.add(tooltip), QTIP.inactiveEvents, inactiveMethod);\n\t\t\t}\n\n\t\t\t// Filter and bind events\n\t\t\tthis._bindEvents(showEvents, hideEvents, showTarget, hideTarget, showMethod, hideMethod);\n\n\t\t\t// Mouse movement bindings\n\t\t\tthis._bind(showTarget.add(tooltip), 'mousemove', function(event) {\n\t\t\t\t// Check if the tooltip hides when mouse is moved a certain distance\n\t\t\t\tif('number' === typeof options.hide.distance) {\n\t\t\t\t\tvar origin = this.cache.origin || {},\n\t\t\t\t\t\tlimit = this.options.hide.distance,\n\t\t\t\t\t\tabs = Math.abs;\n\n\t\t\t\t\t// Check if the movement has gone beyond the limit, and hide it if so\n\t\t\t\t\tif(abs(event.pageX - origin.pageX) >= limit || abs(event.pageY - origin.pageY) >= limit) {\n\t\t\t\t\t\tthis.hide(event);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Cache mousemove coords on show targets\n\t\t\t\tthis._storeMouse(event);\n\t\t\t});\n\n\t\t\t// Mouse positioning events\n\t\t\tif(posOptions.target === 'mouse') {\n\t\t\t\t// If mouse adjustment is on...\n\t\t\t\tif(posOptions.adjust.mouse) {\n\t\t\t\t\t// Apply a mouseleave event so we don't get problems with overlapping\n\t\t\t\t\tif(options.hide.event) {\n\t\t\t\t\t\t// Track if we're on the target or not\n\t\t\t\t\t\tthis._bind(showTarget, ['mouseenter', 'mouseleave'], function(event) {\n\t\t\t\t\t\t\tif(!this.cache) {return FALSE; }\n\t\t\t\t\t\t\tthis.cache.onTarget = event.type === 'mouseenter';\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update tooltip position on mousemove\n\t\t\t\t\tthis._bind(documentTarget, 'mousemove', function(event) {\n\t\t\t\t\t\t// Update the tooltip position only if the tooltip is visible and adjustment is enabled\n\t\t\t\t\t\tif(this.rendered && this.cache.onTarget && !this.tooltip.hasClass(CLASS_DISABLED) && this.tooltip[0].offsetWidth > 0) {\n\t\t\t\t\t\t\tthis.reposition(event);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Adjust positions of the tooltip on window resize if enabled\n\t\t\tif(posOptions.adjust.resize || viewportTarget.length) {\n\t\t\t\tthis._bind( $.event.special.resize ? viewportTarget : windowTarget, 'resize', repositionMethod );\n\t\t\t}\n\n\t\t\t// Adjust tooltip position on scroll of the window or viewport element if present\n\t\t\tif(posOptions.adjust.scroll) {\n\t\t\t\tthis._bind( windowTarget.add(posOptions.container), 'scroll', repositionMethod );\n\t\t\t}\n\t\t};\n\n// Un-assignment method\n\t\tPROTOTYPE._unassignEvents = function() {\n\t\t\tvar options = this.options,\n\t\t\t\tshowTargets = options.show.target,\n\t\t\t\thideTargets = options.hide.target,\n\t\t\t\ttargets = $.grep([\n\t\t\t\t\tthis.elements.target[0],\n\t\t\t\t\tthis.rendered && this.tooltip[0],\n\t\t\t\t\toptions.position.container[0],\n\t\t\t\t\toptions.position.viewport[0],\n\t\t\t\t\toptions.position.container.closest('html')[0], // unfocus\n\t\t\t\t\twindow,\n\t\t\t\t\tdocument\n\t\t\t\t], function(i) {\n\t\t\t\t\treturn typeof i === 'object';\n\t\t\t\t});\n\n\t\t\t// Add show and hide targets if they're valid\n\t\t\tif(showTargets && showTargets.toArray) {\n\t\t\t\ttargets = targets.concat(showTargets.toArray());\n\t\t\t}\n\t\t\tif(hideTargets && hideTargets.toArray) {\n\t\t\t\ttargets = targets.concat(hideTargets.toArray());\n\t\t\t}\n\n\t\t\t// Unbind the events\n\t\t\tthis._unbind(targets)\n\t\t\t\t._unbind(targets, 'destroy')\n\t\t\t\t._unbind(targets, 'inactive');\n\t\t};\n\n// Apply common event handlers using delegate (avoids excessive .bind calls!)\n\t\t$(function() {\n\t\t\tdelegate(SELECTOR, ['mouseenter', 'mouseleave'], function(event) {\n\t\t\t\tvar state = event.type === 'mouseenter',\n\t\t\t\t\ttooltip = $(event.currentTarget),\n\t\t\t\t\ttarget = $(event.relatedTarget || event.target),\n\t\t\t\t\toptions = this.options;\n\n\t\t\t\t// On mouseenter...\n\t\t\t\tif(state) {\n\t\t\t\t\t// Focus the tooltip on mouseenter (z-index stacking)\n\t\t\t\t\tthis.focus(event);\n\n\t\t\t\t\t// Clear hide timer on tooltip hover to prevent it from closing\n\t\t\t\t\ttooltip.hasClass(CLASS_FIXED) && !tooltip.hasClass(CLASS_DISABLED) && clearTimeout(this.timers.hide);\n\t\t\t\t}\n\n\t\t\t\t// On mouseleave...\n\t\t\t\telse {\n\t\t\t\t\t// When mouse tracking is enabled, hide when we leave the tooltip and not onto the show target (if a hide event is set)\n\t\t\t\t\tif(options.position.target === 'mouse' && options.position.adjust.mouse &&\n\t\t\t\t\t\toptions.hide.event && options.show.target && !target.closest(options.show.target[0]).length) {\n\t\t\t\t\t\tthis.hide(event);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Add hover class\n\t\t\t\ttooltip.toggleClass(CLASS_HOVER, state);\n\t\t\t});\n\n\t\t\t// Define events which reset the 'inactive' event handler\n\t\t\tdelegate('['+ATTR_ID+']', INACTIVE_EVENTS, inactiveMethod);\n\t\t});\n\t\t;// Initialization method\n\t\tfunction init(elem, id, opts) {\n\t\t\tvar obj, posOptions, attr, config, title,\n\n\t\t\t\t// Setup element references\n\t\t\t\tdocBody = $(document.body),\n\n\t\t\t\t// Use document body instead of document element if needed\n\t\t\t\tnewTarget = elem[0] === document ? docBody : elem,\n\n\t\t\t\t// Grab metadata from element if plugin is present\n\t\t\t\tmetadata = elem.metadata ? elem.metadata(opts.metadata) : NULL,\n\n\t\t\t\t// If metadata type if HTML5, grab 'name' from the object instead, or use the regular data object otherwise\n\t\t\t\tmetadata5 = opts.metadata.type === 'html5' && metadata ? metadata[opts.metadata.name] : NULL,\n\n\t\t\t\t// Grab data from metadata.name (or data-qtipopts as fallback) using .data() method,\n\t\t\t\thtml5 = elem.data(opts.metadata.name || 'qtipopts');\n\n\t\t\t// If we don't get an object returned attempt to parse it manualyl without parseJSON\n\t\t\t/* eslint-disable no-empty */\n\t\t\ttry { html5 = typeof html5 === 'string' ? $.parseJSON(html5) : html5; }\n\t\t\tcatch(e) {}\n\t\t\t/* eslint-enable no-empty */\n\n\t\t\t// Merge in and sanitize metadata\n\t\t\tconfig = $.extend(TRUE, {}, QTIP.defaults, opts,\n\t\t\t\ttypeof html5 === 'object' ? sanitizeOptions(html5) : NULL,\n\t\t\t\tsanitizeOptions(metadata5 || metadata));\n\n\t\t\t// Re-grab our positioning options now we've merged our metadata and set id to passed value\n\t\t\tposOptions = config.position;\n\t\t\tconfig.id = id;\n\n\t\t\t// Setup missing content if none is detected\n\t\t\tif('boolean' === typeof config.content.text) {\n\t\t\t\tattr = elem.attr(config.content.attr);\n\n\t\t\t\t// Grab from supplied attribute if available\n\t\t\t\tif(config.content.attr !== FALSE && attr) { config.content.text = attr; }\n\n\t\t\t\t// No valid content was found, abort render\n\t\t\t\telse { return FALSE; }\n\t\t\t}\n\n\t\t\t// Setup target options\n\t\t\tif(!posOptions.container.length) { posOptions.container = docBody; }\n\t\t\tif(posOptions.target === FALSE) { posOptions.target = newTarget; }\n\t\t\tif(config.show.target === FALSE) { config.show.target = newTarget; }\n\t\t\tif(config.show.solo === TRUE) { config.show.solo = posOptions.container.closest('body'); }\n\t\t\tif(config.hide.target === FALSE) { config.hide.target = newTarget; }\n\t\t\tif(config.position.viewport === TRUE) { config.position.viewport = posOptions.container; }\n\n\t\t\t// Ensure we only use a single container\n\t\t\tposOptions.container = posOptions.container.eq(0);\n\n\t\t\t// Convert position corner values into x and y strings\n\t\t\tposOptions.at = new CORNER(posOptions.at, TRUE);\n\t\t\tposOptions.my = new CORNER(posOptions.my);\n\n\t\t\t// Destroy previous tooltip if overwrite is enabled, or skip element if not\n\t\t\tif(elem.data(NAMESPACE)) {\n\t\t\t\tif(config.overwrite) {\n\t\t\t\t\telem.qtip('destroy', true);\n\t\t\t\t}\n\t\t\t\telse if(config.overwrite === FALSE) {\n\t\t\t\t\treturn FALSE;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add has-qtip attribute\n\t\t\telem.attr(ATTR_HAS, id);\n\n\t\t\t// Remove title attribute and store it if present\n\t\t\tif(config.suppress && (title = elem.attr('title'))) {\n\t\t\t\t// Final attr call fixes event delegatiom and IE default tooltip showing problem\n\t\t\t\telem.removeAttr('title').attr(oldtitle, title).attr('title', '');\n\t\t\t}\n\n\t\t\t// Initialize the tooltip and add API reference\n\t\t\tobj = new QTip(elem, config, id, !!attr);\n\t\t\telem.data(NAMESPACE, obj);\n\n\t\t\treturn obj;\n\t\t}\n\n// jQuery $.fn extension method\n\t\tQTIP = $.fn.qtip = function(options, notation, newValue)\n\t\t{\n\t\t\tvar command = ('' + options).toLowerCase(), // Parse command\n\t\t\t\treturned = NULL,\n\t\t\t\targs = $.makeArray(arguments).slice(1),\n\t\t\t\tevent = args[args.length - 1],\n\t\t\t\topts = this[0] ? $.data(this[0], NAMESPACE) : NULL;\n\n\t\t\t// Check for API request\n\t\t\tif(!arguments.length && opts || command === 'api') {\n\t\t\t\treturn opts;\n\t\t\t}\n\n\t\t\t// Execute API command if present\n\t\t\telse if('string' === typeof options) {\n\t\t\t\tthis.each(function() {\n\t\t\t\t\tvar api = $.data(this, NAMESPACE);\n\t\t\t\t\tif(!api) { return TRUE; }\n\n\t\t\t\t\t// Cache the event if possible\n\t\t\t\t\tif(event && event.timeStamp) { api.cache.event = event; }\n\n\t\t\t\t\t// Check for specific API commands\n\t\t\t\t\tif(notation && (command === 'option' || command === 'options')) {\n\t\t\t\t\t\tif(newValue !== undefined || $.isPlainObject(notation)) {\n\t\t\t\t\t\t\tapi.set(notation, newValue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\treturned = api.get(notation);\n\t\t\t\t\t\t\treturn FALSE;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Execute API command\n\t\t\t\t\telse if(api[command]) {\n\t\t\t\t\t\tapi[command].apply(api, args);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\treturn returned !== NULL ? returned : this;\n\t\t\t}\n\n\t\t\t// No API commands. validate provided options and setup qTips\n\t\t\telse if('object' === typeof options || !arguments.length) {\n\t\t\t\t// Sanitize options first\n\t\t\t\topts = sanitizeOptions($.extend(TRUE, {}, options));\n\n\t\t\t\treturn this.each(function(i) {\n\t\t\t\t\tvar api, id;\n\n\t\t\t\t\t// Find next available ID, or use custom ID if provided\n\t\t\t\t\tid = $.isArray(opts.id) ? opts.id[i] : opts.id;\n\t\t\t\t\tid = !id || id === FALSE || id.length < 1 || QTIP.api[id] ? QTIP.nextid++ : id;\n\n\t\t\t\t\t// Initialize the qTip and re-grab newly sanitized options\n\t\t\t\t\tapi = init($(this), id, opts);\n\t\t\t\t\tif(api === FALSE) { return TRUE; }\n\t\t\t\t\telse { QTIP.api[id] = api; }\n\n\t\t\t\t\t// Initialize plugins\n\t\t\t\t\t$.each(PLUGINS, function() {\n\t\t\t\t\t\tif(this.initialize === 'initialize') { this(api); }\n\t\t\t\t\t});\n\n\t\t\t\t\t// Assign initial pre-render events\n\t\t\t\t\tapi._assignInitialEvents(event);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n// Expose class\n\t\t$.qtip = QTip;\n\n// Populated in render method\n\t\tQTIP.api = {};\n\t\t;$.each({\n\t\t\t/* Allow other plugins to successfully retrieve the title of an element with a qTip applied */\n\t\t\tattr: function(attr, val) {\n\t\t\t\tif(this.length) {\n\t\t\t\t\tvar self = this[0],\n\t\t\t\t\t\ttitle = 'title',\n\t\t\t\t\t\tapi = $.data(self, 'qtip');\n\n\t\t\t\t\tif(attr === title && api && api.options && 'object' === typeof api && 'object' === typeof api.options && api.options.suppress) {\n\t\t\t\t\t\tif(arguments.length < 2) {\n\t\t\t\t\t\t\treturn $.attr(self, oldtitle);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// If qTip is rendered and title was originally used as content, update it\n\t\t\t\t\t\tif(api && api.options.content.attr === title && api.cache.attr) {\n\t\t\t\t\t\t\tapi.set('content.text', val);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Use the regular attr method to set, then cache the result\n\t\t\t\t\t\treturn this.attr(oldtitle, val);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn $.fn['attr'+replaceSuffix].apply(this, arguments);\n\t\t\t},\n\n\t\t\t/* Allow clone to correctly retrieve cached title attributes */\n\t\t\tclone: function(keepData) {\n\t\t\t\t// Clone our element using the real clone method\n\t\t\t\tvar elems = $.fn['clone'+replaceSuffix].apply(this, arguments);\n\n\t\t\t\t// Grab all elements with an oldtitle set, and change it to regular title attribute, if keepData is false\n\t\t\t\tif(!keepData) {\n\t\t\t\t\telems.filter('['+oldtitle+']').attr('title', function() {\n\t\t\t\t\t\treturn $.attr(this, oldtitle);\n\t\t\t\t\t})\n\t\t\t\t\t\t.removeAttr(oldtitle);\n\t\t\t\t}\n\n\t\t\t\treturn elems;\n\t\t\t}\n\t\t}, function(name, func) {\n\t\t\tif(!func || $.fn[name+replaceSuffix]) { return TRUE; }\n\n\t\t\tvar old = $.fn[name+replaceSuffix] = $.fn[name];\n\t\t\t$.fn[name] = function() {\n\t\t\t\treturn func.apply(this, arguments) || old.apply(this, arguments);\n\t\t\t};\n\t\t});\n\n\t\t/* Fire off 'removeqtip' handler in $.cleanData if jQuery UI not present (it already does similar).\n\t\t * This snippet is taken directly from jQuery UI source code found here:\n\t\t *     http://code.jquery.com/ui/jquery-ui-git.js\n\t\t */\n\t\tif(!$.ui) {\n\t\t\t$['cleanData'+replaceSuffix] = $.cleanData;\n\t\t\t$.cleanData = function( elems ) {\n\t\t\t\tfor(var i = 0, elem; (elem = $( elems[i] )).length; i++) {\n\t\t\t\t\tif(elem.attr(ATTR_HAS)) {\n\t\t\t\t\t\t/* eslint-disable no-empty */\n\t\t\t\t\t\ttry { elem.triggerHandler('removeqtip'); }\n\t\t\t\t\t\tcatch( e ) {}\n\t\t\t\t\t\t/* eslint-enable no-empty */\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$['cleanData'+replaceSuffix].apply(this, arguments);\n\t\t\t};\n\t\t}\n\t\t;// qTip version\n\t\tQTIP.version = '3.0.3';\n\n// Base ID for all qTips\n\t\tQTIP.nextid = 0;\n\n// Inactive events array\n\t\tQTIP.inactiveEvents = INACTIVE_EVENTS;\n\n// Base z-index for all qTips\n\t\tQTIP.zindex = 15000;\n\n// Define configuration defaults\n\t\tQTIP.defaults = {\n\t\t\tprerender: FALSE,\n\t\t\tid: FALSE,\n\t\t\toverwrite: TRUE,\n\t\t\tsuppress: TRUE,\n\t\t\tcontent: {\n\t\t\t\ttext: TRUE,\n\t\t\t\tattr: 'title',\n\t\t\t\ttitle: FALSE,\n\t\t\t\tbutton: FALSE\n\t\t\t},\n\t\t\tposition: {\n\t\t\t\tmy: 'top left',\n\t\t\t\tat: 'bottom right',\n\t\t\t\ttarget: FALSE,\n\t\t\t\tcontainer: FALSE,\n\t\t\t\tviewport: FALSE,\n\t\t\t\tadjust: {\n\t\t\t\t\tx: 0, y: 0,\n\t\t\t\t\tmouse: TRUE,\n\t\t\t\t\tscroll: TRUE,\n\t\t\t\t\tresize: TRUE,\n\t\t\t\t\tmethod: 'flipinvert flipinvert'\n\t\t\t\t},\n\t\t\t\teffect: function(api, pos) {\n\t\t\t\t\t$(this).animate(pos, {\n\t\t\t\t\t\tduration: 200,\n\t\t\t\t\t\tqueue: FALSE\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\tshow: {\n\t\t\t\ttarget: FALSE,\n\t\t\t\tevent: 'mouseenter',\n\t\t\t\teffect: TRUE,\n\t\t\t\tdelay: 90,\n\t\t\t\tsolo: FALSE,\n\t\t\t\tready: FALSE,\n\t\t\t\tautofocus: FALSE\n\t\t\t},\n\t\t\thide: {\n\t\t\t\ttarget: FALSE,\n\t\t\t\tevent: 'mouseleave',\n\t\t\t\teffect: TRUE,\n\t\t\t\tdelay: 0,\n\t\t\t\tfixed: FALSE,\n\t\t\t\tinactive: FALSE,\n\t\t\t\tleave: 'window',\n\t\t\t\tdistance: FALSE\n\t\t\t},\n\t\t\tstyle: {\n\t\t\t\tclasses: '',\n\t\t\t\twidget: FALSE,\n\t\t\t\twidth: FALSE,\n\t\t\t\theight: FALSE,\n\t\t\t\tdef: TRUE\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\trender: NULL,\n\t\t\t\tmove: NULL,\n\t\t\t\tshow: NULL,\n\t\t\t\thide: NULL,\n\t\t\t\ttoggle: NULL,\n\t\t\t\tvisible: NULL,\n\t\t\t\thidden: NULL,\n\t\t\t\tfocus: NULL,\n\t\t\t\tblur: NULL\n\t\t\t}\n\t\t};\n\t\t;var TIP,\n\t\t\tcreateVML,\n\t\t\tSCALE,\n\t\t\tPIXEL_RATIO,\n\t\t\tBACKING_STORE_RATIO,\n\n// Common CSS strings\n\t\t\tMARGIN = 'margin',\n\t\t\tBORDER = 'border',\n\t\t\tCOLOR = 'color',\n\t\t\tBG_COLOR = 'background-color',\n\t\t\tTRANSPARENT = 'transparent',\n\t\t\tIMPORTANT = ' !important',\n\n// Check if the browser supports <canvas/> elements\n\t\t\tHASCANVAS = !!document.createElement('canvas').getContext,\n\n// Invalid colour values used in parseColours()\n\t\t\tINVALID = /rgba?\\(0, 0, 0(, 0)?\\)|transparent|#123456/i;\n\n// Camel-case method, taken from jQuery source\n// http://code.jquery.com/jquery-1.8.0.js\n\t\tfunction camel(s) { return s.charAt(0).toUpperCase() + s.slice(1); }\n\n\t\t/*\n\t\t * Modified from Modernizr's testPropsAll()\n\t\t * http://modernizr.com/downloads/modernizr-latest.js\n\t\t */\n\t\tvar cssProps = {}, cssPrefixes = ['Webkit', 'O', 'Moz', 'ms'];\n\t\tfunction vendorCss(elem, prop) {\n\t\t\tvar ucProp = prop.charAt(0).toUpperCase() + prop.slice(1),\n\t\t\t\tprops = (prop + ' ' + cssPrefixes.join(ucProp + ' ') + ucProp).split(' '),\n\t\t\t\tcur, val, i = 0;\n\n\t\t\t// If the property has already been mapped...\n\t\t\tif(cssProps[prop]) { return elem.css(cssProps[prop]); }\n\n\t\t\twhile(cur = props[i++]) {\n\t\t\t\tif((val = elem.css(cur)) !== undefined) {\n\t\t\t\t\tcssProps[prop] = cur;\n\t\t\t\t\treturn val;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n// Parse a given elements CSS property into an int\n\t\tfunction intCss(elem, prop) {\n\t\t\treturn Math.ceil(parseFloat(vendorCss(elem, prop)));\n\t\t}\n\n\n// VML creation (for IE only)\n\t\tif(!HASCANVAS) {\n\t\t\tcreateVML = function(tag, props, style) {\n\t\t\t\treturn '<qtipvml:'+tag+' xmlns=\"urn:schemas-microsoft.com:vml\" class=\"qtip-vml\" '+(props||'')+\n\t\t\t\t\t' style=\"behavior: url(#default#VML); '+(style||'')+ '\" />';\n\t\t\t};\n\t\t}\n\n// Canvas only definitions\n\t\telse {\n\t\t\tPIXEL_RATIO = window.devicePixelRatio || 1;\n\t\t\tBACKING_STORE_RATIO = (function() {\n\t\t\t\tvar context = document.createElement('canvas').getContext('2d');\n\t\t\t\treturn context.backingStorePixelRatio || context.webkitBackingStorePixelRatio || context.mozBackingStorePixelRatio ||\n\t\t\t\t\tcontext.msBackingStorePixelRatio || context.oBackingStorePixelRatio || 1;\n\t\t\t})();\n\t\t\tSCALE = PIXEL_RATIO / BACKING_STORE_RATIO;\n\t\t}\n\n\n\t\tfunction Tip(qtip, options) {\n\t\t\tthis._ns = 'tip';\n\t\t\tthis.options = options;\n\t\t\tthis.offset = options.offset;\n\t\t\tthis.size = [ options.width, options.height ];\n\n\t\t\t// Initialize\n\t\t\tthis.qtip = qtip;\n\t\t\tthis.init(qtip);\n\t\t}\n\n\t\t$.extend(Tip.prototype, {\n\t\t\tinit: function(qtip) {\n\t\t\t\tvar context, tip;\n\n\t\t\t\t// Create tip element and prepend to the tooltip\n\t\t\t\ttip = this.element = qtip.elements.tip = $('<div />', { 'class': NAMESPACE+'-tip' }).prependTo(qtip.tooltip);\n\n\t\t\t\t// Create tip drawing element(s)\n\t\t\t\tif(HASCANVAS) {\n\t\t\t\t\t// save() as soon as we create the canvas element so FF2 doesn't bork on our first restore()!\n\t\t\t\t\tcontext = $('<canvas />').appendTo(this.element)[0].getContext('2d');\n\n\t\t\t\t\t// Setup constant parameters\n\t\t\t\t\tcontext.lineJoin = 'miter';\n\t\t\t\t\tcontext.miterLimit = 100000;\n\t\t\t\t\tcontext.save();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tcontext = createVML('shape', 'coordorigin=\"0,0\"', 'position:absolute;');\n\t\t\t\t\tthis.element.html(context + context);\n\n\t\t\t\t\t// Prevent mousing down on the tip since it causes problems with .live() handling in IE due to VML\n\t\t\t\t\tqtip._bind( $('*', tip).add(tip), ['click', 'mousedown'], function(event) { event.stopPropagation(); }, this._ns);\n\t\t\t\t}\n\n\t\t\t\t// Bind update events\n\t\t\t\tqtip._bind(qtip.tooltip, 'tooltipmove', this.reposition, this._ns, this);\n\n\t\t\t\t// Create it\n\t\t\t\tthis.create();\n\t\t\t},\n\n\t\t\t_swapDimensions: function() {\n\t\t\t\tthis.size[0] = this.options.height;\n\t\t\t\tthis.size[1] = this.options.width;\n\t\t\t},\n\t\t\t_resetDimensions: function() {\n\t\t\t\tthis.size[0] = this.options.width;\n\t\t\t\tthis.size[1] = this.options.height;\n\t\t\t},\n\n\t\t\t_useTitle: function(corner) {\n\t\t\t\tvar titlebar = this.qtip.elements.titlebar;\n\t\t\t\treturn titlebar && (\n\t\t\t\t\t\tcorner.y === TOP || corner.y === CENTER && this.element.position().top + this.size[1] / 2 + this.options.offset < titlebar.outerHeight(TRUE)\n\t\t\t\t\t);\n\t\t\t},\n\n\t\t\t_parseCorner: function(corner) {\n\t\t\t\tvar my = this.qtip.options.position.my;\n\n\t\t\t\t// Detect corner and mimic properties\n\t\t\t\tif(corner === FALSE || my === FALSE) {\n\t\t\t\t\tcorner = FALSE;\n\t\t\t\t}\n\t\t\t\telse if(corner === TRUE) {\n\t\t\t\t\tcorner = new CORNER( my.string() );\n\t\t\t\t}\n\t\t\t\telse if(!corner.string) {\n\t\t\t\t\tcorner = new CORNER(corner);\n\t\t\t\t\tcorner.fixed = TRUE;\n\t\t\t\t}\n\n\t\t\t\treturn corner;\n\t\t\t},\n\n\t\t\t_parseWidth: function(corner, side, use) {\n\t\t\t\tvar elements = this.qtip.elements,\n\t\t\t\t\tprop = BORDER + camel(side) + 'Width';\n\n\t\t\t\treturn (use ? intCss(use, prop) :\n\t\t\t\t\t\tintCss(elements.content, prop) ||\n\t\t\t\t\t\tintCss(this._useTitle(corner) && elements.titlebar || elements.content, prop) ||\n\t\t\t\t\t\tintCss(elements.tooltip, prop)\n\t\t\t\t\t) || 0;\n\t\t\t},\n\n\t\t\t_parseRadius: function(corner) {\n\t\t\t\tvar elements = this.qtip.elements,\n\t\t\t\t\tprop = BORDER + camel(corner.y) + camel(corner.x) + 'Radius';\n\n\t\t\t\treturn BROWSER.ie < 9 ? 0 :\n\t\t\t\tintCss(this._useTitle(corner) && elements.titlebar || elements.content, prop) ||\n\t\t\t\tintCss(elements.tooltip, prop) || 0;\n\t\t\t},\n\n\t\t\t_invalidColour: function(elem, prop, compare) {\n\t\t\t\tvar val = elem.css(prop);\n\t\t\t\treturn !val || compare && val === elem.css(compare) || INVALID.test(val) ? FALSE : val;\n\t\t\t},\n\n\t\t\t_parseColours: function(corner) {\n\t\t\t\tvar elements = this.qtip.elements,\n\t\t\t\t\ttip = this.element.css('cssText', ''),\n\t\t\t\t\tborderSide = BORDER + camel(corner[ corner.precedance ]) + camel(COLOR),\n\t\t\t\t\tcolorElem = this._useTitle(corner) && elements.titlebar || elements.content,\n\t\t\t\t\tcss = this._invalidColour, color = [];\n\n\t\t\t\t// Attempt to detect the background colour from various elements, left-to-right precedance\n\t\t\t\tcolor[0] = css(tip, BG_COLOR) || css(colorElem, BG_COLOR) || css(elements.content, BG_COLOR) ||\n\t\t\t\t\tcss(elements.tooltip, BG_COLOR) || tip.css(BG_COLOR);\n\n\t\t\t\t// Attempt to detect the correct border side colour from various elements, left-to-right precedance\n\t\t\t\tcolor[1] = css(tip, borderSide, COLOR) || css(colorElem, borderSide, COLOR) ||\n\t\t\t\t\tcss(elements.content, borderSide, COLOR) || css(elements.tooltip, borderSide, COLOR) || elements.tooltip.css(borderSide);\n\n\t\t\t\t// Reset background and border colours\n\t\t\t\t$('*', tip).add(tip).css('cssText', BG_COLOR+':'+TRANSPARENT+IMPORTANT+';'+BORDER+':0'+IMPORTANT+';');\n\n\t\t\t\treturn color;\n\t\t\t},\n\n\t\t\t_calculateSize: function(corner) {\n\t\t\t\tvar y = corner.precedance === Y,\n\t\t\t\t\twidth = this.options.width,\n\t\t\t\t\theight = this.options.height,\n\t\t\t\t\tisCenter = corner.abbrev() === 'c',\n\t\t\t\t\tbase = (y ? width: height) * (isCenter ? 0.5 : 1),\n\t\t\t\t\tpow = Math.pow,\n\t\t\t\t\tround = Math.round,\n\t\t\t\t\tbigHyp, ratio, result,\n\n\t\t\t\t\tsmallHyp = Math.sqrt( pow(base, 2) + pow(height, 2) ),\n\t\t\t\t\thyp = [\n\t\t\t\t\t\tthis.border / base * smallHyp,\n\t\t\t\t\t\tthis.border / height * smallHyp\n\t\t\t\t\t];\n\n\t\t\t\thyp[2] = Math.sqrt( pow(hyp[0], 2) - pow(this.border, 2) );\n\t\t\t\thyp[3] = Math.sqrt( pow(hyp[1], 2) - pow(this.border, 2) );\n\n\t\t\t\tbigHyp = smallHyp + hyp[2] + hyp[3] + (isCenter ? 0 : hyp[0]);\n\t\t\t\tratio = bigHyp / smallHyp;\n\n\t\t\t\tresult = [ round(ratio * width), round(ratio * height) ];\n\t\t\t\treturn y ? result : result.reverse();\n\t\t\t},\n\n\t\t\t// Tip coordinates calculator\n\t\t\t_calculateTip: function(corner, size, scale) {\n\t\t\t\tscale = scale || 1;\n\t\t\t\tsize = size || this.size;\n\n\t\t\t\tvar width = size[0] * scale,\n\t\t\t\t\theight = size[1] * scale,\n\t\t\t\t\twidth2 = Math.ceil(width / 2), height2 = Math.ceil(height / 2),\n\n\t\t\t\t\t// Define tip coordinates in terms of height and width values\n\t\t\t\t\ttips = {\n\t\t\t\t\t\tbr:\t[0,0,\t\twidth,height,\twidth,0],\n\t\t\t\t\t\tbl:\t[0,0,\t\twidth,0,\t\t0,height],\n\t\t\t\t\t\ttr:\t[0,height,\twidth,0,\t\twidth,height],\n\t\t\t\t\t\ttl:\t[0,0,\t\t0,height,\t\twidth,height],\n\t\t\t\t\t\ttc:\t[0,height,\twidth2,0,\t\twidth,height],\n\t\t\t\t\t\tbc:\t[0,0,\t\twidth,0,\t\twidth2,height],\n\t\t\t\t\t\trc:\t[0,0,\t\twidth,height2,\t0,height],\n\t\t\t\t\t\tlc:\t[width,0,\twidth,height,\t0,height2]\n\t\t\t\t\t};\n\n\t\t\t\t// Set common side shapes\n\t\t\t\ttips.lt = tips.br; tips.rt = tips.bl;\n\t\t\t\ttips.lb = tips.tr; tips.rb = tips.tl;\n\n\t\t\t\treturn tips[ corner.abbrev() ];\n\t\t\t},\n\n\t\t\t// Tip coordinates drawer (canvas)\n\t\t\t_drawCoords: function(context, coords) {\n\t\t\t\tcontext.beginPath();\n\t\t\t\tcontext.moveTo(coords[0], coords[1]);\n\t\t\t\tcontext.lineTo(coords[2], coords[3]);\n\t\t\t\tcontext.lineTo(coords[4], coords[5]);\n\t\t\t\tcontext.closePath();\n\t\t\t},\n\n\t\t\tcreate: function() {\n\t\t\t\t// Determine tip corner\n\t\t\t\tvar c = this.corner = (HASCANVAS || BROWSER.ie) && this._parseCorner(this.options.corner);\n\n\t\t\t\t// If we have a tip corner...\n\t\t\t\tthis.enabled = !!this.corner && this.corner.abbrev() !== 'c';\n\t\t\t\tif(this.enabled) {\n\t\t\t\t\t// Cache it\n\t\t\t\t\tthis.qtip.cache.corner = c.clone();\n\n\t\t\t\t\t// Create it\n\t\t\t\t\tthis.update();\n\t\t\t\t}\n\n\t\t\t\t// Toggle tip element\n\t\t\t\tthis.element.toggle(this.enabled);\n\n\t\t\t\treturn this.corner;\n\t\t\t},\n\n\t\t\tupdate: function(corner, position) {\n\t\t\t\tif(!this.enabled) { return this; }\n\n\t\t\t\tvar elements = this.qtip.elements,\n\t\t\t\t\ttip = this.element,\n\t\t\t\t\tinner = tip.children(),\n\t\t\t\t\toptions = this.options,\n\t\t\t\t\tcurSize = this.size,\n\t\t\t\t\tmimic = options.mimic,\n\t\t\t\t\tround = Math.round,\n\t\t\t\t\tcolor, precedance, context,\n\t\t\t\t\tcoords, bigCoords, translate, newSize, border;\n\n\t\t\t\t// Re-determine tip if not already set\n\t\t\t\tif(!corner) { corner = this.qtip.cache.corner || this.corner; }\n\n\t\t\t\t// Use corner property if we detect an invalid mimic value\n\t\t\t\tif(mimic === FALSE) { mimic = corner; }\n\n\t\t\t\t// Otherwise inherit mimic properties from the corner object as necessary\n\t\t\t\telse {\n\t\t\t\t\tmimic = new CORNER(mimic);\n\t\t\t\t\tmimic.precedance = corner.precedance;\n\n\t\t\t\t\tif(mimic.x === 'inherit') { mimic.x = corner.x; }\n\t\t\t\t\telse if(mimic.y === 'inherit') { mimic.y = corner.y; }\n\t\t\t\t\telse if(mimic.x === mimic.y) {\n\t\t\t\t\t\tmimic[ corner.precedance ] = corner[ corner.precedance ];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprecedance = mimic.precedance;\n\n\t\t\t\t// Ensure the tip width.height are relative to the tip position\n\t\t\t\tif(corner.precedance === X) { this._swapDimensions(); }\n\t\t\t\telse { this._resetDimensions(); }\n\n\t\t\t\t// Update our colours\n\t\t\t\tcolor = this.color = this._parseColours(corner);\n\n\t\t\t\t// Detect border width, taking into account colours\n\t\t\t\tif(color[1] !== TRANSPARENT) {\n\t\t\t\t\t// Grab border width\n\t\t\t\t\tborder = this.border = this._parseWidth(corner, corner[corner.precedance]);\n\n\t\t\t\t\t// If border width isn't zero, use border color as fill if it's not invalid (1.0 style tips)\n\t\t\t\t\tif(options.border && border < 1 && !INVALID.test(color[1])) { color[0] = color[1]; }\n\n\t\t\t\t\t// Set border width (use detected border width if options.border is true)\n\t\t\t\t\tthis.border = border = options.border !== TRUE ? options.border : border;\n\t\t\t\t}\n\n\t\t\t\t// Border colour was invalid, set border to zero\n\t\t\t\telse { this.border = border = 0; }\n\n\t\t\t\t// Determine tip size\n\t\t\t\tnewSize = this.size = this._calculateSize(corner);\n\t\t\t\ttip.css({\n\t\t\t\t\twidth: newSize[0],\n\t\t\t\t\theight: newSize[1],\n\t\t\t\t\tlineHeight: newSize[1]+'px'\n\t\t\t\t});\n\n\t\t\t\t// Calculate tip translation\n\t\t\t\tif(corner.precedance === Y) {\n\t\t\t\t\ttranslate = [\n\t\t\t\t\t\tround(mimic.x === LEFT ? border : mimic.x === RIGHT ? newSize[0] - curSize[0] - border : (newSize[0] - curSize[0]) / 2),\n\t\t\t\t\t\tround(mimic.y === TOP ? newSize[1] - curSize[1] : 0)\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttranslate = [\n\t\t\t\t\t\tround(mimic.x === LEFT ? newSize[0] - curSize[0] : 0),\n\t\t\t\t\t\tround(mimic.y === TOP ? border : mimic.y === BOTTOM ? newSize[1] - curSize[1] - border : (newSize[1] - curSize[1]) / 2)\n\t\t\t\t\t];\n\t\t\t\t}\n\n\t\t\t\t// Canvas drawing implementation\n\t\t\t\tif(HASCANVAS) {\n\t\t\t\t\t// Grab canvas context and clear/save it\n\t\t\t\t\tcontext = inner[0].getContext('2d');\n\t\t\t\t\tcontext.restore(); context.save();\n\t\t\t\t\tcontext.clearRect(0,0,6000,6000);\n\n\t\t\t\t\t// Calculate coordinates\n\t\t\t\t\tcoords = this._calculateTip(mimic, curSize, SCALE);\n\t\t\t\t\tbigCoords = this._calculateTip(mimic, this.size, SCALE);\n\n\t\t\t\t\t// Set the canvas size using calculated size\n\t\t\t\t\tinner.attr(WIDTH, newSize[0] * SCALE).attr(HEIGHT, newSize[1] * SCALE);\n\t\t\t\t\tinner.css(WIDTH, newSize[0]).css(HEIGHT, newSize[1]);\n\n\t\t\t\t\t// Draw the outer-stroke tip\n\t\t\t\t\tthis._drawCoords(context, bigCoords);\n\t\t\t\t\tcontext.fillStyle = color[1];\n\t\t\t\t\tcontext.fill();\n\n\t\t\t\t\t// Draw the actual tip\n\t\t\t\t\tcontext.translate(translate[0] * SCALE, translate[1] * SCALE);\n\t\t\t\t\tthis._drawCoords(context, coords);\n\t\t\t\t\tcontext.fillStyle = color[0];\n\t\t\t\t\tcontext.fill();\n\t\t\t\t}\n\n\t\t\t\t// VML (IE Proprietary implementation)\n\t\t\t\telse {\n\t\t\t\t\t// Calculate coordinates\n\t\t\t\t\tcoords = this._calculateTip(mimic);\n\n\t\t\t\t\t// Setup coordinates string\n\t\t\t\t\tcoords = 'm' + coords[0] + ',' + coords[1] + ' l' + coords[2] +\n\t\t\t\t\t\t',' + coords[3] + ' ' + coords[4] + ',' + coords[5] + ' xe';\n\n\t\t\t\t\t// Setup VML-specific offset for pixel-perfection\n\t\t\t\t\ttranslate[2] = border && /^(r|b)/i.test(corner.string()) ?\n\t\t\t\t\t\tBROWSER.ie === 8 ? 2 : 1 : 0;\n\n\t\t\t\t\t// Set initial CSS\n\t\t\t\t\tinner.css({\n\t\t\t\t\t\tcoordsize: newSize[0]+border + ' ' + newSize[1]+border,\n\t\t\t\t\t\tantialias: ''+(mimic.string().indexOf(CENTER) > -1),\n\t\t\t\t\t\tleft: translate[0] - translate[2] * Number(precedance === X),\n\t\t\t\t\t\ttop: translate[1] - translate[2] * Number(precedance === Y),\n\t\t\t\t\t\twidth: newSize[0] + border,\n\t\t\t\t\t\theight: newSize[1] + border\n\t\t\t\t\t})\n\t\t\t\t\t\t.each(function(i) {\n\t\t\t\t\t\t\tvar $this = $(this);\n\n\t\t\t\t\t\t\t// Set shape specific attributes\n\t\t\t\t\t\t\t$this[ $this.prop ? 'prop' : 'attr' ]({\n\t\t\t\t\t\t\t\tcoordsize: newSize[0]+border + ' ' + newSize[1]+border,\n\t\t\t\t\t\t\t\tpath: coords,\n\t\t\t\t\t\t\t\tfillcolor: color[0],\n\t\t\t\t\t\t\t\tfilled: !!i,\n\t\t\t\t\t\t\t\tstroked: !i\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.toggle(!!(border || i));\n\n\t\t\t\t\t\t\t// Check if border is enabled and add stroke element\n\t\t\t\t\t\t\t!i && $this.html( createVML(\n\t\t\t\t\t\t\t\t'stroke', 'weight=\"'+border*2+'px\" color=\"'+color[1]+'\" miterlimit=\"1000\" joinstyle=\"miter\"'\n\t\t\t\t\t\t\t) );\n\t\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Opera bug #357 - Incorrect tip position\n\t\t\t\t// https://github.com/Craga89/qTip2/issues/367\n\t\t\t\twindow.opera && setTimeout(function() {\n\t\t\t\t\telements.tip.css({\n\t\t\t\t\t\tdisplay: 'inline-block',\n\t\t\t\t\t\tvisibility: 'visible'\n\t\t\t\t\t});\n\t\t\t\t}, 1);\n\n\t\t\t\t// Position if needed\n\t\t\t\tif(position !== FALSE) { this.calculate(corner, newSize); }\n\t\t\t},\n\n\t\t\tcalculate: function(corner, size) {\n\t\t\t\tif(!this.enabled) { return FALSE; }\n\n\t\t\t\tvar self = this,\n\t\t\t\t\telements = this.qtip.elements,\n\t\t\t\t\ttip = this.element,\n\t\t\t\t\tuserOffset = this.options.offset,\n\t\t\t\t\tposition = {},\n\t\t\t\t\tprecedance, corners;\n\n\t\t\t\t// Inherit corner if not provided\n\t\t\t\tcorner = corner || this.corner;\n\t\t\t\tprecedance = corner.precedance;\n\n\t\t\t\t// Determine which tip dimension to use for adjustment\n\t\t\t\tsize = size || this._calculateSize(corner);\n\n\t\t\t\t// Setup corners and offset array\n\t\t\t\tcorners = [ corner.x, corner.y ];\n\t\t\t\tif(precedance === X) { corners.reverse(); }\n\n\t\t\t\t// Calculate tip position\n\t\t\t\t$.each(corners, function(i, side) {\n\t\t\t\t\tvar b, bc, br;\n\n\t\t\t\t\tif(side === CENTER) {\n\t\t\t\t\t\tb = precedance === Y ? LEFT : TOP;\n\t\t\t\t\t\tposition[ b ] = '50%';\n\t\t\t\t\t\tposition[MARGIN+'-' + b] = -Math.round(size[ precedance === Y ? 0 : 1 ] / 2) + userOffset;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tb = self._parseWidth(corner, side, elements.tooltip);\n\t\t\t\t\t\tbc = self._parseWidth(corner, side, elements.content);\n\t\t\t\t\t\tbr = self._parseRadius(corner);\n\n\t\t\t\t\t\tposition[ side ] = Math.max(-self.border, i ? bc : userOffset + (br > b ? br : -b));\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\t// Adjust for tip size\n\t\t\t\tposition[ corner[precedance] ] -= size[ precedance === X ? 0 : 1 ];\n\n\t\t\t\t// Set and return new position\n\t\t\t\ttip.css({ margin: '', top: '', bottom: '', left: '', right: '' }).css(position);\n\t\t\t\treturn position;\n\t\t\t},\n\n\t\t\treposition: function(event, api, pos) {\n\t\t\t\tif(!this.enabled) { return; }\n\n\t\t\t\tvar cache = api.cache,\n\t\t\t\t\tnewCorner = this.corner.clone(),\n\t\t\t\t\tadjust = pos.adjusted,\n\t\t\t\t\tmethod = api.options.position.adjust.method.split(' '),\n\t\t\t\t\thorizontal = method[0],\n\t\t\t\t\tvertical = method[1] || method[0],\n\t\t\t\t\tshift = { left: FALSE, top: FALSE, x: 0, y: 0 },\n\t\t\t\t\toffset, css = {}, props;\n\n\t\t\t\tfunction shiftflip(direction, precedance, popposite, side, opposite) {\n\t\t\t\t\t// Horizontal - Shift or flip method\n\t\t\t\t\tif(direction === SHIFT && newCorner.precedance === precedance && adjust[side] && newCorner[popposite] !== CENTER) {\n\t\t\t\t\t\tnewCorner.precedance = newCorner.precedance === X ? Y : X;\n\t\t\t\t\t}\n\t\t\t\t\telse if(direction !== SHIFT && adjust[side]){\n\t\t\t\t\t\tnewCorner[precedance] = newCorner[precedance] === CENTER ?\n\t\t\t\t\t\t\tadjust[side] > 0 ? side : opposite :\n\t\t\t\t\t\t\tnewCorner[precedance] === side ? opposite : side;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfunction shiftonly(xy, side, opposite) {\n\t\t\t\t\tif(newCorner[xy] === CENTER) {\n\t\t\t\t\t\tcss[MARGIN+'-'+side] = shift[xy] = offset[MARGIN+'-'+side] - adjust[side];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tprops = offset[opposite] !== undefined ?\n\t\t\t\t\t\t\t[ adjust[side], -offset[side] ] : [ -adjust[side], offset[side] ];\n\n\t\t\t\t\t\tif( (shift[xy] = Math.max(props[0], props[1])) > props[0] ) {\n\t\t\t\t\t\t\tpos[side] -= adjust[side];\n\t\t\t\t\t\t\tshift[side] = FALSE;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcss[ offset[opposite] !== undefined ? opposite : side ] = shift[xy];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// If our tip position isn't fixed e.g. doesn't adjust with viewport...\n\t\t\t\tif(this.corner.fixed !== TRUE) {\n\t\t\t\t\t// Perform shift/flip adjustments\n\t\t\t\t\tshiftflip(horizontal, X, Y, LEFT, RIGHT);\n\t\t\t\t\tshiftflip(vertical, Y, X, TOP, BOTTOM);\n\n\t\t\t\t\t// Update and redraw the tip if needed (check cached details of last drawn tip)\n\t\t\t\t\tif(newCorner.string() !== cache.corner.string() || cache.cornerTop !== adjust.top || cache.cornerLeft !== adjust.left) {\n\t\t\t\t\t\tthis.update(newCorner, FALSE);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Setup tip offset properties\n\t\t\t\toffset = this.calculate(newCorner);\n\n\t\t\t\t// Readjust offset object to make it left/top\n\t\t\t\tif(offset.right !== undefined) { offset.left = -offset.right; }\n\t\t\t\tif(offset.bottom !== undefined) { offset.top = -offset.bottom; }\n\t\t\t\toffset.user = this.offset;\n\n\t\t\t\t// Perform shift adjustments\n\t\t\t\tshift.left = horizontal === SHIFT && !!adjust.left;\n\t\t\t\tif(shift.left) {\n\t\t\t\t\tshiftonly(X, LEFT, RIGHT);\n\t\t\t\t}\n\t\t\t\tshift.top = vertical === SHIFT && !!adjust.top;\n\t\t\t\tif(shift.top) {\n\t\t\t\t\tshiftonly(Y, TOP, BOTTOM);\n\t\t\t\t}\n\n\t\t\t\t/*\n\t\t\t\t * If the tip is adjusted in both dimensions, or in a\n\t\t\t\t * direction that would cause it to be anywhere but the\n\t\t\t\t * outer border, hide it!\n\t\t\t\t */\n\t\t\t\tthis.element.css(css).toggle(\n\t\t\t\t\t!(shift.x && shift.y || newCorner.x === CENTER && shift.y || newCorner.y === CENTER && shift.x)\n\t\t\t\t);\n\n\t\t\t\t// Adjust position to accomodate tip dimensions\n\t\t\t\tpos.left -= offset.left.charAt ? offset.user :\n\t\t\t\t\thorizontal !== SHIFT || shift.top || !shift.left && !shift.top ? offset.left + this.border : 0;\n\t\t\t\tpos.top -= offset.top.charAt ? offset.user :\n\t\t\t\t\tvertical !== SHIFT || shift.left || !shift.left && !shift.top ? offset.top + this.border : 0;\n\n\t\t\t\t// Cache details\n\t\t\t\tcache.cornerLeft = adjust.left; cache.cornerTop = adjust.top;\n\t\t\t\tcache.corner = newCorner.clone();\n\t\t\t},\n\n\t\t\tdestroy: function() {\n\t\t\t\t// Unbind events\n\t\t\t\tthis.qtip._unbind(this.qtip.tooltip, this._ns);\n\n\t\t\t\t// Remove the tip element(s)\n\t\t\t\tif(this.qtip.elements.tip) {\n\t\t\t\t\tthis.qtip.elements.tip.find('*')\n\t\t\t\t\t\t.remove().end().remove();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tTIP = PLUGINS.tip = function(api) {\n\t\t\treturn new Tip(api, api.options.style.tip);\n\t\t};\n\n// Initialize tip on render\n\t\tTIP.initialize = 'render';\n\n// Setup plugin sanitization options\n\t\tTIP.sanitize = function(options) {\n\t\t\tif(options.style && 'tip' in options.style) {\n\t\t\t\tvar opts = options.style.tip;\n\t\t\t\tif(typeof opts !== 'object') { opts = options.style.tip = { corner: opts }; }\n\t\t\t\tif(!(/string|boolean/i).test(typeof opts.corner)) { opts.corner = TRUE; }\n\t\t\t}\n\t\t};\n\n// Add new option checks for the plugin\n\t\tCHECKS.tip = {\n\t\t\t'^position.my|style.tip.(corner|mimic|border)$': function() {\n\t\t\t\t// Make sure a tip can be drawn\n\t\t\t\tthis.create();\n\n\t\t\t\t// Reposition the tooltip\n\t\t\t\tthis.qtip.reposition();\n\t\t\t},\n\t\t\t'^style.tip.(height|width)$': function(obj) {\n\t\t\t\t// Re-set dimensions and redraw the tip\n\t\t\t\tthis.size = [ obj.width, obj.height ];\n\t\t\t\tthis.update();\n\n\t\t\t\t// Reposition the tooltip\n\t\t\t\tthis.qtip.reposition();\n\t\t\t},\n\t\t\t'^content.title|style.(classes|widget)$': function() {\n\t\t\t\tthis.update();\n\t\t\t}\n\t\t};\n\n// Extend original qTip defaults\n\t\t$.extend(TRUE, QTIP.defaults, {\n\t\t\tstyle: {\n\t\t\t\ttip: {\n\t\t\t\t\tcorner: TRUE,\n\t\t\t\t\tmimic: FALSE,\n\t\t\t\t\twidth: 6,\n\t\t\t\t\theight: 6,\n\t\t\t\t\tborder: TRUE,\n\t\t\t\t\toffset: 0\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\t;var MODAL, OVERLAY,\n\t\t\tMODALCLASS = 'qtip-modal',\n\t\t\tMODALSELECTOR = '.'+MODALCLASS;\n\n\t\tOVERLAY = function()\n\t\t{\n\t\t\tvar self = this,\n\t\t\t\tfocusableElems = {},\n\t\t\t\tcurrent,\n\t\t\t\tprevState,\n\t\t\t\telem;\n\n\t\t\t// Modified code from jQuery UI 1.10.0 source\n\t\t\t// http://code.jquery.com/ui/1.10.0/jquery-ui.js\n\t\t\tfunction focusable(element) {\n\t\t\t\t// Use the defined focusable checker when possible\n\t\t\t\tif($.expr[':'].focusable) { return $.expr[':'].focusable; }\n\n\t\t\t\tvar isTabIndexNotNaN = !isNaN($.attr(element, 'tabindex')),\n\t\t\t\t\tnodeName = element.nodeName && element.nodeName.toLowerCase(),\n\t\t\t\t\tmap, mapName, img;\n\n\t\t\t\tif('area' === nodeName) {\n\t\t\t\t\tmap = element.parentNode;\n\t\t\t\t\tmapName = map.name;\n\t\t\t\t\tif(!element.href || !mapName || map.nodeName.toLowerCase() !== 'map') {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\timg = $('img[usemap=#' + mapName + ']')[0];\n\t\t\t\t\treturn !!img && img.is(':visible');\n\t\t\t\t}\n\n\t\t\t\treturn /input|select|textarea|button|object/.test( nodeName ) ?\n\t\t\t\t\t!element.disabled :\n\t\t\t\t\t'a' === nodeName ?\n\t\t\t\t\telement.href || isTabIndexNotNaN :\n\t\t\t\t\t\tisTabIndexNotNaN\n\t\t\t\t\t;\n\t\t\t}\n\n\t\t\t// Focus inputs using cached focusable elements (see update())\n\t\t\tfunction focusInputs(blurElems) {\n\t\t\t\t// Blurring body element in IE causes window.open windows to unfocus!\n\t\t\t\tif(focusableElems.length < 1 && blurElems.length) { blurElems.not('body').blur(); }\n\n\t\t\t\t// Focus the inputs\n\t\t\t\telse { focusableElems.first().focus(); }\n\t\t\t}\n\n\t\t\t// Steal focus from elements outside tooltip\n\t\t\tfunction stealFocus(event) {\n\t\t\t\tif(!elem.is(':visible')) { return; }\n\n\t\t\t\tvar target = $(event.target),\n\t\t\t\t\ttooltip = current.tooltip,\n\t\t\t\t\tcontainer = target.closest(SELECTOR),\n\t\t\t\t\ttargetOnTop;\n\n\t\t\t\t// Determine if input container target is above this\n\t\t\t\ttargetOnTop = container.length < 1 ? FALSE :\n\t\t\t\tparseInt(container[0].style.zIndex, 10) > parseInt(tooltip[0].style.zIndex, 10);\n\n\t\t\t\t// If we're showing a modal, but focus has landed on an input below\n\t\t\t\t// this modal, divert focus to the first visible input in this modal\n\t\t\t\t// or if we can't find one... the tooltip itself\n\t\t\t\tif(!targetOnTop && target.closest(SELECTOR)[0] !== tooltip[0]) {\n\t\t\t\t\tfocusInputs(target);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$.extend(self, {\n\t\t\t\tinit: function() {\n\t\t\t\t\t// Create document overlay\n\t\t\t\t\telem = self.elem = $('<div />', {\n\t\t\t\t\t\tid: 'qtip-overlay',\n\t\t\t\t\t\thtml: '<div></div>',\n\t\t\t\t\t\tmousedown: function() { return FALSE; }\n\t\t\t\t\t})\n\t\t\t\t\t\t.hide();\n\n\t\t\t\t\t// Make sure we can't focus anything outside the tooltip\n\t\t\t\t\t$(document.body).bind('focusin'+MODALSELECTOR, stealFocus);\n\n\t\t\t\t\t// Apply keyboard \"Escape key\" close handler\n\t\t\t\t\t$(document).bind('keydown'+MODALSELECTOR, function(event) {\n\t\t\t\t\t\tif(current && current.options.show.modal.escape && event.keyCode === 27) {\n\t\t\t\t\t\t\tcurrent.hide(event);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t// Apply click handler for blur option\n\t\t\t\t\telem.bind('click'+MODALSELECTOR, function(event) {\n\t\t\t\t\t\tif(current && current.options.show.modal.blur) {\n\t\t\t\t\t\t\tcurrent.hide(event);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn self;\n\t\t\t\t},\n\n\t\t\t\tupdate: function(api) {\n\t\t\t\t\t// Update current API reference\n\t\t\t\t\tcurrent = api;\n\n\t\t\t\t\t// Update focusable elements if enabled\n\t\t\t\t\tif(api.options.show.modal.stealfocus !== FALSE) {\n\t\t\t\t\t\tfocusableElems = api.tooltip.find('*').filter(function() {\n\t\t\t\t\t\t\treturn focusable(this);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse { focusableElems = []; }\n\t\t\t\t},\n\n\t\t\t\ttoggle: function(api, state, duration) {\n\t\t\t\t\tvar tooltip = api.tooltip,\n\t\t\t\t\t\toptions = api.options.show.modal,\n\t\t\t\t\t\teffect = options.effect,\n\t\t\t\t\t\ttype = state ? 'show': 'hide',\n\t\t\t\t\t\tvisible = elem.is(':visible'),\n\t\t\t\t\t\tvisibleModals = $(MODALSELECTOR).filter(':visible:not(:animated)').not(tooltip);\n\n\t\t\t\t\t// Set active tooltip API reference\n\t\t\t\t\tself.update(api);\n\n\t\t\t\t\t// If the modal can steal the focus...\n\t\t\t\t\t// Blur the current item and focus anything in the modal we an\n\t\t\t\t\tif(state && options.stealfocus !== FALSE) {\n\t\t\t\t\t\tfocusInputs( $(':focus') );\n\t\t\t\t\t}\n\n\t\t\t\t\t// Toggle backdrop cursor style on show\n\t\t\t\t\telem.toggleClass('blurs', options.blur);\n\n\t\t\t\t\t// Append to body on show\n\t\t\t\t\tif(state) {\n\t\t\t\t\t\telem.appendTo(document.body);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Prevent modal from conflicting with show.solo, and don't hide backdrop is other modals are visible\n\t\t\t\t\tif(elem.is(':animated') && visible === state && prevState !== FALSE || !state && visibleModals.length) {\n\t\t\t\t\t\treturn self;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Stop all animations\n\t\t\t\t\telem.stop(TRUE, FALSE);\n\n\t\t\t\t\t// Use custom function if provided\n\t\t\t\t\tif($.isFunction(effect)) {\n\t\t\t\t\t\teffect.call(elem, state);\n\t\t\t\t\t}\n\n\t\t\t\t\t// If no effect type is supplied, use a simple toggle\n\t\t\t\t\telse if(effect === FALSE) {\n\t\t\t\t\t\telem[ type ]();\n\t\t\t\t\t}\n\n\t\t\t\t\t// Use basic fade function\n\t\t\t\t\telse {\n\t\t\t\t\t\telem.fadeTo( parseInt(duration, 10) || 90, state ? 1 : 0, function() {\n\t\t\t\t\t\t\tif(!state) { elem.hide(); }\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reset position and detach from body on hide\n\t\t\t\t\tif(!state) {\n\t\t\t\t\t\telem.queue(function(next) {\n\t\t\t\t\t\t\telem.css({ left: '', top: '' });\n\t\t\t\t\t\t\tif(!$(MODALSELECTOR).length) { elem.detach(); }\n\t\t\t\t\t\t\tnext();\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Cache the state\n\t\t\t\t\tprevState = state;\n\n\t\t\t\t\t// If the tooltip is destroyed, set reference to null\n\t\t\t\t\tif(current.destroyed) { current = NULL; }\n\n\t\t\t\t\treturn self;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tself.init();\n\t\t};\n\t\tOVERLAY = new OVERLAY();\n\n\t\tfunction Modal(api, options) {\n\t\t\tthis.options = options;\n\t\t\tthis._ns = '-modal';\n\n\t\t\tthis.qtip = api;\n\t\t\tthis.init(api);\n\t\t}\n\n\t\t$.extend(Modal.prototype, {\n\t\t\tinit: function(qtip) {\n\t\t\t\tvar tooltip = qtip.tooltip;\n\n\t\t\t\t// If modal is disabled... return\n\t\t\t\tif(!this.options.on) { return this; }\n\n\t\t\t\t// Set overlay reference\n\t\t\t\tqtip.elements.overlay = OVERLAY.elem;\n\n\t\t\t\t// Add unique attribute so we can grab modal tooltips easily via a SELECTOR, and set z-index\n\t\t\t\ttooltip.addClass(MODALCLASS).css('z-index', QTIP.modal_zindex + $(MODALSELECTOR).length);\n\n\t\t\t\t// Apply our show/hide/focus modal events\n\t\t\t\tqtip._bind(tooltip, ['tooltipshow', 'tooltiphide'], function(event, api, duration) {\n\t\t\t\t\tvar oEvent = event.originalEvent;\n\n\t\t\t\t\t// Make sure mouseout doesn't trigger a hide when showing the modal and mousing onto backdrop\n\t\t\t\t\tif(event.target === tooltip[0]) {\n\t\t\t\t\t\tif(oEvent && event.type === 'tooltiphide' && /mouse(leave|enter)/.test(oEvent.type) && $(oEvent.relatedTarget).closest(OVERLAY.elem[0]).length) {\n\t\t\t\t\t\t\t/* eslint-disable no-empty */\n\t\t\t\t\t\t\ttry { event.preventDefault(); }\n\t\t\t\t\t\t\tcatch(e) {}\n\t\t\t\t\t\t\t/* eslint-enable no-empty */\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(!oEvent || oEvent && oEvent.type !== 'tooltipsolo') {\n\t\t\t\t\t\t\tthis.toggle(event, event.type === 'tooltipshow', duration);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, this._ns, this);\n\n\t\t\t\t// Adjust modal z-index on tooltip focus\n\t\t\t\tqtip._bind(tooltip, 'tooltipfocus', function(event, api) {\n\t\t\t\t\t// If focus was cancelled before it reached us, don't do anything\n\t\t\t\t\tif(event.isDefaultPrevented() || event.target !== tooltip[0]) { return; }\n\n\t\t\t\t\tvar qtips = $(MODALSELECTOR),\n\n\t\t\t\t\t\t// Keep the modal's lower than other, regular qtips\n\t\t\t\t\t\tnewIndex = QTIP.modal_zindex + qtips.length,\n\t\t\t\t\t\tcurIndex = parseInt(tooltip[0].style.zIndex, 10);\n\n\t\t\t\t\t// Set overlay z-index\n\t\t\t\t\tOVERLAY.elem[0].style.zIndex = newIndex - 1;\n\n\t\t\t\t\t// Reduce modal z-index's and keep them properly ordered\n\t\t\t\t\tqtips.each(function() {\n\t\t\t\t\t\tif(this.style.zIndex > curIndex) {\n\t\t\t\t\t\t\tthis.style.zIndex -= 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t// Fire blur event for focused tooltip\n\t\t\t\t\tqtips.filter('.' + CLASS_FOCUS).qtip('blur', event.originalEvent);\n\n\t\t\t\t\t// Set the new z-index\n\t\t\t\t\ttooltip.addClass(CLASS_FOCUS)[0].style.zIndex = newIndex;\n\n\t\t\t\t\t// Set current\n\t\t\t\t\tOVERLAY.update(api);\n\n\t\t\t\t\t// Prevent default handling\n\t\t\t\t\t/* eslint-disable no-empty */\n\t\t\t\t\ttry { event.preventDefault(); }\n\t\t\t\t\tcatch(e) {}\n\t\t\t\t\t/* eslint-enable no-empty */\n\t\t\t\t}, this._ns, this);\n\n\t\t\t\t// Focus any other visible modals when this one hides\n\t\t\t\tqtip._bind(tooltip, 'tooltiphide', function(event) {\n\t\t\t\t\tif(event.target === tooltip[0]) {\n\t\t\t\t\t\t$(MODALSELECTOR).filter(':visible').not(tooltip).last().qtip('focus', event);\n\t\t\t\t\t}\n\t\t\t\t}, this._ns, this);\n\t\t\t},\n\n\t\t\ttoggle: function(event, state, duration) {\n\t\t\t\t// Make sure default event hasn't been prevented\n\t\t\t\tif(event && event.isDefaultPrevented()) { return this; }\n\n\t\t\t\t// Toggle it\n\t\t\t\tOVERLAY.toggle(this.qtip, !!state, duration);\n\t\t\t},\n\n\t\t\tdestroy: function() {\n\t\t\t\t// Remove modal class\n\t\t\t\tthis.qtip.tooltip.removeClass(MODALCLASS);\n\n\t\t\t\t// Remove bound events\n\t\t\t\tthis.qtip._unbind(this.qtip.tooltip, this._ns);\n\n\t\t\t\t// Delete element reference\n\t\t\t\tOVERLAY.toggle(this.qtip, FALSE);\n\t\t\t\tdelete this.qtip.elements.overlay;\n\t\t\t}\n\t\t});\n\n\n\t\tMODAL = PLUGINS.modal = function(api) {\n\t\t\treturn new Modal(api, api.options.show.modal);\n\t\t};\n\n// Setup sanitiztion rules\n\t\tMODAL.sanitize = function(opts) {\n\t\t\tif(opts.show) {\n\t\t\t\tif(typeof opts.show.modal !== 'object') { opts.show.modal = { on: !!opts.show.modal }; }\n\t\t\t\telse if(typeof opts.show.modal.on === 'undefined') { opts.show.modal.on = TRUE; }\n\t\t\t}\n\t\t};\n\n// Base z-index for all modal tooltips (use qTip core z-index as a base)\n\t\t/* eslint-disable camelcase */\n\t\tQTIP.modal_zindex = QTIP.zindex - 200;\n\t\t/* eslint-enable camelcase */\n\n// Plugin needs to be initialized on render\n\t\tMODAL.initialize = 'render';\n\n// Setup option set checks\n\t\tCHECKS.modal = {\n\t\t\t'^show.modal.(on|blur)$': function() {\n\t\t\t\t// Initialise\n\t\t\t\tthis.destroy();\n\t\t\t\tthis.init();\n\n\t\t\t\t// Show the modal if not visible already and tooltip is visible\n\t\t\t\tthis.qtip.elems.overlay.toggle(\n\t\t\t\t\tthis.qtip.tooltip[0].offsetWidth > 0\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\n// Extend original api defaults\n\t\t$.extend(TRUE, QTIP.defaults, {\n\t\t\tshow: {\n\t\t\t\tmodal: {\n\t\t\t\t\ton: FALSE,\n\t\t\t\t\teffect: TRUE,\n\t\t\t\t\tblur: TRUE,\n\t\t\t\t\tstealfocus: TRUE,\n\t\t\t\t\tescape: TRUE\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\t;PLUGINS.viewport = function(api, position, posOptions, targetWidth, targetHeight, elemWidth, elemHeight)\n\t\t{\n\t\t\tvar target = posOptions.target,\n\t\t\t\ttooltip = api.elements.tooltip,\n\t\t\t\tmy = posOptions.my,\n\t\t\t\tat = posOptions.at,\n\t\t\t\tadjust = posOptions.adjust,\n\t\t\t\tmethod = adjust.method.split(' '),\n\t\t\t\tmethodX = method[0],\n\t\t\t\tmethodY = method[1] || method[0],\n\t\t\t\tviewport = posOptions.viewport,\n\t\t\t\tcontainer = posOptions.container,\n\t\t\t\tadjusted = { left: 0, top: 0 },\n\t\t\t\tfixed, newMy, containerOffset, containerStatic,\n\t\t\t\tviewportWidth, viewportHeight, viewportScroll, viewportOffset;\n\n\t\t\t// If viewport is not a jQuery element, or it's the window/document, or no adjustment method is used... return\n\t\t\tif(!viewport.jquery || target[0] === window || target[0] === document.body || adjust.method === 'none') {\n\t\t\t\treturn adjusted;\n\t\t\t}\n\n\t\t\t// Cach container details\n\t\t\tcontainerOffset = container.offset() || adjusted;\n\t\t\tcontainerStatic = container.css('position') === 'static';\n\n\t\t\t// Cache our viewport details\n\t\t\tfixed = tooltip.css('position') === 'fixed';\n\t\t\tviewportWidth = viewport[0] === window ? viewport.width() : viewport.outerWidth(FALSE);\n\t\t\tviewportHeight = viewport[0] === window ? viewport.height() : viewport.outerHeight(FALSE);\n\t\t\tviewportScroll = { left: fixed ? 0 : viewport.scrollLeft(), top: fixed ? 0 : viewport.scrollTop() };\n\t\t\tviewportOffset = viewport.offset() || adjusted;\n\n\t\t\t// Generic calculation method\n\t\t\tfunction calculate(side, otherSide, type, adjustment, side1, side2, lengthName, targetLength, elemLength) {\n\t\t\t\tvar initialPos = position[side1],\n\t\t\t\t\tmySide = my[side],\n\t\t\t\t\tatSide = at[side],\n\t\t\t\t\tisShift = type === SHIFT,\n\t\t\t\t\tmyLength = mySide === side1 ? elemLength : mySide === side2 ? -elemLength : -elemLength / 2,\n\t\t\t\t\tatLength = atSide === side1 ? targetLength : atSide === side2 ? -targetLength : -targetLength / 2,\n\t\t\t\t\tsideOffset = viewportScroll[side1] + viewportOffset[side1] - (containerStatic ? 0 : containerOffset[side1]),\n\t\t\t\t\toverflow1 = sideOffset - initialPos,\n\t\t\t\t\toverflow2 = initialPos + elemLength - (lengthName === WIDTH ? viewportWidth : viewportHeight) - sideOffset,\n\t\t\t\t\toffset = myLength - (my.precedance === side || mySide === my[otherSide] ? atLength : 0) - (atSide === CENTER ? targetLength / 2 : 0);\n\n\t\t\t\t// shift\n\t\t\t\tif(isShift) {\n\t\t\t\t\toffset = (mySide === side1 ? 1 : -1) * myLength;\n\n\t\t\t\t\t// Adjust position but keep it within viewport dimensions\n\t\t\t\t\tposition[side1] += overflow1 > 0 ? overflow1 : overflow2 > 0 ? -overflow2 : 0;\n\t\t\t\t\tposition[side1] = Math.max(\n\t\t\t\t\t\t-containerOffset[side1] + viewportOffset[side1],\n\t\t\t\t\t\tinitialPos - offset,\n\t\t\t\t\t\tMath.min(\n\t\t\t\t\t\t\tMath.max(\n\t\t\t\t\t\t\t\t-containerOffset[side1] + viewportOffset[side1] + (lengthName === WIDTH ? viewportWidth : viewportHeight),\n\t\t\t\t\t\t\t\tinitialPos + offset\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tposition[side1],\n\n\t\t\t\t\t\t\t// Make sure we don't adjust complete off the element when using 'center'\n\t\t\t\t\t\t\tmySide === 'center' ? initialPos - myLength : 1E9\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\n\t\t\t\t}\n\n\t\t\t\t// flip/flipinvert\n\t\t\t\telse {\n\t\t\t\t\t// Update adjustment amount depending on if using flipinvert or flip\n\t\t\t\t\tadjustment *= type === FLIPINVERT ? 2 : 0;\n\n\t\t\t\t\t// Check for overflow on the left/top\n\t\t\t\t\tif(overflow1 > 0 && (mySide !== side1 || overflow2 > 0)) {\n\t\t\t\t\t\tposition[side1] -= offset + adjustment;\n\t\t\t\t\t\tnewMy.invert(side, side1);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Check for overflow on the bottom/right\n\t\t\t\t\telse if(overflow2 > 0 && (mySide !== side2 || overflow1 > 0)  ) {\n\t\t\t\t\t\tposition[side1] -= (mySide === CENTER ? -offset : offset) + adjustment;\n\t\t\t\t\t\tnewMy.invert(side, side2);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Make sure we haven't made things worse with the adjustment and reset if so\n\t\t\t\t\tif(position[side1] < viewportScroll[side1] && -position[side1] > overflow2) {\n\t\t\t\t\t\tposition[side1] = initialPos; newMy = my.clone();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn position[side1] - initialPos;\n\t\t\t}\n\n\t\t\t// Set newMy if using flip or flipinvert methods\n\t\t\tif(methodX !== 'shift' || methodY !== 'shift') { newMy = my.clone(); }\n\n\t\t\t// Adjust position based onviewport and adjustment options\n\t\t\tadjusted = {\n\t\t\t\tleft: methodX !== 'none' ? calculate( X, Y, methodX, adjust.x, LEFT, RIGHT, WIDTH, targetWidth, elemWidth ) : 0,\n\t\t\t\ttop: methodY !== 'none' ? calculate( Y, X, methodY, adjust.y, TOP, BOTTOM, HEIGHT, targetHeight, elemHeight ) : 0,\n\t\t\t\tmy: newMy\n\t\t\t};\n\n\t\t\treturn adjusted;\n\t\t};\n\t\t;PLUGINS.polys = {\n\t\t\t// POLY area coordinate calculator\n\t\t\t//\tSpecial thanks to Ed Cradock for helping out with this.\n\t\t\t//\tUses a binary search algorithm to find suitable coordinates.\n\t\t\tpolygon: function(baseCoords, corner) {\n\t\t\t\tvar result = {\n\t\t\t\t\t\twidth: 0, height: 0,\n\t\t\t\t\t\tposition: {\n\t\t\t\t\t\t\ttop: 1e10, right: 0,\n\t\t\t\t\t\t\tbottom: 0, left: 1e10\n\t\t\t\t\t\t},\n\t\t\t\t\t\tadjustable: FALSE\n\t\t\t\t\t},\n\t\t\t\t\ti = 0, next,\n\t\t\t\t\tcoords = [],\n\t\t\t\t\tcompareX = 1, compareY = 1,\n\t\t\t\t\trealX = 0, realY = 0,\n\t\t\t\t\tnewWidth, newHeight;\n\n\t\t\t\t// First pass, sanitize coords and determine outer edges\n\t\t\t\ti = baseCoords.length;\n\t\t\t\twhile(i--) {\n\t\t\t\t\tnext = [ parseInt(baseCoords[--i], 10), parseInt(baseCoords[i+1], 10) ];\n\n\t\t\t\t\tif(next[0] > result.position.right){ result.position.right = next[0]; }\n\t\t\t\t\tif(next[0] < result.position.left){ result.position.left = next[0]; }\n\t\t\t\t\tif(next[1] > result.position.bottom){ result.position.bottom = next[1]; }\n\t\t\t\t\tif(next[1] < result.position.top){ result.position.top = next[1]; }\n\n\t\t\t\t\tcoords.push(next);\n\t\t\t\t}\n\n\t\t\t\t// Calculate height and width from outer edges\n\t\t\t\tnewWidth = result.width = Math.abs(result.position.right - result.position.left);\n\t\t\t\tnewHeight = result.height = Math.abs(result.position.bottom - result.position.top);\n\n\t\t\t\t// If it's the center corner...\n\t\t\t\tif(corner.abbrev() === 'c') {\n\t\t\t\t\tresult.position = {\n\t\t\t\t\t\tleft: result.position.left + result.width / 2,\n\t\t\t\t\t\ttop: result.position.top + result.height / 2\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Second pass, use a binary search algorithm to locate most suitable coordinate\n\t\t\t\t\twhile(newWidth > 0 && newHeight > 0 && compareX > 0 && compareY > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = Math.floor(newWidth / 2);\n\t\t\t\t\t\tnewHeight = Math.floor(newHeight / 2);\n\n\t\t\t\t\t\tif(corner.x === LEFT){ compareX = newWidth; }\n\t\t\t\t\t\telse if(corner.x === RIGHT){ compareX = result.width - newWidth; }\n\t\t\t\t\t\telse{ compareX += Math.floor(newWidth / 2); }\n\n\t\t\t\t\t\tif(corner.y === TOP){ compareY = newHeight; }\n\t\t\t\t\t\telse if(corner.y === BOTTOM){ compareY = result.height - newHeight; }\n\t\t\t\t\t\telse{ compareY += Math.floor(newHeight / 2); }\n\n\t\t\t\t\t\ti = coords.length;\n\t\t\t\t\t\twhile(i--)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif(coords.length < 2){ break; }\n\n\t\t\t\t\t\t\trealX = coords[i][0] - result.position.left;\n\t\t\t\t\t\t\trealY = coords[i][1] - result.position.top;\n\n\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\tcorner.x === LEFT && realX >= compareX ||\n\t\t\t\t\t\t\t\tcorner.x === RIGHT && realX <= compareX ||\n\t\t\t\t\t\t\t\tcorner.x === CENTER && (realX < compareX || realX > result.width - compareX) ||\n\t\t\t\t\t\t\t\tcorner.y === TOP && realY >= compareY ||\n\t\t\t\t\t\t\t\tcorner.y === BOTTOM && realY <= compareY ||\n\t\t\t\t\t\t\t\tcorner.y === CENTER && (realY < compareY || realY > result.height - compareY)) {\n\t\t\t\t\t\t\t\tcoords.splice(i, 1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tresult.position = { left: coords[0][0], top: coords[0][1] };\n\t\t\t\t}\n\n\t\t\t\treturn result;\n\t\t\t},\n\n\t\t\trect: function(ax, ay, bx, by) {\n\t\t\t\treturn {\n\t\t\t\t\twidth: Math.abs(bx - ax),\n\t\t\t\t\theight: Math.abs(by - ay),\n\t\t\t\t\tposition: {\n\t\t\t\t\t\tleft: Math.min(ax, bx),\n\t\t\t\t\t\ttop: Math.min(ay, by)\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\n\t\t\t_angles: {\n\t\t\t\ttc: 3 / 2, tr: 7 / 4, tl: 5 / 4,\n\t\t\t\tbc: 1 / 2, br: 1 / 4, bl: 3 / 4,\n\t\t\t\trc: 2, lc: 1, c: 0\n\t\t\t},\n\t\t\tellipse: function(cx, cy, rx, ry, corner) {\n\t\t\t\tvar c = PLUGINS.polys._angles[ corner.abbrev() ],\n\t\t\t\t\trxc = c === 0 ? 0 : rx * Math.cos( c * Math.PI ),\n\t\t\t\t\trys = ry * Math.sin( c * Math.PI );\n\n\t\t\t\treturn {\n\t\t\t\t\twidth: rx * 2 - Math.abs(rxc),\n\t\t\t\t\theight: ry * 2 - Math.abs(rys),\n\t\t\t\t\tposition: {\n\t\t\t\t\t\tleft: cx + rxc,\n\t\t\t\t\t\ttop: cy + rys\n\t\t\t\t\t},\n\t\t\t\t\tadjustable: FALSE\n\t\t\t\t};\n\t\t\t},\n\t\t\tcircle: function(cx, cy, r, corner) {\n\t\t\t\treturn PLUGINS.polys.ellipse(cx, cy, r, r, corner);\n\t\t\t}\n\t\t};\n\t\t;PLUGINS.svg = function(api, svg, corner)\n\t\t{\n\t\t\tvar elem = svg[0],\n\t\t\t\troot = $(elem.ownerSVGElement),\n\t\t\t\townerDocument = elem.ownerDocument,\n\t\t\t\tstrokeWidth2 = (parseInt(svg.css('stroke-width'), 10) || 0) / 2,\n\t\t\t\tframeOffset, mtx, transformed,\n\t\t\t\tlen, next, i, points,\n\t\t\t\tresult, position;\n\n\t\t\t// Ascend the parentNode chain until we find an element with getBBox()\n\t\t\twhile(!elem.getBBox) { elem = elem.parentNode; }\n\t\t\tif(!elem.getBBox || !elem.parentNode) { return FALSE; }\n\n\t\t\t// Determine which shape calculation to use\n\t\t\tswitch(elem.nodeName) {\n\t\t\t\tcase 'ellipse':\n\t\t\t\tcase 'circle':\n\t\t\t\t\tresult = PLUGINS.polys.ellipse(\n\t\t\t\t\t\telem.cx.baseVal.value,\n\t\t\t\t\t\telem.cy.baseVal.value,\n\t\t\t\t\t\t(elem.rx || elem.r).baseVal.value + strokeWidth2,\n\t\t\t\t\t\t(elem.ry || elem.r).baseVal.value + strokeWidth2,\n\t\t\t\t\t\tcorner\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'line':\n\t\t\t\tcase 'polygon':\n\t\t\t\tcase 'polyline':\n\t\t\t\t\t// Determine points object (line has none, so mimic using array)\n\t\t\t\t\tpoints = elem.points || [\n\t\t\t\t\t\t\t{ x: elem.x1.baseVal.value, y: elem.y1.baseVal.value },\n\t\t\t\t\t\t\t{ x: elem.x2.baseVal.value, y: elem.y2.baseVal.value }\n\t\t\t\t\t\t];\n\n\t\t\t\t\tfor(result = [], i = -1, len = points.numberOfItems || points.length; ++i < len;) {\n\t\t\t\t\t\tnext = points.getItem ? points.getItem(i) : points[i];\n\t\t\t\t\t\tresult.push.apply(result, [next.x, next.y]);\n\t\t\t\t\t}\n\n\t\t\t\t\tresult = PLUGINS.polys.polygon(result, corner);\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Unknown shape or rectangle? Use bounding box\n\t\t\t\tdefault:\n\t\t\t\t\tresult = elem.getBBox();\n\t\t\t\t\tresult = {\n\t\t\t\t\t\twidth: result.width,\n\t\t\t\t\t\theight: result.height,\n\t\t\t\t\t\tposition: {\n\t\t\t\t\t\t\tleft: result.x,\n\t\t\t\t\t\t\ttop: result.y\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Shortcut assignments\n\t\t\tposition = result.position;\n\t\t\troot = root[0];\n\n\t\t\t// Convert position into a pixel value\n\t\t\tif(root.createSVGPoint) {\n\t\t\t\tmtx = elem.getScreenCTM();\n\t\t\t\tpoints = root.createSVGPoint();\n\n\t\t\t\tpoints.x = position.left;\n\t\t\t\tpoints.y = position.top;\n\t\t\t\ttransformed = points.matrixTransform( mtx );\n\t\t\t\tposition.left = transformed.x;\n\t\t\t\tposition.top = transformed.y;\n\t\t\t}\n\n\t\t\t// Check the element is not in a child document, and if so, adjust for frame elements offset\n\t\t\tif(ownerDocument !== document && api.position.target !== 'mouse') {\n\t\t\t\tframeOffset = $((ownerDocument.defaultView || ownerDocument.parentWindow).frameElement).offset();\n\t\t\t\tif(frameOffset) {\n\t\t\t\t\tposition.left += frameOffset.left;\n\t\t\t\t\tposition.top += frameOffset.top;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Adjust by scroll offset of owner document\n\t\t\townerDocument = $(ownerDocument);\n\t\t\tposition.left += ownerDocument.scrollLeft();\n\t\t\tposition.top += ownerDocument.scrollTop();\n\n\t\t\treturn result;\n\t\t};\n\t\t;PLUGINS.imagemap = function(api, area, corner)\n\t\t{\n\t\t\tif(!area.jquery) { area = $(area); }\n\n\t\t\tvar shape = (area.attr('shape') || 'rect').toLowerCase().replace('poly', 'polygon'),\n\t\t\t\timage = $('img[usemap=\"#'+area.parent('map').attr('name')+'\"]'),\n\t\t\t\tcoordsString = $.trim(area.attr('coords')),\n\t\t\t\tcoordsArray = coordsString.replace(/,$/, '').split(','),\n\t\t\t\timageOffset, coords, i, result, len;\n\n\t\t\t// If we can't find the image using the map...\n\t\t\tif(!image.length) { return FALSE; }\n\n\t\t\t// Pass coordinates string if polygon\n\t\t\tif(shape === 'polygon') {\n\t\t\t\tresult = PLUGINS.polys.polygon(coordsArray, corner);\n\t\t\t}\n\n\t\t\t// Otherwise parse the coordinates and pass them as arguments\n\t\t\telse if(PLUGINS.polys[shape]) {\n\t\t\t\tfor(i = -1, len = coordsArray.length, coords = []; ++i < len;) {\n\t\t\t\t\tcoords.push( parseInt(coordsArray[i], 10) );\n\t\t\t\t}\n\n\t\t\t\tresult = PLUGINS.polys[shape].apply(\n\t\t\t\t\tthis, coords.concat(corner)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// If no shapre calculation method was found, return false\n\t\t\telse { return FALSE; }\n\n\t\t\t// Make sure we account for padding and borders on the image\n\t\t\timageOffset = image.offset();\n\t\t\timageOffset.left += Math.ceil((image.outerWidth(FALSE) - image.width()) / 2);\n\t\t\timageOffset.top += Math.ceil((image.outerHeight(FALSE) - image.height()) / 2);\n\n\t\t\t// Add image position to offset coordinates\n\t\t\tresult.position.left += imageOffset.left;\n\t\t\tresult.position.top += imageOffset.top;\n\n\t\t\treturn result;\n\t\t};\n\t\t;var IE6,\n\n\t\t\t/*\n\t\t\t * BGIFrame adaption (http://plugins.jquery.com/project/bgiframe)\n\t\t\t * Special thanks to Brandon Aaron\n\t\t\t */\n\t\t\tBGIFRAME = '<iframe class=\"qtip-bgiframe\" frameborder=\"0\" tabindex=\"-1\" src=\"javascript:\\'\\';\" ' +\n\t\t\t\t' style=\"display:block; position:absolute; z-index:-1; filter:alpha(opacity=0); ' +\n\t\t\t\t'-ms-filter:\"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)\";\"></iframe>';\n\n\t\tfunction Ie6(api) {\n\t\t\tthis._ns = 'ie6';\n\n\t\t\tthis.qtip = api;\n\t\t\tthis.init(api);\n\t\t}\n\n\t\t$.extend(Ie6.prototype, {\n\t\t\t_scroll : function() {\n\t\t\t\tvar overlay = this.qtip.elements.overlay;\n\t\t\t\toverlay && (overlay[0].style.top = $(window).scrollTop() + 'px');\n\t\t\t},\n\n\t\t\tinit: function(qtip) {\n\t\t\t\tvar tooltip = qtip.tooltip;\n\n\t\t\t\t// Create the BGIFrame element if needed\n\t\t\t\tif($('select, object').length < 1) {\n\t\t\t\t\tthis.bgiframe = qtip.elements.bgiframe = $(BGIFRAME).appendTo(tooltip);\n\n\t\t\t\t\t// Update BGIFrame on tooltip move\n\t\t\t\t\tqtip._bind(tooltip, 'tooltipmove', this.adjustBGIFrame, this._ns, this);\n\t\t\t\t}\n\n\t\t\t\t// redraw() container for width/height calculations\n\t\t\t\tthis.redrawContainer = $('<div/>', { id: NAMESPACE+'-rcontainer' })\n\t\t\t\t\t.appendTo(document.body);\n\n\t\t\t\t// Fixup modal plugin if present too\n\t\t\t\tif( qtip.elements.overlay && qtip.elements.overlay.addClass('qtipmodal-ie6fix') ) {\n\t\t\t\t\tqtip._bind(window, ['scroll', 'resize'], this._scroll, this._ns, this);\n\t\t\t\t\tqtip._bind(tooltip, ['tooltipshow'], this._scroll, this._ns, this);\n\t\t\t\t}\n\n\t\t\t\t// Set dimensions\n\t\t\t\tthis.redraw();\n\t\t\t},\n\n\t\t\tadjustBGIFrame: function() {\n\t\t\t\tvar tooltip = this.qtip.tooltip,\n\t\t\t\t\tdimensions = {\n\t\t\t\t\t\theight: tooltip.outerHeight(FALSE),\n\t\t\t\t\t\twidth: tooltip.outerWidth(FALSE)\n\t\t\t\t\t},\n\t\t\t\t\tplugin = this.qtip.plugins.tip,\n\t\t\t\t\ttip = this.qtip.elements.tip,\n\t\t\t\t\ttipAdjust, offset;\n\n\t\t\t\t// Adjust border offset\n\t\t\t\toffset = parseInt(tooltip.css('borderLeftWidth'), 10) || 0;\n\t\t\t\toffset = { left: -offset, top: -offset };\n\n\t\t\t\t// Adjust for tips plugin\n\t\t\t\tif(plugin && tip) {\n\t\t\t\t\ttipAdjust = plugin.corner.precedance === 'x' ? [WIDTH, LEFT] : [HEIGHT, TOP];\n\t\t\t\t\toffset[ tipAdjust[1] ] -= tip[ tipAdjust[0] ]();\n\t\t\t\t}\n\n\t\t\t\t// Update bgiframe\n\t\t\t\tthis.bgiframe.css(offset).css(dimensions);\n\t\t\t},\n\n\t\t\t// Max/min width simulator function\n\t\t\tredraw: function() {\n\t\t\t\tif(this.qtip.rendered < 1 || this.drawing) { return this; }\n\n\t\t\t\tvar tooltip = this.qtip.tooltip,\n\t\t\t\t\tstyle = this.qtip.options.style,\n\t\t\t\t\tcontainer = this.qtip.options.position.container,\n\t\t\t\t\tperc, width, max, min;\n\n\t\t\t\t// Set drawing flag\n\t\t\t\tthis.qtip.drawing = 1;\n\n\t\t\t\t// If tooltip has a set height/width, just set it... like a boss!\n\t\t\t\tif(style.height) { tooltip.css(HEIGHT, style.height); }\n\t\t\t\tif(style.width) { tooltip.css(WIDTH, style.width); }\n\n\t\t\t\t// Simulate max/min width if not set width present...\n\t\t\t\telse {\n\t\t\t\t\t// Reset width and add fluid class\n\t\t\t\t\ttooltip.css(WIDTH, '').appendTo(this.redrawContainer);\n\n\t\t\t\t\t// Grab our tooltip width (add 1 if odd so we don't get wrapping problems.. huzzah!)\n\t\t\t\t\twidth = tooltip.width();\n\t\t\t\t\tif(width % 2 < 1) { width += 1; }\n\n\t\t\t\t\t// Grab our max/min properties\n\t\t\t\t\tmax = tooltip.css('maxWidth') || '';\n\t\t\t\t\tmin = tooltip.css('minWidth') || '';\n\n\t\t\t\t\t// Parse into proper pixel values\n\t\t\t\t\tperc = (max + min).indexOf('%') > -1 ? container.width() / 100 : 0;\n\t\t\t\t\tmax = (max.indexOf('%') > -1 ? perc : 1 * parseInt(max, 10)) || width;\n\t\t\t\t\tmin = (min.indexOf('%') > -1 ? perc : 1 * parseInt(min, 10)) || 0;\n\n\t\t\t\t\t// Determine new dimension size based on max/min/current values\n\t\t\t\t\twidth = max + min ? Math.min(Math.max(width, min), max) : width;\n\n\t\t\t\t\t// Set the newly calculated width and remvoe fluid class\n\t\t\t\t\ttooltip.css(WIDTH, Math.round(width)).appendTo(container);\n\t\t\t\t}\n\n\t\t\t\t// Set drawing flag\n\t\t\t\tthis.drawing = 0;\n\n\t\t\t\treturn this;\n\t\t\t},\n\n\t\t\tdestroy: function() {\n\t\t\t\t// Remove iframe\n\t\t\t\tthis.bgiframe && this.bgiframe.remove();\n\n\t\t\t\t// Remove bound events\n\t\t\t\tthis.qtip._unbind([window, this.qtip.tooltip], this._ns);\n\t\t\t}\n\t\t});\n\n\t\tIE6 = PLUGINS.ie6 = function(api) {\n\t\t\t// Proceed only if the browser is IE6\n\t\t\treturn BROWSER.ie === 6 ? new Ie6(api) : FALSE;\n\t\t};\n\n\t\tIE6.initialize = 'render';\n\n\t\tCHECKS.ie6 = {\n\t\t\t'^content|style$': function() {\n\t\t\t\tthis.redraw();\n\t\t\t}\n\t\t};\n\t\t;}));\n}( window, document ));\n\n",
    "/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2017 (original work) Open Assessment Technologies SA;\n */\n/**\n * @author Christophe Nol <christophe@taotesting.com>\n */\ndefine('taoQtiItem/portableLib/OAT/util/tooltip',[\n    'taoQtiItem/portableLib/jquery_2_1_1',\n    'taoQtiItem/portableLib/jquery.qtip'\n], function($) {\n    'use strict';\n\n    return {\n        render: function render($container) {\n            $container.find('[data-role=\"tooltip-target\"]').each(function(){\n                var $target = $(this),\n                    $content,\n                    contentId = $target.attr('aria-describedBy'),\n                    contentHtml;\n\n                if (contentId) {\n                    $content = $container.find('#' + contentId);\n                    if ($content.length) {\n                        contentHtml = $content.html();\n\n                        $target.qtip({\n                            overwrite: true,\n                            theme: 'default',\n                            content: {\n                                text: contentHtml\n                            },\n                            position: {\n                                target: 'event',\n                                my: 'bottom center',\n                                at: 'top center'\n                            }\n                        });\n                    }\n                }\n            });\n        }\n    };\n});\n",
    "/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2017 (original work) Open Assessment Technologies SA;\n */\ndefine('taoQtiItem/portableLib/OAT/util/html',[\n    'taoQtiItem/portableLib/OAT/util/xml',\n    'taoQtiItem/portableLib/OAT/util/math',\n    'taoQtiItem/portableLib/OAT/util/tooltip'\n], function(xml, math, tooltip){\n    'use strict';\n\n    return {\n        render : function render($container){\n            var markup = $container.html();\n\n            //remove xml ns (would break jquery selector otherwise)\n            markup = xml.removeNamespace(markup);\n            $container.html(markup);\n\n            //render math\n            math.render($container);\n\n            //render tooltip\n            tooltip.render($container);\n        }\n    };\n});\n",
    "/*  Snap a programming environment\r\n    based on morphic.js, blocks.js, threads.js and objects.js\r\n    inspired by Scratch\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is bundel version of Snap build as a part of a PCI for TAO plateform.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n     \r\n    modified by Jean-Philippe Rivire - Wiquid for TAO - 2018\r\n\r\n    */\r\n\r\ndefine('SnapForTao/runtime/js/lib/snapsrc',[], function(){\r\n    'use strict';\r\n\r\n    //************ Wiquid ************************\r\n\r\n    var panel_Left, stageSaver, worldwatcher;\r\n    var attemptLimit =0; // for try counter\r\n    var snapsrc = {}; // snapsrc global object\r\n    snapsrc.actionOrder = 0; // Order block manip. for Tao answering system\r\n   \r\n\r\n   \r\n\r\n    snapsrc.snap = function(id, $container, config){\r\n    //*****************************************\r\n    \t// Global stuff\r\n\t\tvar Localizer;\r\n        var SnapTranslator = new Localizer();\r\n        var importString = \"\";\r\n        var getSnapProjectScript =\"scriptPlaceHolder\";        \r\n        if(config.snapScript==\"shield\"){importString=\"\";}\r\n        else{ importString = config.snapScript; \r\n        }\r\n        var allMorphs = []; //xdone\r\n        var grabOrigine; //xdone\r\n\r\n\t\tfunction localize(string) {\r\n\t\t    return SnapTranslator.translate(string);\r\n\r\n\t\t}\r\n\r\n\t\tfunction Localizer(language, dict) {\r\n\t\t this.language = language || 'en';\r\n    \t this.dict = dict || {};\r\n        }\r\n\r\nLocalizer.prototype.translate = function (string) {\r\n    return Object.prototype.hasOwnProperty.call(\r\n        this.dict[this.language],\r\n        string\r\n    ) ? this.dict[this.language][string] : string;\r\n};\r\n\r\nLocalizer.prototype.languages = function () {\r\n    var property, arr = [];\r\n    for (property in this.dict) {\r\n        if (Object.prototype.hasOwnProperty.call(this.dict, property)) {\r\n            arr.push(property);\r\n        }\r\n    }\r\n    return arr.sort();\r\n};\r\n\r\nLocalizer.prototype.languageName = function (lang) {\r\n    return this.dict[lang].language_name || lang;\r\n};\r\n\r\nLocalizer.prototype.credits = function () {\r\n    var txt = '',\r\n        myself = this;\r\n    this.languages().forEach(function (lang) {\r\n        txt = txt + '\\n'\r\n            + myself.languageName(lang)\r\n            + ' (' + lang + ') - '\r\n            + myself.dict[lang].language_translator\r\n            + ' - ' + myself.dict[lang].last_changed;\r\n    });\r\n    return txt;\r\n};\r\n\r\nLocalizer.prototype.unload = function () {\r\n    var dict,\r\n        keep = ['language_name', 'language_translator', 'last_changed'],\r\n        myself = this;\r\n    this.languages().forEach(function (lang) {\r\n        var key;\r\n        if (lang !== 'en') {\r\n            dict = myself.dict[lang];\r\n            for (key in dict) {\r\n                if (Object.prototype.hasOwnProperty.call(dict, key)\r\n                        && !contains(keep, key)) {\r\n                    delete dict[key];\r\n                }\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n// SnapTranslator initialization\r\n\r\nSnapTranslator.dict.en = {\r\n    // meta information\r\n    'language_name':\r\n        'English',\r\n    'language_translator':\r\n        'Jens M\\u00F6nig',\r\n    'translator_e-mail':\r\n        'jens@moenig.org',\r\n    'last_changed':\r\n        '2015-12-22',\r\n\r\n    // rewordings in English avoiding having to adjust all other translations\r\n    'any':\r\n        'random',\r\n\r\n    // long strings look-up only\r\n    'file menu import hint':\r\n        'load an exported project file\\nor block library, a costume\\n'\r\n            + 'or a sound',\r\n    'settings menu prefer empty slots hint':\r\n        'check to focus on empty slots\\nwhen dragging & '\r\n                + 'dropping reporters',\r\n    'costumes tab help':\r\n        'import a picture from another web page or from\\n'\r\n            + 'a file on your computer by dropping it here\\n',\r\n    'block deletion dialog text':\r\n        'Are you sure you want to delete this\\n'\r\n            + 'custom block and all its instances?',\r\n    'download to disk text':\r\n        'This item could not be opened in a new tab.\\n' +\r\n        'It has been saved to your browser\\'s downloads folder.',\r\n    'unable to export text':\r\n        'This item could not be exported from Snap!.\\n' +\r\n        'It\\'s likely that your project may contain a lot of media ' +\r\n        '(sounds and images) or that you are using an older browser.' +\r\n        'Please try using a recent version of Chrome, Firefox, or Safari.'\r\n};\r\n\r\nSnapTranslator.dict.fr = {\r\n    'language_name':\r\n        'Fran\\u00E7ais',\r\n    'language_translator':\r\n        'Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli',\r\n    'translator_e-mail':\r\n        'i.scool@mac.com',\r\n    'last_changed':\r\n        '2016-10-27'\r\n};\r\n\r\n//DEBUT DE MORPHIC\r\n/*\r\n\r\n// Global settings /////////////////////////////////////////////////////\r\n\r\n/*global window, HTMLCanvasElement, FileReader, Audio, FileList*/\r\n\r\nvar morphicVersion = '2017-September-26';\r\nvar modules = {}; // keep track of additional loaded modules\r\nvar useBlurredShadows = getBlurredShadowSupport(); // check for Chrome-bug\r\n\r\nvar standardSettings = {\r\n    minimumFontHeight: getMinimumFontHeight(), // browser settings\r\n    globalFontFamily: '',\r\n    menuFontName: 'sans-serif',\r\n    menuFontSize: 12,\r\n    bubbleHelpFontSize: 10,\r\n    prompterFontName: 'sans-serif',\r\n    prompterFontSize: 12,\r\n    prompterSliderSize: 10,\r\n    handleSize: 15,\r\n    scrollBarSize: 12,\r\n    mouseScrollAmount: 40,\r\n    useSliderForInput: false,\r\n    useVirtualKeyboard: true,\r\n    isTouchDevice: false, // turned on by touch events, don't set\r\n    rasterizeSVGs: false,\r\n    isFlat: false,\r\n    grabThreshold: 5\r\n};\r\n\r\nvar touchScreenSettings = {\r\n    minimumFontHeight: standardSettings.minimumFontHeight,\r\n    globalFontFamily: '',\r\n    menuFontName: 'sans-serif',\r\n    menuFontSize: 24,\r\n    bubbleHelpFontSize: 18,\r\n    prompterFontName: 'sans-serif',\r\n    prompterFontSize: 24,\r\n    prompterSliderSize: 20,\r\n    handleSize: 26,\r\n    scrollBarSize: 24,\r\n    mouseScrollAmount: 40,\r\n    useSliderForInput: true,\r\n    useVirtualKeyboard: true,\r\n    isTouchDevice: false,\r\n    rasterizeSVGs: false,\r\n    isFlat: false,\r\n    grabThreshold: 5\r\n};\r\n\r\nvar MorphicPreferences = standardSettings;\r\n\r\n// first, try enabling support for retina displays - can be turned off later\r\n\r\n/*\r\n    Support for retina displays has been pioneered and contributed by\r\n    Bartosz Leper.\r\n\r\n    NOTE: this will make changes to the HTMLCanvasElement that - mostly -\r\n    make Morphic usable on retina displays in very high resolution mode\r\n    with crisp fonts and clear fine lines without you (the programmer)\r\n    needing to know any specifics, provided both the display and the browser\r\n    support these (Safari currently doesn't), otherwise these utilities will\r\n    not be installed.\r\n    If you don't want your Morphic application to support retina resolutions\r\n    you don't have to edit this morphic.js file to comment out the next line\r\n    of code, instead you can simply call\r\n\r\n        disableRetinaSupport();\r\n\r\n    before you create your World(s) in the html page. Disabling retina\r\n    support also will simply do nothing if retina support is not possible\r\n    or already disabled, so it's equally safe to call.\r\n\r\n    For an example how to make retina support user-specifiable refer to\r\n    Snap! >> guis.js >> toggleRetina()\r\n*/\r\n\r\nenableRetinaSupport();\r\n\r\n// Global Functions ////////////////////////////////////////////////////\r\n\r\nfunction nop() {\r\n    // do explicitly nothing\r\n    return null;\r\n}\r\n\r\nvar dicofr =  {\r\n\r\n/*\r\n    Special characters: (see <http://0xcc.net/jsescape/>)\r\n\r\n          \\u00C0\r\n          \\u00E0\r\n          \\u00C9\r\n          \\u00E8\r\n          \\u00E9\r\n          \\u00EA\r\n          \\u00E7\r\n          \\u00EF\r\n          \\u00F4\r\n          \\u00F9\r\n          \\u00B0\r\n    '      \\u0027\r\n          \\u00AB\r\n          \\u00BB\r\n          \\u2194\r\n          \\u2195\r\n*/\r\n\r\n    // translations meta information\r\n    'language_name':\r\n        'Fran\\u00E7ais', // the name as it should appear in the language menu\r\n    'language_translator':\r\n        'Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli', // your name for the Translators tab\r\n    'translator_e-mail':\r\n        'i.scool@mac.com', // optional\r\n    'last_changed':\r\n        '2016-10-27', // this, too, will appear in the Translators tab\r\n\r\n    // GUI\r\n    // control bar:\r\n    'untitled':\r\n        'Sans Titre',\r\n    'development mode':\r\n        'mode d\\u00E9veloppeur',\r\n\r\n    // categories:\r\n    'Motion':\r\n        'Mouvement',\r\n    'Looks':\r\n        'Apparence',\r\n    'Sound':\r\n        'Sons',\r\n    'Pen':\r\n        'Stylo',\r\n    'Control':\r\n        'Contr\\u00F4les',\r\n    'Sensing':\r\n        'Capteurs',\r\n    'Operators':\r\n        'Op\\u00E9rateurs',\r\n    'Variables':\r\n        'Variables',\r\n    'Lists':\r\n        'Listes',\r\n    'Other':\r\n        'Autres',\r\n\r\n    // editor:\r\n    'draggable':\r\n        'd\\u00E9pla\\u00E7able avec la souris',\r\n\r\n    // tabs:\r\n    'Scripts':\r\n        'Scripts',\r\n    'Costumes':\r\n        'Costumes',\r\n    'Sounds':\r\n        'Sons',\r\n\r\n   // names:\r\n    'Sprite':\r\n        'Lutin',\r\n    'Stage':\r\n        'Sc\\u00E8ne',\r\n\r\n    // rotation styles:\r\n    'don\\'t rotate':\r\n        'le lutin ne pivote jamais',\r\n    'can rotate':\r\n        'le lutin pivote \\nautour de son centre de rotation',\r\n    'only face left/right':\r\n        'le lutin reste en position horizontale \\nsoit vers la gauche soit vers la droite ',\r\n\r\n    // new sprite button:\r\n    'add a new sprite':\r\n        'ajouter un nouveau lutin',\r\n    'add a new Turtle sprite':\r\n        'ajouter un nouveau lutin Tortue',\r\n\r\n    // tab help\r\n    'costumes tab help':\r\n        'Importer une image depuis votre ordinateur ou une page web \\npar un presser-glisser-d\\u00E9poser dans l\\u0027aire des costumes',\r\n    'import a sound from your computer\\nby dragging it into here':\r\n        'Importer un son depuis votre ordinateur \\npar un presser-glisser-d\\u00E9poser dans l\\u0027aire des sons',\r\n\r\n    // primitive blocks:\r\n\r\n    /*\r\n        Attention Translators:\r\n        ----------------------\r\n        At this time your translation of block specs will only work\r\n        correctly, if the order of formal parameters and their types\r\n        are unchanged. Placeholders for inputs (formal parameters) are\r\n        indicated by a preceding % prefix and followed by a type\r\n        abbreviation.\r\n\r\n        For example:\r\n\r\n            'say %s for %n secs'\r\n\r\n        can currently not be changed into\r\n\r\n            'say %n secs long %s'\r\n\r\n        and still work as intended.\r\n\r\n        Similarly\r\n\r\n            'point towards %dst'\r\n\r\n        cannot be changed into\r\n\r\n            'point towards %cst'\r\n\r\n        without breaking its functionality.\r\n    */\r\n\r\n     // motion:\r\n    'Stage selected:\\nno motion primitives':\r\n        'Sc\\u00E8ne s\\u00E9lectionn\\u00E9e :\\naucune brique de d\\u00E9pla\\u00E7ement',\r\n\r\n    'move %n steps':\r\n        'avancer de %n pas',\r\n    'turn %clockwise %n degrees':\r\n        'tourner de %n degr\\u00E9s %clockwise',\r\n    'turn %counterclockwise %n degrees':\r\n        'tourner de %n degr\\u00E9s %counterclockwise',\r\n    'point in direction %dir':\r\n        'se diriger en faisant un angle de %dir',\r\n    'point towards %dst':\r\n        'se diriger vers %dst',\r\n    'go to x: %n y: %n':\r\n        'aller \\u00E0 x: %n y: %n',\r\n    'go to %dst':\r\n        'aller \\u00E0 %dst',\r\n    'glide %n secs to x: %n y: %n':\r\n        'glisser en %n sec. \\u00E0 x: %n y: %n',\r\n    'change x by %n':\r\n        'ajouter %n \\u00E0 x',\r\n    'set x to %n':\r\n        'donner la valeur %n \\u00E0 x',\r\n    'change y by %n':\r\n        'ajouter %n \\u00E0 y',\r\n    'set y to %n':\r\n        'donner la valeur %n \\u00E0 y',\r\n    'if on edge, bounce':\r\n        'rebondir si le bord est atteint',\r\n    'x position':\r\n        'position x',\r\n    'y position':\r\n        'position y',\r\n    'direction':\r\n        'direction',\r\n\r\n    // looks:\r\n    'switch to costume %cst':\r\n        'basculer sur le costume %cst',\r\n    'next costume':\r\n        'costume suivant',\r\n    'costume #':\r\n        'costume n\\u00B0',\r\n    'say %s for %n secs':\r\n        'dire %s pendant %n sec.',\r\n    'say %s':\r\n        'dire %s',\r\n    'think %s for %n secs':\r\n        'penser %s pendant %n sec.',\r\n    'think %s':\r\n        'penser %s',\r\n    'Hello!':\r\n        'Salut !',\r\n    'Hmm...':\r\n        'Mmmh...',\r\n    'change %eff effect by %n':\r\n        'ajouter \\u00E0 l\\u0027effet %eff %n',\r\n    'set %eff effect to %n':\r\n        'mettre l\\u0027effet %eff \\u00E0 %n',\r\n    'clear graphic effects':\r\n        'annuler les effets graphiques',\r\n    'change size by %n':\r\n        'ajouter %n \\u00E0 la taille',\r\n    'set size to %n %':\r\n        'choisir %n % de la taille initiale',\r\n    'size':\r\n        'taille',\r\n    'show':\r\n        'montrer',\r\n    'hide':\r\n        'cacher',\r\n    'go to front':\r\n        'envoyer au premier plan',\r\n    'go back %n layers':\r\n        'd\\u00E9placer de %n plan arri\\u00E8re',\r\n\r\n    'development mode \\ndebugging primitives:':\r\n        'mode d\\u00E9veloppement \\ndebugging primitives:',\r\n    'console log %mult%s':\r\n        'console log %mult%s',\r\n    'alert %mult%s':\r\n        'Pop-up: %mult%s',\r\n\r\n    // sound:\r\n    'play sound %snd':\r\n        'jouer le son %snd',\r\n    'play sound %snd until done':\r\n        'jouer le son %snd jusqu\\u0027au bout',\r\n    'stop all sounds':\r\n        'arr\\u00EAter tous les sons',\r\n    'rest for %n beats':\r\n        'faire une pause pour %n temps',\r\n    'play note %n for %n beats':\r\n        'jouer la note %n pour %n temps',\r\n    'change tempo by %n':\r\n        'ajouter %n au tempo',\r\n    'set tempo to %n bpm':\r\n        'choisir le tempo \\u00E0 %n bpm',\r\n    'tempo':\r\n        'tempo',\r\n\r\n    // pen:\r\n    'clear':\r\n        'effacer tout',\r\n    'pen down':\r\n        'stylo en position d\\u0027\\u00E9criture',\r\n    'pen up':\r\n        'relever le stylo',\r\n    'set pen color to %clr':\r\n        'mettre la couleur %clr pour le stylo',\r\n    'change pen color by %n':\r\n        'ajouter %n \\u00E0 la couleur du stylo',\r\n    'set pen color to %n':\r\n        'choisir la couleur %n pour le stylo',\r\n    'change pen shade by %n':\r\n        'ajouter %n \\u00E0 l\\u0027intensit\\u00E9 du stylo ',\r\n    'set pen shade to %n':\r\n        'choisir l\\u0027intensit\\u00E9 %n pour le stylo',\r\n    'change pen size by %n':\r\n        'ajouter %n \\u00E0 la taille du stylo ',\r\n    'set pen size to %n':\r\n        'choisir la taille %n pour le stylo',\r\n    'stamp':\r\n        'estampiller',\r\n    'fill':\r\n        'remplir',\r\n\r\n      // control:\r\n    'when %greenflag clicked':\r\n        'Quand %greenflag est press\\u00E9',\r\n    'when %keyHat key pressed':\r\n        'Quand %keyHat est press\\u00E9',\r\n    'when I am clicked':\r\n        'Quand je suis press\\u00E9 ',\r\n  'when I am %interaction':\r\n    'Quand je suis %interaction',\r\n    'when I receive %msgHat':\r\n        'Quand je re\\u00E7ois %msgHat',\r\n    'broadcast %msg':\r\n        'envoyer \\u00E0 tous %msg',\r\n    'broadcast %msg and wait':\r\n        'envoyer \\u00E0 tous %msg et attendre',\r\n    'Message name':\r\n        'Nom du message',\r\n    'wait %n secs':\r\n        'attendre %n sec.',\r\n    'wait until %b':\r\n        'attendre jusqu\\u0027\\u00E0 %b',\r\n    'forever %c':\r\n        'r\\u00E9p\\u00E9ter ind\\u00E9finiment %c',\r\n    'repeat %n %c':\r\n        'r\\u00E9p\\u00E9ter %n fois %c',\r\n    'repeat until %b %c':\r\n        'r\\u00E9p\\u00E9ter jusqu\\u0027\\u00E0 %b %c',\r\n    'if %b %c':\r\n        'si %b %c',\r\n    'if %b %c else %c':\r\n        'si %b %c sinon %c',\r\n    'report %s':\r\n        'rapporte %s',\r\n    'stop block':\r\n        'arr\\u00EAter le bloc',\r\n    'stop script':\r\n        'arr\\u00EAter le script',\r\n  'stop %stopOthersChoices':\r\n    'arr\\u00EAter %stopOthersChoices',\r\n  'stop %stopChoices':\r\n    'arr\\u00EAter %stopChoices',\r\n    'stop all %stop':\r\n        'arr\\u00EAter tout %stop',\r\n    'run %cmdRing %inputs':\r\n        'ex\\u00E9cute %cmdRing  %inputs',\r\n    'launch %cmdRing %inputs':\r\n        'lance %cmdRing %inputs',\r\n    'call %repRing %inputs':\r\n        'appelle %repRing %inputs',\r\n    'run %cmdRing w/continuation':\r\n        'ex\\u00E9cute %cmdRing avec continuation',\r\n    'call %cmdRing w/continuation':\r\n        'appelle %cmdRing avec continuation',\r\n    'warp %c':\r\n        'Englobe %c',\r\n    'when I start as a clone':\r\n        'Quand je commence comme clone',\r\n    'create a clone of %cln':\r\n        'Clone %cln',\r\n    'myself':\r\n        'moi-m\\u00EAme',\r\n    'delete this clone':\r\n        'supprime ce clone',\r\n    'pause all %pause':\r\n        'mettre en pause %pause',\r\n  'all but this script':\r\n    'tout sauf ce script',\r\n  'other scripts in sprite':\r\n    'les autres scripts de ce lutin',\r\n  'this script':\r\n    'ce script',\r\n  'this block':\r\n    'ce bloc',\r\n\r\n     // sensing:\r\n    'touching %col ?':\r\n        '%col touch\\u00E9 ?',\r\n    'touching %clr ?':\r\n        'couleur %clr touch\\u00E9e ?',\r\n    'color %clr is touching %clr ?':\r\n        'couleur %clr touche %clr ?',\r\n    'ask %s and wait':\r\n        'demander %s et attendre',\r\n    'what\\'s your name?':\r\n        'Quel est ton nom ?',\r\n    'answer':\r\n        'r\\u00E9ponse',\r\n    'mouse x':\r\n        'souris x',\r\n    'mouse y':\r\n        'souris y',\r\n    'mouse down?':\r\n        'souris press\\u00E9e ?',\r\n    'key %key pressed?':\r\n        'touche %key press\\u00E9e ?',\r\n    'distance to %dst':\r\n        'distance de %dst',\r\n    'reset timer':\r\n        'r\\u00E9initialiser le chronom\\u00E8tre',\r\n    'timer':\r\n        'chronom\\u00E8tre',\r\n    '%att of %spr':\r\n        '%att de %spr',\r\n    'my %get':\r\n        'attribut %get',\r\n    'http:// %s':\r\n        'http:// %s',\r\n    'turbo mode?':\r\n        'turbo mode activ\\u00E9 ?',\r\n    'set turbo mode to %b':\r\n        'turbo mode prend la valeur %b',\r\n\r\n    'filtered for %clr':\r\n        'filtr\\u00E9 pour %clr',\r\n    'stack size':\r\n        'taille de la pile',\r\n    'frames':\r\n        'cadres',\r\n\r\n    // operators:\r\n    '%n mod %n':\r\n        '%n mod %n',\r\n    'round %n':\r\n        'arrondi de %n',\r\n    '%fun of %n':\r\n        '%fun appliqu\\u00E9 \\u00E0 %n',\r\n    'pick random %n to %n':\r\n        'nombre al\\u00E9atoire entre %n et %n',\r\n    '%b and %b':\r\n        '%b et %b',\r\n    '%b or %b':\r\n        '%b ou %b',\r\n    'not %b':\r\n        'non %b',\r\n    'true':\r\n        'vrai',\r\n    'false':\r\n        'faux',\r\n    'join %words':\r\n        'regroupe %words',\r\n    'split %s by %delim':\r\n        'd\\u00E9coupe %s entre les %delim',\r\n    'hello':\r\n        'Bonjour',\r\n    'world':\r\n        'Monde',\r\n    'letter %n of %s':\r\n        'lettre %n de %s',\r\n    'length of %s':\r\n        'longueur de %s',\r\n    'unicode of %s':\r\n        'valeur unicode de %s',\r\n    'unicode %n as letter':\r\n        'unicode %n comme lettre',\r\n    'is %s a %typ ?':\r\n        '%s est un(e) %typ ?',\r\n    'is %s identical to %s ?':\r\n        '%s est identique \\u00E0 %s ?',\r\n\r\n    'type of %s':\r\n        'type de %s',\r\n\r\n     // variables:\r\n    'Make a variable':\r\n        'Nouvelle variable',\r\n    'Variable name':\r\n        'Nom de la variable',\r\n    'Delete a variable':\r\n        'Supprimer une variable',\r\n\r\n    'set %var to %s':\r\n        '%var prend la valeur %s',\r\n    'change %var by %n':\r\n        'ajouter \\u00E0 %var %n',\r\n    'show variable %var':\r\n        'afficher la variable %var',\r\n    'hide variable %var':\r\n        'cacher la variable %var',\r\n    'script variables %scriptVars':\r\n        'variables du script %scriptVars',\r\n\r\n    // lists:\r\n    'list %exp':\r\n        'liste %exp',\r\n    '%s in front of %l':\r\n        '%s au d\\u00E9but de %l',\r\n    'item %idx of %l':\r\n        '\\u00E9l\\u00E9ment %idx de %l',\r\n    'all but first of %l':\r\n        'tous sauf le premier de %l',\r\n    'length of %l':\r\n        'longueur de %l',\r\n    '%l contains %s':\r\n        '%l contient %s',\r\n    'thing':\r\n        'qqchose',\r\n    'add %s to %l':\r\n        'ajouter %s \\u00E0 %l',\r\n    'delete %ida of %l':\r\n        'supprimer l\\u0027\\u00E9l\\u00E9ment %ida de %l',\r\n    'insert %s at %idx of %l':\r\n        'ins\\u00E9rer %s en position %idx de %l',\r\n    'replace item %idx of %l with %s':\r\n        'remplacer l\\u0027\\u00E9l\\u00E9ment %idx de %l par %s',\r\n\r\n    // other\r\n    'Make a block':\r\n        'Nouveau bloc',\r\n\r\n   // menus\r\n    // snap menu\r\n    'About...':\r\n        '\\u00C0 propos de Snap!...',\r\n    'Reference manual':\r\n        'Manuel de r\\u00E9f\\u00E9rence',\r\n    'Snap! website':\r\n        'Snap! le site web',\r\n    'Download source':\r\n        'T\\u00E9l\\u00E9charger le code source',\r\n    'Switch back to user mode':\r\n        'Revenir en mode utilisateur',\r\n    'disable deep-Morphic\\ncontext menus\\nand show user-friendly ones':\r\n        'd\\u00E9sactiver la fonction morphic',\r\n    'Switch to dev mode':\r\n        'Passer en mode d\\u00E9veloppeur',\r\n    'enable Morphic\\ncontext menus\\nand inspectors,\\nnot user-friendly!':\r\n        'activer la fonction morphic',\r\n\r\n    // project menu\r\n    'Project notes...':\r\n        'Notes du projet...',\r\n    'New':\r\n        'Nouveau',\r\n    'Open...':\r\n        'Ouvrir...',\r\n    'Save':\r\n        'Sauvegarder',\r\n    'Save As...':\r\n        'Sauvegarder sous...',\r\n    'Import...':\r\n        'Importer...',\r\n    'file menu import hint':\r\n        'importer un projet export\\u00E9,\\nune biblioth\\u00E8que de '\r\n            + 'blocs\\n'\r\n            + 'un costume ou un son',\r\n    'Export project as plain text...':\r\n        'Exporter le projet comme texte...',\r\n    'Export project...':\r\n        'Exporter le projet...',\r\n    'save project data as XML\\nto your downloads folder':\r\n        'sauvegarder le projet au\\nformat XML dans votre\\ndossier T\\u00E9l\\u00E9chargements',\r\n    'show project data as XML\\nin a new browser window':\r\n        'ouvrir le projet au format XML\\ndans une nouvelle fen\\u00EAtre de votre navigateur',\r\n    'Export blocks...':\r\n        'Exporter les blocs ',\r\n    'show global custom block definitions as XML\\nin a new browser window':\r\n        'montrer les d\\u00E9finitions de bloc global personnalis\\u00E9 au format XML \\ndans une nouvelle fen\\u00EAtre de navigateur',\r\n    'Unused blocks...':\r\n        'Blocs inutilis\\u00E9s...',\r\n    'find unused global custom blocks\\nand remove their definitions':\r\n        'trouver et supprimer les blocs personnalis\\u00E9s inutilis\\u00E9s',\r\n    'Remove unused blocks':\r\n        'Supprimer les blocs inutilis\\u00E9s',\r\n    'there are currently no unused\\nglobal custom blocks in this project':\r\n        'Aucun bloc inutilis\\u00E9 dans ce projet',\r\n    'unused block(s) removed':\r\n        'bloc(s) inutilis\\u00E9(s) supprim\\u00E9(s)',\r\n    'Export summary...':\r\n        'Exporter un r\\u00E9sum\\u00E9...',\r\n    'open a new browser browser window\\n with a summary of this project':\r\n        'voir un rsum de ce projet dans\\nune nouvelle fentre du navigateur',\r\n    'Import tools':\r\n        'Importer les outils',\r\n    'load the official library of\\npowerful blocks':\r\n        'Importer la biblioth\\u00E8que officielle\\nd\\'outils avanc\\u00E9s',\r\n    'Libraries...':\r\n        'Biblioth\\u00E8ques...',\r\n    'Import library':\r\n        'Importer une biblioth\\u00E8que',\r\n\r\n    // settings menu\r\n    'Language...':\r\n        'Langue...',\r\n    'Blurred shadows':\r\n        'Ombres floues',\r\n    'uncheck to use solid drop\\nshadows and highlights':\r\n        'D\\u00E9cocher pour utiliser des rehauts et des ombres \\n port\\u00E9es floues',\r\n    'check to use blurred drop\\nshadows and highlights':\r\n        'cocher pour utiliser des rehauts et des ombres \\n port\\u00E9es pleines',\r\n    'Zebra coloring':\r\n        'Colorations altern\\u00E9es',\r\n    'check to enable alternating\\ncolors for nested blocks':\r\n        'cocher pour activer des couleurs altern\\u00E9es \\n pour les blocs embo\\u00EEt\\u00E9s',\r\n    'uncheck to disable alternating\\ncolors for nested block':\r\n        'd\\u00E9cocher pour d\\u00E9sactiver des couleurs altern\\u00E9es \\n pour les blocs embo\\u00EEt\\u00E9s',\r\n    'Prefer empty slot drops':\r\n        'Pr\\u00E9f\\u00E9rer des entr\\u00E9es vides',\r\n    'settings menu prefer empty slots hint':\r\n        'cocher pour pr\\u00E9f\\u00E9rer des entr\\u00E9es vides \\n'\r\n        + 'lors du glisser-d\\u00E9poser d\\u0027un reporter',\r\n    'uncheck to allow dropped\\nreporters to kick out others':\r\n        'd\\u00E9cocher pour ne pas pr\\u00E9f\\u00E9rer des entr\\u00E9es vides \\n'\r\n    + 'lors du glisser-d\\u00E9poser d\\u0027un reporter',\r\n    'Long form input dialog':\r\n        'Bo\\u00EEte d\\u0027entr\\u00E9e en mode d\\u00E9taill\\u00E9',\r\n    'check to always show slot\\ntypes in the input dialog':\r\n        'cocher pour toujours ouvrir la bo\\u00EEte de dialogue \\nd\\u0027entr\\u00E9e en mode d\\u00E9taill\\u00E9 : avec tous les types de blocs',\r\n    'uncheck to use the input\\ndialog in short form':\r\n        'd\\u00E9cocher pour utiliser la bo\\u00EEte de dialogue \\nd\\u0027entr\\u00E9e en mode simple ',\r\n    'Virtual keyboard':\r\n        'Clavier virtuel',\r\n    'uncheck to disable\\nvirtual keyboard support\\nfor mobile devices':\r\n        'd\\u00E9cocher pour d\\u00E9sactiver le clavier virtuel pour \\nles tablettes et smartphones : mobile devices  ',\r\n    'check to enable\\nvirtual keyboard support\\nfor mobile devices':\r\n        'cocher pour activer le clavier virtuel pour \\nles tablettes et smartphones : mobile devices  ',\r\n    'Input sliders':\r\n        'Entr\\u00E9e curseurs',\r\n    'uncheck to disable\\ninput sliders for\\nentry fields':\r\n        'd\\u00E9cocher pour d\\u00E9sactiver le curseur coulissant \\ndans le champ de saisie',\r\n    'check to enable\\ninput sliders for\\nentry fields':\r\n        'cocher pour activer un curseur coulissant \\ndans le champ de saisie ',\r\n    'Clicking sound':\r\n        'Cliquetis',\r\n    'uncheck to turn\\nblock clicking\\nsound off':\r\n        'd\\u00E9cocher pour d\\u00E9sactiver le cliquetis \\n'\r\n    +'lors de l\\u0027embo\\u00EEtement des blocs' ,\r\n    'check to turn\\nblock clicking\\nsound on':\r\n        'cocher pour activer le cliquetis \\n'\r\n    +'lors de l\\u0027embo\\u00EEtement des blocs',\r\n    'Turbo mode':\r\n        'Mode turbo',\r\n    'check to prioritize\\nscript execution':\r\n        'cocher pour favoriser l\\'ex\\u00E9cution du script',\r\n    'uncheck to run scripts\\nat normal speed':\r\n        'd\\u00E9cocher pour ex\\u00E9cuter le script en vitesse normale',\r\n    'Flat design':\r\n        'Style al\\u00E9g\\u00E9',\r\n    'check for alternative\\nGUI design':\r\n        'cocher pour un style d\\'interface alternatif',\r\n    'uncheck for default\\nGUI design':\r\n     'd\\u00E9cocher pour le style classique d\\'interface',\r\n    'Keyboard Editing':\r\n        '\\u00C9dition au clavier',\r\n    'uncheck to disable\\nkeyboard editing support':\r\n        'd\\u00E9cocher pour d\\u00E9sactiver l\\'\\u00E9dition au clavier',\r\n    'check to enable\\nkeyboard editing support':\r\n        'cocher pour activer l\\'\\u00E9dition au clavier',\r\n    'Thread safe scripts':\r\n        'Scripts rentrants',\r\n    'check to disallow\\nscript reentrance':\r\n        'cocher pour interdire\\n la r\\u00E9entrance des scripts\\n'\r\n      + 'et les ex\\u00E9cuter s\\u00E9par\\u00E9ment',\r\n    'uncheck to allow\\nscript reentrance':\r\n        'd\\u00E9cocher pour permettre\\n la r\\u00E9entrance des scripts\\n'\r\n      + 'o\\u00F9 certains s\\'ex\\u00E9cutent en paral\\u00E8lle',\r\n    'Prefer smooth animations':\r\n        'Vitesse d\\'animation fixe',\r\n    'uncheck for greater speed\\nat variable frame rates':\r\n        'd\\u00E9cocher pour une vitesse\\nd\\'animation maximale (mais variable)',\r\n    'check for smooth, predictable\\nanimations across computers':\r\n        'cocher pour une vitesse d\\'animation\\nfixe et identique sur tous les ordinateurs',\r\n\r\n    // inputs\r\n    'with inputs':\r\n        'avec entr\\u00E9es',\r\n    'input names:':\r\n        'renseigner un nom :',\r\n    'Input Names:':\r\n        'Renseigner un nom :',\r\n\r\n    // context menus:\r\n    'help':\r\n        'Aide',\r\n\r\n    // palette:\r\n    'hide primitives':\r\n        'Masquer les blocs de base',\r\n    'show primitives':\r\n        'Afficher les blocs de base',\r\n\r\n    // blocks:\r\n    'help...':\r\n        'Aide...',\r\n    'duplicate':\r\n        'dupliquer',\r\n    'make a copy\\nand pick it up':\r\n        'faire une copie\\n et le d\\u00E9placer',\r\n    'only duplicate this block':\r\n        'ne dupliquer que ce bloc',\r\n    'delete':\r\n        'supprimer',\r\n    'script pic...':\r\n        'image du script...',\r\n    'open a new window\\nwith a picture of this script':\r\n        'ouvrir une nouvelle fen\\u00EAtre avec une \\nimage .png de ce script',\r\n    'ringify':\r\n        'entourer',\r\n    'unringify':\r\n        'd\\u00E9tourer',\r\n\r\n    // custom blocks:\r\n    'delete block definition...':\r\n        'supprimer les d\\u00E9finitions de bloc',\r\n    'edit...':\r\n        '\\u00E9diter...',\r\n\r\n    // sprites:\r\n    'edit':\r\n        '\\u00E9diter',\r\n    'move':\r\n        'd\\u00E9placer',\r\n    'detach from':\r\n        'D\\u00E9tacher de',\r\n    'detach all parts':\r\n        'D\\u00E9tacher toutes les parties',\r\n    'export...':\r\n        'Exporter...',\r\n    'paint a new sprite':\r\n        'dessiner un nouveau lutin',\r\n\r\n    // scripting area\r\n    'clean up':\r\n        'effacer',\r\n    'arrange scripts\\nvertically':\r\n        'arrange scripts\\nvertically',\r\n    'add comment':\r\n        'ajouter un commentaire',\r\n    'make a block...':\r\n        'cr\\u00E9er un nouveau bloc...',\r\n\r\n    // costumes\r\n    'rename':\r\n        'renommer',\r\n    'export':\r\n        'exporter',\r\n    'rename costume':\r\n        'renommer un costume',\r\n    'Paint a new costume':\r\n        'Dessiner un nouveau costume',\r\n\r\n    // sounds\r\n    'Play sound':\r\n        'jouer un son',\r\n    'Stop sound':\r\n        'arr\\u00EAter un son',\r\n    'Stop':\r\n        'arr\\u00EAter',\r\n    'Play':\r\n        'jouer',\r\n    'rename sound':\r\n        'renommer un son',\r\n\r\n    // dialogs\r\n    // buttons\r\n    'OK':\r\n        'OK',\r\n    'Ok':\r\n        'Ok',\r\n    'Cancel':\r\n        'Annuler',\r\n    'Yes':\r\n        'Oui',\r\n    'No':\r\n        'Non',\r\n    'Open':\r\n        'Ouvrir',\r\n    'Browser':\r\n        'Navigateur',\r\n    'Examples':\r\n        'Exemples',\r\n\r\n    // help\r\n    'Help':\r\n        'Aide',\r\n\r\n    // Project Manager\r\n    'Untitled':\r\n        'Sans titre',\r\n    'Open Project':\r\n        'Ouvrir un projet',\r\n    '(empty)':\r\n        '(vide)',\r\n    'Saved!':\r\n        'Enregistr\\u00EA !',\r\n    'Delete Project':\r\n        'Supprimer un projet',\r\n    'Are you sure you want to delete':\r\n        'Souhaitez-vous vraiment supprimer ?',\r\n    'rename...':\r\n        'Renommer...',\r\n\r\n     // costume editor\r\n    'Costume Editor':\r\n        '\\u00EAditeur de costumes',\r\n    'click or drag crosshairs to move the rotation center':\r\n        'cliquez ou faites d\\u00EAfiler la ligne de mire  pour d\\u00EAfinir le centre de rotation du costume',\r\n\r\n    // project notes\r\n    'Project Notes':\r\n        'Notes du projet',\r\n\r\n    // new project\r\n    'New Project':\r\n        'Nouveau projet',\r\n    'Replace the current project with a new one?':\r\n        'Remplacer le projet actuel par un nouveau ?',\r\n\r\n    // open project\r\n    'Open Projekt':\r\n        'Ouvrir un projet',\r\n\r\n    // save project\r\n    'Save Project As...':\r\n        'Sauvegarder le projet sous...',\r\n\r\n    // export blocks\r\n    'Export blocks':\r\n        'exporter des blocs',\r\n    'this project doesn\\'t have any\\ncustom global blocks yet':\r\n        'ce projet ne contient pas \\nde bloc global personnalis\\u00E9',\r\n    'select':\r\n        's\\u00E9lectionner',\r\n    'all':\r\n        'tout',\r\n    'none':\r\n        'aucun',\r\n\r\n    // variable dialog\r\n    'for all sprites':\r\n        'pour tous les lutins',\r\n    'for this sprite only':\r\n        'pour ce lutin uniquement',\r\n\r\n    // block dialog\r\n    'Change block':\r\n        'Changer le bloc',\r\n    'Command':\r\n        'Commande',\r\n    'Reporter':\r\n        'Reporter',\r\n    'Predicate':\r\n        'Pr\\u00E9dicat',\r\n\r\n    // block editor\r\n    'Block Editor':\r\n        '\\u00C9diteur de bloc',\r\n    'Apply':\r\n        'Appliquer',\r\n\r\n    // block deletion dialog\r\n    'Delete Custom Block':\r\n        'Effacer le bloc personnalis\\u00E9',\r\n    'block deletion dialog text':\r\n        '\\u00CAtes-vous s\\u00FBr de vouloir supprimer ce bloc personnalis\\u00E9 \\net ' +\r\n            'toutes ses instances ?',\r\n\r\n    // input dialog\r\n    'Create input name':\r\n        'Cr\\u00E9er le nom de l\\u0027entr\\u00E9e',\r\n    'Edit input name':\r\n        '\\u00C9diter le nom de l\\u0027entr\\u00E9e',\r\n    'Edit label fragment':\r\n        '\\u00C9diter le fragment du label',\r\n    'Title text':\r\n        'Texte du titre',\r\n    'Input name':\r\n        'Nom de l\\u0027entr\\u00E9e',\r\n    'Delete':\r\n        'Supprimer',\r\n    'Object':\r\n        'Objet',\r\n    'Number':\r\n        'Nombre',\r\n    'Text':\r\n        'Texte',\r\n    'List':\r\n        'Liste',\r\n    'Any type':\r\n        'Tout type',\r\n    'Boolean (T/F)':\r\n        'Bool\\u00E9en (V/F)',\r\n    'Command\\n(inline)':\r\n        'Commande\\n(en ligne)',\r\n    'Command\\n(C-shape)':\r\n        'Commande\\n(en forme de C)',\r\n    'Any\\n(unevaluated)':\r\n        'Tout type\\n(non \\u00E9valu\\u00E9e)',\r\n    'Boolean\\n(unevaluated)':\r\n        'Bool\\u00E9en\\n(non \\u00E9valu\\u00E9e)',\r\n    'Single input.':\r\n        'Entr\\u00E9e unique.',\r\n    'Default Value:':\r\n        'Valeur par d\\u00E9faut :',\r\n    'Multiple inputs (value is list of inputs)':\r\n        'Entr\\u00E9es multiples (la valeur est une liste des entr\\u00E9es)',\r\n    'Upvar - make internal variable visible to caller':\r\n        'Upvar - Rendre la variable interne visible pour l\\u0027appelant',\r\n    // delimiters\r\n    'whitespace':\r\n        'espaces blancs',\r\n    'line':\r\n        'lignes',\r\n    'tab':\r\n        'tabulations',\r\n    'cr':\r\n        'retours de ligne',\r\n  'letter':\r\n    'lettres',\r\n\r\n    // About Snap\r\n    'About Snap':\r\n        '\\u00C0 propos de Snap',\r\n    'Back...':\r\n        'Retour...',\r\n    'License...':\r\n        'Licence...',\r\n    'Modules...':\r\n        'Modules...',\r\n    'Credits...':\r\n        'Contributeurs...',\r\n    'Translators...':\r\n        'Traducteurs...',\r\n    'License':\r\n        'License',\r\n    'current module versions:':\r\n        'Versions du module courant :',\r\n    'Contributors':\r\n        'Contributeurs',\r\n    'Translations':\r\n        'Traductions',\r\n\r\n    // variable watchers\r\n    'normal':\r\n        'normal',\r\n    'large':\r\n        'grand',\r\n    'slider':\r\n        'curseur',\r\n    'slider min...':\r\n        'min...',\r\n    'slider max...':\r\n        'max...',\r\n    'Slider minimum value':\r\n        'Valeur minimale du curseur',\r\n    'Slider maximum value':\r\n        'Valeur maximale du curseur',\r\n\r\n    // list watchers\r\n    'length: ':\r\n        'Longueur : ',\r\n\r\n    // coments\r\n    'add comment here...':\r\n        'ajoute un commentaire ici',\r\n\r\n    // drow downs\r\n    // directions\r\n    '(90) right':\r\n        '(90) \\u00E0 droite',\r\n    '(-90) left':\r\n        '(-90) \\u00E0 gauche',\r\n    '(0) up':\r\n        '(0) vers le haut',\r\n    '(180) down':\r\n        '(180) vers le bas',\r\n\r\n    // collision detection\r\n    'mouse-pointer':\r\n        'pointeur souris',\r\n    'edge':\r\n        'bord',\r\n    'pen trails':\r\n        'traces de stylo',\r\n\r\n    // costumes\r\n    'Turtle':\r\n        'Pointeur',\r\n    'Empty':\r\n        'Vide',\r\n\r\n    // graphical effects\r\n    'color':\r\n        'couleur',\r\n    'fisheye':\r\n        'fisheye',\r\n    'whirl':\r\n        'tourbillon',\r\n    'pixelate':\r\n        'pixelisation',\r\n    'mosaic':\r\n        'mosa\\u00EFque',\r\n    'saturation':\r\n        'saturation',\r\n    'brightness':\r\n        'luminosit\\u00E9',\r\n    'ghost':\r\n        'transparence',\r\n    'negative':\r\n        'n\\u00E9gatif',\r\n    'comic':\r\n        'moir\\u00E9',\r\n    'confetti':\r\n        'confetti',\r\n\r\n    // keys\r\n    'space':\r\n        'espace',\r\n    'up arrow':\r\n        'fl\\u00E8che vers le haut',\r\n    'down arrow':\r\n        'fl\\u00E8che vers le bas',\r\n    'right arrow':\r\n        'fl\\u00E8che vers la droite',\r\n    'left arrow':\r\n        'fl\\u00E8che vers la gauche',\r\n    'a':\r\n        'a',\r\n    'b':\r\n        'b',\r\n    'c':\r\n        'c',\r\n    'd':\r\n        'd',\r\n    'e':\r\n        'e',\r\n    'f':\r\n        'f',\r\n    'g':\r\n        'g',\r\n    'h':\r\n        'h',\r\n    'i':\r\n        'i',\r\n    'j':\r\n        'j',\r\n    'k':\r\n        'k',\r\n    'l':\r\n        'l',\r\n    'm':\r\n        'm',\r\n    'n':\r\n        'n',\r\n    'o':\r\n        'o',\r\n    'p':\r\n        'p',\r\n    'q':\r\n        'q',\r\n    'r':\r\n        'r',\r\n    's':\r\n        's',\r\n    't':\r\n        't',\r\n    'u':\r\n        'u',\r\n    'v':\r\n        'v',\r\n    'w':\r\n        'w',\r\n    'x':\r\n        'x',\r\n    'y':\r\n        'y',\r\n    'z':\r\n        'z',\r\n    '0':\r\n        '0',\r\n    '1':\r\n        '1',\r\n    '2':\r\n        '2',\r\n    '3':\r\n        '3',\r\n    '4':\r\n        '4',\r\n    '5':\r\n        '5',\r\n    '6':\r\n        '6',\r\n    '7':\r\n        '7',\r\n    '8':\r\n        '8',\r\n    '9':\r\n        '9',\r\n\r\n     // messages\r\n    'new...':\r\n        'nouveau...',\r\n\r\n    // math functions\r\n    'abs':\r\n        'v. absolue',\r\n    'sqrt':\r\n        'racine',\r\n    'sin':\r\n        'sin',\r\n    'cos':\r\n        'cos',\r\n    'tan':\r\n        'tan',\r\n    'asin':\r\n        'asin',\r\n    'acos':\r\n        'acos',\r\n    'atan':\r\n        'atan',\r\n    'ln':\r\n        'ln',\r\n    'e^':\r\n        'e^',\r\n\r\n    // data types\r\n    'number':\r\n        'nombre',\r\n    'text':\r\n        'texte',\r\n    'Boolean':\r\n        'bool\\u00E9en',\r\n    'list':\r\n        'liste',\r\n    'command':\r\n        'bloc de commande',\r\n    'reporter':\r\n        'bloc reporter',\r\n    'predicate':\r\n        'pr\\u00E9dicat',\r\n\r\n    // list indices\r\n    'last':\r\n        'dernier',\r\n    'any':\r\n        'n\\u0027importe quel',\r\n\r\n    // miscellaneous\r\n    'find blocks...':\r\n        'chercher des blocs...',\r\n    'hide primitives':\r\n        'cacher les primitives',\r\n    'show primitives':\r\n        'montrer les primitives',\r\n    'Login...':\r\n        'Connexion...',\r\n    'Signup...':\r\n        'S\\u0027enregistrer...',\r\n    'Reset Password...':\r\n        'Remise \\u00E0 z\\u00E9ro du mot de passe...',\r\n    'show all':\r\n        'tout montrer',\r\n    'pic...':\r\n        'image...',\r\n    'open a new window\\nwith a picture of the stage':\r\n        'ouvre une nouvelle fen\\u00EAtre\\navec une image de la sc\\u00E8ne',\r\n    'scripts pic...':\r\n        'image des scripts...',\r\n    'open a new window\\nwith a picture of all scripts':\r\n        'ouvre une nouvelle fen\\u00EAtre\\navec une image de tous les scripts',\r\n    'Stage size...':\r\n        'Taille de la sc\\u00E8ne...',\r\n    'Zoom blocks...':\r\n        'Agrandir les blocs...',\r\n\r\n    'Plain prototype labels':\r\n        '\\u00C9tiquettes simples de d\\u00E9finition',\r\n    'uncheck to always show (+) symbols\\nin block prototype labels':\r\n        'd\\u00E9cocher pour montrer en permanance le symbole (+)\\ndans les \\u00e9tiquettes de d\\u00E9finition de bloc',\r\n    'check to hide (+) symbols\\nin block prototype labels':\r\n        'cocher pour cacher le symbole (+)\\ndans les \\u00e9tiquettes de d\\u00E9finition de bloc',\r\n\r\n    'check for flat ends of lines':\r\n        'cocher pour dessiner des fins de ligne plates',\r\n    'uncheck for round ends of lines':\r\n        'd\\u00E9cocher pour dessiner des fins de lignes arrondies',\r\n    'Flat line ends':\r\n        'Fins de ligne plates',\r\n\r\n    'Codification support':\r\n        'Support de la \\u00AB codification \\u00BB',\r\n    'uncheck to disable\\nblock to text mapping features':\r\n        'd\\u00E9cocher pour d\\u00E9activer\\nla fonction de transformation :\\nbloc vers texte',\r\n    'check for block\\nto text mapping features':\r\n        'cocher pour activer\\nla fonction de transformation :\\nbloc vers texte',\r\n\r\n    'Inheritance support':\r\n        'Support de l\\'h\\u00E9ritage',\r\n\r\n    'current %dates':\r\n        'date courante %dates',\r\n    'year':\r\n        'ann\\u00E9e',\r\n    'month':\r\n        'mois',\r\n    'date':\r\n        'jour',\r\n    'hour':\r\n        'heure',\r\n    'minute':\r\n        'minute',\r\n    'second':\r\n        'seconde',\r\n    'time in milliseconds':\r\n        'heure en millisecondes',\r\n    'day of week':\r\n        'jour de la semaine',\r\n\r\n    'brightness':\r\n        'luminosit\\u00E9',\r\n    'transparence':\r\n        'transparence',\r\n    'negative':\r\n        'n\\u00E9gatif',\r\n    'comic':\r\n        'bande dessin\\u00E9e',\r\n\r\n    'clicked':\r\n        'cliqu\\u00E9',\r\n    'pressed':\r\n        'press\\u00E9',\r\n    'dropped':\r\n        'd\\u00E9pos\\u00E9',\r\n    'mouse-entered':\r\n        'survol\\u00E9',\r\n    'mouse-departed':\r\n        'quitt\\u00E9',\r\n    'when %b':\r\n        'Quand %b',\r\n\r\n    'JavaScript function ( %mult%s ) { %code }':\r\n        'fonction JavaScript ( %mult%s ) { %code }',\r\n\r\n\r\n    // Copy / Paste\r\n    'Press CTRL+C one more time to effectively copy to clipboard.':\r\n        'Taper une nouvelle fois sur CTRL+C pour copier effectivement vers le presse-papier.',\r\n    'Press CTRL+V one more time to effectively paste from clipboard.':\r\n        'Taper une nouvelle fois sur CTRL+V pour coller effectivement depuis le presse-papier.',\r\n    'Press CTRL+X one more time to effectively cut to clipboard.':\r\n        'Taper une nouvelle fois sur CTRL+X pour couper effectivement vers le presse-papier.',\r\n\r\n    // Paint.js\r\n    'undo':\r\n        'd\\u00E9faire',\r\n    'Paintbrush tool\\n(free draw)':\r\n        'Pinceau\\n(dessin \\u00E0 main lev\\u00E9e)',\r\n    'Stroked Rectangle\\n(shift: square)':\r\n        'Rectangle\\n(Maj : carr\\u00E9)',\r\n    'Stroked Ellipse\\n(shift: circle)':\r\n        'Ellipse\\n(Maj : cercle)',\r\n    'Eraser tool':\r\n        'Gomme',\r\n    'Set the rotation center':\r\n        'Fixer le centre de rotation',\r\n    'Line tool\\n(shift: vertical/horizontal)':\r\n        'Ligne\\n(Maj: verticale/horizontale)',\r\n    'Filled Rectangle\\n(shift: square)':\r\n        'Rectangle plein\\n(Maj: carr\\u00E9)',\r\n    'Filled Ellipse\\n(shift: circle)':\r\n        'Ellipse pleine\\n(Maj: cercle)',\r\n    'Fill a region':\r\n        'Remplir une r\\u00E9gion',\r\n    'Pipette tool\\n(pick a color anywhere)':\r\n        'Pipette\\n(s\\u00E9lectionnez une couleur n\\u0027importe o\\u00F9)',\r\n    'grow':\r\n        'agrandir',\r\n    'shrink':\r\n        'r\\u00E9duire',\r\n    'flip \\u2194':\r\n        'miroir \\u2194',\r\n    'flip \\u2195':\r\n        'miroir \\u2195',\r\n    'Brush size':\r\n        'Taille de pinceau',\r\n    'Constrain proportions of shapes?\\n(you can also hold shift)':\r\n        'Contraindre les proportions de la forme ?\\n(vous pouvez aussi maintenir appuy\\u00E9 Maj)'\r\n\r\n};\r\n\r\n\r\nfunction localize(string) {\r\n    var strong;\r\n    if(dicofr[string]){strong = dicofr[string];}\r\n        else {strong = string;}\r\n    // override this function with custom localizations\r\n    return strong;\r\n}\r\n\r\nfunction isNil(thing) {\r\n    return thing === undefined || thing === null;\r\n}\r\n\r\nfunction contains(list, element) {\r\n    // answer true if element is a member of list\r\n    return list.indexOf(element) !== -1;\r\n}\r\n\r\nfunction detect(list, predicate) {\r\n    // answer the first element of list for which predicate evaluates\r\n    // true, otherwise answer null\r\n    var i, size = list.length;\r\n    for (i = 0; i < size; i += 1) {\r\n        if (predicate.call(null, list[i])) {\r\n            return list[i];\r\n        }\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction sizeOf(object) {\r\n    // answer the number of own properties\r\n    var size = 0, key;\r\n    for (key in object) {\r\n        if (Object.prototype.hasOwnProperty.call(object, key)) {\r\n            size += 1;\r\n        }\r\n    }\r\n    return size;\r\n}\r\n\r\nfunction isString(target) {\r\n    return typeof target === 'string' || target instanceof String;\r\n}\r\n\r\nfunction isObject(target) {\r\n    return target !== null &&\r\n        (typeof target === 'object' || target instanceof Object);\r\n}\r\n\r\nfunction radians(degrees) {\r\n    return degrees * Math.PI / 180;\r\n}\r\n\r\nfunction degrees(radians) {\r\n    return radians * 180 / Math.PI;\r\n}\r\n\r\nfunction fontHeight(height) {\r\n    var minHeight = Math.max(height, MorphicPreferences.minimumFontHeight);\r\n    return minHeight * 1.2; // assuming 1/5 font size for ascenders\r\n}\r\n\r\nfunction isWordChar(aCharacter) {\r\n    // can't use \\b or \\w because they ignore diacritics\r\n    return aCharacter.match(/[A-z-0-9]/);\r\n}\r\n\r\nfunction newCanvas(extentPoint, nonRetina) {\r\n    // answer a new empty instance of Canvas, don't display anywhere\r\n    // nonRetina - optional Boolean \"false\"\r\n    // by default retina support is automatic\r\n    var canvas, ext;\r\n    ext = extentPoint || {x: 0, y: 0};\r\n    canvas = document.createElement('canvas');\r\n    canvas.width = ext.x;\r\n    canvas.height = ext.y;\r\n    if (nonRetina && canvas.isRetinaEnabled) {\r\n        canvas.isRetinaEnabled = true;\r\n    }\r\n    return canvas;\r\n}\r\n\r\nfunction getMinimumFontHeight() {\r\n    // answer the height of the smallest font renderable in pixels\r\n    var str = 'I',\r\n        size = 50,\r\n        canvas = document.createElement('canvas'),\r\n        ctx,\r\n        maxX,\r\n        data,\r\n        x,\r\n        y;\r\n    canvas.width = size;\r\n    canvas.height = size;\r\n    ctx = canvas.getContext('2d');\r\n    ctx.font = '1px serif';\r\n    maxX = ctx.measureText(str).width;\r\n    ctx.fillStyle = 'black';\r\n    ctx.textBaseline = 'bottom';\r\n    ctx.fillText(str, 0, size);\r\n    for (y = 0; y < size; y += 1) {\r\n        for (x = 0; x < maxX; x += 1) {\r\n            data = ctx.getImageData(x, y, 1, 1);\r\n            if (data.data[3] !== 0) {\r\n                return size - y + 1;\r\n            }\r\n        }\r\n    }\r\n    return 0;\r\n}\r\n\r\nfunction getBlurredShadowSupport() {\r\n    // check for Chrome issue 90001\r\n    // http://code.google.com/p/chromium/issues/detail?id=90001\r\n    var source, target, ctx;\r\n    source = document.createElement('canvas');\r\n    source.width = 10;\r\n    source.height = 10;\r\n    ctx = source.getContext('2d');\r\n    ctx.fillStyle = 'rgb(255, 0, 0)';\r\n    ctx.beginPath();\r\n    ctx.arc(5, 5, 5, 0, Math.PI * 2, true);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    target = document.createElement('canvas');\r\n    target.width = 10;\r\n    target.height = 10;\r\n    ctx = target.getContext('2d');\r\n    ctx.shadowBlur = 10;\r\n    ctx.shadowColor = 'rgba(0, 0, 255, 1)';\r\n    ctx.drawImage(source, 0, 0);\r\n    return ctx.getImageData(0, 0, 1, 1).data[3] ? true : false;\r\n}\r\n\r\nfunction getDocumentPositionOf(aDOMelement) {\r\n    // answer the absolute coordinates of a DOM element in the document\r\n    var pos, offsetParent;\r\n    if (aDOMelement === null) {\r\n        return {x: 0, y: 0};\r\n    }\r\n    pos = {x: aDOMelement.offsetLeft, y: aDOMelement.offsetTop};\r\n    offsetParent = aDOMelement.offsetParent;\r\n    while (offsetParent !== null) {\r\n        pos.x += offsetParent.offsetLeft;\r\n        pos.y += offsetParent.offsetTop;\r\n        if (offsetParent !== document.body &&\r\n                offsetParent !== document.documentElement) {\r\n            pos.x -= offsetParent.scrollLeft;\r\n            pos.y -= offsetParent.scrollTop;\r\n        }\r\n        offsetParent = offsetParent.offsetParent;\r\n    }\r\n    return pos;\r\n}\r\n\r\nfunction copy(target) {\r\n    // answer a shallow copy of target\r\n    var value, c, property, keys, l, i;\r\n\r\n    if (typeof target !== 'object') {\r\n        return target;\r\n    }\r\n    value = target.valueOf();\r\n    if (target !== value) {\r\n        return new target.constructor(value);\r\n    }\r\n    if (target instanceof target.constructor &&\r\n            target.constructor !== Object) {\r\n        c = Object.create(target.constructor.prototype);\r\n        keys = Object.keys(target);\r\n        for (l = keys.length, i = 0; i < l; i += 1) {\r\n            property = keys[i];\r\n            c[property] = target[property];\r\n        }\r\n    } else {\r\n        c = {};\r\n        for (property in target) {\r\n            c[property] = target[property];\r\n        }\r\n    }\r\n    return c;\r\n}\r\n\r\n// Retina Display Support //////////////////////////////////////////////\r\n\r\n/*\r\n    By default retina support gets installed when Morphic.js loads. There\r\n    are two global functions that let you test for retina availability:\r\n\r\n        isRetinaSupported() - Boolean, whether retina support is available\r\n        isRetinaEnabled()   - Boolean, whether currently in retina mode\r\n\r\n    and two more functions that let you control retina support if it is\r\n    available:\r\n\r\n        enableRetinaSupport()\r\n        disableRetinaSupport()\r\n\r\n    Both of these internally test whether retina is available, so they are\r\n    safe to call directly.\r\n\r\n    Even when in retina mode it often makes sense to use non-high-resolution\r\n    canvasses for simple shapes in order to save system resources and\r\n    optimize performance. Examples are costumes and backgrounds in Snap.\r\n    In Morphic you can create new canvas elements using\r\n    \r\n        newCanvas(extentPoint [, nonRetinaFlag])\r\n\r\n    If retina support is enabled such new canvasses will automatically be\r\n    high-resolution canvasses, unless the newCanvas() function is given an\r\n    otherwise optional second Boolean <true> argument that explicitly makes\r\n    it a non-retina canvas.\r\n\r\n    Not the whole canvas API is supported by Morphic's retina utilities.\r\n    Especially if your code uses putImageData() you will want to \"downgrade\"\r\n    a target high-resolution canvas to a normal-resolution (\"non-retina\")\r\n    one before using\r\n\r\n        normalizeCanvas(aCanvas [, copyFlag])\r\n\r\n    This will change the target canvas' resolution in place (!). If you\r\n    pass in the optional second Boolean <true> flag the function returns\r\n    a non-retina copy and leaves the target canvas unchanged. An example\r\n    of this normalize mechanism is converting the penTrails layer of Snap's\r\n    stage (high-resolution) into a sprite-costume (normal resolution).\r\n*/\r\n\r\nfunction enableRetinaSupport() {\r\n/*\r\n    === contributed by Bartosz Leper ===\r\n\r\n    This installs a series of utilities that allow using Canvas the same way\r\n    on retina and non-retina displays. If the display is a retina one, the\r\n    underlying dimensions of the Canvas elements are doubled, but this will\r\n    be transparent to the code that uses Canvas. All dimensions read or\r\n    written to the Canvas element will be scaled appropriately.\r\n\r\n    NOTE: This implementation is not exhaustive; it only implements what is\r\n    needed by the Snap! UI.\r\n    \r\n    [Jens]: like all other retina screen support implementations I've seen\r\n    Bartosz's patch also does not address putImageData() compatibility when\r\n    mixing retina-enabled and non-retina canvasses. If you need to manipulate\r\n    pixels in such mixed canvasses, make sure to \"downgrade\" them all using\r\n    normalizeCanvas() below.\r\n*/\r\n\r\n    // Get the window's pixel ratio for canvas elements.\r\n    // See: http://www.html5rocks.com/en/tutorials/canvas/hidpi/\r\n    var ctx = document.createElement(\"canvas\").getContext(\"2d\"),\r\n        backingStorePixelRatio = ctx.webkitBackingStorePixelRatio ||\r\n            ctx.mozBackingStorePixelRatio ||\r\n            ctx.msBackingStorePixelRatio ||\r\n            ctx.oBackingStorePixelRatio ||\r\n            ctx.backingStorePixelRatio || 1,\r\n\r\n    // Unfortunately, it's really hard to make this work well when changing\r\n    // zoom level, so let's leave it like this right now, and stick to\r\n    // whatever the ratio was in the beginning.\r\n\r\n        // originalDevicePixelRatio = window.devicePixelRatio,\r\n\r\n    // [Jens]: As of summer 2016 non-integer devicePixelRatios lead to\r\n    // artifacts when blitting images onto canvas elements in all browsers\r\n    // except Chrome, especially Firefox, Edge, IE (Safari doesn't even\r\n    // support retina mode as implemented here).\r\n    // therefore - to ensure crisp fonts - use the ceiling of whatever\r\n    // the devicePixelRatio is. This needs more memory, but looks nicer.\r\n\r\n        originalDevicePixelRatio = Math.ceil(window.devicePixelRatio),\r\n\r\n        canvasProto = HTMLCanvasElement.prototype,\r\n        contextProto = CanvasRenderingContext2D.prototype,\r\n\r\n    // [Jens]: keep track of original properties in a dictionary\r\n    // so they can be iterated over and restored\r\n        uber = {\r\n            drawImage: contextProto.drawImage,\r\n            getImageData: contextProto.getImageData,\r\n\r\n            width: Object.getOwnPropertyDescriptor(\r\n                canvasProto,\r\n                'width'\r\n            ),\r\n            height: Object.getOwnPropertyDescriptor(\r\n                canvasProto,\r\n                'height'\r\n            ),\r\n            shadowOffsetX: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowOffsetX'\r\n            ),\r\n            shadowOffsetY: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowOffsetY'\r\n            ),\r\n            shadowBlur: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowBlur'\r\n            )\r\n        };\r\n\r\n    // [Jens]: only install retina utilities if the display supports them\r\n    if (backingStorePixelRatio === originalDevicePixelRatio) {return; }\r\n    // [Jens]: check whether properties can be overridden, needed for Safari\r\n    if (Object.keys(uber).some(function (any) {\r\n        var prop = uber[any];\r\n        return prop.hasOwnProperty('configurable') && (!prop.configurable);\r\n    })) {return; }\r\n\r\n    function getPixelRatio(imageSource) {\r\n        return imageSource.isRetinaEnabled ?\r\n            (originalDevicePixelRatio || 1) / backingStorePixelRatio : 1;\r\n    }\r\n\r\n    canvasProto._isRetinaEnabled = true;\r\n    // [Jens]: remember the original non-retina properties,\r\n    // so they can be restored again\r\n    canvasProto._bak = uber;\r\n\r\n    Object.defineProperty(canvasProto, 'isRetinaEnabled', {\r\n        get: function() {\r\n            return this._isRetinaEnabled;\r\n        },\r\n        set: function(enabled) {\r\n            var prevPixelRatio = getPixelRatio(this),\r\n                prevWidth = this.width,\r\n                prevHeight = this.height;\r\n\r\n            this._isRetinaEnabled = enabled;\r\n            if (getPixelRatio(this) != prevPixelRatio) {\r\n                this.width = prevWidth;\r\n                this.height = prevHeight;\r\n            }\r\n        },\r\n        configurable: true // [Jens]: allow to be deleted an reconfigured\r\n    });\r\n\r\n    Object.defineProperty(canvasProto, 'width', {\r\n        get: function() {\r\n            return uber.width.get.call(this) / getPixelRatio(this);\r\n        },\r\n        set: function(width) {\r\n            try { // workaround one of FF's dreaded NS_ERROR_FAILURE bugs\r\n                // this should be taken out as soon as FF gets fixed again\r\n                var pixelRatio = getPixelRatio(this),\r\n                    context;\r\n                uber.width.set.call(this, width * pixelRatio);\r\n                context = this.getContext('2d');\r\n                context.restore();\r\n                context.save();\r\n                context.scale(pixelRatio, pixelRatio);\r\n            } catch (err) {\r\n                console.log('Retina Display Support Problem', err);\r\n                uber.width.set.call(this, width);\r\n            }\r\n        }\r\n    });\r\n\r\n    Object.defineProperty(canvasProto, 'height', {\r\n        get: function() {\r\n            return uber.height.get.call(this) / getPixelRatio(this);\r\n        },\r\n        set: function(height) {\r\n            var pixelRatio = getPixelRatio(this),\r\n                context;\r\n            uber.height.set.call(this, height * pixelRatio);\r\n            context = this.getContext('2d');\r\n            context.restore();\r\n            context.save();\r\n            context.scale(pixelRatio, pixelRatio);\r\n        }\r\n    });\r\n\r\n    contextProto.drawImage = function(image) {\r\n        var pixelRatio = getPixelRatio(image),\r\n            sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight;\r\n        \r\n        // Different signatures of drawImage() method have different\r\n        // parameter assignments.\r\n        switch (arguments.length) {\r\n            case 9:\r\n                sx = arguments[1];\r\n                sy = arguments[2];\r\n                sWidth = arguments[3];\r\n                sHeight = arguments[4];\r\n                dx = arguments[5];\r\n                dy = arguments[6];\r\n                dWidth = arguments[7];\r\n                dHeight = arguments[8];\r\n                break;\r\n\r\n            case 5:\r\n                sx = 0;\r\n                sy = 0;\r\n                sWidth = image.width;\r\n                sHeight = image.height;\r\n                dx = arguments[1];\r\n                dy = arguments[2];\r\n                dWidth = arguments[3];\r\n                dHeight = arguments[4];\r\n                break;\r\n\r\n            case 3:\r\n                sx = 0;\r\n                sy = 0;\r\n                sWidth = image.width;\r\n                sHeight = image.height;\r\n                dx = arguments[1];\r\n                dy = arguments[2];\r\n                dWidth = image.width;\r\n                dHeight = image.height;\r\n                break;\r\n\r\n            default:\r\n                throw Error('Called drawImage() with ' + arguments.length +\r\n                        ' arguments');\r\n        }\r\n        uber.drawImage.call(\r\n                this, image,\r\n                sx * pixelRatio, sy * pixelRatio,\r\n                sWidth * pixelRatio, sHeight * pixelRatio,\r\n                dx, dy,\r\n                dWidth, dHeight);\r\n    };\r\n\r\n    contextProto.getImageData = function(sx, sy, sw, sh) {\r\n        var pixelRatio = getPixelRatio(this.canvas);\r\n        return uber.getImageData.call(\r\n                this,\r\n                sx * pixelRatio, sy * pixelRatio,\r\n                sw * pixelRatio, sh * pixelRatio);\r\n    };\r\n\r\n    Object.defineProperty(contextProto, 'shadowOffsetX', {\r\n        get: function() {\r\n            return uber.shadowOffsetX.get.call(this) /\r\n                getPixelRatio(this.canvas);\r\n        },\r\n        set: function(offset) {\r\n            var pixelRatio = getPixelRatio(this.canvas);\r\n            uber.shadowOffsetX.set.call(this, offset * pixelRatio);\r\n        }\r\n    });\r\n\r\n    Object.defineProperty(contextProto, 'shadowOffsetY', {\r\n        get: function() {\r\n            return uber.shadowOffsetY.get.call(this) /\r\n                getPixelRatio(this.canvas);\r\n        },\r\n        set: function(offset) {\r\n            var pixelRatio = getPixelRatio(this.canvas);\r\n            uber.shadowOffsetY.set.call(this, offset * pixelRatio);\r\n        }\r\n    });\r\n\r\n    Object.defineProperty(contextProto, 'shadowBlur', {\r\n        get: function() {\r\n            return uber.shadowBlur.get.call(this) /\r\n                getPixelRatio(this.canvas);\r\n        },\r\n        set: function(blur) {\r\n            var pixelRatio = getPixelRatio(this.canvas);\r\n            uber.shadowBlur.set.call(this, blur * pixelRatio);\r\n        }\r\n    });\r\n}\r\n\r\nfunction isRetinaSupported () {\r\n    var ctx = document.createElement(\"canvas\").getContext(\"2d\"),\r\n        backingStorePixelRatio = ctx.webkitBackingStorePixelRatio ||\r\n            ctx.mozBackingStorePixelRatio ||\r\n            ctx.msBackingStorePixelRatio ||\r\n            ctx.oBackingStorePixelRatio ||\r\n            ctx.backingStorePixelRatio || 1,\r\n        canvasProto = HTMLCanvasElement.prototype,\r\n        contextProto = CanvasRenderingContext2D.prototype,\r\n        uber = {\r\n            drawImage: contextProto.drawImage,\r\n            getImageData: contextProto.getImageData,\r\n\r\n            width: Object.getOwnPropertyDescriptor(\r\n                canvasProto,\r\n                'width'\r\n            ),\r\n            height: Object.getOwnPropertyDescriptor(\r\n                canvasProto,\r\n                'height'\r\n            ),\r\n            shadowOffsetX: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowOffsetX'\r\n            ),\r\n            shadowOffsetY: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowOffsetY'\r\n            ),\r\n            shadowBlur: Object.getOwnPropertyDescriptor(\r\n                contextProto,\r\n                'shadowBlur'\r\n            )\r\n        };\r\n    return backingStorePixelRatio !== window.devicePixelRatio &&\r\n        !(Object.keys(uber).some(function (any) {\r\n            var prop = uber[any];\r\n            return prop.hasOwnProperty('configurable') && (!prop.configurable);\r\n        })\r\n    );\r\n}\r\n\r\nfunction isRetinaEnabled () {\r\n    return HTMLCanvasElement.prototype.hasOwnProperty('_isRetinaEnabled');\r\n}\r\n\r\nfunction disableRetinaSupport() {\r\n    // uninstalls Retina utilities. Make sure to re-create every Canvas\r\n    // element afterwards\r\n    var canvasProto, contextProto, uber;\r\n    if (!isRetinaEnabled()) {return; }\r\n    canvasProto = HTMLCanvasElement.prototype;\r\n    contextProto = CanvasRenderingContext2D.prototype;\r\n    uber = canvasProto._bak;\r\n    Object.defineProperty(canvasProto, 'width', uber.width);\r\n    Object.defineProperty(canvasProto, 'height', uber.height);\r\n    contextProto.drawImage = uber.drawImage;\r\n    contextProto.getImageData = uber.getImageData;\r\n    Object.defineProperty(contextProto, 'shadowOffsetX', uber.shadowOffsetX);\r\n    Object.defineProperty(contextProto, 'shadowOffsetY', uber.shadowOffsetY);\r\n    Object.defineProperty(contextProto, 'shadowBlur', uber.shadowBlur);\r\n    delete canvasProto._isRetinaEnabled;\r\n    delete canvasProto.isRetinaEnabled;\r\n    delete canvasProto._bak;\r\n}\r\n\r\nfunction normalizeCanvas(aCanvas, getCopy) {\r\n    // make sure aCanvas is non-retina, otherwise convert it in place (!)\r\n    // or answer a normalized copy if the \"getCopy\" flag is <true>\r\n    var cpy;\r\n    if (!aCanvas.isRetinaEnabled) {return aCanvas; }\r\n    cpy = newCanvas(new Point(aCanvas.width, aCanvas.height), true);\r\n    cpy.getContext('2d').drawImage(aCanvas, 0, 0);\r\n    if (getCopy) {return cpy; }\r\n    aCanvas.isRetinaEnabled = false;\r\n    aCanvas.width = cpy.width;\r\n    aCanvas.height = cpy.height;\r\n    aCanvas.getContext('2d').drawImage(cpy, 0, 0);\r\n    return aCanvas;\r\n}\r\n\r\n// Animations //////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    Animations handle gradual transitions between one state and another over a\r\n    period of time. Transition effects can be specified using easing functions.\r\n    An easing function maps a fraction of the transition time to a fraction of\r\n    the state delta. This way accelerating / decelerating and bouncing sliding\r\n    effects can be accomplished.\r\n\r\n    Animations are generic and not limited to motion, i.e. they can also handle\r\n    other transitions such as color changes, transparency fadings, growing,\r\n    shrinking, turning etc.\r\n\r\n    Animations need to be stepped by a scheduler, e. g. an interval function.\r\n    In Morphic the preferred way to run an animation is to register it with\r\n    the World by adding it to the World's animation queue. The World steps each\r\n    registered animation once per display cycle independently of the Morphic\r\n    stepping mechanism.\r\n\r\n    For an example how to use animations look at how the Morph's methods\r\n    \r\n        glideTo()\r\n        fadeTo()\r\n\r\n    and\r\n    \r\n        slideBackTo()\r\n\r\n    are implemented.\r\n*/\r\n\r\n// Animation instance creation:\r\n\r\nfunction Animation(setter, getter, delta, duration, easing, onComplete) {\r\n    this.setter = setter; // function\r\n    this.getter = getter; // function\r\n    this.delta = delta || 0; // number\r\n    this.duration = duration || 0; // milliseconds\r\n    this.easing = isString(easing) ? // string or function\r\n            this.easings[easing] || this.easings.sinusoidal\r\n                : easing || this.easings.sinusoidal;\r\n    this.onComplete = onComplete || null; // optional callback\r\n    this.endTime = null;\r\n    this.destination = null;\r\n    this.isActive = false;\r\n    this.start();\r\n}\r\n\r\nAnimation.prototype.easings = {\r\n    // dictionary of a few pre-defined easing functions used to transition\r\n    // two states\r\n\r\n    // ease both in and out:\r\n    linear: function (t) {return t; },\r\n    sinusoidal: function (t) {return 1 - Math.cos(radians(t * 90)); },\r\n    quadratic: function (t) {\r\n        return t < 0.5 ?\r\n                2 * t * t\r\n                    : ((4 - (2 * t)) * t) - 1;\r\n    },\r\n    cubic: function (t) {\r\n        return t < 0.5 ?\r\n                4 * t * t * t\r\n                    : ((t - 1) * ((2 * t) - 2) * ((2 * t) - 2)) + 1;\r\n    },\r\n    elastic: function (t) {\r\n        return (t -= 0.5) < 0 ?\r\n            (0.01 + 0.01 / t) * Math.sin(50 * t)\r\n                : (0.02 - 0.01 / t) * Math.sin(50 * t) + 1;\r\n    },\r\n\r\n    // ease in only:\r\n    sine_in: function (t) {return 1 - Math.sin(radians(90 + (t * 90))); },\r\n    quad_in: function (t) {return t * t; },\r\n    cubic_in: function (t) {return t * t * t; },\r\n    elastic_in: function (t) {\r\n        return (0.04 - 0.04 / t) * Math.sin(25 * t) + 1;\r\n    },\r\n\r\n    // ease out only:\r\n    sine_out: function (t) {return Math.sin(radians(t * 90)); },\r\n    quad_out: function (t) {return t * (2 - t); },\r\n    elastic_out: function (t) {return 0.04 * t / (--t) * Math.sin(25 * t); }\r\n};\r\n\r\nAnimation.prototype.start = function () {\r\n    // (re-) activate the animation, e.g. if is has previously completed,\r\n    // make sure to plug it into something that repeatedly triggers step(),\r\n    // e.g. the World's animations queue\r\n    this.endTime = Date.now() + this.duration;\r\n    this.destination = this.getter.call(this) + this.delta;\r\n    this.isActive = true;\r\n};\r\n\r\nAnimation.prototype.step = function () {\r\n    if (!this.isActive) {return; }\r\n    var now = Date.now();\r\n    if (now > this.endTime) {\r\n        this.setter(this.destination);\r\n        this.isActive = false;\r\n        if (this.onComplete) {this.onComplete(); }\r\n    } else {\r\n        this.setter(\r\n            this.destination -\r\n                (this.delta * this.easing((this.endTime - now) / this.duration))\r\n        );\r\n    }\r\n};\r\n\r\n// Colors //////////////////////////////////////////////////////////////\r\n\r\n// Color instance creation:\r\n\r\nfunction Color(r, g, b, a) {\r\n    // all values are optional, just (r, g, b) is fine\r\n    this.r = r || 0;\r\n    this.g = g || 0;\r\n    this.b = b || 0;\r\n    this.a = a || ((a === 0) ? 0 : 1);\r\n}\r\n\r\n// Color string representation: e.g. 'rgba(255,165,0,1)'\r\n\r\nColor.prototype.toString = function () {\r\n    return 'rgba(' +\r\n        Math.round(this.r) + ',' +\r\n        Math.round(this.g) + ',' +\r\n        Math.round(this.b) + ',' +\r\n        this.a + ')';\r\n};\r\n\r\n// Color copying:\r\n\r\nColor.prototype.copy = function () {\r\n    return new Color(\r\n        this.r,\r\n        this.g,\r\n        this.b,\r\n        this.a\r\n    );\r\n};\r\n\r\n// Color comparison:\r\n\r\nColor.prototype.eq = function (aColor) {\r\n    // ==\r\n    return aColor &&\r\n        this.r === aColor.r &&\r\n        this.g === aColor.g &&\r\n        this.b === aColor.b;\r\n};\r\n\r\n// Color conversion (hsv):\r\n\r\nColor.prototype.hsv = function () {\r\n    // ignore alpha\r\n    var max, min, h, s, v, d,\r\n        rr = this.r / 255,\r\n        gg = this.g / 255,\r\n        bb = this.b / 255;\r\n    max = Math.max(rr, gg, bb);\r\n    min = Math.min(rr, gg, bb);\r\n    h = max;\r\n    s = max;\r\n    v = max;\r\n    d = max - min;\r\n    s = max === 0 ? 0 : d / max;\r\n    if (max === min) {\r\n        h = 0;\r\n    } else {\r\n        switch (max) {\r\n        case rr:\r\n            h = (gg - bb) / d + (gg < bb ? 6 : 0);\r\n            break;\r\n        case gg:\r\n            h = (bb - rr) / d + 2;\r\n            break;\r\n        case bb:\r\n            h = (rr - gg) / d + 4;\r\n            break;\r\n        }\r\n        h /= 6;\r\n    }\r\n    return [h, s, v];\r\n};\r\n\r\nColor.prototype.set_hsv = function (h, s, v) {\r\n    // ignore alpha, h, s and v are to be within [0, 1]\r\n    var i, f, p, q, t;\r\n    i = Math.floor(h * 6);\r\n    f = h * 6 - i;\r\n    p = v * (1 - s);\r\n    q = v * (1 - f * s);\r\n    t = v * (1 - (1 - f) * s);\r\n    switch (i % 6) {\r\n    case 0:\r\n        this.r = v;\r\n        this.g = t;\r\n        this.b = p;\r\n        break;\r\n    case 1:\r\n        this.r = q;\r\n        this.g = v;\r\n        this.b = p;\r\n        break;\r\n    case 2:\r\n        this.r = p;\r\n        this.g = v;\r\n        this.b = t;\r\n        break;\r\n    case 3:\r\n        this.r = p;\r\n        this.g = q;\r\n        this.b = v;\r\n        break;\r\n    case 4:\r\n        this.r = t;\r\n        this.g = p;\r\n        this.b = v;\r\n        break;\r\n    case 5:\r\n        this.r = v;\r\n        this.g = p;\r\n        this.b = q;\r\n        break;\r\n    }\r\n\r\n    this.r *= 255;\r\n    this.g *= 255;\r\n    this.b *= 255;\r\n\r\n};\r\n\r\n// Color mixing:\r\n\r\nColor.prototype.mixed = function (proportion, otherColor) {\r\n    // answer a copy of this color mixed with another color, ignore alpha\r\n    var frac1 = Math.min(Math.max(proportion, 0), 1),\r\n        frac2 = 1 - frac1;\r\n    return new Color(\r\n        this.r * frac1 + otherColor.r * frac2,\r\n        this.g * frac1 + otherColor.g * frac2,\r\n        this.b * frac1 + otherColor.b * frac2\r\n    );\r\n};\r\n\r\nColor.prototype.darker = function (percent) {\r\n    // return an rgb-interpolated darker copy of me, ignore alpha\r\n    var fract = 0.8333;\r\n    if (percent) {\r\n        fract = (100 - percent) / 100;\r\n    }\r\n    return this.mixed(fract, new Color(0, 0, 0));\r\n};\r\n\r\nColor.prototype.lighter = function (percent) {\r\n    // return an rgb-interpolated lighter copy of me, ignore alpha\r\n    var fract = 0.8333;\r\n    if (percent) {\r\n        fract = (100 - percent) / 100;\r\n    }\r\n    return this.mixed(fract, new Color(255, 255, 255));\r\n};\r\n\r\nColor.prototype.dansDarker = function () {\r\n    // return an hsv-interpolated darker copy of me, ignore alpha\r\n    var hsv = this.hsv(),\r\n        result = new Color(),\r\n        vv = Math.max(hsv[2] - 0.16, 0);\r\n    result.set_hsv(hsv[0], hsv[1], vv);\r\n    return result;\r\n};\r\n\r\nColor.prototype.inverted = function () {\r\n    return new Color(\r\n        255 - this.r,\r\n        255 - this.g,\r\n        255 - this.b\r\n    );\r\n};\r\n\r\n// Points //////////////////////////////////////////////////////////////\r\n\r\n// Point instance creation:\r\n\r\nfunction Point(x, y) {\r\n    this.x = x || 0;\r\n    this.y = y || 0;\r\n}\r\n\r\n// Point string representation: e.g. '12@68'\r\n\r\nPoint.prototype.toString = function () {\r\n    return Math.round(this.x.toString()) +\r\n        '@' + Math.round(this.y.toString());\r\n};\r\n\r\n// Point copying:\r\n\r\nPoint.prototype.copy = function () {\r\n    return new Point(this.x, this.y);\r\n};\r\n\r\n// Point comparison:\r\n\r\nPoint.prototype.eq = function (aPoint) {\r\n    // ==\r\n    return this.x === aPoint.x && this.y === aPoint.y;\r\n};\r\n\r\nPoint.prototype.lt = function (aPoint) {\r\n    // <\r\n    return this.x < aPoint.x && this.y < aPoint.y;\r\n};\r\n\r\nPoint.prototype.gt = function (aPoint) {\r\n    // >\r\n    return this.x > aPoint.x && this.y > aPoint.y;\r\n};\r\n\r\nPoint.prototype.ge = function (aPoint) {\r\n    // >=\r\n    return this.x >= aPoint.x && this.y >= aPoint.y;\r\n};\r\n\r\nPoint.prototype.le = function (aPoint) {\r\n    // <=\r\n    return this.x <= aPoint.x && this.y <= aPoint.y;\r\n};\r\n\r\nPoint.prototype.max = function (aPoint) {\r\n    return new Point(Math.max(this.x, aPoint.x),\r\n        Math.max(this.y, aPoint.y));\r\n};\r\n\r\nPoint.prototype.min = function (aPoint) {\r\n    return new Point(Math.min(this.x, aPoint.x),\r\n        Math.min(this.y, aPoint.y));\r\n};\r\n\r\n// Point conversion:\r\n\r\nPoint.prototype.round = function () {\r\n    return new Point(Math.round(this.x), Math.round(this.y));\r\n};\r\n\r\nPoint.prototype.abs = function () {\r\n    return new Point(Math.abs(this.x), Math.abs(this.y));\r\n};\r\n\r\nPoint.prototype.neg = function () {\r\n    return new Point(-this.x, -this.y);\r\n};\r\n\r\nPoint.prototype.mirror = function () {\r\n    return new Point(this.y, this.x);\r\n};\r\n\r\nPoint.prototype.floor = function () {\r\n    return new Point(\r\n        Math.max(Math.floor(this.x), 0),\r\n        Math.max(Math.floor(this.y), 0)\r\n    );\r\n};\r\n\r\nPoint.prototype.ceil = function () {\r\n    return new Point(Math.ceil(this.x), Math.ceil(this.y));\r\n};\r\n\r\n// Point arithmetic:\r\n\r\nPoint.prototype.add = function (other) {\r\n    if (other instanceof Point) {\r\n        return new Point(this.x + other.x, this.y + other.y);\r\n    }\r\n    return new Point(this.x + other, this.y + other);\r\n};\r\n\r\nPoint.prototype.subtract = function (other) {\r\n    if (other instanceof Point) {\r\n        return new Point(this.x - other.x, this.y - other.y);\r\n    }\r\n    return new Point(this.x - other, this.y - other);\r\n};\r\n\r\nPoint.prototype.multiplyBy = function (other) {\r\n    if (other instanceof Point) {\r\n        return new Point(this.x * other.x, this.y * other.y);\r\n    }\r\n    return new Point(this.x * other, this.y * other);\r\n};\r\n\r\nPoint.prototype.divideBy = function (other) {\r\n    if (other instanceof Point) {\r\n        return new Point(this.x / other.x, this.y / other.y);\r\n    }\r\n    return new Point(this.x / other, this.y / other);\r\n};\r\n\r\nPoint.prototype.floorDivideBy = function (other) {\r\n    if (other instanceof Point) {\r\n        return new Point(Math.floor(this.x / other.x),\r\n            Math.floor(this.y / other.y));\r\n    }\r\n    return new Point(Math.floor(this.x / other),\r\n        Math.floor(this.y / other));\r\n};\r\n\r\n// Point polar coordinates:\r\n\r\nPoint.prototype.r = function () {\r\n    var t = (this.multiplyBy(this));\r\n    return Math.sqrt(t.x + t.y);\r\n};\r\n\r\nPoint.prototype.degrees = function () {\r\n/*\r\n    answer the angle I make with origin in degrees.\r\n    Right is 0, down is 90\r\n*/\r\n    var tan, theta;\r\n\r\n    if (this.x === 0) {\r\n        if (this.y >= 0) {\r\n            return 90;\r\n        }\r\n        return 270;\r\n    }\r\n    tan = this.y / this.x;\r\n    theta = Math.atan(tan);\r\n    if (this.x >= 0) {\r\n        if (this.y >= 0) {\r\n            return degrees(theta);\r\n        }\r\n        return 360 + (degrees(theta));\r\n    }\r\n    return 180 + degrees(theta);\r\n};\r\n\r\nPoint.prototype.theta = function () {\r\n/*\r\n    answer the angle I make with origin in radians.\r\n    Right is 0, down is 90\r\n*/\r\n    var tan, theta;\r\n\r\n    if (this.x === 0) {\r\n        if (this.y >= 0) {\r\n            return radians(90);\r\n        }\r\n        return radians(270);\r\n    }\r\n    tan = this.y / this.x;\r\n    theta = Math.atan(tan);\r\n    if (this.x >= 0) {\r\n        if (this.y >= 0) {\r\n            return theta;\r\n        }\r\n        return radians(360) + theta;\r\n    }\r\n    return radians(180) + theta;\r\n};\r\n\r\n// Point functions:\r\n\r\nPoint.prototype.crossProduct = function (aPoint) {\r\n    return this.multiplyBy(aPoint.mirror());\r\n};\r\n\r\nPoint.prototype.distanceTo = function (aPoint) {\r\n    return (aPoint.subtract(this)).r();\r\n};\r\n\r\nPoint.prototype.rotate = function (direction, center) {\r\n    // direction must be 'right', 'left' or 'pi'\r\n    var offset = this.subtract(center);\r\n    if (direction === 'right') {\r\n        return new Point(-offset.y, offset.y).add(center);\r\n    }\r\n    if (direction === 'left') {\r\n        return new Point(offset.y, -offset.y).add(center);\r\n    }\r\n    // direction === 'pi'\r\n    return center.subtract(offset);\r\n};\r\n\r\nPoint.prototype.flip = function (direction, center) {\r\n    // direction must be 'vertical' or 'horizontal'\r\n    if (direction === 'vertical') {\r\n        return new Point(this.x, center.y * 2 - this.y);\r\n    }\r\n    // direction === 'horizontal'\r\n    return new Point(center.x * 2 - this.x, this.y);\r\n};\r\n\r\nPoint.prototype.distanceAngle = function (dist, angle) {\r\n    var deg = angle, x, y;\r\n    if (deg > 270) {\r\n        deg = deg - 360;\r\n    } else if (deg < -270) {\r\n        deg = deg + 360;\r\n    }\r\n    if (-90 <= deg && deg <= 90) {\r\n        x = Math.sin(radians(deg)) * dist;\r\n        y = Math.sqrt((dist * dist) - (x * x));\r\n        return new Point(x + this.x, this.y - y);\r\n    }\r\n    x = Math.sin(radians(180 - deg)) * dist;\r\n    y = Math.sqrt((dist * dist) - (x * x));\r\n    return new Point(x + this.x, this.y + y);\r\n};\r\n\r\n// Point transforming:\r\n\r\nPoint.prototype.scaleBy = function (scalePoint) {\r\n    return this.multiplyBy(scalePoint);\r\n};\r\n\r\nPoint.prototype.translateBy = function (deltaPoint) {\r\n    return this.add(deltaPoint);\r\n};\r\n\r\nPoint.prototype.rotateBy = function (angle, centerPoint) {\r\n    var center = centerPoint || new Point(0, 0),\r\n        p = this.subtract(center),\r\n        r = p.r(),\r\n        theta = angle - p.theta();\r\n    return new Point(\r\n        center.x + (r * Math.cos(theta)),\r\n        center.y - (r * Math.sin(theta))\r\n    );\r\n};\r\n\r\n// Point conversion:\r\n\r\nPoint.prototype.asArray = function () {\r\n    return [this.x, this.y];\r\n};\r\n\r\n// Rectangles //////////////////////////////////////////////////////////\r\n\r\n// Rectangle instance creation:\r\n\r\nfunction Rectangle(left, top, right, bottom) {\r\n    this.init(new Point((left || 0), (top || 0)),\r\n            new Point((right || 0), (bottom || 0)));\r\n}\r\n\r\nRectangle.prototype.init = function (originPoint, cornerPoint) {\r\n    this.origin = originPoint;\r\n    this.corner = cornerPoint;\r\n};\r\n\r\n// Rectangle string representation: e.g. '[0@0 | 160@80]'\r\n\r\nRectangle.prototype.toString = function () {\r\n    return '[' + this.origin.toString() + ' | ' +\r\n        this.extent().toString() + ']';\r\n};\r\n\r\n// Rectangle copying:\r\n\r\nRectangle.prototype.copy = function () {\r\n    return new Rectangle(\r\n        this.left(),\r\n        this.top(),\r\n        this.right(),\r\n        this.bottom()\r\n    );\r\n};\r\n\r\n// creating Rectangle instances from Points:\r\n\r\nPoint.prototype.corner = function (cornerPoint) {\r\n    // answer a new Rectangle\r\n    return new Rectangle(\r\n        this.x,\r\n        this.y,\r\n        cornerPoint.x,\r\n        cornerPoint.y\r\n    );\r\n};\r\n\r\nPoint.prototype.rectangle = function (aPoint) {\r\n    // answer a new Rectangle\r\n    var org, crn;\r\n    org = this.min(aPoint);\r\n    crn = this.max(aPoint);\r\n    return new Rectangle(org.x, org.y, crn.x, crn.y);\r\n};\r\n\r\nPoint.prototype.extent = function (aPoint) {\r\n    //answer a new Rectangle\r\n    var crn = this.add(aPoint);\r\n    return new Rectangle(this.x, this.y, crn.x, crn.y);\r\n};\r\n\r\n// Rectangle accessing - setting:\r\n\r\nRectangle.prototype.setTo = function (left, top, right, bottom) {\r\n    // note: all inputs are optional and can be omitted\r\n\r\n    this.origin = new Point(\r\n        left || ((left === 0) ? 0 : this.left()),\r\n        top || ((top === 0) ? 0 : this.top())\r\n    );\r\n\r\n    this.corner = new Point(\r\n        right || ((right === 0) ? 0 : this.right()),\r\n        bottom || ((bottom === 0) ? 0 : this.bottom())\r\n    );\r\n};\r\n\r\n// Rectangle accessing - getting:\r\n\r\nRectangle.prototype.area = function () {\r\n    //requires width() and height() to be defined\r\n    var w = this.width();\r\n    if (w < 0) {\r\n        return 0;\r\n    }\r\n    return Math.max(w * this.height(), 0);\r\n};\r\n\r\nRectangle.prototype.bottom = function () {\r\n    return this.corner.y;\r\n};\r\n\r\nRectangle.prototype.bottomCenter = function () {\r\n    return new Point(this.center().x, this.bottom());\r\n};\r\n\r\nRectangle.prototype.bottomLeft = function () {\r\n    return new Point(this.origin.x, this.corner.y);\r\n};\r\n\r\nRectangle.prototype.bottomRight = function () {\r\n    return this.corner.copy();\r\n};\r\n\r\nRectangle.prototype.boundingBox = function () {\r\n    return this;\r\n};\r\n\r\nRectangle.prototype.center = function () {\r\n    return this.origin.add(\r\n        this.corner.subtract(this.origin).floorDivideBy(2)\r\n    );\r\n};\r\n\r\nRectangle.prototype.corners = function () {\r\n    return [this.origin,\r\n        this.bottomLeft(),\r\n        this.corner,\r\n        this.topRight()];\r\n};\r\n\r\nRectangle.prototype.extent = function () {\r\n    return this.corner.subtract(this.origin);\r\n};\r\n\r\nRectangle.prototype.height = function () {\r\n    return this.corner.y - this.origin.y;\r\n};\r\n\r\nRectangle.prototype.left = function () {\r\n    return this.origin.x;\r\n};\r\n\r\nRectangle.prototype.leftCenter = function () {\r\n    return new Point(this.left(), this.center().y);\r\n};\r\n\r\nRectangle.prototype.right = function () {\r\n    return this.corner.x;\r\n};\r\n\r\nRectangle.prototype.rightCenter = function () {\r\n    return new Point(this.right(), this.center().y);\r\n};\r\n\r\nRectangle.prototype.top = function () {\r\n    return this.origin.y;\r\n};\r\n\r\nRectangle.prototype.topCenter = function () {\r\n    return new Point(this.center().x, this.top());\r\n};\r\n\r\nRectangle.prototype.topLeft = function () {\r\n    return this.origin;\r\n};\r\n\r\nRectangle.prototype.topRight = function () {\r\n    return new Point(this.corner.x, this.origin.y);\r\n};\r\n\r\nRectangle.prototype.width = function () {\r\n    return this.corner.x - this.origin.x;\r\n};\r\n\r\nRectangle.prototype.position = function () {\r\n    return this.origin;\r\n};\r\n\r\n// Rectangle comparison:\r\n\r\nRectangle.prototype.eq = function (aRect) {\r\n    return this.origin.eq(aRect.origin) &&\r\n        this.corner.eq(aRect.corner);\r\n};\r\n\r\nRectangle.prototype.abs = function () {\r\n    var newOrigin, newCorner;\r\n\r\n    newOrigin = this.origin.abs();\r\n    newCorner = this.corner.max(newOrigin);\r\n    return newOrigin.corner(newCorner);\r\n};\r\n\r\n// Rectangle functions:\r\n\r\nRectangle.prototype.insetBy = function (delta) {\r\n    // delta can be either a Point or a Number\r\n    var result = new Rectangle();\r\n    result.origin = this.origin.add(delta);\r\n    result.corner = this.corner.subtract(delta);\r\n    return result;\r\n};\r\n\r\nRectangle.prototype.expandBy = function (delta) {\r\n    // delta can be either a Point or a Number\r\n    var result = new Rectangle();\r\n    result.origin = this.origin.subtract(delta);\r\n    result.corner = this.corner.add(delta);\r\n    return result;\r\n};\r\n\r\nRectangle.prototype.growBy = function (delta) {\r\n    // delta can be either a Point or a Number\r\n    var result = new Rectangle();\r\n    result.origin = this.origin.copy();\r\n    result.corner = this.corner.add(delta);\r\n    return result;\r\n};\r\n\r\nRectangle.prototype.intersect = function (aRect) {\r\n    var result = new Rectangle();\r\n    result.origin = this.origin.max(aRect.origin);\r\n    result.corner = this.corner.min(aRect.corner);\r\n    return result;\r\n};\r\n\r\nRectangle.prototype.merge = function (aRect) {\r\n    var result = new Rectangle();\r\n    result.origin = this.origin.min(aRect.origin);\r\n    result.corner = this.corner.max(aRect.corner);\r\n    return result;\r\n};\r\n\r\nRectangle.prototype.mergeWith = function (aRect) {\r\n    // mutates myself\r\n    this.origin = this.origin.min(aRect.origin);\r\n    this.corner = this.corner.max(aRect.corner);\r\n};\r\n\r\nRectangle.prototype.round = function () {\r\n    return this.origin.round().corner(this.corner.round());\r\n};\r\n\r\nRectangle.prototype.spread = function () {\r\n    // round me by applying floor() to my origin and ceil() to my corner\r\n    // expand by 1 to be on the safe side, this eliminates rounding\r\n    // artifacts caused by Safari's auto-scaling on retina displays\r\n    return this.origin.floor().corner(this.corner.ceil()).expandBy(1);\r\n};\r\n\r\nRectangle.prototype.amountToTranslateWithin = function (aRect) {\r\n/*\r\n    Answer a Point, delta, such that self + delta is forced within\r\n    aRectangle. when all of me cannot be made to fit, prefer to keep\r\n    my topLeft inside. Taken from Squeak.\r\n*/\r\n    var dx = 0, dy = 0;\r\n\r\n    if (this.right() > aRect.right()) {\r\n        dx = aRect.right() - this.right();\r\n    }\r\n    if (this.bottom() > aRect.bottom()) {\r\n        dy = aRect.bottom() - this.bottom();\r\n    }\r\n    if ((this.left() + dx) < aRect.left()) {\r\n        dx = aRect.left() - this.left();\r\n    }\r\n    if ((this.top() + dy) < aRect.top()) {\r\n        dy = aRect.top() - this.top();\r\n    }\r\n    return new Point(dx, dy);\r\n};\r\n\r\n// Rectangle testing:\r\n\r\nRectangle.prototype.containsPoint = function (aPoint) {\r\n    return this.origin.le(aPoint) && aPoint.lt(this.corner);\r\n};\r\n\r\nRectangle.prototype.containsRectangle = function (aRect) {\r\n    return aRect.origin.gt(this.origin) &&\r\n        aRect.corner.lt(this.corner);\r\n};\r\n\r\nRectangle.prototype.intersects = function (aRect) {\r\n    var ro = aRect.origin, rc = aRect.corner;\r\n    return (rc.x >= this.origin.x) &&\r\n        (rc.y >= this.origin.y) &&\r\n        (ro.x <= this.corner.x) &&\r\n        (ro.y <= this.corner.y);\r\n};\r\n\r\nRectangle.prototype.isNearTo = function (aRect, threshold) {\r\n    var ro = aRect.origin, rc = aRect.corner, border = threshold || 0;\r\n    return (rc.x + border >= this.origin.x) &&\r\n        (rc.y  + border >= this.origin.y) &&\r\n        (ro.x - border <= this.corner.x) &&\r\n        (ro.y - border <= this.corner.y);\r\n};\r\n\r\n// Rectangle transforming:\r\n\r\nRectangle.prototype.scaleBy = function (scale) {\r\n    // scale can be either a Point or a scalar\r\n    var o = this.origin.multiplyBy(scale),\r\n        c = this.corner.multiplyBy(scale);\r\n    return new Rectangle(o.x, o.y, c.x, c.y);\r\n};\r\n\r\nRectangle.prototype.translateBy = function (factor) {\r\n    // factor can be either a Point or a scalar\r\n    var o = this.origin.add(factor),\r\n        c = this.corner.add(factor);\r\n    return new Rectangle(o.x, o.y, c.x, c.y);\r\n};\r\n\r\n// Rectangle converting:\r\n\r\nRectangle.prototype.asArray = function () {\r\n    return [this.left(), this.top(), this.right(), this.bottom()];\r\n};\r\n\r\nRectangle.prototype.asArray_xywh = function () {\r\n    return [this.left(), this.top(), this.width(), this.height()];\r\n};\r\n\r\n// Nodes ///////////////////////////////////////////////////////////////\r\n\r\n// Node instance creation:\r\n\r\nfunction Node(parent, childrenArray) {\r\n    this.init(parent || null, childrenArray || []);\r\n}\r\n\r\nNode.prototype.init = function (parent, childrenArray) {\r\n    this.parent = parent || null;\r\n    this.children = childrenArray || [];\r\n};\r\n\r\n// Node string representation: e.g. 'a Node[3]'\r\n\r\nNode.prototype.toString = function () {\r\n    return 'a Node' + '[' + this.children.length.toString() + ']';\r\n};\r\n\r\n// Node accessing:\r\n\r\nNode.prototype.addChild = function (aNode) {\r\n    this.children.push(aNode);\r\n    aNode.parent = this;\r\n};\r\n\r\nNode.prototype.addChildFirst = function (aNode) {\r\n    this.children.splice(0, null, aNode);\r\n    aNode.parent = this;\r\n};\r\n\r\nNode.prototype.removeChild = function (aNode) {\r\n    var idx = this.children.indexOf(aNode);\r\n    if (idx !== -1) {\r\n        this.children.splice(idx, 1);\r\n    }\r\n};\r\n\r\n// Node functions:\r\n\r\nNode.prototype.root = function () {\r\n    if (this.parent === null) {\r\n        return this;\r\n    }\r\n    return this.parent.root();\r\n};\r\n\r\nNode.prototype.depth = function () {\r\n    if (this.parent === null) {\r\n        return 0;\r\n    }\r\n    return this.parent.depth() + 1;\r\n};\r\n\r\nNode.prototype.allChildren = function () {\r\n    // includes myself\r\n    var result = [this];\r\n    this.children.forEach(function (child) {\r\n        result = result.concat(child.allChildren());\r\n    });\r\n    return result;\r\n};\r\n\r\nNode.prototype.forAllChildren = function (aFunction) {\r\n    if (this.children.length > 0) {\r\n        this.children.forEach(function (child) {\r\n            child.forAllChildren(aFunction);\r\n        });\r\n    }\r\n    aFunction.call(null, this);\r\n};\r\n\r\nNode.prototype.anyChild = function (aPredicate) {\r\n    // includes myself\r\n    var i;\r\n    if (aPredicate.call(null, this)) {\r\n        return true;\r\n    }\r\n    for (i = 0; i < this.children.length; i += 1) {\r\n        if (this.children[i].anyChild(aPredicate)) {\r\n            return true;\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nNode.prototype.allLeafs = function () {\r\n    var result = [];\r\n    this.allChildren().forEach(function (element) {\r\n        if (element.children.length === 0) {\r\n            result.push(element);\r\n        }\r\n    });\r\n    return result;\r\n};\r\n\r\nNode.prototype.allParents = function () {\r\n    // includes myself\r\n    var result = [this];\r\n    if (this.parent !== null) {\r\n        result = result.concat(this.parent.allParents());\r\n    }\r\n    return result;\r\n};\r\n\r\nNode.prototype.siblings = function () {\r\n    var myself = this;\r\n    if (this.parent === null) {\r\n        return [];\r\n    }\r\n    return this.parent.children.filter(function (child) {\r\n        return child !== myself;\r\n    });\r\n};\r\n\r\nNode.prototype.parentThatIsA = function (constructor) {\r\n    // including myself\r\n    if (this instanceof constructor) {\r\n        return this;\r\n    }\r\n    if (!this.parent) {\r\n        return null;\r\n    }\r\n    return this.parent.parentThatIsA(constructor);\r\n};\r\n\r\nNode.prototype.parentThatIsAnyOf = function (constructors) {\r\n    // including myself\r\n    var yup = false,\r\n        myself = this;\r\n    constructors.forEach(function (each) {\r\n        if (myself.constructor === each) {\r\n            yup = true;\r\n            return;\r\n        }\r\n    });\r\n    if (yup) {\r\n        return this;\r\n    }\r\n    if (!this.parent) {\r\n        return null;\r\n    }\r\n    return this.parent.parentThatIsAnyOf(constructors);\r\n};\r\n\r\n// Morphs //////////////////////////////////////////////////////////////\r\n\r\n// Morph: referenced constructors\r\n\r\nvar Morph;\r\nvar WorldMorph;\r\nvar HandMorph;\r\nvar ShadowMorph;\r\nvar FrameMorph;\r\nvar MenuMorph;\r\nvar HandleMorph;\r\nvar StringFieldMorph;\r\nvar ColorPickerMorph;\r\nvar SliderMorph;\r\nvar ScrollFrameMorph;\r\nvar InspectorMorph;\r\nvar StringMorph;\r\nvar TextMorph;\r\n\r\n// Morph inherits from Node:\r\n\r\nMorph.prototype = new Node();\r\nMorph.prototype.constructor = Morph;\r\nMorph.uber = Node.prototype;\r\n\r\n// Morph settings:\r\n\r\n/*\r\n    damage list housekeeping\r\n\r\n    the trackChanges property of the Morph prototype is a Boolean switch\r\n    that determines whether the World's damage list ('broken' rectangles)\r\n    tracks changes. By default the switch is always on. If set to false\r\n    changes are not stored. This can be very useful for housekeeping of\r\n    the damage list in situations where a large number of (sub-) morphs\r\n    are changed more or less at once. Instead of keeping track of every\r\n    single submorph's changes tremendous performance improvements can be\r\n    achieved by setting the trackChanges flag to false before propagating\r\n    the layout changes, setting it to true again and then storing the full\r\n    bounds of the surrounding morph. As an example refer to the\r\n\r\n        fixLayout()\r\n\r\n    method of InspectorMorph, or the\r\n\r\n        startLayout()\r\n        endLayout()\r\n\r\n    methods of SyntaxElementMorph in the Snap application.\r\n*/\r\n\r\nMorph.prototype.trackChanges = true;\r\nMorph.prototype.shadowBlur = 4;\r\n\r\n// Morph instance creation:\r\n\r\nfunction Morph() {\r\n    this.init();\r\n}\r\n\r\n// Morph initialization:\r\n\r\nMorph.prototype.init = function (noDraw) {\r\n    Morph.uber.init.call(this);\r\n    this.isMorph = true;\r\n    this.image = null;\r\n    this.bounds = new Rectangle(0, 0, 50, 40);\r\n    this.cachedFullImage = null;\r\n    this.cachedFullBounds = null;\r\n    this.color = new Color(80, 80, 80);\r\n    this.texture = null; // optional url of a fill-image\r\n    this.cachedTexture = null; // internal cache of actual bg image\r\n    this.alpha = 1;\r\n    this.isVisible = true;\r\n    this.isDraggable = false;\r\n    this.isTemplate = false;\r\n    this.acceptsDrops = false;\r\n    this.noticesTransparentClick = false;\r\n    if (!noDraw) {this.drawNew(); }\r\n    this.fps = 0;\r\n    this.customContextMenu = null;\r\n    this.lastTime = Date.now();\r\n    this.onNextStep = null; // optional function to be run once\r\n};\r\n\r\n// Morph string representation: e.g. 'a Morph 2 [20@45 | 130@250]'\r\n\r\nMorph.prototype.toString = function () {\r\n    return 'a ' +\r\n        (this.constructor.name ||\r\n            this.constructor.toString().split(' ')[1].split('(')[0]) +\r\n        ' ' +\r\n        this.children.length.toString() + ' ' +\r\n        this.bounds;\r\n};\r\n\r\n// Morph deleting:\r\n\r\nMorph.prototype.destroy = function () {\r\n    if (this.parent !== null) {\r\n        this.fullChanged();\r\n        this.parent.removeChild(this);\r\n    }\r\n};\r\n\r\n// Morph stepping:\r\n\r\nMorph.prototype.stepFrame = function () {\r\n    if (!this.step) {\r\n        return null;\r\n    }\r\n    var current, elapsed, leftover, nxt;\r\n    current = Date.now();\r\n    elapsed = current - this.lastTime;\r\n    if (this.fps > 0) {\r\n        leftover = (1000 / this.fps) - elapsed;\r\n    } else {\r\n        leftover = 0;\r\n    }\r\n    if (leftover < 1) {\r\n        this.lastTime = current;\r\n        if (this.onNextStep) {\r\n            nxt = this.onNextStep;\r\n            this.onNextStep = null;\r\n            nxt.call(this);\r\n        }\r\n        this.step();\r\n        this.children.forEach(function (child) {\r\n            child.stepFrame();\r\n        });\r\n    }\r\n};\r\n\r\nMorph.prototype.nextSteps = function (arrayOfFunctions) {\r\n    var lst = arrayOfFunctions || [],\r\n        nxt = lst.shift(),\r\n        myself = this;\r\n    if (nxt) {\r\n        this.onNextStep = function () {\r\n            nxt.call(myself);\r\n            myself.nextSteps(lst);\r\n        };\r\n    }\r\n};\r\n\r\nMorph.prototype.step = nop;\r\n\r\n// Morph accessing - geometry getting:\r\n\r\nMorph.prototype.left = function () {\r\n    return this.bounds.left();\r\n};\r\n\r\nMorph.prototype.right = function () {\r\n    return this.bounds.right();\r\n};\r\n\r\nMorph.prototype.top = function () {\r\n    return this.bounds.top();\r\n};\r\n\r\nMorph.prototype.bottom = function () {\r\n    return this.bounds.bottom();\r\n};\r\n\r\nMorph.prototype.center = function () {\r\n    return this.bounds.center();\r\n};\r\n\r\nMorph.prototype.bottomCenter = function () {\r\n    return this.bounds.bottomCenter();\r\n};\r\n\r\nMorph.prototype.bottomLeft = function () {\r\n    return this.bounds.bottomLeft();\r\n};\r\n\r\nMorph.prototype.bottomRight = function () {\r\n    return this.bounds.bottomRight();\r\n};\r\n\r\nMorph.prototype.boundingBox = function () {\r\n    return this.bounds;\r\n};\r\n\r\nMorph.prototype.corners = function () {\r\n    return this.bounds.corners();\r\n};\r\n\r\nMorph.prototype.leftCenter = function () {\r\n    return this.bounds.leftCenter();\r\n};\r\n\r\nMorph.prototype.rightCenter = function () {\r\n    return this.bounds.rightCenter();\r\n};\r\n\r\nMorph.prototype.topCenter = function () {\r\n    return this.bounds.topCenter();\r\n};\r\n\r\nMorph.prototype.topLeft = function () {\r\n    return this.bounds.topLeft();\r\n};\r\n\r\nMorph.prototype.topRight = function () {\r\n    return this.bounds.topRight();\r\n};\r\nMorph.prototype.position = function () {\r\n    return this.bounds.origin;\r\n};\r\n\r\nMorph.prototype.extent = function () {\r\n    return this.bounds.extent();\r\n};\r\n\r\nMorph.prototype.width = function () {\r\n    return this.bounds.width();\r\n};\r\n\r\nMorph.prototype.height = function () {\r\n    return this.bounds.height();\r\n};\r\n\r\nMorph.prototype.fullBounds = function () {\r\n    var result;\r\n    result = this.bounds;\r\n    this.children.forEach(function (child) {\r\n        if (child.isVisible) {\r\n            result = result.merge(child.fullBounds());\r\n        }\r\n    });\r\n    return result;\r\n};\r\n\r\nMorph.prototype.fullBoundsNoShadow = function () {\r\n    // answer my full bounds but ignore any shadow\r\n    var result;\r\n    result = this.bounds;\r\n    this.children.forEach(function (child) {\r\n        if (!(child instanceof ShadowMorph) && (child.isVisible)) {\r\n            result = result.merge(child.fullBounds());\r\n        }\r\n    });\r\n    return result;\r\n};\r\n\r\nMorph.prototype.visibleBounds = function () {\r\n    // answer which part of me is not clipped by a Frame\r\n    var visible = this.bounds,\r\n        frames = this.allParents().filter(function (p) {\r\n            return p instanceof FrameMorph;\r\n        });\r\n    frames.forEach(function (f) {\r\n        visible = visible.intersect(f.bounds);\r\n    });\r\n    return visible;\r\n};\r\n\r\n// Morph accessing - simple changes:\r\n\r\nMorph.prototype.moveBy = function (delta) {\r\n    this.fullChanged();\r\n    this.silentMoveBy(delta);\r\n    this.fullChanged();\r\n};\r\n\r\nMorph.prototype.silentMoveBy = function (delta) {\r\n    var children = this.children,\r\n        i = children.length;\r\n    this.bounds = this.bounds.translateBy(delta);\r\n    if (this.cachedFullBounds) {\r\n        this.cachedFullBounds = this.cachedFullBounds.translateBy(delta);\r\n    }\r\n    // ugly optimization avoiding forEach()\r\n    for (i; i > 0; i -= 1) {\r\n        children[i - 1].silentMoveBy(delta);\r\n    }\r\n};\r\n\r\nMorph.prototype.setPosition = function (aPoint) {\r\n    var delta = aPoint.subtract(this.topLeft());\r\n    if ((delta.x !== 0) || (delta.y !== 0)) {\r\n        this.moveBy(delta);\r\n    }\r\n};\r\n\r\nMorph.prototype.silentSetPosition = function (aPoint) {\r\n    var delta = aPoint.subtract(this.topLeft());\r\n    if ((delta.x !== 0) || (delta.y !== 0)) {\r\n        this.silentMoveBy(delta);\r\n    }\r\n};\r\n\r\nMorph.prototype.setLeft = function (x) {\r\n    this.setPosition(\r\n        new Point(\r\n            x,\r\n            this.top()\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.setRight = function (x) {\r\n    this.setPosition(\r\n        new Point(\r\n            x - this.width(),\r\n            this.top()\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.setTop = function (y) {\r\n    this.setPosition(\r\n        new Point(\r\n            this.left(),\r\n            y\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.setBottom = function (y) {\r\n    this.setPosition(\r\n        new Point(\r\n            this.left(),\r\n            y - this.height()\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.setCenter = function (aPoint) {\r\n    this.setPosition(\r\n        aPoint.subtract(\r\n            this.extent().floorDivideBy(2)\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.setFullCenter = function (aPoint) {\r\n    this.setPosition(\r\n        aPoint.subtract(\r\n            this.fullBounds().extent().floorDivideBy(2)\r\n        )\r\n    );\r\n};\r\n\r\nMorph.prototype.keepWithin = function (aMorph) {\r\n    // make sure I am completely within another Morph's bounds\r\n    var leftOff, rightOff, topOff, bottomOff;\r\n    leftOff = this.fullBounds().left() - aMorph.left();\r\n    if (leftOff < 0) {\r\n        this.moveBy(new Point(-leftOff, 0));\r\n    }\r\n    rightOff = this.fullBounds().right() - aMorph.right();\r\n    if (rightOff > 0) {\r\n        this.moveBy(new Point(-rightOff, 0));\r\n    }\r\n    topOff = this.fullBounds().top() - aMorph.top();\r\n    if (topOff < 0) {\r\n        this.moveBy(new Point(0, -topOff));\r\n    }\r\n    bottomOff = this.fullBounds().bottom() - aMorph.bottom();\r\n    if (bottomOff > 0) {\r\n        this.moveBy(new Point(0, -bottomOff));\r\n    }\r\n};\r\n\r\nMorph.prototype.scrollIntoView = function () {\r\n    var leftOff, rightOff, topOff, bottomOff,\r\n        sf = this.parentThatIsA(ScrollFrameMorph);\r\n    if (!sf) {return; }\r\n    rightOff = Math.min(\r\n        this.fullBounds().right() - sf.right(),\r\n        sf.contents.right() - sf.right()\r\n    );\r\n    if (rightOff > 0) {\r\n        sf.contents.moveBy(new Point(-rightOff, 0));\r\n    }\r\n    leftOff = this.fullBounds().left() - sf.left();\r\n    if (leftOff < 0) {\r\n        sf.contents.moveBy(new Point(-leftOff, 0));\r\n    }\r\n    topOff = this.fullBounds().top() - sf.top();\r\n    if (topOff < 0) {\r\n        sf.contents.moveBy(new Point(0, -topOff));\r\n    }\r\n    bottomOff = this.fullBounds().bottom() - sf.bottom();\r\n    if (bottomOff > 0) {\r\n        sf.contents.moveBy(new Point(0, -bottomOff));\r\n    }\r\n    sf.adjustScrollBars();\r\n};\r\n\r\n// Morph accessing - dimensional changes requiring a complete redraw\r\n\r\nMorph.prototype.setExtent = function (aPoint, silently) {\r\n    // silently avoids redrawing the receiver\r\n    if (silently) {\r\n        this.silentSetExtent(aPoint);\r\n        return;\r\n    }\r\n    if (!aPoint.eq(this.extent())) {\r\n        this.changed();\r\n        this.silentSetExtent(aPoint);\r\n        this.changed();\r\n        this.drawNew();\r\n    }\r\n};\r\n\r\nMorph.prototype.silentSetExtent = function (aPoint) {\r\n    var ext, newWidth, newHeight;\r\n    ext = aPoint.round();\r\n    newWidth = Math.max(ext.x, 0);\r\n    newHeight = Math.max(ext.y, 0);\r\n    this.bounds.corner = new Point(\r\n        this.bounds.origin.x + newWidth,\r\n        this.bounds.origin.y + newHeight\r\n    );\r\n};\r\n\r\nMorph.prototype.setWidth = function (width) {\r\n    // TRACKJP\r\n    try {\r\n        this.setExtent(new Point(width || 0, this.height()));\r\n    }\r\n    catch (err) {\r\n        // watch error jp\r\n    }\r\n    \r\n};\r\n\r\nMorph.prototype.silentSetWidth = function (width) {\r\n    // do not drawNew() just yet\r\n    var w = Math.max(Math.round(width || 0), 0);\r\n    this.bounds.corner = new Point(\r\n        this.bounds.origin.x + w,\r\n        this.bounds.corner.y\r\n    );\r\n};\r\n\r\nMorph.prototype.setHeight = function (height) {\r\n  \r\n\r\n    // TRACKJP\r\n    try {\r\n        this.setExtent(new Point(this.width(), height || 0));\r\n    }\r\n    catch (err) {\r\n       // watch error jp\r\n    }\r\n};\r\n\r\nMorph.prototype.silentSetHeight = function (height) {\r\n    // do not drawNew() just yet\r\n    var h = Math.max(Math.round(height || 0), 0);\r\n    this.bounds.corner = new Point(\r\n        this.bounds.corner.x,\r\n        this.bounds.origin.y + h\r\n    );\r\n};\r\n\r\nMorph.prototype.setColor = function (aColor) {\r\n    if (aColor) {\r\n        if (!this.color.eq(aColor)) {\r\n            this.color = aColor;\r\n            this.changed();\r\n            this.drawNew();\r\n        }\r\n    }\r\n};\r\n\r\n// Morph displaying:\r\n\r\nMorph.prototype.drawNew = function () {\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    var context = this.image.getContext('2d');\r\n    context.fillStyle = this.color.toString();\r\n\r\n    /*\r\n        Chrome issue:\r\n\r\n            when filling a rectangular area, versions of Chrome beginning with\r\n            57.0.2987.133 start introducing vertical transparent stripes\r\n            to the right of the rectangle.\r\n            The following code replaces the original fillRect() call with\r\n            an explicit almost-rectangular path that miraculously  makes\r\n            sure the whole rectangle gets filled correctly.\r\n\r\n        Important: This needs to be monitored in the future so we can\r\n        revert to sane code once this Chrome issue has been resolved again.\r\n    */\r\n\r\n    // context.fillRect(0, 0, this.width(), this.height()); // taken out\r\n\r\n    context.beginPath();\r\n    context.moveTo(0, 0);\r\n    context.lineTo(this.image.width, 0);\r\n    context.lineTo(this.image.width, this.image.height);\r\n    context.lineTo(0, this.image.height + 0.0001); // yeah, I luv Chrome!\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (this.cachedTexture) {\r\n        this.drawCachedTexture();\r\n    } else if (this.texture) {\r\n        this.drawTexture(this.texture);\r\n    }\r\n};\r\n\r\nMorph.prototype.drawTexture = function (url) {\r\n    var myself = this;\r\n    this.cachedTexture = new Image();\r\n    this.cachedTexture.onload = function () {\r\n        myself.drawCachedTexture();\r\n    };\r\n    this.cachedTexture.src = this.texture = url; // make absolute\r\n};\r\n\r\nMorph.prototype.drawCachedTexture = function () {\r\n    var bg = this.cachedTexture,\r\n        cols = Math.floor(this.image.width / bg.width),\r\n        lines = Math.floor(this.image.height / bg.height),\r\n        x,\r\n        y,\r\n        context = this.image.getContext('2d');\r\n\r\n    for (y = 0; y <= lines; y += 1) {\r\n        for (x = 0; x <= cols; x += 1) {\r\n            context.drawImage(bg, x * bg.width, y * bg.height);\r\n        }\r\n    }\r\n    this.changed();\r\n};\r\n\r\nMorph.prototype.drawOn = function (aCanvas, aRect) {\r\n    var rectangle, area, delta, src, context, w, h, sl, st,\r\n        pic = this.cachedFullImage || this.image,\r\n        bounds = this.cachedFullBounds || this.bounds;\r\n    if (!this.isVisible) {\r\n        return null;\r\n    }\r\n    rectangle = aRect || bounds;\r\n    area = rectangle.intersect(bounds);\r\n    if (area.extent().gt(new Point(0, 0))) {\r\n        delta = bounds.position().neg();\r\n        src = area.copy().translateBy(delta);\r\n        context = aCanvas.getContext('2d');\r\n        context.globalAlpha = this.alpha;\r\n\r\n        sl = src.left();\r\n        st = src.top();\r\n        w = Math.min(src.width(), pic.width - sl);\r\n        h = Math.min(src.height(), pic.height - st);\r\n\r\n        if (w < 1 || h < 1) {\r\n            return null;\r\n        }\r\n\r\n        context.drawImage(\r\n            pic,\r\n            sl,\r\n            st,\r\n            w,\r\n            h,\r\n            area.left(),\r\n            area.top(),\r\n            w,\r\n            h\r\n        );\r\n    }\r\n};\r\n\r\nMorph.prototype.fullDrawOn = function (aCanvas, aRect) {\r\n    var rectangle;\r\n    if (!this.isVisible) {\r\n        return null;\r\n    }\r\n    rectangle = aRect || this.cachedFullBounds || this.fullBounds();\r\n    this.drawOn(aCanvas, rectangle);\r\n    if (this.cachedFullImage) {return; }\r\n    this.children.forEach(function (child) {\r\n        child.fullDrawOn(aCanvas, rectangle);\r\n    });\r\n};\r\n\r\nMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n    this.children.forEach(function (child) {\r\n        child.hide();\r\n    });\r\n};\r\n\r\nMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n    this.children.forEach(function (child) {\r\n        child.show();\r\n    });\r\n};\r\n\r\nMorph.prototype.toggleVisibility = function () {\r\n    this.isVisible = (!this.isVisible);\r\n    this.changed();\r\n    this.children.forEach(function (child) {\r\n        child.toggleVisibility();\r\n    });\r\n};\r\n\r\n// Morph full image:\r\n\r\nMorph.prototype.fullImageClassic = function () {\r\n    // use the cache since fullDrawOn() will\r\n    var fb = this.cachedFullBounds || this.fullBounds(),\r\n        img = newCanvas(fb.extent()),\r\n        ctx = img.getContext('2d');\r\n    ctx.translate(-fb.origin.x, -fb.origin.y);\r\n    this.fullDrawOn(img, fb);\r\n    img.globalAlpha = this.alpha;\r\n    return img;\r\n};\r\n\r\nMorph.prototype.fullImage = function () {\r\n    var img, ctx, fb;\r\n    img = newCanvas(this.fullBounds().extent());\r\n    ctx = img.getContext('2d');\r\n    fb = this.fullBounds();\r\n    this.allChildren().forEach(function (morph) {\r\n        if (morph.isVisible) {\r\n            ctx.globalAlpha = morph.alpha;\r\n            if (morph.image.width && morph.image.height) {\r\n                ctx.drawImage(\r\n                    morph.image,\r\n                    morph.bounds.origin.x - fb.origin.x,\r\n                    morph.bounds.origin.y - fb.origin.y\r\n                );\r\n            }\r\n        }\r\n    });\r\n    return img;\r\n};\r\n\r\n// Morph shadow:\r\n\r\nMorph.prototype.shadowImage = function (off, color) {\r\n    // fallback for Windows Chrome-Shadow bug\r\n    var fb, img, outline, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.fullBounds().extent();\r\n    img = this.fullImage();\r\n    outline = newCanvas(fb);\r\n    ctx = outline.getContext('2d');\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        -offset.x,\r\n        -offset.y\r\n    );\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.drawImage(outline, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = clr.toString();\r\n    ctx.fillRect(0, 0, fb.x, fb.y);\r\n    return sha;\r\n};\r\n\r\nMorph.prototype.shadowImageBlurred = function (off, color) {\r\n    var fb, img, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        blur = this.shadowBlur,\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.fullBounds().extent().add(blur * 2);\r\n    img = this.fullImage();\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.shadowOffsetX = offset.x;\r\n    ctx.shadowOffsetY = offset.y;\r\n    ctx.shadowBlur = blur;\r\n    ctx.shadowColor = clr.toString();\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    ctx.shadowOffsetX = 0;\r\n    ctx.shadowOffsetY = 0;\r\n    ctx.shadowBlur = 0;\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    return sha;\r\n};\r\n\r\nMorph.prototype.shadow = function (off, a, color) {\r\n    var shadow = new ShadowMorph(),\r\n        offset = off || new Point(7, 7),\r\n        alpha = a || ((a === 0) ? 0 : 0.2),\r\n        fb = this.fullBounds();\r\n    shadow.setExtent(fb.extent().add(this.shadowBlur * 2));\r\n    if (useBlurredShadows && !MorphicPreferences.isFlat) {\r\n        shadow.image = this.shadowImageBlurred(offset, color);\r\n        shadow.alpha = alpha;\r\n        shadow.setPosition(fb.origin.add(offset).subtract(this.shadowBlur));\r\n    } else {\r\n        shadow.image = this.shadowImage(offset, color);\r\n        shadow.alpha = alpha;\r\n        shadow.setPosition(fb.origin.add(offset));\r\n    }\r\n    return shadow;\r\n};\r\n\r\nMorph.prototype.addShadow = function (off, a, color) {\r\n    var shadow,\r\n        offset = off || new Point(7, 7),\r\n        alpha = a || ((a === 0) ? 0 : 0.2);\r\n    shadow = this.shadow(offset, alpha, color);\r\n    this.addBack(shadow);\r\n    this.fullChanged();\r\n    return shadow;\r\n};\r\n\r\nMorph.prototype.getShadow = function () {\r\n    var shadows;\r\n    shadows = this.children.slice(0).reverse().filter(\r\n        function (child) {\r\n            return child instanceof ShadowMorph;\r\n        }\r\n    );\r\n    if (shadows.length !== 0) {\r\n        return shadows[0];\r\n    }\r\n    return null;\r\n};\r\n\r\nMorph.prototype.removeShadow = function () {\r\n    var shadow = this.getShadow();\r\n    if (shadow !== null) {\r\n        this.fullChanged();\r\n        this.removeChild(shadow);\r\n    }\r\n};\r\n\r\n// Morph pen trails:\r\n\r\nMorph.prototype.penTrails = function () {\r\n    // answer my pen trails canvas. default is to answer my image\r\n    return this.image;\r\n};\r\n\r\nMorph.prototype.changed = function () {\r\n    if (this.trackChanges) {\r\n        var w = this.root();\r\n        if (w instanceof WorldMorph) {\r\n            w.broken.push(this.visibleBounds().spread());\r\n        }\r\n    }\r\n    if (this.parent) {\r\n        this.parent.childChanged(this);\r\n    }\r\n\r\n};\r\n\r\nMorph.prototype.fullChanged = function () {\r\n    if (this.trackChanges) {\r\n        var w = this.root();\r\n        if (w instanceof WorldMorph) {\r\n            w.broken.push(\r\n                (this.cachedFullBounds || this.fullBounds()).spread()\r\n            );\r\n           // Wiquid : user activity tracker here if needed  \r\n\r\n        }\r\n    }\r\n};\r\n\r\nMorph.prototype.childChanged = function () {\r\n    // react to a change in one of my children,\r\n    // default is to just pass this message on upwards\r\n    // override this method for Morphs that need to adjust accordingly\r\n    if (this.parent) {\r\n        this.parent.childChanged(this);\r\n\r\n    }\r\n};\r\n\r\n// Morph accessing - structure:\r\n\r\nMorph.prototype.world = function () {\r\n    var root = this.root();\r\n    if (root instanceof WorldMorph) {\r\n        return root;\r\n    }\r\n    if (root instanceof HandMorph) {\r\n        return root.world;\r\n    }\r\n    return null;\r\n};\r\n\r\nMorph.prototype.add = function (aMorph) {\r\n    var owner = aMorph.parent;\r\n    if (owner !== null) {\r\n        owner.removeChild(aMorph);\r\n    }\r\n    this.addChild(aMorph);\r\n\r\n};\r\n\r\nMorph.prototype.addBack = function (aMorph) {\r\n    var owner = aMorph.parent;\r\n    if (owner !== null) {\r\n        owner.removeChild(aMorph);\r\n    }\r\n    this.addChildFirst(aMorph);\r\n};\r\n\r\nMorph.prototype.topMorphAt = function (point) {\r\n    var i, result;\r\n    if (!this.isVisible) {return null; }\r\n    for (i = this.children.length - 1; i >= 0; i -= 1) {\r\n        result = this.children[i].topMorphAt(point);\r\n        if (result) {return result; }\r\n    }\r\n    return this.bounds.containsPoint(point) &&\r\n        (this.noticesTransparentClick || !this.isTransparentAt(point)) ? this\r\n              : null;\r\n};\r\n\r\nMorph.prototype.topMorphSuchThat = function (predicate) {\r\n    var next;\r\n    if (predicate.call(null, this)) {\r\n        next = detect(\r\n            this.children.slice(0).reverse(),\r\n            predicate\r\n        );\r\n        if (next) {\r\n            return next.topMorphSuchThat(predicate);\r\n        }\r\n        return this;\r\n    }\r\n    return null;\r\n};\r\n\r\nMorph.prototype.overlappedMorphs = function () {\r\n    //exclude the World\r\n    var world = this.world(),\r\n        fb = this.fullBounds(),\r\n        myself = this,\r\n        allParents = this.allParents(),\r\n        allChildren = this.allChildren(),\r\n        morphs;\r\n\r\n    morphs = world.allChildren();\r\n    return morphs.filter(function (m) {\r\n        return m.isVisible &&\r\n            m !== myself &&\r\n            m !== world &&\r\n            !contains(allParents, m) &&\r\n            !contains(allChildren, m) &&\r\n            m.fullBounds().intersects(fb);\r\n    });\r\n};\r\n\r\n// Morph pixel access:\r\n\r\nMorph.prototype.getPixelColor = function (aPoint) {\r\n    var point, context, data;\r\n    point = aPoint.subtract(this.bounds.origin);\r\n    context = this.image.getContext('2d');\r\n    data = context.getImageData(point.x, point.y, 1, 1);\r\n    return new Color(\r\n        data.data[0],\r\n        data.data[1],\r\n        data.data[2],\r\n        data.data[3] / 255\r\n    );\r\n};\r\n\r\nMorph.prototype.isTransparentAt = function (aPoint) {\r\n    var point, context, data;\r\n    if (this.bounds.containsPoint(aPoint)) {\r\n        if (this.texture) {\r\n            return false;\r\n        }\r\n        point = aPoint.subtract(this.bounds.origin);\r\n        context = this.image.getContext('2d');\r\n        data = context.getImageData(\r\n            Math.floor(point.x),\r\n            Math.floor(point.y),\r\n            1,\r\n            1\r\n        );\r\n        return data.data[3] === 0;\r\n    }\r\n    return false;\r\n};\r\n\r\n// Morph duplicating:\r\n\r\nMorph.prototype.copy = function () {\r\n    var c = copy(this);\r\n    c.parent = null;\r\n    c.children = [];\r\n    c.bounds = this.bounds.copy();\r\n    return c;\r\n};\r\n\r\nMorph.prototype.fullCopy = function () {\r\n    /*\r\n    Produce a copy of me with my entire tree of submorphs. Morphs\r\n    mentioned more than once are all directed to a single new copy.\r\n    Other properties are also *shallow* copied, so you must override\r\n    to deep copy Arrays and (complex) Objects\r\n    */\r\n    var map = new Map(), c;\r\n    c = this.copyRecordingReferences(map);\r\n    c.forAllChildren(function (m) {\r\n        m.updateReferences(map);\r\n    });\r\n    return c;\r\n};\r\n\r\nMorph.prototype.copyRecordingReferences = function (map) {\r\n    /*\r\n    Recursively copy this entire composite morph, recording the\r\n    correspondence between old and new morphs in the given dictionary.\r\n    This dictionary will be used to update intra-composite references\r\n    in the copy. See updateReferences().\r\n\r\n    Note: This default implementation copies ONLY morphs. If a morph\r\n    stores morphs in other properties that it wants to copy, then it\r\n    should override this method to do so. The same goes for morphs that\r\n    contain other complex data that should be copied when the morph is\r\n    duplicated.\r\n    */\r\n    var c = this.copy();\r\n    map.set(this, c);\r\n    this.children.forEach(function (m) {\r\n        c.add(m.copyRecordingReferences(map));\r\n    });\r\n    return c;\r\n};\r\n\r\nMorph.prototype.updateReferences = function (map) {\r\n    /*\r\n    Update intra-morph references within a composite morph that has\r\n    been copied. For example, if a button refers to morph X in the\r\n    orginal composite then the copy of that button in the new composite\r\n    should refer to the copy of X in new composite, not the original X.\r\n    */\r\n    var properties = Object.keys(this),\r\n        l = properties.length,\r\n        property,\r\n        value,\r\n        reference,\r\n        i;\r\n    for (i = 0; i < l; i += 1) {\r\n        property = properties[i];\r\n        value = this[property];\r\n        if (value && value.isMorph) {\r\n            reference = map.get(value);\r\n            if (reference) { this[property] = reference; }\r\n        }\r\n    }\r\n};\r\n\r\n// Morph dragging and dropping:\r\n\r\nMorph.prototype.rootForGrab = function () {\r\n    if (this instanceof ShadowMorph) {\r\n        return this.parent.rootForGrab();\r\n    }\r\n    if (this.parent instanceof ScrollFrameMorph) {\r\n        return this.parent;\r\n    }\r\n    if (this.parent === null ||\r\n            this.parent instanceof WorldMorph ||\r\n            this.parent instanceof FrameMorph ||\r\n            this.isDraggable === true) {\r\n        return this;\r\n    }\r\n    return this.parent.rootForGrab();\r\n};\r\n\r\nMorph.prototype.isCorrectingOutsideDrag = function () {\r\n    // make sure I don't \"trail behind\" the hand when dragged\r\n    // override for morphs that you want to be dragged outside\r\n    // their full bounds\r\n    return true;\r\n};\r\n\r\nMorph.prototype.wantsDropOf = function (aMorph) {\r\n    // default is to answer the general flag - change for my heirs\r\n    if ((aMorph instanceof HandleMorph) ||\r\n            (aMorph instanceof MenuMorph) ||\r\n            (aMorph instanceof InspectorMorph)) {\r\n        return false;\r\n    }\r\n    return this.acceptsDrops;\r\n};\r\n\r\nMorph.prototype.pickUp = function (wrrld) {\r\n    var world = wrrld || this.world();\r\n    this.setPosition(\r\n        world.hand.position().subtract(\r\n            this.extent().floorDivideBy(2)\r\n        )\r\n    );\r\n    world.hand.grab(this);\r\n};\r\n\r\nMorph.prototype.isPickedUp = function () {\r\n    return this.parentThatIsA(HandMorph) !== null;\r\n};\r\n\r\nMorph.prototype.situation = function () {\r\n    // answer a dictionary specifying where I am right now, so\r\n    // I can slide back to it if I'm dropped somewhere else\r\n    if (this.parent) {\r\n        return {\r\n            origin: this.parent,\r\n            position: this.position().subtract(this.parent.position())\r\n        };\r\n    }\r\n    return null;\r\n};\r\n\r\nMorph.prototype.slideBackTo = function (\r\n    situation,\r\n    msecs,\r\n    onBeforeDrop,\r\n    onComplete\r\n) {\r\n    var pos = situation.origin.position().add(situation.position),\r\n        myself = this;\r\n    this.glideTo(\r\n        pos,\r\n        msecs,\r\n        null, // easing\r\n        function () {\r\n            situation.origin.add(myself);\r\n            if (onBeforeDrop) {onBeforeDrop(); }\r\n            if (myself.justDropped) {myself.justDropped(); }\r\n            if (situation.origin.reactToDropOf) {\r\n                situation.origin.reactToDropOf(myself);\r\n            }\r\n            if (onComplete) {onComplete(); }\r\n        }\r\n    );\r\n};\r\n\r\n// Morph animating:\r\n\r\nMorph.prototype.glideTo = function (endPoint, msecs, easing, onComplete) {\r\n    var world = this.world(),\r\n        myself = this;\r\n    world.animations.push(new Animation(\r\n        function (x) {myself.setLeft(x); },\r\n        function () {return myself.left(); },\r\n        -(this.left() - endPoint.x),\r\n        msecs || 100,\r\n        easing,\r\n        onComplete\r\n    ));\r\n    world.animations.push(new Animation(\r\n        function (y) {myself.setTop(y); },\r\n        function () {return myself.top(); },\r\n        -(this.top() - endPoint.y),\r\n        msecs || 100,\r\n        easing\r\n    ));\r\n};\r\n\r\nMorph.prototype.fadeTo = function (endAlpha, msecs, easing, onComplete) {\r\n    // include all my children, restore all original transparencies\r\n    // on completion, so I can be recovered\r\n    var world = this.world(),\r\n        myself = this,\r\n        oldAlpha = this.alpha;\r\n    this.children.forEach(function (child) {\r\n        child.fadeTo(endAlpha, msecs, easing);\r\n    });\r\n    world.animations.push(new Animation(\r\n        function (n) {\r\n            myself.alpha = n;\r\n            myself.changed();\r\n        },\r\n        function () {return myself.alpha; },\r\n        endAlpha - this.alpha,\r\n        msecs || 200,\r\n        easing,\r\n        function () {\r\n            myself.alpha = oldAlpha;\r\n            if (onComplete) {onComplete(); }\r\n        }\r\n    ));\r\n};\r\n\r\nMorph.prototype.perish = function (msecs, onComplete) {\r\n    var myself = this;\r\n    this.fadeTo(\r\n        0,\r\n        msecs || 100,\r\n        null,\r\n        function () {\r\n            myself.destroy();\r\n            if (onComplete) {onComplete(); }\r\n        }\r\n    );\r\n};\r\n\r\n// Morph utilities:\r\n\r\nMorph.prototype.nop = nop;\r\n\r\nMorph.prototype.resize = function () {\r\n    this.world().activeHandle = new HandleMorph(this);\r\n};\r\n\r\nMorph.prototype.move = function () {\r\n    this.world().activeHandle = new HandleMorph(\r\n        this,\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        'move'\r\n    );\r\n};\r\n\r\nMorph.prototype.moveCenter = function () {\r\n    this.world().activeHandle = new HandleMorph(\r\n        this,\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        'moveCenter'\r\n    );\r\n};\r\n\r\nMorph.prototype.hint = function (msg) {\r\n    var m, text;\r\n    text = msg;\r\n    if (msg) {\r\n        if (msg.toString) {\r\n            text = msg.toString();\r\n        }\r\n    } else {\r\n        text = 'NULL';\r\n    }\r\n    m = new MenuMorph(this, text);\r\n    m.isDraggable = true;\r\n    m.popUpCenteredAtHand(this.world());\r\n};\r\n\r\nMorph.prototype.inform = function (msg) {\r\n    var m, text;\r\n    text = msg;\r\n    if (msg) {\r\n        if (msg.toString) {\r\n            text = msg.toString();\r\n        }\r\n    } else {\r\n        text = 'NULL';\r\n    }\r\n    m = new MenuMorph(this, text);\r\n    m.addItem(\"Ok\");\r\n    m.isDraggable = true;\r\n    m.popUpCenteredAtHand(this.world());\r\n};\r\n\r\nMorph.prototype.prompt = function (\r\n    msg,\r\n    callback,\r\n    environment,\r\n    defaultContents,\r\n    width,\r\n    floorNum,\r\n    ceilingNum,\r\n    isRounded\r\n) {\r\n    var menu, entryField, slider, isNumeric;\r\n    if (ceilingNum) {\r\n        isNumeric = true;\r\n    }\r\n    menu = new MenuMorph(\r\n        callback || null,\r\n        msg || '',\r\n        environment || null\r\n    );\r\n    entryField = new StringFieldMorph(\r\n        defaultContents || '',\r\n        width || 100,\r\n        MorphicPreferences.prompterFontSize,\r\n        MorphicPreferences.prompterFontName,\r\n        false,\r\n        false,\r\n        isNumeric\r\n    );\r\n    menu.items.push(entryField);\r\n    if (ceilingNum || MorphicPreferences.useSliderForInput) {\r\n        slider = new SliderMorph(\r\n            floorNum || 0,\r\n            ceilingNum,\r\n            parseFloat(defaultContents),\r\n            Math.floor((ceilingNum - floorNum) / 4),\r\n            'horizontal'\r\n        );\r\n        slider.alpha = 1;\r\n        slider.color = new Color(225, 225, 225);\r\n        slider.button.color = menu.borderColor;\r\n        slider.button.highlightColor = slider.button.color.copy();\r\n        slider.button.highlightColor.b += 100;\r\n        slider.button.pressColor = slider.button.color.copy();\r\n        slider.button.pressColor.b += 150;\r\n        slider.setHeight(MorphicPreferences.prompterSliderSize);\r\n        if (isRounded) {\r\n            slider.action = function (num) {\r\n                entryField.changed();\r\n                entryField.text.text = Math.round(num).toString();\r\n                entryField.text.drawNew();\r\n                entryField.text.changed();\r\n                entryField.text.edit();\r\n            };\r\n        } else {\r\n            slider.action = function (num) {\r\n                entryField.changed();\r\n                entryField.text.text = num.toString();\r\n                entryField.text.drawNew();\r\n                entryField.text.changed();\r\n            };\r\n        }\r\n        menu.items.push(slider);\r\n    }\r\n\r\n    menu.addLine(2);\r\n    menu.addItem('Ok', function () {\r\n        return entryField.string();\r\n    });\r\n    menu.addItem('Cancel', function () {\r\n        return null;\r\n    });\r\n    menu.isDraggable = true;\r\n    menu.popUpAtHand(this.world());\r\n    entryField.text.edit();\r\n};\r\n\r\nMorph.prototype.pickColor = function (\r\n    msg,\r\n    callback,\r\n    environment,\r\n    defaultContents\r\n) {\r\n    var menu, colorPicker;\r\n    menu = new MenuMorph(\r\n        callback || null,\r\n        msg || '',\r\n        environment || null\r\n    );\r\n    colorPicker = new ColorPickerMorph(defaultContents);\r\n    menu.items.push(colorPicker);\r\n    menu.addLine(2);\r\n    menu.addItem('Ok', function () {\r\n        return colorPicker.getChoice();\r\n    });\r\n    menu.addItem('Cancel', function () {\r\n        return null;\r\n    });\r\n    menu.isDraggable = true;\r\n    menu.popUpAtHand(this.world());\r\n};\r\n\r\nMorph.prototype.inspect = function (anotherObject) {\r\n    var world = this.world instanceof Function ?\r\n            this.world() : this.root() || this.world,\r\n        inspector,\r\n        inspectee = this;\r\n\r\n    if (anotherObject) {\r\n        inspectee = anotherObject;\r\n    }\r\n    inspector = new InspectorMorph(inspectee);\r\n    inspector.setPosition(world.hand.position());\r\n    inspector.keepWithin(world);\r\n    world.add(inspector);\r\n    inspector.changed();\r\n};\r\n\r\n// Morph menus:\r\n\r\nMorph.prototype.contextMenu = function () {\r\n    var world;\r\n\r\n    if (this.customContextMenu) {\r\n        return this.customContextMenu;\r\n    }\r\n    world = this.world instanceof Function ? this.world() : this.world;\r\n    if (world && world.isDevMode) {\r\n        if (this.parent === world) {\r\n            return this.developersMenu();\r\n        }\r\n        return this.hierarchyMenu();\r\n    }\r\n    return this.userMenu() ||\r\n        (this.parent && this.parent.userMenu());\r\n};\r\n\r\nMorph.prototype.hierarchyMenu = function () {\r\n    var parents = this.allParents(),\r\n        world = this.world instanceof Function ? this.world() : this.world,\r\n        menu = new MenuMorph(this, null);\r\n\r\n    parents.forEach(function (each) {\r\n        if (each.developersMenu && (each !== world)) {\r\n            menu.addMenu(\r\n                each.toString().slice(0, 50),\r\n                each.developersMenu()\r\n            );\r\n        }\r\n    });\r\n    return menu;\r\n};\r\n\r\nMorph.prototype.developersMenu = function () {\r\n    // 'name' is not an official property of a function, hence:\r\n    var world = this.world instanceof Function ? this.world() : this.world,\r\n        userMenu = this.userMenu() ||\r\n            (this.parent && this.parent.userMenu()),\r\n        menu = new MenuMorph(this, this.constructor.name ||\r\n            this.constructor.toString().split(' ')[1].split('(')[0]);\r\n    if (userMenu) {\r\n        menu.addMenu('user features', userMenu);\r\n        menu.addLine();\r\n    }\r\n    menu.addItem(\r\n        \"color...\",\r\n        function () {\r\n            this.pickColor(\r\n                menu.title + localize('\\ncolor:'),\r\n                this.setColor,\r\n                this,\r\n                this.color\r\n            );\r\n        },\r\n        'choose another color \\nfor this morph'\r\n    );\r\n    menu.addItem(\r\n        \"transparency...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + localize('\\nalpha\\nvalue:'),\r\n                this.setAlphaScaled,\r\n                this,\r\n                (this.alpha * 100).toString(),\r\n                null,\r\n                1,\r\n                100,\r\n                true\r\n            );\r\n        },\r\n        'set this morph\\'s\\nalpha value'\r\n    );\r\n    menu.addItem(\r\n        \"resize...\",\r\n        'resize',\r\n        'show a handle\\nwhich can be dragged\\nto change this morph\\'s' +\r\n            ' extent'\r\n    );\r\n    menu.addLine();\r\n    menu.addItem(\r\n        \"duplicate\",\r\n        function () {\r\n            this.fullCopy().pickUp(this.world());\r\n        },\r\n        'make a copy\\nand pick it up'\r\n    );\r\n    menu.addItem(\r\n        \"pick up\",\r\n        'pickUp',\r\n        'detach and put \\ninto the hand'\r\n    );\r\n    menu.addItem(\r\n        \"attach...\",\r\n        'attach',\r\n        'stick this morph\\nto another one'\r\n    );\r\n    menu.addItem(\r\n        \"move...\",\r\n        'move',\r\n        'show a handle\\nwhich can be dragged\\nto move this morph'\r\n    );\r\n    menu.addItem(\r\n        \"inspect...\",\r\n        'inspect',\r\n        'open a window\\non all properties'\r\n    );\r\n    menu.addItem(\r\n        \"pic...\",\r\n        function () {\r\n            window.open(this.fullImageClassic().toDataURL());\r\n        },\r\n        'open a new window\\nwith a picture of this morph'\r\n    );\r\n    menu.addLine();\r\n    if (this.isDraggable) {\r\n        menu.addItem(\r\n            \"lock\",\r\n            'toggleIsDraggable',\r\n            'make this morph\\nunmovable'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            \"unlock\",\r\n            'toggleIsDraggable',\r\n            'make this morph\\nmovable'\r\n        );\r\n    }\r\n    menu.addItem(\"hide\", 'hide');\r\n    menu.addItem(\"delete\", 'destroy');\r\n    if (!(this instanceof WorldMorph)) {\r\n        menu.addLine();\r\n        menu.addItem(\r\n            \"World...\",\r\n            function () {\r\n                world.contextMenu().popUpAtHand(world);\r\n            },\r\n            'show the\\nWorld\\'s menu'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\nMorph.prototype.userMenu = function () {\r\n    return null;\r\n};\r\n\r\n// Morph menu actions\r\n\r\nMorph.prototype.setAlphaScaled = function (alpha) {\r\n    // for context menu demo purposes\r\n    var newAlpha, unscaled;\r\n    if (typeof alpha === 'number') {\r\n        unscaled = alpha / 100;\r\n        this.alpha = Math.min(Math.max(unscaled, 0.1), 1);\r\n    } else {\r\n        newAlpha = parseFloat(alpha);\r\n        if (!isNaN(newAlpha)) {\r\n            unscaled = newAlpha / 100;\r\n            this.alpha = Math.min(Math.max(unscaled, 0.1), 1);\r\n        }\r\n    }\r\n    this.changed();\r\n};\r\n\r\nMorph.prototype.attach = function () {\r\n    var choices = this.overlappedMorphs(),\r\n        menu = new MenuMorph(this, 'choose new parent:'),\r\n        myself = this;\r\n\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each.toString().slice(0, 50), function () {\r\n            each.add(myself);\r\n            myself.isDraggable = false;\r\n        });\r\n    });\r\n    if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\nMorph.prototype.toggleIsDraggable = function () {\r\n    // for context menu demo purposes\r\n    this.isDraggable = !this.isDraggable;\r\n};\r\n\r\nMorph.prototype.colorSetters = function () {\r\n    // for context menu demo purposes\r\n    return ['color'];\r\n};\r\n\r\nMorph.prototype.numericalSetters = function () {\r\n    // for context menu demo purposes\r\n    return [\r\n        'setLeft',\r\n        'setTop',\r\n        'setWidth',\r\n        'setHeight',\r\n        'setAlphaScaled'\r\n    ];\r\n};\r\n\r\n// Morph entry field tabbing:\r\n\r\nMorph.prototype.allEntryFields = function () {\r\n    return this.allChildren().filter(function (each) {\r\n        return each.isEditable &&\r\n            (each instanceof StringMorph ||\r\n                each instanceof TextMorph);\r\n    });\r\n};\r\n\r\nMorph.prototype.nextEntryField = function (current) {\r\n    var fields = this.allEntryFields(),\r\n        idx = fields.indexOf(current);\r\n    if (idx !== -1) {\r\n        if (fields.length > idx + 1) {\r\n            return fields[idx + 1];\r\n        }\r\n    }\r\n    return fields[0];\r\n};\r\n\r\nMorph.prototype.previousEntryField = function (current) {\r\n    var fields = this.allEntryFields(),\r\n        idx = fields.indexOf(current);\r\n    if (idx !== -1) {\r\n        if (idx > 0) {\r\n            return fields[idx - 1];\r\n        }\r\n        return fields[fields.length - 1];\r\n    }\r\n    return fields[0];\r\n};\r\n\r\nMorph.prototype.tab = function (editField) {\r\n/*\r\n    the <tab> key was pressed in one of my edit fields.\r\n    invoke my \"nextTab()\" function if it exists, else\r\n    propagate it up my owner chain.\r\n*/\r\n    if (this.nextTab) {\r\n        this.nextTab(editField);\r\n    } else if (this.parent) {\r\n        this.parent.tab(editField);\r\n    }\r\n};\r\n\r\nMorph.prototype.backTab = function (editField) {\r\n/*\r\n    the <back tab> key was pressed in one of my edit fields.\r\n    invoke my \"previousTab()\" function if it exists, else\r\n    propagate it up my owner chain.\r\n*/\r\n    if (this.previousTab) {\r\n        this.previousTab(editField);\r\n    } else if (this.parent) {\r\n        this.parent.backTab(editField);\r\n    }\r\n};\r\n\r\n/*\r\n    the following are examples of what the navigation methods should\r\n    look like. Insert these at the World level for fallback, and at lower\r\n    levels in the Morphic tree (e.g. dialog boxes) for a more fine-grained\r\n    control over the tabbing cycle.\r\n*/\r\n\r\n// Morph events:\r\n\r\nMorph.prototype.escalateEvent = function (functionName, arg) {\r\n    var handler = this.parent;\r\n    while (!handler[functionName] && handler.parent !== null) {\r\n        handler = handler.parent;\r\n    }\r\n    if (handler[functionName]) {\r\n        handler[functionName](arg);\r\n    }\r\n};\r\n\r\n// Morph eval:\r\n\r\nMorph.prototype.evaluateString = function (code) {\r\n    var result;\r\n\r\n    try {\r\n        result = eval(code);\r\n        this.drawNew();\r\n        this.changed();\r\n    } catch (err) {\r\n        this.inform(err);\r\n    }\r\n    return result;\r\n};\r\n\r\n// Morph collision detection:\r\n\r\nMorph.prototype.isTouching = function (otherMorph) {\r\n    var oImg = this.overlappingImage(otherMorph),\r\n        data;\r\n    if (!oImg.width || !oImg.height) {\r\n        return false;\r\n    }\r\n    data = oImg.getContext('2d')\r\n        .getImageData(1, 1, oImg.width, oImg.height)\r\n        .data;\r\n    return detect(\r\n        data,\r\n        function (each) {\r\n            return each !== 0;\r\n        }\r\n    ) !== null;\r\n};\r\n\r\nMorph.prototype.overlappingImage = function (otherMorph) {\r\n    var fb = this.fullBounds(),\r\n        otherFb = otherMorph.fullBounds(),\r\n        oRect = fb.intersect(otherFb),\r\n        oImg = newCanvas(oRect.extent()),\r\n        ctx = oImg.getContext('2d');\r\n    if (oRect.width() < 1 || oRect.height() < 1) {\r\n        return newCanvas(new Point(1, 1));\r\n    }\r\n    ctx.drawImage(\r\n        this.fullImage(),\r\n        oRect.origin.x - fb.origin.x,\r\n        oRect.origin.y - fb.origin.y\r\n    );\r\n    ctx.globalCompositeOperation = 'source-in';\r\n    ctx.drawImage(\r\n        otherMorph.fullImage(),\r\n        otherFb.origin.x - oRect.origin.x,\r\n        otherFb.origin.y - oRect.origin.y\r\n    );\r\n    return oImg;\r\n};\r\n\r\n// ShadowMorph /////////////////////////////////////////////////////////\r\n\r\n// ShadowMorph inherits from Morph:\r\n\r\nShadowMorph.prototype = new Morph();\r\nShadowMorph.prototype.constructor = ShadowMorph;\r\nShadowMorph.uber = Morph.prototype;\r\n\r\n// ShadowMorph instance creation:\r\n\r\nfunction ShadowMorph() {\r\n    this.init();\r\n}\r\n\r\nShadowMorph.prototype.topMorphAt = function () {\r\n    return null;\r\n};\r\n\r\n// HandleMorph ////////////////////////////////////////////////////////\r\n\r\n// I am a resize / move handle that can be attached to any Morph\r\n\r\n// HandleMorph inherits from Morph:\r\n\r\nHandleMorph.prototype = new Morph();\r\nHandleMorph.prototype.constructor = HandleMorph;\r\nHandleMorph.uber = Morph.prototype;\r\n\r\n// HandleMorph instance creation:\r\n\r\nfunction HandleMorph(target, minX, minY, insetX, insetY, type) {\r\n    // if insetY is missing, it will be the same as insetX\r\n    this.init(target, minX, minY, insetX, insetY, type);\r\n}\r\n\r\nHandleMorph.prototype.init = function (\r\n    target,\r\n    minX,\r\n    minY,\r\n    insetX,\r\n    insetY,\r\n    type\r\n) {\r\n    var size = MorphicPreferences.handleSize;\r\n    this.target = target || null;\r\n    this.minExtent = new Point(minX || 0, minY || 0);\r\n    this.inset = new Point(insetX || 0, insetY || insetX || 0);\r\n    this.type =  type || 'resize'; // also: 'move', 'moveCenter', 'movePivot'\r\n    HandleMorph.uber.init.call(this);\r\n    this.color = new Color(255, 255, 255);\r\n    this.isDraggable = false;\r\n    this.noticesTransparentClick = true;\r\n    if (this.type === 'movePivot') {\r\n        size *= 2;\r\n    }\r\n    this.setExtent(new Point(size, size));\r\n};\r\n\r\n// HandleMorph drawing:\r\n\r\nHandleMorph.prototype.drawNew = function () {\r\n    this.normalImage = newCanvas(this.extent());\r\n    this.highlightImage = newCanvas(this.extent());\r\n    if (this.type === 'movePivot') {\r\n        this.drawCrosshairsOnCanvas(this.normalImage, 0.6);\r\n        this.drawCrosshairsOnCanvas(this.highlightImage, 0.5);\r\n    } else {\r\n        this.drawOnCanvas(\r\n            this.normalImage,\r\n            this.color,\r\n            new Color(100, 100, 100)\r\n        );\r\n        this.drawOnCanvas(\r\n            this.highlightImage,\r\n            new Color(100, 100, 255),\r\n            new Color(255, 255, 255)\r\n        );\r\n    }\r\n    this.image = this.normalImage;\r\n    if (this.target) {\r\n        if (this.type === 'moveCenter') {\r\n            this.setCenter(this.target.center());\r\n        } else if (this.type === 'movePivot') {\r\n            this.setCenter(this.target.rotationCenter());\r\n        } else { // 'resize', 'move'\r\n            this.setPosition(\r\n                this.target.bottomRight().subtract(\r\n                    this.extent().add(this.inset)\r\n                )\r\n            );\r\n        }\r\n        this.target.add(this);\r\n        this.target.changed();\r\n    }\r\n};\r\n\r\nHandleMorph.prototype.drawCrosshairsOnCanvas = function (aCanvas, fract) {\r\n    var ctx = aCanvas.getContext('2d'),\r\n        r = aCanvas.width / 2;\r\n    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';\r\n    ctx.arc(r, r, r * 0.9, radians(0), radians(360), false);\r\n    ctx.fill();\r\n    ctx.strokeStyle = 'black';\r\n    ctx.lineWidth = 1;\r\n    ctx.beginPath();\r\n    ctx.arc(r, r, r * fract, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n    ctx.moveTo(0, r);\r\n    ctx.lineTo(aCanvas.width, r);\r\n    ctx.stroke();\r\n    ctx.moveTo(r, 0);\r\n    ctx.lineTo(r, aCanvas.height);\r\n    ctx.stroke();\r\n};\r\n\r\nHandleMorph.prototype.drawOnCanvas = function (\r\n    aCanvas,\r\n    color,\r\n    shadowColor\r\n) {\r\n    var context = aCanvas.getContext('2d'),\r\n        isSquare = (this.type.indexOf('move') === 0),\r\n        p1,\r\n        p11,\r\n        p2,\r\n        p22,\r\n        i;\r\n\r\n    context.lineWidth = 1;\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = color.toString();\r\n\r\n    if (isSquare) {\r\n\r\n        p1 = this.bottomLeft().subtract(this.position());\r\n        p11 = p1.copy();\r\n        p2 = this.topRight().subtract(this.position());\r\n        p22 = p2.copy();\r\n\r\n        for (i = 0; i <= this.height(); i = i + 6) {\r\n            p11.y = p1.y - i;\r\n            p22.y = p2.y - i;\r\n\r\n            context.beginPath();\r\n            context.moveTo(p11.x, p11.y);\r\n            context.lineTo(p22.x, p22.y);\r\n            context.closePath();\r\n            context.stroke();\r\n        }\r\n    }\r\n\r\n    p1 = this.bottomLeft().subtract(this.position());\r\n    p11 = p1.copy();\r\n    p2 = this.topRight().subtract(this.position());\r\n    p22 = p2.copy();\r\n\r\n    for (i = 0; i <= this.width(); i = i + 6) {\r\n        p11.x = p1.x + i;\r\n        p22.x = p2.x + i;\r\n\r\n        context.beginPath();\r\n        context.moveTo(p11.x, p11.y);\r\n        context.lineTo(p22.x, p22.y);\r\n        context.closePath();\r\n        context.stroke();\r\n    }\r\n\r\n    context.strokeStyle = shadowColor.toString();\r\n\r\n    if (isSquare) {\r\n\r\n        p1 = this.bottomLeft().subtract(this.position());\r\n        p11 = p1.copy();\r\n        p2 = this.topRight().subtract(this.position());\r\n        p22 = p2.copy();\r\n\r\n        for (i = -2; i <= this.height(); i = i + 6) {\r\n            p11.y = p1.y - i;\r\n            p22.y = p2.y - i;\r\n\r\n            context.beginPath();\r\n            context.moveTo(p11.x, p11.y);\r\n            context.lineTo(p22.x, p22.y);\r\n            context.closePath();\r\n            context.stroke();\r\n        }\r\n    }\r\n\r\n    p1 = this.bottomLeft().subtract(this.position());\r\n    p11 = p1.copy();\r\n    p2 = this.topRight().subtract(this.position());\r\n    p22 = p2.copy();\r\n\r\n    for (i = 2; i <= this.width(); i = i + 6) {\r\n        p11.x = p1.x + i;\r\n        p22.x = p2.x + i;\r\n\r\n        context.beginPath();\r\n        context.moveTo(p11.x, p11.y);\r\n        context.lineTo(p22.x, p22.y);\r\n        context.closePath();\r\n        context.stroke();\r\n    }\r\n};\r\n\r\n// HandleMorph stepping:\r\n\r\nHandleMorph.prototype.step = null;\r\n\r\nHandleMorph.prototype.mouseDownLeft = function (pos) {\r\n    var world = this.root(),\r\n        offset,\r\n        myself = this;\r\n\r\n    if (!this.target) {\r\n        return null;\r\n    }\r\n    if (this.type.indexOf('move') === 0) {\r\n        offset = pos.subtract(this.center());\r\n    } else {\r\n        offset = pos.subtract(this.bounds.origin);\r\n    }\r\n    this.step = function () {\r\n        var newPos, newExt;\r\n        if (world.hand.mouseButton) {\r\n            newPos = world.hand.bounds.origin.copy().subtract(offset);\r\n            if (this.type === 'resize') {\r\n                newExt = newPos.add(\r\n                    myself.extent().add(myself.inset)\r\n                ).subtract(myself.target.bounds.origin);\r\n                newExt = newExt.max(myself.minExtent);\r\n                myself.target.setExtent(newExt);\r\n\r\n                myself.setPosition(\r\n                    myself.target.bottomRight().subtract(\r\n                        myself.extent().add(myself.inset)\r\n                    )\r\n                );\r\n            } else if (this.type === 'moveCenter') {\r\n                myself.target.setCenter(newPos);\r\n            } else if (this.type === 'movePivot') {\r\n                myself.target.setPivot(newPos);\r\n                myself.setCenter(this.target.rotationCenter());\r\n            } else { // type === 'move'\r\n                myself.target.setPosition(\r\n                    newPos.subtract(this.target.extent())\r\n                        .add(this.extent())\r\n                );\r\n            }\r\n        } else {\r\n            this.step = null;\r\n        }\r\n    };\r\n    if (!this.target.step) {\r\n        this.target.step = function () {\r\n            nop();\r\n        };\r\n    }\r\n};\r\n\r\n// HandleMorph dragging and dropping:\r\n\r\nHandleMorph.prototype.rootForGrab = function () {\r\n    return this;\r\n};\r\n\r\n// HandleMorph events:\r\n\r\nHandleMorph.prototype.mouseEnter = function () {\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n};\r\n\r\nHandleMorph.prototype.mouseLeave = function () {\r\n    this.image = this.normalImage;\r\n    this.changed();\r\n};\r\n\r\n// HandleMorph menu:\r\n\r\nHandleMorph.prototype.attach = function () {\r\n    var choices = this.overlappedMorphs(),\r\n        menu = new MenuMorph(this, 'choose target:'),\r\n        myself = this;\r\n\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each.toString().slice(0, 50), function () {\r\n            myself.isDraggable = false;\r\n            myself.target = each;\r\n            myself.drawNew();\r\n            myself.noticesTransparentClick = true;\r\n        });\r\n    });\r\n    if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\n// PenMorph ////////////////////////////////////////////////////////////\r\n\r\n// I am a simple LOGO-wise turtle.\r\n\r\n// PenMorph: referenced constructors\r\n\r\nvar PenMorph;\r\n\r\n// PenMorph inherits from Morph:\r\n\r\nPenMorph.prototype = new Morph();\r\nPenMorph.prototype.constructor = PenMorph;\r\nPenMorph.uber = Morph.prototype;\r\n\r\n// PenMorph instance creation:\r\n\r\nfunction PenMorph() {\r\n    this.init();\r\n}\r\n\r\nPenMorph.prototype.init = function () {\r\n    var size = MorphicPreferences.handleSize * 4;\r\n\r\n    // additional properties:\r\n    this.isWarped = false; // internal optimization\r\n    this.heading = 0;\r\n    this.isDown = true;\r\n    this.size = 1;\r\n    this.wantsRedraw = false;\r\n    this.penPoint = 'tip'; // or 'center\"\r\n    this.penBounds = null; // rect around the visible arrow shape\r\n\r\n    HandleMorph.uber.init.call(this);\r\n    this.setExtent(new Point(size, size));\r\n};\r\n\r\n// PenMorph updating - optimized for warping, i.e atomic recursion\r\n\r\nPenMorph.prototype.changed = function () {\r\n    if (this.isWarped === false) {\r\n        var w = this.root();\r\n        if (w instanceof WorldMorph) {\r\n            w.broken.push(this.visibleBounds().spread());\r\n        }\r\n        if (this.parent) {\r\n            this.parent.childChanged(this);\r\n        }\r\n    }\r\n};\r\n\r\n// PenMorph display:\r\n\r\nPenMorph.prototype.drawNew = function (facing) {\r\n    // my orientation can be overridden with the \"facing\" parameter to\r\n    // implement Scratch-style rotation styles\r\n\r\n    var context, start, dest, left, right, len,\r\n        direction = facing || this.heading;\r\n\r\n    if (this.isWarped) {\r\n        this.wantsRedraw = true;\r\n        return;\r\n    }\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    len = this.width() / 2;\r\n    start = this.center().subtract(this.bounds.origin);\r\n\r\n    if (this.penPoint === 'tip') {\r\n        dest = start.distanceAngle(len * 0.75, direction - 180);\r\n        left = start.distanceAngle(len, direction + 195);\r\n        right = start.distanceAngle(len, direction - 195);\r\n    } else { // 'middle'\r\n        dest = start.distanceAngle(len * 0.75, direction);\r\n        left = start.distanceAngle(len * 0.33, direction + 230);\r\n        right = start.distanceAngle(len * 0.33, direction - 230);\r\n    }\r\n\r\n    // cache penBounds\r\n    this.penBounds = new Rectangle(\r\n        Math.min(start.x, dest.x, left.x, right.x),\r\n        Math.min(start.y, dest.y, left.y, right.y),\r\n        Math.max(start.x, dest.x, left.x, right.x),\r\n        Math.max(start.y, dest.y, left.y, right.y)\r\n    );\r\n\r\n    // draw arrow shape\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n\r\n    context.moveTo(start.x, start.y);\r\n    context.lineTo(left.x, left.y);\r\n    context.lineTo(dest.x, dest.y);\r\n    context.lineTo(right.x, right.y);\r\n\r\n    context.closePath();\r\n    context.strokeStyle = 'white';\r\n    context.lineWidth = 3;\r\n    context.stroke();\r\n    context.strokeStyle = 'black';\r\n    context.lineWidth = 1;\r\n    context.stroke();\r\n    context.fill();\r\n};\r\n\r\n// PenMorph access:\r\n\r\nPenMorph.prototype.setHeading = function (degrees) {\r\n    this.heading = ((+degrees % 360) + 360) % 360;\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// PenMorph drawing:\r\n\r\nPenMorph.prototype.drawLine = function (start, dest) {\r\n    var context = this.parent.penTrails().getContext('2d'),\r\n        from = start.subtract(this.parent.bounds.origin),\r\n        to = dest.subtract(this.parent.bounds.origin);\r\n    if (this.isDown) {\r\n        context.lineWidth = this.size;\r\n        context.strokeStyle = this.color.toString();\r\n        context.lineCap = 'round';\r\n        context.lineJoin = 'round';\r\n        context.beginPath();\r\n        context.moveTo(from.x, from.y);\r\n        context.lineTo(to.x, to.y);\r\n        context.stroke();\r\n        if (this.isWarped === false) {\r\n            this.world().broken.push(\r\n                start.rectangle(dest).expandBy(\r\n                    Math.max(this.size / 2, 1)\r\n                ).intersect(this.parent.visibleBounds()).spread()\r\n            );\r\n        }\r\n    }\r\n};\r\n\r\n// PenMorph turtle ops:\r\n\r\nPenMorph.prototype.turn = function (degrees) {\r\n    this.setHeading(this.heading + parseFloat(degrees));\r\n};\r\n\r\nPenMorph.prototype.forward = function (steps) {\r\n    var start = this.center(),\r\n        dest,\r\n        dist = parseFloat(steps);\r\n    if (dist >= 0) {\r\n        dest = this.position().distanceAngle(dist, this.heading);\r\n    } else {\r\n        dest = this.position().distanceAngle(\r\n            Math.abs(dist),\r\n            (this.heading - 180)\r\n        );\r\n    }\r\n    this.setPosition(dest);\r\n    this.drawLine(start, this.center());\r\n};\r\n\r\nPenMorph.prototype.down = function () {\r\n    this.isDown = true;\r\n};\r\n\r\nPenMorph.prototype.up = function () {\r\n    this.isDown = false;\r\n};\r\n\r\nPenMorph.prototype.clear = function () {\r\n    this.parent.drawNew();\r\n    this.parent.changed();\r\n};\r\n\r\n// PenMorph optimization for atomic recursion:\r\n\r\nPenMorph.prototype.startWarp = function () {\r\n    this.wantsRedraw = false;\r\n    this.isWarped = true;\r\n};\r\n\r\nPenMorph.prototype.endWarp = function () {\r\n    this.isWarped = false;\r\n    if (this.wantsRedraw) {\r\n        this.drawNew();\r\n        this.wantsRedraw = false;\r\n    }\r\n    this.parent.changed();\r\n};\r\n\r\nPenMorph.prototype.warp = function (fun) {\r\n    this.startWarp();\r\n    fun.call(this);\r\n    this.endWarp();\r\n};\r\n\r\nPenMorph.prototype.warpOp = function (selector, argsArray) {\r\n    this.startWarp();\r\n    this[selector].apply(this, argsArray);\r\n    this.endWarp();\r\n};\r\n\r\n// PenMorph demo ops:\r\n// try these with WARP eg.: this.warp(function () {tree(12, 120, 20)})\r\n\r\nPenMorph.prototype.warpSierpinski = function (length, min) {\r\n    this.warpOp('sierpinski', [length, min]);\r\n};\r\n\r\nPenMorph.prototype.sierpinski = function (length, min) {\r\n    var i;\r\n    if (length > min) {\r\n        for (i = 0; i < 3; i += 1) {\r\n            this.sierpinski(length * 0.5, min);\r\n            this.turn(120);\r\n            this.forward(length);\r\n        }\r\n    }\r\n};\r\n\r\nPenMorph.prototype.warpTree = function (level, length, angle) {\r\n    this.warpOp('tree', [level, length, angle]);\r\n};\r\n\r\nPenMorph.prototype.tree = function (level, length, angle) {\r\n    if (level > 0) {\r\n        this.size = level;\r\n        this.forward(length);\r\n        this.turn(angle);\r\n        this.tree(level - 1, length * 0.75, angle);\r\n        this.turn(angle * -2);\r\n        this.tree(level - 1, length * 0.75, angle);\r\n        this.turn(angle);\r\n        this.forward(-length);\r\n    }\r\n};\r\n\r\n// ColorPaletteMorph ///////////////////////////////////////////////////\r\n\r\nvar ColorPaletteMorph;\r\n\r\n// ColorPaletteMorph inherits from Morph:\r\n\r\nColorPaletteMorph.prototype = new Morph();\r\nColorPaletteMorph.prototype.constructor = ColorPaletteMorph;\r\nColorPaletteMorph.uber = Morph.prototype;\r\n\r\n// ColorPaletteMorph instance creation:\r\n\r\nfunction ColorPaletteMorph(target, sizePoint) {\r\n    this.init(\r\n        target || null,\r\n        sizePoint || new Point(80, 50)\r\n    );\r\n}\r\n\r\nColorPaletteMorph.prototype.init = function (target, size) {\r\n    ColorPaletteMorph.uber.init.call(this);\r\n    this.target = target;\r\n    this.targetSetter = 'color';\r\n    this.silentSetExtent(size);\r\n    this.choice = null;\r\n    this.drawNew();\r\n};\r\n\r\nColorPaletteMorph.prototype.drawNew = function () {\r\n    var context, ext, x, y, h, l;\r\n\r\n    ext = this.extent();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    this.choice = new Color();\r\n    for (x = 0; x <= ext.x; x += 1) {\r\n        h = 360 * x / ext.x;\r\n        for (y = 0; y <= ext.y; y += 1) {\r\n            l = 100 - (y / ext.y * 100);\r\n            context.fillStyle = 'hsl(' + h + ',100%,' + l + '%)';\r\n            context.fillRect(x, y, 1, 1);\r\n        }\r\n    }\r\n};\r\n\r\nColorPaletteMorph.prototype.mouseMove = function (pos) {\r\n    this.choice = this.getPixelColor(pos);\r\n    this.updateTarget();\r\n};\r\n\r\nColorPaletteMorph.prototype.mouseDownLeft = function (pos) {\r\n    this.choice = this.getPixelColor(pos);\r\n    this.updateTarget();\r\n};\r\n\r\nColorPaletteMorph.prototype.updateTarget = function () {\r\n    if (this.target instanceof Morph && this.choice !== null) {\r\n        if (this.target[this.targetSetter] instanceof Function) {\r\n            this.target[this.targetSetter](this.choice);\r\n        } else {\r\n            this.target[this.targetSetter] = this.choice;\r\n            this.target.drawNew();\r\n            this.target.changed();\r\n        }\r\n    }\r\n};\r\n\r\n// ColorPaletteMorph menu:\r\n\r\nColorPaletteMorph.prototype.developersMenu = function () {\r\n    var menu = ColorPaletteMorph.uber.developersMenu.call(this);\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'set target',\r\n        \"setTarget\",\r\n        'choose another morph\\nwhose color property\\n will be' +\r\n            ' controlled by this one'\r\n    );\r\n    return menu;\r\n};\r\n\r\nColorPaletteMorph.prototype.setTarget = function () {\r\n    var choices = this.overlappedMorphs(),\r\n        menu = new MenuMorph(this, 'choose target:'),\r\n        myself = this;\r\n\r\n    choices.push(this.world());\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each.toString().slice(0, 50), function () {\r\n            myself.target = each;\r\n            myself.setTargetSetter();\r\n        });\r\n    });\r\n    if (choices.length === 1) {\r\n        this.target = choices[0];\r\n        this.setTargetSetter();\r\n    } else if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\nColorPaletteMorph.prototype.setTargetSetter = function () {\r\n    var choices = this.target.colorSetters(),\r\n        menu = new MenuMorph(this, 'choose target property:'),\r\n        myself = this;\r\n\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each, function () {\r\n            myself.targetSetter = each;\r\n        });\r\n    });\r\n    if (choices.length === 1) {\r\n        this.targetSetter = choices[0];\r\n    } else if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\n// GrayPaletteMorph ///////////////////////////////////////////////////\r\n\r\nvar GrayPaletteMorph;\r\n\r\n// GrayPaletteMorph inherits from ColorPaletteMorph:\r\n\r\nGrayPaletteMorph.prototype = new ColorPaletteMorph();\r\nGrayPaletteMorph.prototype.constructor = GrayPaletteMorph;\r\nGrayPaletteMorph.uber = ColorPaletteMorph.prototype;\r\n\r\n// GrayPaletteMorph instance creation:\r\n\r\nfunction GrayPaletteMorph(target, sizePoint) {\r\n    this.init(\r\n        target || null,\r\n        sizePoint || new Point(80, 10)\r\n    );\r\n}\r\n\r\nGrayPaletteMorph.prototype.drawNew = function () {\r\n    var context, ext, gradient;\r\n\r\n    ext = this.extent();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    this.choice = new Color();\r\n    gradient = context.createLinearGradient(0, 0, ext.x, ext.y);\r\n    gradient.addColorStop(0, 'black');\r\n    gradient.addColorStop(1, 'white');\r\n    context.fillStyle = gradient;\r\n    context.fillRect(0, 0, ext.x, ext.y);\r\n};\r\n\r\n// ColorPickerMorph ///////////////////////////////////////////////////\r\n\r\n// ColorPickerMorph inherits from Morph:\r\n\r\nColorPickerMorph.prototype = new Morph();\r\nColorPickerMorph.prototype.constructor = ColorPickerMorph;\r\nColorPickerMorph.uber = Morph.prototype;\r\n\r\n// ColorPickerMorph instance creation:\r\n\r\nfunction ColorPickerMorph(defaultColor) {\r\n    this.init(defaultColor || new Color(255, 255, 255));\r\n}\r\n\r\nColorPickerMorph.prototype.init = function (defaultColor) {\r\n    this.choice = defaultColor;\r\n    ColorPickerMorph.uber.init.call(this);\r\n    this.color = new Color(255, 255, 255);\r\n    this.silentSetExtent(new Point(80, 80));\r\n    this.drawNew();\r\n};\r\n\r\nColorPickerMorph.prototype.drawNew = function () {\r\n    ColorPickerMorph.uber.drawNew.call(this);\r\n    this.buildSubmorphs();\r\n};\r\n\r\nColorPickerMorph.prototype.buildSubmorphs = function () {\r\n    var cpal, gpal, x, y;\r\n\r\n    this.children.forEach(function (child) {\r\n        child.destroy();\r\n    });\r\n    this.children = [];\r\n    this.feedback = new Morph();\r\n    this.feedback.color = this.choice;\r\n    this.feedback.setExtent(new Point(20, 20));\r\n    cpal = new ColorPaletteMorph(\r\n        this.feedback,\r\n        new Point(this.width(), 50)\r\n    );\r\n    gpal = new GrayPaletteMorph(\r\n        this.feedback,\r\n        new Point(this.width(), 5)\r\n    );\r\n    cpal.setPosition(this.bounds.origin);\r\n    this.add(cpal);\r\n    gpal.setPosition(cpal.bottomLeft());\r\n    this.add(gpal);\r\n    x = (gpal.left() +\r\n        Math.floor((gpal.width() - this.feedback.width()) / 2));\r\n    y = gpal.bottom() + Math.floor((this.bottom() -\r\n        gpal.bottom() - this.feedback.height()) / 2);\r\n    this.feedback.setPosition(new Point(x, y));\r\n    this.add(this.feedback);\r\n};\r\n\r\nColorPickerMorph.prototype.getChoice = function () {\r\n    return this.feedback.color;\r\n};\r\n\r\nColorPickerMorph.prototype.rootForGrab = function () {\r\n    return this;\r\n};\r\n\r\n// BlinkerMorph ////////////////////////////////////////////////////////\r\n\r\n// can be used for text cursors\r\n\r\nvar BlinkerMorph;\r\n\r\n// BlinkerMorph inherits from Morph:\r\n\r\nBlinkerMorph.prototype = new Morph();\r\nBlinkerMorph.prototype.constructor = BlinkerMorph;\r\nBlinkerMorph.uber = Morph.prototype;\r\n\r\n// BlinkerMorph instance creation:\r\n\r\nfunction BlinkerMorph(rate) {\r\n    this.init(rate);\r\n}\r\n\r\nBlinkerMorph.prototype.init = function (rate) {\r\n    BlinkerMorph.uber.init.call(this);\r\n    this.color = new Color(0, 0, 0);\r\n    this.fps = rate || 2;\r\n    this.drawNew();\r\n};\r\n\r\n// BlinkerMorph stepping:\r\n\r\nBlinkerMorph.prototype.step = function () {\r\n    this.toggleVisibility();\r\n};\r\n\r\n// CursorMorph /////////////////////////////////////////////////////////\r\n\r\n// I am a String/Text editing widget\r\n\r\n// CursorMorph: referenced constructors\r\n\r\nvar CursorMorph;\r\n\r\n// CursorMorph inherits from BlinkerMorph:\r\n\r\nCursorMorph.prototype = new BlinkerMorph();\r\nCursorMorph.prototype.constructor = CursorMorph;\r\nCursorMorph.uber = BlinkerMorph.prototype;\r\n\r\n// CursorMorph preferences settings:\r\n\r\nCursorMorph.prototype.viewPadding = 1;\r\n\r\n// CursorMorph instance creation:\r\n\r\nfunction CursorMorph(aStringOrTextMorph) {\r\n    this.init(aStringOrTextMorph);\r\n}\r\n\r\nCursorMorph.prototype.init = function (aStringOrTextMorph) {\r\n    var ls;\r\n\r\n    // additional properties:\r\n    this.keyDownEventUsed = false;\r\n    this.target = aStringOrTextMorph;\r\n    this.originalContents = this.target.text;\r\n    this.originalAlignment = this.target.alignment;\r\n    this.slot = this.target.text.length;\r\n    CursorMorph.uber.init.call(this);\r\n    ls = fontHeight(this.target.fontSize);\r\n    this.setExtent(new Point(Math.max(Math.floor(ls / 20), 1), ls));\r\n    this.drawNew();\r\n    this.image.getContext('2d').font = this.target.font();\r\n    if (this.target instanceof TextMorph &&\r\n            (this.target.alignment !== 'left')) {\r\n        this.target.setAlignmentToLeft();\r\n    }\r\n    this.gotoSlot(this.slot);\r\n    this.initializeClipboardHandler();\r\n};\r\n\r\nCursorMorph.prototype.initializeClipboardHandler = function () {\r\n    // Add hidden text box for copying and pasting\r\n    var myself = this,\r\n        wrrld = this.target.world();\r\n\r\n    this.clipboardHandler = document.createElement('textarea');\r\n    this.clipboardHandler.style.position = 'absolute';\r\n    this.clipboardHandler.style.top = window.outerHeight;\r\n    this.clipboardHandler.style.right = '101%'; // placed just out of view\r\n\r\n    document.body.appendChild(this.clipboardHandler);\r\n\r\n    this.clipboardHandler.value = this.target.selection();\r\n    this.clipboardHandler.focus();\r\n    this.clipboardHandler.select();\r\n\r\n    this.clipboardHandler.addEventListener(\r\n        'keypress',\r\n        function (event) {\r\n            myself.processKeyPress(event);\r\n            this.value = myself.target.selection();\r\n            this.select();\r\n        },\r\n        false\r\n    );\r\n\r\n    this.clipboardHandler.addEventListener(\r\n        'keydown',\r\n        function (event) {\r\n            myself.processKeyDown(event);\r\n            if (event.shiftKey) {\r\n                wrrld.currentKey = 16;\r\n            }\r\n            this.value = myself.target.selection();\r\n            this.select();\r\n\r\n            // Make sure tab prevents default\r\n            if (event.key === 'U+0009' ||\r\n                    event.key === 'Tab') {\r\n                myself.processKeyPress(event);\r\n                event.preventDefault();\r\n            }\r\n        },\r\n        false\r\n    );\r\n\r\n    this.clipboardHandler.addEventListener(\r\n        'keyup',\r\n        function (event) {\r\n            wrrld.currentKey = null;\r\n        },\r\n        false\r\n    );\r\n\r\n    this.clipboardHandler.addEventListener(\r\n        'input',\r\n        function (event) {\r\n            if (this.value === '') {\r\n                myself.gotoSlot(myself.target.selectionStartSlot());\r\n                myself.target.deleteSelection();\r\n            }\r\n        },\r\n        false\r\n    );\r\n};\r\n\r\n// CursorMorph event processing:\r\n\r\nCursorMorph.prototype.processKeyPress = function (event) {\r\n    // this.inspectKeyEvent(event);\r\n    if (this.keyDownEventUsed) {\r\n        this.keyDownEventUsed = false;\r\n        return null;\r\n    }\r\n    if ((event.keyCode === 40) || event.charCode === 40) {\r\n        this.insert('(');\r\n        return null;\r\n    }\r\n    if ((event.keyCode === 37) || event.charCode === 37) {\r\n        this.insert('%');\r\n        return null;\r\n    }\r\n    if (event.keyCode) { // Opera doesn't support charCode\r\n        if (event.ctrlKey && (!event.altKey)) {\r\n            this.ctrl(event.keyCode, event.shiftKey);\r\n        } else if (event.metaKey) {\r\n            this.cmd(event.keyCode, event.shiftKey);\r\n        } else {\r\n            this.insert(\r\n                String.fromCharCode(event.keyCode),\r\n                event.shiftKey\r\n            );\r\n        }\r\n    } else if (event.charCode) { // all other browsers\r\n        if (event.ctrlKey && (!event.altKey)) {\r\n            this.ctrl(event.charCode, event.shiftKey);\r\n        } else if (event.metaKey) {\r\n            this.cmd(event.charCode, event.shiftKey);\r\n        } else {\r\n            this.insert(\r\n                String.fromCharCode(event.charCode),\r\n                event.shiftKey\r\n            );\r\n        }\r\n    }\r\n    // notify target's parent of key event\r\n    this.target.escalateEvent('reactToKeystroke', event);\r\n};\r\n\r\nCursorMorph.prototype.processKeyDown = function (event) {\r\n    // this.inspectKeyEvent(event);\r\n    var shift = event.shiftKey,\r\n        wordNavigation = event.ctrlKey || event.altKey,\r\n        selecting = this.target.selection().length > 0;\r\n\r\n    this.keyDownEventUsed = false;\r\n    if (event.ctrlKey && (!event.altKey)) {\r\n        this.ctrl(event.keyCode, event.shiftKey);\r\n        // notify target's parent of key event\r\n        this.target.escalateEvent('reactToKeystroke', event);\r\n    }\r\n    if (event.metaKey) {\r\n        this.cmd(event.keyCode, event.shiftKey);\r\n        // notify target's parent of key event\r\n        this.target.escalateEvent('reactToKeystroke', event);\r\n    }\r\n\r\n    switch (event.keyCode) {\r\n    case 37:\r\n        if (selecting && !shift && !wordNavigation) {\r\n            this.gotoSlot(Math.min(this.target.startMark, this.target.endMark));\r\n            this.target.clearSelection();\r\n        } else {\r\n            this.goLeft(\r\n                    shift,\r\n                    wordNavigation ?\r\n                        this.slot - this.target.previousWordFrom(this.slot)\r\n                        : 1);\r\n        }\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 39:\r\n        if (selecting && !shift && !wordNavigation) {\r\n            this.gotoSlot(Math.max(this.target.startMark, this.target.endMark));\r\n            this.target.clearSelection();\r\n        } else {\r\n            this.goRight(\r\n                    shift,\r\n                    wordNavigation ?\r\n                        this.target.nextWordFrom(this.slot) - this.slot\r\n                        : 1);\r\n        }\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 38:\r\n        this.goUp(shift);\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 40:\r\n        this.goDown(shift);\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 36:\r\n        this.goHome(shift);\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 35:\r\n        this.goEnd(shift);\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 46:\r\n        this.deleteRight();\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 8:\r\n        this.deleteLeft();\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 13:\r\n        if ((this.target instanceof StringMorph) || shift) {\r\n            this.accept();\r\n        } else {\r\n            this.insert('\\n');\r\n        }\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    case 27:\r\n        this.cancel();\r\n        this.keyDownEventUsed = true;\r\n        break;\r\n    default:\r\n        nop();\r\n        // this.inspectKeyEvent(event);\r\n    }\r\n    // notify target's parent of key event\r\n    this.target.escalateEvent('reactToKeystroke', event);\r\n};\r\n\r\n// CursorMorph navigation:\r\n\r\n/*\r\n// original non-scrolling code, commented out in case we need to fall back:\r\n\r\nCursorMorph.prototype.gotoSlot = function (newSlot) {\r\n    this.setPosition(this.target.slotPosition(newSlot));\r\n    this.slot = Math.max(newSlot, 0);\r\n};\r\n*/\r\n\r\nCursorMorph.prototype.gotoSlot = function (slot) {\r\n    var length = this.target.text.length,\r\n        pos = this.target.slotPosition(slot),\r\n        right,\r\n        left;\r\n    this.slot = slot < 0 ? 0 : slot > length ? length : slot;\r\n    if (this.parent && this.target.isScrollable) {\r\n        right = this.parent.right() - this.viewPadding;\r\n        left = this.parent.left() + this.viewPadding;\r\n        if (pos.x > right) {\r\n            this.target.setLeft(this.target.left() + right - pos.x);\r\n            pos.x = right;\r\n        }\r\n        if (pos.x < left) {\r\n            left = Math.min(this.parent.left(), left);\r\n            this.target.setLeft(this.target.left() + left - pos.x);\r\n            pos.x = left;\r\n        }\r\n        if (this.target.right() < right &&\r\n                right - this.target.width() < left) {\r\n            pos.x += right - this.target.right();\r\n            this.target.setRight(right);\r\n        }\r\n    }\r\n    this.show();\r\n    this.setPosition(pos);\r\n    if (this.parent\r\n            && this.parent.parent instanceof ScrollFrameMorph\r\n            && this.target.isScrollable) {\r\n        this.parent.parent.scrollCursorIntoView(this);\r\n    }\r\n};\r\n\r\nCursorMorph.prototype.goLeft = function (shift, howMany) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.slot - (howMany || 1));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.goRight = function (shift, howMany) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.slot + (howMany || 1));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.goUp = function (shift) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.target.upFrom(this.slot));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.goDown = function (shift) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.target.downFrom(this.slot));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.goHome = function (shift) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.target.startOfLine(this.slot));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.goEnd = function (shift) {\r\n    this.updateSelection(shift);\r\n    this.gotoSlot(this.target.endOfLine(this.slot));\r\n    this.updateSelection(shift);\r\n};\r\n\r\nCursorMorph.prototype.gotoPos = function (aPoint) {\r\n    this.gotoSlot(this.target.slotAt(aPoint));\r\n    this.show();\r\n};\r\n\r\n// CursorMorph selecting:\r\n\r\nCursorMorph.prototype.updateSelection = function (shift) {\r\n    if (shift) {\r\n        if (isNil(this.target.endMark) && isNil(this.target.startMark)) {\r\n            this.target.startMark = this.slot;\r\n            this.target.endMark = this.slot;\r\n        } else if (this.target.endMark !== this.slot) {\r\n            this.target.endMark = this.slot;\r\n            this.target.drawNew();\r\n            this.target.changed();\r\n        }\r\n    } else {\r\n        this.target.clearSelection();\r\n    }\r\n};\r\n\r\n// CursorMorph editing:\r\n\r\nCursorMorph.prototype.accept = function () {\r\n    var world = this.root();\r\n    if (world) {\r\n        world.stopEditing();\r\n    }\r\n    this.escalateEvent('accept', this);\r\n};\r\n\r\nCursorMorph.prototype.cancel = function () {\r\n    var world = this.root();\r\n    this.undo();\r\n    if (world) {\r\n        world.stopEditing();\r\n    }\r\n    this.escalateEvent('cancel', this);\r\n};\r\n\r\nCursorMorph.prototype.undo = function () {\r\n    this.target.text = this.originalContents;\r\n    this.target.changed();\r\n    this.target.drawNew();\r\n    this.target.changed();\r\n    this.gotoSlot(0);\r\n};\r\n\r\nCursorMorph.prototype.insert = function (aChar, shiftKey) {\r\n    var text;\r\n    if (aChar === '\\u0009') {\r\n        this.target.escalateEvent('reactToEdit', this.target);\r\n        if (shiftKey) {\r\n            return this.target.backTab(this.target);\r\n        }\r\n        return this.target.tab(this.target);\r\n    }\r\n    if (!this.target.isNumeric ||\r\n            !isNaN(parseFloat(aChar)) ||\r\n            contains(['-', '.'], aChar)) {\r\n        if (this.target.selection() !== '') {\r\n            this.gotoSlot(this.target.selectionStartSlot());\r\n            this.target.deleteSelection();\r\n        }\r\n        text = this.target.text;\r\n        text = text.slice(0, this.slot) +\r\n            aChar +\r\n            text.slice(this.slot);\r\n        this.target.text = text;\r\n        this.target.drawNew();\r\n        this.target.changed();\r\n        this.goRight(false, aChar.length);\r\n    }\r\n};\r\n\r\nCursorMorph.prototype.ctrl = function (aChar, shiftKey) {\r\n    if (aChar === 64 || (aChar === 65 && shiftKey)) {\r\n        this.insert('@');\r\n    } else if (aChar === 65) {\r\n        this.target.selectAll();\r\n    } else if (aChar === 90) {\r\n        this.undo();\r\n    } else if (aChar === 123) {\r\n        this.insert('{');\r\n    } else if (aChar === 125) {\r\n        this.insert('}');\r\n    } else if (aChar === 91) {\r\n        this.insert('[');\r\n    } else if (aChar === 93) {\r\n        this.insert(']');\r\n    } else if (!isNil(this.target.receiver)) {\r\n        if (aChar === 68) {\r\n            this.target.doIt();\r\n        } else if (aChar === 73) {\r\n            this.target.inspectIt();\r\n        } else if (aChar === 80) {\r\n            this.target.showIt();\r\n        }\r\n    }\r\n\r\n\r\n};\r\n\r\nCursorMorph.prototype.cmd = function (aChar, shiftKey) {\r\n    if (aChar === 64 || (aChar === 65 && shiftKey)) {\r\n        this.insert('@');\r\n    } else if (aChar === 65) {\r\n        this.target.selectAll();\r\n    } else if (aChar === 90) {\r\n        this.undo();\r\n    } else if (!isNil(this.target.receiver)) {\r\n        if (aChar === 68) {\r\n            this.target.doIt();\r\n        } else if (aChar === 73) {\r\n            this.target.inspectIt();\r\n        } else if (aChar === 80) {\r\n            this.target.showIt();\r\n        }\r\n    }\r\n};\r\n\r\nCursorMorph.prototype.deleteRight = function () {\r\n    var text;\r\n    if (this.target.selection() !== '') {\r\n        this.gotoSlot(this.target.selectionStartSlot());\r\n        this.target.deleteSelection();\r\n    } else {\r\n        text = this.target.text;\r\n        this.target.changed();\r\n        text = text.slice(0, this.slot) + text.slice(this.slot + 1);\r\n        this.target.text = text;\r\n        this.target.drawNew();\r\n    }\r\n};\r\n\r\nCursorMorph.prototype.deleteLeft = function () {\r\n    var text;\r\n    if (this.target.selection()) {\r\n        this.gotoSlot(this.target.selectionStartSlot());\r\n        return this.target.deleteSelection();\r\n    }\r\n    text = this.target.text;\r\n    this.target.changed();\r\n    this.target.text = text.substring(0, this.slot - 1) +\r\n        text.substr(this.slot);\r\n    this.target.drawNew();\r\n    this.goLeft();\r\n};\r\n\r\n// CursorMorph destroying:\r\n\r\nCursorMorph.prototype.destroy = function () {\r\n    if (this.target.alignment !== this.originalAlignment) {\r\n        this.target.alignment = this.originalAlignment;\r\n        this.target.drawNew();\r\n        this.target.changed();\r\n    }\r\n    this.destroyClipboardHandler();\r\n    CursorMorph.uber.destroy.call(this);\r\n};\r\n\r\nCursorMorph.prototype.destroyClipboardHandler = function () {\r\n    var nodes = document.body.children,\r\n        each,\r\n        i;\r\n    if (this.clipboardHandler) {\r\n        for (i = 0; i < nodes.length; i += 1) {\r\n            each = nodes[i];\r\n            if (each === this.clipboardHandler) {\r\n                document.body.removeChild(this.clipboardHandler);\r\n                this.clipboardHandler = null;\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// CursorMorph utilities:\r\n\r\nCursorMorph.prototype.inspectKeyEvent = function (event) {\r\n    // private\r\n    this.inform(\r\n        'Key pressed: ' +\r\n            String.fromCharCode(event.charCode) +\r\n            '\\n------------------------' +\r\n            '\\ncharCode: ' +\r\n            event.charCode.toString() +\r\n            '\\nkeyCode: ' +\r\n            event.keyCode.toString() +\r\n            '\\nshiftKey: ' +\r\n            event.shiftKey.toString() +\r\n            '\\naltKey: ' +\r\n            event.altKey.toString() +\r\n            '\\nctrlKey: ' +\r\n            event.ctrlKey.toString() +\r\n            '\\ncmdKey: ' +\r\n            event.metaKey.toString()\r\n    );\r\n};\r\n\r\n// BoxMorph ////////////////////////////////////////////////////////////\r\n\r\n// I can have an optionally rounded border\r\n\r\nvar BoxMorph;\r\n\r\n// BoxMorph inherits from Morph:\r\n\r\nBoxMorph.prototype = new Morph();\r\nBoxMorph.prototype.constructor = BoxMorph;\r\nBoxMorph.uber = Morph.prototype;\r\n\r\n// BoxMorph instance creation:\r\n\r\nfunction BoxMorph(edge, border, borderColor) {\r\n    this.init(edge, border, borderColor);\r\n}\r\n\r\nBoxMorph.prototype.init = function (edge, border, borderColor) {\r\n    this.edge = edge || 4;\r\n    this.border = border || ((border === 0) ? 0 : 2);\r\n    this.borderColor = borderColor || new Color();\r\n    BoxMorph.uber.init.call(this);\r\n};\r\n\r\n// BoxMorph drawing:\r\n\r\nBoxMorph.prototype.drawNew = function () {\r\n    var context;\r\n\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if ((this.edge === 0) && (this.border === 0)) {\r\n        BoxMorph.uber.drawNew.call(this);\r\n        return null;\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        Math.max(this.edge - this.border, 0),\r\n        this.border\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n    if (this.border > 0) {\r\n        context.lineWidth = this.border;\r\n        context.strokeStyle = this.borderColor.toString();\r\n        context.beginPath();\r\n        this.outlinePath(context, this.edge, this.border / 2);\r\n        context.closePath();\r\n        context.stroke();\r\n    }\r\n};\r\n\r\nBoxMorph.prototype.outlinePath = function (context, radius, inset) {\r\n    var offset = radius + inset,\r\n        w = this.width(),\r\n        h = this.height();\r\n\r\n    // top left:\r\n    context.arc(\r\n        offset,\r\n        offset,\r\n        radius,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    // top right:\r\n    context.arc(\r\n        w - offset,\r\n        offset,\r\n        radius,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n    // bottom right:\r\n    context.arc(\r\n        w - offset,\r\n        h - offset,\r\n        radius,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    // bottom left:\r\n    context.arc(\r\n        offset,\r\n        h - offset,\r\n        radius,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n};\r\n\r\n\r\n// BoxMorph menus:\r\n\r\nBoxMorph.prototype.developersMenu = function () {\r\n    var menu = BoxMorph.uber.developersMenu.call(this);\r\n    menu.addLine();\r\n    menu.addItem(\r\n        \"border width...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nborder\\nwidth:',\r\n                this.setBorderWidth,\r\n                this,\r\n                this.border.toString(),\r\n                null,\r\n                0,\r\n                100,\r\n                true\r\n            );\r\n        },\r\n        'set the border\\'s\\nline size'\r\n    );\r\n    menu.addItem(\r\n        \"border color...\",\r\n        function () {\r\n            this.pickColor(\r\n                menu.title + '\\nborder color:',\r\n                this.setBorderColor,\r\n                this,\r\n                this.borderColor\r\n            );\r\n        },\r\n        'set the border\\'s\\nline color'\r\n    );\r\n    menu.addItem(\r\n        \"corner size...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\ncorner\\nsize:',\r\n                this.setCornerSize,\r\n                this,\r\n                this.edge.toString(),\r\n                null,\r\n                0,\r\n                100,\r\n                true\r\n            );\r\n        },\r\n        'set the corner\\'s\\nradius'\r\n    );\r\n    return menu;\r\n};\r\n\r\nBoxMorph.prototype.setBorderWidth = function (size) {\r\n    // for context menu demo purposes\r\n    var newSize;\r\n    if (typeof size === 'number') {\r\n        this.border = Math.max(size, 0);\r\n    } else {\r\n        newSize = parseFloat(size);\r\n        if (!isNaN(newSize)) {\r\n            this.border = Math.max(newSize, 0);\r\n        }\r\n    }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nBoxMorph.prototype.setBorderColor = function (color) {\r\n    // for context menu demo purposes\r\n    if (color) {\r\n        this.borderColor = color;\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nBoxMorph.prototype.setCornerSize = function (size) {\r\n    // for context menu demo purposes\r\n    var newSize;\r\n    if (typeof size === 'number') {\r\n        this.edge = Math.max(size, 0);\r\n    } else {\r\n        newSize = parseFloat(size);\r\n        if (!isNaN(newSize)) {\r\n            this.edge = Math.max(newSize, 0);\r\n        }\r\n    }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nBoxMorph.prototype.colorSetters = function () {\r\n    // for context menu demo purposes\r\n    return ['color', 'borderColor'];\r\n};\r\n\r\nBoxMorph.prototype.numericalSetters = function () {\r\n    // for context menu demo purposes\r\n    var list = BoxMorph.uber.numericalSetters.call(this);\r\n    list.push('setBorderWidth', 'setCornerSize');\r\n    return list;\r\n};\r\n\r\n// SpeechBubbleMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a comic-style speech bubble that can display either a string,\r\n    a Morph, a Canvas or a toString() representation of anything else.\r\n    If I am invoked using popUp() I behave like a tool tip.\r\n*/\r\n\r\n// SpeechBubbleMorph: referenced constructors\r\n\r\nvar SpeechBubbleMorph;\r\n\r\n// SpeechBubbleMorph inherits from BoxMorph:\r\n\r\nSpeechBubbleMorph.prototype = new BoxMorph();\r\nSpeechBubbleMorph.prototype.constructor = SpeechBubbleMorph;\r\nSpeechBubbleMorph.uber = BoxMorph.prototype;\r\n\r\n// SpeechBubbleMorph instance creation:\r\n\r\nfunction SpeechBubbleMorph(\r\n    contents,\r\n    color,\r\n    edge,\r\n    border,\r\n    borderColor,\r\n    padding,\r\n    isThought\r\n) {\r\n    this.init(contents, color, edge, border, borderColor, padding, isThought);\r\n}\r\n\r\nSpeechBubbleMorph.prototype.init = function (\r\n    contents,\r\n    color,\r\n    edge,\r\n    border,\r\n    borderColor,\r\n    padding,\r\n    isThought // bool or anything but \"true\" to draw no hook at all\r\n) {\r\n    this.isPointingRight = true; // orientation of text\r\n    this.contents = contents || '';\r\n    this.padding = padding || 0; // additional vertical pixels\r\n    this.isThought = isThought || false; // draw \"think\" bubble\r\n    this.isClickable = false;\r\n    SpeechBubbleMorph.uber.init.call(\r\n        this,\r\n        edge || 6,\r\n        border || ((border === 0) ? 0 : 1),\r\n        borderColor || new Color(140, 140, 140)\r\n    );\r\n    this.color = color || new Color(230, 230, 230);\r\n    this.drawNew();\r\n};\r\n\r\n// SpeechBubbleMorph invoking:\r\n\r\nSpeechBubbleMorph.prototype.popUp = function (world, pos, isClickable) {\r\n    this.drawNew();\r\n    this.setPosition(pos.subtract(new Point(0, this.height())));\r\n    this.addShadow(new Point(2, 2), 80);\r\n    this.keepWithin(world);\r\n    world.add(this);\r\n    this.fullChanged();\r\n    world.hand.destroyTemporaries();\r\n    world.hand.temporaries.push(this);\r\n\r\n    if (!isClickable) {\r\n        this.mouseEnter = function () {\r\n            this.destroy();\r\n        };\r\n    } else {\r\n        this.isClickable = true;\r\n    }\r\n};\r\n\r\n// SpeechBubbleMorph drawing:\r\n\r\nSpeechBubbleMorph.prototype.drawNew = function () {\r\n    // re-build my contents\r\n    if (this.contentsMorph) {\r\n        this.contentsMorph.destroy();\r\n    }\r\n    if (this.contents instanceof Morph) {\r\n        this.contentsMorph = this.contents;\r\n    } else if (isString(this.contents)) {\r\n        this.contentsMorph = new TextMorph(\r\n            this.contents,\r\n            MorphicPreferences.bubbleHelpFontSize,\r\n            null,\r\n            false,\r\n            true,\r\n            'center'\r\n        );\r\n    } else if (this.contents instanceof HTMLCanvasElement) {\r\n        this.contentsMorph = new Morph();\r\n        this.contentsMorph.silentSetWidth(this.contents.width);\r\n        this.contentsMorph.silentSetHeight(this.contents.height);\r\n        this.contentsMorph.image = this.contents;\r\n    } else {\r\n        this.contentsMorph = new TextMorph(\r\n            this.contents.toString(),\r\n            MorphicPreferences.bubbleHelpFontSize,\r\n            null,\r\n            false,\r\n            true,\r\n            'center'\r\n        );\r\n    }\r\n    this.add(this.contentsMorph);\r\n\r\n    // adjust my layout\r\n    this.silentSetWidth(this.contentsMorph.width() +\r\n        (this.padding ? this.padding * 2 : this.edge * 2));\r\n    this.silentSetHeight(this.contentsMorph.height() +\r\n        this.edge +\r\n        this.border * 2 +\r\n        this.padding * 2 +\r\n        2);\r\n\r\n    // draw my outline\r\n    SpeechBubbleMorph.uber.drawNew.call(this);\r\n\r\n    // position my contents\r\n    this.contentsMorph.setPosition(this.position().add(\r\n        new Point(\r\n            this.padding || this.edge,\r\n            this.border + this.padding + 1\r\n        )\r\n    ));\r\n};\r\n\r\nSpeechBubbleMorph.prototype.outlinePath = function (\r\n    context,\r\n    radius,\r\n    inset\r\n) {\r\n    var offset = radius + inset,\r\n        w = this.width(),\r\n        h = this.height(),\r\n        rad;\r\n\r\n    function circle(x, y, r) {\r\n        context.moveTo(x + r, y);\r\n        context.arc(x, y, r, radians(0), radians(360));\r\n    }\r\n\r\n    // top left:\r\n    context.arc(\r\n        offset,\r\n        offset,\r\n        radius,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    // top right:\r\n    context.arc(\r\n        w - offset,\r\n        offset,\r\n        radius,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n    // bottom right:\r\n    context.arc(\r\n        w - offset,\r\n        h - offset - radius,\r\n        radius,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    if (!this.isThought) { // draw speech bubble hook\r\n        if (this.isPointingRight) {\r\n            context.lineTo(\r\n                offset + radius,\r\n                h - offset\r\n            );\r\n            context.lineTo(\r\n                radius / 2 + inset,\r\n                h - inset\r\n            );\r\n        } else { // pointing left\r\n            context.lineTo(\r\n                w - (radius / 2 + inset),\r\n                h - inset\r\n            );\r\n            context.lineTo(\r\n                w - (offset + radius),\r\n                h - offset\r\n            );\r\n        }\r\n    }\r\n    // bottom left:\r\n    context.arc(\r\n        offset,\r\n        h - offset - radius,\r\n        radius,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n    if (this.isThought === true) { // use anything but \"true\" to draw nothing\r\n        // close large bubble:\r\n        context.lineTo(\r\n            inset,\r\n            offset\r\n        );\r\n        // draw thought bubbles:\r\n        if (this.isPointingRight) {\r\n            // tip bubble:\r\n            rad = radius / 4;\r\n            circle(rad + inset, h - rad - inset, rad);\r\n            // middle bubble:\r\n            rad = radius / 3.2;\r\n            circle(rad * 2 + inset, h - rad - inset * 2, rad);\r\n            // top bubble:\r\n            rad = radius / 2.8;\r\n            circle(rad * 3 + inset * 2, h - rad - inset * 4, rad);\r\n        } else { // pointing left\r\n            // tip bubble:\r\n            rad = radius / 4;\r\n            circle(w - (rad + inset), h - rad - inset, rad);\r\n            // middle bubble:\r\n            rad = radius / 3.2;\r\n            circle(w - (rad * 2 + inset), h - rad - inset * 2, rad);\r\n            // top bubble:\r\n            rad = radius / 2.8;\r\n            circle(w - (rad * 3 + inset * 2), h - rad - inset * 4, rad);\r\n        }\r\n    }\r\n};\r\n\r\n// SpeechBubbleMorph shadow\r\n\r\n/*\r\n    only take the 'plain' image, so the box rounding and the\r\n    shadow doesn't become conflicted by embedded scrolling panes\r\n*/\r\n\r\nSpeechBubbleMorph.prototype.shadowImage = function (off, color) {\r\n    // fallback for Windows Chrome-Shadow bug\r\n    var fb, img, outline, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.extent();\r\n    img = this.image;\r\n    outline = newCanvas(fb);\r\n    ctx = outline.getContext('2d');\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        -offset.x,\r\n        -offset.y\r\n    );\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.drawImage(outline, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = clr.toString();\r\n    ctx.fillRect(0, 0, fb.x, fb.y);\r\n    return sha;\r\n};\r\n\r\nSpeechBubbleMorph.prototype.shadowImageBlurred = function (off, color) {\r\n    var fb, img, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        blur = this.shadowBlur,\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.extent().add(blur * 2);\r\n    img = this.image;\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.shadowOffsetX = offset.x;\r\n    ctx.shadowOffsetY = offset.y;\r\n    ctx.shadowBlur = blur;\r\n    ctx.shadowColor = clr.toString();\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    ctx.shadowOffsetX = 0;\r\n    ctx.shadowOffsetY = 0;\r\n    ctx.shadowBlur = 0;\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    return sha;\r\n};\r\n\r\n// SpeechBubbleMorph resizing\r\n\r\nSpeechBubbleMorph.prototype.fixLayout = function () {\r\n    this.removeShadow();\r\n    this.drawNew();\r\n    this.addShadow(new Point(2, 2), 80);\r\n};\r\n\r\n// CircleBoxMorph //////////////////////////////////////////////////////\r\n\r\n// I can be used for sliders\r\n\r\nvar CircleBoxMorph;\r\n\r\n// CircleBoxMorph inherits from Morph:\r\n\r\nCircleBoxMorph.prototype = new Morph();\r\nCircleBoxMorph.prototype.constructor = CircleBoxMorph;\r\nCircleBoxMorph.uber = Morph.prototype;\r\n\r\nfunction CircleBoxMorph(orientation) {\r\n    this.init(orientation || 'vertical');\r\n}\r\n\r\nCircleBoxMorph.prototype.init = function (orientation) {\r\n    CircleBoxMorph.uber.init.call(this);\r\n    this.orientation = orientation;\r\n    this.autoOrient = true;\r\n    this.setExtent(new Point(20, 100));\r\n};\r\n\r\nCircleBoxMorph.prototype.autoOrientation = function () {\r\n    if (this.height() > this.width()) {\r\n        this.orientation = 'vertical';\r\n    } else {\r\n        this.orientation = 'horizontal';\r\n    }\r\n};\r\n\r\nCircleBoxMorph.prototype.drawNew = function () {\r\n    var radius, center1, center2, rect, points, x, y,\r\n        context, ext,\r\n        myself = this;\r\n\r\n    if (this.autoOrient) {\r\n        this.autoOrientation();\r\n    }\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n\r\n    if (this.orientation === 'vertical') {\r\n        radius = this.width() / 2;\r\n        x = this.center().x;\r\n        center1 = new Point(x, this.top() + radius);\r\n        center2 = new Point(x, this.bottom() - radius);\r\n        rect = this.bounds.origin.add(new Point(0, radius)).corner(\r\n            this.bounds.corner.subtract(new Point(0, radius))\r\n        );\r\n    } else {\r\n        radius = this.height() / 2;\r\n        y = this.center().y;\r\n        center1 = new Point(this.left() + radius, y);\r\n        center2 = new Point(this.right() - radius, y);\r\n        rect = this.bounds.origin.add(new Point(radius, 0)).corner(\r\n            this.bounds.corner.subtract(new Point(radius, 0))\r\n        );\r\n    }\r\n    points = [ center1.subtract(this.bounds.origin),\r\n        center2.subtract(this.bounds.origin)];\r\n    points.forEach(function (center) {\r\n        context.fillStyle = myself.color.toString();\r\n        context.beginPath();\r\n        context.arc(\r\n            center.x,\r\n            center.y,\r\n            radius,\r\n            0,\r\n            2 * Math.PI,\r\n            false\r\n        );\r\n        context.closePath();\r\n        context.fill();\r\n    });\r\n    rect = rect.translateBy(this.bounds.origin.neg());\r\n    ext = rect.extent();\r\n    if (ext.x > 0 && ext.y > 0) {\r\n        context.fillRect(\r\n            rect.origin.x,\r\n            rect.origin.y,\r\n            rect.width(),\r\n            rect.height()\r\n        );\r\n    }\r\n};\r\n\r\n// CircleBoxMorph menu:\r\n\r\nCircleBoxMorph.prototype.developersMenu = function () {\r\n    var menu = CircleBoxMorph.uber.developersMenu.call(this);\r\n    menu.addLine();\r\n    if (this.orientation === 'vertical') {\r\n        menu.addItem(\r\n            \"horizontal...\",\r\n            'toggleOrientation',\r\n            'toggle the\\norientation'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            \"vertical...\",\r\n            'toggleOrientation',\r\n            'toggle the\\norientation'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\nCircleBoxMorph.prototype.toggleOrientation = function () {\r\n    var center = this.center();\r\n    this.changed();\r\n    if (this.orientation === 'vertical') {\r\n        this.orientation = 'horizontal';\r\n    } else {\r\n        this.orientation = 'vertical';\r\n    }\r\n    this.silentSetExtent(new Point(this.height(), this.width()));\r\n    this.setCenter(center);\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// SliderButtonMorph ///////////////////////////////////////////////////\r\n\r\nvar SliderButtonMorph;\r\n\r\n// SliderButtonMorph inherits from CircleBoxMorph:\r\n\r\nSliderButtonMorph.prototype = new CircleBoxMorph();\r\nSliderButtonMorph.prototype.constructor = SliderButtonMorph;\r\nSliderButtonMorph.uber = CircleBoxMorph.prototype;\r\n\r\nfunction SliderButtonMorph(orientation) {\r\n    this.init(orientation);\r\n}\r\n\r\nSliderButtonMorph.prototype.init = function (orientation) {\r\n    this.color = new Color(80, 80, 80);\r\n    this.highlightColor = new Color(90, 90, 140);\r\n    this.pressColor = new Color(80, 80, 160);\r\n    this.is3D = false;\r\n    this.hasMiddleDip = true;\r\n    SliderButtonMorph.uber.init.call(this, orientation);\r\n};\r\n\r\nSliderButtonMorph.prototype.autoOrientation = nop;\r\n\r\nSliderButtonMorph.prototype.drawNew = function () {\r\n    var colorBak = this.color.copy();\r\n\r\n    SliderButtonMorph.uber.drawNew.call(this);\r\n    if (this.is3D || !MorphicPreferences.isFlat) {\r\n        this.drawEdges();\r\n    }\r\n    this.normalImage = this.image;\r\n\r\n    this.color = this.highlightColor.copy();\r\n    SliderButtonMorph.uber.drawNew.call(this);\r\n    if (this.is3D || !MorphicPreferences.isFlat) {\r\n        this.drawEdges();\r\n    }\r\n    this.highlightImage = this.image;\r\n\r\n    this.color = this.pressColor.copy();\r\n    SliderButtonMorph.uber.drawNew.call(this);\r\n    if (this.is3D || !MorphicPreferences.isFlat) {\r\n        this.drawEdges();\r\n    }\r\n    this.pressImage = this.image;\r\n\r\n    this.color = colorBak;\r\n    this.image = this.normalImage;\r\n\r\n};\r\n\r\nSliderButtonMorph.prototype.drawEdges = function () {\r\n    var context = this.image.getContext('2d'),\r\n        gradient,\r\n        radius,\r\n        w = this.width(),\r\n        h = this.height();\r\n\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    if (this.orientation === 'vertical') {\r\n        context.lineWidth = w / 3;\r\n        gradient = context.createLinearGradient(\r\n            0,\r\n            0,\r\n            context.lineWidth,\r\n            0\r\n        );\r\n        gradient.addColorStop(0, 'white');\r\n        gradient.addColorStop(1, this.color.toString());\r\n\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        context.moveTo(context.lineWidth * 0.5, w / 2);\r\n        context.lineTo(context.lineWidth * 0.5, h - w / 2);\r\n        context.stroke();\r\n\r\n        gradient = context.createLinearGradient(\r\n            w - context.lineWidth,\r\n            0,\r\n            w,\r\n            0\r\n        );\r\n        gradient.addColorStop(0, this.color.toString());\r\n        gradient.addColorStop(1, 'black');\r\n\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        context.moveTo(w - context.lineWidth * 0.5, w / 2);\r\n        context.lineTo(w - context.lineWidth * 0.5, h - w / 2);\r\n        context.stroke();\r\n\r\n        if (this.hasMiddleDip) {\r\n            gradient = context.createLinearGradient(\r\n                context.lineWidth,\r\n                0,\r\n                w - context.lineWidth,\r\n                0\r\n            );\r\n\r\n            radius = w / 4;\r\n            gradient.addColorStop(0, 'black');\r\n            gradient.addColorStop(0.35, this.color.toString());\r\n            gradient.addColorStop(0.65, this.color.toString());\r\n            gradient.addColorStop(1, 'white');\r\n\r\n            context.fillStyle = gradient;\r\n            context.beginPath();\r\n            context.arc(\r\n                w / 2,\r\n                h / 2,\r\n                radius,\r\n                radians(0),\r\n                radians(360),\r\n                false\r\n            );\r\n            context.closePath();\r\n            context.fill();\r\n        }\r\n    } else if (this.orientation === 'horizontal') {\r\n        context.lineWidth = h / 3;\r\n        gradient = context.createLinearGradient(\r\n            0,\r\n            0,\r\n            0,\r\n            context.lineWidth\r\n        );\r\n        gradient.addColorStop(0, 'white');\r\n        gradient.addColorStop(1, this.color.toString());\r\n\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        context.moveTo(h / 2, context.lineWidth * 0.5);\r\n        context.lineTo(w - h / 2, context.lineWidth * 0.5);\r\n        context.stroke();\r\n\r\n        gradient = context.createLinearGradient(\r\n            0,\r\n            h - context.lineWidth,\r\n            0,\r\n            h\r\n        );\r\n        gradient.addColorStop(0, this.color.toString());\r\n        gradient.addColorStop(1, 'black');\r\n\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        context.moveTo(h / 2, h - context.lineWidth * 0.5);\r\n        context.lineTo(w - h / 2, h - context.lineWidth * 0.5);\r\n        context.stroke();\r\n\r\n        if (this.hasMiddleDip) {\r\n            gradient = context.createLinearGradient(\r\n                0,\r\n                context.lineWidth,\r\n                0,\r\n                h - context.lineWidth\r\n            );\r\n\r\n            radius = h / 4;\r\n            gradient.addColorStop(0, 'black');\r\n            gradient.addColorStop(0.35, this.color.toString());\r\n            gradient.addColorStop(0.65, this.color.toString());\r\n            gradient.addColorStop(1, 'white');\r\n\r\n            context.fillStyle = gradient;\r\n            context.beginPath();\r\n            context.arc(\r\n                this.width() / 2,\r\n                this.height() / 2,\r\n                radius,\r\n                radians(0),\r\n                radians(360),\r\n                false\r\n            );\r\n            context.closePath();\r\n            context.fill();\r\n        }\r\n    }\r\n};\r\n\r\n//SliderButtonMorph events:\r\n\r\nSliderButtonMorph.prototype.mouseEnter = function () {\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n};\r\n\r\nSliderButtonMorph.prototype.mouseLeave = function () {\r\n    this.image = this.normalImage;\r\n    this.changed();\r\n};\r\n\r\nSliderButtonMorph.prototype.mouseDownLeft = function (pos) {\r\n    this.image = this.pressImage;\r\n    this.changed();\r\n    this.escalateEvent('mouseDownLeft', pos);\r\n};\r\n\r\nSliderButtonMorph.prototype.mouseClickLeft = function () {\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n};\r\n\r\nSliderButtonMorph.prototype.mouseMove = function () {\r\n    // prevent my parent from getting picked up\r\n    nop();\r\n};\r\n\r\n// SliderMorph ///////////////////////////////////////////////////\r\n\r\n// SliderMorph inherits from CircleBoxMorph:\r\n\r\nSliderMorph.prototype = new CircleBoxMorph();\r\nSliderMorph.prototype.constructor = SliderMorph;\r\nSliderMorph.uber = CircleBoxMorph.prototype;\r\n\r\nfunction SliderMorph(start, stop, value, size, orientation, color) {\r\n    this.init(\r\n        start || 1,\r\n        stop || 100,\r\n        value || 50,\r\n        size || 10,\r\n        orientation || 'vertical',\r\n        color\r\n    );\r\n}\r\n\r\nSliderMorph.prototype.init = function (\r\n    start,\r\n    stop,\r\n    value,\r\n    size,\r\n    orientation,\r\n    color\r\n) {\r\n    this.target = null;\r\n    this.action = null;\r\n    this.start = start;\r\n    this.stop = stop;\r\n    this.value = value;\r\n    this.size = size;\r\n    this.offset = null;\r\n    this.button = new SliderButtonMorph();\r\n    this.button.isDraggable = false;\r\n    this.button.color = new Color(200, 200, 200);\r\n    this.button.highlightColor = new Color(210, 210, 255);\r\n    this.button.pressColor = new Color(180, 180, 255);\r\n    SliderMorph.uber.init.call(this, orientation);\r\n    this.add(this.button);\r\n    this.alpha = 0.3;\r\n    this.color = color || new Color(0, 0, 0);\r\n    this.setExtent(new Point(20, 100));\r\n    // this.drawNew();\r\n};\r\n\r\nSliderMorph.prototype.autoOrientation = nop;\r\n\r\nSliderMorph.prototype.rangeSize = function () {\r\n    return this.stop - this.start;\r\n};\r\n\r\nSliderMorph.prototype.ratio = function () {\r\n    return this.size / (this.rangeSize() + 1);\r\n};\r\n\r\nSliderMorph.prototype.unitSize = function () {\r\n    if (this.orientation === 'vertical') {\r\n        return (this.height() - this.button.height()) /\r\n            this.rangeSize();\r\n    }\r\n    return (this.width() - this.button.width()) /\r\n        this.rangeSize();\r\n};\r\n\r\nSliderMorph.prototype.drawNew = function () {\r\n    var bw, bh, posX, posY;\r\n\r\n    SliderMorph.uber.drawNew.call(this);\r\n    this.button.orientation = this.orientation;\r\n    if (this.orientation === 'vertical') {\r\n        bw  = this.width() - 2;\r\n        bh = Math.max(bw, Math.round(this.height() * this.ratio()));\r\n        this.button.silentSetExtent(new Point(bw, bh));\r\n        posX = 1;\r\n        posY = Math.min(\r\n            Math.round((this.value - this.start) * this.unitSize()),\r\n            this.height() - this.button.height()\r\n        );\r\n    } else {\r\n        bh = this.height() - 2;\r\n        bw  = Math.max(bh, Math.round(this.width() * this.ratio()));\r\n        this.button.silentSetExtent(new Point(bw, bh));\r\n        posY = 1;\r\n        posX = Math.min(\r\n            Math.round((this.value - this.start) * this.unitSize()),\r\n            this.width() - this.button.width()\r\n        );\r\n    }\r\n    this.button.setPosition(\r\n        new Point(posX, posY).add(this.bounds.origin)\r\n    );\r\n    this.button.drawNew();\r\n    this.button.changed();\r\n};\r\n\r\nSliderMorph.prototype.updateValue = function () {\r\n    var relPos;\r\n    if (this.orientation === 'vertical') {\r\n        relPos = this.button.top() - this.top();\r\n    } else {\r\n        relPos = this.button.left() - this.left();\r\n    }\r\n    this.value = Math.round(relPos / this.unitSize() + this.start);\r\n    this.updateTarget();\r\n};\r\n\r\nSliderMorph.prototype.updateTarget = function () {\r\n    if (this.action) {\r\n        if (typeof this.action === 'function') {\r\n            this.action.call(this.target, this.value);\r\n        } else { // assume it's a String\r\n            this.target[this.action](this.value);\r\n        }\r\n    }\r\n};\r\n\r\n// SliderMorph menu:\r\n\r\nSliderMorph.prototype.developersMenu = function () {\r\n    var menu = SliderMorph.uber.developersMenu.call(this);\r\n    menu.addItem(\r\n        \"show value...\",\r\n        'showValue',\r\n        'display a dialog box\\nshowing the selected number'\r\n    );\r\n    menu.addItem(\r\n        \"floor...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nfloor:',\r\n                this.setStart,\r\n                this,\r\n                this.start.toString(),\r\n                null,\r\n                0,\r\n                this.stop - this.size,\r\n                true\r\n            );\r\n        },\r\n        'set the minimum value\\nwhich can be selected'\r\n    );\r\n    menu.addItem(\r\n        \"ceiling...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nceiling:',\r\n                this.setStop,\r\n                this,\r\n                this.stop.toString(),\r\n                null,\r\n                this.start + this.size,\r\n                this.size * 100,\r\n                true\r\n            );\r\n        },\r\n        'set the maximum value\\nwhich can be selected'\r\n    );\r\n    menu.addItem(\r\n        \"button size...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nbutton size:',\r\n                this.setSize,\r\n                this,\r\n                this.size.toString(),\r\n                null,\r\n                1,\r\n                this.stop - this.start,\r\n                true\r\n            );\r\n        },\r\n        'set the range\\ncovered by\\nthe slider button'\r\n    );\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'set target',\r\n        \"setTarget\",\r\n        'select another morph\\nwhose numerical property\\nwill be ' +\r\n            'controlled by this one'\r\n    );\r\n    return menu;\r\n};\r\n\r\nSliderMorph.prototype.showValue = function () {\r\n    this.inform(this.value);\r\n};\r\n\r\nSliderMorph.prototype.userSetStart = function (num) {\r\n    // for context menu demo purposes\r\n    this.start = Math.max(num, this.stop);\r\n};\r\n\r\nSliderMorph.prototype.setStart = function (num, noUpdate) {\r\n    // for context menu demo purposes\r\n    var newStart;\r\n    if (typeof num === 'number') {\r\n        this.start = Math.min(\r\n            num,\r\n            this.stop - this.size\r\n        );\r\n    } else {\r\n        newStart = parseFloat(num);\r\n        if (!isNaN(newStart)) {\r\n            this.start = Math.min(\r\n                newStart,\r\n                this.stop - this.size\r\n            );\r\n        }\r\n    }\r\n    this.value = Math.max(this.value, this.start);\r\n    if (!noUpdate) {this.updateTarget(); }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nSliderMorph.prototype.setStop = function (num, noUpdate) {\r\n    // for context menu demo purposes\r\n    var newStop;\r\n    if (typeof num === 'number') {\r\n        this.stop = Math.max(num, this.start + this.size);\r\n    } else {\r\n        newStop = parseFloat(num);\r\n        if (!isNaN(newStop)) {\r\n            this.stop = Math.max(newStop, this.start + this.size);\r\n        }\r\n    }\r\n    this.value = Math.min(this.value, this.stop);\r\n    if (!noUpdate) {this.updateTarget(); }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nSliderMorph.prototype.setSize = function (num, noUpdate) {\r\n    // for context menu demo purposes\r\n    var newSize;\r\n    if (typeof num === 'number') {\r\n        this.size = Math.min(\r\n            Math.max(num, 1),\r\n            this.stop - this.start\r\n        );\r\n    } else {\r\n        newSize = parseFloat(num);\r\n        if (!isNaN(newSize)) {\r\n            this.size = Math.min(\r\n                Math.max(newSize, 1),\r\n                this.stop - this.start\r\n            );\r\n        }\r\n    }\r\n    this.value = Math.min(this.value, this.stop - this.size);\r\n    if (!noUpdate) {this.updateTarget(); }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nSliderMorph.prototype.setTarget = function () {\r\n    var choices = this.overlappedMorphs(),\r\n        menu = new MenuMorph(this, 'choose target:'),\r\n        myself = this;\r\n\r\n    choices.push(this.world());\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each.toString().slice(0, 50), function () {\r\n            myself.target = each;\r\n            myself.setTargetSetter();\r\n        });\r\n    });\r\n    if (choices.length === 1) {\r\n        this.target = choices[0];\r\n        this.setTargetSetter();\r\n    } else if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\nSliderMorph.prototype.setTargetSetter = function () {\r\n    var choices = this.target.numericalSetters(),\r\n        menu = new MenuMorph(this, 'choose target property:'),\r\n        myself = this;\r\n\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each, function () {\r\n            myself.action = each;\r\n        });\r\n    });\r\n    if (choices.length === 1) {\r\n        this.action = choices[0];\r\n    } else if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\nSliderMorph.prototype.numericalSetters = function () {\r\n    // for context menu demo purposes\r\n    var list = SliderMorph.uber.numericalSetters.call(this);\r\n    list.push('setStart', 'setStop', 'setSize');\r\n    return list;\r\n};\r\n\r\n// SliderMorph stepping:\r\n\r\nSliderMorph.prototype.step = null;\r\n\r\nSliderMorph.prototype.mouseDownLeft = function (pos) {\r\n    var world, myself = this;\r\n\r\n    if (!this.button.bounds.containsPoint(pos)) {\r\n        this.offset = new Point(); // return null;\r\n    } else {\r\n        this.offset = pos.subtract(this.button.bounds.origin);\r\n    }\r\n    world = this.root();\r\n    this.step = function () {\r\n        var mousePos, newX, newY;\r\n        if (world.hand.mouseButton) {\r\n            mousePos = world.hand.bounds.origin;\r\n            if (myself.orientation === 'vertical') {\r\n                newX = myself.button.bounds.origin.x;\r\n                newY = Math.max(\r\n                    Math.min(\r\n                        mousePos.y - myself.offset.y,\r\n                        myself.bottom() - myself.button.height()\r\n                    ),\r\n                    myself.top()\r\n                );\r\n            } else {\r\n                newY = myself.button.bounds.origin.y;\r\n                newX = Math.max(\r\n                    Math.min(\r\n                        mousePos.x - myself.offset.x,\r\n                        myself.right() - myself.button.width()\r\n                    ),\r\n                    myself.left()\r\n                );\r\n            }\r\n            myself.button.setPosition(new Point(newX, newY));\r\n            myself.updateValue();\r\n        } else {\r\n            this.step = null;\r\n        }\r\n    };\r\n};\r\n\r\n// MouseSensorMorph ////////////////////////////////////////////////////\r\n\r\n// for demo and debuggin purposes only, to be removed later\r\n\r\nvar MouseSensorMorph;\r\n\r\n// MouseSensorMorph inherits from BoxMorph:\r\n\r\nMouseSensorMorph.prototype = new BoxMorph();\r\nMouseSensorMorph.prototype.constructor = MouseSensorMorph;\r\nMouseSensorMorph.uber = BoxMorph.prototype;\r\n\r\n// MouseSensorMorph instance creation:\r\n\r\nfunction MouseSensorMorph(edge, border, borderColor) {\r\n    this.init(edge, border, borderColor);\r\n}\r\n\r\nMouseSensorMorph.prototype.init = function (edge, border, borderColor) {\r\n    MouseSensorMorph.uber.init.call(this);\r\n    this.edge = edge || 4;\r\n    this.border = border || 2;\r\n    this.color = new Color(255, 255, 255);\r\n    this.borderColor = borderColor || new Color();\r\n    this.isTouched = false;\r\n    this.upStep = 0.05;\r\n    this.downStep = 0.02;\r\n    this.noticesTransparentClick = false;\r\n    this.drawNew();\r\n};\r\n\r\nMouseSensorMorph.prototype.touch = function () {\r\n    var myself = this;\r\n    if (!this.isTouched) {\r\n        this.isTouched = true;\r\n        this.alpha = 0.6;\r\n\r\n        this.step = function () {\r\n            if (myself.isTouched) {\r\n                if (myself.alpha < 1) {\r\n                    myself.alpha = myself.alpha + myself.upStep;\r\n                }\r\n            } else if (myself.alpha > (myself.downStep)) {\r\n                myself.alpha = myself.alpha - myself.downStep;\r\n            } else {\r\n                myself.alpha = 0;\r\n                myself.step = null;\r\n            }\r\n            myself.changed();\r\n        };\r\n    }\r\n};\r\n\r\nMouseSensorMorph.prototype.unTouch = function () {\r\n    this.isTouched = false;\r\n};\r\n\r\nMouseSensorMorph.prototype.mouseEnter = function () {\r\n    this.touch();\r\n};\r\n\r\nMouseSensorMorph.prototype.mouseLeave = function () {\r\n    this.unTouch();\r\n};\r\n\r\nMouseSensorMorph.prototype.mouseDownLeft = function () {\r\n    this.touch();\r\n};\r\n\r\nMouseSensorMorph.prototype.mouseClickLeft = function () {\r\n    this.unTouch();\r\n};\r\n\r\n// InspectorMorph //////////////////////////////////////////////////////\r\n\r\n// InspectorMorph: referenced constructors\r\n\r\nvar ListMorph;\r\nvar TriggerMorph;\r\n\r\n// InspectorMorph inherits from BoxMorph:\r\n\r\nInspectorMorph.prototype = new BoxMorph();\r\nInspectorMorph.prototype.constructor = InspectorMorph;\r\nInspectorMorph.uber = BoxMorph.prototype;\r\n\r\n// InspectorMorph instance creation:\r\n\r\nfunction InspectorMorph(target) {\r\n    this.init(target);\r\n}\r\n\r\nInspectorMorph.prototype.init = function (target) {\r\n    // additional properties:\r\n    this.target = target;\r\n    this.currentProperty = null;\r\n    this.showing = 'attributes';\r\n    this.markOwnProperties = false;\r\n    this.hasUserEditedDetails = false;\r\n\r\n    // initialize inherited properties:\r\n    InspectorMorph.uber.init.call(this);\r\n\r\n    // override inherited properties:\r\n    this.silentSetExtent(\r\n        new Point(\r\n            MorphicPreferences.handleSize * 20,\r\n            MorphicPreferences.handleSize * 20 * 2 / 3\r\n        )\r\n    );\r\n    this.isDraggable = true;\r\n    this.border = 1;\r\n    this.edge = MorphicPreferences.isFlat ? 1 : 5;\r\n    this.color = new Color(60, 60, 60);\r\n    this.borderColor = new Color(95, 95, 95);\r\n    this.fps = 25;\r\n    this.drawNew();\r\n\r\n    // panes:\r\n    this.label = null;\r\n    this.list = null;\r\n    this.detail = null;\r\n    this.work = null;\r\n    this.buttonInspect = null;\r\n    this.buttonClose = null;\r\n    this.buttonSubset = null;\r\n    this.buttonEdit = null;\r\n    this.resizer = null;\r\n\r\n    if (this.target) {\r\n        this.buildPanes();\r\n    }\r\n};\r\n\r\nInspectorMorph.prototype.setTarget = function (target) {\r\n    this.target = target;\r\n    this.currentProperty = null;\r\n    this.buildPanes();\r\n};\r\n\r\nInspectorMorph.prototype.updateCurrentSelection = function () {\r\n    var val, txt, cnts,\r\n        sel = this.list.selected,\r\n        currentTxt = this.detail.contents.children[0],\r\n        root = this.root();\r\n\r\n    if (root &&\r\n            (root.keyboardReceiver instanceof CursorMorph) &&\r\n            (root.keyboardReceiver.target === currentTxt)) {\r\n        this.hasUserEditedDetails = true;\r\n        return;\r\n    }\r\n    if (isNil(sel) || this.hasUserEditedDetails) {return; }\r\n    val = this.target[sel];\r\n    this.currentProperty = val;\r\n    if (isNil(val)) {\r\n        txt = 'NULL';\r\n    } else if (isString(val)) {\r\n        txt = val;\r\n    } else {\r\n        txt = val.toString();\r\n    }\r\n    if (currentTxt.text === txt) {return; }\r\n    cnts = new TextMorph(txt);\r\n    cnts.isEditable = true;\r\n    cnts.enableSelecting();\r\n    cnts.setReceiver(this.target);\r\n    this.detail.setContents(cnts);\r\n};\r\n\r\nInspectorMorph.prototype.buildPanes = function () {\r\n    var attribs = [], property, myself = this, ctrl, ev, doubleClickAction;\r\n\r\n    // remove existing panes\r\n    this.children.forEach(function (m) {\r\n        if (m !== this.work) { // keep work pane around\r\n            m.destroy();\r\n        }\r\n    });\r\n    this.children = [];\r\n\r\n    // label\r\n    this.label = new TextMorph(this.target.toString());\r\n    this.label.fontSize = MorphicPreferences.menuFontSize;\r\n    this.label.isBold = true;\r\n    this.label.color = new Color(255, 255, 255);\r\n    this.label.drawNew();\r\n    this.add(this.label);\r\n\r\n    // properties list\r\n    for (property in this.target) {\r\n        if (property) { // dummy condition, to be refined\r\n            attribs.push(property);\r\n        }\r\n    }\r\n    if (this.showing === 'attributes') {\r\n        attribs = attribs.filter(function (prop) {\r\n            return typeof myself.target[prop] !== 'function';\r\n        });\r\n    } else if (this.showing === 'methods') {\r\n        attribs = attribs.filter(function (prop) {\r\n            return typeof myself.target[prop] === 'function';\r\n        });\r\n    } // otherwise show all properties\r\n\r\n    doubleClickAction = function () {\r\n        var world, inspector;\r\n        if (!isObject(myself.currentProperty)) {return; }\r\n        world = myself.world();\r\n        inspector = new InspectorMorph(\r\n            myself.currentProperty\r\n        );\r\n        inspector.setPosition(world.hand.position());\r\n        inspector.keepWithin(world);\r\n        world.add(inspector);\r\n        inspector.changed();\r\n    };\r\n\r\n    this.list = new ListMorph(\r\n        this.target instanceof Array ? attribs : attribs.sort(),\r\n        null, // label getter\r\n        this.markOwnProperties ?\r\n                [ // format list\r\n                    [ // format element: [color, predicate(element]\r\n                        new Color(0, 0, 180),\r\n                        function (element) {\r\n                            return Object.prototype.hasOwnProperty.call(\r\n                                myself.target,\r\n                                element\r\n                            );\r\n                        }\r\n                    ]\r\n                ]\r\n                : null,\r\n        doubleClickAction\r\n    );\r\n\r\n    this.list.action = function () {\r\n        myself.hasUserEditedDetails = false;\r\n        myself.updateCurrentSelection();\r\n    };\r\n\r\n    this.list.hBar.alpha = 0.6;\r\n    this.list.vBar.alpha = 0.6;\r\n    this.list.contents.step = null;\r\n    this.add(this.list);\r\n\r\n    // details pane\r\n    this.detail = new ScrollFrameMorph();\r\n    this.detail.acceptsDrops = false;\r\n    this.detail.contents.acceptsDrops = false;\r\n    this.detail.isTextLineWrapping = true;\r\n    this.detail.color = new Color(255, 255, 255);\r\n    this.detail.hBar.alpha = 0.6;\r\n    this.detail.vBar.alpha = 0.6;\r\n    ctrl = new TextMorph('');\r\n    ctrl.isEditable = true;\r\n    ctrl.enableSelecting();\r\n    ctrl.setReceiver(this.target);\r\n    this.detail.setContents(ctrl);\r\n    this.add(this.detail);\r\n\r\n    // work ('evaluation') pane\r\n    // don't refresh the work pane if it already exists\r\n    if (this.work === null) {\r\n        this.work = new ScrollFrameMorph();\r\n        this.work.acceptsDrops = false;\r\n        this.work.contents.acceptsDrops = false;\r\n        this.work.isTextLineWrapping = true;\r\n        this.work.color = new Color(255, 255, 255);\r\n        this.work.hBar.alpha = 0.6;\r\n        this.work.vBar.alpha = 0.6;\r\n        ev = new TextMorph('');\r\n        ev.isEditable = true;\r\n        ev.enableSelecting();\r\n        ev.setReceiver(this.target);\r\n        this.work.setContents(ev);\r\n    }\r\n    this.add(this.work);\r\n\r\n    // properties button\r\n    this.buttonSubset = new TriggerMorph();\r\n    this.buttonSubset.labelString = 'show...';\r\n    this.buttonSubset.action = function () {\r\n        var menu;\r\n        menu = new MenuMorph();\r\n        menu.addItem(\r\n            'attributes',\r\n            function () {\r\n                myself.showing = 'attributes';\r\n                myself.buildPanes();\r\n            }\r\n        );\r\n        menu.addItem(\r\n            'methods',\r\n            function () {\r\n                myself.showing = 'methods';\r\n                myself.buildPanes();\r\n            }\r\n        );\r\n        menu.addItem(\r\n            'all',\r\n            function () {\r\n                myself.showing = 'all';\r\n                myself.buildPanes();\r\n            }\r\n        );\r\n        menu.addLine();\r\n        menu.addItem(\r\n            (myself.markOwnProperties ?\r\n                    'un-mark own' : 'mark own'),\r\n            function () {\r\n                myself.markOwnProperties = !myself.markOwnProperties;\r\n                myself.buildPanes();\r\n            },\r\n            'highlight\\n\\'own\\' properties'\r\n        );\r\n        menu.popUpAtHand(myself.world());\r\n    };\r\n    this.add(this.buttonSubset);\r\n\r\n    // inspect button\r\n    this.buttonInspect = new TriggerMorph();\r\n    this.buttonInspect.labelString = 'inspect...';\r\n    this.buttonInspect.action = function () {\r\n        var menu, world, inspector;\r\n        if (isObject(myself.currentProperty)) {\r\n            menu = new MenuMorph();\r\n            menu.addItem(\r\n                'in new inspector...',\r\n                function () {\r\n                    world = myself.world();\r\n                    inspector = new InspectorMorph(\r\n                        myself.currentProperty\r\n                    );\r\n                    inspector.setPosition(world.hand.position());\r\n                    inspector.keepWithin(world);\r\n                    world.add(inspector);\r\n                    inspector.changed();\r\n                }\r\n            );\r\n            menu.addItem(\r\n                'here...',\r\n                function () {\r\n                    myself.setTarget(myself.currentProperty);\r\n                }\r\n            );\r\n            menu.popUpAtHand(myself.world());\r\n        } else {\r\n            myself.inform(\r\n                (myself.currentProperty === null ?\r\n                        'null' : typeof myself.currentProperty) +\r\n                            '\\nis not inspectable'\r\n            );\r\n        }\r\n    };\r\n    this.add(this.buttonInspect);\r\n\r\n    // edit button\r\n\r\n    this.buttonEdit = new TriggerMorph();\r\n    this.buttonEdit.labelString = 'edit...';\r\n    this.buttonEdit.action = function () {\r\n        var menu;\r\n        menu = new MenuMorph(myself);\r\n        menu.addItem(\"save\", 'save', 'accept changes');\r\n        menu.addLine();\r\n        menu.addItem(\"add property...\", 'addProperty');\r\n        menu.addItem(\"rename...\", 'renameProperty');\r\n        menu.addItem(\"remove...\", 'removeProperty');\r\n        menu.popUpAtHand(myself.world());\r\n    };\r\n    this.add(this.buttonEdit);\r\n\r\n    // close button\r\n    this.buttonClose = new TriggerMorph();\r\n    this.buttonClose.labelString = 'close';\r\n    this.buttonClose.action = function () {\r\n        myself.destroy();\r\n    };\r\n    this.add(this.buttonClose);\r\n\r\n    // resizer\r\n    this.resizer = new HandleMorph(\r\n        this,\r\n        150,\r\n        100,\r\n        this.edge,\r\n        this.edge\r\n    );\r\n\r\n    // update layout\r\n    this.fixLayout();\r\n};\r\n\r\nInspectorMorph.prototype.fixLayout = function () {\r\n    var x, y, r, b, w, h;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    // label\r\n    x = this.left() + this.edge;\r\n    y = this.top() + this.edge;\r\n    r = this.right() - this.edge;\r\n    w = r - x;\r\n    this.label.setPosition(new Point(x, y));\r\n    this.label.setWidth(w);\r\n    if (this.label.height() > (this.height() - 50)) {\r\n        this.silentSetHeight(this.label.height() + 50);\r\n        this.drawNew();\r\n        this.changed();\r\n        this.resizer.drawNew();\r\n    }\r\n\r\n    // list\r\n    y = this.label.bottom() + 2;\r\n    w = Math.min(\r\n        Math.floor(this.width() / 3),\r\n        this.list.listContents.width()\r\n    );\r\n\r\n    w -= this.edge;\r\n    b = this.bottom() - (2 * this.edge) -\r\n        MorphicPreferences.handleSize;\r\n    h = b - y;\r\n    this.list.setPosition(new Point(x, y));\r\n    this.list.setExtent(new Point(w, h));\r\n\r\n    // detail\r\n    x = this.list.right() + this.edge;\r\n    r = this.right() - this.edge;\r\n    w = r - x;\r\n    this.detail.setPosition(new Point(x, y));\r\n    this.detail.setExtent(new Point(w, (h * 2 / 3) - this.edge));\r\n\r\n    // work\r\n    y = this.detail.bottom() + this.edge;\r\n    this.work.setPosition(new Point(x, y));\r\n    this.work.setExtent(new Point(w, h / 3));\r\n\r\n    // properties button\r\n    x = this.list.left();\r\n    y = this.list.bottom() + this.edge;\r\n    w = this.list.width();\r\n    h = MorphicPreferences.handleSize;\r\n    this.buttonSubset.setPosition(new Point(x, y));\r\n    this.buttonSubset.setExtent(new Point(w, h));\r\n\r\n    // inspect button\r\n    x = this.detail.left();\r\n    w = this.detail.width() - this.edge -\r\n        MorphicPreferences.handleSize;\r\n    w = w / 3 - this.edge / 3;\r\n    this.buttonInspect.setPosition(new Point(x, y));\r\n    this.buttonInspect.setExtent(new Point(w, h));\r\n\r\n    // edit button\r\n    x = this.buttonInspect.right() + this.edge;\r\n    this.buttonEdit.setPosition(new Point(x, y));\r\n    this.buttonEdit.setExtent(new Point(w, h));\r\n\r\n    // close button\r\n    x = this.buttonEdit.right() + this.edge;\r\n    r = this.detail.right() - this.edge -\r\n        MorphicPreferences.handleSize;\r\n    w = r - x;\r\n    this.buttonClose.setPosition(new Point(x, y));\r\n    this.buttonClose.setExtent(new Point(w, h));\r\n\r\n    Morph.prototype.trackChanges = true;\r\n    this.changed();\r\n\r\n};\r\n\r\nInspectorMorph.prototype.setExtent = function (aPoint) {\r\n    InspectorMorph.uber.setExtent.call(this, aPoint);\r\n    this.fixLayout();\r\n};\r\n\r\n// InspectorMorph editing ops:\r\n\r\nInspectorMorph.prototype.save = function () {\r\n    var txt = this.detail.contents.children[0].text.toString(),\r\n        prop = this.list.selected;\r\n    try {\r\n        // this.target[prop] = evaluate(txt);\r\n        this.target.evaluateString('this.' + prop + ' = ' + txt);\r\n        this.hasUserEditedDetails = false;\r\n        if (this.target.drawNew) {\r\n            this.target.changed();\r\n            this.target.drawNew();\r\n            this.target.changed();\r\n        }\r\n    } catch (err) {\r\n        this.inform(err);\r\n    }\r\n};\r\n\r\nInspectorMorph.prototype.addProperty = function () {\r\n    var myself = this;\r\n    this.prompt(\r\n        'new property name:',\r\n        function (prop) {\r\n            if (prop) {\r\n                myself.target[prop] = null;\r\n                myself.buildPanes();\r\n                if (myself.target.drawNew) {\r\n                    myself.target.changed();\r\n                    myself.target.drawNew();\r\n                    myself.target.changed();\r\n                }\r\n            }\r\n        },\r\n        this,\r\n        'property' // Chrome cannot handle empty strings (others do)\r\n    );\r\n};\r\n\r\nInspectorMorph.prototype.renameProperty = function () {\r\n    var myself = this,\r\n        propertyName = this.list.selected;\r\n    this.prompt(\r\n        'property name:',\r\n        function (prop) {\r\n            try {\r\n                delete (myself.target[propertyName]);\r\n                myself.target[prop] = myself.currentProperty;\r\n            } catch (err) {\r\n                myself.inform(err);\r\n            }\r\n            myself.buildPanes();\r\n            if (myself.target.drawNew) {\r\n                myself.target.changed();\r\n                myself.target.drawNew();\r\n                myself.target.changed();\r\n            }\r\n        },\r\n        this,\r\n        propertyName\r\n    );\r\n};\r\n\r\nInspectorMorph.prototype.removeProperty = function () {\r\n    var prop = this.list.selected;\r\n    try {\r\n        delete (this.target[prop]);\r\n        this.currentProperty = null;\r\n        this.buildPanes();\r\n        if (this.target.drawNew) {\r\n            this.target.changed();\r\n            this.target.drawNew();\r\n            this.target.changed();\r\n        }\r\n    } catch (err) {\r\n        this.inform(err);\r\n    }\r\n};\r\n\r\n// InspectorMorph stepping\r\n\r\nInspectorMorph.prototype.step = function () {\r\n    this.updateCurrentSelection();\r\n    var lbl = this.target.toString();\r\n    if (this.label.text === lbl) {return; }\r\n    this.label.text = lbl;\r\n    this.label.drawNew();\r\n    this.fixLayout();\r\n};\r\n\r\n// InspectorMorph duplicating:\r\n\r\nInspectorMorph.prototype.updateReferences = function (map) {\r\n    var active = this.list.activeIndex();\r\n    InspectorMorph.uber.updateReferences.call(this, map);\r\n    this.buildPanes();\r\n    this.list.activateIndex(active);\r\n};\r\n\r\n// MenuMorph ///////////////////////////////////////////////////////////\r\n\r\n// MenuMorph: referenced constructors\r\n\r\nvar MenuItemMorph;\r\n\r\n// MenuMorph inherits from BoxMorph:\r\n\r\nMenuMorph.prototype = new BoxMorph();\r\nMenuMorph.prototype.constructor = MenuMorph;\r\nMenuMorph.uber = BoxMorph.prototype;\r\n\r\n// MenuMorph instance creation:\r\n\r\nfunction MenuMorph(target, title, environment, fontSize) {\r\n    this.init(target, title, environment, fontSize);\r\n\r\n    /*\r\n    if target is a function, use it as callback:\r\n    execute target as callback function with the action property\r\n    of the triggered MenuItem as argument.\r\n    Use the environment, if it is specified.\r\n    Note: if action is also a function, instead of becoming\r\n    the argument itself it will be called to answer the argument.\r\n    For selections, Yes/No Choices etc.\r\n\r\n    else (if target is not a function):\r\n\r\n        if action is a function:\r\n        execute the action with target as environment (can be null)\r\n        for lambdafied (inline) actions\r\n\r\n        else if action is a String:\r\n        treat it as function property of target and execute it\r\n        for selector-like actions\r\n    */\r\n}\r\n\r\nMenuMorph.prototype.init = function (target, title, environment, fontSize) {\r\n    // additional properties:\r\n    this.target = target;\r\n    this.title = title || null;\r\n    this.environment = environment || null;\r\n    this.fontSize = fontSize || null;\r\n    this.items = [];\r\n    this.label = null;\r\n    this.world = null;\r\n    this.isListContents = false;\r\n    this.hasFocus = false;\r\n    this.selection = null;\r\n    this.submenu = null;\r\n\r\n    // initialize inherited properties:\r\n    MenuMorph.uber.init.call(this);\r\n\r\n    // override inherited properties:\r\n    this.isDraggable = false;\r\n\r\n    // immutable properties:\r\n    this.border = null;\r\n    this.edge = null;\r\n};\r\n\r\nMenuMorph.prototype.addItem = function (\r\n    labelString,\r\n    action,\r\n    hint,\r\n    color,\r\n    bold, // bool\r\n    italic, // bool\r\n    doubleClickAction, // optional, when used as list contents\r\n    shortcut // optional string, icon (Morph or Canvas) or tuple [icon, string]\r\n) {\r\n    /*\r\n    labelString is normally a single-line string. But it can also be one\r\n    of the following:\r\n\r\n        * a multi-line string (containing line breaks)\r\n        * an icon (either a Morph or a Canvas)\r\n        * a tuple of format: [icon, string]\r\n    */\r\n    this.items.push([\r\n        localize(labelString || 'close'),\r\n        action || nop,\r\n        hint,\r\n        color,\r\n        bold || false,\r\n        italic || false,\r\n        doubleClickAction,\r\n        shortcut]);\r\n};\r\n\r\nMenuMorph.prototype.addMenu = function (label, aMenu, indicator) {\r\n    this.addPair(label, aMenu, isNil(indicator) ? '\\u25ba' : indicator);\r\n};\r\n\r\nMenuMorph.prototype.addPair = function (label, action, shortcut, hint) {\r\n    this.addItem(label, action, hint, null, null, null, null, shortcut);\r\n};\r\n\r\nMenuMorph.prototype.addLine = function (width) {\r\n    this.items.push([0, width || 1]);\r\n};\r\n\r\nMenuMorph.prototype.createLabel = function () {\r\n    var text;\r\n    if (this.label !== null) {\r\n        this.label.destroy();\r\n    }\r\n    text = new TextMorph(\r\n        localize(this.title),\r\n        this.fontSize || MorphicPreferences.menuFontSize,\r\n        MorphicPreferences.menuFontName,\r\n        true,\r\n        false,\r\n        'center'\r\n    );\r\n    text.alignment = 'center';\r\n    text.color = new Color(255, 255, 255);\r\n    text.backgroundColor = this.borderColor;\r\n    text.drawNew();\r\n    this.label = new BoxMorph(3, 0);\r\n    if (MorphicPreferences.isFlat) {\r\n        this.label.edge = 0;\r\n    }\r\n    this.label.color = this.borderColor;\r\n    this.label.borderColor = this.borderColor;\r\n    this.label.setExtent(text.extent().add(4));\r\n    this.label.drawNew();\r\n    this.label.add(text);\r\n    this.label.text = text;\r\n};\r\n\r\nMenuMorph.prototype.drawNew = function () {\r\n    var myself = this,\r\n        item,\r\n        fb,\r\n        x,\r\n        y,\r\n        isLine = false;\r\n\r\n    this.children.forEach(function (m) {\r\n        m.destroy();\r\n    });\r\n    this.children = [];\r\n    if (!this.isListContents) {\r\n        this.edge = MorphicPreferences.isFlat ? 0 : 5;\r\n        this.border = MorphicPreferences.isFlat ? 1 : 2;\r\n    }\r\n    this.color = new Color(255, 255, 255);\r\n    this.borderColor = new Color(60, 60, 60);\r\n    this.silentSetExtent(new Point(0, 0));\r\n\r\n    y = 2;\r\n    x = this.left() + 4;\r\n    if (!this.isListContents) {\r\n        if (this.title) {\r\n            this.createLabel();\r\n            this.label.setPosition(this.bounds.origin.add(4));\r\n            this.add(this.label);\r\n            y = this.label.bottom();\r\n        } else {\r\n            y = this.top() + 4;\r\n        }\r\n    }\r\n    y += 1;\r\n    this.items.forEach(function (tuple) {\r\n        isLine = false;\r\n        if (tuple instanceof StringFieldMorph ||\r\n                tuple instanceof ColorPickerMorph ||\r\n                tuple instanceof SliderMorph) {\r\n            item = tuple;\r\n        } else if (tuple[0] === 0) {\r\n            isLine = true;\r\n            item = new Morph();\r\n            item.color = myself.borderColor;\r\n            item.setHeight(tuple[1]);\r\n        } else {\r\n            item = new MenuItemMorph(\r\n                myself.target,\r\n                tuple[1],\r\n                tuple[0],\r\n                myself.fontSize || MorphicPreferences.menuFontSize,\r\n                MorphicPreferences.menuFontName,\r\n                myself.environment,\r\n                tuple[2], // bubble help hint\r\n                tuple[3], // color\r\n                tuple[4], // bold\r\n                tuple[5], // italic\r\n                tuple[6], // doubleclick action\r\n                tuple[7] // shortcut\r\n            );\r\n        }\r\n        if (isLine) {\r\n            y += 1;\r\n        }\r\n        item.setPosition(new Point(x, y));\r\n        myself.add(item);\r\n        y = y + item.height();\r\n        if (isLine) {\r\n            y += 1;\r\n        }\r\n    });\r\n\r\n    fb = this.fullBounds();\r\n    this.silentSetExtent(fb.extent().add(4));\r\n    this.adjustWidths();\r\n    MenuMorph.uber.drawNew.call(this);\r\n};\r\n\r\nMenuMorph.prototype.maxWidth = function () {\r\n    var w = 0;\r\n\r\n    if (this.parent instanceof FrameMorph) {\r\n        if (this.parent.scrollFrame instanceof ScrollFrameMorph) {\r\n            w = this.parent.scrollFrame.width();\r\n        }\r\n    }\r\n    this.children.forEach(function (item) {\r\n        if (item instanceof MenuItemMorph) {\r\n            w = Math.max(\r\n                w,\r\n                item.label.width() + 8 +\r\n                    (item.shortcut ? item.shortcut.width() + 4 : 0)\r\n            );\r\n        } else if ((item instanceof StringFieldMorph) ||\r\n                (item instanceof ColorPickerMorph) ||\r\n                (item instanceof SliderMorph)) {\r\n            w = Math.max(w, item.width());\r\n        }\r\n    });\r\n    if (this.label) {\r\n        w = Math.max(w, this.label.width());\r\n    }\r\n    return w;\r\n};\r\n\r\nMenuMorph.prototype.adjustWidths = function () {\r\n    var w = this.maxWidth(),\r\n        isSelected,\r\n        myself = this;\r\n    this.children.forEach(function (item) {\r\n        item.silentSetWidth(w);\r\n        if (item instanceof MenuItemMorph) {\r\n            item.fixLayout();\r\n            isSelected = (item.image === item.pressImage);\r\n            item.createBackgrounds();\r\n            if (isSelected) {\r\n                item.image = item.pressImage;\r\n            }\r\n        } else {\r\n            item.drawNew();\r\n            if (item === myself.label) {\r\n                item.text.setPosition(\r\n                    item.center().subtract(\r\n                        item.text.extent().floorDivideBy(2)\r\n                    )\r\n                );\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nMenuMorph.prototype.unselectAllItems = function () {\r\n    this.children.forEach(function (item) {\r\n        if (item instanceof MenuItemMorph) {\r\n            item.image = item.normalImage;\r\n        }\r\n    });\r\n    this.changed();\r\n};\r\n\r\nMenuMorph.prototype.popup = function (world, pos) {\r\n    this.drawNew();\r\n    this.setPosition(pos);\r\n    this.addShadow(new Point(2, 2), 80);\r\n    this.keepWithin(world);\r\n    if (world.activeMenu) {\r\n        world.activeMenu.destroy();\r\n    }\r\n    if (this.items.length < 1 && !this.title) { // don't show empty menus\r\n        return;\r\n    }\r\n    world.add(this);\r\n    world.activeMenu = this;\r\n    this.world = world; // optionally enable keyboard support\r\n    this.fullChanged();\r\n};\r\n\r\nMenuMorph.prototype.popUpAtHand = function (world) {\r\n    var wrrld = world || this.world;\r\n    this.popup(wrrld, wrrld.hand.position());\r\n};\r\n\r\nMenuMorph.prototype.popUpCenteredAtHand = function (world) {\r\n    var wrrld = world || this.world;\r\n    this.drawNew();\r\n    this.popup(\r\n        wrrld,\r\n        wrrld.hand.position().subtract(\r\n            this.extent().floorDivideBy(2)\r\n        )\r\n    );\r\n};\r\n\r\nMenuMorph.prototype.popUpCenteredInWorld = function (world) {\r\n    var wrrld = world || this.world;\r\n    this.drawNew();\r\n    this.popup(\r\n        wrrld,\r\n        wrrld.center().subtract(\r\n            this.extent().floorDivideBy(2)\r\n        )\r\n    );\r\n};\r\n\r\n// MenuMorph submenus\r\n\r\nMenuMorph.prototype.closeRootMenu = function () {\r\n    if (this.parent instanceof MenuMorph) {\r\n        this.parent.closeRootMenu();\r\n    } else {\r\n        this.destroy();\r\n    }\r\n};\r\n\r\nMenuMorph.prototype.closeSubmenu = function () {\r\n    if (this.submenu) {\r\n        this.submenu.destroy();\r\n        this.submenu = null;\r\n        this.unselectAllItems();\r\n    }\r\n};\r\n\r\n// MenuMorph keyboard accessibility\r\n\r\nMenuMorph.prototype.getFocus = function () {\r\n    this.world.keyboardReceiver = this;\r\n    this.selection = null;\r\n    this.selectFirst();\r\n    this.hasFocus = true;\r\n};\r\n\r\nMenuMorph.prototype.processKeyDown = function (event) {\r\n    switch (event.keyCode) {\r\n    case 13: // 'enter'\r\n    case 32: // 'space'\r\n        if (this.selection) {\r\n            this.selection.mouseClickLeft();\r\n            if (this.submenu) {\r\n                this.submenu.getFocus();\r\n            }\r\n        }\r\n        return;\r\n    case 27: // 'esc'\r\n        return this.destroy();\r\n    case 37: // 'left arrow'\r\n        return this.leaveSubmenu();\r\n    case 38: // 'up arrow'\r\n        return this.selectUp();\r\n    case 39: // 'right arrow'\r\n        return this.enterSubmenu();\r\n    case 40: // 'down arrow'\r\n        return this.selectDown();\r\n    default:\r\n        nop();\r\n    }\r\n};\r\n\r\nMenuMorph.prototype.processKeyUp = function (event) {\r\n    nop(event);\r\n};\r\n\r\nMenuMorph.prototype.processKeyPress = function (event) {\r\n    nop(event);\r\n};\r\n\r\nMenuMorph.prototype.selectFirst = function () {\r\n    var i;\r\n    for (i = 0; i < this.children.length; i += 1) {\r\n        if (this.children[i] instanceof MenuItemMorph) {\r\n            this.select(this.children[i]);\r\n            return;\r\n        }\r\n    }\r\n};\r\n\r\nMenuMorph.prototype.selectUp = function () {\r\n    var triggers, idx;\r\n\r\n    triggers = this.children.filter(function (each) {\r\n        return each instanceof MenuItemMorph;\r\n    });\r\n    if (!this.selection) {\r\n        if (triggers.length) {\r\n            this.select(triggers[0]);\r\n        }\r\n        return;\r\n    }\r\n    idx = triggers.indexOf(this.selection) - 1;\r\n    if (idx < 0) {\r\n        idx = triggers.length - 1;\r\n    }\r\n    this.select(triggers[idx]);\r\n};\r\n\r\nMenuMorph.prototype.selectDown = function () {\r\n    var triggers, idx;\r\n\r\n    triggers = this.children.filter(function (each) {\r\n        return each instanceof MenuItemMorph;\r\n    });\r\n    if (!this.selection) {\r\n        if (triggers.length) {\r\n            this.select(triggers[0]);\r\n        }\r\n        return;\r\n    }\r\n    idx = triggers.indexOf(this.selection) + 1;\r\n    if (idx >= triggers.length) {\r\n        idx = 0;\r\n    }\r\n    this.select(triggers[idx]);\r\n};\r\n\r\nMenuMorph.prototype.enterSubmenu = function () {\r\n    if (this.selection && this.selection.action instanceof MenuMorph) {\r\n        this.selection.popUpSubmenu();\r\n        if (this.submenu) {\r\n            this.submenu.getFocus();\r\n        }\r\n    }\r\n};\r\n\r\nMenuMorph.prototype.leaveSubmenu = function () {\r\n    var menu = this.parent;\r\n    if (this.parent instanceof MenuMorph) {\r\n        menu.submenu = null;\r\n        menu.hasFocus = true;\r\n        this.destroy();\r\n        menu.world.keyboardReceiver = menu;\r\n    }\r\n};\r\n\r\nMenuMorph.prototype.select = function (aMenuItem) {\r\n    this.unselectAllItems();\r\n    aMenuItem.image = aMenuItem.highlightImage;\r\n    aMenuItem.changed();\r\n    this.selection = aMenuItem;\r\n};\r\n\r\nMenuMorph.prototype.destroy = function () {\r\n    if (this.hasFocus) {\r\n        this.world.keyboardReceiver = null;\r\n    }\r\n    MenuMorph.uber.destroy.call(this);\r\n};\r\n\r\n// StringMorph /////////////////////////////////////////////////////////\r\n\r\n// I am a single line of text\r\n\r\n// StringMorph inherits from Morph:\r\n\r\nStringMorph.prototype = new Morph();\r\nStringMorph.prototype.constructor = StringMorph;\r\nStringMorph.uber = Morph.prototype;\r\n\r\n// StringMorph instance creation:\r\n\r\nfunction StringMorph(\r\n    text,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    isNumeric,\r\n    shadowOffset,\r\n    shadowColor,\r\n    color,\r\n    fontName\r\n) {\r\n    this.init(\r\n        text,\r\n        fontSize,\r\n        fontStyle,\r\n        bold,\r\n        italic,\r\n        isNumeric,\r\n        shadowOffset,\r\n        shadowColor,\r\n        color,\r\n        fontName\r\n    );\r\n}\r\n\r\nStringMorph.prototype.init = function (\r\n    text,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    isNumeric,\r\n    shadowOffset,\r\n    shadowColor,\r\n    color,\r\n    fontName\r\n) {\r\n    // additional properties:\r\n    this.text = text || ((text === '') ? '' : 'StringMorph');\r\n    this.fontSize = fontSize || 12;\r\n    this.fontName = fontName || MorphicPreferences.globalFontFamily;\r\n    this.fontStyle = fontStyle || 'sans-serif';\r\n    this.isBold = bold || false;\r\n    this.isItalic = italic || false;\r\n    this.isEditable = false;\r\n    this.isNumeric = isNumeric || false;\r\n    this.isPassword = false;\r\n    this.shadowOffset = shadowOffset || new Point(0, 0);\r\n    this.shadowColor = shadowColor || null;\r\n    this.isShowingBlanks = false;\r\n    this.blanksColor = new Color(180, 140, 140);\r\n\r\n    // additional properties for text-editing:\r\n    this.isScrollable = true; // scrolls into view when edited\r\n    this.currentlySelecting = false;\r\n    this.startMark = 0;\r\n    this.endMark = 0;\r\n    this.markedTextColor = new Color(255, 255, 255);\r\n    this.markedBackgoundColor = new Color(60, 60, 120);\r\n\r\n    // initialize inherited properties:\r\n    StringMorph.uber.init.call(this, true);\r\n\r\n    // override inherited properites:\r\n    this.color = color || new Color(0, 0, 0);\r\n    this.noticesTransparentClick = true;\r\n    this.drawNew();\r\n};\r\n\r\nStringMorph.prototype.toString = function () {\r\n    // e.g. 'a StringMorph(\"Hello World\")'\r\n    return 'a ' +\r\n        (this.constructor.name ||\r\n            this.constructor.toString().split(' ')[1].split('(')[0]) +\r\n        '(\"' + this.text.slice(0, 30) + '...\")';\r\n};\r\n\r\nStringMorph.prototype.password = function (letter, length) {\r\n    var ans = '',\r\n        i;\r\n    for (i = 0; i < length; i += 1) {\r\n        ans += letter;\r\n    }\r\n    return ans;\r\n};\r\n\r\nStringMorph.prototype.font = function () {\r\n    // answer a font string, e.g. 'bold italic 12px sans-serif'\r\n    var font = '';\r\n    if (this.isBold) {\r\n        font = font + 'bold ';\r\n    }\r\n    if (this.isItalic) {\r\n        font = font + 'italic ';\r\n    }\r\n    return font +\r\n        this.fontSize + 'px ' +\r\n        (this.fontName ? this.fontName + ', ' : '') +\r\n        this.fontStyle;\r\n};\r\n\r\nStringMorph.prototype.drawNew = function () {\r\n    var context, width, start, stop, i, p, c, x, y,\r\n        shadowOffset = this.shadowOffset || new Point(),\r\n        txt = this.isPassword ?\r\n                this.password('*', this.text.length) : this.text;\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas();\r\n    context = this.image.getContext('2d');\r\n    context.font = this.font();\r\n\r\n    // set my extent\r\n    width = Math.max(\r\n        context.measureText(txt).width + Math.abs(shadowOffset.x),\r\n        1\r\n    );\r\n    this.bounds.corner = this.bounds.origin.add(\r\n        new Point(\r\n            width,\r\n            fontHeight(this.fontSize) + Math.abs(shadowOffset.y)\r\n        )\r\n    );\r\n    this.image.width = width;\r\n    this.image.height = this.height();\r\n\r\n    // prepare context for drawing text\r\n    context.font = this.font();\r\n    context.textAlign = 'left';\r\n    context.textBaseline = 'bottom';\r\n\r\n    // first draw the shadow, if any\r\n    if (this.shadowColor) {\r\n        x = Math.max(shadowOffset.x, 0);\r\n        y = Math.max(shadowOffset.y, 0);\r\n        context.fillStyle = this.shadowColor.toString();\r\n        context.fillText(txt, x, fontHeight(this.fontSize) + y);\r\n    }\r\n\r\n    // now draw the actual text\r\n    x = Math.abs(Math.min(shadowOffset.x, 0));\r\n    y = Math.abs(Math.min(shadowOffset.y, 0));\r\n    context.fillStyle = this.color.toString();\r\n\r\n    if (this.isShowingBlanks) {\r\n        this.renderWithBlanks(context, x, fontHeight(this.fontSize) + y);\r\n    } else {\r\n        context.fillText(txt, x, fontHeight(this.fontSize) + y);\r\n    }\r\n\r\n    // draw the selection\r\n    start = Math.min(this.startMark, this.endMark);\r\n    stop = Math.max(this.startMark, this.endMark);\r\n    for (i = start; i < stop; i += 1) {\r\n        p = this.slotPosition(i).subtract(this.position());\r\n        c = txt.charAt(i);\r\n        context.fillStyle = this.markedBackgoundColor.toString();\r\n        context.fillRect(p.x, p.y, context.measureText(c).width + 1 + x,\r\n            fontHeight(this.fontSize) + y);\r\n        context.fillStyle = this.markedTextColor.toString();\r\n        context.fillText(c, p.x + x, fontHeight(this.fontSize) + y);\r\n    }\r\n\r\n    // notify my parent of layout change\r\n    if (this.parent) {\r\n        if (this.parent.fixLayout) {\r\n            this.parent.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\nStringMorph.prototype.renderWithBlanks = function (context, startX, y) {\r\n    var space = context.measureText(' ').width,\r\n        blank = newCanvas(new Point(space, this.height())),\r\n        ctx = blank.getContext('2d'),\r\n        words = this.text.split(' '),\r\n        x = startX || 0,\r\n        isFirst = true;\r\n\r\n    // create the blank form\r\n    ctx.fillStyle = this.blanksColor.toString();\r\n    ctx.arc(\r\n        space / 2,\r\n        blank.height / 2,\r\n        space / 2,\r\n        radians(0),\r\n        radians(360)\r\n    );\r\n    ctx.fill();\r\n\r\n    function drawBlank() {\r\n        context.drawImage(blank, x, 0);\r\n        x += space;\r\n    }\r\n\r\n    // render my text inserting blanks\r\n    words.forEach(function (word) {\r\n        if (!isFirst) {\r\n            drawBlank();\r\n        }\r\n        isFirst = false;\r\n        if (word !== '') {\r\n            context.fillText(word, x, y);\r\n            x += context.measureText(word).width;\r\n        }\r\n    });\r\n};\r\n\r\n// StringMorph measuring:\r\n\r\nStringMorph.prototype.slotPosition = function (slot) {\r\n    // answer the position point of the given index (\"slot\")\r\n    // where the cursor should be placed\r\n    var txt = this.isPassword ?\r\n                this.password('*', this.text.length) : this.text,\r\n        dest = Math.min(Math.max(slot, 0), txt.length),\r\n        context = this.image.getContext('2d'),\r\n        xOffset,\r\n        x,\r\n        y,\r\n        idx;\r\n\r\n    xOffset = 0;\r\n    for (idx = 0; idx < dest; idx += 1) {\r\n        xOffset += context.measureText(txt[idx]).width;\r\n    }\r\n    this.pos = dest;\r\n    x = this.left() + xOffset;\r\n    y = this.top();\r\n    return new Point(x, y);\r\n};\r\n\r\nStringMorph.prototype.slotAt = function (aPoint) {\r\n    // answer the slot (index) closest to the given point taking\r\n    // in account how far from the middle of the character it is,\r\n    // so the cursor can be moved accordingly\r\n\r\n    var txt = this.isPassword ?\r\n                this.password('*', this.text.length) : this.text,\r\n        idx = 0,\r\n        charX = 0,\r\n        context = this.image.getContext('2d');\r\n\r\n    while (aPoint.x - this.left() > charX) {\r\n        charX += context.measureText(txt[idx]).width;\r\n        idx += 1;\r\n        if (idx === txt.length) {\r\n            if ((context.measureText(txt).width -\r\n                    (context.measureText(txt[idx - 1]).width / 2)) <\r\n                    (aPoint.x - this.left())) {\r\n                return idx;\r\n            }\r\n        }\r\n    }\r\n\r\n    // see where our click fell with respect to the middle of the char\r\n    if (aPoint.x - this.left() >\r\n            charX - context.measureText(txt[idx - 1]).width / 2) {\r\n        return idx;\r\n    } else {\r\n        return idx - 1;\r\n    }\r\n};\r\n\r\nStringMorph.prototype.upFrom = function (slot) {\r\n    // answer the slot above the given one\r\n    return slot;\r\n};\r\n\r\nStringMorph.prototype.downFrom = function (slot) {\r\n    // answer the slot below the given one\r\n    return slot;\r\n};\r\n\r\nStringMorph.prototype.startOfLine = function () {\r\n    // answer the first slot (index) of the line for the given slot\r\n    return 0;\r\n};\r\n\r\nStringMorph.prototype.endOfLine = function () {\r\n    // answer the slot (index) indicating the EOL for the given slot\r\n    return this.text.length;\r\n};\r\n\r\nStringMorph.prototype.previousWordFrom = function (aSlot) {\r\n    // answer the slot (index) slots indicating the position of the\r\n    // previous word to the left of aSlot\r\n    var index = aSlot - 1;\r\n    \r\n    // while the current character is non-word one, we skip it, so that\r\n    // if we are in the middle of a non-alphanumeric sequence, we'll get\r\n    // right to the beginning of the previous word\r\n    while (index > 0 && !isWordChar(this.text[index])) {\r\n        index -= 1;\r\n    }\r\n\r\n    // while the current character is a word one, we skip it until we\r\n    // find the beginning of the current word\r\n    while (index > 0 && isWordChar(this.text[index - 1])) {\r\n        index -= 1;\r\n    }\r\n\r\n    return index;\r\n};\r\n\r\nStringMorph.prototype.nextWordFrom = function (aSlot) {\r\n    var index = aSlot;\r\n    \r\n    while (index < this.endOfLine() && !isWordChar(this.text[index])) {\r\n        index += 1;\r\n    }\r\n\r\n    while (index < this.endOfLine() && isWordChar(this.text[index])) {\r\n        index += 1;\r\n    }\r\n\r\n    return index;\r\n};\r\n\r\nStringMorph.prototype.rawHeight = function () {\r\n    // answer my corrected fontSize\r\n    return this.height() / 1.2;\r\n};\r\n\r\n// StringMorph menus:\r\n\r\nStringMorph.prototype.developersMenu = function () {\r\n    var menu = StringMorph.uber.developersMenu.call(this);\r\n\r\n    menu.addLine();\r\n    menu.addItem(\"edit\", 'edit');\r\n    menu.addItem(\r\n        \"font size...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nfont\\nsize:',\r\n                this.setFontSize,\r\n                this,\r\n                this.fontSize.toString(),\r\n                null,\r\n                6,\r\n                500,\r\n                true\r\n            );\r\n        },\r\n        'set this String\\'s\\nfont point size'\r\n    );\r\n    if (this.fontStyle !== 'serif') {\r\n        menu.addItem(\"serif\", 'setSerif');\r\n    }\r\n    if (this.fontStyle !== 'sans-serif') {\r\n        menu.addItem(\"sans-serif\", 'setSansSerif');\r\n    }\r\n    if (this.isBold) {\r\n        menu.addItem(\"normal weight\", 'toggleWeight');\r\n    } else {\r\n        menu.addItem(\"bold\", 'toggleWeight');\r\n    }\r\n    if (this.isItalic) {\r\n        menu.addItem(\"normal style\", 'toggleItalic');\r\n    } else {\r\n        menu.addItem(\"italic\", 'toggleItalic');\r\n    }\r\n    if (this.isShowingBlanks) {\r\n        menu.addItem(\"hide blanks\", 'toggleShowBlanks');\r\n    } else {\r\n        menu.addItem(\"show blanks\", 'toggleShowBlanks');\r\n    }\r\n    if (this.isPassword) {\r\n        menu.addItem(\"show characters\", 'toggleIsPassword');\r\n    } else {\r\n        menu.addItem(\"hide characters\", 'toggleIsPassword');\r\n    }\r\n    return menu;\r\n};\r\n\r\nStringMorph.prototype.toggleIsDraggable = function () {\r\n    // for context menu demo purposes\r\n    this.isDraggable = !this.isDraggable;\r\n    if (this.isDraggable) {\r\n        this.disableSelecting();\r\n    } else {\r\n        this.enableSelecting();\r\n    }\r\n};\r\n\r\nStringMorph.prototype.toggleShowBlanks = function () {\r\n    this.isShowingBlanks = !this.isShowingBlanks;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.toggleWeight = function () {\r\n    this.isBold = !this.isBold;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.toggleItalic = function () {\r\n    this.isItalic = !this.isItalic;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.toggleIsPassword = function () {\r\n    this.isPassword = !this.isPassword;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.setSerif = function () {\r\n    this.fontStyle = 'serif';\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.setSansSerif = function () {\r\n    this.fontStyle = 'sans-serif';\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.setFontSize = function (size) {\r\n    // for context menu demo purposes\r\n    var newSize;\r\n    if (typeof size === 'number') {\r\n        this.fontSize = Math.round(Math.min(Math.max(size, 4), 500));\r\n    } else {\r\n        newSize = parseFloat(size);\r\n        if (!isNaN(newSize)) {\r\n            this.fontSize = Math.round(\r\n                Math.min(Math.max(newSize, 4), 500)\r\n            );\r\n        }\r\n    }\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.setText = function (size) {\r\n    // for context menu demo purposes\r\n    this.text = Math.round(size).toString();\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.numericalSetters = function () {\r\n    // for context menu demo purposes\r\n    return [\r\n        'setLeft',\r\n        'setTop',\r\n        'setAlphaScaled',\r\n        'setFontSize',\r\n        'setText'\r\n    ];\r\n};\r\n\r\n// StringMorph editing:\r\n\r\nStringMorph.prototype.edit = function () {\r\n    this.root().edit(this);\r\n};\r\n\r\nStringMorph.prototype.selection = function () {\r\n    var start, stop;\r\n    start = Math.min(this.startMark, this.endMark);\r\n    stop = Math.max(this.startMark, this.endMark);\r\n    return this.text.slice(start, stop);\r\n};\r\n\r\nStringMorph.prototype.selectionStartSlot = function () {\r\n    return Math.min(this.startMark, this.endMark);\r\n};\r\n\r\nStringMorph.prototype.clearSelection = function () {\r\n    if (!this.currentlySelecting &&\r\n            isNil(this.startMark) &&\r\n            isNil(this.endMark)) {\r\n        return;\r\n    }\r\n    this.currentlySelecting = false;\r\n    this.startMark = null;\r\n    this.endMark = null;\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.deleteSelection = function () {\r\n    var start, stop, text;\r\n    text = this.text;\r\n    start = Math.min(this.startMark, this.endMark);\r\n    stop = Math.max(this.startMark, this.endMark);\r\n    this.text = text.slice(0, start) + text.slice(stop);\r\n    this.changed();\r\n    this.clearSelection();\r\n};\r\n\r\nStringMorph.prototype.selectAll = function () {\r\n    var cursor;\r\n    if (this.isEditable) {\r\n        this.startMark = 0;\r\n        cursor = this.root().cursor;\r\n        if (cursor) {\r\n            cursor.gotoSlot(this.text.length);\r\n        }\r\n        this.endMark = this.text.length;\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nStringMorph.prototype.mouseDownLeft = function (pos) {\r\n    if (this.world().currentKey === 16) {\r\n        this.shiftClick(pos);\r\n    } else if (this.isEditable) {\r\n        this.clearSelection();\r\n    } else {\r\n        this.escalateEvent('mouseDownLeft', pos);\r\n    }\r\n};\r\n\r\nStringMorph.prototype.shiftClick = function (pos) {\r\n    var cursor = this.root().cursor;\r\n\r\n    if (cursor) {\r\n        if (!this.startMark) {\r\n            this.startMark = cursor.slot;\r\n        }\r\n        cursor.gotoPos(pos);\r\n        this.endMark = cursor.slot;\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n    this.currentlySelecting = false;\r\n    this.escalateEvent('mouseDownLeft', pos);\r\n};\r\n\r\nStringMorph.prototype.mouseClickLeft = function (pos) {\r\n    var cursor;\r\n    if (this.isEditable) {\r\n        if (!this.currentlySelecting) {\r\n            this.edit(); // creates a new cursor\r\n        }\r\n        cursor = this.root().cursor;\r\n        if (cursor) {\r\n            cursor.gotoPos(pos);\r\n        }\r\n        this.currentlySelecting = true;\r\n    } else {\r\n        this.escalateEvent('mouseClickLeft', pos);\r\n    }\r\n};\r\n\r\nStringMorph.prototype.mouseDoubleClick = function (pos) {\r\n    // selects the word at pos\r\n    // if there is no word, we select whatever is between\r\n    // the previous and next words\r\n    var slot = this.slotAt(pos);\r\n\r\n    if (this.isEditable) {\r\n        this.edit();\r\n\r\n        if (slot === this.text.length) {\r\n            slot -= 1;\r\n        }\r\n\r\n        if (this.text[slot] && isWordChar(this.text[slot])) {\r\n            this.selectWordAt(slot);\r\n        } else if (this.text[slot]) {\r\n            this.selectBetweenWordsAt(slot);\r\n        } else {\r\n            // special case for when we click right after the\r\n            // last slot in multi line TextMorphs\r\n            this.selectAll();\r\n        }\r\n    } else {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    }\r\n};\r\n\r\nStringMorph.prototype.selectWordAt = function (slot) {\r\n    var cursor = this.root().cursor;\r\n\r\n    if (slot === 0 || isWordChar(this.text[slot - 1])) {\r\n        cursor.gotoSlot(this.previousWordFrom(slot));\r\n        this.startMark = cursor.slot;\r\n        this.endMark = this.nextWordFrom(cursor.slot);\r\n    } else {\r\n        cursor.gotoSlot(slot);\r\n        this.startMark = slot;\r\n        this.endMark = this.nextWordFrom(slot);\r\n    }\r\n\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.selectBetweenWordsAt = function (slot) {\r\n    var cursor = this.root().cursor;\r\n\r\n    cursor.gotoSlot(this.nextWordFrom(this.previousWordFrom(slot)));\r\n    this.startMark = cursor.slot;\r\n    this.endMark = cursor.slot;\r\n\r\n    while (this.endMark < this.text.length\r\n            && !isWordChar(this.text[this.endMark])) {\r\n        this.endMark += 1;\r\n    }\r\n\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nStringMorph.prototype.enableSelecting = function () {\r\n    this.mouseDownLeft = function (pos) {\r\n        var crs = this.root().cursor,\r\n            already = crs ? crs.target === this : false;\r\n        if (this.world().currentKey === 16) {\r\n            this.shiftClick(pos);\r\n        } else {\r\n            this.clearSelection();\r\n            if (this.isEditable && (!this.isDraggable)) {\r\n                this.edit();\r\n                this.root().cursor.gotoPos(pos);\r\n                this.startMark = this.slotAt(pos);\r\n                this.endMark = this.startMark;\r\n                this.currentlySelecting = true;\r\n                if (!already) {this.escalateEvent('mouseDownLeft', pos); }\r\n            }\r\n        }\r\n    };\r\n    this.mouseMove = function (pos) {\r\n        if (this.isEditable &&\r\n                this.currentlySelecting &&\r\n                (!this.isDraggable)) {\r\n            var newMark = this.slotAt(pos);\r\n            if (newMark !== this.endMark) {\r\n                this.endMark = newMark;\r\n                this.drawNew();\r\n                this.changed();\r\n            }\r\n        }\r\n    };\r\n};\r\n\r\nStringMorph.prototype.disableSelecting = function () {\r\n    this.mouseDownLeft = StringMorph.prototype.mouseDownLeft;\r\n    delete this.mouseMove;\r\n};\r\n\r\n// TextMorph ////////////////////////////////////////////////////////////////\r\n\r\n// I am a multi-line, word-wrapping String, quasi-inheriting from StringMorph\r\n\r\n// TextMorph inherits from Morph:\r\n\r\nTextMorph.prototype = new Morph();\r\nTextMorph.prototype.constructor = TextMorph;\r\nTextMorph.uber = Morph.prototype;\r\n\r\n// TextMorph instance creation:\r\n\r\nfunction TextMorph(\r\n    text,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    alignment,\r\n    width,\r\n    fontName,\r\n    shadowOffset,\r\n    shadowColor\r\n) {\r\n    this.init(text,\r\n        fontSize,\r\n        fontStyle,\r\n        bold,\r\n        italic,\r\n        alignment,\r\n        width,\r\n        fontName,\r\n        shadowOffset,\r\n        shadowColor);\r\n}\r\n\r\nTextMorph.prototype.init = function (\r\n    text,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    alignment,\r\n    width,\r\n    fontName,\r\n    shadowOffset,\r\n    shadowColor\r\n) {\r\n    // additional properties:\r\n    this.text = text || (text === '' ? text : 'TextMorph');\r\n    this.words = [];\r\n    this.lines = [];\r\n    this.lineSlots = [];\r\n    this.fontSize = fontSize || 12;\r\n    this.fontName = fontName || MorphicPreferences.globalFontFamily;\r\n    this.fontStyle = fontStyle || 'sans-serif';\r\n    this.isBold = bold || false;\r\n    this.isItalic = italic || false;\r\n    this.alignment = alignment || 'left';\r\n    this.shadowOffset = shadowOffset || new Point(0, 0);\r\n    this.shadowColor = shadowColor || null;\r\n    this.maxWidth = width || 0;\r\n    this.maxLineWidth = 0;\r\n    this.backgroundColor = null;\r\n    this.isEditable = false;\r\n\r\n    //additional properties for ad-hoc evaluation:\r\n    this.receiver = null;\r\n\r\n    // additional properties for text-editing:\r\n    this.isScrollable = true; // scrolls into view when edited\r\n    this.currentlySelecting = false;\r\n    this.startMark = 0;\r\n    this.endMark = 0;\r\n    this.markedTextColor = new Color(255, 255, 255);\r\n    this.markedBackgoundColor = new Color(60, 60, 120);\r\n\r\n    // initialize inherited properties:\r\n    TextMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.color = new Color(0, 0, 0);\r\n    this.noticesTransparentClick = true;\r\n    this.drawNew();\r\n};\r\n\r\nTextMorph.prototype.toString = function () {\r\n    // e.g. 'a TextMorph(\"Hello World\")'\r\n    return 'a TextMorph' + '(\"' + this.text.slice(0, 30) + '...\")';\r\n};\r\n\r\nTextMorph.prototype.font = StringMorph.prototype.font;\r\n\r\nTextMorph.prototype.parse = function () {\r\n    var myself = this,\r\n        paragraphs = this.text.split('\\n'),\r\n        canvas = newCanvas(),\r\n        context = canvas.getContext('2d'),\r\n        oldline = '',\r\n        newline,\r\n        w,\r\n        slot = 0;\r\n\r\n    context.font = this.font();\r\n    this.maxLineWidth = 0;\r\n    this.lines = [];\r\n    this.lineSlots = [0];\r\n    this.words = [];\r\n\r\n    paragraphs.forEach(function (p) {\r\n        myself.words = myself.words.concat(p.split(' '));\r\n        myself.words.push('\\n');\r\n    });\r\n\r\n    this.words.forEach(function (word) {\r\n        if (word === '\\n') {\r\n            myself.lines.push(oldline);\r\n            myself.lineSlots.push(slot);\r\n            myself.maxLineWidth = Math.max(\r\n                myself.maxLineWidth,\r\n                context.measureText(oldline).width\r\n            );\r\n            oldline = '';\r\n        } else {\r\n            if (myself.maxWidth > 0) {\r\n                newline = oldline + word + ' ';\r\n                w = context.measureText(newline).width;\r\n                if (w > myself.maxWidth) {\r\n                    myself.lines.push(oldline);\r\n                    myself.lineSlots.push(slot);\r\n                    myself.maxLineWidth = Math.max(\r\n                        myself.maxLineWidth,\r\n                        context.measureText(oldline).width\r\n                    );\r\n                    oldline = word + ' ';\r\n                } else {\r\n                    oldline = newline;\r\n                }\r\n            } else {\r\n                oldline = oldline + word + ' ';\r\n            }\r\n            slot += word.length + 1;\r\n        }\r\n    });\r\n};\r\n\r\nTextMorph.prototype.drawNew = function () {\r\n    var context, height, i, line, width, shadowHeight, shadowWidth,\r\n        offx, offy, x, y, start, stop, p, c;\r\n\r\n    this.image = newCanvas();\r\n    context = this.image.getContext('2d');\r\n    context.font = this.font();\r\n    this.parse();\r\n\r\n    // set my extent\r\n    shadowWidth = Math.abs(this.shadowOffset.x);\r\n    shadowHeight = Math.abs(this.shadowOffset.y);\r\n    height = this.lines.length * (fontHeight(this.fontSize) + shadowHeight);\r\n    if (this.maxWidth === 0) {\r\n        this.bounds = this.bounds.origin.extent(\r\n            new Point(this.maxLineWidth + shadowWidth, height)\r\n        );\r\n    } else {\r\n        this.bounds = this.bounds.origin.extent(\r\n            new Point(this.maxWidth + shadowWidth, height)\r\n        );\r\n    }\r\n    this.image.width = this.width();\r\n    this.image.height = this.height();\r\n\r\n    // prepare context for drawing text\r\n    context = this.image.getContext('2d');\r\n    context.font = this.font();\r\n    context.textAlign = 'left';\r\n    context.textBaseline = 'bottom';\r\n\r\n    // fill the background, if desired\r\n    if (this.backgroundColor) {\r\n        context.fillStyle = this.backgroundColor.toString();\r\n        context.fillRect(0, 0, this.width(), this.height());\r\n    }\r\n\r\n    // draw the shadow, if any\r\n    if (this.shadowColor) {\r\n        offx = Math.max(this.shadowOffset.x, 0);\r\n        offy = Math.max(this.shadowOffset.y, 0);\r\n        context.fillStyle = this.shadowColor.toString();\r\n\r\n        for (i = 0; i < this.lines.length; i = i + 1) {\r\n            line = this.lines[i];\r\n            width = context.measureText(line).width + shadowWidth;\r\n            if (this.alignment === 'right') {\r\n                x = this.width() - width;\r\n            } else if (this.alignment === 'center') {\r\n                x = (this.width() - width) / 2;\r\n            } else { // 'left'\r\n                x = 0;\r\n            }\r\n            y = (i + 1) * (fontHeight(this.fontSize) + shadowHeight)\r\n                - shadowHeight;\r\n            context.fillText(line, x + offx, y + offy);\r\n        }\r\n    }\r\n\r\n    // now draw the actual text\r\n    offx = Math.abs(Math.min(this.shadowOffset.x, 0));\r\n    offy = Math.abs(Math.min(this.shadowOffset.y, 0));\r\n    context.fillStyle = this.color.toString();\r\n\r\n    for (i = 0; i < this.lines.length; i = i + 1) {\r\n        line = this.lines[i];\r\n        width = context.measureText(line).width + shadowWidth;\r\n        if (this.alignment === 'right') {\r\n            x = this.width() - width;\r\n        } else if (this.alignment === 'center') {\r\n            x = (this.width() - width) / 2;\r\n        } else { // 'left'\r\n            x = 0;\r\n        }\r\n        y = (i + 1) * (fontHeight(this.fontSize) + shadowHeight)\r\n            - shadowHeight;\r\n        context.fillText(line, x + offx, y + offy);\r\n    }\r\n\r\n    // draw the selection\r\n    start = Math.min(this.startMark, this.endMark);\r\n    stop = Math.max(this.startMark, this.endMark);\r\n    for (i = start; i < stop; i += 1) {\r\n        p = this.slotPosition(i).subtract(this.position());\r\n        c = this.text.charAt(i);\r\n        context.fillStyle = this.markedBackgoundColor.toString();\r\n        context.fillRect(p.x, p.y, context.measureText(c).width + 1,\r\n            fontHeight(this.fontSize));\r\n        context.fillStyle = this.markedTextColor.toString();\r\n        context.fillText(c, p.x, p.y + fontHeight(this.fontSize));\r\n    }\r\n\r\n    // notify my parent of layout change\r\n    if (this.parent) {\r\n        if (this.parent.layoutChanged) {\r\n            this.parent.layoutChanged();\r\n        }\r\n    }\r\n};\r\n\r\nTextMorph.prototype.setExtent = function (aPoint) {\r\n    this.maxWidth = Math.max(aPoint.x, 0);\r\n    this.changed();\r\n    this.drawNew();\r\n};\r\n\r\n// TextMorph mesuring:\r\n\r\nTextMorph.prototype.columnRow = function (slot) {\r\n    // answer the logical position point of the given index (\"slot\")\r\n    var row,\r\n        col,\r\n        idx = 0;\r\n\r\n    for (row = 0; row < this.lines.length; row += 1) {\r\n        idx = this.lineSlots[row];\r\n        for (col = 0; col < this.lines[row].length; col += 1) {\r\n            if (idx === slot) {\r\n                return new Point(col, row);\r\n            }\r\n            idx += 1;\r\n        }\r\n    }\r\n    // return new Point(0, 0);\r\n    return new Point(\r\n        this.lines[this.lines.length - 1].length - 1,\r\n        this.lines.length - 1\r\n    );\r\n};\r\n\r\nTextMorph.prototype.slotPosition = function (slot) {\r\n    // answer the physical position point of the given index (\"slot\")\r\n    // where the cursor should be placed\r\n    var colRow = this.columnRow(slot),\r\n        context = this.image.getContext('2d'),\r\n        shadowHeight = Math.abs(this.shadowOffset.y),\r\n        xOffset = 0,\r\n        yOffset,\r\n        x,\r\n        y,\r\n        idx;\r\n\r\n    yOffset = colRow.y * (fontHeight(this.fontSize) + shadowHeight);\r\n    for (idx = 0; idx < colRow.x; idx += 1) {\r\n        xOffset += context.measureText(this.lines[colRow.y][idx]).width;\r\n    }\r\n    x = this.left() + xOffset;\r\n    y = this.top() + yOffset;\r\n    return new Point(x, y);\r\n};\r\n\r\nTextMorph.prototype.slotAt = function (aPoint) {\r\n    // answer the slot (index) closest to the given point taking\r\n    // in account how far from the middle of the character it is,\r\n    // so the cursor can be moved accordingly\r\n\r\n    var charX = 0,\r\n        row = 0,\r\n        col = 0,\r\n        shadowHeight = Math.abs(this.shadowOffset.y),\r\n        context = this.image.getContext('2d');\r\n\r\n    while (aPoint.y - this.top() >\r\n            ((fontHeight(this.fontSize) + shadowHeight) * row)) {\r\n        row += 1;\r\n    }\r\n    row = Math.max(row, 1);\r\n\r\n    while (aPoint.x - this.left() > charX) {\r\n        charX += context.measureText(this.lines[row - 1][col]).width;\r\n        col += 1;\r\n    }\r\n\r\n    // see where our click fell with respect to the middle of the char\r\n    if (aPoint.x - this.left() >\r\n            charX - context.measureText(this.lines[row - 1][col]).width / 2) {\r\n        return this.lineSlots[Math.max(row - 1, 0)] + col;\r\n    } else {\r\n        return this.lineSlots[Math.max(row - 1, 0)] + col - 1;\r\n    }\r\n};\r\n\r\nTextMorph.prototype.upFrom = function (slot) {\r\n    // answer the slot above the given one\r\n    var above,\r\n        colRow = this.columnRow(slot);\r\n    if (colRow.y < 1) {\r\n        return slot;\r\n    }\r\n    above = this.lines[colRow.y - 1];\r\n    if (above.length < colRow.x - 1) {\r\n        return this.lineSlots[colRow.y - 1] + above.length;\r\n    }\r\n    return this.lineSlots[colRow.y - 1] + colRow.x;\r\n};\r\n\r\nTextMorph.prototype.downFrom = function (slot) {\r\n    // answer the slot below the given one\r\n    var below,\r\n        colRow = this.columnRow(slot);\r\n    if (colRow.y > this.lines.length - 2) {\r\n        return slot;\r\n    }\r\n    below = this.lines[colRow.y + 1];\r\n    if (below.length < colRow.x - 1) {\r\n        return this.lineSlots[colRow.y + 1] + below.length;\r\n    }\r\n    return this.lineSlots[colRow.y + 1] + colRow.x;\r\n};\r\n\r\nTextMorph.prototype.startOfLine = function (slot) {\r\n    // answer the first slot (index) of the line for the given slot\r\n    return this.lineSlots[this.columnRow(slot).y];\r\n};\r\n\r\nTextMorph.prototype.endOfLine = function (slot) {\r\n    // answer the slot (index) indicating the EOL for the given slot\r\n    return this.startOfLine(slot) +\r\n        this.lines[this.columnRow(slot).y].length - 1;\r\n};\r\n\r\nTextMorph.prototype.previousWordFrom = StringMorph.prototype.previousWordFrom;\r\n\r\nTextMorph.prototype.nextWordFrom = StringMorph.prototype.nextWordFrom;\r\n\r\n// TextMorph editing:\r\n\r\nTextMorph.prototype.edit = StringMorph.prototype.edit;\r\n\r\nTextMorph.prototype.selection = StringMorph.prototype.selection;\r\n\r\nTextMorph.prototype.selectionStartSlot\r\n    = StringMorph.prototype.selectionStartSlot;\r\n\r\nTextMorph.prototype.clearSelection = StringMorph.prototype.clearSelection;\r\n\r\nTextMorph.prototype.deleteSelection = StringMorph.prototype.deleteSelection;\r\n\r\nTextMorph.prototype.selectAll = StringMorph.prototype.selectAll;\r\n\r\nTextMorph.prototype.mouseDownLeft = StringMorph.prototype.mouseDownLeft;\r\n\r\nTextMorph.prototype.shiftClick = StringMorph.prototype.shiftClick;\r\n\r\nTextMorph.prototype.mouseClickLeft = StringMorph.prototype.mouseClickLeft;\r\n\r\nTextMorph.prototype.mouseDoubleClick = StringMorph.prototype.mouseDoubleClick;\r\n\r\nTextMorph.prototype.selectWordAt = StringMorph.prototype.selectWordAt;\r\n\r\nTextMorph.prototype.selectBetweenWordsAt\r\n    = StringMorph.prototype.selectBetweenWordsAt;\r\n\r\nTextMorph.prototype.enableSelecting = StringMorph.prototype.enableSelecting;\r\n\r\nTextMorph.prototype.disableSelecting = StringMorph.prototype.disableSelecting;\r\n\r\nTextMorph.prototype.selectAllAndEdit = function () {\r\n    this.edit();\r\n    this.selectAll();\r\n};\r\n\r\n// TextMorph menus:\r\n\r\nTextMorph.prototype.developersMenu = function () {\r\n    var menu = TextMorph.uber.developersMenu.call(this);\r\n    menu.addLine();\r\n    menu.addItem(\"edit\", 'edit');\r\n    menu.addItem(\r\n        \"font size...\",\r\n        function () {\r\n            this.prompt(\r\n                menu.title + '\\nfont\\nsize:',\r\n                this.setFontSize,\r\n                this,\r\n                this.fontSize.toString(),\r\n                null,\r\n                6,\r\n                100,\r\n                true\r\n            );\r\n        },\r\n        'set this Text\\'s\\nfont point size'\r\n    );\r\n    if (this.alignment !== 'left') {\r\n        menu.addItem(\"align left\", 'setAlignmentToLeft');\r\n    }\r\n    if (this.alignment !== 'right') {\r\n        menu.addItem(\"align right\", 'setAlignmentToRight');\r\n    }\r\n    if (this.alignment !== 'center') {\r\n        menu.addItem(\"align center\", 'setAlignmentToCenter');\r\n    }\r\n    menu.addLine();\r\n    if (this.fontStyle !== 'serif') {\r\n        menu.addItem(\"serif\", 'setSerif');\r\n    }\r\n    if (this.fontStyle !== 'sans-serif') {\r\n        menu.addItem(\"sans-serif\", 'setSansSerif');\r\n    }\r\n    if (this.isBold) {\r\n        menu.addItem(\"normal weight\", 'toggleWeight');\r\n    } else {\r\n        menu.addItem(\"bold\", 'toggleWeight');\r\n    }\r\n    if (this.isItalic) {\r\n        menu.addItem(\"normal style\", 'toggleItalic');\r\n    } else {\r\n        menu.addItem(\"italic\", 'toggleItalic');\r\n    }\r\n    return menu;\r\n};\r\n\r\nTextMorph.prototype.setAlignmentToLeft = function () {\r\n    this.alignment = 'left';\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nTextMorph.prototype.setAlignmentToRight = function () {\r\n    this.alignment = 'right';\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nTextMorph.prototype.setAlignmentToCenter = function () {\r\n    this.alignment = 'center';\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nTextMorph.prototype.toggleIsDraggable\r\n    = StringMorph.prototype.toggleIsDraggable;\r\n\r\nTextMorph.prototype.toggleWeight = StringMorph.prototype.toggleWeight;\r\n\r\nTextMorph.prototype.toggleItalic = StringMorph.prototype.toggleItalic;\r\n\r\nTextMorph.prototype.setSerif = StringMorph.prototype.setSerif;\r\n\r\nTextMorph.prototype.setSansSerif = StringMorph.prototype.setSansSerif;\r\n\r\nTextMorph.prototype.setText = StringMorph.prototype.setText;\r\n\r\nTextMorph.prototype.setFontSize = StringMorph.prototype.setFontSize;\r\n\r\nTextMorph.prototype.numericalSetters = StringMorph.prototype.numericalSetters;\r\n\r\n// TextMorph evaluation:\r\n\r\nTextMorph.prototype.evaluationMenu = function () {\r\n    var menu = new MenuMorph(this, null);\r\n    menu.addItem(\r\n        \"do it\",\r\n        'doIt',\r\n        'evaluate the\\nselected expression'\r\n    );\r\n    menu.addItem(\r\n        \"show it\",\r\n        'showIt',\r\n        'evaluate the\\nselected expression\\nand show the result'\r\n    );\r\n    menu.addItem(\r\n        \"inspect it\",\r\n        'inspectIt',\r\n        'evaluate the\\nselected expression\\nand inspect the result'\r\n    );\r\n    menu.addLine();\r\n    menu.addItem(\"select all\", 'selectAllAndEdit');\r\n    return menu;\r\n};\r\n\r\nTextMorph.prototype.setReceiver = function (obj) {\r\n    this.receiver = obj;\r\n    this.customContextMenu = this.evaluationMenu();\r\n};\r\n\r\nTextMorph.prototype.doIt = function () {\r\n    this.receiver.evaluateString(this.selection());\r\n    this.edit();\r\n};\r\n\r\nTextMorph.prototype.showIt = function () {\r\n    var result = this.receiver.evaluateString(this.selection());\r\n    if (result !== null) {\r\n        this.inform(result);\r\n    }\r\n};\r\n\r\nTextMorph.prototype.inspectIt = function () {\r\n    var result = this.receiver.evaluateString(this.selection()),\r\n        world = this.world(),\r\n        inspector;\r\n    if (isObject(result)) {\r\n        inspector = new InspectorMorph(result);\r\n        inspector.setPosition(world.hand.position());\r\n        inspector.keepWithin(world);\r\n        world.add(inspector);\r\n        inspector.changed();\r\n    }\r\n};\r\n\r\n// TriggerMorph ////////////////////////////////////////////////////////\r\n\r\n// I provide basic button functionality\r\n\r\n// TriggerMorph inherits from Morph:\r\n\r\nTriggerMorph.prototype = new Morph();\r\nTriggerMorph.prototype.constructor = TriggerMorph;\r\nTriggerMorph.uber = Morph.prototype;\r\n\r\n// TriggerMorph instance creation:\r\n\r\nfunction TriggerMorph(\r\n    target,\r\n    action,\r\n    labelString,\r\n    fontSize,\r\n    fontStyle,\r\n    environment,\r\n    hint,\r\n    labelColor,\r\n    labelBold,\r\n    labelItalic,\r\n    doubleClickAction\r\n) {\r\n    this.init(\r\n        target,\r\n        action,\r\n        labelString,\r\n        fontSize,\r\n        fontStyle,\r\n        environment,\r\n        hint,\r\n        labelColor,\r\n        labelBold,\r\n        labelItalic,\r\n        doubleClickAction\r\n    );\r\n}\r\n\r\nTriggerMorph.prototype.init = function (\r\n    target,\r\n    action,\r\n    labelString,\r\n    fontSize,\r\n    fontStyle,\r\n    environment,\r\n    hint,\r\n    labelColor,\r\n    labelBold,\r\n    labelItalic,\r\n    doubleClickAction\r\n) {\r\n    // additional properties:\r\n    this.target = target || null;\r\n    this.action = action || null;\r\n    this.doubleClickAction = doubleClickAction || null;\r\n    this.environment = environment || null;\r\n    this.labelString = labelString || null;\r\n    this.label = null;\r\n    this.hint = hint || null; // null, String, or Function\r\n    this.schedule = null; // animation slot for displaying hints\r\n    this.fontSize = fontSize || MorphicPreferences.menuFontSize;\r\n    this.fontStyle = fontStyle || 'sans-serif';\r\n    this.highlightColor = new Color(192, 192, 192);\r\n    this.pressColor = new Color(128, 128, 128);\r\n    this.labelColor = labelColor || new Color(0, 0, 0);\r\n    this.labelBold = labelBold || false;\r\n    this.labelItalic = labelItalic || false;\r\n\r\n    // initialize inherited properties:\r\n    TriggerMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.color = new Color(255, 255, 255);\r\n    this.drawNew();\r\n};\r\n\r\n// TriggerMorph drawing:\r\n\r\nTriggerMorph.prototype.drawNew = function () {\r\n    this.createBackgrounds();\r\n    if (this.labelString !== null) {\r\n        this.createLabel();\r\n    }\r\n};\r\n\r\nTriggerMorph.prototype.createBackgrounds = function () {\r\n    var context,\r\n        ext = this.extent();\r\n\r\n    this.normalImage = newCanvas(ext);\r\n    context = this.normalImage.getContext('2d');\r\n    context.fillStyle = this.color.toString();\r\n    context.fillRect(0, 0, ext.x, ext.y);\r\n\r\n    this.highlightImage = newCanvas(ext);\r\n    context = this.highlightImage.getContext('2d');\r\n    context.fillStyle = this.highlightColor.toString();\r\n    context.fillRect(0, 0, ext.x, ext.y);\r\n\r\n    this.pressImage = newCanvas(ext);\r\n    context = this.pressImage.getContext('2d');\r\n    context.fillStyle = this.pressColor.toString();\r\n    context.fillRect(0, 0, ext.x, ext.y);\r\n\r\n    this.image = this.normalImage;\r\n};\r\n\r\nTriggerMorph.prototype.createLabel = function () {\r\n    if (this.label !== null) {\r\n        this.label.destroy();\r\n    }\r\n    this.label = new StringMorph(\r\n        this.labelString,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        this.labelBold,\r\n        this.labelItalic,\r\n        false, // numeric\r\n        null, // shadow offset\r\n        null, // shadow color\r\n        this.labelColor\r\n    );\r\n    this.label.setPosition(\r\n        this.center().subtract(\r\n            this.label.extent().floorDivideBy(2)\r\n        )\r\n    );\r\n    this.add(this.label);\r\n};\r\n\r\n// TriggerMorph action:\r\n\r\nTriggerMorph.prototype.trigger = function () {\r\n    /*\r\n    if target is a function, use it as callback:\r\n    execute target as callback function with action as argument\r\n    in the environment as optionally specified.\r\n    Note: if action is also a function, instead of becoming\r\n    the argument itself it will be called to answer the argument.\r\n    for selections, Yes/No Choices etc. As second argument pass\r\n    myself, so I can be modified to reflect status changes, e.g.\r\n    inside a list box:\r\n\r\n    else (if target is not a function):\r\n\r\n        if action is a function:\r\n        execute the action with target as environment (can be null)\r\n        for lambdafied (inline) actions\r\n\r\n        else if action is a String:\r\n        treat it as function property of target and execute it\r\n        for selector-like actions\r\n    */\r\n    if (this.schedule) {\r\n        this.schedule.isActive = false;\r\n    }\r\n    if (typeof this.target === 'function') {\r\n        if (typeof this.action === 'function') {\r\n            this.target.call(this.environment, this.action.call(), this);\r\n        } else {\r\n            this.target.call(this.environment, this.action, this);\r\n        }\r\n    } else {\r\n        if (typeof this.action === 'function') {\r\n            this.action.call(this.target);\r\n        } else { // assume it's a String\r\n            this.target[this.action]();\r\n        }\r\n    }\r\n};\r\n\r\nTriggerMorph.prototype.triggerDoubleClick = function () {\r\n    // same as trigger() but use doubleClickAction instead of action property\r\n    // note that specifying a doubleClickAction is optional\r\n    if (!this.doubleClickAction) {return; }\r\n    if (this.schedule) {\r\n        this.schedule.isActive = false;\r\n    }\r\n    if (typeof this.target === 'function') {\r\n        if (typeof this.doubleClickAction === 'function') {\r\n            this.target.call(\r\n                this.environment,\r\n                this.doubleClickAction.call(),\r\n                this\r\n            );\r\n        } else {\r\n            this.target.call(this.environment, this.doubleClickAction, this);\r\n        }\r\n    } else {\r\n        if (typeof this.doubleClickAction === 'function') {\r\n            this.doubleClickAction.call(this.target);\r\n        } else { // assume it's a String\r\n            this.target[this.doubleClickAction]();\r\n        }\r\n    }\r\n};\r\n\r\n// TriggerMorph events:\r\n\r\nTriggerMorph.prototype.mouseEnter = function () {\r\n    var contents = this.hint instanceof Function ? this.hint() : this.hint;\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n    if (contents) {\r\n        this.bubbleHelp(contents);\r\n    }\r\n};\r\n\r\nTriggerMorph.prototype.mouseLeave = function () {\r\n    this.image = this.normalImage;\r\n    this.changed();\r\n    if (this.schedule) {\r\n        this.schedule.isActive = false;\r\n    }\r\n    if (this.hint) {\r\n        this.world().hand.destroyTemporaries();\r\n    }\r\n};\r\n\r\nTriggerMorph.prototype.mouseDownLeft = function () {\r\n    this.image = this.pressImage;\r\n    this.changed();\r\n};\r\n\r\nTriggerMorph.prototype.mouseClickLeft = function () {\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n    this.trigger();\r\n};\r\n\r\nTriggerMorph.prototype.mouseDoubleClick = function () {\r\n    this.triggerDoubleClick();\r\n};\r\n\r\nTriggerMorph.prototype.rootForGrab = function () {\r\n    return this.isDraggable ? TriggerMorph.uber.rootForGrab.call(this) : null;\r\n};\r\n\r\n// TriggerMorph bubble help:\r\n\r\nTriggerMorph.prototype.bubbleHelp = function (contents) {\r\n    var world = this.world(),\r\n        myself = this;\r\n    this.schedule = new Animation(\r\n        nop,\r\n        nop,\r\n        0,\r\n        500,\r\n        nop,\r\n        function () {myself.popUpbubbleHelp(contents); }\r\n    );\r\n    world.animations.push(this.schedule);\r\n};\r\n\r\nTriggerMorph.prototype.popUpbubbleHelp = function (contents) {\r\n    new SpeechBubbleMorph(\r\n        localize(contents),\r\n        null,\r\n        null,\r\n        1\r\n    ).popUp(this.world(), this.rightCenter().add(new Point(-8, 0)));\r\n};\r\n\r\n// MenuItemMorph ///////////////////////////////////////////////////////\r\n\r\n// I automatically determine my bounds\r\n\r\nvar MenuItemMorph;\r\n\r\n// MenuItemMorph inherits from TriggerMorph:\r\n\r\nMenuItemMorph.prototype = new TriggerMorph();\r\nMenuItemMorph.prototype.constructor = MenuItemMorph;\r\nMenuItemMorph.uber = TriggerMorph.prototype;\r\n\r\n// MenuItemMorph instance creation:\r\n\r\nfunction MenuItemMorph(\r\n    target,\r\n    action,\r\n    labelString, // can also be a Morph or a Canvas or a tuple: [icon, string]\r\n    fontSize,\r\n    fontStyle,\r\n    environment,\r\n    hint,\r\n    color,\r\n    bold,\r\n    italic,\r\n    doubleClickAction, // optional when used as list morph item\r\n    shortcut // optional string, Morph, Canvas or tuple: [icon, string]\r\n) {\r\n    // additional properties:\r\n    this.shortcutString = shortcut || null;\r\n    this.shortcut = null;\r\n\r\n    // initialize inherited properties:\r\n    this.init(\r\n        target,\r\n        action,\r\n        labelString,\r\n        fontSize,\r\n        fontStyle,\r\n        environment,\r\n        hint,\r\n        color,\r\n        bold,\r\n        italic,\r\n        doubleClickAction\r\n    );\r\n}\r\n\r\nMenuItemMorph.prototype.createLabel = function () {\r\n    var w, h;\r\n    if (this.label) {\r\n        this.label.destroy();\r\n    }\r\n    this.label = this.createLabelPart(this.labelString);\r\n    this.add(this.label);\r\n    w = this.label.width();\r\n    h = this.label.height();\r\n    if (this.shortcut) {\r\n        this.shortcut.destroy();\r\n    }\r\n    if (this.shortcutString) {\r\n        this.shortcut = this.createLabelPart(this.shortcutString);\r\n        w += this.shortcut.width() + 4;\r\n        h = Math.max(h, this.shortcut.height());\r\n        this.add(this.shortcut);\r\n    }\r\n    this.silentSetExtent(new Point(w + 8, h));\r\n    this.fixLayout();\r\n};\r\n\r\nMenuItemMorph.prototype.fixLayout = function () {\r\n    var cntr = this.center();\r\n    this.label.setCenter(cntr);\r\n    this.label.setLeft(this.left() + 4);\r\n    if (this.shortcut) {\r\n        this.shortcut.setCenter(cntr);\r\n        this.shortcut.setRight(this.right() - 4);\r\n    }\r\n};\r\n\r\nMenuItemMorph.prototype.createLabelPart = function (source) {\r\n    var part, icon, lbl;\r\n    if (isString(source)) {\r\n        return this.createLabelString(source);\r\n    }\r\n    if (source instanceof Array) {\r\n        // assume its pattern is: [icon, string]\r\n        part = new Morph();\r\n        part.alpha = 0; // transparent\r\n        icon = this.createIcon(source[0]);\r\n        part.add(icon);\r\n        lbl = this.createLabelString(source[1]);\r\n        part.add(lbl);\r\n        lbl.setCenter(icon.center());\r\n        lbl.setLeft(icon.right() + 4);\r\n        part.bounds = (icon.bounds.merge(lbl.bounds));\r\n        part.drawNew();\r\n        return part;\r\n    }\r\n    // assume it's either a Morph or a Canvas\r\n    return this.createIcon(source);\r\n};\r\n\r\nMenuItemMorph.prototype.createIcon = function (source) {\r\n    // source can be either a Morph or an HTMLCanvasElement\r\n    var icon = new Morph(),\r\n        src;\r\n    icon.image = source instanceof Morph ? source.fullImage() : source;\r\n    // adjust shadow dimensions\r\n    if (source instanceof Morph && source.getShadow()) {\r\n        src = icon.image;\r\n        icon.image = newCanvas(\r\n            source.fullBounds().extent().subtract(\r\n                this.shadowBlur * (useBlurredShadows ? 1 : 2)\r\n            )\r\n        );\r\n        icon.image.getContext('2d').drawImage(src, 0, 0);\r\n    }\r\n    icon.silentSetWidth(icon.image.width);\r\n    icon.silentSetHeight(icon.image.height);\r\n    return icon;\r\n};\r\n\r\nMenuItemMorph.prototype.createLabelString = function (string) {\r\n    var lbl = new TextMorph(\r\n        string,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        this.labelBold,\r\n        this.labelItalic\r\n    );\r\n    lbl.setColor(this.labelColor);\r\n    return lbl;\r\n};\r\n\r\n// MenuItemMorph events:\r\n\r\nMenuItemMorph.prototype.mouseEnter = function () {\r\n    var menu = this.parentThatIsA(MenuMorph);\r\n    if (this.isShowingSubmenu()) {\r\n        return;\r\n    }\r\n    if (menu) {\r\n        menu.closeSubmenu();\r\n    }\r\n    if (!this.isListItem()) {\r\n        this.image = this.highlightImage;\r\n        this.changed();\r\n    }\r\n    if (this.action instanceof MenuMorph) {\r\n        this.delaySubmenu();\r\n    } else if (this.hint) {\r\n        this.bubbleHelp(this.hint);\r\n    }\r\n};\r\n\r\nMenuItemMorph.prototype.mouseLeave = function () {\r\n    if (!this.isListItem()) {\r\n        if (this.isShowingSubmenu()) {\r\n            this.image = this.highlightImage;\r\n        } else {\r\n            this.image = this.normalImage;\r\n        }\r\n        this.changed();\r\n    }\r\n    if (this.schedule) {\r\n        this.schedule.isActive = false;\r\n    }\r\n    if (this.hint) {\r\n        this.world().hand.destroyTemporaries();\r\n    }\r\n};\r\n\r\nMenuItemMorph.prototype.mouseDownLeft = function (pos) {\r\n    if (this.isListItem()) {\r\n        this.parent.unselectAllItems();\r\n        this.escalateEvent('mouseDownLeft', pos);\r\n    }\r\n    this.image = this.pressImage;\r\n    this.changed();\r\n};\r\n\r\nMenuItemMorph.prototype.mouseMove = function () {\r\n    if (this.isListItem()) {\r\n        this.escalateEvent('mouseMove');\r\n    }\r\n};\r\n\r\nMenuItemMorph.prototype.mouseClickLeft = function () {\r\n    if (this.action instanceof MenuMorph) {\r\n        this.popUpSubmenu();\r\n    } else {\r\n        if (!this.isListItem()) {\r\n            this.parent.closeRootMenu();\r\n            this.world().activeMenu = null;\r\n        }\r\n        this.trigger();\r\n    }\r\n};\r\n\r\nMenuItemMorph.prototype.isListItem = function () {\r\n    if (this.parent) {\r\n        return this.parent.isListContents;\r\n    }\r\n    return false;\r\n};\r\n\r\nMenuItemMorph.prototype.isSelectedListItem = function () {\r\n    if (this.isListItem()) {\r\n        return this.image === this.pressImage;\r\n    }\r\n    return false;\r\n};\r\n\r\nMenuItemMorph.prototype.isShowingSubmenu = function () {\r\n    var menu = this.parentThatIsA(MenuMorph);\r\n    if (menu && (this.action instanceof MenuMorph)) {\r\n        return menu.submenu === this.action;\r\n    }\r\n    return false;\r\n};\r\n\r\n// MenuItemMorph submenus:\r\n\r\nMenuItemMorph.prototype.delaySubmenu = function () {\r\n    var world = this.world(),\r\n        myself = this;\r\n    this.schedule = new Animation(\r\n        nop,\r\n        nop,\r\n        0,\r\n        500,\r\n        nop,\r\n        function () {myself.popUpSubmenu(); }\r\n    );\r\n    world.animations.push(this.schedule);\r\n};\r\n\r\nMenuItemMorph.prototype.popUpSubmenu = function () {\r\n    var menu = this.parentThatIsA(MenuMorph);\r\n    if (!(this.action instanceof MenuMorph)) {return; }\r\n    this.action.drawNew();\r\n    this.action.setPosition(this.topRight().subtract(new Point(0, 5)));\r\n    this.action.addShadow(new Point(2, 2), 80);\r\n    this.action.keepWithin(this.world());\r\n    if (this.action.items.length < 1 && !this.action.title) {return; }\r\n    menu.add(this.action);\r\n    menu.submenu = this.action;\r\n    menu.submenu.world = menu.world; // keyboard control\r\n    this.action.fullChanged();\r\n};\r\n\r\n// FrameMorph //////////////////////////////////////////////////////////\r\n\r\n// I clip my submorphs at my bounds\r\n\r\n// Frames inherit from Morph:\r\n\r\nFrameMorph.prototype = new Morph();\r\nFrameMorph.prototype.constructor = FrameMorph;\r\nFrameMorph.uber = Morph.prototype;\r\n\r\nfunction FrameMorph(aScrollFrame) {\r\n    this.init(aScrollFrame);\r\n}\r\n\r\nFrameMorph.prototype.init = function (aScrollFrame) {\r\n    this.scrollFrame = aScrollFrame || null;\r\n\r\n    FrameMorph.uber.init.call(this);\r\n    this.color = new Color(255, 250, 245);\r\n    this.drawNew();\r\n    this.acceptsDrops = true;\r\n\r\n    if (this.scrollFrame) {\r\n        this.isDraggable = false;\r\n        this.noticesTransparentClick = false;\r\n        this.alpha = 0;\r\n    }\r\n};\r\n\r\nFrameMorph.prototype.fullBounds = function () {\r\n    var shadow = this.getShadow();\r\n    if (shadow !== null) {\r\n        return this.bounds.merge(shadow.bounds);\r\n    }\r\n    return this.bounds;\r\n};\r\n\r\nFrameMorph.prototype.fullImage = function () {\r\n    // use only for shadows\r\n    return this.image;\r\n};\r\n\r\nFrameMorph.prototype.fullDrawOn = function (aCanvas, aRect) {\r\n    var rectangle, dirty;\r\n    if (!this.isVisible) {\r\n        return null;\r\n    }\r\n    rectangle = aRect || this.fullBounds();\r\n    dirty = this.bounds.intersect(rectangle);\r\n    if (!dirty.extent().gt(new Point(0, 0))) {\r\n        return null;\r\n    }\r\n    this.drawOn(aCanvas, dirty);\r\n    this.children.forEach(function (child) {\r\n        if (child instanceof ShadowMorph) {\r\n            child.fullDrawOn(aCanvas, rectangle);\r\n        } else {\r\n            child.fullDrawOn(aCanvas, dirty);\r\n        }\r\n    });\r\n};\r\n\r\n// FrameMorph navigation:\r\n\r\nFrameMorph.prototype.topMorphAt = function (point) {\r\n    var i, result;\r\n    if (!(this.isVisible && this.bounds.containsPoint(point))) {\r\n        return null;\r\n    }\r\n    for (i = this.children.length - 1; i >= 0; i -= 1) {\r\n        result = this.children[i].topMorphAt(point);\r\n        if (result) {return result; }\r\n    }\r\n    return this.noticesTransparentClick ||\r\n        !this.isTransparentAt(point) ? this : null;\r\n};\r\n\r\n// FrameMorph scrolling support:\r\n\r\nFrameMorph.prototype.submorphBounds = function () {\r\n    var result = null;\r\n\r\n    if (this.children.length > 0) {\r\n        result = this.children[0].bounds;\r\n        this.children.forEach(function (child) {\r\n            result = result.merge(child.fullBounds());\r\n        });\r\n    }\r\n    return result;\r\n};\r\n\r\nFrameMorph.prototype.keepInScrollFrame = function () {\r\n    if (this.scrollFrame === null) {\r\n        return null;\r\n    }\r\n    if (this.left() > this.scrollFrame.left()) {\r\n        this.moveBy(\r\n            new Point(this.scrollFrame.left() - this.left(), 0)\r\n        );\r\n    }\r\n    if (this.right() < this.scrollFrame.right()) {\r\n        this.moveBy(\r\n            new Point(this.scrollFrame.right() - this.right(), 0)\r\n        );\r\n    }\r\n    if (this.top() > this.scrollFrame.top()) {\r\n        this.moveBy(\r\n            new Point(0, this.scrollFrame.top() - this.top())\r\n        );\r\n    }\r\n    if (this.bottom() < this.scrollFrame.bottom()) {\r\n        this.moveBy(\r\n            0,\r\n            new Point(this.scrollFrame.bottom() - this.bottom(), 0)\r\n        );\r\n    }\r\n};\r\n\r\nFrameMorph.prototype.adjustBounds = function () {\r\n    var subBounds,\r\n        newBounds,\r\n        myself = this;\r\n\r\n    if (this.scrollFrame === null) {\r\n        return null;\r\n    }\r\n\r\n    subBounds = this.submorphBounds();\r\n    if (subBounds && (!this.scrollFrame.isTextLineWrapping)) {\r\n        newBounds = subBounds\r\n            .expandBy(this.scrollFrame.padding)\r\n            .growBy(this.scrollFrame.growth)\r\n            .merge(this.scrollFrame.bounds);\r\n    } else {\r\n        newBounds = this.scrollFrame.bounds.copy();\r\n    }\r\n    if (!this.bounds.eq(newBounds)) {\r\n        this.bounds = newBounds;\r\n        this.drawNew();\r\n        this.keepInScrollFrame();\r\n    }\r\n\r\n    if (this.scrollFrame.isTextLineWrapping) {\r\n        this.children.forEach(function (morph) {\r\n            if (morph instanceof TextMorph) {\r\n                morph.setWidth(myself.width());\r\n                myself.setHeight(\r\n                    Math.max(morph.height(), myself.scrollFrame.height())\r\n                );\r\n            }\r\n        });\r\n    }\r\n\r\n    this.scrollFrame.adjustScrollBars();\r\n};\r\n\r\n// FrameMorph dragging & dropping of contents:\r\n\r\nFrameMorph.prototype.reactToDropOf = function () {\r\n    this.adjustBounds();\r\n};\r\n\r\nFrameMorph.prototype.reactToGrabOf = function () {\r\n    this.adjustBounds();\r\n};\r\n\r\n// FrameMorph menus:\r\n\r\nFrameMorph.prototype.developersMenu = function () {\r\n    var menu = FrameMorph.uber.developersMenu.call(this);\r\n    if (this.children.length > 0) {\r\n        menu.addLine();\r\n        menu.addItem(\r\n            \"move all inside...\",\r\n            'keepAllSubmorphsWithin',\r\n            'keep all submorphs\\nwithin and visible'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\nFrameMorph.prototype.keepAllSubmorphsWithin = function () {\r\n    var myself = this;\r\n    this.children.forEach(function (m) {\r\n        m.keepWithin(myself);\r\n    });\r\n};\r\n\r\n// ScrollFrameMorph ////////////////////////////////////////////////////\r\n\r\nScrollFrameMorph.prototype = new FrameMorph();\r\nScrollFrameMorph.prototype.constructor = ScrollFrameMorph;\r\nScrollFrameMorph.uber = FrameMorph.prototype;\r\n\r\nfunction ScrollFrameMorph(scroller, size, sliderColor) {\r\n    this.init(scroller, size, sliderColor);\r\n}\r\n\r\nScrollFrameMorph.prototype.init = function (scroller, size, sliderColor) {\r\n    var myself = this;\r\n\r\n    ScrollFrameMorph.uber.init.call(this);\r\n    this.scrollBarSize = size || MorphicPreferences.scrollBarSize;\r\n    this.autoScrollTrigger = null;\r\n    this.enableAutoScrolling = true; // change to suppress\r\n    this.isScrollingByDragging = true; // change to suppress\r\n    this.hasVelocity = true; // dto.\r\n    this.padding = 0; // around the scrollable area\r\n    this.growth = 0; // pixels or Point to grow right/left when near edge\r\n    this.isTextLineWrapping = false;\r\n    this.contents = scroller || new FrameMorph(this);\r\n    this.add(this.contents);\r\n    this.hBar = new SliderMorph(\r\n        null, // start\r\n        null, // stop\r\n        null, // value\r\n        null, // size\r\n        'horizontal',\r\n        sliderColor\r\n    );\r\n    this.hBar.setHeight(this.scrollBarSize);\r\n    this.hBar.action = function (num) {\r\n        myself.contents.setPosition(\r\n            new Point(\r\n                myself.left() - num,\r\n                myself.contents.position().y\r\n            )\r\n        );\r\n    };\r\n    this.hBar.isDraggable = false;\r\n    this.add(this.hBar);\r\n    this.vBar = new SliderMorph(\r\n        null, // start\r\n        null, // stop\r\n        null, // value\r\n        null, // size\r\n        'vertical',\r\n        sliderColor\r\n    );\r\n    this.vBar.setWidth(this.scrollBarSize);\r\n    this.vBar.action = function (num) {\r\n        myself.contents.setPosition(\r\n            new Point(\r\n                myself.contents.position().x,\r\n                myself.top() - num\r\n            )\r\n        );\r\n    };\r\n    this.vBar.isDraggable = false;\r\n    this.add(this.vBar);\r\n    this.toolBar = null; // optional slot\r\n};\r\n\r\nScrollFrameMorph.prototype.adjustScrollBars = function () {\r\n    var hWidth = this.width() - this.scrollBarSize,\r\n        vHeight = this.height() - this.scrollBarSize;\r\n\r\n    this.changed();\r\n    if (this.contents.width() > this.width() +\r\n            MorphicPreferences.scrollBarSize) {\r\n        this.hBar.show();\r\n        if (this.hBar.width() !== hWidth) {\r\n            this.hBar.setWidth(hWidth);\r\n        }\r\n\r\n        this.hBar.setPosition(\r\n            new Point(\r\n                this.left(),\r\n                this.bottom() - this.hBar.height()\r\n            )\r\n        );\r\n        this.hBar.start = 0;\r\n        this.hBar.stop = this.contents.width() - this.width();\r\n        this.hBar.size =\r\n            this.width() / this.contents.width() * this.hBar.stop;\r\n        this.hBar.value = this.left() - this.contents.left();\r\n        this.hBar.drawNew();\r\n    } else {\r\n        this.hBar.hide();\r\n    }\r\n\r\n    if (this.contents.height() > this.height() +\r\n            this.scrollBarSize) {\r\n        this.vBar.show();\r\n        if (this.vBar.height() !== vHeight) {\r\n            this.vBar.setHeight(vHeight);\r\n        }\r\n\r\n        this.vBar.setPosition(\r\n            new Point(\r\n                this.right() - this.vBar.width(),\r\n                this.top()\r\n            )\r\n        );\r\n        this.vBar.start = 0;\r\n        this.vBar.stop = this.contents.height() - this.height();\r\n        this.vBar.size =\r\n            this.height() / this.contents.height() * this.vBar.stop;\r\n        this.vBar.value = this.top() - this.contents.top();\r\n        this.vBar.drawNew();\r\n    } else {\r\n        this.vBar.hide();\r\n    }\r\n    this.adjustToolBar();\r\n};\r\n\r\nScrollFrameMorph.prototype.adjustToolBar = function () {\r\n    var padding = 3;\r\n    if (this.toolBar) {\r\n        this.toolBar.setTop(this.top() + padding);\r\n        this.toolBar.setRight(\r\n            (this.vBar.isVisible ? this.vBar.left() : this.right()) - padding\r\n        );\r\n    }\r\n};\r\n\r\nScrollFrameMorph.prototype.addContents = function (aMorph) {\r\n    this.contents.add(aMorph);\r\n    this.contents.adjustBounds();\r\n};\r\n\r\nScrollFrameMorph.prototype.setContents = function (aMorph) {\r\n    this.contents.children.forEach(function (m) {\r\n        m.destroy();\r\n    });\r\n    this.contents.children = [];\r\n    aMorph.setPosition(this.position().add(this.padding + 2));\r\n    this.addContents(aMorph);\r\n};\r\n\r\nScrollFrameMorph.prototype.setExtent = function (aPoint) {\r\n    if (this.isTextLineWrapping) {\r\n        this.contents.setPosition(this.position().copy());\r\n    }\r\n    ScrollFrameMorph.uber.setExtent.call(this, aPoint);\r\n    this.contents.adjustBounds();\r\n};\r\n\r\n// ScrollFrameMorph scrolling by dragging:\r\n\r\nScrollFrameMorph.prototype.scrollX = function (steps) {\r\n    var cl = this.contents.left(),\r\n        l = this.left(),\r\n        cw = this.contents.width(),\r\n        r = this.right(),\r\n        newX;\r\n\r\n    newX = cl + steps;\r\n    if (newX + cw < r) {\r\n        newX = r - cw;\r\n    }\r\n    if (newX > l) {\r\n        newX = l;\r\n    }\r\n    if (newX !== cl) {\r\n        this.contents.setLeft(newX);\r\n    }\r\n};\r\n\r\nScrollFrameMorph.prototype.scrollY = function (steps) {\r\n    var ct = this.contents.top(),\r\n        t = this.top(),\r\n        ch = this.contents.height(),\r\n        b = this.bottom(),\r\n        newY;\r\n\r\n    newY = ct + steps;\r\n    if (newY + ch < b) {\r\n        newY = b - ch;\r\n    }\r\n    if (newY > t) {\r\n        newY = t;\r\n    }\r\n    if (newY !== ct) {\r\n        this.contents.setTop(newY);\r\n    }\r\n};\r\n\r\nScrollFrameMorph.prototype.step = nop;\r\n\r\nScrollFrameMorph.prototype.mouseDownLeft = function (pos) {\r\n    if (!this.isScrollingByDragging) {\r\n        return null;\r\n    }\r\n    var world = this.root(),\r\n        hand = world.hand,\r\n        oldPos = pos,\r\n        myself = this,\r\n        deltaX = 0,\r\n        deltaY = 0,\r\n        friction = 0.8;\r\n\r\n    this.step = function () {\r\n        var newPos;\r\n        if (hand.mouseButton &&\r\n                (hand.children.length === 0) &&\r\n                (myself.bounds.containsPoint(hand.bounds.origin))) {\r\n\r\n            if (hand.grabPosition &&\r\n                (hand.grabPosition.distanceTo(hand.position()) <=\r\n                    MorphicPreferences.grabThreshold)) {\r\n                // still within the grab threshold\r\n                return null;\r\n            }\r\n\r\n            newPos = hand.bounds.origin;\r\n            deltaX = newPos.x - oldPos.x;\r\n            if (deltaX !== 0) {\r\n                myself.scrollX(deltaX);\r\n            }\r\n            deltaY = newPos.y - oldPos.y;\r\n            if (deltaY !== 0) {\r\n                myself.scrollY(deltaY);\r\n            }\r\n            oldPos = newPos;\r\n        } else {\r\n            if (!myself.hasVelocity) {\r\n                myself.step = function () {\r\n                    nop();\r\n                };\r\n            } else {\r\n                if ((Math.abs(deltaX) < 0.5) &&\r\n                        (Math.abs(deltaY) < 0.5)) {\r\n                    myself.step = function () {\r\n                        nop();\r\n                    };\r\n                } else {\r\n                    deltaX = deltaX * friction;\r\n                    myself.scrollX(Math.round(deltaX));\r\n                    deltaY = deltaY * friction;\r\n                    myself.scrollY(Math.round(deltaY));\r\n                }\r\n            }\r\n        }\r\n        this.adjustScrollBars();\r\n    };\r\n};\r\n\r\nScrollFrameMorph.prototype.startAutoScrolling = function () {\r\n    var myself = this,\r\n        inset = MorphicPreferences.scrollBarSize * 3,\r\n        world = this.world(),\r\n        hand,\r\n        inner,\r\n        pos;\r\n\r\n    if (!world) {\r\n        return null;\r\n    }\r\n    hand = world.hand;\r\n    if (!this.autoScrollTrigger) {\r\n        this.autoScrollTrigger = Date.now();\r\n    }\r\n    this.step = function () {\r\n        pos = hand.bounds.origin;\r\n        inner = myself.bounds.insetBy(inset);\r\n        if ((myself.bounds.containsPoint(pos)) &&\r\n                (!(inner.containsPoint(pos))) &&\r\n                (hand.children.length > 0)) {\r\n            myself.autoScroll(pos);\r\n        } else {\r\n            myself.step = function () {\r\n                nop();\r\n            };\r\n            myself.autoScrollTrigger = null;\r\n        }\r\n    };\r\n};\r\n\r\nScrollFrameMorph.prototype.autoScroll = function (pos) {\r\n    var inset, area;\r\n\r\n    if (Date.now() - this.autoScrollTrigger < 500) {\r\n        return null;\r\n    }\r\n\r\n    inset = MorphicPreferences.scrollBarSize * 3;\r\n    area = this.topLeft().extent(new Point(this.width(), inset));\r\n    if (area.containsPoint(pos)) {\r\n        this.scrollY(inset - (pos.y - this.top()));\r\n    }\r\n    area = this.topLeft().extent(new Point(inset, this.height()));\r\n    if (area.containsPoint(pos)) {\r\n        this.scrollX(inset - (pos.x - this.left()));\r\n    }\r\n    area = (new Point(this.right() - inset, this.top()))\r\n        .extent(new Point(inset, this.height()));\r\n    if (area.containsPoint(pos)) {\r\n        this.scrollX(-(inset - (this.right() - pos.x)));\r\n    }\r\n    area = (new Point(this.left(), this.bottom() - inset))\r\n        .extent(new Point(this.width(), inset));\r\n    if (area.containsPoint(pos)) {\r\n        this.scrollY(-(inset - (this.bottom() - pos.y)));\r\n    }\r\n    this.adjustScrollBars();\r\n};\r\n\r\n// ScrollFrameMorph scrolling by editing text:\r\n\r\nScrollFrameMorph.prototype.scrollCursorIntoView = function (morph) {\r\n    var txt = morph.target,\r\n        offset = txt.position().subtract(this.contents.position()),\r\n        ft = this.top() + this.padding,\r\n        fb = this.bottom() - this.padding;\r\n    this.contents.setExtent(txt.extent().add(offset).add(this.padding));\r\n    if (morph.top() < ft) {\r\n        this.contents.setTop(this.contents.top() + ft - morph.top());\r\n        morph.setTop(ft);\r\n    } else if (morph.bottom() > fb) {\r\n        this.contents.setBottom(this.contents.bottom() + fb - morph.bottom());\r\n        morph.setBottom(fb);\r\n    }\r\n    this.adjustScrollBars();\r\n};\r\n\r\n// ScrollFrameMorph events:\r\n\r\nScrollFrameMorph.prototype.mouseScroll = function (y, x) {\r\n    if (y) {\r\n        this.scrollY(y * MorphicPreferences.mouseScrollAmount);\r\n    }\r\n    if (x) {\r\n        this.scrollX(x * MorphicPreferences.mouseScrollAmount);\r\n    }\r\n    this.adjustScrollBars();\r\n};\r\n\r\n// ScrollFrameMorph duplicating:\r\n\r\nScrollFrameMorph.prototype.updateReferences = function (map) {\r\n    var myself = this;\r\n    ScrollFrameMorph.uber.updateReferences.call(this, map);\r\n    if (this.hBar) {\r\n        this.hBar.action = function (num) {\r\n            myself.contents.setPosition(\r\n                new Point(myself.left() - num, myself.contents.position().y)\r\n            );\r\n        };\r\n    }\r\n    if (this.vBar) {\r\n        this.vBar.action = function (num) {\r\n            myself.contents.setPosition(\r\n                new Point(myself.contents.position().x, myself.top() - num)\r\n            );\r\n        };\r\n    }\r\n};\r\n\r\n// ScrollFrameMorph menu:\r\n\r\nScrollFrameMorph.prototype.developersMenu = function () {\r\n    var menu = ScrollFrameMorph.uber.developersMenu.call(this);\r\n    if (this.isTextLineWrapping) {\r\n        menu.addItem(\r\n            \"auto line wrap off...\",\r\n            'toggleTextLineWrapping',\r\n            'turn automatic\\nline wrapping\\noff'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            \"auto line wrap on...\",\r\n            'toggleTextLineWrapping',\r\n            'enable automatic\\nline wrapping'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\nScrollFrameMorph.prototype.toggleTextLineWrapping = function () {\r\n    this.isTextLineWrapping = !this.isTextLineWrapping;\r\n};\r\n\r\n// ListMorph ///////////////////////////////////////////////////////////\r\n\r\nListMorph.prototype = new ScrollFrameMorph();\r\nListMorph.prototype.constructor = ListMorph;\r\nListMorph.uber = ScrollFrameMorph.prototype;\r\n\r\nfunction ListMorph(elements, labelGetter, format, doubleClickAction) {\r\n/*\r\n    passing a format is optional. If the format parameter is specified\r\n    it has to be of the following pattern:\r\n\r\n        [\r\n            [<color>, <single-argument predicate>],\r\n            ['bold', <single-argument predicate>],\r\n            ['italic', <single-argument predicate>],\r\n            ...\r\n        ]\r\n\r\n    multiple conditions can be passed in such a format list, the\r\n    last predicate to evaluate true when given the list element sets\r\n    the given format category (color, bold, italic).\r\n    If no condition is met, the default format (color black, non-bold,\r\n    non-italic) will be assigned.\r\n\r\n    An example of how to use fomats can be found in the InspectorMorph's\r\n    \"markOwnProperties\" mechanism.\r\n*/\r\n    this.init(\r\n        elements || [],\r\n        labelGetter || function (element) {\r\n            if (isString(element)) {\r\n                return element;\r\n            }\r\n            if (element.toSource) {\r\n                return element.toSource();\r\n            }\r\n            return element.toString();\r\n        },\r\n        format || [],\r\n        doubleClickAction // optional callback\r\n    );\r\n}\r\n\r\nListMorph.prototype.init = function (\r\n    elements,\r\n    labelGetter,\r\n    format,\r\n    doubleClickAction\r\n) {\r\n    ListMorph.uber.init.call(this);\r\n\r\n    this.contents.acceptsDrops = false;\r\n    this.color = new Color(255, 255, 255);\r\n    this.hBar.alpha = 0.6;\r\n    this.vBar.alpha = 0.6;\r\n    this.elements = elements || [];\r\n    this.labelGetter = labelGetter;\r\n    this.format = format;\r\n    this.listContents = null;\r\n    this.selected = null; // actual element currently selected\r\n    this.active = null; // menu item representing the selected element\r\n    this.action = null;\r\n    this.doubleClickAction = doubleClickAction || null;\r\n    this.acceptsDrops = false;\r\n    this.buildListContents();\r\n};\r\n\r\nListMorph.prototype.buildListContents = function () {\r\n    var myself = this;\r\n    if (this.listContents) {\r\n        this.listContents.destroy();\r\n    }\r\n    this.listContents = new MenuMorph(\r\n        this.select,\r\n        null,\r\n        this\r\n    );\r\n    if (this.elements.length === 0) {\r\n        this.elements = ['(empty)'];\r\n    }\r\n    this.elements.forEach(function (element) {\r\n        var color = null,\r\n            bold = false,\r\n            italic = false;\r\n\r\n        myself.format.forEach(function (pair) {\r\n            if (pair[1].call(null, element)) {\r\n                if (pair[0] === 'bold') {\r\n                    bold = true;\r\n                } else if (pair[0] === 'italic') {\r\n                    italic = true;\r\n                } else { // assume it's a color\r\n                    color = pair[0];\r\n                }\r\n            }\r\n        });\r\n        myself.listContents.addItem(\r\n            myself.labelGetter(element), // label string\r\n            element, // action\r\n            null, // hint\r\n            color,\r\n            bold,\r\n            italic,\r\n            myself.doubleClickAction\r\n        );\r\n    });\r\n    this.listContents.isListContents = true;\r\n    this.listContents.drawNew();\r\n    this.listContents.setPosition(this.contents.position());\r\n    this.addContents(this.listContents);\r\n};\r\n\r\nListMorph.prototype.select = function (item, trigger) {\r\n    if (isNil(item)) {return; }\r\n    this.selected = item;\r\n    this.active = trigger;\r\n    if (this.action) {\r\n        this.action.call(null, item);\r\n    }\r\n};\r\n\r\nListMorph.prototype.setExtent = function (aPoint) {\r\n    var lb = this.listContents.bounds,\r\n        nb = this.bounds.origin.copy().corner(\r\n            this.bounds.origin.add(aPoint)\r\n        );\r\n\r\n    if (nb.right() > lb.right() && nb.width() <= lb.width()) {\r\n        this.listContents.setRight(nb.right());\r\n    }\r\n    if (nb.bottom() > lb.bottom() && nb.height() <= lb.height()) {\r\n        this.listContents.setBottom(nb.bottom());\r\n    }\r\n    ListMorph.uber.setExtent.call(this, aPoint);\r\n};\r\n\r\nListMorph.prototype.activeIndex = function () {\r\n    return this.listContents.children.indexOf(this.active);\r\n};\r\n\r\nListMorph.prototype.activateIndex = function (idx) {\r\n    var item = this.listContents.children[idx];\r\n    if (!item) {return; }\r\n    item.image = item.pressImage;\r\n    item.changed();\r\n    item.trigger();\r\n};\r\n\r\n// StringFieldMorph ////////////////////////////////////////////////////\r\n\r\n// StringFieldMorph inherit from FrameMorph:\r\n\r\nStringFieldMorph.prototype = new FrameMorph();\r\nStringFieldMorph.prototype.constructor = StringFieldMorph;\r\nStringFieldMorph.uber = FrameMorph.prototype;\r\n\r\nfunction StringFieldMorph(\r\n    defaultContents,\r\n    minWidth,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    isNumeric\r\n) {\r\n    this.init(\r\n        defaultContents || '',\r\n        minWidth || 100,\r\n        fontSize || 12,\r\n        fontStyle || 'sans-serif',\r\n        bold || false,\r\n        italic || false,\r\n        isNumeric\r\n    );\r\n}\r\n\r\nStringFieldMorph.prototype.init = function (\r\n    defaultContents,\r\n    minWidth,\r\n    fontSize,\r\n    fontStyle,\r\n    bold,\r\n    italic,\r\n    isNumeric\r\n) {\r\n    this.defaultContents = defaultContents;\r\n    this.minWidth = minWidth;\r\n    this.fontSize = fontSize;\r\n    this.fontStyle = fontStyle;\r\n    this.isBold = bold;\r\n    this.isItalic = italic;\r\n    this.isNumeric = isNumeric || false;\r\n    this.text = null;\r\n    StringFieldMorph.uber.init.call(this);\r\n    this.color = new Color(255, 255, 255);\r\n    this.isEditable = true;\r\n    this.acceptsDrops = false;\r\n    this.drawNew();\r\n};\r\n\r\nStringFieldMorph.prototype.drawNew = function () {\r\n    var txt;\r\n    txt = this.text ? this.string() : this.defaultContents;\r\n    this.text = null;\r\n    this.children.forEach(function (child) {\r\n        child.destroy();\r\n    });\r\n    this.children = [];\r\n    this.text = new StringMorph(\r\n        txt,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        this.isBold,\r\n        this.isItalic,\r\n        this.isNumeric\r\n    );\r\n\r\n    this.text.isNumeric = this.isNumeric; // for whichever reason...\r\n    this.text.setPosition(this.bounds.origin.copy());\r\n    this.text.isEditable = this.isEditable;\r\n    this.text.isDraggable = false;\r\n    this.text.enableSelecting();\r\n    this.silentSetExtent(\r\n        new Point(\r\n            Math.max(this.width(), this.minWidth),\r\n            this.text.height()\r\n        )\r\n    );\r\n    StringFieldMorph.uber.drawNew.call(this);\r\n    this.add(this.text);\r\n};\r\n\r\nStringFieldMorph.prototype.string = function () {\r\n    return this.text.text;\r\n};\r\n\r\nStringFieldMorph.prototype.mouseClickLeft = function (pos) {\r\n    if (this.isEditable) {\r\n        this.text.edit();\r\n    } else {\r\n        this.escalateEvent('mouseClickLeft', pos);\r\n    }\r\n};\r\n\r\n// BouncerMorph ////////////////////////////////////////////////////////\r\n\r\n// I am a Demo of a stepping custom Morph\r\n\r\nvar BouncerMorph;\r\n\r\n// Bouncers inherit from Morph:\r\n\r\nBouncerMorph.prototype = new Morph();\r\nBouncerMorph.prototype.constructor = BouncerMorph;\r\nBouncerMorph.uber = Morph.prototype;\r\n\r\n// BouncerMorph instance creation:\r\n\r\nfunction BouncerMorph() {\r\n    this.init();\r\n}\r\n\r\n// BouncerMorph initialization:\r\n\r\nBouncerMorph.prototype.init = function (type, speed) {\r\n    BouncerMorph.uber.init.call(this);\r\n    this.fps = 50;\r\n\r\n    // additional properties:\r\n    this.isStopped = false;\r\n    this.type = type || 'vertical';\r\n    if (this.type === 'vertical') {\r\n        this.direction = 'down';\r\n    } else {\r\n        this.direction = 'right';\r\n    }\r\n    this.speed = speed || 1;\r\n};\r\n\r\n// BouncerMorph moving:\r\n\r\nBouncerMorph.prototype.moveUp = function () {\r\n    this.moveBy(new Point(0, -this.speed));\r\n};\r\n\r\nBouncerMorph.prototype.moveDown = function () {\r\n    this.moveBy(new Point(0, this.speed));\r\n};\r\n\r\nBouncerMorph.prototype.moveRight = function () {\r\n    this.moveBy(new Point(this.speed, 0));\r\n};\r\n\r\nBouncerMorph.prototype.moveLeft = function () {\r\n    this.moveBy(new Point(-this.speed, 0));\r\n};\r\n\r\n// BouncerMorph stepping:\r\n\r\nBouncerMorph.prototype.step = function () {\r\n    if (!this.isStopped) {\r\n        if (this.type === 'vertical') {\r\n            if (this.direction === 'down') {\r\n                this.moveDown();\r\n            } else {\r\n                this.moveUp();\r\n            }\r\n            if (this.fullBounds().top() < this.parent.top() &&\r\n                    this.direction === 'up') {\r\n                this.direction = 'down';\r\n            }\r\n            if (this.fullBounds().bottom() > this.parent.bottom() &&\r\n                    this.direction === 'down') {\r\n                this.direction = 'up';\r\n            }\r\n        } else if (this.type === 'horizontal') {\r\n            if (this.direction === 'right') {\r\n                this.moveRight();\r\n            } else {\r\n                this.moveLeft();\r\n            }\r\n            if (this.fullBounds().left() < this.parent.left() &&\r\n                    this.direction === 'left') {\r\n                this.direction = 'right';\r\n            }\r\n            if (this.fullBounds().right() > this.parent.right() &&\r\n                    this.direction === 'right') {\r\n                this.direction = 'left';\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// HandMorph ///////////////////////////////////////////////////////////\r\n\r\n// I represent the Mouse cursor\r\n\r\n// HandMorph inherits from Morph:\r\n\r\nHandMorph.prototype = new Morph();\r\nHandMorph.prototype.constructor = HandMorph;\r\nHandMorph.uber = Morph.prototype;\r\n\r\n// HandMorph instance creation:\r\n\r\nfunction HandMorph(aWorld) {\r\n    this.init(aWorld);\r\n}\r\n\r\n// HandMorph initialization:\r\n\r\nHandMorph.prototype.init = function (aWorld) {\r\n    HandMorph.uber.init.call(this, true);\r\n    this.bounds = new Rectangle();\r\n\r\n    // additional properties:\r\n    this.world = aWorld;\r\n    this.mouseButton = null;\r\n    this.mouseOverList = [];\r\n    this.morphToGrab = null;\r\n    this.grabPosition = null;\r\n    this.grabOrigin = null;\r\n    this.temporaries = [];\r\n    this.touchHoldTimeout = null;\r\n    this.contextMenuEnabled = false;\r\n};\r\n\r\nHandMorph.prototype.changed = function () {\r\n    var b;\r\n    if (this.world !== null) {\r\n        b = this.fullBounds();\r\n        if (!b.extent().eq(new Point())) {\r\n            this.world.broken.push(b.spread());\r\n        }\r\n    }\r\n};\r\n\r\nHandMorph.prototype.fullChanged = HandMorph.prototype.changed;\r\n\r\n// HandMorph navigation:\r\n\r\nHandMorph.prototype.morphAtPointer = function () {\r\n    return this.world.topMorphAt(this.bounds.origin) || this.world;\r\n};\r\n\r\nHandMorph.prototype.allMorphsAtPointer = function () {\r\n    var morphs = this.world.allChildren(),\r\n        myself = this;\r\n    return morphs.filter(function (m) {\r\n        return m.isVisible &&\r\n            m.visibleBounds().containsPoint(myself.bounds.origin);\r\n    });\r\n};\r\n\r\n// HandMorph dragging and dropping:\r\n/*\r\n    drag 'n' drop events, method(arg) -> receiver:\r\n\r\n        prepareToBeGrabbed(handMorph) -> grabTarget\r\n        reactToGrabOf(grabbedMorph) -> oldParent\r\n        wantsDropOf(morphToDrop) ->  newParent\r\n        justDropped(handMorph) -> droppedMorph\r\n        reactToDropOf(droppedMorph, handMorph) -> newParent\r\n*/\r\n\r\nHandMorph.prototype.dropTargetFor = function (aMorph) {\r\n    var target = this.morphAtPointer();\r\n    while (!target.wantsDropOf(aMorph)) {\r\n        target = target.parent;\r\n    }\r\n    return target;\r\n};\r\n\r\nHandMorph.prototype.grab = function (aMorph) {\r\n    var oldParent = aMorph.parent;\r\n    if (aMorph instanceof WorldMorph) {\r\n        return null;\r\n    }\r\n    if (this.children.length === 0) {\r\n        this.world.stopEditing();\r\n        this.grabOrigin = aMorph.situation();\r\n        aMorph.addShadow();\r\n        if (aMorph.prepareToBeGrabbed) {\r\n            aMorph.prepareToBeGrabbed(this);\r\n        }\r\n        aMorph.cachedFullImage = aMorph.fullImageClassic();\r\n        aMorph.cachedFullBounds = aMorph.fullBounds();\r\n        this.add(aMorph);\r\n        this.changed();\r\n        if (oldParent && oldParent.reactToGrabOf) {\r\n            oldParent.reactToGrabOf(aMorph);\r\n        }\r\n    }\r\n};\r\n\r\nHandMorph.prototype.drop = function () {\r\n    var target, morphToDrop;\r\n    if (this.children.length !== 0) {\r\n        morphToDrop = this.children[0];\r\n        target = this.dropTargetFor(morphToDrop);\r\n        target = target.selectForEdit ? target.selectForEdit() : target;\r\n        this.changed();\r\n        target.add(morphToDrop);\r\n        morphToDrop.cachedFullImage = null;\r\n        morphToDrop.cachedFullBounds = null;\r\n        morphToDrop.changed();\r\n        morphToDrop.removeShadow();\r\n        this.children = [];\r\n        this.setExtent(new Point());\r\n        if (morphToDrop.justDropped) {\r\n            morphToDrop.justDropped(this);\r\n        }\r\n        if (target.reactToDropOf) {\r\n            target.reactToDropOf(morphToDrop, this);\r\n        }\r\n    }\r\n};\r\n\r\n// HandMorph event dispatching:\r\n/*\r\n    mouse events:\r\n\r\n        mouseDownLeft\r\n        mouseDownRight\r\n        mouseClickLeft\r\n        mouseClickRight\r\n        mouseDoubleClick\r\n        mouseEnter\r\n        mouseLeave\r\n        mouseEnterDragging\r\n        mouseLeaveDragging\r\n        mouseMove\r\n        mouseScroll\r\n*/\r\n\r\nHandMorph.prototype.processMouseDown = function (event) {\r\n    var morph, actualClick;\r\n\r\n    this.destroyTemporaries();\r\n    this.contextMenuEnabled = true;\r\n    this.morphToGrab = null;\r\n    this.grabPosition = null;\r\n    if (this.children.length !== 0) {\r\n        this.drop();\r\n        this.mouseButton = null;\r\n    } else {\r\n        morph = this.morphAtPointer();\r\n        if (this.world.activeMenu) {\r\n            if (!contains(\r\n                    morph.allParents(),\r\n                    this.world.activeMenu\r\n                )) {\r\n                this.world.activeMenu.destroy();\r\n            } else {\r\n                clearInterval(this.touchHoldTimeout);\r\n            }\r\n        }\r\n        if (this.world.activeHandle) {\r\n            if (morph !== this.world.activeHandle) {\r\n                this.world.activeHandle.destroy();\r\n            }\r\n        }\r\n        if (this.world.cursor) {\r\n            if (morph !== this.world.cursor.target) {\r\n                this.world.stopEditing();\r\n            }\r\n        }\r\n        if (!morph.mouseMove) {\r\n            this.morphToGrab = morph.rootForGrab();\r\n            this.grabPosition = this.bounds.origin.copy();\r\n        }\r\n        if (event.button === 2 || event.ctrlKey) {\r\n            this.mouseButton = 'right';\r\n            actualClick = 'mouseDownRight';\r\n        } else {\r\n            this.mouseButton = 'left';\r\n            actualClick = 'mouseDownLeft';\r\n        }\r\n        while (!morph[actualClick]) {\r\n            morph = morph.parent;\r\n        }\r\n        morph[actualClick](this.bounds.origin);\r\n    }\r\n};\r\n\r\nHandMorph.prototype.processTouchStart = function (event) {\r\n    var myself = this;\r\n    MorphicPreferences.isTouchDevice = true;\r\n    clearInterval(this.touchHoldTimeout);\r\n    if (event.touches.length === 1) {\r\n        this.touchHoldTimeout = setInterval( // simulate mouseRightClick\r\n            function () {\r\n                myself.processMouseDown({button: 2});\r\n                myself.processMouseUp({button: 2});\r\n                event.preventDefault();\r\n                clearInterval(myself.touchHoldTimeout);\r\n            },\r\n            400\r\n        );\r\n        this.processMouseMove(event.touches[0]); // update my position\r\n        this.processMouseDown({button: 0});\r\n        event.preventDefault();\r\n    }\r\n};\r\n\r\nHandMorph.prototype.processTouchMove = function (event) {\r\n    MorphicPreferences.isTouchDevice = true;\r\n    if (event.touches.length === 1) {\r\n        var touch = event.touches[0];\r\n        this.processMouseMove(touch);\r\n        clearInterval(this.touchHoldTimeout);\r\n    }\r\n};\r\n\r\nHandMorph.prototype.processTouchEnd = function (event) {\r\n    MorphicPreferences.isTouchDevice = true;\r\n    clearInterval(this.touchHoldTimeout);\r\n    nop(event);\r\n    this.processMouseUp({button: 0});\r\n};\r\n\r\nHandMorph.prototype.processMouseUp = function () {\r\n    var morph = this.morphAtPointer(),\r\n        context,\r\n        contextMenu,\r\n        expectedClick;\r\n\r\n    this.destroyTemporaries();\r\n    if (this.children.length !== 0) {\r\n        this.drop();\r\n    } else {\r\n        if (this.mouseButton === 'left') {\r\n            expectedClick = 'mouseClickLeft';\r\n        } else {\r\n            expectedClick = 'mouseClickRight';\r\n            if (this.mouseButton && this.contextMenuEnabled) {\r\n                context = morph;\r\n                contextMenu = context.contextMenu();\r\n                while ((!contextMenu) &&\r\n                        context.parent) {\r\n                    context = context.parent;\r\n                    contextMenu = context.contextMenu();\r\n                }\r\n                if (contextMenu) {\r\n                    contextMenu.popUpAtHand(this.world);\r\n                }\r\n            }\r\n        }\r\n        while (!morph[expectedClick]) {\r\n            morph = morph.parent;\r\n        }\r\n        morph[expectedClick](this.bounds.origin);\r\n    }\r\n    this.mouseButton = null;\r\n};\r\n\r\nHandMorph.prototype.processDoubleClick = function () {\r\n    var morph = this.morphAtPointer();\r\n\r\n    this.destroyTemporaries();\r\n    if (this.children.length !== 0) {\r\n        this.drop();\r\n    } else {\r\n        while (morph && !morph.mouseDoubleClick) {\r\n            morph = morph.parent;\r\n        }\r\n        if (morph) {\r\n            morph.mouseDoubleClick(this.bounds.origin);\r\n        }\r\n    }\r\n    this.mouseButton = null;\r\n};\r\n\r\nHandMorph.prototype.processMouseMove = function (event) {\r\n    var pos,\r\n        posInDocument = getDocumentPositionOf(this.world.worldCanvas),\r\n        mouseOverNew,\r\n        myself = this,\r\n        morph,\r\n        topMorph;\r\n\r\n    pos = new Point(\r\n        event.pageX - posInDocument.x,\r\n        event.pageY - posInDocument.y\r\n    );\r\n\r\n    this.setPosition(pos);\r\n\r\n    // determine the new mouse-over-list:\r\n    // mouseOverNew = this.allMorphsAtPointer();\r\n    mouseOverNew = this.morphAtPointer().allParents();\r\n\r\n    if (!this.children.length && this.mouseButton) {\r\n        topMorph = this.morphAtPointer();\r\n        morph = topMorph.rootForGrab();\r\n        if (topMorph.mouseMove) {\r\n            topMorph.mouseMove(pos, this.mouseButton);\r\n            if (this.mouseButton === 'right') {\r\n                this.contextMenuEnabled = false;\r\n            }\r\n        }\r\n\r\n        // if a morph is marked for grabbing, just grab it\r\n        if (this.mouseButton === 'left' &&\r\n                this.morphToGrab &&\r\n                (this.grabPosition.distanceTo(this.bounds.origin) >\r\n                    MorphicPreferences.grabThreshold)) {\r\n            this.setPosition(this.grabPosition);\r\n            if (this.morphToGrab.isDraggable) {\r\n                morph = this.morphToGrab.selectForEdit ?\r\n                        this.morphToGrab.selectForEdit() : this.morphToGrab;\r\n                this.grab(morph);\r\n            } else if (this.morphToGrab.isTemplate) {\r\n                morph = this.morphToGrab.fullCopy();\r\n                morph.isTemplate = false;\r\n                morph.isDraggable = true;\r\n                if (morph.reactToTemplateCopy) {\r\n                    morph.reactToTemplateCopy();\r\n                }\r\n                this.grab(morph);\r\n                this.grabOrigin = this.morphToGrab.situation();\r\n            }\r\n            this.setPosition(pos);\r\n        }\r\n    }\r\n\r\n    this.mouseOverList.forEach(function (old) {\r\n        if (!contains(mouseOverNew, old)) {\r\n            if (old.mouseLeave) {\r\n                old.mouseLeave();\r\n            }\r\n            if (old.mouseLeaveDragging && myself.mouseButton) {\r\n                old.mouseLeaveDragging();\r\n            }\r\n        }\r\n    });\r\n    mouseOverNew.forEach(function (newMorph) {\r\n        if (!contains(myself.mouseOverList, newMorph)) {\r\n            if (newMorph.mouseEnter) {\r\n                newMorph.mouseEnter();\r\n            }\r\n            if (newMorph.mouseEnterDragging && myself.mouseButton) {\r\n                newMorph.mouseEnterDragging();\r\n            }\r\n        }\r\n\r\n        // autoScrolling support:\r\n        if (myself.children.length > 0) {\r\n            if (newMorph instanceof ScrollFrameMorph &&\r\n                    newMorph.enableAutoScrolling &&\r\n                    newMorph.contents.allChildren().some(function (any) {\r\n                        return any.wantsDropOf(myself.children[0]);\r\n                    })\r\n            ) {\r\n                if (!newMorph.bounds.insetBy(\r\n                        MorphicPreferences.scrollBarSize * 3\r\n                    ).containsPoint(myself.bounds.origin)) {\r\n                    newMorph.startAutoScrolling();\r\n                }\r\n            }\r\n        }\r\n    });\r\n    this.mouseOverList = mouseOverNew;\r\n};\r\n\r\nHandMorph.prototype.processMouseScroll = function (event) {\r\n    var morph = this.morphAtPointer();\r\n    while (morph && !morph.mouseScroll) {\r\n        morph = morph.parent;\r\n    }\r\n    if (morph) {\r\n        morph.mouseScroll(\r\n            (event.detail / -3) || (\r\n                Object.prototype.hasOwnProperty.call(\r\n                    event,\r\n                    'wheelDeltaY'\r\n                ) ?\r\n                        event.wheelDeltaY / 120 :\r\n                        event.wheelDelta / 120\r\n            ),\r\n            event.wheelDeltaX / 120 || 0\r\n        );\r\n    }\r\n};\r\n\r\n/*\r\n    drop event:\r\n\r\n        droppedImage\r\n        droppedSVG\r\n        droppedAudio\r\n        droppedText\r\n*/\r\n\r\nHandMorph.prototype.processDrop = function (event) {\r\n/*\r\n    find out whether an external image or audio file was dropped\r\n    onto the world canvas, turn it into an offscreen canvas or audio\r\n    element and dispatch the\r\n\r\n        droppedImage(canvas, name)\r\n        droppedSVG(image, name)\r\n        droppedAudio(audio, name)\r\n\r\n    events to interested Morphs at the mouse pointer\r\n*/\r\n    var files = event instanceof FileList ? event\r\n                : event.target.files || event.dataTransfer.files,\r\n        file,\r\n        url = event.dataTransfer ?\r\n                event.dataTransfer.getData('URL') : null,\r\n        txt = event.dataTransfer ?\r\n                event.dataTransfer.getData('Text/HTML') : null,\r\n        suffix,\r\n        src,\r\n        target = this.morphAtPointer(),\r\n        img = new Image(),\r\n        canvas,\r\n        i;\r\n\r\n    function readSVG(aFile) {\r\n        var pic = new Image(),\r\n            frd = new FileReader();\r\n        while (!target.droppedSVG) {\r\n            target = target.parent;\r\n        }\r\n        pic.onload = function () {\r\n            target.droppedSVG(pic, aFile.name);\r\n        };\r\n        frd = new FileReader();\r\n        frd.onloadend = function (e) {\r\n            pic.src = e.target.result;\r\n        };\r\n        frd.readAsDataURL(aFile);\r\n    }\r\n\r\n    function readImage(aFile) {\r\n        var pic = new Image(),\r\n            frd = new FileReader();\r\n        while (!target.droppedImage) {\r\n            target = target.parent;\r\n        }\r\n        pic.onload = function () {\r\n            canvas = newCanvas(new Point(pic.width, pic.height), true);\r\n            canvas.getContext('2d').drawImage(pic, 0, 0);\r\n            target.droppedImage(canvas, aFile.name);\r\n        };\r\n        frd = new FileReader();\r\n        frd.onloadend = function (e) {\r\n            pic.src = e.target.result;\r\n        };\r\n        frd.readAsDataURL(aFile);\r\n    }\r\n\r\n    function readAudio(aFile) {\r\n        var snd = new Audio(),\r\n            frd = new FileReader();\r\n        while (!target.droppedAudio) {\r\n            target = target.parent;\r\n        }\r\n        frd.onloadend = function (e) {\r\n            snd.src = e.target.result;\r\n            target.droppedAudio(snd, aFile.name);\r\n        };\r\n        frd.readAsDataURL(aFile);\r\n    }\r\n\r\n    function readText(aFile) {\r\n        var frd = new FileReader();\r\n        while (!target.droppedText) {\r\n            target = target.parent;\r\n        }\r\n        frd.onloadend = function (e) {\r\n            target.droppedText(e.target.result, aFile.name);\r\n            \r\n        };\r\n        frd.readAsText(aFile);\r\n        \r\n    }\r\n\r\n    function readBinary(aFile) {\r\n        var frd = new FileReader();\r\n        while (!target.droppedBinary) {\r\n            target = target.parent;\r\n        }\r\n        frd.onloadend = function (e) {\r\n            target.droppedBinary(e.target.result, aFile.name);\r\n        };\r\n        frd.readAsArrayBuffer(aFile);\r\n    }\r\n\r\n    function readURL(url, callback) {\r\n        var request = new XMLHttpRequest();\r\n        request.open('GET', url);\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    callback(request.responseText);\r\n                } else {\r\n                    throw new Error('unable to retrieve ' + url);\r\n                }\r\n            }\r\n        };\r\n        request.send();\r\n    }\r\n\r\n    function parseImgURL(html) {\r\n        var iurl = '',\r\n            idx,\r\n            c,\r\n            start = html.indexOf('<img src=\"');\r\n        if (start === -1) {return null; }\r\n        start += 10;\r\n        for (idx = start; idx < html.length; idx += 1) {\r\n            c = html[idx];\r\n            if (c === '\"') {\r\n                return iurl;\r\n            }\r\n            iurl = iurl.concat(c);\r\n        }\r\n        return null;\r\n    }\r\n\r\n    if (files.length > 0) {\r\n        for (i = 0; i < files.length; i += 1) {\r\n            file = files[i];\r\n            if (file.type.indexOf(\"svg\") !== -1\r\n                    && !MorphicPreferences.rasterizeSVGs) {\r\n                readSVG(file);\r\n            } else if (file.type.indexOf(\"image\") === 0) {\r\n                readImage(file);\r\n            } else if (file.type.indexOf(\"audio\") === 0) {\r\n                readAudio(file);\r\n            } else if (file.type.indexOf(\"text\") === 0) {\r\n                readText(file);\r\n            } else { // assume it's meant to be binary\r\n                readBinary(file);\r\n            }\r\n        }\r\n    } else if (url) {\r\n        suffix = url.slice(url.lastIndexOf('.') + 1).toLowerCase();\r\n        if (\r\n            contains(\r\n                ['gif', 'png', 'jpg', 'jpeg', 'bmp'],\r\n                suffix\r\n            )\r\n        ) {\r\n            while (!target.droppedImage) {\r\n                target = target.parent;\r\n            }\r\n            img = new Image();\r\n            img.onload = function () {\r\n                canvas = newCanvas(new Point(img.width, img.height), true);\r\n                canvas.getContext('2d').drawImage(img, 0, 0);\r\n                target.droppedImage(canvas);\r\n            };\r\n            img.src = url;\r\n        } else if (suffix === 'svg' && !MorphicPreferences.rasterizeSVGs) {\r\n            while (!target.droppedSVG) {\r\n                target = target.parent;\r\n            }\r\n            readURL(\r\n                url,\r\n                function (txt) {\r\n                    var pic = new Image();\r\n                    pic.onload = function () {\r\n                        target.droppedSVG(\r\n                            pic,\r\n                            url.slice(\r\n                                url.lastIndexOf('/') + 1,\r\n                                url.lastIndexOf('.')\r\n                            )\r\n                        );\r\n                    };\r\n                    pic.src = 'data:image/svg+xml;utf8,' +\r\n                        encodeURIComponent(txt);\r\n                }\r\n            );\r\n        }\r\n    } else if (txt) {\r\n        while (!target.droppedImage) {\r\n            target = target.parent;\r\n        }\r\n        img = new Image();\r\n        img.onload = function () {\r\n            canvas = newCanvas(new Point(img.width, img.height), true);\r\n            canvas.getContext('2d').drawImage(img, 0, 0);\r\n            target.droppedImage(canvas);\r\n        };\r\n        src = parseImgURL(txt);\r\n        if (src) {img.src = src; }\r\n    }\r\n};\r\n\r\n// HandMorph tools\r\n\r\nHandMorph.prototype.destroyTemporaries = function () {\r\n\r\n\r\n/*\r\n    temporaries are just an array of morphs which will be deleted upon\r\n    the next mouse click, or whenever another temporary Morph decides\r\n    that it needs to remove them. The primary purpose of temporaries is\r\n    to display tools tips of speech bubble help.\r\n*/\r\n    var myself = this;\r\n    this.temporaries.forEach(function (morph) {\r\n        if (!(morph.isClickable\r\n                && morph.bounds.containsPoint(myself.position()))) {\r\n            morph.destroy();\r\n            myself.temporaries.splice(myself.temporaries.indexOf(morph), 1);\r\n        }\r\n    });\r\n};\r\n\r\n\r\n\r\n// WorldMorph //////////////////////////////////////////////////////////\r\n\r\n// I represent the <canvas> element\r\n\r\n// WorldMorph inherits from FrameMorph:\r\nWorldMorph.prototype = new FrameMorph();\r\nWorldMorph.prototype.constructor = WorldMorph;\r\nWorldMorph.uber = FrameMorph.prototype;\r\n\r\n// WorldMorph instance creation:\r\n\r\nfunction WorldMorph(aCanvas, fillPage) {\r\n\r\n    this.init(aCanvas, fillPage);\r\n}\r\n\r\n// WorldMorph initialization:\r\n\r\nWorldMorph.prototype.init = function (aCanvas, fillPage) {\r\n\r\n    WorldMorph.uber.init.call(this);\r\n    this.color = new Color(205, 205, 205); // (130, 130, 130)\r\n    this.alpha = 1;\r\n    this.bounds = new Rectangle(0, 0, aCanvas.width, aCanvas.height);\r\n    this.drawNew();\r\n    this.isVisible = true;\r\n    this.isDraggable = false;\r\n    this.currentKey = null; // currently pressed key code\r\n    this.worldCanvas = aCanvas;\r\n    this.noticesTransparentClick = true;\r\n\r\n    // additional properties:\r\n    this.stamp = Date.now(); // reference in multi-world setups\r\n    while (this.stamp === Date.now()) {nop(); }\r\n    this.stamp = Date.now();\r\n\r\n    this.useFillPage = fillPage;\r\n    if (this.useFillPage === undefined) {\r\n        this.useFillPage = true;\r\n    }\r\n    this.isDevMode = false;\r\n    this.broken = [];\r\n    this.animations = [];\r\n    this.hand = new HandMorph(this);\r\n    this.keyboardReceiver = null;\r\n    this.cursor = null;\r\n    this.lastEditedText = null;\r\n    this.activeMenu = null;\r\n    this.activeHandle = null;\r\n    this.virtualKeyboard = null;\r\n\r\n    this.initEventListeners();\r\n};\r\n\r\n// World Morph display:\r\n\r\nWorldMorph.prototype.brokenFor = function (aMorph) {\r\n    // private\r\n    var fb = aMorph.fullBounds();\r\n    return this.broken.filter(function (rect) {\r\n        return rect.intersects(fb);\r\n    });\r\n};\r\n\r\nWorldMorph.prototype.fullDrawOn = function (aCanvas, aRect) {\r\n    WorldMorph.uber.fullDrawOn.call(this, aCanvas, aRect);\r\n    this.hand.fullDrawOn(aCanvas, aRect);\r\n};\r\n\r\nWorldMorph.prototype.updateBroken = function () {\r\n    var myself = this;\r\n    this.condenseDamages();\r\n    this.broken.forEach(function (rect) {\r\n        if (rect.extent().gt(new Point(0, 0))) {\r\n            myself.fullDrawOn(myself.worldCanvas, rect);\r\n        }\r\n    });\r\n    this.broken = [];\r\n};\r\n\r\nWorldMorph.prototype.stepAnimations = function () {\r\n    this.animations.forEach(function (anim) {anim.step(); });\r\n    this.animations = this.animations.filter(function (anim) {\r\n        return anim.isActive;\r\n    });\r\n};\r\n\r\nWorldMorph.prototype.condenseDamages = function () {\r\n    // collapse clustered damaged rectangles into their unions,\r\n    // thereby reducing the array of brokens to a manageable size\r\n\r\n    function condense(src) {\r\n        var trgt = [], hit;\r\n        src.forEach(function (rect) {\r\n            hit = detect(\r\n                trgt,\r\n                function (each) {return each.isNearTo(rect, 20); }\r\n            );\r\n            if (hit) {\r\n                hit.mergeWith(rect);\r\n            } else {\r\n                trgt.push(rect);\r\n            }\r\n        });\r\n        return trgt;\r\n    }\r\n\r\n    var again = true, size = this.broken.length;\r\n    while (again) {\r\n        this.broken = condense(this.broken);\r\n        again = (this.broken.length < size);\r\n        size = this.broken.length;\r\n    }\r\n};\r\n\r\nWorldMorph.prototype.doOneCycle = function () {\r\n    this.stepFrame();\r\n    this.stepAnimations();\r\n    this.updateBroken();\r\n};\r\n\r\n// Wiquid : Resize Canvas respecting proportionality\r\n// Change clientHeight and Width but keep same proportion for this.worldCanvas.style.width / height\r\n\r\nWorldMorph.prototype.fillPage = function () {\r\n    var clientHeight = window.innerHeight, //Wiquid : Here example /2\r\n        clientWidth = window.innerWidth,   //Wiquid : Here\r\n        myself = this;\r\n\r\n    clientHeight = clientHeight * 0.9; //xdone\r\n    clientWidth  = clientWidth *0.7; //xdone\r\n\r\n    this.worldCanvas.style.position = \"relative\";\r\n    this.worldCanvas.style.left = \"0px\";\r\n    this.worldCanvas.style.right = \"0px\";\r\n   // this.worldCanvas.style.width = \"100%\";  //Wiquid : Here example : 50%\r\n   // this.worldCanvas.style.height = \"100%\"; //Wiquid : Here\r\n\r\n    if (document.documentElement.scrollTop) {\r\n        // scrolled down b/c of viewport scaling\r\n        clientHeight = document.documentElement.clientHeight;\r\n    }\r\n    if (document.documentElement.scrollLeft) {\r\n        // scrolled left b/c of viewport scaling\r\n        clientWidth = document.documentElement.clientWidth;\r\n    }\r\n    if (this.worldCanvas.width !== clientWidth) {\r\n        this.worldCanvas.width = clientWidth;\r\n        this.setWidth(clientWidth);\r\n    }\r\n    if (this.worldCanvas.height !== clientHeight) {\r\n        this.worldCanvas.height = clientHeight;\r\n        this.setHeight(clientHeight);\r\n    }\r\n    this.children.forEach(function (child) {\r\n        if (child.reactToWorldResize) {\r\n            child.reactToWorldResize(myself.bounds.copy());\r\n        }\r\n    });\r\n};\r\n\r\n// WorldMorph global pixel access:\r\n\r\nWorldMorph.prototype.getGlobalPixelColor = function (point) {\r\n    // answer the color at the given point.\r\n\r\n/*\r\n    // original method, now deprecated as of 4/4/2017 because Chrome\r\n    // \"taints\" the on-screen canvas as soon as its image data is\r\n    // requested, significantly slowing down subsequent blittings\r\n\r\n    var dta = this.worldCanvas.getContext('2d').getImageData(\r\n        point.x,\r\n        point.y,\r\n        1,\r\n        1\r\n    ).data;\r\n    return new Color(dta[0], dta[1], dta[2]);\r\n*/\r\n\r\n    var clr = this.hand.morphAtPointer().getPixelColor(this.hand.position());\r\n    // IMPORTANT:\r\n    // all callers of getGlobalPixelColor should make provisions for retina\r\n    // display support, which gets null-pixels interlaced with non-null ones:\r\n    // if (!clr.a) {/* ignore */ }\r\n    return clr;\r\n};\r\n\r\n// WorldMorph events:\r\n\r\nWorldMorph.prototype.initVirtualKeyboard = function () {\r\n    var myself = this;\r\n\r\n    if (this.virtualKeyboard) {\r\n        document.body.removeChild(this.virtualKeyboard);\r\n        this.virtualKeyboard = null;\r\n    }\r\n    if (!MorphicPreferences.isTouchDevice\r\n            || !MorphicPreferences.useVirtualKeyboard) {\r\n        return;\r\n    }\r\n    this.virtualKeyboard = document.createElement(\"input\");\r\n    this.virtualKeyboard.type = \"text\";\r\n    this.virtualKeyboard.style.color = \"transparent\";\r\n    this.virtualKeyboard.style.backgroundColor = \"transparent\";\r\n    this.virtualKeyboard.style.border = \"none\";\r\n    this.virtualKeyboard.style.outline = \"none\";\r\n    this.virtualKeyboard.style.position = \"absolute\";\r\n    this.virtualKeyboard.style.top = \"0px\";\r\n    this.virtualKeyboard.style.left = \"0px\";\r\n    this.virtualKeyboard.style.width = \"0px\";\r\n    this.virtualKeyboard.style.height = \"0px\";\r\n    this.virtualKeyboard.autocapitalize = \"none\"; // iOS specific\r\n    document.body.appendChild(this.virtualKeyboard);\r\n\r\n    this.virtualKeyboard.addEventListener(\r\n        \"keydown\",\r\n        function (event) {\r\n            // remember the keyCode in the world's currentKey property\r\n            myself.currentKey = event.keyCode;\r\n            if (myself.keyboardReceiver) {\r\n                myself.keyboardReceiver.processKeyDown(event);\r\n            }\r\n            // supress backspace override\r\n            if (event.keyCode === 8) {\r\n                event.preventDefault();\r\n            }\r\n            // supress tab override and make sure tab gets\r\n            // received by all browsers\r\n            if (event.keyCode === 9) {\r\n                if (myself.keyboardReceiver) {\r\n                    myself.keyboardReceiver.processKeyPress(event);\r\n                }\r\n                event.preventDefault();\r\n            }\r\n        },\r\n        false\r\n    );\r\n\r\n    this.virtualKeyboard.addEventListener(\r\n        \"keyup\",\r\n        function (event) {\r\n            // flush the world's currentKey property\r\n            myself.currentKey = null;\r\n            // dispatch to keyboard receiver\r\n            if (myself.keyboardReceiver) {\r\n                if (myself.keyboardReceiver.processKeyUp) {\r\n                    myself.keyboardReceiver.processKeyUp(event);\r\n                }\r\n            }\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    this.virtualKeyboard.addEventListener(\r\n        \"keypress\",\r\n        function (event) {\r\n            if (myself.keyboardReceiver) {\r\n                myself.keyboardReceiver.processKeyPress(event);\r\n            }\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n};\r\n\r\nWorldMorph.prototype.initEventListeners = function () {\r\n    var canvas = this.worldCanvas, myself = this;\r\n\r\n    if (myself.useFillPage) {\r\n        myself.fillPage();\r\n    } else {\r\n        this.changed();\r\n    }\r\n\r\n    canvas.addEventListener(\r\n        \"mousedown\",\r\n        function (event) {\r\n            event.preventDefault();\r\n            canvas.focus();\r\n            myself.hand.processMouseDown(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"touchstart\",\r\n        function (event) {\r\n            myself.hand.processTouchStart(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"mouseup\",\r\n        function (event) {\r\n            event.preventDefault();\r\n            myself.hand.processMouseUp(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"dblclick\",\r\n        function (event) {\r\n            event.preventDefault();\r\n            myself.hand.processDoubleClick(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"touchend\",\r\n        function (event) {\r\n            myself.hand.processTouchEnd(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"mousemove\",\r\n        function (event) {\r\n            myself.hand.processMouseMove(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"touchmove\",\r\n        function (event) {\r\n            myself.hand.processTouchMove(event);\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"contextmenu\",\r\n        function (event) {\r\n            // suppress context menu for Mac-Firefox\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"keydown\",\r\n        function (event) {\r\n            // remember the keyCode in the world's currentKey property\r\n            myself.currentKey = event.keyCode;\r\n            if (myself.keyboardReceiver) {\r\n                myself.keyboardReceiver.processKeyDown(event);\r\n            }\r\n            // supress backspace override\r\n            if (event.keyCode === 8) {\r\n                event.preventDefault();\r\n            }\r\n            // supress tab override and make sure tab gets\r\n            // received by all browsers\r\n            if (event.keyCode === 9) {\r\n                if (myself.keyboardReceiver) {\r\n                    myself.keyboardReceiver.processKeyPress(event);\r\n                }\r\n                event.preventDefault();\r\n            }\r\n            if ((event.ctrlKey && (!event.altKey) || event.metaKey) &&\r\n                    (event.keyCode !== 86)) { // allow pasting-in\r\n                event.preventDefault();\r\n            }\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"keyup\",\r\n        function (event) {\r\n            // flush the world's currentKey property\r\n            myself.currentKey = null;\r\n            // dispatch to keyboard receiver\r\n            if (myself.keyboardReceiver) {\r\n                if (myself.keyboardReceiver.processKeyUp) {\r\n                    myself.keyboardReceiver.processKeyUp(event);\r\n                }\r\n            }\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener(\r\n        \"keypress\",\r\n        function (event) {\r\n            if (myself.keyboardReceiver) {\r\n                myself.keyboardReceiver.processKeyPress(event);\r\n            }\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    canvas.addEventListener( // Safari, Chrome\r\n        \"mousewheel\",\r\n        function (event) {\r\n            myself.hand.processMouseScroll(event);\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n    canvas.addEventListener( // Firefox\r\n        \"DOMMouseScroll\",\r\n        function (event) {\r\n            myself.hand.processMouseScroll(event);\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    document.body.addEventListener(\r\n        \"paste\",\r\n        function (event) {\r\n            var txt = event.clipboardData.getData(\"Text\");\r\n            if (txt && myself.cursor) {\r\n                myself.cursor.insert(txt);\r\n            }\r\n        },\r\n        false\r\n    );\r\n\r\n    window.addEventListener(\r\n        \"dragover\",\r\n        function (event) {\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n    window.addEventListener(\r\n        \"drop\",\r\n        function (event) {\r\n            myself.hand.processDrop(event);\r\n            event.preventDefault();\r\n        },\r\n        false\r\n    );\r\n\r\n    window.addEventListener(\r\n        \"resize\",\r\n        function () {\r\n            if (myself.useFillPage) {\r\n                myself.fillPage();\r\n            }\r\n        },\r\n        false\r\n    );\r\n};\r\n\r\nWorldMorph.prototype.mouseDownLeft = nop;\r\n\r\nWorldMorph.prototype.mouseClickLeft = nop;\r\n\r\nWorldMorph.prototype.mouseDownRight = nop;\r\n\r\nWorldMorph.prototype.mouseClickRight = nop;\r\n\r\nWorldMorph.prototype.wantsDropOf = function () {\r\n    // allow handle drops if any drops are allowed\r\n    return this.acceptsDrops;\r\n};\r\n\r\nWorldMorph.prototype.droppedImage = function () {\r\n    return null;\r\n};\r\n\r\nWorldMorph.prototype.droppedSVG = function () {\r\n    return null;\r\n};\r\n\r\n// WorldMorph text field tabbing:\r\n\r\nWorldMorph.prototype.nextTab = function (editField) {\r\n    var next = this.nextEntryField(editField);\r\n    if (next) {\r\n        editField.clearSelection();\r\n        next.selectAll();\r\n        next.edit();\r\n    }\r\n};\r\n\r\nWorldMorph.prototype.previousTab = function (editField) {\r\n    var prev = this.previousEntryField(editField);\r\n    if (prev) {\r\n        editField.clearSelection();\r\n        prev.selectAll();\r\n        prev.edit();\r\n    }\r\n};\r\n\r\n// WorldMorph menu:\r\n\r\nWorldMorph.prototype.contextMenu = function () {\r\n    var menu;\r\n\r\n    if (this.isDevMode) {\r\n        menu = new MenuMorph(this, this.constructor.name ||\r\n            this.constructor.toString().split(' ')[1].split('(')[0]);\r\n    } else {\r\n        menu = new MenuMorph(this, 'Morphic');\r\n    }\r\n    if (this.isDevMode) {\r\n        menu.addItem(\"demo...\", 'userCreateMorph', 'sample morphs');\r\n        menu.addLine();\r\n        menu.addItem(\"hide all...\", 'hideAll');\r\n        menu.addItem(\"show all...\", 'showAllHiddens');\r\n        menu.addItem(\r\n            \"move all inside...\",\r\n            'keepAllSubmorphsWithin',\r\n            'keep all submorphs\\nwithin and visible'\r\n        );\r\n        menu.addItem(\r\n            \"inspect...\",\r\n            'inspect',\r\n            'open a window on\\nall properties'\r\n        );\r\n        menu.addItem(\r\n            \"screenshot...\",\r\n            function () {\r\n                window.open(this.fullImageClassic().toDataURL());\r\n            },\r\n            'open a new window\\nwith a picture of this morph'\r\n        );\r\n        menu.addLine();\r\n        menu.addItem(\r\n            \"restore display\",\r\n            'changed',\r\n            'redraw the\\nscreen once'\r\n        );\r\n        menu.addItem(\r\n            \"fill page...\",\r\n            'fillPage',\r\n            'let the World automatically\\nadjust to browser resizing'\r\n        );\r\n        if (useBlurredShadows) {\r\n            menu.addItem(\r\n                \"sharp shadows...\",\r\n                'toggleBlurredShadows',\r\n                'sharp drop shadows\\nuse for old browsers'\r\n            );\r\n        } else {\r\n            menu.addItem(\r\n                \"blurred shadows...\",\r\n                'toggleBlurredShadows',\r\n                'blurry shades,\\n use for new browsers'\r\n            );\r\n        }\r\n        menu.addItem(\r\n            \"color...\",\r\n            function () {\r\n                this.pickColor(\r\n                    menu.title + localize('\\ncolor:'),\r\n                    this.setColor,\r\n                    this,\r\n                    this.color\r\n                );\r\n            },\r\n            'choose the World\\'s\\nbackground color'\r\n        );\r\n        if (MorphicPreferences === standardSettings) {\r\n            menu.addItem(\r\n                \"touch screen settings\",\r\n                'togglePreferences',\r\n                'bigger menu fonts\\nand sliders'\r\n            );\r\n        } else {\r\n            menu.addItem(\r\n                \"standard settings\",\r\n                'togglePreferences',\r\n                'smaller menu fonts\\nand sliders'\r\n            );\r\n        }\r\n        menu.addLine();\r\n    }\r\n    if (this.isDevMode) {\r\n        menu.addItem(\r\n            \"user mode...\",\r\n            'toggleDevMode',\r\n            'disable developers\\'\\ncontext menus'\r\n        );\r\n    } else {\r\n        menu.addItem(\"development mode...\", 'toggleDevMode');\r\n    }\r\n    menu.addItem(\"about morphic.js...\", 'about');\r\n    return menu;\r\n};\r\n\r\nWorldMorph.prototype.userCreateMorph = function () {\r\n    var myself = this, menu, newMorph;\r\n\r\n    function create(aMorph) {\r\n        aMorph.isDraggable = true;\r\n        aMorph.pickUp(myself);\r\n    }\r\n\r\n    menu = new MenuMorph(this, 'make a morph');\r\n    menu.addItem('rectangle', function () {\r\n        create(new Morph());\r\n    });\r\n    menu.addItem('box', function () {\r\n        create(new BoxMorph());\r\n    });\r\n    menu.addItem('circle box', function () {\r\n        create(new CircleBoxMorph());\r\n    });\r\n    menu.addLine();\r\n    menu.addItem('slider', function () {\r\n        create(new SliderMorph());\r\n    });\r\n    menu.addItem('frame', function () {\r\n        newMorph = new FrameMorph();\r\n        newMorph.setExtent(new Point(350, 250));\r\n        create(newMorph);\r\n    });\r\n    menu.addItem('scroll frame', function () {\r\n        newMorph = new ScrollFrameMorph();\r\n        newMorph.contents.acceptsDrops = true;\r\n        newMorph.contents.adjustBounds();\r\n        newMorph.setExtent(new Point(350, 250));\r\n        create(newMorph);\r\n    });\r\n    menu.addItem('handle', function () {\r\n        create(new HandleMorph());\r\n    });\r\n    menu.addLine();\r\n    menu.addItem('string', function () {\r\n        newMorph = new StringMorph('Hello, World!');\r\n        newMorph.isEditable = true;\r\n        create(newMorph);\r\n    });\r\n    menu.addItem('text', function () {\r\n        newMorph = new TextMorph(\r\n            \"Ich wei\\u00DF nicht, was soll es bedeuten, dass ich so \" +\r\n                \"traurig bin, ein M\\u00E4rchen aus uralten Zeiten, das \" +\r\n                \"kommt mir nicht aus dem Sinn. Die Luft ist k\\u00FChl \" +\r\n                \"und es dunkelt, und ruhig flie\\u00DFt der Rhein; der \" +\r\n                \"Gipfel des Berges funkelt im Abendsonnenschein. \" +\r\n                \"Die sch\\u00F6nste Jungfrau sitzet dort oben wunderbar, \" +\r\n                \"ihr gold'nes Geschmeide blitzet, sie k\\u00E4mmt ihr \" +\r\n                \"goldenes Haar, sie k\\u00E4mmt es mit goldenem Kamme, \" +\r\n                \"und singt ein Lied dabei; das hat eine wundersame, \" +\r\n                \"gewalt'ge Melodei. Den Schiffer im kleinen \" +\r\n                \"Schiffe, ergreift es mit wildem Weh; er schaut \" +\r\n                \"nicht die Felsenriffe, er schaut nur hinauf in \" +\r\n                \"die H\\u00F6h'. Ich glaube, die Wellen verschlingen \" +\r\n                \"am Ende Schiffer und Kahn, und das hat mit ihrem \" +\r\n                \"Singen, die Loreley getan.\"\r\n        );\r\n        newMorph.isEditable = true;\r\n        newMorph.maxWidth = 300;\r\n        newMorph.drawNew();\r\n        create(newMorph);\r\n    });\r\n    menu.addItem('speech bubble', function () {\r\n        newMorph = new SpeechBubbleMorph('Hello, World!');\r\n        create(newMorph);\r\n    });\r\n    menu.addLine();\r\n    menu.addItem('gray scale palette', function () {\r\n        create(new GrayPaletteMorph());\r\n    });\r\n    menu.addItem('color palette', function () {\r\n        create(new ColorPaletteMorph());\r\n    });\r\n    menu.addItem('color picker', function () {\r\n        create(new ColorPickerMorph());\r\n    });\r\n    menu.addLine();\r\n    menu.addItem('sensor demo', function () {\r\n        newMorph = new MouseSensorMorph();\r\n        newMorph.setColor(new Color(230, 200, 100));\r\n        newMorph.edge = 35;\r\n        newMorph.border = 15;\r\n        newMorph.borderColor = new Color(200, 100, 50);\r\n        newMorph.alpha = 0.2;\r\n        newMorph.setExtent(new Point(100, 100));\r\n        create(newMorph);\r\n    });\r\n    menu.addItem('animation demo', function () {\r\n        var foo, bar, baz, garply, fred;\r\n\r\n        foo = new BouncerMorph();\r\n        foo.setPosition(new Point(50, 20));\r\n        foo.setExtent(new Point(300, 200));\r\n        foo.alpha = 0.9;\r\n        foo.speed = 3;\r\n\r\n        bar = new BouncerMorph();\r\n        bar.setColor(new Color(50, 50, 50));\r\n        bar.setPosition(new Point(80, 80));\r\n        bar.setExtent(new Point(80, 250));\r\n        bar.type = 'horizontal';\r\n        bar.direction = 'right';\r\n        bar.alpha = 0.9;\r\n        bar.speed = 5;\r\n\r\n        baz = new BouncerMorph();\r\n        baz.setColor(new Color(20, 20, 20));\r\n        baz.setPosition(new Point(90, 140));\r\n        baz.setExtent(new Point(40, 30));\r\n        baz.type = 'horizontal';\r\n        baz.direction = 'right';\r\n        baz.speed = 3;\r\n\r\n        garply = new BouncerMorph();\r\n        garply.setColor(new Color(200, 20, 20));\r\n        garply.setPosition(new Point(90, 140));\r\n        garply.setExtent(new Point(20, 20));\r\n        garply.type = 'vertical';\r\n        garply.direction = 'up';\r\n        garply.speed = 8;\r\n\r\n        fred = new BouncerMorph();\r\n        fred.setColor(new Color(20, 200, 20));\r\n        fred.setPosition(new Point(120, 140));\r\n        fred.setExtent(new Point(20, 20));\r\n        fred.type = 'vertical';\r\n        fred.direction = 'down';\r\n        fred.speed = 4;\r\n\r\n        bar.add(garply);\r\n        bar.add(baz);\r\n        foo.add(fred);\r\n        foo.add(bar);\r\n\r\n        create(foo);\r\n    });\r\n    menu.addItem('pen', function () {\r\n        create(new PenMorph());\r\n    });\r\n    if (myself.customMorphs) {\r\n        menu.addLine();\r\n        myself.customMorphs().forEach(function (morph) {\r\n            menu.addItem(morph.toString(), function () {\r\n                create(morph);\r\n            });\r\n        });\r\n    }\r\n    menu.popUpAtHand(this);\r\n};\r\n\r\nWorldMorph.prototype.toggleDevMode = function () {\r\n    this.isDevMode = !this.isDevMode;\r\n};\r\n\r\nWorldMorph.prototype.hideAll = function () {\r\n    this.children.forEach(function (child) {\r\n        child.hide();\r\n    });\r\n};\r\n\r\nWorldMorph.prototype.showAllHiddens = function () {\r\n    this.forAllChildren(function (child) {\r\n        if (!child.isVisible) {\r\n            child.show();\r\n        }\r\n    });\r\n};\r\n\r\nWorldMorph.prototype.about = function () {\r\n    var versions = '', module;\r\n\r\n    for (module in modules) {\r\n        if (Object.prototype.hasOwnProperty.call(modules, module)) {\r\n            versions += ('\\n' + module + ' (' + modules[module] + ')');\r\n        }\r\n    }\r\n    if (versions !== '') {\r\n        versions = '\\n\\nmodules:\\n\\n' +\r\n            'morphic (' + morphicVersion + ')' +\r\n            versions;\r\n    }\r\n\r\n    this.inform(\r\n        'morphic.js\\n\\n' +\r\n            'a lively Web GUI\\ninspired by Squeak\\n' +\r\n            morphicVersion +\r\n            '\\n\\nwritten by Jens M\\u00F6nig\\njens@moenig.org' +\r\n            versions\r\n    );\r\n};\r\n\r\nWorldMorph.prototype.edit = function (aStringOrTextMorph) {\r\n    var pos = getDocumentPositionOf(this.worldCanvas);\r\n\r\n    if (!aStringOrTextMorph.isEditable) {\r\n        return null;\r\n    }\r\n    if (this.cursor) {\r\n        this.cursor.destroy();\r\n    }\r\n    this.cursor = new CursorMorph(aStringOrTextMorph);\r\n    aStringOrTextMorph.parent.add(this.cursor);\r\n    this.keyboardReceiver = this.cursor;\r\n\r\n    this.initVirtualKeyboard();\r\n    if (MorphicPreferences.isTouchDevice\r\n            && MorphicPreferences.useVirtualKeyboard) {\r\n        this.virtualKeyboard.style.top = this.cursor.top() + pos.y + \"px\";\r\n        this.virtualKeyboard.style.left = this.cursor.left() + pos.x + \"px\";\r\n        this.virtualKeyboard.focus();\r\n    }\r\n\r\n    if (MorphicPreferences.useSliderForInput) {\r\n        if (!aStringOrTextMorph.parentThatIsA(MenuMorph)) {\r\n            this.slide(aStringOrTextMorph);\r\n        }\r\n    }\r\n\r\n    if (this.lastEditedText !== aStringOrTextMorph) {\r\n        aStringOrTextMorph.escalateEvent('freshTextEdit', aStringOrTextMorph);\r\n    }\r\n    this.lastEditedText = aStringOrTextMorph;\r\n};\r\n\r\nWorldMorph.prototype.slide = function (aStringOrTextMorph) {\r\n    // display a slider for numeric text entries\r\n    var val = parseFloat(aStringOrTextMorph.text),\r\n        menu,\r\n        slider;\r\n\r\n    if (isNaN(val)) {\r\n        val = 0;\r\n    }\r\n    menu = new MenuMorph();\r\n    slider = new SliderMorph(\r\n        val - 25,\r\n        val + 25,\r\n        val,\r\n        10,\r\n        'horizontal'\r\n    );\r\n    slider.alpha = 1;\r\n    slider.color = new Color(225, 225, 225);\r\n    slider.button.color = menu.borderColor;\r\n    slider.button.highlightColor = slider.button.color.copy();\r\n    slider.button.highlightColor.b += 100;\r\n    slider.button.pressColor = slider.button.color.copy();\r\n    slider.button.pressColor.b += 150;\r\n    slider.silentSetHeight(MorphicPreferences.scrollBarSize);\r\n    slider.silentSetWidth(MorphicPreferences.menuFontSize * 10);\r\n    slider.drawNew();\r\n    slider.action = function (num) {\r\n        aStringOrTextMorph.changed();\r\n        aStringOrTextMorph.text = Math.round(num).toString();\r\n        aStringOrTextMorph.drawNew();\r\n        aStringOrTextMorph.changed();\r\n        aStringOrTextMorph.escalateEvent(\r\n            'reactToSliderEdit',\r\n            aStringOrTextMorph\r\n        );\r\n    };\r\n    menu.items.push(slider);\r\n    menu.popup(this, aStringOrTextMorph.bottomLeft().add(new Point(0, 5)));\r\n};\r\n\r\nWorldMorph.prototype.stopEditing = function () {\r\n    if (this.cursor) {\r\n        this.cursor.target.escalateEvent('reactToEdit', this.cursor.target);\r\n        this.cursor.target.clearSelection();\r\n        this.cursor.destroy();\r\n        this.cursor = null;\r\n    }\r\n    if (this.keyboardReceiver && this.keyboardReceiver.stopEditing) {\r\n    \tthis.keyboardReceiver.stopEditing();\r\n    }\r\n    this.keyboardReceiver = null;\r\n    if (this.virtualKeyboard) {\r\n        this.virtualKeyboard.blur();\r\n        document.body.removeChild(this.virtualKeyboard);\r\n        this.virtualKeyboard = null;\r\n    }\r\n    this.lastEditedText = null;\r\n    this.worldCanvas.focus();\r\n};\r\n\r\nWorldMorph.prototype.toggleBlurredShadows = function () {\r\n    useBlurredShadows = !useBlurredShadows;\r\n};\r\n\r\nWorldMorph.prototype.togglePreferences = function () {\r\n    if (MorphicPreferences === standardSettings) {\r\n        MorphicPreferences = touchScreenSettings;\r\n    } else {\r\n        MorphicPreferences = standardSettings;\r\n    }\r\n};\r\n\r\n\r\n//fin de MORPHIC\r\n\r\n/*\r\n\r\n    widgets.js\r\n\r\n    additional GUI elements for morphic.js\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs blocks.js and objects.js\r\n\r\n\r\n    credits\r\n    -------\r\n    Lucas Karahadian contributed a first prototype of the piano keyboard\r\n\r\n\r\n    I. hierarchy\r\n    -------------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n    Morph*\r\n        AlignmentMorph\r\n        DialogBoxMorph\r\n        InputFieldMorph\r\n    TriggerMorph*\r\n        MenuItemMorph*\r\n            PianoKeyMorph\r\n        PushButtonMorph\r\n            ToggleButtonMorph\r\n                TabMorph\r\n            ToggleMorph\r\n        ToggleElementMorph\r\n    MenuMorph*\r\n        PianoMenuMorph\r\n\r\n    * from Morphic.js\r\n\r\n\r\n    II. toc\r\n    -------\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n    PushButtonMorph\r\n    ToggleButtonMorph\r\n    TabMorph\r\n    ToggleMorph\r\n    ToggleElementMorph\r\n    DialogBoxMorph\r\n    AlignmentMorph\r\n    InputFieldMorph\r\n    PianoMenuMorph\r\n    PianoKeyMorph\r\n\r\n*/\r\n\r\n// Global settings /////////////////////////////////////////////////////\r\n\r\n/*global TriggerMorph, modules, Color, Point, BoxMorph, radians,\r\nnewCanvas, StringMorph, Morph, TextMorph, nop, detect, StringFieldMorph,\r\nHTMLCanvasElement, fontHeight, SymbolMorph, localize, SpeechBubbleMorph,\r\nArrowMorph, MenuMorph, isString, isNil, SliderMorph, MorphicPreferences,\r\nScrollFrameMorph, MenuItemMorph, Note*/\r\n\r\nmodules.widgets = '2017-September-25';\r\n\r\nvar PushButtonMorph;\r\nvar ToggleButtonMorph;\r\nvar TabMorph;\r\nvar ToggleMorph;\r\nvar ToggleElementMorph;\r\nvar DialogBoxMorph;\r\nvar AlignmentMorph;\r\nvar InputFieldMorph;\r\nvar PianoMenuMorph;\r\nvar PianoKeyMorph;\r\n\r\n// PushButtonMorph /////////////////////////////////////////////////////\r\n\r\n// I am a Button with rounded corners and 3D-ish graphical effects\r\n\r\n// PushButtonMorph inherits from TriggerMorph:\r\n\r\nPushButtonMorph.prototype = new TriggerMorph();\r\nPushButtonMorph.prototype.constructor = PushButtonMorph;\r\nPushButtonMorph.uber = TriggerMorph.prototype;\r\n\r\n// PushButtonMorph preferences settings:\r\n\r\nPushButtonMorph.prototype.fontSize = 10;\r\nPushButtonMorph.prototype.fontStyle = 'sans-serif';\r\nPushButtonMorph.prototype.labelColor = new Color(0, 0, 0);\r\nPushButtonMorph.prototype.labelShadowColor = new Color(255, 255, 255);\r\nPushButtonMorph.prototype.labelShadowOffset = new Point(1, 1);\r\n\r\nPushButtonMorph.prototype.color = new Color(220, 220, 220);\r\nPushButtonMorph.prototype.pressColor = new Color(115, 180, 240);\r\nPushButtonMorph.prototype.highlightColor\r\n    = PushButtonMorph.prototype.pressColor.lighter(50);\r\nPushButtonMorph.prototype.outlineColor = new Color(30, 30, 30);\r\nPushButtonMorph.prototype.outlineGradient = false;\r\nPushButtonMorph.prototype.contrast = 60;\r\n\r\nPushButtonMorph.prototype.edge = 2;\r\nPushButtonMorph.prototype.corner = 5;\r\nPushButtonMorph.prototype.outline = 1.00001;\r\nPushButtonMorph.prototype.padding = 3;\r\n\r\n// PushButtonMorph instance creation:\r\n\r\nfunction PushButtonMorph(\r\n    target,\r\n    action,\r\n    labelString,\r\n    environment,\r\n    hint,\r\n    template\r\n) {\r\n    this.init(\r\n        target,\r\n        action,\r\n        labelString,\r\n        environment,\r\n        hint,\r\n        template\r\n    );\r\n}\r\n\r\nPushButtonMorph.prototype.init = function (\r\n    target,\r\n    action,\r\n    labelString,\r\n    environment,\r\n    hint,\r\n    template\r\n) {\r\n    // additional properties:\r\n    this.is3D = false; // for \"flat\" design exceptions\r\n    this.target = target || null;\r\n    this.action = action || null;\r\n    this.environment = environment || null;\r\n    this.labelString = labelString || null;\r\n    this.label = null;\r\n    this.labelMinExtent = new Point(0, 0);\r\n    this.hint = hint || null;\r\n    this.template = template || null; // for pre-computed backbrounds\r\n    // if a template is specified, its background images are used as cache\r\n    this.isDisabled = false;\r\n\r\n    // initialize inherited properties:\r\n    TriggerMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.color = PushButtonMorph.prototype.color;\r\n    this.drawNew();\r\n    this.fixLayout();\r\n};\r\n\r\n// PushButtonMorph layout:\r\n\r\nPushButtonMorph.prototype.fixLayout = function () {\r\n    // make sure I at least encompass my label\r\n    if (this.label !== null) {\r\n        var padding = this.padding * 2 + this.outline * 2 + this.edge * 2;\r\n        this.setExtent(new Point(\r\n            Math.max(this.label.width(), this.labelMinExtent.x) + padding,\r\n            Math.max(this.label instanceof StringMorph ?\r\n                    this.label.rawHeight() :\r\n                        this.label.height(), this.labelMinExtent.y) + padding\r\n        ));\r\n        this.label.setCenter(this.center());\r\n    }\r\n};\r\n\r\n// PushButtonMorph events\r\n\r\nPushButtonMorph.prototype.mouseDownLeft = function () {\r\n    PushButtonMorph.uber.mouseDownLeft.call(this);\r\n    if (this.label) {\r\n        this.label.setCenter(this.center().add(1));\r\n    }\r\n};\r\n\r\nPushButtonMorph.prototype.mouseClickLeft = function () {\r\n    if (this.isDisabled) {return; }\r\n    PushButtonMorph.uber.mouseClickLeft.call(this);\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n    }\r\n};\r\n\r\nPushButtonMorph.prototype.mouseLeave = function () {\r\n    PushButtonMorph.uber.mouseLeave.call(this);\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n    }\r\n};\r\n\r\n// PushButtonMorph drawing:\r\n\r\nPushButtonMorph.prototype.outlinePath = BoxMorph.prototype.outlinePath;\r\n\r\nPushButtonMorph.prototype.drawOutline = function (context) {\r\n    var outlineStyle,\r\n        isFlat = MorphicPreferences.isFlat && !this.is3D;\r\n\r\n    if (!this.outline || isFlat) {return null; }\r\n    if (this.outlineGradient) {\r\n        outlineStyle = context.createLinearGradient(\r\n            0,\r\n            0,\r\n            0,\r\n            this.height()\r\n        );\r\n        outlineStyle.addColorStop(0, this.outlineColor.darker().toString());\r\n        outlineStyle.addColorStop(1, 'white');\r\n    } else {\r\n        outlineStyle = this.outlineColor.toString();\r\n    }\r\n    context.fillStyle = outlineStyle;\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        isFlat ? 0 : this.corner,\r\n        0\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nPushButtonMorph.prototype.drawBackground = function (context, color) {\r\n    var isFlat = MorphicPreferences.isFlat && !this.is3D;\r\n\r\n    context.fillStyle = color.toString();\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        isFlat ? 0 : Math.max(this.corner - this.outline, 0),\r\n        this.outline\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n    context.lineWidth = this.outline;\r\n};\r\n\r\nPushButtonMorph.prototype.drawEdges = function (\r\n    context,\r\n    color,\r\n    topColor,\r\n    bottomColor\r\n) {\r\n    if (MorphicPreferences.isFlat && !this.is3D) {return; }\r\n    var minInset = Math.max(this.corner, this.outline + this.edge),\r\n        w = this.width(),\r\n        h = this.height(),\r\n        gradient;\r\n\r\n    // top:\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.outline,\r\n        0,\r\n        this.outline + this.edge\r\n    );\r\n    gradient.addColorStop(0, topColor.toString());\r\n    gradient.addColorStop(1, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.moveTo(minInset, this.outline + this.edge / 2);\r\n    context.lineTo(w - minInset, this.outline + this.edge / 2);\r\n    context.stroke();\r\n\r\n    // top-left corner:\r\n    gradient = context.createRadialGradient(\r\n        this.corner,\r\n        this.corner,\r\n        Math.max(this.corner - this.outline - this.edge, 0),\r\n        this.corner,\r\n        this.corner,\r\n        Math.max(this.corner - this.outline, 0)\r\n    );\r\n    gradient.addColorStop(0, color.toString());\r\n    gradient.addColorStop(1, topColor.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.arc(\r\n        this.corner,\r\n        this.corner,\r\n        Math.max(this.corner - this.outline - this.edge / 2, 0),\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // left:\r\n    gradient = context.createLinearGradient(\r\n        this.outline,\r\n        0,\r\n        this.outline + this.edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, topColor.toString());\r\n    gradient.addColorStop(1, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.moveTo(this.outline + this.edge / 2, minInset);\r\n    context.lineTo(this.outline + this.edge / 2, h - minInset);\r\n    context.stroke();\r\n\r\n    // bottom:\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.outline,\r\n        0,\r\n        h - this.outline - this.edge\r\n    );\r\n    gradient.addColorStop(0, bottomColor.toString());\r\n    gradient.addColorStop(1, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.moveTo(minInset, h - this.outline - this.edge / 2);\r\n    context.lineTo(w - minInset, h - this.outline - this.edge / 2);\r\n    context.stroke();\r\n\r\n    // bottom-right corner:\r\n    gradient = context.createRadialGradient(\r\n        w - this.corner,\r\n        h - this.corner,\r\n        Math.max(this.corner - this.outline - this.edge, 0),\r\n        w - this.corner,\r\n        h - this.corner,\r\n        Math.max(this.corner - this.outline, 0)\r\n    );\r\n    gradient.addColorStop(0, color.toString());\r\n    gradient.addColorStop(1, bottomColor.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - this.corner,\r\n        h - this.corner,\r\n        Math.max(this.corner - this.outline - this.edge / 2, 0),\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // right:\r\n    gradient = context.createLinearGradient(\r\n        w - this.outline,\r\n        0,\r\n        w - this.outline - this.edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, bottomColor.toString());\r\n    gradient.addColorStop(1, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.moveTo(w - this.outline - this.edge / 2, minInset);\r\n    context.lineTo(w - this.outline - this.edge / 2, h - minInset);\r\n    context.stroke();\r\n};\r\n\r\nPushButtonMorph.prototype.createBackgrounds = function () {\r\n    var context,\r\n        ext = this.extent();\r\n\r\n    if (this.template) { // take the backgrounds images from the template\r\n        this.image = this.template.image;\r\n        this.normalImage = this.template.normalImage;\r\n        this.highlightImage = this.template.highlightImage;\r\n        this.pressImage = this.template.pressImage;\r\n        return null;\r\n    }\r\n\r\n    this.normalImage = newCanvas(ext);\r\n    context = this.normalImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.color);\r\n    this.drawEdges(\r\n        context,\r\n        this.color,\r\n        this.color.lighter(this.contrast),\r\n        this.color.darker(this.contrast)\r\n    );\r\n\r\n    this.highlightImage = newCanvas(ext);\r\n    context = this.highlightImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.highlightColor);\r\n    this.drawEdges(\r\n        context,\r\n        this.highlightColor,\r\n        this.highlightColor.lighter(this.contrast),\r\n        this.highlightColor.darker(this.contrast)\r\n    );\r\n\r\n    this.pressImage = newCanvas(ext);\r\n    context = this.pressImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.pressColor);\r\n    this.drawEdges(\r\n        context,\r\n        this.pressColor,\r\n        this.pressColor.darker(this.contrast),\r\n        this.pressColor.lighter(this.contrast)\r\n    );\r\n\r\n    this.image = this.normalImage;\r\n};\r\n\r\nPushButtonMorph.prototype.createLabel = function () {\r\n    var shading = !MorphicPreferences.isFlat || this.is3D;\r\n\r\n    if (this.label !== null) {\r\n        this.label.destroy();\r\n    }\r\n    if (this.labelString instanceof SymbolMorph) {\r\n        this.label = this.labelString.fullCopy();\r\n        if (shading) {\r\n            this.label.shadowOffset = this.labelShadowOffset;\r\n            this.label.shadowColor = this.labelShadowColor;\r\n        }\r\n        this.label.color = this.labelColor;\r\n        this.label.drawNew();\r\n    } else {\r\n        this.label = new StringMorph(\r\n            localize(this.labelString),\r\n            this.fontSize,\r\n            this.fontStyle,\r\n            true,\r\n            false,\r\n            false,\r\n            shading ? this.labelShadowOffset : null,\r\n            this.labelShadowColor,\r\n            this.labelColor\r\n        );\r\n    }\r\n    this.add(this.label);\r\n};\r\n\r\n// PushButtonMorph states\r\n\r\nPushButtonMorph.prototype.disable = function () {\r\n    this.isDisabled = true;\r\n    this.forAllChildren(function (child) {\r\n        child.alpha = 0.3;\r\n    });\r\n    this.changed();\r\n};\r\n\r\nPushButtonMorph.prototype.enable = function () {\r\n    this.isDisabled = false;\r\n    this.forAllChildren(function (child) {\r\n        child.alpha = 1;\r\n    });\r\n    this.changed();\r\n};\r\n\r\n// ToggleButtonMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a two-state PushButton. When my state is \"true\" I keep my \"pressed\"\r\n    background color. I can also be set to not auto-layout my bounds, in\r\n    which case my label will left-align.\r\n*/\r\n\r\n// ToggleButtonMorph inherits from PushButtonMorph:\r\n\r\nToggleButtonMorph.prototype = new PushButtonMorph();\r\nToggleButtonMorph.prototype.constructor = ToggleButtonMorph;\r\nToggleButtonMorph.uber = PushButtonMorph.prototype;\r\n\r\n// ToggleButton settings\r\n\r\nToggleButtonMorph.prototype.contrast = 30;\r\n\r\n// ToggleButtonMorph instance creation:\r\n\r\nfunction ToggleButtonMorph(\r\n    colors, // color overrides, <array>: [normal, highlight, pressed]\r\n    target,\r\n    action, // a toggle function\r\n    labelString,\r\n    query, // predicate/selector\r\n    environment,\r\n    hint,\r\n    template, // optional, for cached background images\r\n    minWidth, // <num> optional, if specified label will left-align\r\n    hasPreview, // <bool> show press color on left edge (e.g. category)\r\n    isPicture // treat label as picture, i.e. don't apply typography\r\n) {\r\n    this.init(\r\n        colors,\r\n        target,\r\n        action,\r\n        labelString,\r\n        query,\r\n        environment,\r\n        hint,\r\n        template,\r\n        minWidth,\r\n        hasPreview,\r\n        isPicture\r\n    );\r\n}\r\n\r\nToggleButtonMorph.prototype.init = function (\r\n    colors,\r\n    target,\r\n    action,\r\n    labelString,\r\n    query,\r\n    environment,\r\n    hint,\r\n    template,\r\n    minWidth,\r\n    hasPreview,\r\n    isPicture\r\n) {\r\n    // additional properties:\r\n    this.state = false;\r\n    this.query = query || function () {return true; };\r\n    this.minWidth = minWidth || null;\r\n    this.hasPreview = hasPreview || false;\r\n    this.isPicture = isPicture || false;\r\n    this.trueStateLabel = null;\r\n\r\n    // initialize inherited properties:\r\n    ToggleButtonMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        labelString,\r\n        environment,\r\n        hint,\r\n        template\r\n    );\r\n\r\n    // override default colors if others are specified\r\n    if (colors) {\r\n        this.color = colors[0];\r\n        this.highlightColor = colors[1];\r\n        this.pressColor = colors[2];\r\n    }\r\n\r\n    this.refresh();\r\n    this.drawNew();\r\n};\r\n\r\n// ToggleButtonMorph events\r\n\r\nToggleButtonMorph.prototype.mouseEnter = function () {\r\n    var contents = this.hint instanceof Function ? this.hint() : this.hint;\r\n    if (!this.state) {\r\n        this.image = this.highlightImage;\r\n        this.changed();\r\n    }\r\n    if (contents) {\r\n        this.bubbleHelp(contents);\r\n    }\r\n};\r\n\r\nToggleButtonMorph.prototype.mouseLeave = function () {\r\n    if (!this.state) {\r\n        this.image = this.normalImage;\r\n        this.changed();\r\n    }\r\n    if (this.schedule) {\r\n        this.schedule.isActive = false;\r\n    }\r\n    if (this.hint) {\r\n        this.world().hand.destroyTemporaries();\r\n    }\r\n};\r\n\r\nToggleButtonMorph.prototype.mouseDownLeft = function () {\r\n    if (!this.state) {\r\n        this.image = this.pressImage;\r\n        this.changed();\r\n    }\r\n};\r\n\r\nToggleButtonMorph.prototype.mouseClickLeft = function () {\r\n    if (!this.state) {\r\n        this.image = this.highlightImage;\r\n        this.changed();\r\n    }\r\n    this.trigger(); // allow me to be triggered again to force-update others\r\n};\r\n\r\n// ToggleButtonMorph action\r\n\r\nToggleButtonMorph.prototype.trigger = function () {\r\n    ToggleButtonMorph.uber.trigger.call(this);\r\n    this.refresh();\r\n};\r\n\r\nToggleButtonMorph.prototype.refresh = function () {\r\n/*\r\n    if query is a function:\r\n    execute the query with target as environment (can be null)\r\n    for lambdafied (inline) actions\r\n\r\n    else if query is a String:\r\n    treat it as function property of target and execute it\r\n    for selector-like queries\r\n*/\r\n    if (typeof this.query === 'function') {\r\n        this.state = this.query.call(this.target);\r\n    } else { // assume it's a String\r\n        this.state = this.target[this.query]();\r\n    }\r\n    if (this.state) {\r\n        this.image = this.pressImage;\r\n        if (this.trueStateLabel) {\r\n            this.label.hide();\r\n            this.trueStateLabel.show();\r\n        }\r\n    } else {\r\n        this.image = this.normalImage;\r\n        if (this.trueStateLabel) {\r\n            this.label.show();\r\n            this.trueStateLabel.hide();\r\n        }\r\n    }\r\n    this.changed();\r\n};\r\n\r\n// ToggleButtonMorph layout:\r\n\r\nToggleButtonMorph.prototype.fixLayout = function () {\r\n    if (this.label !== null) {\r\n        var lw = Math.max(this.label.width(), this.labelMinExtent.x),\r\n            padding = this.padding * 2 + this.outline * 2 + this.edge * 2;\r\n        this.setExtent(new Point(\r\n            (this.minWidth ?\r\n                    Math.max(this.minWidth, lw) + padding\r\n                    : lw + padding),\r\n            Math.max(this.label instanceof StringMorph ?\r\n                    this.label.rawHeight() :\r\n                        this.label.height(), this.labelMinExtent.y) + padding\r\n        ));\r\n        this.label.setCenter(this.center());\r\n        if (this.trueStateLabel) {\r\n            this.trueStateLabel.setCenter(this.center());\r\n        }\r\n        if (this.minWidth) { // left-align along my corner\r\n            this.label.setLeft(\r\n                this.left()\r\n                    + this.outline\r\n                    + this.edge\r\n                    + this.corner\r\n                    + this.padding\r\n            );\r\n        }\r\n    }\r\n};\r\n\r\n// ToggleButtonMorph drawing\r\n\r\nToggleButtonMorph.prototype.createBackgrounds = function () {\r\n/*\r\n    basically the same as inherited from PushButtonMorph, except for\r\n    not inverting the pressImage 3D-ish border (because it stays that way),\r\n    and optionally coloring the left edge in the press-color, previewing\r\n    the selection color (e.g. in the case of Scratch palette-category\r\n    selector. the latter is done in the drawEdges() method.\r\n*/\r\n    var context,\r\n        ext = this.extent();\r\n\r\n    if (this.template) { // take the backgrounds images from the template\r\n        this.image = this.template.image;\r\n        this.normalImage = this.template.normalImage;\r\n        this.highlightImage = this.template.highlightImage;\r\n        this.pressImage = this.template.pressImage;\r\n        return null;\r\n    }\r\n\r\n    this.normalImage = newCanvas(ext);\r\n    context = this.normalImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.color);\r\n    this.drawEdges(\r\n        context,\r\n        this.color,\r\n        this.color.lighter(this.contrast),\r\n        this.color.darker(this.contrast)\r\n    );\r\n\r\n    this.highlightImage = newCanvas(ext);\r\n    context = this.highlightImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.highlightColor);\r\n    this.drawEdges(\r\n        context,\r\n        this.highlightColor,\r\n        this.highlightColor.lighter(this.contrast),\r\n        this.highlightColor.darker(this.contrast)\r\n    );\r\n\r\n    // note: don't invert the 3D-ish edges for pressedImage, because\r\n    // it will stay that way, and should not look inverted (or should it?)\r\n    this.pressImage = newCanvas(ext);\r\n    context = this.pressImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.pressColor);\r\n    this.drawEdges(\r\n        context,\r\n        this.pressColor,\r\n        this.pressColor.lighter(40),\r\n        this.pressColor.darker(40)\r\n    );\r\n\r\n    this.image = this.normalImage;\r\n};\r\n\r\nToggleButtonMorph.prototype.drawEdges = function (\r\n    context,\r\n    color,\r\n    topColor,\r\n    bottomColor\r\n) {\r\n    var gradient;\r\n\r\n    ToggleButtonMorph.uber.drawEdges.call(\r\n        this,\r\n        context,\r\n        color,\r\n        topColor,\r\n        bottomColor\r\n    );\r\n\r\n    if (this.hasPreview) { // indicate the possible selection color\r\n        if (MorphicPreferences.isFlat && !this.is3D) {\r\n            context.fillStyle = this.pressColor.toString();\r\n            context.fillRect(\r\n                this.outline,\r\n                this.outline,\r\n                this.corner,\r\n                this.height() - this.outline * 2\r\n            );\r\n            return;\r\n        }\r\n        gradient = context.createLinearGradient(\r\n            0,\r\n            0,\r\n            this.corner,\r\n            0\r\n        );\r\n        gradient.addColorStop(0, this.pressColor.lighter(40).toString());\r\n        gradient.addColorStop(1, this.pressColor.darker(40).toString());\r\n        context.fillStyle = gradient; // this.pressColor.toString();\r\n        context.beginPath();\r\n        this.previewPath(\r\n            context,\r\n            Math.max(this.corner - this.outline, 0),\r\n            this.outline\r\n        );\r\n        context.closePath();\r\n        context.fill();\r\n    }\r\n};\r\n\r\nToggleButtonMorph.prototype.previewPath = function (context, radius, inset) {\r\n    var offset = radius + inset,\r\n        h = this.height();\r\n\r\n    // top left:\r\n    context.arc(\r\n        offset,\r\n        offset,\r\n        radius,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    // bottom left:\r\n    context.arc(\r\n        offset,\r\n        h - offset,\r\n        radius,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n};\r\n\r\nToggleButtonMorph.prototype.createLabel = function () {\r\n    var shading = !MorphicPreferences.isFlat || this.is3D,\r\n        none = new Point();\r\n\r\n    if (this.label !== null) {\r\n        this.label.destroy();\r\n    }\r\n    if (this.trueStateLabel !== null) {\r\n        this.trueStateLabel.destroy();\r\n    }\r\n    if (this.labelString instanceof Array && this.labelString.length === 2) {\r\n        if (this.labelString[0] instanceof SymbolMorph) {\r\n            this.label = this.labelString[0].fullCopy();\r\n            this.trueStateLabel = this.labelString[1].fullCopy();\r\n            if (!this.isPicture) {\r\n                this.label.shadowOffset = shading ?\r\n                        this.labelShadowOffset : none;\r\n                this.label.shadowColor = this.labelShadowColor;\r\n                this.label.color = this.labelColor;\r\n                this.label.drawNew();\r\n\r\n                this.trueStateLabel.shadowOffset = shading ?\r\n                        this.labelShadowOffset : none;\r\n                this.trueStateLabel.shadowColor = this.labelShadowColor;\r\n                this.trueStateLabel.color = this.labelColor;\r\n                this.trueStateLabel.drawNew();\r\n            }\r\n        } else if (this.labelString[0] instanceof Morph) {\r\n            this.label = this.labelString[0].fullCopy();\r\n            this.trueStateLabel = this.labelString[1].fullCopy();\r\n        } else {\r\n            this.label = new StringMorph(\r\n                localize(this.labelString[0]),\r\n                this.fontSize,\r\n                this.fontStyle,\r\n                true,\r\n                false,\r\n                false,\r\n                shading ? this.labelShadowOffset : null,\r\n                this.labelShadowColor,\r\n                this.labelColor\r\n            );\r\n            this.trueStateLabel = new StringMorph(\r\n                localize(this.labelString[1]),\r\n                this.fontSize,\r\n                this.fontStyle,\r\n                true,\r\n                false,\r\n                false,\r\n                shading ? this.labelShadowOffset : null,\r\n                this.labelShadowColor,\r\n                this.labelColor\r\n            );\r\n        }\r\n    } else {\r\n        if (this.labelString instanceof SymbolMorph) {\r\n            this.label = this.labelString.fullCopy();\r\n            if (!this.isPicture) {\r\n                this.label.shadowOffset = shading ?\r\n                        this.labelShadowOffset : none;\r\n                this.label.shadowColor = this.labelShadowColor;\r\n                this.label.color = this.labelColor;\r\n                this.label.drawNew();\r\n            }\r\n        } else if (this.labelString instanceof Morph) {\r\n            this.label = this.labelString.fullCopy();\r\n        } else {\r\n            this.label = new StringMorph(\r\n                localize(this.labelString),\r\n                this.fontSize,\r\n                this.fontStyle,\r\n                true,\r\n                false,\r\n                false,\r\n                shading ? this.labelShadowOffset : none,\r\n                this.labelShadowColor,\r\n                this.labelColor\r\n            );\r\n        }\r\n    }\r\n    this.add(this.label);\r\n    if (this.trueStateLabel) {\r\n        this.add(this.trueStateLabel);\r\n    }\r\n};\r\n\r\n// ToggleButtonMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children, so that my instances get restored correctly when\r\n    hiding/showing my parent.\r\n*/\r\n\r\nToggleButtonMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n};\r\n\r\nToggleButtonMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n};\r\n\r\n// TabMorph ///////////////////////////////////////////////////////\r\n\r\n// TabMorph inherits from ToggleButtonMorph:\r\n\r\nTabMorph.prototype = new ToggleButtonMorph();\r\nTabMorph.prototype.constructor = TabMorph;\r\nTabMorph.uber = ToggleButtonMorph.prototype;\r\n\r\n// TabMorph instance creation:\r\n\r\nfunction TabMorph(\r\n    colors, // color overrides, <array>: [normal, highlight, pressed]\r\n    target,\r\n    action, // a toggle function\r\n    labelString,\r\n    query, // predicate/selector\r\n    environment,\r\n    hint\r\n) {\r\n    this.init(\r\n        colors,\r\n        target,\r\n        action,\r\n        labelString,\r\n        query,\r\n        environment,\r\n        hint\r\n    );\r\n}\r\n\r\n// TabMorph layout:\r\n\r\nTabMorph.prototype.fixLayout = function () {\r\n    if (this.label !== null) {\r\n        this.setExtent(new Point(\r\n            this.label.width()\r\n                + this.padding * 2\r\n                + this.corner * 3\r\n                + this.edge * 2,\r\n            (this.label instanceof StringMorph ?\r\n                        this.label.rawHeight() : this.label.height())\r\n                + this.padding * 2\r\n                + this.edge\r\n        ));\r\n        this.label.setCenter(this.center());\r\n    }\r\n};\r\n\r\n// TabMorph action:\r\n\r\nTabMorph.prototype.refresh = function () {\r\n    if (this.state) { // bring to front\r\n        if (this.parent) {\r\n            this.parent.add(this);\r\n        }\r\n    }\r\n    TabMorph.uber.refresh.call(this);\r\n};\r\n\r\n// TabMorph drawing:\r\n\r\nTabMorph.prototype.drawBackground = function (context, color) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        c = this.corner;\r\n\r\n    context.fillStyle = color.toString();\r\n    context.beginPath();\r\n    context.moveTo(0, h);\r\n    context.bezierCurveTo(c, h, c, 0, c * 2, 0);\r\n    context.lineTo(w - c * 2, 0);\r\n    context.bezierCurveTo(w - c, 0, w - c, h, w, h);\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nTabMorph.prototype.drawOutline = function () {\r\n    nop();\r\n};\r\n\r\nTabMorph.prototype.drawEdges = function (\r\n    context,\r\n    color,\r\n    topColor,\r\n    bottomColor\r\n) {\r\n    if (MorphicPreferences.isFlat && !this.is3D) {return; }\r\n\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        c = this.corner,\r\n        e = this.edge,\r\n        eh = e / 2,\r\n        gradient;\r\n\r\n    nop(color); // argument not needed here\r\n\r\n    gradient = context.createLinearGradient(0, 0, w, 0);\r\n    gradient.addColorStop(0, topColor.toString());\r\n    gradient.addColorStop(1, bottomColor.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = e;\r\n\r\n    context.beginPath();\r\n    context.moveTo(0, h + eh);\r\n    context.bezierCurveTo(c, h, c, 0, c * 2, eh);\r\n    context.lineTo(w - c * 2, eh);\r\n    context.bezierCurveTo(w - c, 0, w - c, h, w, h + eh);\r\n    context.stroke();\r\n};\r\n\r\n// ToggleMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a PushButton which toggles a check mark ( becoming check box)\r\n    or a bullet (becoming a radio button). I can have both or either an\r\n    additional label and an additional pictogram, whereas the pictogram\r\n    can be either an instance of (any) Morph, in which case the pictogram\r\n    will be an interactive toggle itself or a Canvas, in which case it\r\n    is just going to be a picture.\r\n*/\r\n\r\n// ToggleMorph inherits from PushButtonMorph:\r\n\r\nToggleMorph.prototype = new PushButtonMorph();\r\nToggleMorph.prototype.constructor = ToggleMorph;\r\nToggleMorph.uber = PushButtonMorph.prototype;\r\n\r\n// ToggleMorph instance creation:\r\n\r\nfunction ToggleMorph(\r\n    style, // 'checkbox' or 'radiobutton'\r\n    target,\r\n    action, // a toggle function\r\n    labelString,\r\n    query, // predicate/selector\r\n    environment,\r\n    hint,\r\n    template,\r\n    element, // optional Morph or Canvas to display\r\n    builder // method which constructs the element (only for Morphs)\r\n) {\r\n    this.init(\r\n        style,\r\n        target,\r\n        action,\r\n        labelString,\r\n        query,\r\n        environment,\r\n        hint,\r\n        template,\r\n        element,\r\n        builder\r\n    );\r\n}\r\n\r\nToggleMorph.prototype.init = function (\r\n    style,\r\n    target,\r\n    action,\r\n    labelString,\r\n    query,\r\n    environment,\r\n    hint,\r\n    template,\r\n    element,\r\n    builder\r\n) {\r\n    // additional properties:\r\n    this.padding = 1;\r\n    style = style || 'checkbox';\r\n    this.corner = (style === 'checkbox' ?\r\n            0 : fontHeight(this.fontSize) / 2 + this.outline + this.padding);\r\n    this.state = false;\r\n    this.query = query || function () {return true; };\r\n    this.tick = null;\r\n    this.captionString = labelString || null;\r\n    this.labelAlignment = 'right';\r\n    this.element = element || null;\r\n    this.builder = builder || null;\r\n    this.toggleElement = null;\r\n\r\n    // initialize inherited properties:\r\n    ToggleMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        (style === 'checkbox' ? '\\u2713' : '\\u25CF'),\r\n        environment,\r\n        hint,\r\n        template\r\n    );\r\n    this.refresh();\r\n    this.drawNew();\r\n};\r\n\r\n// ToggleMorph layout:\r\n\r\nToggleMorph.prototype.fixLayout = function () {\r\n    var padding = this.padding * 2 + this.outline * 2,\r\n        y;\r\n    if (this.tick !== null) {\r\n        this.silentSetHeight(this.tick.rawHeight() + padding);\r\n        this.silentSetWidth(this.tick.width() + padding);\r\n\r\n        this.setExtent(new Point(\r\n            Math.max(this.width(), this.height()),\r\n            Math.max(this.width(), this.height())\r\n        ));\r\n        this.tick.setCenter(this.center());\r\n    }\r\n    if (this.state) {\r\n        this.tick.show();\r\n    } else {\r\n        this.tick.hide();\r\n    }\r\n    if (this.toggleElement && (this.labelAlignment === 'right')) {\r\n        y = this.top() + (this.height() - this.toggleElement.height()) / 2;\r\n        this.toggleElement.setPosition(new Point(\r\n            this.right() + padding,\r\n            y\r\n        ));\r\n    }\r\n    if (this.label !== null) {\r\n        y = this.top() + (this.height() - this.label.height()) / 2;\r\n        if (this.labelAlignment === 'right') {\r\n            this.label.setPosition(new Point(\r\n                this.toggleElement ?\r\n                        this.toggleElement instanceof ToggleElementMorph ?\r\n                                this.toggleElement.right()\r\n                                : this.toggleElement.right() + padding\r\n                        : this.right() + padding,\r\n                y\r\n            ));\r\n        } else {\r\n            this.label.setPosition(new Point(\r\n                this.left() - this.label.width() - padding,\r\n                y\r\n            ));\r\n        }\r\n    }\r\n};\r\n\r\nToggleMorph.prototype.createLabel = function () {\r\n    var shading = !MorphicPreferences.isFlat || this.is3D;\r\n\r\n    if (this.label === null) {\r\n        if (this.captionString) {\r\n            this.label = new TextMorph(\r\n                localize(this.captionString),\r\n                this.fontSize,\r\n                this.fontStyle,\r\n                true\r\n            );\r\n            this.add(this.label);\r\n        }\r\n    }\r\n    if (this.tick === null) {\r\n        this.tick = new StringMorph(\r\n            localize(this.labelString),\r\n            this.fontSize,\r\n            this.fontStyle,\r\n            true,\r\n            false,\r\n            false,\r\n            shading ? new Point(1, 1) : null,\r\n            new Color(240, 240, 240)\r\n        );\r\n        this.add(this.tick);\r\n    }\r\n    if (this.toggleElement === null) {\r\n        if (this.element) {\r\n            if (this.element instanceof Morph) {\r\n                this.toggleElement = new ToggleElementMorph(\r\n                    this.target,\r\n                    this.action,\r\n                    this.element,\r\n                    this.query,\r\n                    this.environment,\r\n                    this.hint,\r\n                    this.builder\r\n                );\r\n            } else if (this.element instanceof HTMLCanvasElement) {\r\n                this.toggleElement = new Morph();\r\n                this.toggleElement.silentSetExtent(new Point(\r\n                    this.element.width,\r\n                    this.element.height\r\n                ));\r\n                this.toggleElement.image = this.element;\r\n            }\r\n            this.add(this.toggleElement);\r\n        }\r\n    }\r\n};\r\n\r\n// ToggleMorph action:\r\n\r\nToggleMorph.prototype.trigger = function () {\r\n    ToggleMorph.uber.trigger.call(this);\r\n    this.refresh();\r\n};\r\n\r\nToggleMorph.prototype.refresh = function () {\r\n    /*\r\n    if query is a function:\r\n    execute the query with target as environment (can be null)\r\n    for lambdafied (inline) actions\r\n\r\n    else if query is a String:\r\n    treat it as function property of target and execute it\r\n    for selector-like queries\r\n    */\r\n    if (typeof this.query === 'function') {\r\n        this.state = this.query.call(this.target);\r\n    } else { // assume it's a String\r\n        this.state = this.target[this.query]();\r\n    }\r\n    if (this.state) {\r\n        this.tick.show();\r\n    } else {\r\n        this.tick.hide();\r\n    }\r\n    if (this.toggleElement && this.toggleElement.refresh) {\r\n        this.toggleElement.refresh();\r\n    }\r\n};\r\n\r\n// ToggleMorph events\r\n\r\nToggleMorph.prototype.mouseDownLeft = function () {\r\n    PushButtonMorph.uber.mouseDownLeft.call(this);\r\n    if (this.tick) {\r\n        this.tick.setCenter(this.center().add(1));\r\n    }\r\n};\r\n\r\nToggleMorph.prototype.mouseClickLeft = function () {\r\n    PushButtonMorph.uber.mouseClickLeft.call(this);\r\n    if (this.tick) {\r\n        this.tick.setCenter(this.center());\r\n    }\r\n};\r\n\r\nToggleMorph.prototype.mouseLeave = function () {\r\n    PushButtonMorph.uber.mouseLeave.call(this);\r\n    if (this.tick) {\r\n        this.tick.setCenter(this.center());\r\n    }\r\n};\r\n\r\n// ToggleMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children, so that my instances get restored correctly when\r\n    hiding/showing my parent.\r\n*/\r\n\r\nToggleMorph.prototype.hide = ToggleButtonMorph.prototype.hide;\r\n\r\nToggleMorph.prototype.show = ToggleButtonMorph.prototype.show;\r\n\r\n// ToggleElementMorph /////////////////////////////////////////////////////\r\n/*\r\n    I am a picture of a Morph (\"element\") which acts as a toggle button.\r\n    I am different from ToggleButton in that I neither create a label nor\r\n    draw button outlines. Instead I display my element morph in specified\r\n    contrasts of a given color, symbolizing whether it is selected or not\r\n*/\r\n\r\n// ToggleElementMorph inherits from TriggerMorph:\r\n\r\nToggleElementMorph.prototype = new TriggerMorph();\r\nToggleElementMorph.prototype.constructor = ToggleElementMorph;\r\nToggleElementMorph.uber = TriggerMorph.prototype;\r\n\r\n// ToggleElementMorph preferences settings\r\n\r\nToggleElementMorph.prototype.contrast = 50;\r\nToggleElementMorph.prototype.shadowOffset = new Point(2, 2);\r\nToggleElementMorph.prototype.shadowAlpha = 0.6;\r\nToggleElementMorph.prototype.fontSize = 10; // only for (optional) labels\r\nToggleElementMorph.prototype.inactiveColor = new Color(180, 180, 180);\r\n\r\n// ToggleElementMorph instance creation:\r\n\r\nfunction ToggleElementMorph(\r\n    target,\r\n    action,\r\n    element,\r\n    query,\r\n    environment,\r\n    hint,\r\n    builder,\r\n    labelString\r\n) {\r\n    this.init(\r\n        target,\r\n        action,\r\n        element,\r\n        query,\r\n        environment,\r\n        hint,\r\n        builder,\r\n        labelString\r\n    );\r\n}\r\n\r\nToggleElementMorph.prototype.init = function (\r\n    target,\r\n    action,\r\n    element, // mandatory\r\n    query,\r\n    environment,\r\n    hint,\r\n    builder, // optional function name that rebuilds the element\r\n    labelString\r\n) {\r\n    // additional properties:\r\n    this.target = target || null;\r\n    this.action = action || null;\r\n    this.element = element;\r\n    this.query = query || function () {return true; };\r\n    this.environment = environment || null;\r\n    this.hint = hint || null;\r\n    this.builder = builder || 'nop';\r\n    this.captionString = labelString || null;\r\n    this.labelAlignment = 'right';\r\n    this.state = false;\r\n\r\n    // initialize inherited properties:\r\n    TriggerMorph.uber.init.call(this);\r\n\r\n    // override inherited properties:\r\n    this.color = element.color;\r\n    this.createLabel();\r\n};\r\n\r\n// ToggleElementMorph drawing:\r\n\r\nToggleElementMorph.prototype.createBackgrounds = function () {\r\n    var shading = !MorphicPreferences.isFlat || this.is3D;\r\n\r\n    this.color = this.element.color;\r\n    this.element.removeShadow();\r\n    this.element[this.builder]();\r\n    if (shading) {\r\n        this.element.addShadow(this.shadowOffset, this.shadowAlpha);\r\n    }\r\n    this.silentSetExtent(this.element.fullBounds().extent()); // w/ shadow\r\n    this.pressImage = this.element.fullImage();\r\n\r\n    this.element.removeShadow();\r\n    this.element.setColor(this.inactiveColor);\r\n    this.element[this.builder](this.contrast);\r\n    if (shading) {\r\n        this.element.addShadow(this.shadowOffset, 0);\r\n    }\r\n    this.normalImage = this.element.fullImage();\r\n\r\n    this.element.removeShadow();\r\n    this.element.setColor(this.color.lighter(this.contrast));\r\n    this.element[this.builder](this.contrast);\r\n    if (shading) {\r\n        this.element.addShadow(this.shadowOffset, this.shadowAlpha);\r\n    }\r\n    this.highlightImage = this.element.fullImage();\r\n\r\n    this.element.removeShadow();\r\n    this.element.setColor(this.color);\r\n    this.element[this.builder]();\r\n    this.image = this.normalImage;\r\n};\r\n\r\nToggleElementMorph.prototype.setColor = function (aColor) {\r\n    this.element.setColor(aColor);\r\n    this.createBackgrounds();\r\n    this.refresh();\r\n};\r\n\r\n// ToggleElementMorph layout:\r\n\r\nToggleElementMorph.prototype.createLabel = function () {\r\n    var y;\r\n    if (this.captionString) {\r\n        this.label = new StringMorph(\r\n            this.captionString,\r\n            this.fontSize,\r\n            this.fontStyle,\r\n            true\r\n        );\r\n        this.add(this.label);\r\n        y = this.top() + (this.height() - this.label.height()) / 2;\r\n        if (this.labelAlignment === 'right') {\r\n            this.label.setPosition(new Point(\r\n                this.right(),\r\n                y\r\n            ));\r\n        } else {\r\n            this.label.setPosition(new Point(\r\n                this.left() - this.label.width(),\r\n                y\r\n            ));\r\n        }\r\n    }\r\n};\r\n\r\n// ToggleElementMorph action\r\n\r\nToggleElementMorph.prototype.trigger\r\n    = ToggleButtonMorph.prototype.trigger;\r\n\r\nToggleElementMorph.prototype.refresh\r\n    = ToggleButtonMorph.prototype.refresh;\r\n\r\n// ToggleElementMorph events\r\n\r\nToggleElementMorph.prototype.mouseEnter\r\n    = ToggleButtonMorph.prototype.mouseEnter;\r\n\r\nToggleElementMorph.prototype.mouseLeave\r\n    = ToggleButtonMorph.prototype.mouseLeave;\r\n\r\nToggleElementMorph.prototype.mouseDownLeft\r\n    = ToggleButtonMorph.prototype.mouseDownLeft;\r\n\r\nToggleElementMorph.prototype.mouseClickLeft\r\n    = ToggleButtonMorph.prototype.mouseClickLeft;\r\n\r\n// DialogBoxMorph /////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a DialogBox frame.\r\n\r\n    Note:\r\n    -----\r\n    my key property keeps track of my purpose to prevent multiple instances\r\n    on the same or similar objects\r\n*/\r\n\r\n// DialogBoxMorph inherits from Morph:\r\n\r\nDialogBoxMorph.prototype = new Morph();\r\nDialogBoxMorph.prototype.constructor = DialogBoxMorph;\r\nDialogBoxMorph.uber = Morph.prototype;\r\n\r\n// DialogBoxMorph preferences settings:\r\n\r\nDialogBoxMorph.prototype.fontSize = 12;\r\nDialogBoxMorph.prototype.titleFontSize = 14;\r\nDialogBoxMorph.prototype.fontStyle = 'sans-serif';\r\n\r\nDialogBoxMorph.prototype.color = PushButtonMorph.prototype.color;\r\nDialogBoxMorph.prototype.titleTextColor = new Color(255, 255, 255);\r\nDialogBoxMorph.prototype.titleBarColor\r\n    = PushButtonMorph.prototype.pressColor;\r\n\r\nDialogBoxMorph.prototype.contrast = 40;\r\n\r\nDialogBoxMorph.prototype.corner = 12;\r\nDialogBoxMorph.prototype.padding = 14;\r\nDialogBoxMorph.prototype.titlePadding = 6;\r\n\r\nDialogBoxMorph.prototype.buttonContrast = 50;\r\nDialogBoxMorph.prototype.buttonFontSize = 12;\r\nDialogBoxMorph.prototype.buttonCorner = 12;\r\nDialogBoxMorph.prototype.buttonEdge = 6;\r\nDialogBoxMorph.prototype.buttonPadding = 0;\r\nDialogBoxMorph.prototype.buttonOutline = 3;\r\nDialogBoxMorph.prototype.buttonOutlineColor\r\n    = PushButtonMorph.prototype.color;\r\nDialogBoxMorph.prototype.buttonOutlineGradient = true;\r\n\r\nDialogBoxMorph.prototype.instances = {}; // prevent multiple instances\r\n\r\n// DialogBoxMorph instance creation:\r\n\r\nfunction DialogBoxMorph(target, action, environment) {\r\n    this.init(target, action, environment);\r\n}\r\n\r\nDialogBoxMorph.prototype.init = function (target, action, environment) {\r\n    // additional properties:\r\n    this.is3D = false; // for \"flat\" design exceptions\r\n    this.target = target || null;\r\n    this.action = action || null;\r\n    this.environment = environment || null;\r\n    this.key = null; // keep track of my purpose to prevent mulitple instances\r\n\r\n    this.labelString = null;\r\n    this.label = null;\r\n    this.head = null;\r\n    this.body = null;\r\n    this.buttons = null;\r\n\r\n    // initialize inherited properties:\r\n    DialogBoxMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.isDraggable = true;\r\n    this.color = PushButtonMorph.prototype.color;\r\n    this.createLabel();\r\n    this.createButtons();\r\n    this.setExtent(new Point(300, 150));\r\n};\r\n\r\n// DialogBoxMorph ops\r\nDialogBoxMorph.prototype.inform = function (\r\n    title,\r\n    textString,\r\n    world,\r\n    pic\r\n) {\r\n    var txt = new TextMorph(\r\n        textString,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        true,\r\n        false,\r\n        'center',\r\n        null,\r\n        null,\r\n        MorphicPreferences.isFlat ? null : new Point(1, 1),\r\n        new Color(255, 255, 255)\r\n    );\r\n\r\n    if (!this.key) {\r\n        this.key = 'inform' + title + textString;\r\n    }\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n    if (textString) {\r\n        this.addBody(txt);\r\n    }\r\n    this.addButton('ok', 'OK');\r\n    this.drawNew();\r\n    this.fixLayout();\r\n    this.popUp(world);\r\n};\r\n\r\nDialogBoxMorph.prototype.askYesNo = function (\r\n    title,\r\n    textString,\r\n    world,\r\n    pic\r\n) {\r\n    var txt = new TextMorph(\r\n        textString,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        true,\r\n        false,\r\n        'center',\r\n        null,\r\n        null,\r\n        MorphicPreferences.isFlat ? null : new Point(1, 1),\r\n        new Color(255, 255, 255)\r\n    );\r\n\r\n    if (!this.key) {\r\n        this.key = 'decide' + title + textString;\r\n    }\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n    this.addBody(txt);\r\n    this.addButton('ok', 'Yes');\r\n    this.addButton('cancel', 'No');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n    this.popUp(world);\r\n};\r\n\r\nDialogBoxMorph.prototype.prompt = function (\r\n    title,\r\n    defaultString,\r\n    world,\r\n    pic,\r\n    choices, // optional dictionary for drop-down of choices\r\n    isReadOnly, // optional when using choices\r\n    isNumeric, // optional\r\n    sliderMin, // optional for numeric sliders\r\n    sliderMax, // optional for numeric sliders\r\n    sliderAction // optional single-arg function for numeric slider\r\n) {\r\n    var sld,\r\n        head,\r\n        txt = new InputFieldMorph(\r\n            defaultString,\r\n            isNumeric || false, // numeric?\r\n            choices || null, // drop-down dict, optional\r\n            choices ? isReadOnly || false : false\r\n        );\r\n    txt.setWidth(250);\r\n    if (isNumeric) {\r\n        if (pic) {\r\n            head = new AlignmentMorph('column', this.padding);\r\n            pic.setPosition(head.position());\r\n            head.add(pic);\r\n        }\r\n        if (!isNil(sliderMin) && !isNil(sliderMax)) {\r\n            sld = new SliderMorph(\r\n                sliderMin * 100,\r\n                sliderMax * 100,\r\n                parseFloat(defaultString) * 100,\r\n                (sliderMax - sliderMin) / 10 * 100,\r\n                'horizontal'\r\n            );\r\n            sld.alpha = 1;\r\n            sld.color = this.color.lighter(50);\r\n            sld.setHeight(txt.height() * 0.7);\r\n            sld.setWidth(txt.width());\r\n            sld.action = function (num) {\r\n                if (sliderAction) {\r\n                    sliderAction(num / 100);\r\n                }\r\n                txt.setContents(num / 100);\r\n                txt.edit();\r\n            };\r\n            if (!head) {\r\n                head = new AlignmentMorph('column', this.padding);\r\n            }\r\n            head.add(sld);\r\n        }\r\n        if (head) {\r\n            head.fixLayout();\r\n            this.setPicture(head);\r\n            head.fixLayout();\r\n        }\r\n    } else {\r\n        if (pic) {this.setPicture(pic); }\r\n    }\r\n\r\n    this.reactToChoice = function (inp) {\r\n        if (sld) {\r\n            sld.value = inp * 100;\r\n            sld.drawNew();\r\n            sld.changed();\r\n        }\r\n        if (sliderAction) {\r\n            sliderAction(inp);\r\n        }\r\n    };\r\n\r\n    txt.reactToKeystroke = function () {\r\n        var inp = txt.getValue();\r\n        if (sld) {\r\n            inp = Math.max(inp, sliderMin);\r\n            sld.value = inp * 100;\r\n            sld.drawNew();\r\n            sld.changed();\r\n        }\r\n        if (sliderAction) {\r\n            sliderAction(inp);\r\n        }\r\n    };\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n\r\n    if (!this.key) {\r\n        this.key = 'prompt' + title + defaultString;\r\n    }\r\n\r\n    this.addBody(txt);\r\n    txt.drawNew();\r\n    this.addButton('ok', 'OK');\r\n    this.addButton('cancel', 'Cancel');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n    this.popUp(world);\r\n};\r\n\r\nDialogBoxMorph.prototype.promptCode = function (\r\n    title,\r\n    defaultString,\r\n    world,\r\n    pic,\r\n    instructions\r\n) {\r\n    var frame = new ScrollFrameMorph(),\r\n        text = new TextMorph(defaultString || ''),\r\n        bdy = new AlignmentMorph('column', this.padding),\r\n        size = pic ? Math.max(pic.width, 400) : 400;\r\n\r\n    this.getInput = function () {\r\n        return text.text;\r\n    };\r\n\r\n    function remarkText(string) {\r\n        return new TextMorph(\r\n            localize(string),\r\n            10,\r\n            null, // style\r\n            false, // bold\r\n            null, // italic\r\n            null, // alignment\r\n            null, // width\r\n            null, // font name\r\n            MorphicPreferences.isFlat ? null : new Point(1, 1),\r\n            new Color(255, 255, 255) // shadowColor\r\n        );\r\n    }\r\n\r\n    frame.padding = 6;\r\n    frame.setWidth(size);\r\n    frame.acceptsDrops = false;\r\n    frame.contents.acceptsDrops = false;\r\n\r\n    text.fontName = 'monospace';\r\n    text.fontStyle = 'monospace';\r\n    text.fontSize = 11;\r\n    text.setPosition(frame.topLeft().add(frame.padding));\r\n    text.enableSelecting();\r\n    text.isEditable = true;\r\n\r\n    frame.setHeight(size / 4);\r\n    frame.fixLayout = nop;\r\n    frame.edge = InputFieldMorph.prototype.edge;\r\n    frame.fontSize = InputFieldMorph.prototype.fontSize;\r\n    frame.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    frame.contrast = InputFieldMorph.prototype.contrast;\r\n    frame.drawNew = InputFieldMorph.prototype.drawNew;\r\n    frame.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    frame.addContents(text);\r\n    text.drawNew();\r\n\r\n    if (pic) {this.setPicture(pic); }\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n\r\n    if (!this.key) {\r\n        this.key = 'promptCode' + title + defaultString;\r\n    }\r\n\r\n    bdy.setColor(this.color);\r\n    bdy.add(frame);\r\n    if (instructions) {\r\n        bdy.add(remarkText(instructions));\r\n    }\r\n    bdy.fixLayout();\r\n\r\n    this.addBody(bdy);\r\n    frame.drawNew();\r\n    bdy.drawNew();\r\n\r\n    this.addButton('ok', 'OK');\r\n    this.addButton('cancel', 'Cancel');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n    this.popUp(world);\r\n    text.edit();\r\n};\r\n\r\nDialogBoxMorph.prototype.promptVector = function (\r\n    title,\r\n    point,\r\n    deflt,\r\n    xLabel,\r\n    yLabel,\r\n    world,\r\n    pic,\r\n    msg\r\n) {\r\n    var vec = new AlignmentMorph('row', 4),\r\n        xInp = new InputFieldMorph(point.x.toString(), true),\r\n        yInp = new InputFieldMorph(point.y.toString(), true),\r\n        xCol = new AlignmentMorph('column', 2),\r\n        yCol = new AlignmentMorph('column', 2),\r\n        inp = new AlignmentMorph('column', 2),\r\n        bdy = new AlignmentMorph('column', this.padding);\r\n\r\n    function labelText(string) {\r\n        return new TextMorph(\r\n            localize(string),\r\n            10,\r\n            null, // style\r\n            false, // bold\r\n            null, // italic\r\n            null, // alignment\r\n            null, // width\r\n            null, // font name\r\n            MorphicPreferences.isFlat ? null : new Point(1, 1),\r\n            new Color(255, 255, 255) // shadowColor\r\n        );\r\n    }\r\n\r\n    inp.alignment = 'left';\r\n    inp.setColor(this.color);\r\n    bdy.setColor(this.color);\r\n    xCol.alignment = 'left';\r\n    xCol.setColor(this.color);\r\n    yCol.alignment = 'left';\r\n    yCol.setColor(this.color);\r\n\r\n    xCol.add(labelText(xLabel));\r\n    xCol.add(xInp);\r\n    yCol.add(labelText(yLabel));\r\n    yCol.add(yInp);\r\n    vec.add(xCol);\r\n    vec.add(yCol);\r\n    inp.add(vec);\r\n\r\n    if (msg) {\r\n        bdy.add(labelText(msg));\r\n    }\r\n\r\n    bdy.add(inp);\r\n\r\n    vec.fixLayout();\r\n    xCol.fixLayout();\r\n    yCol.fixLayout();\r\n    inp.fixLayout();\r\n    bdy.fixLayout();\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n\r\n    this.addBody(bdy);\r\n\r\n    vec.drawNew();\r\n    xCol.drawNew();\r\n    xInp.drawNew();\r\n    yCol.drawNew();\r\n    yInp.drawNew();\r\n    bdy.fixLayout();\r\n\r\n    this.addButton('ok', 'OK');\r\n\r\n    if (deflt instanceof Point) {\r\n        this.addButton(\r\n            function () {\r\n                xInp.setContents(deflt.x.toString());\r\n                yInp.setContents(deflt.y.toString());\r\n            },\r\n            'Default'\r\n\r\n        );\r\n    }\r\n\r\n    this.addButton('cancel', 'Cancel');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n\r\n    this.edit = function () {\r\n        xInp.edit();\r\n    };\r\n\r\n    this.getInput = function () {\r\n        return new Point(xInp.getValue(), yInp.getValue());\r\n    };\r\n\r\n    if (!this.key) {\r\n        this.key = 'vector' + title;\r\n    }\r\n\r\n    this.popUp(world);\r\n};\r\n\r\nDialogBoxMorph.prototype.promptCredentials = function (\r\n    title,\r\n    purpose,\r\n    tosURL,\r\n    tosLabel,\r\n    prvURL,\r\n    prvLabel,\r\n    checkBoxLabel,\r\n    world,\r\n    pic,\r\n    msg\r\n) {\r\n    var usr = new InputFieldMorph(),\r\n        bmn,\r\n        byr,\r\n        emlLabel,\r\n        eml = new InputFieldMorph(),\r\n        pw1 = new InputFieldMorph(),\r\n        pw2 = new InputFieldMorph(),\r\n        opw = new InputFieldMorph(),\r\n        agree = false,\r\n        chk,\r\n        dof = new AlignmentMorph('row', 4),\r\n        mCol = new AlignmentMorph('column', 2),\r\n        yCol = new AlignmentMorph('column', 2),\r\n        inp = new AlignmentMorph('column', 2),\r\n        lnk = new AlignmentMorph('row', 4),\r\n        bdy = new AlignmentMorph('column', this.padding),\r\n        years = {},\r\n        currentYear = new Date().getFullYear(),\r\n        firstYear = currentYear - 20,\r\n        myself = this;\r\n\r\n    function labelText(string) {\r\n        return new TextMorph(\r\n            localize(string),\r\n            10,\r\n            null, // style\r\n            false, // bold\r\n            null, // italic\r\n            null, // alignment\r\n            null, // width\r\n            null, // font name\r\n            MorphicPreferences.isFlat ? null : new Point(1, 1),\r\n            new Color(255, 255, 255) // shadowColor\r\n        );\r\n    }\r\n\r\n    function linkButton(label, url) {\r\n        var btn = new PushButtonMorph(\r\n            myself,\r\n            function () {\r\n                window.open(url);\r\n            },\r\n            '  ' + localize(label) + '  '\r\n        );\r\n        btn.fontSize = 10;\r\n        btn.corner = myself.buttonCorner;\r\n        btn.edge = myself.buttonEdge;\r\n        btn.outline = myself.buttonOutline;\r\n        btn.outlineColor = myself.buttonOutlineColor;\r\n        btn.outlineGradient = myself.buttonOutlineGradient;\r\n        btn.padding = myself.buttonPadding;\r\n        btn.contrast = myself.buttonContrast;\r\n        btn.drawNew();\r\n        btn.fixLayout();\r\n        return btn;\r\n    }\r\n\r\n    function age() {\r\n        var today = new Date().getFullYear() + new Date().getMonth() / 12,\r\n            year = +byr.getValue() || 0,\r\n            monthName = bmn.getValue(),\r\n            month,\r\n            birthday;\r\n        if (monthName instanceof Array) { // translatable\r\n            monthName = monthName[0];\r\n        }\r\n        if (isNaN(year)) {\r\n            year = 0;\r\n        }\r\n        month = [\r\n            'January',\r\n            'February',\r\n            'March',\r\n            'April',\r\n            'May',\r\n            'June',\r\n            'July',\r\n            'August',\r\n            'September',\r\n            'October',\r\n            'November',\r\n            'December'\r\n        ].indexOf(monthName);\r\n        if (isNaN(month)) {\r\n            month = 0;\r\n        }\r\n        birthday = year + month / 12;\r\n        return today - birthday;\r\n    }\r\n\r\n    bmn = new InputFieldMorph(\r\n        null, // text\r\n        false, // numeric?\r\n        {\r\n            'January' : ['January'],\r\n            'February' : ['February'],\r\n            'March' : ['March'],\r\n            'April' : ['April'],\r\n            'May' : ['May'],\r\n            'June' : ['June'],\r\n            'July' : ['July'],\r\n            'August' : ['August'],\r\n            'September' : ['September'],\r\n            'October' : ['October'],\r\n            'November' : ['November'],\r\n            'December' : ['December']\r\n        },\r\n        true // read-only\r\n    );\r\n    for (currentYear; currentYear > firstYear; currentYear -= 1) {\r\n        years[currentYear.toString() + ' '] = currentYear;\r\n    }\r\n    years[firstYear + ' ' + localize('or before')] = '< ' + currentYear;\r\n    byr = new InputFieldMorph(\r\n        null, // text\r\n        false, // numeric?\r\n        years,\r\n        true // read-only\r\n    );\r\n\r\n    inp.alignment = 'left';\r\n    inp.setColor(this.color);\r\n    bdy.setColor(this.color);\r\n\r\n    mCol.alignment = 'left';\r\n    mCol.setColor(this.color);\r\n    yCol.alignment = 'left';\r\n    yCol.setColor(this.color);\r\n\r\n    usr.setWidth(200);\r\n    bmn.setWidth(100);\r\n    byr.contents().minWidth = 80;\r\n    byr.setWidth(80);\r\n    eml.setWidth(200);\r\n    pw1.setWidth(200);\r\n    pw2.setWidth(200);\r\n    opw.setWidth(200);\r\n    pw1.contents().text.toggleIsPassword();\r\n    pw2.contents().text.toggleIsPassword();\r\n    opw.contents().text.toggleIsPassword();\r\n\r\n    if (purpose === 'login') {\r\n        inp.add(labelText('User name:'));\r\n        inp.add(usr);\r\n    }\r\n\r\n    if (purpose === 'signup') {\r\n        inp.add(labelText('User name:'));\r\n        inp.add(usr);\r\n        mCol.add(labelText('Birth date:'));\r\n        mCol.add(bmn);\r\n        yCol.add(labelText('year:'));\r\n        yCol.add(byr);\r\n        dof.add(mCol);\r\n        dof.add(yCol);\r\n        inp.add(dof);\r\n        emlLabel = labelText('foo');\r\n        inp.add(emlLabel);\r\n        inp.add(eml);\r\n    }\r\n\r\n    if (purpose === 'login') {\r\n        inp.add(labelText('Password:'));\r\n        inp.add(pw1);\r\n    }\r\n\r\n    if (purpose === 'changePassword') {\r\n        inp.add(labelText('Old password:'));\r\n        inp.add(opw);\r\n        inp.add(labelText('New password:'));\r\n        inp.add(pw1);\r\n        inp.add(labelText('Repeat new password:'));\r\n        inp.add(pw2);\r\n    }\r\n\r\n    if (purpose === 'resetPassword') {\r\n        inp.add(labelText('User name:'));\r\n        inp.add(usr);\r\n    }\r\n\r\n    if (msg) {\r\n        bdy.add(labelText(msg));\r\n    }\r\n\r\n    bdy.add(inp);\r\n\r\n    if (tosURL || prvURL) {\r\n        bdy.add(lnk);\r\n    }\r\n    if (tosURL) {\r\n        lnk.add(linkButton(tosLabel, tosURL));\r\n    }\r\n    if (prvURL) {\r\n        lnk.add(linkButton(prvLabel, prvURL));\r\n    }\r\n\r\n    if (checkBoxLabel) {\r\n        chk = new ToggleMorph(\r\n            'checkbox',\r\n            this,\r\n            function () {agree = !agree; }, // action,\r\n            checkBoxLabel,\r\n            function () {return agree; } //query\r\n        );\r\n        chk.edge = this.buttonEdge / 2;\r\n        chk.outline = this.buttonOutline / 2;\r\n        chk.outlineColor = this.buttonOutlineColor;\r\n        chk.outlineGradient = this.buttonOutlineGradient;\r\n        chk.contrast = this.buttonContrast;\r\n        chk.drawNew();\r\n        chk.fixLayout();\r\n        bdy.add(chk);\r\n    }\r\n\r\n    dof.fixLayout();\r\n    mCol.fixLayout();\r\n    yCol.fixLayout();\r\n    inp.fixLayout();\r\n    lnk.fixLayout();\r\n    bdy.fixLayout();\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n\r\n    this.addBody(bdy);\r\n\r\n    usr.drawNew();\r\n    dof.drawNew();\r\n    mCol.drawNew();\r\n    bmn.drawNew();\r\n    yCol.drawNew();\r\n    byr.drawNew();\r\n    pw1.drawNew();\r\n    pw2.drawNew();\r\n    opw.drawNew();\r\n    eml.drawNew();\r\n    bdy.fixLayout();\r\n\r\n    this.addButton('ok', 'OK');\r\n    this.addButton('cancel', 'Cancel');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n\r\n    function validInputs() {\r\n        var checklist,\r\n            empty,\r\n            em = eml.getValue();\r\n\r\n        function indicate(morph, string) {\r\n            var bubble = new SpeechBubbleMorph(localize(string));\r\n            bubble.isPointingRight = false;\r\n            bubble.drawNew();\r\n            bubble.popUp(\r\n                world,\r\n                morph.leftCenter().subtract(new Point(bubble.width() + 2, 0))\r\n            );\r\n            if (morph.edit) {\r\n                morph.edit();\r\n            }\r\n        }\r\n\r\n        if (purpose === 'login') {\r\n            checklist = [usr, pw1];\r\n        } else if (purpose === 'signup') {\r\n            checklist = [usr, bmn, byr, eml];\r\n        } else if (purpose === 'changePassword') {\r\n            checklist = [opw, pw1, pw2];\r\n        } else if (purpose === 'resetPassword') {\r\n            checklist = [usr];\r\n        }\r\n\r\n        empty = detect(\r\n            checklist,\r\n            function (inp) {\r\n                return !inp.getValue();\r\n            }\r\n        );\r\n        if (empty) {\r\n            indicate(empty, 'please fill out\\nthis field');\r\n            return false;\r\n        }\r\n        if (purpose === 'signup') {\r\n            if (usr.getValue().length < 4) {\r\n                indicate(usr, 'User name must be four\\ncharacters or longer');\r\n                return false;\r\n            }\r\n            if (em.indexOf(' ') > -1 || em.indexOf('@') === -1\r\n                    || em.indexOf('.') === -1) {\r\n                indicate(eml, 'please provide a valid\\nemail address');\r\n                return false;\r\n            }\r\n        }\r\n        if (purpose === 'changePassword') {\r\n            if (pw1.getValue().length < 6) {\r\n                indicate(pw1, 'password must be six\\ncharacters or longer');\r\n                return false;\r\n            }\r\n            if (pw1.getValue() !== pw2.getValue()) {\r\n                indicate(pw2, 'passwords do\\nnot match');\r\n                return false;\r\n            }\r\n        }\r\n        if (purpose === 'signup') {\r\n            if (!agree) {\r\n                indicate(chk, 'please agree to\\nthe TOS');\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    this.accept = function () {\r\n        if (validInputs()) {\r\n            DialogBoxMorph.prototype.accept.call(myself);\r\n        }\r\n    };\r\n\r\n    this.edit = function () {\r\n        if (purpose === 'changePassword') {\r\n            opw.edit();\r\n        } else { // 'signup', 'login', 'resetPassword'\r\n            usr.edit();\r\n        }\r\n    };\r\n\r\n    this.getInput = function () {\r\n        return {\r\n            username: usr.getValue(),\r\n            email: eml.getValue(),\r\n            oldpassword: opw.getValue(),\r\n            password: pw1.getValue(),\r\n            choice: agree\r\n        };\r\n    };\r\n\r\n    this.reactToChoice = function () {\r\n        if (purpose === 'signup') {\r\n            emlLabel.changed();\r\n            emlLabel.text = age() <= 13 ?\r\n                    'E-mail address of parent or guardian:'\r\n                        : 'E-mail address:';\r\n            emlLabel.text = localize(emlLabel.text);\r\n            emlLabel.drawNew();\r\n            emlLabel.changed();\r\n        }\r\n    };\r\n\r\n    this.reactToChoice(); // initialize e-mail label\r\n\r\n    if (!this.key) {\r\n        this.key = 'credentials' + title + purpose;\r\n    }\r\n\r\n    this.popUp(world);\r\n};\r\n\r\nDialogBoxMorph.prototype.accept = function () {\r\n    /*\r\n    if target is a function, use it as callback:\r\n    execute target as callback function with action as argument\r\n    in the environment as optionally specified.\r\n    Note: if action is also a function, instead of becoming\r\n    the argument itself it will be called to answer the argument.\r\n    for selections, Yes/No Choices etc:\r\n\r\n    else (if target is not a function):\r\n\r\n        if action is a function:\r\n        execute the action with target as environment (can be null)\r\n        for lambdafied (inline) actions\r\n\r\n        else if action is a String:\r\n        treat it as function property of target and execute it\r\n        for selector-like actions\r\n    */\r\n    if (this.action) {\r\n        if (typeof this.target === 'function') {\r\n            if (typeof this.action === 'function') {\r\n                this.target.call(this.environment, this.action.call());\r\n            } else {\r\n                this.target.call(this.environment, this.action);\r\n            }\r\n        } else {\r\n            if (typeof this.action === 'function') {\r\n                this.action.call(this.target, this.getInput());\r\n            } else { // assume it's a String\r\n                this.target[this.action](this.getInput());\r\n            }\r\n        }\r\n    }\r\n    this.destroy();\r\n};\r\n\r\nDialogBoxMorph.prototype.withKey = function (key) {\r\n    this.key = key;\r\n    return this;\r\n};\r\n\r\nDialogBoxMorph.prototype.popUp = function (world) {\r\n    if (world) {\r\n        if (this.key) {\r\n            if (this.instances[world.stamp]) {\r\n                if (this.instances[world.stamp][this.key]) {\r\n                    this.instances[world.stamp][this.key].destroy();\r\n                }\r\n                this.instances[world.stamp][this.key] = this;\r\n            } else {\r\n                this.instances[world.stamp] = {};\r\n                this.instances[world.stamp][this.key] = this;\r\n            }\r\n        }\r\n        world.add(this);\r\n        world.keyboardReceiver = this;\r\n        this.setCenter(world.center());\r\n        this.edit();\r\n    }\r\n};\r\n\r\nDialogBoxMorph.prototype.destroy = function () {\r\n    DialogBoxMorph.uber.destroy.call(this);\r\n    if (this.key) {\r\n        delete this.instances[this.key];\r\n    }\r\n};\r\n\r\nDialogBoxMorph.prototype.ok = function () {\r\n    this.accept();\r\n};\r\n\r\nDialogBoxMorph.prototype.cancel = function () {\r\n    this.destroy();\r\n};\r\n\r\nDialogBoxMorph.prototype.edit = function () {\r\n    this.children.forEach(function (c) {\r\n        if (c.edit) {\r\n            return c.edit();\r\n        }\r\n    });\r\n};\r\n\r\nDialogBoxMorph.prototype.getInput = function () {\r\n    if (this.body instanceof InputFieldMorph) {\r\n        return this.body.getValue();\r\n    }\r\n    return null;\r\n};\r\n\r\nDialogBoxMorph.prototype.justDropped = function (hand) {\r\n    hand.world.keyboardReceiver = this;\r\n    this.edit();\r\n};\r\n\r\nDialogBoxMorph.prototype.destroy = function () {\r\n    var world = this.world();\r\n    world.keyboardReceiver = null;\r\n    world.hand.destroyTemporaries();\r\n    DialogBoxMorph.uber.destroy.call(this);\r\n};\r\n\r\nDialogBoxMorph.prototype.normalizeSpaces = function (string) {\r\n    var ans = '', i, c, flag = false;\r\n\r\n    for (i = 0; i < string.length; i += 1) {\r\n        c = string[i];\r\n        if (c === ' ') {\r\n            if (flag) {\r\n                ans += c;\r\n                flag = false;\r\n            }\r\n        } else {\r\n            ans += c;\r\n            flag = true;\r\n        }\r\n    }\r\n    return ans.trim();\r\n};\r\n\r\n// DialogBoxMorph submorph construction\r\n\r\nDialogBoxMorph.prototype.createLabel = function () {\r\n    var shading = !MorphicPreferences.isFlat || this.is3D;\r\n\r\n    if (this.label) {\r\n        this.label.destroy();\r\n    }\r\n    if (this.labelString) {\r\n        this.label = new StringMorph(\r\n            localize(this.labelString),\r\n            this.titleFontSize,\r\n            this.fontStyle,\r\n            true,\r\n            false,\r\n            false,\r\n            shading ? new Point(2, 1) : null,\r\n            this.titleBarColor.darker(this.contrast)\r\n        );\r\n        this.label.color = this.titleTextColor;\r\n        this.label.drawNew();\r\n        this.add(this.label);\r\n    }\r\n};\r\n\r\nDialogBoxMorph.prototype.createButtons = function () {\r\n    if (this.buttons) {\r\n        this.buttons.destroy();\r\n    }\r\n    this.buttons = new AlignmentMorph('row', this.padding);\r\n    this.add(this.buttons);\r\n};\r\n\r\nDialogBoxMorph.prototype.addButton = function (action, label) {\r\n    var button = new PushButtonMorph(\r\n        this,\r\n        action || 'ok',\r\n        '  ' + localize((label || 'OK')) + '  '\r\n    );\r\n    button.fontSize = this.buttonFontSize;\r\n    button.corner = this.buttonCorner;\r\n    button.edge = this.buttonEdge;\r\n    button.outline = this.buttonOutline;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n    button.padding = this.buttonPadding;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    this.buttons.add(button);\r\n    return button;\r\n};\r\n\r\nDialogBoxMorph.prototype.setPicture = function (aMorphOrCanvas) {\r\n    var morph;\r\n    if (aMorphOrCanvas instanceof Morph) {\r\n        morph = aMorphOrCanvas;\r\n    } else {\r\n        morph = new Morph();\r\n        morph.image = aMorphOrCanvas;\r\n        morph.silentSetWidth(aMorphOrCanvas.width);\r\n        morph.silentSetHeight(aMorphOrCanvas.height);\r\n    }\r\n    this.addHead(morph);\r\n};\r\n\r\nDialogBoxMorph.prototype.addHead = function (aMorph) {\r\n    if (this.head) {\r\n        this.head.destroy();\r\n    }\r\n    this.head = aMorph;\r\n    this.add(this.head);\r\n};\r\n\r\nDialogBoxMorph.prototype.addBody = function (aMorph) {\r\n    if (this.body) {\r\n        this.body.destroy();\r\n    }\r\n    this.body = aMorph;\r\n    this.add(this.body);\r\n};\r\n\r\n// DialogBoxMorph layout\r\n\r\nDialogBoxMorph.prototype.addShadow = function () {nop(); };\r\nDialogBoxMorph.prototype.removeShadow = function () {nop(); };\r\n\r\nDialogBoxMorph.prototype.fixLayout = function () {\r\n    var th = fontHeight(this.titleFontSize) + this.titlePadding * 2, w;\r\n\r\n    if (this.head) {\r\n        this.head.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.silentSetWidth(this.head.width() + this.padding * 2);\r\n        this.silentSetHeight(\r\n            this.head.height()\r\n                + this.padding * 2\r\n                + th\r\n        );\r\n    }\r\n\r\n    if (this.body) {\r\n        if (this.head) {\r\n            this.body.setPosition(this.head.bottomLeft().add(new Point(\r\n                0,\r\n                this.padding\r\n            )));\r\n            this.silentSetWidth(Math.max(\r\n                this.width(),\r\n                this.body.width() + this.padding * 2\r\n            ));\r\n            this.silentSetHeight(\r\n                this.height()\r\n                    + this.body.height()\r\n                    + this.padding\r\n            );\r\n            w = this.width();\r\n            this.head.setLeft(\r\n                this.left()\r\n                    + Math.round((w - this.head.width()) / 2)\r\n            );\r\n            this.body.setLeft(\r\n                this.left()\r\n                    + Math.round((w - this.body.width()) / 2)\r\n            );\r\n        } else {\r\n            this.body.setPosition(this.position().add(new Point(\r\n                this.padding,\r\n                th + this.padding\r\n            )));\r\n            this.silentSetWidth(this.body.width() + this.padding * 2);\r\n            this.silentSetHeight(\r\n                this.body.height()\r\n                    + this.padding * 2\r\n                    + th\r\n            );\r\n        }\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n    }\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.buttons.height()\r\n                    + this.padding\r\n        );\r\n        this.silentSetWidth(Math.max(\r\n                this.width(),\r\n                this.buttons.width()\r\n                        + (2 * this.padding)\r\n            )\r\n        );\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n};\r\n\r\n// DialogBoxMorph shadow\r\n\r\n/*\r\n    only take the 'plain' image, so the box rounding doesn't become\r\n    conflicted by the scrolling scripts pane\r\n*/\r\n\r\nDialogBoxMorph.prototype.shadowImage = function (off, color) {\r\n    // fallback for Windows Chrome-Shadow bug\r\n    var fb, img, outline, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.extent();\r\n    img = this.image;\r\n    outline = newCanvas(fb);\r\n    ctx = outline.getContext('2d');\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        -offset.x,\r\n        -offset.y\r\n    );\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.drawImage(outline, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = clr.toString();\r\n    ctx.fillRect(0, 0, fb.x, fb.y);\r\n    return sha;\r\n};\r\n\r\nDialogBoxMorph.prototype.shadowImageBlurred = function (off, color) {\r\n    var fb, img, sha, ctx,\r\n        offset = off || new Point(7, 7),\r\n        blur = this.shadowBlur,\r\n        clr = color || new Color(0, 0, 0);\r\n    fb = this.extent().add(blur * 2);\r\n    img = this.image;\r\n    sha = newCanvas(fb);\r\n    ctx = sha.getContext('2d');\r\n    ctx.shadowOffsetX = offset.x;\r\n    ctx.shadowOffsetY = offset.y;\r\n    ctx.shadowBlur = blur;\r\n    ctx.shadowColor = clr.toString();\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    ctx.shadowOffsetX = 0;\r\n    ctx.shadowOffsetY = 0;\r\n    ctx.shadowBlur = 0;\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(\r\n        img,\r\n        blur - offset.x,\r\n        blur - offset.y\r\n    );\r\n    return sha;\r\n};\r\n\r\n// DialogBoxMorph keyboard events\r\n\r\nDialogBoxMorph.prototype.processKeyPress = function () {nop(); };\r\n\r\nDialogBoxMorph.prototype.processKeyDown = function (event) {\r\n    // this.inspectKeyEvent(event);\r\n    switch (event.keyCode) {\r\n    case 13:\r\n        this.ok();\r\n        break;\r\n    case 27:\r\n        this.cancel();\r\n        break;\r\n    default:\r\n        nop();\r\n        // this.inspectKeyEvent(event);\r\n    }\r\n};\r\n\r\n// DialogBoxMorph drawing\r\n\r\nDialogBoxMorph.prototype.drawNew = function () {\r\n    this.fullChanged();\r\n    Morph.prototype.trackChanges = false;\r\n    DialogBoxMorph.uber.removeShadow.call(this);\r\n    this.fixLayout();\r\n\r\n    var context,\r\n        gradient,\r\n        w = this.width(),\r\n        h = this.height(),\r\n        th = Math.floor(\r\n            fontHeight(this.titleFontSize) + this.titlePadding * 2\r\n        ),\r\n        shift = this.corner / 2,\r\n        x,\r\n        y,\r\n        isFlat = MorphicPreferences.isFlat && !this.is3D;\r\n\r\n    // this.alpha = isFlat ? 0.9 : 1;\r\n\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n\r\n    // title bar\r\n    if (isFlat) {\r\n        context.fillStyle = this.titleBarColor.toString();\r\n    } else {\r\n        gradient = context.createLinearGradient(0, 0, 0, th);\r\n        gradient.addColorStop(\r\n            0,\r\n            this.titleBarColor.lighter(this.contrast / 2).toString()\r\n        );\r\n        gradient.addColorStop(\r\n            1,\r\n            this.titleBarColor.darker(this.contrast).toString()\r\n        );\r\n        context.fillStyle = gradient;\r\n    }\r\n    context.beginPath();\r\n    this.outlinePathTitle(\r\n        context,\r\n        isFlat ? 0 : this.corner\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    // flat shape\r\n    // body\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n    this.outlinePathBody(\r\n        context,\r\n        isFlat ? 0 : this.corner\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (isFlat) {\r\n        DialogBoxMorph.uber.addShadow.call(this);\r\n        Morph.prototype.trackChanges = true;\r\n        this.fullChanged();\r\n        return;\r\n    }\r\n\r\n    // 3D-effect\r\n    // bottom left corner\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.corner,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(0, this.color.toString());\r\n    gradient.addColorStop(1, this.color.darker(this.contrast.toString()));\r\n\r\n    context.lineWidth = this.corner;\r\n    context.lineCap = 'round';\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(this.corner, h - shift);\r\n    context.lineTo(this.corner + 1, h - shift);\r\n    context.stroke();\r\n\r\n    // bottom edge\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.corner,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(0, this.color.toString());\r\n    gradient.addColorStop(1, this.color.darker(this.contrast.toString()));\r\n\r\n    context.lineWidth = this.corner;\r\n    context.lineCap = 'butt';\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(this.corner, h - shift);\r\n    context.lineTo(w - this.corner, h - shift);\r\n    context.stroke();\r\n\r\n    // right body edge\r\n    gradient = context.createLinearGradient(\r\n        w - this.corner,\r\n        0,\r\n        w,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.color.toString());\r\n    gradient.addColorStop(1, this.color.darker(this.contrast).toString());\r\n\r\n    context.lineWidth = this.corner;\r\n    context.lineCap = 'butt';\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(w - shift, th);\r\n    context.lineTo(w - shift, h - this.corner);\r\n    context.stroke();\r\n\r\n    // bottom right corner\r\n    x = w - this.corner;\r\n    y = h - this.corner;\r\n\r\n    gradient = context.createRadialGradient(\r\n        x,\r\n        y,\r\n        0,\r\n        x,\r\n        y,\r\n        this.corner\r\n    );\r\n    gradient.addColorStop(0, this.color.toString());\r\n    gradient.addColorStop(1, this.color.darker(this.contrast.toString()));\r\n\r\n    context.lineCap = 'butt';\r\n\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.arc(\r\n        x,\r\n        y,\r\n        shift,\r\n        radians(90),\r\n        radians(0),\r\n        true\r\n    );\r\n    context.stroke();\r\n\r\n    // left body edge\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        this.corner,\r\n        0\r\n    );\r\n    gradient.addColorStop(\r\n        0,\r\n        this.color.lighter(this.contrast).toString()\r\n    );\r\n    gradient.addColorStop(1, this.color.toString());\r\n\r\n    context.lineCap = 'butt';\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(shift, th);\r\n    context.lineTo(shift, h - this.corner * 2);\r\n    context.stroke();\r\n\r\n    // left vertical bottom corner\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        this.corner,\r\n        0\r\n    );\r\n    gradient.addColorStop(\r\n        0,\r\n        this.color.lighter(this.contrast).toString()\r\n    );\r\n    gradient.addColorStop(1, this.color.toString());\r\n\r\n    context.lineCap = 'round';\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(shift, h - this.corner * 2);\r\n    context.lineTo(shift, h - this.corner - shift);\r\n    context.stroke();\r\n\r\n    DialogBoxMorph.uber.addShadow.call(this);\r\n    Morph.prototype.trackChanges = true;\r\n    this.fullChanged();\r\n};\r\n\r\nDialogBoxMorph.prototype.outlinePathTitle = function (context, radius) {\r\n    var w = this.width(),\r\n        h = Math.ceil(fontHeight(this.titleFontSize)) + this.titlePadding * 2;\r\n\r\n    // top left:\r\n    context.arc(\r\n        radius,\r\n        radius,\r\n        radius,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    // top right:\r\n    context.arc(\r\n        w - radius,\r\n        radius,\r\n        radius,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n    // bottom right:\r\n    context.lineTo(w, h);\r\n\r\n    // bottom left:\r\n    context.lineTo(0, h);\r\n};\r\n\r\nDialogBoxMorph.prototype.outlinePathBody = function (context, radius) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        th = Math.floor(fontHeight(this.titleFontSize)) +\r\n            this.titlePadding * 2;\r\n\r\n    // top left:\r\n    context.moveTo(0, th);\r\n\r\n    // top right:\r\n    context.lineTo(w, th);\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        w - radius,\r\n        h - radius,\r\n        radius,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    // bottom left:\r\n    context.arc(\r\n        radius,\r\n        h - radius,\r\n        radius,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n};\r\n\r\n// AlignmentMorph /////////////////////////////////////////////////////\r\n\r\n// I am a reified layout, either a row or a column of submorphs\r\n\r\n// AlignmentMorph inherits from Morph:\r\n\r\nAlignmentMorph.prototype = new Morph();\r\nAlignmentMorph.prototype.constructor = AlignmentMorph;\r\nAlignmentMorph.uber = Morph.prototype;\r\n\r\n// AlignmentMorph instance creation:\r\n\r\nfunction AlignmentMorph(orientation, padding) {\r\n    this.init(orientation, padding);\r\n}\r\n\r\nAlignmentMorph.prototype.init = function (orientation, padding) {\r\n    // additional properties:\r\n    this.orientation = orientation || 'row'; // or 'column'\r\n    this.alignment = 'center'; // or 'left' in a column\r\n    this.padding = padding || 0;\r\n    this.respectHiddens = false;\r\n\r\n    // initialize inherited properties:\r\n    AlignmentMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n};\r\n\r\n// AlignmentMorph displaying and layout\r\n\r\nAlignmentMorph.prototype.drawNew = function () {\r\n    this.image = newCanvas(new Point(1, 1));\r\n    this.fixLayout();\r\n};\r\n\r\nAlignmentMorph.prototype.fixLayout = function () {\r\n    var myself = this,\r\n        last = null,\r\n        newBounds;\r\n    if (this.children.length === 0) {\r\n        return null;\r\n    }\r\n    this.children.forEach(function (c) {\r\n        var cfb = c.fullBounds(),\r\n            lfb;\r\n        if (c.isVisible || myself.respectHiddens) {\r\n            if (last) {\r\n                lfb = last.fullBounds();\r\n                if (myself.orientation === 'row') {\r\n                    c.setPosition(\r\n                        lfb.topRight().add(new Point(\r\n                            myself.padding,\r\n                            (lfb.height() - cfb.height()) / 2\r\n                        ))\r\n                    );\r\n                } else { // orientation === 'column'\r\n                    c.setPosition(\r\n                        lfb.bottomLeft().add(new Point(\r\n                            myself.alignment === 'center' ?\r\n                                    (lfb.width() - cfb.width()) / 2\r\n                                            : 0,\r\n                            myself.padding\r\n                        ))\r\n                    );\r\n                }\r\n                cfb = c.fullBounds();\r\n                newBounds = newBounds.merge(cfb);\r\n            } else {\r\n                newBounds = cfb;\r\n            }\r\n            last = c;\r\n        }\r\n    });\r\n    this.bounds = newBounds;\r\n};\r\n\r\n// InputFieldMorph //////////////////////////////////////////////////////\r\n\r\n// InputFieldMorph inherits from Morph:\r\n\r\nInputFieldMorph.prototype = new Morph();\r\nInputFieldMorph.prototype.constructor = InputFieldMorph;\r\nInputFieldMorph.uber = Morph.prototype;\r\n\r\n// InputFieldMorph settings\r\n\r\nInputFieldMorph.prototype.edge = 2;\r\nInputFieldMorph.prototype.fontSize = 12;\r\nInputFieldMorph.prototype.typeInPadding = 2;\r\nInputFieldMorph.prototype.contrast = 65;\r\n\r\n// InputFieldMorph instance creation:\r\n\r\nfunction InputFieldMorph(text, isNumeric, choiceDict, isReadOnly) {\r\n    this.init(text, isNumeric, choiceDict, isReadOnly);\r\n}\r\n\r\nInputFieldMorph.prototype.init = function (\r\n    text,\r\n    isNumeric,\r\n    choiceDict,\r\n    isReadOnly\r\n) {\r\n    var contents = new StringFieldMorph(text || ''),\r\n        arrow = new ArrowMorph(\r\n            'down',\r\n            0,\r\n            Math.max(Math.floor(this.fontSize / 6), 1)\r\n        );\r\n\r\n    this.choices = choiceDict || null; // object, function or selector\r\n    this.isReadOnly = isReadOnly || false;\r\n    this.isNumeric = isNumeric || false;\r\n\r\n    contents.alpha = 0;\r\n    contents.fontSize = this.fontSize;\r\n    contents.drawNew();\r\n\r\n    this.oldContentsExtent = contents.extent();\r\n    this.isNumeric = isNumeric || false;\r\n\r\n    InputFieldMorph.uber.init.call(this);\r\n    this.color = new Color(255, 255, 255);\r\n    this.add(contents);\r\n    this.add(arrow);\r\n    contents.isDraggable = false;\r\n    this.drawNew();\r\n};\r\n\r\n// InputFieldMorph accessing:\r\n\r\nInputFieldMorph.prototype.contents = function () {\r\n    return detect(\r\n        this.children,\r\n        function (child) {\r\n            return (child instanceof StringFieldMorph);\r\n        }\r\n    );\r\n};\r\n\r\nInputFieldMorph.prototype.arrow = function () {\r\n    return detect(\r\n        this.children,\r\n        function (child) {\r\n            return (child instanceof ArrowMorph);\r\n        }\r\n    );\r\n};\r\n\r\nInputFieldMorph.prototype.setChoice = function (aStringOrFloat) {\r\n    this.setContents(aStringOrFloat);\r\n    this.escalateEvent('reactToChoice', aStringOrFloat);\r\n};\r\n\r\nInputFieldMorph.prototype.setContents = function (aStringOrFloat) {\r\n    var cnts = this.contents();\r\n    cnts.text.text = aStringOrFloat;\r\n    if (aStringOrFloat === undefined) {\r\n        return null;\r\n    }\r\n    if (aStringOrFloat === null) {\r\n        cnts.text.text = '';\r\n    } else if (aStringOrFloat.toString) {\r\n        cnts.text.text = aStringOrFloat.toString();\r\n    }\r\n    cnts.drawNew();\r\n    cnts.changed();\r\n};\r\n\r\nInputFieldMorph.prototype.edit = function () {\r\n    var c = this.contents();\r\n    c.text.edit();\r\n    c.text.selectAll();\r\n};\r\n\r\nInputFieldMorph.prototype.setIsNumeric = function (bool) {\r\n    var value;\r\n\r\n    this.isNumeric = bool;\r\n    this.contents().isNumeric = bool;\r\n    this.contents().text.isNumeric = bool;\r\n\r\n    // adjust my shown value to conform with the numeric flag\r\n    value = this.getValue();\r\n    if (this.isNumeric) {\r\n        value = parseFloat(value);\r\n        if (isNaN(value)) {\r\n            value = null;\r\n        }\r\n    }\r\n    this.setContents(value);\r\n};\r\n\r\n// InputFieldMorph drop-down menu:\r\n\r\nInputFieldMorph.prototype.dropDownMenu = function () {\r\n    var choices = this.choices,\r\n        key,\r\n        menu = new MenuMorph(\r\n            this.setChoice,\r\n            null,\r\n            this,\r\n            this.fontSize\r\n        );\r\n\r\n    if (choices instanceof Function) {\r\n        choices = choices.call(this);\r\n    } else if (isString(choices)) {\r\n        choices = this[choices]();\r\n    }\r\n    if (!choices) {\r\n        return null;\r\n    }\r\n    menu.addItem(' ', null);\r\n    if (choices instanceof Array) {\r\n        choices.forEach(function (choice) {\r\n            menu.addItem(choice[0], choice[1]);\r\n        });\r\n    } else { // assuming a dictionary\r\n        for (key in choices) {\r\n            if (Object.prototype.hasOwnProperty.call(choices, key)) {\r\n                if (key[0] === '~') {\r\n                    menu.addLine();\r\n                } else {\r\n                    menu.addItem(key, choices[key]);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (menu.items.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    } else {\r\n        return null;\r\n    }\r\n};\r\n\r\n// InputFieldMorph layout:\r\n\r\nInputFieldMorph.prototype.fixLayout = function () {\r\n    var contents = this.contents(),\r\n        arrow = this.arrow();\r\n\r\n    if (!contents) {return null; }\r\n    contents.isNumeric = this.isNumeric;\r\n    contents.isEditable = (!this.isReadOnly);\r\n    if (this.choices) {\r\n        arrow.setSize(this.fontSize);\r\n        arrow.show();\r\n    } else {\r\n        arrow.setSize(0);\r\n        arrow.hide();\r\n    }\r\n    this.silentSetHeight(\r\n        contents.height()\r\n            + this.edge * 2\r\n            + this.typeInPadding * 2\r\n    );\r\n    this.silentSetWidth(Math.max(\r\n        contents.minWidth\r\n            + this.edge * 2\r\n            + this.typeInPadding * 2,\r\n        this.width()\r\n    ));\r\n\r\n    contents.setWidth(\r\n        this.width() - this.edge - this.typeInPadding -\r\n            (this.choices ? arrow.width() + this.typeInPadding : 0)\r\n    );\r\n\r\n    contents.silentSetPosition(new Point(\r\n        this.edge,\r\n        this.edge\r\n    ).add(this.typeInPadding).add(this.position()));\r\n\r\n    arrow.silentSetPosition(new Point(\r\n        this.right() - arrow.width() - this.edge,\r\n        contents.top()\r\n    ));\r\n\r\n};\r\n\r\n// InputFieldMorph events:\r\n\r\nInputFieldMorph.prototype.mouseClickLeft = function (pos) {\r\n    if (this.arrow().bounds.containsPoint(pos)) {\r\n        this.dropDownMenu();\r\n    } else if (this.isReadOnly) {\r\n        this.dropDownMenu();\r\n    } else {\r\n        this.escalateEvent('mouseClickLeft', pos);\r\n    }\r\n};\r\n\r\n// InputFieldMorph retrieving:\r\n\r\nInputFieldMorph.prototype.getValue = function () {\r\n/*\r\n    answer my content's text string. If I am numerical convert that\r\n    string to a number. If the conversion fails answer the string\r\n    otherwise the numerical value.\r\n*/\r\n    var num,\r\n        contents = this.contents();\r\n    if (this.isNumeric) {\r\n        num = parseFloat(contents.text);\r\n        if (!isNaN(num)) {\r\n            return num;\r\n        }\r\n    }\r\n    return this.normalizeSpaces(contents.string());\r\n};\r\n\r\nInputFieldMorph.prototype.normalizeSpaces\r\n    = DialogBoxMorph.prototype.normalizeSpaces;\r\n\r\n// InputFieldMorph drawing:\r\n\r\nInputFieldMorph.prototype.drawNew = function () {\r\n    var context, borderColor;\r\n\r\n    this.fixLayout();\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if (this.parent) {\r\n        if (this.parent.color.eq(new Color(255, 255, 255))) {\r\n            this.color = this.parent.color.darker(this.contrast * 0.1);\r\n        } else {\r\n            this.color = this.parent.color.lighter(this.contrast * 0.75);\r\n        }\r\n        borderColor = this.parent.color;\r\n    } else {\r\n        borderColor = new Color(120, 120, 120);\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n\r\n    // cache my border colors\r\n    this.cachedClr = borderColor.toString();\r\n    this.cachedClrBright = borderColor.lighter(this.contrast)\r\n        .toString();\r\n    this.cachedClrDark = borderColor.darker(this.contrast).toString();\r\n\r\n    context.fillRect(\r\n        this.edge,\r\n        this.edge,\r\n        this.width() - this.edge * 2,\r\n        this.height() - this.edge * 2\r\n    );\r\n\r\n    this.drawRectBorder(context);\r\n};\r\n\r\nInputFieldMorph.prototype.drawRectBorder = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient;\r\n\r\n    if (MorphicPreferences.isFlat && !this.is3D) {return; }\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge * 4;\r\n    context.shadowColor = this.cachedClrDark;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.edge, shift);\r\n    context.lineTo(this.width() - this.edge - shift, shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetY = 0;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        this.edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, this.edge);\r\n    context.lineTo(shift, this.height() - this.edge - shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.height() - this.edge,\r\n        0,\r\n        this.height()\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.edge, this.height() - shift);\r\n    context.lineTo(this.width() - this.edge, this.height() - shift);\r\n    context.stroke();\r\n\r\n    gradient = context.createLinearGradient(\r\n        this.width() - this.edge,\r\n        0,\r\n        this.width(),\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.width() - shift, this.edge);\r\n    context.lineTo(this.width() - shift, this.height() - this.edge);\r\n    context.stroke();\r\n};\r\n\r\n// PianoMenuMorph //////////////////////////////////////////////////////\r\n/* \r\n    I am a menu that looks like a piano keyboard.\r\n*/\r\n\r\n// PianoMenuMorph inherits from MenuMorph\r\n\r\nPianoMenuMorph.prototype = new MenuMorph();\r\nPianoMenuMorph.prototype.constructor = PianoMenuMorph;\r\nPianoMenuMorph.uber = MenuMorph.prototype;\r\n\r\n// PianoMenuMorph instance creation:\r\n\r\nfunction PianoMenuMorph(target, environment, fontSize, soundType) {\r\n    this.init(target, environment, fontSize, soundType);\r\n}\r\n\r\nPianoMenuMorph.prototype.init = function (\r\n    target,\r\n    environment,\r\n    fontSize,\r\n    soundType // number 1 - 4: 'sine', 'square', 'sawtooth' or 'triangle'\r\n) {\r\n    var choices, key;\r\n    this.soundType = soundType;\r\n    PianoMenuMorph.uber.init.call(this, target, null, environment, fontSize);\r\n    choices = {\r\n        'C (48)' : 48,\r\n        'D (50)' : 50,\r\n        'C# (49)' : 49,\r\n        'E (52)' : 52,\r\n        'Eb (51)' : 51,\r\n        'F (53)' : 53,\r\n        'G (55)' : 55,\r\n        'F# (54)' : 54,\r\n        'A (57)' : 57,\r\n        'G# (56)' : 56,\r\n        'B (59)' : 59,\r\n        'Bb (58)' : 58,\r\n        'C (60)' : 60,\r\n        'D (62)' : 62,\r\n        'C# (61)' : 61,\r\n        'E (64)' : 64,\r\n        'Eb (63)' : 63,\r\n        'F (65)' : 65,\r\n        'G (67)' : 67,\r\n        'F# (66)' : 66,\r\n        'A (69)' : 69,\r\n        'G# (68)' : 68,\r\n        'B (71)' : 71,\r\n        'Bb (70)' : 70,\r\n        'C (72)' : 72\r\n    };\r\n    for (key in choices) {\r\n        if (Object.prototype.hasOwnProperty.call(choices, key)) {\r\n            this.addItem(key, choices[key]);\r\n        }\r\n    }\r\n    this.drawNew();\r\n};\r\n\r\nPianoMenuMorph.prototype.drawNew = function () {\r\n    var myself = this,\r\n        item,\r\n        fb,\r\n        x,\r\n        y,\r\n        label,\r\n        blackkey,\r\n        key,\r\n        keycolor,\r\n        keywidth,\r\n        keyheight,\r\n        keyposition;\r\n\r\n    this.children.forEach(function (m) {\r\n        m.destroy();\r\n    });\r\n    this.children = [];\r\n    if (!this.isListContents) {\r\n        this.edge = MorphicPreferences.isFlat ? 0 : 5;\r\n        this.border = MorphicPreferences.isFlat ? 1 : 2;\r\n    }\r\n    this.color = new Color(255, 255, 255);\r\n    this.borderColor = new Color(60, 60, 60);\r\n    this.silentSetExtent(new Point(0, 0));\r\n\r\n    x = this.left() + 1;\r\n    y = this.top() + (this.fontSize * 1.5) + 2;\r\n    label = new StringMorph('', this.fontSize);\r\n    this.items.forEach(function (tuple) {\r\n        blackkey = tuple[0][1] !== \" \";\r\n        key = new BoxMorph(1, 1);\r\n        if (blackkey) {\r\n            keycolor = new Color(0, 0, 0);\r\n            keywidth = myself.fontSize; // 9;\r\n            keyheight = myself.fontSize * 2.5;\r\n            keyposition = new Point(x + 2 - (myself.fontSize * 2), y);\r\n        } else {\r\n            keycolor = new Color(255, 255, 255);\r\n            keywidth = myself.fontSize * 1.5;\r\n            keyheight = myself.fontSize * 4;\r\n            keyposition = new Point(x + 1, y);\r\n            x += keywidth - 1;\r\n        }\r\n        key.setColor(keycolor);\r\n        key.setWidth(keywidth);\r\n        key.setHeight(keyheight);\r\n        item = new PianoKeyMorph(\r\n            myself.target,\r\n            tuple[1],\r\n            [key, tuple[0]],\r\n            myself.fontSize || MorphicPreferences.menuFontSize,\r\n            MorphicPreferences.menuFontName,\r\n            myself.environment,\r\n            tuple[2], // bubble help hint\r\n            tuple[3], // color\r\n            tuple[4], // bold\r\n            tuple[5], // italic\r\n            tuple[6], // doubleclick action\r\n            label     // String to change\r\n        );\r\n        item.setPosition(keyposition);\r\n        myself.add(item);\r\n    });\r\n    fb = this.fullBounds();\r\n    label.setPosition(new Point((fb.width() / 2) - this.fontSize, 2));\r\n    this.add(label);\r\n    fb = this.fullBounds();\r\n    this.silentSetExtent(fb.extent().add(2));\r\n    MenuMorph.uber.drawNew.call(this);\r\n};\r\n\r\n// PianoMenuMorph keyboard selecting a key:\r\n\r\nPianoMenuMorph.prototype.select = function(aPianoKeyItem) {\r\n    this.unselectAllItems();\r\n    aPianoKeyItem.mouseEnter();\r\n    this.selection = aPianoKeyItem;\r\n    this.world.keyboardReceiver = this;\r\n    this.hasFocus = true;\r\n};\r\n\r\nPianoMenuMorph.prototype.unselectAllItems = function () {\r\n    this.children.forEach(function (item) {\r\n        if (item instanceof MenuItemMorph) {\r\n            item.mouseLeave();\r\n        }\r\n    });\r\n    this.changed();\r\n};\r\n\r\nPianoMenuMorph.prototype.selectKey = function (midiNum) {\r\n    var key;\r\n    if (isNil(midiNum)) {\r\n        return;\r\n    }\r\n    key = detect(\r\n        this.children,\r\n        function (each) {\r\n            return each.action === midiNum;\r\n        }\r\n    );\r\n    if (key) {\r\n        this.select(key);\r\n    } else {\r\n        this.selectKey(48);\r\n    }\r\n};\r\n\r\n// PianoMenuMorph keyboard navigation & entry:\r\n\r\nPianoMenuMorph.prototype.processKeyDown = function (event) {\r\n    \r\n    switch (event.keyCode) {\r\n    case 13: // 'enter'\r\n    case 32: // 'space'\r\n        if (this.selection) {\r\n            this.selection.mouseClickLeft();\r\n        }\r\n        return;\r\n    case 27: // 'esc'\r\n        return this.destroy();\r\n    case 37: // 'left arrow'\r\n    case 40: // 'down arrow'\r\n    case 189: // -\r\n        return this.selectDown();\r\n    case 38: // 'up arrow'\r\n    case 39: // 'right arrow'\r\n    case 187: // +\r\n    case 220: // #\r\n        return this.selectUp();\r\n    default:\r\n        switch(event.key) {\r\n        case 'C':\r\n            return this.selectKey(48);\r\n        case 'c':\r\n            return this.selectKey(60);\r\n        case 'D':\r\n            return this.selectKey(50);\r\n        case 'd':\r\n            return this.selectKey(62);\r\n        case 'E':\r\n            return this.selectKey(52);\r\n        case 'e':\r\n            return this.selectKey(64);\r\n        case 'F':\r\n            return this.selectKey(53);\r\n        case 'f':\r\n            return this.selectKey(65);\r\n        case 'G':\r\n            return this.selectKey(55);\r\n        case 'g':\r\n            return this.selectKey(67);\r\n        case 'A':\r\n            return this.selectKey(57);\r\n        case 'a':\r\n            return this.selectKey(69);\r\n        case 'B':\r\n        case 'H':\r\n            return this.selectKey(59);\r\n        case 'b':\r\n        case 'h':\r\n            return this.selectKey(71);\r\n        default:\r\n            nop();\r\n        }\r\n    }\r\n};\r\n\r\nPianoMenuMorph.prototype.selectUp = function () {\r\n    var next = 48;\r\n    if (this.selection) {\r\n        next = this.selection.action + 1;\r\n        if (next > 72) {\r\n            next = 48;\r\n        }\r\n    }\r\n    this.selectKey(next);\r\n};\r\n\r\nPianoMenuMorph.prototype.selectDown = function () {\r\n    var next = 48;\r\n    if (this.selection) {\r\n        next = this.selection.action - 1;\r\n        if (next < 48) {\r\n            next = 72;\r\n        }\r\n    }\r\n    this.selectKey(next);\r\n};\r\n\r\nPianoMenuMorph.prototype.destroy = function () {\r\n    this.children.forEach(function (key) {\r\n        if (key.note) {\r\n            key.note.stop();\r\n        }\r\n    });\r\n    PianoMenuMorph.uber.destroy.call(this);\r\n};\r\n\r\n\r\n// PianoKeyMorph ///////////////////////////////////////////////////////\r\n\r\nPianoKeyMorph.prototype = new MenuItemMorph();\r\nPianoKeyMorph.prototype.constructor = PianoKeyMorph;\r\nPianoKeyMorph.uber = MenuItemMorph.prototype;\r\n\r\nfunction PianoKeyMorph(\r\n    target,\r\n    action,\r\n    labelString, // can also be a Morph or a Canvas or a tuple: [icon, string]\r\n    fontSize,\r\n    fontStyle,\r\n    environment,\r\n    hint,\r\n    color,\r\n    bold,\r\n    italic,\r\n    doubleClickAction, // optional when used as list morph item\r\n    label\r\n) {\r\n    this.init(\r\n        target,\r\n        action,\r\n        labelString,\r\n        fontSize,\r\n        fontStyle,\r\n        environment,\r\n        hint,\r\n        color,\r\n        bold,\r\n        italic,\r\n        doubleClickAction,\r\n        label\r\n    );\r\n    this.feedback = label;\r\n}\r\n\r\nPianoKeyMorph.prototype.init = function (\r\n    target,\r\n    action,\r\n    labelString,\r\n    fontSize,\r\n    fontStyle,\r\n    environment,\r\n    hint,\r\n    color,\r\n    bold,\r\n    italic,\r\n    doubleClickAction,\r\n    label\r\n) {\r\n    // additional \"note\" property for sound output:\r\n    this.note = new Note(action);\r\n    PianoKeyMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        labelString,\r\n        fontSize,\r\n        fontStyle,\r\n        environment,\r\n        hint,\r\n        color,\r\n        bold,\r\n        italic,\r\n        doubleClickAction,\r\n        label\r\n    );\r\n};\r\n\r\nPianoKeyMorph.prototype.createLabel = function () {\r\n    var icon;\r\n    if (this.label !== null) {\r\n        this.label.destroy();\r\n    }\r\n    // assume its pattern is: [icon, string]\r\n    this.label = new Morph();\r\n    icon = this.createIcon(this.labelString[0]);\r\n    this.label.add(icon);\r\n    this.label.drawNew();\r\n    this.silentSetExtent(icon.extent());\r\n    this.label.bounds = this.position().extent(this.label.extent());\r\n    this.label.silentSetExtent(new Point(0, 0));\r\n    this.add(this.label);\r\n};\r\n\r\nPianoKeyMorph.prototype.mouseEnter = function () {\r\n    var piano = this.parentThatIsA(PianoMenuMorph),\r\n        soundType = piano ? piano.soundType : 1,\r\n        myself = this;\r\n    if (piano) {\r\n        piano.unselectAllItems();\r\n        piano.selection = this;\r\n        piano.world.keyboardReceiver = piano;\r\n        piano.hasFocus = true;\r\n    }\r\n    this.label.children[0].hide();\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n    this.feedback.text = this.labelString[1];\r\n    this.feedback.changed();\r\n    this.feedback.drawNew();\r\n    this.feedback.changed();\r\n    this.note.play(soundType);\r\n    setTimeout(\r\n        function () {\r\n            myself.note.stop();\r\n        },\r\n        400\r\n    );\r\n};\r\n\r\nPianoKeyMorph.prototype.mouseLeave = function () {\r\n    this.note.stop();\r\n    this.label.children[0].show();\r\n    this.image = this.normalImage;\r\n    this.changed();\r\n};\r\n// fin de Widgets\r\n/*\r\n\r\n    blocks.js\r\n\r\n    a programming construction kit\r\n    based on morphic.js\r\n    inspired by Scratch\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js and symbols.js\r\n\r\n\r\n    hierarchy\r\n    ---------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n        Morph*\r\n            ArrowMorph\r\n            BlockHighlightMorph\r\n            ScriptsMorph\r\n            SyntaxElementMorph\r\n                ArgMorph\r\n                    ArgLabelMorph\r\n                    BooleanSlotMorph\r\n                    ColorSlotMorph\r\n                    CommandSlotMorph\r\n                        CSlotMorph\r\n                        RingCommandSlotMorph\r\n                    FunctionSlotMorph\r\n                        ReporterSlotMorph\r\n                            RingReporterSlotMorph\r\n                    InputSlotMorph\r\n                        TextSlotMorph\r\n                    MultiArgMorph\r\n                    TemplateSlotMorph\r\n                BlockMorph\r\n                    CommandBlockMorph\r\n                        HatBlockMorph\r\n                    ReporterBlockMorph\r\n                        RingMorph\r\n        BoxMorph*\r\n            CommentMorph\r\n            ScriptFocusMorph\r\n\r\n    * from morphic.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        SyntaxElementMorph\r\n        BlockMorph\r\n        CommandBlockMorph\r\n        HatBlockMorph\r\n        ReporterBlockMorph\r\n        RingMorph\r\n        ScriptsMorph\r\n        ArgMorph\r\n        CommandSlotMorph\r\n        RingCommandSlotMorph\r\n        CSlotMorph\r\n        InputSlotMorph\r\n        BooleanSlotMorph\r\n        ArrowMorph\r\n        TextSlotMorph\r\n        ColorSlotMorph\r\n        TemplateSlotMorph\r\n        BlockHighlightMorph\r\n        MultiArgMorph\r\n        ArgLabelMorph\r\n        FunctionSlotMorph\r\n        ReporterSlotMorph\r\n        RingReporterSlotMorph\r\n        CommentMorph\r\n\r\n\r\n    structure of syntax elements\r\n    ----------------------------\r\n    the structure of syntax elements is identical with their morphic\r\n    tree. There are, however, accessor methods to get (only) the\r\n    parts which are relevant for evaluation wherever appropriate.\r\n\r\n    In Scratch/BYOB every sprite and the stage has its own \"blocks bin\",\r\n    an instance of ScriptsMorph (we're going to name it differently in\r\n    Snap, probably just \"scripts\").\r\n\r\n    At the top most level blocks are assembled into stacks in ScriptsMorph\r\n    instances. A ScriptsMorph contains nothing but blocks, therefore\r\n    every child of a ScriptsMorph is expected to be a block.\r\n\r\n    Each block contains:\r\n\r\n        selector    - indicating the name of the function it triggers,\r\n\r\n    Its arguments are first evaluated and then passed along    as the\r\n    selector is called. Arguments can be either instances of ArgMorph\r\n    or ReporterBlockMorph. The getter method for a block's arguments is\r\n\r\n        inputs()    - gets an array of arg morphs and/or reporter blocks\r\n\r\n    in addition to inputs, command blocks also know their\r\n\r\n        nextBlock()    - gets the block attached to the receiver's bottom\r\n\r\n    and the block they're attached to - if any: Their parent.\r\n\r\n    please also refer to the high-level comment at the beginning of each\r\n    constructor for further details.\r\n*/\r\n\r\n/*global Array, BoxMorph,\r\nColor, ColorPaletteMorph, FrameMorph, Function, HandleMorph, Math, MenuMorph,\r\nMorph, MorphicPreferences, Object, Point, ScrollFrameMorph, ShadowMorph,\r\nString, StringMorph, TextMorph, contains, degrees, detect, PianoMenuMorph,\r\ndocument, getDocumentPositionOf, isNaN, isString, newCanvas, nop, parseFloat,\r\nradians, useBlurredShadows, SpeechBubbleMorph, modules, StageMorph, Sound,\r\nfontHeight, TableFrameMorph, SpriteMorph, Context, ListWatcherMorph,\r\nCellMorph, DialogBoxMorph, BlockInputFragmentMorph, PrototypeHatBlockMorph,\r\nCostume, IDE_Morph, BlockDialogMorph, BlockEditorMorph, localize, isNil,\r\nisSnapObject, PushButtonMorph, SpriteIconMorph, Process, AlignmentMorph,\r\nCustomCommandBlockMorph, SymbolMorph, ToggleButtonMorph*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.blocks = '2017-November-16';\r\n\r\nvar SyntaxElementMorph;\r\nvar BlockMorph;\r\nvar CommandBlockMorph;\r\nvar ReporterBlockMorph;\r\nvar ScriptsMorph;\r\nvar ArgMorph;\r\nvar CommandSlotMorph;\r\nvar CSlotMorph;\r\nvar InputSlotMorph;\r\nvar BooleanSlotMorph;\r\nvar ArrowMorph;\r\nvar ColorSlotMorph;\r\nvar HatBlockMorph;\r\nvar BlockHighlightMorph;\r\nvar MultiArgMorph;\r\nvar TemplateSlotMorph;\r\nvar FunctionSlotMorph;\r\nvar ReporterSlotMorph;\r\nvar RingMorph;\r\nvar RingCommandSlotMorph;\r\nvar RingReporterSlotMorph;\r\nvar CommentMorph;\r\nvar ArgLabelMorph;\r\nvar TextSlotMorph;\r\nvar ScriptFocusMorph;\r\n\r\n// SyntaxElementMorph //////////////////////////////////////////////////\r\n\r\n// I am the ancestor of all blocks and input slots\r\n\r\n// SyntaxElementMorph inherits from Morph:\r\n\r\nSyntaxElementMorph.prototype = new Morph();\r\nSyntaxElementMorph.prototype.constructor = SyntaxElementMorph;\r\nSyntaxElementMorph.uber = Morph.prototype;\r\n\r\n// SyntaxElementMorph preferences settings:\r\n\r\n/*\r\n    the following settings govern the appearance of all syntax elements\r\n    (blocks and slots) where applicable:\r\n\r\n    outline:\r\n\r\n        corner      - radius of command block rounding\r\n        rounding    - radius of reporter block rounding\r\n        edge        - width of 3D-ish shading box\r\n        hatHeight   - additional top space for hat blocks\r\n        hatWidth    - minimum width for hat blocks\r\n        rfBorder    - pixel width of reification border (grey outline)\r\n        minWidth    - minimum width for any syntax element's contents\r\n\r\n    jigsaw shape:\r\n\r\n        inset       - distance from indentation to left edge\r\n        dent        - width of indentation bottom\r\n\r\n    paddings:\r\n\r\n        bottomPadding   - adds to the width of the bottom most c-slot\r\n        cSlotPadding    - adds to the width of the open \"C\" in c-slots\r\n        typeInPadding   - adds pixels between text and edge in input slots\r\n        labelPadding    - adds left/right pixels to block labels\r\n\r\n    label:\r\n\r\n        labelFontName       - <string> specific font family name\r\n        labelFontStyle      - <string> generic font family name, cascaded\r\n        fontSize            - duh\r\n        embossing           - <Point> offset for embossing effect\r\n        labelWidth          - column width, used for word wrapping\r\n        labelWordWrap       - <bool> if true labels can break after each word\r\n        dynamicInputLabels  - <bool> if true inputs can have dynamic labels\r\n\r\n    snapping:\r\n\r\n        feedbackColor       - <Color> for displaying drop feedbacks\r\n        feedbackMinHeight   - height of white line for command block snaps\r\n        minSnapDistance     - threshold when commands start snapping\r\n        reporterDropFeedbackPadding  - increases reporter drop feedback\r\n\r\n    color gradients:\r\n\r\n        contrast        - <percent int> 3D-ish shading gradient contrast\r\n        labelContrast   - <percent int> 3D-ish label shading contrast\r\n        activeHighlight - <Color> for stack highlighting when active\r\n        errorHighlight  - <Color> for error highlighting\r\n        activeBlur      - <pixels int> shadow for blurred activeHighlight\r\n        activeBorder    - <pixels int> unblurred activeHighlight\r\n        rfColor         - <Color> for reified outlines and slot backgrounds\r\n*/\r\n\r\nSyntaxElementMorph.prototype.setScale = function (num) {\r\n    var scale = Math.min(Math.max(num, 1), 25);\r\n    this.scale = scale;\r\n    this.corner = 3 * scale;\r\n    this.rounding = 9 * scale;\r\n    this.edge = 1.000001 * scale;\r\n    this.inset = 6 * scale;\r\n    this.hatHeight = 12 * scale;\r\n    this.hatWidth = 70 * scale;\r\n    this.rfBorder = 3 * scale;\r\n    this.minWidth = 0;\r\n    this.dent = 8 * scale;\r\n    this.bottomPadding = 3 * scale;\r\n    this.cSlotPadding = 4 * scale;\r\n    this.typeInPadding = scale;\r\n    this.labelPadding = 4 * scale;\r\n    this.labelFontName = 'Verdana';\r\n    this.labelFontStyle = 'sans-serif';\r\n    this.fontSize = 10 * scale;\r\n    this.embossing = new Point(\r\n        -1 * Math.max(scale / 2, 1),\r\n        -1 * Math.max(scale / 2, 1)\r\n    );\r\n    this.labelWidth = 450 * scale;\r\n    this.labelWordWrap = true;\r\n    this.dynamicInputLabels = true;\r\n    this.feedbackColor = new Color(255, 255, 255);\r\n    this.feedbackMinHeight = 5;\r\n    this.minSnapDistance = 20;\r\n    this.reporterDropFeedbackPadding = 10 * scale;\r\n    this.contrast = 65;\r\n    this.labelContrast = 25;\r\n    this.activeHighlight = new Color(153, 255, 213);\r\n    this.errorHighlight = new Color(173, 15, 0);\r\n    this.activeBlur = 20;\r\n    this.activeBorder = 4;\r\n    this.rfColor = new Color(120, 120, 120);\r\n};\r\n\r\nSyntaxElementMorph.prototype.setScale(1);\r\nSyntaxElementMorph.prototype.isCachingInputs = false;\r\n\r\n// SyntaxElementMorph instance creation:\r\n\r\nfunction SyntaxElementMorph() {\r\n    this.init();\r\n}\r\n\r\nSyntaxElementMorph.prototype.init = function (silently) {\r\n    this.cachedClr = null;\r\n    this.cachedClrBright = null;\r\n    this.cachedClrDark = null;\r\n    this.cachedNormalColor = null; // for single-stepping\r\n    this.isStatic = false; // if true, I cannot be exchanged\r\n\r\n    SyntaxElementMorph.uber.init.call(this, silently);\r\n\r\n    this.defaults = [];\r\n    this.cachedInputs = null;\r\n};\r\n\r\n// SyntaxElementMorph accessing:\r\n\r\nSyntaxElementMorph.prototype.parts = function () {\r\n    // answer my non-crontrol submorphs\r\n    var nb = null;\r\n    if (this.nextBlock) { // if I am a CommandBlock or a HatBlock\r\n        nb = this.nextBlock();\r\n    }\r\n    return this.children.filter(function (child) {\r\n        return (child !== nb)\r\n            && !(child instanceof ShadowMorph)\r\n            && !(child instanceof BlockHighlightMorph);\r\n    });\r\n};\r\n\r\nSyntaxElementMorph.prototype.inputs = function () {\r\n    // answer my arguments and nested reporters\r\n    if (isNil(this.cachedInputs) || !this.isCachingInputs) {\r\n        this.cachedInputs = this.parts().filter(function (part) {\r\n            return part instanceof SyntaxElementMorph;\r\n        });\r\n    }\r\n    // this.debugCachedInputs();\r\n    return this.cachedInputs;\r\n};\r\n\r\nSyntaxElementMorph.prototype.debugCachedInputs = function () {\r\n    // private - only used for manually debugging inputs caching\r\n    var realInputs, i;\r\n    if (!isNil(this.cachedInputs)) {\r\n        realInputs = this.parts().filter(function (part) {\r\n            return part instanceof SyntaxElementMorph;\r\n        });\r\n    }\r\n    if (this.cachedInputs.length !== realInputs.length) {\r\n        throw new Error('cached inputs size do not match: ' +\r\n            this.constructor.name);\r\n    }\r\n    for (i = 0; i < realInputs.length; i += 1) {\r\n        if (this.cachedInputs[i] !== realInputs[i]) {\r\n            throw new Error('cached input does not match: ' +\r\n                this.constructor.name +\r\n                ' #' +\r\n                i +\r\n                ' ' +\r\n                this.cachedInputs[i].constructor.name +\r\n                ' != ' +\r\n                realInputs[i].constructor.name);\r\n        }\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.allInputs = function () {\r\n    // answer arguments and nested reporters of all children\r\n    var myself = this;\r\n    return this.allChildren().slice(0).reverse().filter(\r\n        function (child) {\r\n            return (child instanceof ArgMorph) ||\r\n                (child instanceof ReporterBlockMorph &&\r\n                child !== myself);\r\n        }\r\n    );\r\n};\r\n\r\nSyntaxElementMorph.prototype.allEmptySlots = function () {\r\n    // answer empty input slots of all children excluding myself,\r\n    // but omit those in nested rings (lambdas) and JS-Function primitives.\r\n    // Used by the evaluator when binding implicit formal parameters\r\n    // to empty input slots\r\n    var empty = [];\r\n    if (!(this instanceof RingMorph) &&\r\n            (this.selector !== 'reportJSFunction')) {\r\n        this.children.forEach(function (morph) {\r\n            if (morph.isEmptySlot && morph.isEmptySlot()) {\r\n                empty.push(morph);\r\n            } else if (morph.allEmptySlots) {\r\n                empty = empty.concat(morph.allEmptySlots());\r\n            }\r\n        });\r\n    }\r\n    return empty;\r\n};\r\n\r\nSyntaxElementMorph.prototype.tagExitBlocks = function (stopTag, isCommand) {\r\n    // tag 'report' and 'stop this block' blocks of all children including\r\n    // myself, with either a stopTag (for \"stop\" blocks) or an indicator of\r\n    // being inside a command block definition, but omit those in nested\r\n    // rings (lambdas. Used by the evaluator when entering a procedure\r\n    if (this.selector === 'doReport') {\r\n        this.partOfCustomCommand = isCommand;\r\n    } else if (this.selector === 'doStopThis') {\r\n        this.exitTag = stopTag;\r\n    } else {\r\n        if (!(this instanceof RingMorph)) {\r\n            this.children.forEach(function (morph) {\r\n                if (morph.tagExitBlocks) {\r\n                    morph.tagExitBlocks(stopTag, isCommand);\r\n                }\r\n            });\r\n        }\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.replaceInput = function (oldArg, newArg) {\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        replacement = newArg,\r\n        idx = this.children.indexOf(oldArg),\r\n        i = 0;\r\n\r\n    // try to find the ArgLabel embedding the newArg,\r\n    // used for the undrop() feature\r\n    if (idx === -1 && newArg instanceof MultiArgMorph) {\r\n        this.children.forEach(function (morph) {\r\n            if (morph instanceof ArgLabelMorph &&\r\n                    morph.argMorph() === oldArg) {\r\n                idx = i;\r\n            }\r\n            i += 1;\r\n        });\r\n    }\r\n\r\n    if ((idx === -1) || (scripts === null)) {\r\n        return null;\r\n    }\r\n\r\n    if (oldArg.cachedSlotSpec) {oldArg.cachedSlotSpec = null; }\r\n    if (newArg.cachedSlotSpec) {newArg.cachedSlotSpec = null; }\r\n\r\n    this.startLayout();\r\n    if (newArg.parent) {\r\n        newArg.parent.removeChild(newArg);\r\n    }\r\n    if (oldArg instanceof MultiArgMorph) {\r\n        oldArg.inputs().forEach(function (inp) { // preserve nested reporters\r\n            oldArg.replaceInput(inp, new InputSlotMorph());\r\n        });\r\n        if (this.dynamicInputLabels) {\r\n            replacement = new ArgLabelMorph(newArg);\r\n        }\r\n    }\r\n    replacement.parent = this;\r\n    this.children[idx] = replacement;\r\n    if (oldArg instanceof ReporterBlockMorph) {\r\n        if (!(oldArg instanceof RingMorph)\r\n                || (oldArg instanceof RingMorph && oldArg.contents())) {\r\n            scripts.add(oldArg);\r\n            oldArg.moveBy(replacement.extent());\r\n            oldArg.fixBlockColor();\r\n        }\r\n    }\r\n    if (replacement instanceof MultiArgMorph\r\n            || replacement instanceof ArgLabelMorph\r\n            || replacement.constructor === CommandSlotMorph) {\r\n        replacement.fixLayout();\r\n        if (this.fixLabelColor) { // special case for variadic continuations\r\n            this.fixLabelColor();\r\n        }\r\n    } else {\r\n        replacement.drawNew();\r\n        this.fixLayout();\r\n    }\r\n    this.cachedInputs = null;\r\n    this.endLayout();\r\n};\r\n\r\nSyntaxElementMorph.prototype.silentReplaceInput = function (oldArg, newArg) {\r\n    // used by the Serializer or when programatically\r\n    // changing blocks\r\n    var i = this.children.indexOf(oldArg),\r\n        replacement;\r\n\r\n    if (i === -1) {\r\n        return;\r\n    }\r\n\r\n    if (oldArg.cachedSlotSpec) {oldArg.cachedSlotSpec = null; }\r\n    if (newArg.cachedSlotSpec) {newArg.cachedSlotSpec = null; }\r\n\r\n    if (newArg.parent) {\r\n        newArg.parent.removeChild(newArg);\r\n    }\r\n    if (oldArg instanceof MultiArgMorph && this.dynamicInputLabels) {\r\n        replacement = new ArgLabelMorph(newArg);\r\n    } else {\r\n        replacement = newArg;\r\n    }\r\n    replacement.parent = this;\r\n    this.children[i] = replacement;\r\n\r\n    if (replacement instanceof MultiArgMorph\r\n            || replacement instanceof ArgLabelMorph\r\n            || replacement.constructor === CommandSlotMorph) {\r\n        replacement.fixLayout();\r\n        if (this.fixLabelColor) { // special case for variadic continuations\r\n            this.fixLabelColor();\r\n        }\r\n    } else {\r\n        replacement.drawNew();\r\n        this.fixLayout();\r\n    }\r\n    this.cachedInputs = null;\r\n};\r\n\r\nSyntaxElementMorph.prototype.revertToDefaultInput = function (arg, noValues) {\r\n    var idx = this.parts().indexOf(arg),\r\n        inp = this.inputs().indexOf(arg),\r\n        deflt = new InputSlotMorph(),\r\n        def;\r\n\r\n    if (idx !== -1) {\r\n        if (this instanceof BlockMorph) {\r\n            deflt = this.labelPart(this.parseSpec(this.blockSpec)[idx]);\r\n            if (this.isCustomBlock) {\r\n                def = this.isGlobal ? this.definition\r\n                        : this.scriptTarget().getMethod(this.blockSpec);\r\n                if (deflt instanceof InputSlotMorph) {\r\n                    deflt.setChoices.apply(\r\n                        deflt,\r\n                        def.inputOptionsOfIdx(inp)\r\n                    );\r\n                }\r\n                if (deflt instanceof InputSlotMorph ||\r\n                    (deflt instanceof BooleanSlotMorph)\r\n                ) {\r\n                    deflt.setContents(\r\n                        def.defaultValueOfInputIdx(inp)\r\n                    );\r\n                }\r\n            }\r\n        } else if (this instanceof MultiArgMorph) {\r\n            deflt = this.labelPart(this.slotSpec);\r\n        } else if (this instanceof ReporterSlotMorph) {\r\n            deflt = this.emptySlot();\r\n        }\r\n    }\r\n    // set default value\r\n    if (!noValues) {\r\n        if (inp !== -1) {\r\n            if (deflt instanceof MultiArgMorph) {\r\n                deflt.setContents(this.defaults);\r\n                deflt.defaults = this.defaults;\r\n            } else if (!isNil(this.defaults[inp])) {\r\n                deflt.setContents(this.defaults[inp]);\r\n            }\r\n        }\r\n    }\r\n    this.silentReplaceInput(arg, deflt);\r\n    if (deflt instanceof MultiArgMorph) {\r\n        deflt.refresh();\r\n    } else if (deflt instanceof RingMorph) {\r\n        deflt.fixBlockColor();\r\n    }\r\n    this.cachedInputs = null;\r\n};\r\n\r\nSyntaxElementMorph.prototype.isLocked = function () {\r\n    // answer true if I can be exchanged by a dropped reporter\r\n    return this.isStatic;\r\n};\r\n\r\n// SyntaxElementMorph enumerating:\r\n\r\nSyntaxElementMorph.prototype.topBlock = function () {\r\n    if (this.parent && this.parent.topBlock) {\r\n        return this.parent.topBlock();\r\n    }\r\n    return this;\r\n};\r\n\r\n// SyntaxElementMorph reachable variables\r\n\r\nSyntaxElementMorph.prototype.getVarNamesDict = function () {\r\n    var block = this.parentThatIsA(BlockMorph),\r\n        rcvr,\r\n        tempVars = [],\r\n        dict;\r\n\r\n    if (!block) {\r\n        return {};\r\n    }\r\n    rcvr = block.scriptTarget();\r\n    block.allParents().forEach(function (morph) {\r\n        if (morph instanceof PrototypeHatBlockMorph) {\r\n            tempVars.push.apply(\r\n                tempVars,\r\n                morph.variableNames()\r\n            );\r\n            tempVars.push.apply(\r\n                tempVars,\r\n                morph.inputs()[0].inputFragmentNames()\r\n            );\r\n        } else if (morph instanceof BlockMorph) {\r\n            morph.inputs().forEach(function (inp) {\r\n                if (inp instanceof TemplateSlotMorph) {\r\n                    tempVars.push(inp.contents());\r\n                } else if (inp instanceof MultiArgMorph) {\r\n                    inp.children.forEach(function (m) {\r\n                        if (m instanceof TemplateSlotMorph) {\r\n                            tempVars.push(m.contents());\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    });\r\n    if (rcvr) {\r\n        dict = rcvr.variables.allNamesDict();\r\n        tempVars.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n        return dict;\r\n    }\r\n    return {};\r\n};\r\n\r\n// Variable refactoring\r\n\r\nSyntaxElementMorph.prototype.refactorVarInStack = function (\r\n    oldName,\r\n    newName,\r\n    isScriptVar\r\n) {\r\n    // Rename all oldName var occurrences found in this block stack into newName\r\n    // taking care of not being too greedy\r\n\r\n    if ((this instanceof RingMorph && contains(this.inputNames(), oldName))\r\n            || (!isScriptVar && this.definesScriptVariable(oldName))) {\r\n        return;\r\n    }\r\n\r\n    if (this.selector === 'reportGetVar'\r\n            && this.blockSpec === oldName) {\r\n        this.setSpec(newName);\r\n        this.fullChanged();\r\n        this.fixLabelColor();\r\n    }\r\n\r\n    if (this.choices === 'getVarNamesDict'\r\n            && this.contents().text === oldName) {\r\n        this.setContents(newName);\r\n    }\r\n\r\n    if (this instanceof CustomCommandBlockMorph\r\n            && this.definition.body\r\n            && isNil(this.definition.declarations[oldName])\r\n            && !contains(this.definition.variableNames, oldName)) {\r\n        this.definition.body.expression.refactorVarInStack(oldName, newName);\r\n    }\r\n\r\n    this.inputs().forEach(function (input) {\r\n        input.refactorVarInStack(oldName, newName);\r\n    });\r\n\r\n    if (this.nextBlock) {\r\n        var nb = this.nextBlock();\r\n        if (nb) {\r\n            nb.refactorVarInStack(oldName, newName);\r\n        }\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.definesScriptVariable = function (name) {\r\n    // Returns true if this block is defining either a script local var or\r\n    // an upVar called `name`\r\n    return ((this.selector === 'doDeclareVariables'\r\n                || (this.blockSpec && this.blockSpec.match('%upvar')))\r\n            && (detect(this.inputs()[0].allInputs(), function (input) {\r\n                return (input.selector === 'reportGetVar'\r\n                        && input.blockSpec === name);\r\n            })));\r\n};\r\n\r\n// SyntaxElementMorph copy-on-write support:\r\n\r\nSyntaxElementMorph.prototype.selectForEdit = function () {\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        rcvr = ide ? ide.currentSprite : null,\r\n        selected;\r\n    if (scripts && rcvr && rcvr.inheritsAttribute('scripts')) {\r\n        // copy on write:\r\n        this.selectionID = true;\r\n        rcvr.shadowAttribute('scripts');\r\n        selected = detect(rcvr.scripts.allChildren(), function (m) {\r\n            return m.selectionID;\r\n        });\r\n        delete this.selectionID;\r\n        delete selected.selectionID;\r\n        return selected;\r\n    }\r\n    return this;\r\n};\r\n\r\n// SyntaxElementMorph drag & drop:\r\n\r\nSyntaxElementMorph.prototype.reactToGrabOf = function (grabbedMorph) {\r\n    var topBlock = this.topBlock(),\r\n        affected;\r\n    if (grabbedMorph instanceof CommandBlockMorph) {\r\n        affected = this.parentThatIsA(CommandSlotMorph);\r\n        if (affected) {\r\n            this.startLayout();\r\n            affected.fixLayout();\r\n            this.endLayout();\r\n        }\r\n    }\r\n    if (topBlock) {\r\n        topBlock.allComments().forEach(function (comment) {\r\n            comment.align(topBlock);\r\n        });\r\n        if (topBlock.getHighlight()) {\r\n            topBlock.addHighlight(topBlock.removeHighlight());\r\n        }\r\n    }\r\n};\r\n\r\n// SyntaxElementMorph 3D - border color rendering:\r\n\r\nSyntaxElementMorph.prototype.bright = function () {\r\n    return this.color.lighter(this.contrast).toString();\r\n};\r\n\r\nSyntaxElementMorph.prototype.dark = function () {\r\n    return this.color.darker(this.contrast).toString();\r\n};\r\n\r\n// SyntaxElementMorph color changing:\r\n\r\nSyntaxElementMorph.prototype.setColor = function (aColor, silently) {\r\n    if (aColor) {\r\n        if (!this.color.eq(aColor)) {\r\n            this.color = aColor;\r\n            if (!silently) {this.drawNew(); }\r\n            this.children.forEach(function (child) {\r\n                if ((!silently || child instanceof TemplateSlotMorph) &&\r\n                \t\t!(child instanceof BlockHighlightMorph)) {\r\n                    child.drawNew();\r\n                    child.changed();\r\n                }\r\n            });\r\n            this.changed();\r\n        }\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.setLabelColor = function (\r\n    textColor,\r\n    shadowColor,\r\n    shadowOffset\r\n) {\r\n    this.children.forEach(function (morph) {\r\n        if (morph instanceof StringMorph && !morph.isProtectedLabel) {\r\n            morph.shadowOffset = shadowOffset || morph.shadowOffset;\r\n            morph.shadowColor = shadowColor || morph.shadowColor;\r\n            morph.setColor(textColor);\r\n        } else if (morph instanceof MultiArgMorph\r\n                || morph instanceof ArgLabelMorph\r\n                || (morph instanceof SymbolMorph && !morph.isProtectedLabel)\r\n                || (morph instanceof InputSlotMorph\r\n                    && morph.isReadOnly)) {\r\n            morph.setLabelColor(textColor, shadowColor, shadowOffset);\r\n        }\r\n    });\r\n};\r\n\r\nSyntaxElementMorph.prototype.flash = function () {\r\n    if (!this.cachedNormalColor) {\r\n        this.cachedNormalColor = this.color;\r\n        this.setColor(this.activeHighlight);\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.unflash = function () {\r\n    if (this.cachedNormalColor) {\r\n        var clr = this.cachedNormalColor;\r\n        this.cachedNormalColor = null;\r\n        this.setColor(clr);\r\n    }\r\n};\r\n\r\n// SyntaxElementMorph zebra coloring\r\n\r\nSyntaxElementMorph.prototype.fixBlockColor = function (\r\n    nearestBlock,\r\n    isForced\r\n) {\r\n    this.children.forEach(function (morph) {\r\n        if (morph instanceof SyntaxElementMorph) {\r\n            morph.fixBlockColor(nearestBlock, isForced);\r\n        }\r\n    });\r\n};\r\n\r\n// SyntaxElementMorph label parts:\r\n\r\nSyntaxElementMorph.prototype.labelPart = function (spec) {\r\n    var part, tokens;\r\n    if (spec[0] === '%' &&\r\n            spec.length > 1 &&\r\n            (this.selector !== 'reportGetVar' ||\r\n                (spec === '%turtleOutline' && this.isObjInputFragment()))) {\r\n\r\n        // check for variable multi-arg-slot:\r\n        if ((spec.length > 5) && (spec.slice(0, 5) === '%mult')) {\r\n            part = new MultiArgMorph(spec.slice(5));\r\n            part.addInput();\r\n            return part;\r\n        }\r\n\r\n        // single-arg and specialized multi-arg slots:\r\n        switch (spec) {\r\n        case '%imgsource':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // non-numeric\r\n                {\r\n                    'pen trails': ['pen trails'],\r\n                    'stage image': ['stage image']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['pen trails']);\r\n            break;\r\n        case '%inputs':\r\n            part = new MultiArgMorph('%s', 'with inputs');\r\n            part.isStatic = false;\r\n            part.canBeEmpty = false;\r\n            break;\r\n        case '%scriptVars':\r\n            part = new MultiArgMorph('%t', null, 1, spec);\r\n            part.canBeEmpty = false;\r\n            break;\r\n        case '%blockVars':\r\n            part = new MultiArgMorph('%t', 'block variables', 0, spec);\r\n            part.canBeEmpty = false;\r\n            break;\r\n        case '%parms':\r\n            part = new MultiArgMorph('%t', 'Input Names:', 0, spec);\r\n            part.canBeEmpty = false;\r\n            break;\r\n        case '%ringparms':\r\n            part = new MultiArgMorph(\r\n                '%t',\r\n                'input names:',\r\n                0,\r\n                spec\r\n            );\r\n            break;\r\n        case '%cmdRing':\r\n            part = new RingMorph();\r\n            part.color = SpriteMorph.prototype.blockColor.other;\r\n            part.selector = 'reifyScript';\r\n            part.setSpec('%rc %ringparms');\r\n            part.isDraggable = true;\r\n            break;\r\n        case '%repRing':\r\n            part = new RingMorph();\r\n            part.color = SpriteMorph.prototype.blockColor.other;\r\n            part.selector = 'reifyReporter';\r\n            part.setSpec('%rr %ringparms');\r\n            part.isDraggable = true;\r\n            part.isStatic = true;\r\n            break;\r\n        case '%predRing':\r\n            part = new RingMorph(true);\r\n            part.color = SpriteMorph.prototype.blockColor.other;\r\n            part.selector = 'reifyPredicate';\r\n            part.setSpec('%rp %ringparms');\r\n            part.isDraggable = true;\r\n            part.isStatic = true;\r\n            break;\r\n        case '%words':\r\n            part = new MultiArgMorph('%s', null, 0);\r\n            part.addInput(); // allow for default value setting\r\n            part.addInput(); // allow for default value setting\r\n            part.isStatic = false;\r\n            break;\r\n        case '%exp':\r\n            part = new MultiArgMorph('%s', null, 0);\r\n            part.addInput();\r\n            part.isStatic = true;\r\n            part.canBeEmpty = false;\r\n            break;\r\n        case '%br':\r\n            part = new Morph();\r\n            part.setExtent(new Point(0, 0));\r\n            part.isBlockLabelBreak = true;\r\n            part.getSpec = function () {\r\n                return '%br';\r\n            };\r\n            break;\r\n        case '%inputName':\r\n            part = new ReporterBlockMorph();\r\n            part.category = 'variables';\r\n            part.color = SpriteMorph.prototype.blockColor.variables;\r\n            part.setSpec(localize('Input name'));\r\n            break;\r\n        case '%s':\r\n            part = new InputSlotMorph();\r\n            break;\r\n        case '%anyUE':\r\n            part = new InputSlotMorph();\r\n            part.isUnevaluated = true;\r\n            break;\r\n        case '%txt':\r\n            part = new InputSlotMorph(); // supports whitespace dots\r\n            // part = new TextSlotMorph(); // multi-line, no whitespace dots\r\n            part.minWidth = part.height() * 1.7; // \"landscape\"\r\n            part.fixLayout();\r\n            break;\r\n        case '%mlt':\r\n            part = new TextSlotMorph();\r\n            part.fixLayout();\r\n            break;\r\n        case '%code':\r\n            part = new TextSlotMorph();\r\n            part.contents().fontName = 'monospace';\r\n            part.contents().fontStyle = 'monospace';\r\n            part.fixLayout();\r\n            break;\r\n        case '%obj':\r\n            part = new ArgMorph('object');\r\n            break;\r\n        case '%n':\r\n            part = new InputSlotMorph(null, true);\r\n            break;\r\n        case '%dir':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                true,\r\n                {\r\n                    '(90) right' : 90,\r\n                    '(-90) left' : -90,\r\n                    '(0) up' : '0',\r\n                    '(180) down' : 180\r\n                }\r\n            );\r\n            part.setContents(90);\r\n            break;\r\n        case '%note':\r\n            part = new InputSlotMorph(\r\n                null, // test\r\n                true, // numeric\r\n                'pianoKeyboardMenu',\r\n                false // read-only\r\n            );\r\n            break;\r\n        case '%inst':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                true,\r\n                {\r\n                    '(1) sine' : 1,\r\n                    '(2) square' : 2,\r\n                    '(3) sawtooth' : 3,\r\n                    '(4) triangle' : 4\r\n                }\r\n            );\r\n            part.setContents(1);\r\n            break;\r\n        case '%month':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // numeric?\r\n                {\r\n                    'January' : ['January'],\r\n                    'February' : ['February'],\r\n                    'March' : ['March'],\r\n                    'April' : ['April'],\r\n                    'May' : ['May'],\r\n                    'June' : ['June'],\r\n                    'July' : ['July'],\r\n                    'August' : ['August'],\r\n                    'September' : ['September'],\r\n                    'October' : ['October'],\r\n                    'November' : ['November'],\r\n                    'December' : ['December']\r\n                },\r\n                true // read-only\r\n            );\r\n            break;\r\n        case '%interaction':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // numeric?\r\n                {\r\n                    'clicked' : ['clicked'],\r\n                    'pressed' : ['pressed'],\r\n                    'dropped' : ['dropped'],\r\n                    'mouse-entered' : ['mouse-entered'],\r\n                    'mouse-departed' : ['mouse-departed']\r\n                },\r\n                true // read-only\r\n            );\r\n            part.isStatic = true;\r\n            break;\r\n        case '%dates':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // non-numeric\r\n                {\r\n                    'year' : ['year'],\r\n                    'month' : ['month'],\r\n                    'date' : ['date'],\r\n                    'day of week' : ['day of week'],\r\n                    'hour' : ['hour'],\r\n                    'minute' : ['minute'],\r\n                    'second' : ['second'],\r\n                    'time in milliseconds' : ['time in milliseconds']\r\n                },\r\n                true // read-only\r\n            );\r\n            part.setContents(['date']);\r\n            break;\r\n        case '%delim':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // numeric?\r\n                {\r\n                    'letter' : ['letter'],\r\n                    'whitespace' : ['whitespace'],\r\n                    'line' : ['line'],\r\n                    'tab' : ['tab'],\r\n                    'cr' : ['cr'],\r\n                    'csv' : ['csv']\r\n                },\r\n                false // read-only\r\n            );\r\n            break;\r\n        case '%ida':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                true,\r\n                {\r\n                    '1' : 1,\r\n                    last : ['last'],\r\n                    '~' : null,\r\n                    all : ['all']\r\n                }\r\n            );\r\n            part.setContents(1);\r\n            break;\r\n        case '%idx':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                true,\r\n                {\r\n                    '1' : 1,\r\n                    last : ['last'],\r\n                    any : ['any']\r\n                }\r\n            );\r\n            part.setContents(1);\r\n            break;\r\n        case '%spr':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'objectsMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%col': // collision detection\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'collidablesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%dst': // distance measuring\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'distancesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%cln': // clones\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'clonablesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%get': // sprites, parts, speciment, clones\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'gettablesMenu',\r\n                true\r\n            );\r\n            part.isStatic = true;\r\n            break;\r\n        case '%cst':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'costumesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%eff':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    color: ['color'],\r\n                    fisheye: ['fisheye'],\r\n                    whirl: ['whirl'],\r\n                    pixelate: ['pixelate'],\r\n                    mosaic: ['mosaic'],\r\n                    duplicate: ['duplicate'],\r\n                    negative : ['negative'],\r\n                    comic: ['comic'],\r\n                    confetti: ['confetti'],\r\n                    saturation: ['saturation'],\r\n                    brightness : ['brightness'],\r\n                    ghost: ['ghost']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['ghost']);\r\n            break;\r\n        case '%snd':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'soundsMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%key':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    'any key' : ['any key'],\r\n                    'up arrow': ['up arrow'],\r\n                    'down arrow': ['down arrow'],\r\n                    'right arrow': ['right arrow'],\r\n                    'left arrow': ['left arrow'],\r\n                    space : ['space'],\r\n                    a : ['a'],\r\n                    b : ['b'],\r\n                    c : ['c'],\r\n                    d : ['d'],\r\n                    e : ['e'],\r\n                    f : ['f'],\r\n                    g : ['g'],\r\n                    h : ['h'],\r\n                    i : ['i'],\r\n                    j : ['j'],\r\n                    k : ['k'],\r\n                    l : ['l'],\r\n                    m : ['m'],\r\n                    n : ['n'],\r\n                    o : ['o'],\r\n                    p : ['p'],\r\n                    q : ['q'],\r\n                    r : ['r'],\r\n                    s : ['s'],\r\n                    t : ['t'],\r\n                    u : ['u'],\r\n                    v : ['v'],\r\n                    w : ['w'],\r\n                    x : ['x'],\r\n                    y : ['y'],\r\n                    z : ['z'],\r\n                    '0' : ['0'],\r\n                    '1' : ['1'],\r\n                    '2' : ['2'],\r\n                    '3' : ['3'],\r\n                    '4' : ['4'],\r\n                    '5' : ['5'],\r\n                    '6' : ['6'],\r\n                    '7' : ['7'],\r\n                    '8' : ['8'],\r\n                    '9' : ['9']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['space']);\r\n            break;\r\n        case '%keyHat':\r\n            part = this.labelPart('%key');\r\n            part.isStatic = true;\r\n            break;\r\n        case '%msg':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'messagesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%msgHat':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'messagesReceivedMenu',\r\n                true\r\n            );\r\n            part.isStatic = true;\r\n            break;\r\n        case '%att':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'attributesMenu',\r\n                true\r\n            );\r\n            break;\r\n        case '%fun':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    abs : ['abs'],\r\n                    ceiling : ['ceiling'],\r\n                    floor : ['floor'],\r\n                    sqrt : ['sqrt'],\r\n                    sin : ['sin'],\r\n                    cos : ['cos'],\r\n                    tan : ['tan'],\r\n                    asin : ['asin'],\r\n                    acos : ['acos'],\r\n                    atan : ['atan'],\r\n                    ln : ['ln'],\r\n                    log : ['log'],\r\n                    'e^' : ['e^'],\r\n                    '10^' : ['10^']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['sqrt']);\r\n            break;\r\n        case '%txtfun':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    'encode URI' : ['encode URI'],\r\n                    'decode URI' : ['decode URI'],\r\n                    'encode URI component' : ['encode URI component'],\r\n                    'decode URI component' : ['decode URI component'],\r\n                    'XML escape' : ['XML escape'],\r\n                    'XML unescape' : ['XML unescape'],\r\n                    'hex sha512 hash' : ['hex sha512 hash']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['encode URI']);\r\n            break;\r\n        case '%stopChoices':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    'all' : ['all'],\r\n                    'this script' : ['this script'],\r\n                    'this block' : ['this block'],\r\n                    'all but this script' : ['all but this script'],\r\n                    'other scripts in sprite' : ['other scripts in sprite']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['all']);\r\n            part.isStatic = true;\r\n            break;\r\n        case '%typ':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'typesMenu',\r\n                true\r\n            );\r\n            part.setContents(['number']);\r\n            break;\r\n        case '%mapValue':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    String : ['String'],\r\n                    Number : ['Number'],\r\n                    'true' : ['true'],\r\n                    'false' : ['false']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['String']);\r\n            part.isStatic = true;\r\n            break;\r\n        case '%var':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'getVarNamesDict',\r\n                true\r\n            );\r\n            part.isStatic = true;\r\n            break;\r\n        case '%shd':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                'shadowedVariablesMenu',\r\n                true\r\n            );\r\n            // part.isStatic = true;\r\n            break;\r\n        case '%lst':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    list1 : 'list1',\r\n                    list2 : 'list2',\r\n                    list3 : 'list3'\r\n                },\r\n                true\r\n            );\r\n            break;\r\n        case '%codeKind':\r\n            part = new InputSlotMorph(\r\n                null,\r\n                false,\r\n                {\r\n                    code : ['code'],\r\n                    header : ['header']\r\n                },\r\n                true\r\n            );\r\n            part.setContents(['code']);\r\n            break;\r\n        case '%l':\r\n            part = new ArgMorph('list');\r\n            break;\r\n        case '%b':\r\n            part = new BooleanSlotMorph();\r\n            break;\r\n        case '%boolUE':\r\n            part = new BooleanSlotMorph();\r\n            part.isUnevaluated = true;\r\n            break;\r\n        case '%bool':\r\n            part = new BooleanSlotMorph(true);\r\n            part.isStatic = true;\r\n            break;\r\n        case '%cmd':\r\n            part = new CommandSlotMorph();\r\n            break;\r\n        case '%rc':\r\n            part = new RingCommandSlotMorph();\r\n            part.isStatic = true;\r\n            break;\r\n        case '%rr':\r\n            part = new RingReporterSlotMorph();\r\n            part.isStatic = true;\r\n            break;\r\n        case '%rp':\r\n            part = new RingReporterSlotMorph(true);\r\n            part.isStatic = true;\r\n            break;\r\n        case '%c':\r\n            part = new CSlotMorph();\r\n            part.isStatic = true;\r\n            break;\r\n        case '%cs':\r\n            part = new CSlotMorph(); // non-static\r\n            break;\r\n        case '%cl':\r\n            part = new CSlotMorph();\r\n            part.isStatic = true; // rejects reporter drops\r\n            part.isLambda = true; // auto-reifies nested script\r\n            break;\r\n        case '%clr':\r\n            part = new ColorSlotMorph();\r\n            part.isStatic = true;\r\n            break;\r\n        case '%t':\r\n            part = new TemplateSlotMorph('a');\r\n            break;\r\n        case '%upvar':\r\n            part = new TemplateSlotMorph('\\u2191'); // up-arrow\r\n            break;\r\n        case '%f':\r\n            part = new FunctionSlotMorph();\r\n            break;\r\n        case '%r':\r\n            part = new ReporterSlotMorph();\r\n            break;\r\n        case '%p':\r\n            part = new ReporterSlotMorph(true);\r\n            break;\r\n\r\n    // code mapping (experimental)\r\n\r\n        case '%codeListPart':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // numeric?\r\n                {\r\n                    'list' : ['list'],\r\n                    'item' : ['item'],\r\n                    'delimiter' : ['delimiter']\r\n                },\r\n                true // read-only\r\n            );\r\n            break;\r\n        case '%codeListKind':\r\n            part = new InputSlotMorph(\r\n                null, // text\r\n                false, // numeric?\r\n                {\r\n                    'collection' : ['collection'],\r\n                    'variables' : ['variables'],\r\n                    'parameters' : ['parameters']\r\n                },\r\n                true // read-only\r\n            );\r\n            break;\r\n\r\n    // symbols:\r\n\r\n        case '%turtle':\r\n            part = new SymbolMorph('turtle');\r\n            part.size = this.fontSize * 1.2;\r\n            part.color = new Color(255, 255, 255);\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%turtleOutline':\r\n            part = new SymbolMorph('turtleOutline');\r\n            part.size = this.fontSize;\r\n            part.color = new Color(255, 255, 255);\r\n            part.isProtectedLabel = true; // doesn't participate in zebraing\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%clockwise':\r\n            part = new SymbolMorph('turnRight');\r\n            part.size = this.fontSize * 1.5;\r\n            part.color = new Color(255, 255, 255);\r\n            part.isProtectedLabel = false; // zebra colors\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%counterclockwise':\r\n            part = new SymbolMorph('turnLeft');\r\n            part.size = this.fontSize * 1.5;\r\n            part.color = new Color(255, 255, 255);\r\n            part.isProtectedLabel = false; // zebra colors\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%greenflag':\r\n            part = new SymbolMorph('flag');\r\n            part.size = this.fontSize * 1.5;\r\n            part.color = new Color(0, 200, 0);\r\n            part.isProtectedLabel = true; // doesn't participate in zebraing\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%stop':\r\n            part = new SymbolMorph('octagon');\r\n            part.size = this.fontSize * 1.5;\r\n            part.color = new Color(200, 0, 0);\r\n            part.isProtectedLabel = true; // doesn't participate in zebraing\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        case '%pause':\r\n            part = new SymbolMorph('pause');\r\n            part.size = this.fontSize;\r\n            part.color = new Color(255, 220, 0);\r\n            part.isProtectedLabel = true; // doesn't participate in zebraing\r\n            part.shadowColor = this.color.darker(this.labelContrast);\r\n            part.shadowOffset = MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing;\r\n            part.drawNew();\r\n            break;\r\n        default:\r\n            nop();\r\n        }\r\n    } else if (spec[0] === '$' &&\r\n            spec.length > 1 &&\r\n            this.selector !== 'reportGetVar') {\r\n/*\r\n        // allow costumes as label symbols\r\n        // has issues when loading costumes (asynchronously)\r\n        // commented out for now\r\n*/\r\n\r\n        // allow GUI symbols as label icons\r\n        // usage: $symbolName[-size-r-g-b], size and color values are optional\r\n        // If there isn't a symbol under that name, it just styles whatever is\r\n        // after \"$\", so you can add unicode icons to your blocks, for example\r\n        // \r\n        tokens = spec.slice(1).split('-');\r\n        if (!contains(SymbolMorph.prototype.names, tokens[0])) {\r\n            part = new StringMorph(tokens[0]);\r\n            part.fontName = this.labelFontName;\r\n            part.fontStyle = this.labelFontStyle;\r\n            part.fontSize = this.fontSize * (+tokens[1] || 1);\r\n        } else {\r\n            part = new SymbolMorph(tokens[0]);\r\n            part.size = this.fontSize * (+tokens[1] || 1.2);\r\n        }\r\n        part.color = new Color(\r\n            +tokens[2] === 0 ? 0 : +tokens[2] || 255,\r\n            +tokens[3] === 0 ? 0 : +tokens[3] || 255,\r\n            +tokens[4] === 0 ? 0 : +tokens[4] || 255\r\n        );\r\n        part.isProtectedLabel = tokens.length > 2; // zebra colors\r\n        part.shadowColor = this.color.darker(this.labelContrast);\r\n        part.shadowOffset = MorphicPreferences.isFlat ?\r\n                new Point() : this.embossing;\r\n        part.drawNew();\r\n    } else {\r\n        part = new StringMorph(\r\n            spec, // text\r\n            this.fontSize, // fontSize\r\n            this.labelFontStyle, // fontStyle\r\n            true, // bold\r\n            false, // italic\r\n            false, // isNumeric\r\n            MorphicPreferences.isFlat ?\r\n                    new Point() : this.embossing, // shadowOffset\r\n            this.color.darker(this.labelContrast), // shadowColor\r\n            new Color(255, 255, 255), // color\r\n            this.labelFontName // fontName\r\n        );\r\n    }\r\n    return part;\r\n};\r\n\r\nSyntaxElementMorph.prototype.isObjInputFragment = function () {\r\n    // private - for displaying a symbol in a variable block template\r\n    return (this.selector === 'reportGetVar') &&\r\n        (this.getSlotSpec() === '%t') &&\r\n        (this.parent.fragment.type === '%obj');\r\n};\r\n\r\n// SyntaxElementMorph layout:\r\n\r\nSyntaxElementMorph.prototype.fixLayout = function (silently) {\r\n    var nb,\r\n        parts = this.parts(),\r\n        myself = this,\r\n        x = 0,\r\n        y,\r\n        lineHeight = 0,\r\n        maxX = 0,\r\n        blockWidth = this.minWidth,\r\n        blockHeight,\r\n        affected,\r\n        l = [],\r\n        lines = [],\r\n        space = this.isPrototype ?\r\n                1 : Math.floor(fontHeight(this.fontSize) / 3),\r\n        ico = this.isCustomBlock && !this.isGlobal ?\r\n                this.methodIconExtent().x + space : 0,\r\n        bottomCorrection,\r\n        initialExtent = this.extent();\r\n\r\n    if ((this instanceof MultiArgMorph) && (this.slotSpec !== '%c')) {\r\n        blockWidth += this.arrows().width();\r\n    } else if (this instanceof ReporterBlockMorph) {\r\n        blockWidth += (this.rounding * 2) + (this.edge * 2);\r\n    } else {\r\n        blockWidth += (this.corner * 4)\r\n            + (this.edge * 2)\r\n            + (this.inset * 3)\r\n            + this.dent;\r\n    }\r\n\r\n    if (this.nextBlock) {\r\n        nb = this.nextBlock();\r\n    }\r\n\r\n    // determine lines\r\n    parts.forEach(function (part) {\r\n        if ((part instanceof CSlotMorph)\r\n                || (part.slotSpec === '%c')) {\r\n            if (l.length > 0) {\r\n                lines.push(l);\r\n                lines.push([part]);\r\n                l = [];\r\n                x = 0;\r\n            } else {\r\n                lines.push([part]);\r\n            }\r\n        } else if (part instanceof BlockHighlightMorph) {\r\n            nop(); // should be redundant now\r\n            // myself.fullChanged();\r\n            // myself.removeChild(part);\r\n        } else {\r\n            if (part.isVisible) {\r\n                x += part.fullBounds().width() + space;\r\n            }\r\n            if ((x > myself.labelWidth) || part.isBlockLabelBreak) {\r\n                if (l.length > 0) {\r\n                    lines.push(l);\r\n                    l = [];\r\n                    x = part.fullBounds().width() + space;\r\n                }\r\n            }\r\n            l.push(part);\r\n            if (part.isBlockLabelBreak) {\r\n                x = 0;\r\n            }\r\n        }\r\n    });\r\n    if (l.length > 0) {\r\n        lines.push(l);\r\n    }\r\n\r\n    // distribute parts on lines\r\n    if (this instanceof CommandBlockMorph) {\r\n        y = this.top() + this.corner + this.edge;\r\n        if (this instanceof HatBlockMorph) {\r\n            y += this.hatHeight;\r\n        }\r\n    } else if (this instanceof ReporterBlockMorph) {\r\n        y = this.top() + (this.edge * 2);\r\n    } else if (this instanceof MultiArgMorph\r\n            || this instanceof ArgLabelMorph) {\r\n        y = this.top();\r\n    }\r\n    lines.forEach(function (line) {\r\n        x = myself.left() + ico + myself.edge + myself.labelPadding;\r\n        if (myself instanceof RingMorph) {\r\n            x = myself.left() + space; //myself.labelPadding;\r\n        } else if (myself.isPredicate) {\r\n            x = myself.left() + ico + myself.rounding;\r\n        } else if (myself instanceof MultiArgMorph\r\n                || myself instanceof ArgLabelMorph) {\r\n            x = myself.left();\r\n        }\r\n        y += lineHeight;\r\n        lineHeight = 0;\r\n        line.forEach(function (part) {\r\n            if (part instanceof CSlotMorph) {\r\n                x -= myself.labelPadding;\r\n                if (myself.isPredicate) {\r\n                    x = myself.left() + ico + myself.rounding;\r\n                }\r\n                part.setColor(myself.color);\r\n                part.setPosition(new Point(x, y));\r\n                lineHeight = part.height();\r\n            } else {\r\n                part.setPosition(new Point(x, y));\r\n                if (!part.isBlockLabelBreak) {\r\n                    if (part.slotSpec === '%c') {\r\n                        x += part.width();\r\n                    } else if (part.isVisible) {\r\n                        x += part.fullBounds().width() + space;\r\n                    }\r\n                }\r\n                maxX = Math.max(maxX, x);\r\n                lineHeight = Math.max(\r\n                    lineHeight,\r\n                    part instanceof StringMorph ?\r\n                            part.rawHeight() : part.height()\r\n                );\r\n            }\r\n        });\r\n\r\n    // center parts vertically on each line:\r\n        line.forEach(function (part) {\r\n            part.moveBy(new Point(\r\n                0,\r\n                Math.floor((lineHeight - part.height()) / 2)\r\n            ));\r\n        });\r\n    });\r\n\r\n    // determine my height:\r\n    y += lineHeight;\r\n    if (this.children.some(function (any) {\r\n            return any instanceof CSlotMorph;\r\n        })) {\r\n        bottomCorrection = this.bottomPadding;\r\n        if (this instanceof ReporterBlockMorph && !this.isPredicate) {\r\n            bottomCorrection = Math.max(\r\n                this.bottomPadding,\r\n                this.rounding - this.bottomPadding\r\n            );\r\n        }\r\n        y += bottomCorrection;\r\n    }\r\n    if (this instanceof CommandBlockMorph) {\r\n        blockHeight = y - this.top() + (this.corner * 2);\r\n    } else if (this instanceof ReporterBlockMorph) {\r\n        blockHeight = y - this.top() + (this.edge * 2);\r\n    } else if (this instanceof MultiArgMorph\r\n            || this instanceof ArgLabelMorph) {\r\n        blockHeight = y - this.top();\r\n    }\r\n\r\n    // determine my width:\r\n    if (this.isPredicate) {\r\n        blockWidth = Math.max(\r\n            blockWidth,\r\n            maxX - this.left() + this.rounding\r\n        );\r\n    } else if (this instanceof MultiArgMorph\r\n            || this instanceof ArgLabelMorph) {\r\n        blockWidth = Math.max(\r\n            blockWidth,\r\n            maxX - this.left() - space\r\n        );\r\n    } else {\r\n        blockWidth = Math.max(\r\n            blockWidth,\r\n            maxX - this.left() + this.labelPadding - this.edge\r\n        );\r\n        // adjust right padding if rightmost input has arrows\r\n        if (parts[parts.length - 1] instanceof MultiArgMorph\r\n                && (lines.length === 1)) {\r\n            blockWidth -= space;\r\n        }\r\n        // adjust width to hat width\r\n        if (this instanceof HatBlockMorph) {\r\n            blockWidth = Math.max(blockWidth, this.hatWidth * 1.5);\r\n        }\r\n    }\r\n\r\n    // set my extent (silently, because we'll redraw later anyway):\r\n    this.silentSetExtent(new Point(blockWidth, blockHeight));\r\n\r\n    // adjust CSlots\r\n    parts.forEach(function (part) {\r\n        if (part instanceof CSlotMorph) {\r\n            if (myself.isPredicate) {\r\n                part.setWidth(blockWidth - ico - myself.rounding * 2);\r\n            } else {\r\n                part.setWidth(blockWidth - myself.edge - ico);\r\n            }\r\n        }\r\n    });\r\n\r\n    // redraw in order to erase CSlot backgrounds\r\n    if (!silently) {this.drawNew(); }\r\n\r\n    // position next block:\r\n    if (nb) {\r\n        nb.setPosition(\r\n            new Point(\r\n                this.left(),\r\n                this.bottom() - (this.corner)\r\n            )\r\n        );\r\n    }\r\n\r\n    // find out if one of my parents needs to be fixed\r\n    if (this instanceof CommandBlockMorph) {\r\n        if (this.height() !== initialExtent.y) {\r\n            affected = this.parentThatIsA(CommandSlotMorph);\r\n            if (affected) {\r\n                affected.fixLayout();\r\n            }\r\n        }\r\n        if (this.width() !== initialExtent.x) {\r\n            affected = this.parentThatIsAnyOf(\r\n                [ReporterBlockMorph, CommandSlotMorph, RingCommandSlotMorph]\r\n            );\r\n            if (affected) {\r\n                affected.fixLayout();\r\n            }\r\n        }\r\n        if (affected) {\r\n            return;\r\n        }\r\n    } else if (this instanceof ReporterBlockMorph) {\r\n        if (this.parent) {\r\n            if (this.parent.fixLayout) {\r\n                return this.parent.fixLayout();\r\n            }\r\n        }\r\n    }\r\n\r\n    this.fixHighlight();\r\n};\r\n\r\nSyntaxElementMorph.prototype.fixHighlight = function () {\r\n    var top = this.topBlock();\r\n    if (top.getHighlight && top.getHighlight()) {\r\n        top.addHighlight(top.removeHighlight());\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.methodIconExtent = function () {\r\n    // answer the span of the icon for the \"local method\" indicator\r\n    var ico = this.fontSize * 1.2;\r\n    return this.isCustomBlock && !this.isGlobal ?\r\n            new Point(ico * 0.66, ico) : new Point(0, 0);\r\n};\r\n\r\n// SyntaxElementMorph evaluating:\r\n\r\nSyntaxElementMorph.prototype.evaluate = function () {\r\n    // responsibility of my children, default is to answer null\r\n    return null;\r\n};\r\n\r\nSyntaxElementMorph.prototype.isEmptySlot = function () {\r\n    // responsibility of my children, default is to answer false\r\n    return false;\r\n};\r\n\r\n// SyntaxElementMorph speech bubble feedback:\r\n\r\nSyntaxElementMorph.prototype.showBubble = function (value, exportPic, target) {\r\n    var bubble,\r\n        txt,\r\n        img,\r\n        morphToShow,\r\n        isClickable = false,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        anchor = this,\r\n        pos = this.rightCenter().add(new Point(2, 0)),\r\n        sf = this.parentThatIsA(ScrollFrameMorph),\r\n        wrrld = this.world();\r\n\r\n    if ((value === undefined) || !wrrld) {\r\n        return null;\r\n    }\r\n    if (value instanceof ListWatcherMorph) {\r\n        morphToShow = value;\r\n        morphToShow.update(true);\r\n        morphToShow.step = value.update;\r\n        morphToShow.isDraggable = false;\r\n        morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent());\r\n        isClickable = true;\r\n    } else if (value instanceof TableFrameMorph) {\r\n        morphToShow = value;\r\n        morphToShow.isDraggable = false;\r\n        morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent());\r\n        isClickable = true;\r\n    } else if (value instanceof Morph) {\r\n        if (isSnapObject(value)) {\r\n            img = value.thumbnail(new Point(40, 40));\r\n            morphToShow = new Morph();\r\n            morphToShow.silentSetWidth(img.width);\r\n            morphToShow.silentSetHeight(img.height);\r\n            morphToShow.image = img;\r\n            morphToShow.version = value.version;\r\n            morphToShow.step = function () {\r\n                if (this.version !== value.version) {\r\n                    img = value.thumbnail(new Point(40, 40));\r\n                    this.image = img;\r\n                    this.version = value.version;\r\n                    this.changed();\r\n                }\r\n            };\r\n        } else {\r\n            img = value.fullImage();\r\n            morphToShow = new Morph();\r\n            morphToShow.silentSetWidth(img.width);\r\n            morphToShow.silentSetHeight(img.height);\r\n            morphToShow.image = img;\r\n        }\r\n    } else if (value instanceof Costume) {\r\n        img = value.thumbnail(new Point(40, 40));\r\n        morphToShow = new Morph();\r\n        morphToShow.silentSetWidth(img.width);\r\n        morphToShow.silentSetHeight(img.height);\r\n        morphToShow.image = img;\r\n    } else if (value instanceof Sound) {\r\n        morphToShow = new SymbolMorph('notes', 30);\r\n    } else if (value instanceof Context) {\r\n        img = value.image();\r\n        morphToShow = new Morph();\r\n        morphToShow.silentSetWidth(img.width);\r\n        morphToShow.silentSetHeight(img.height);\r\n        morphToShow.image = img;\r\n    } else if (typeof value === 'boolean') {\r\n        morphToShow = SpriteMorph.prototype.booleanMorph.call(\r\n            null,\r\n            value\r\n        );\r\n    } else if (isString(value)) {\r\n        txt  = value.length > 500 ? value.slice(0, 500) + '...' : value;\r\n        morphToShow = new TextMorph(\r\n            txt,\r\n            this.fontSize\r\n        );\r\n    } else if (value === null) {\r\n        morphToShow = new TextMorph(\r\n            '',\r\n            this.fontSize\r\n        );\r\n    } else if (value === 0) {\r\n        morphToShow = new TextMorph(\r\n            '0',\r\n            this.fontSize\r\n        );\r\n    } else if (value.toString) {\r\n        morphToShow = new TextMorph(\r\n            value.toString(),\r\n            this.fontSize\r\n        );\r\n    }\r\n    if (ide && (ide.currentSprite !== target)) {\r\n        if (target instanceof StageMorph) {\r\n            anchor = ide.corral.stageIcon;\r\n        } else {\r\n        \tif (target.isTemporary) {\r\n         \t\ttarget = detect(\r\n\t\t\t\t\ttarget.allExemplars(),\r\n     \t\t\t\tfunction (each) {return !each.isTemporary; }\r\n         \t\t);\r\n     \t\t}\r\n            anchor = detect(\r\n                ide.corral.frame.contents.children,\r\n                function (icon) {return icon.object === target; }\r\n            );\r\n        }\r\n        pos = anchor.center();\r\n    }\r\n    bubble = new SpeechBubbleMorph(\r\n        morphToShow,\r\n        null,\r\n        Math.max(this.rounding - 2, 6),\r\n        0\r\n    );\r\n    bubble.popUp(\r\n        wrrld,\r\n        pos,\r\n        isClickable\r\n    );\r\n    if (exportPic) {\r\n        this.exportPictureWithResult(bubble);\r\n    }\r\n    if (anchor instanceof SpriteIconMorph) {\r\n        bubble.keepWithin(ide.corral);\r\n    } else if (sf) {\r\n        bubble.keepWithin(sf);\r\n    }\r\n};\r\n\r\nSyntaxElementMorph.prototype.exportPictureWithResult = function (aBubble) {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        scr = this.fullImage(),\r\n        bub = aBubble.fullImageClassic(),\r\n        taller = Math.max(0, bub.height - scr.height),\r\n        pic = newCanvas(new Point(\r\n            scr.width + bub.width + 2,\r\n            scr.height + taller\r\n        )),\r\n        ctx = pic.getContext('2d');\r\n    ctx.drawImage(scr, 0, pic.height - scr.height);\r\n    ctx.drawImage(bub, scr.width + 2, 0);\r\n    // request to open pic in new window.\r\n    ide.saveCanvasAs(\r\n        pic,\r\n        (ide.projectName || localize('untitled')) + ' ' + localize('script pic')\r\n    );\r\n};\r\n\r\n// SyntaxElementMorph code mapping\r\n\r\n/*\r\n    code mapping lets you use blocks to generate arbitrary text-based\r\n    source code that can be exported and compiled / embedded elsewhere,\r\n    it's not part of Snap's evaluator and not needed for Snap itself\r\n*/\r\n\r\nSyntaxElementMorph.prototype.mappedCode = function (definitions) {\r\n    var result = this.evaluate();\r\n    if (result instanceof BlockMorph) {\r\n        return result.mappedCode(definitions);\r\n    }\r\n    return result;\r\n};\r\n\r\n// SyntaxElementMorph layout update optimization\r\n\r\nSyntaxElementMorph.prototype.startLayout = function () {\r\n    this.topBlock().fullChanged();\r\n    Morph.prototype.trackChanges = false;\r\n};\r\n\r\nSyntaxElementMorph.prototype.endLayout = function () {\r\n    Morph.prototype.trackChanges = true;\r\n    this.topBlock().fullChanged();\r\n};\r\n\r\n// BlockMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an abstraction of all blocks (commands, reporters, hats).\r\n\r\n    Aside from the visual settings inherited from Morph and\r\n    SyntaxElementMorph my most important attributes and public\r\n    accessors are:\r\n\r\n    selector        - (string) name of method to be triggered\r\n    scriptTarget()  - answer the object (sprite) to which I apply\r\n    inputs()        - answer an array with my arg slots and nested reporters\r\n    defaults        - an optional Array containing default input values\r\n    topBlock()      - answer the top block of the stack I'm attached to\r\n    blockSpec       - a formalized description of my label parts\r\n    setSpec()       - force me to change my label structure\r\n    evaluate()      - answer the result of my evaluation\r\n    isUnevaluated() - answer whether I am part of a special form\r\n\r\n    Zebra coloring provides a mechanism to alternate brightness of nested,\r\n    same colored blocks (of the same category). The deviation of alternating\r\n    brightness is set in the preferences setting:\r\n\r\n    zebraContrast - <number> percentage of brightness deviation\r\n\r\n    attribute. If the attribute is set to zero, zebra coloring is turned\r\n    off. If it is a positive number, nested blocks will be colored in\r\n    a brighter shade of the same hue and the label color (for texts)\r\n    alternates between white and black. If the attribute is set to a negative\r\n    number, nested blocks are colored in a darker shade of the same hue\r\n    with no alternating label colors.\r\n\r\n    Note: Some of these methods are inherited from SyntaxElementMorph\r\n    for technical reasons, because they are shared among Block and\r\n    MultiArgMorph (e.g. topBlock()).\r\n\r\n    blockSpec is a formatted string consisting of plain words and\r\n    reserved words starting with the percent character (%), which\r\n    represent the following pre-defined input slots and/or label\r\n    features:\r\n\r\n    arity: single\r\n\r\n    %br     - user-forced line break\r\n    %s      - white rectangular type-in slot (\"string-type\")\r\n    %txt    - white rectangular type-in slot (\"text-type\")\r\n    %mlt    - white rectangular type-in slot (\"multi-line-text-type\")\r\n    %code   - white rectangular type-in slot, monospaced font\r\n    %n      - white roundish type-in slot (\"numerical\")\r\n    %dir    - white roundish type-in slot with drop-down for directions\r\n    %inst   - white roundish type-in slot with drop-down for instruments\r\n    %ida    - white roundish type-in slot with drop-down for list indices\r\n    %idx    - white roundish type-in slot for indices incl. \"any\"\r\n    %obj    - specially drawn slot for object reporters\r\n    %spr    - chameleon colored rectangular drop-down for object-names\r\n    %col    - chameleon colored rectangular drop-down for collidables\r\n    %dst    - chameleon colored rectangular drop-down for distances\r\n    %cst    - chameleon colored rectangular drop-down for costume-names\r\n    %eff    - chameleon colored rectangular drop-down for graphic effects\r\n    %snd    - chameleon colored rectangular drop-down for sound names\r\n    %key    - chameleon colored rectangular drop-down for keyboard keys\r\n    %msg    - chameleon colored rectangular drop-down for messages\r\n    %att    - chameleon colored rectangular drop-down for attributes\r\n    %fun    - chameleon colored rectangular drop-down for math functions\r\n    %typ    - chameleon colored rectangular drop-down for data types\r\n    %var    - chameleon colored rectangular drop-down for variable names\r\n    %shd    - Chameleon colored rectuangular drop-down for shadowed var names\r\n    %lst    - chameleon colored rectangular drop-down for list names\r\n    %b      - chameleon colored hexagonal slot (for predicates)\r\n    %bool   - chameleon colored hexagonal slot (for predicates), static\r\n    %l      - list icon\r\n    %c      - C-shaped command slot, special form for primitives\r\n    %cs     - C-shaped, auto-reifying, accepts reporter drops\r\n    %cl     - C-shaped, auto-reifying, rejects reporters\r\n    %clr    - interactive color slot\r\n    %t      - inline variable reporter template\r\n    %anyUE  - white rectangular type-in slot, unevaluated if replaced\r\n    %boolUE - chameleon colored hexagonal slot, unevaluated if replaced\r\n    %f      - round function slot, unevaluated if replaced,\r\n    %r      - round reporter slot\r\n    %p      - hexagonal predicate slot\r\n\r\n    rings:\r\n\r\n    %cmdRing    - command slotted ring with %ringparms\r\n    %repRing    - round slotted ringn with %ringparms\r\n    %predRing   - diamond slotted ring with %ringparms\r\n\r\n    arity: multiple\r\n\r\n    %mult%x      - where %x stands for any of the above single inputs\r\n    %inputs      - for an additional text label 'with inputs'\r\n    %words       - for an expandable list of default 2 (used in JOIN)\r\n    %exp         - for a static expandable list of minimum 0 (used in LIST)\r\n    %scriptVars  - for an expandable list of variable reporter templates\r\n    %parms       - for an expandable list of formal parameters\r\n    %ringparms   - the same for use inside Rings\r\n\r\n    special form: upvar\r\n\r\n    %upvar       - same as %t (inline variable reporter template)\r\n\r\n    special form: input name\r\n\r\n    %inputName   - variable blob (used in input type dialog)\r\n\r\n    examples:\r\n\r\n        'if %b %c else %c'        - creates Scratch's If/Else block\r\n        'set pen color to %clr'   - creates Scratch's Pen color block\r\n        'list %mult%s'            - creates BYOB's list reporter block\r\n        'call %n %inputs'         - creates BYOB's Call block\r\n        'the script %parms %c'    - creates BYOB's THE SCRIPT block\r\n*/\r\n\r\n// BlockMorph inherits from SyntaxElementMorph:\r\n\r\nBlockMorph.prototype = new SyntaxElementMorph();\r\nBlockMorph.prototype.constructor = BlockMorph;\r\nBlockMorph.uber = SyntaxElementMorph.prototype;\r\n\r\n// BlockMorph preferences settings:\r\n\r\nBlockMorph.prototype.isCachingInputs = true;\r\nBlockMorph.prototype.zebraContrast = 40; // alternating color brightness\r\n\r\n// BlockMorph sound feedback:\r\n\r\nBlockMorph.prototype.snapSound = null;\r\n\r\nBlockMorph.prototype.toggleSnapSound = function () {\r\n    if (this.snapSound !== null) {\r\n        this.snapSound = null;\r\n    } else {\r\n        BlockMorph.prototype.snapSound = document.createElement('audio');\r\n        BlockMorph.prototype.snapSound.src = 'click.wav';\r\n    }\r\n    CommentMorph.prototype.snapSound = BlockMorph.prototype.snapSound;\r\n};\r\n\r\n// BlockMorph instance creation:\r\n\r\nfunction BlockMorph() {\r\n    this.init();\r\n}\r\n\r\nBlockMorph.prototype.init = function (silently) {\r\n    this.selector = null; // name of method to be triggered\r\n    this.blockSpec = ''; // formal description of label and arguments\r\n    this.comment = null; // optional \"sticky\" comment morph\r\n\r\n    // not to be persisted:\r\n    this.instantiationSpec = null; // spec to set upon fullCopy() of template\r\n    this.category = null; // for zebra coloring (non persistent)\r\n    this.isCorpse = false; // marked for deletion fom a custom block definition\r\n\r\n    BlockMorph.uber.init.call(this, silently);\r\n    this.color = new Color(0, 17, 173);\r\n    this.cachedInputs = null;\r\n};\r\n\r\nBlockMorph.prototype.scriptTarget = function () {\r\n    // answer the sprite or stage that this block acts on,\r\n    // if the user clicks on it.\r\n    // NOTE: since scripts can be shared by more than a single sprite\r\n    // this method only gives the desired result within the context of\r\n    // the user actively clicking on a block inside the IDE\r\n    // there is no direct relationship between a block and a sprite.\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        ide;\r\n    if (scripts) {\r\n        return scripts.scriptTarget();\r\n    }\r\n    ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        return ide.currentSprite;\r\n    }\r\n    throw new Error('script target cannot be found for orphaned block');\r\n};\r\n\r\nBlockMorph.prototype.toString = function () {\r\n    return 'a ' +\r\n        (this.constructor.name ||\r\n            this.constructor.toString().split(' ')[1].split('(')[0]) +\r\n        ' (\"' +\r\n        this.blockSpec.slice(0, 30) + '...\")';\r\n};\r\n\r\n// BlockMorph spec:\r\n\r\nBlockMorph.prototype.parseSpec = function (spec) {\r\n    var result = [],\r\n        words,\r\n        word = '';\r\n\r\n    words = isString(spec) ? spec.split(' ') : [];\r\n    if (words.length === 0) {\r\n        words = [spec];\r\n    }\r\n    if (this.labelWordWrap) {\r\n        return words;\r\n    }\r\n\r\n    function addWord(w) {\r\n        if ((w[0] === '%') && (w.length > 1)) {\r\n            if (word !== '') {\r\n                result.push(word);\r\n                word = '';\r\n            }\r\n            result.push(w);\r\n        } else {\r\n            if (word !== '') {\r\n                word += ' ' + w;\r\n            } else {\r\n                word = w;\r\n            }\r\n        }\r\n    }\r\n\r\n    words.forEach(function (each) {\r\n        addWord(each);\r\n    });\r\n    if (word !== '') {\r\n        result.push(word);\r\n    }\r\n    return result;\r\n};\r\n\r\nBlockMorph.prototype.setSpec = function (spec, silently, definition) {\r\n    var myself = this,\r\n        part,\r\n        inputIdx = -1;\r\n\r\n    if (!spec) {return; }\r\n    this.parts().forEach(function (part) {\r\n        part.destroy();\r\n    });\r\n    if (this.isPrototype) {\r\n        this.add(this.placeHolder());\r\n    }\r\n    this.parseSpec(spec).forEach(function (word) {\r\n        if (word[0] === '%') {\r\n            inputIdx += 1;\r\n        }\r\n        part = myself.labelPart(word);\r\n        if (isNil(part)) {\r\n            return;\r\n        }\r\n        myself.add(part);\r\n        if (!(part instanceof CommandSlotMorph ||\r\n                part instanceof StringMorph)) {\r\n            part.drawNew();\r\n        }\r\n        if (part instanceof RingMorph) {\r\n            part.fixBlockColor();\r\n        }\r\n        if (part instanceof MultiArgMorph ||\r\n                part.constructor === CommandSlotMorph ||\r\n                part.constructor === RingCommandSlotMorph) {\r\n            part.fixLayout();\r\n        }\r\n        if (myself.isPrototype) {\r\n            myself.add(myself.placeHolder());\r\n        }\r\n        if (part instanceof InputSlotMorph && myself.isCustomBlock) {\r\n            part.setChoices.apply(\r\n                part,\r\n                (definition || myself.definition).inputOptionsOfIdx(inputIdx)\r\n            );\r\n        }\r\n    });\r\n    this.blockSpec = spec;\r\n    this.fixLayout(silently);\r\n    this.cachedInputs = null;\r\n};\r\n\r\nBlockMorph.prototype.userSetSpec = function (spec) {\r\n    var tb = this.topBlock();\r\n    tb.fullChanged();\r\n    this.setSpec(spec);\r\n    tb.fullChanged();\r\n};\r\n\r\nBlockMorph.prototype.buildSpec = function () {\r\n    // create my blockSpec from my parts - for demo purposes only\r\n    var myself = this;\r\n    this.blockSpec = '';\r\n    this.parts().forEach(function (part) {\r\n        if (part instanceof StringMorph) {\r\n            myself.blockSpec += part.text;\r\n        } else if (part instanceof ArgMorph) {\r\n            myself.blockSpec += part.getSpec();\r\n        } else if (part.isBlockLabelBreak) {\r\n            myself.blockSpec += part.getSpec();\r\n        } else {\r\n            myself.blockSpec += '[undefined]';\r\n        }\r\n        myself.blockSpec += ' ';\r\n    });\r\n    this.blockSpec = this.blockSpec.trim();\r\n};\r\n\r\nBlockMorph.prototype.rebuild = function (contrast) {\r\n    // rebuild my label fragments, for use in ToggleElementMorphs\r\n    this.setSpec(this.blockSpec);\r\n    if (contrast) {\r\n        this.inputs().forEach(function (input) {\r\n            if (input instanceof ReporterBlockMorph) {\r\n                input.setColor(input.color.lighter(contrast));\r\n                input.setSpec(input.blockSpec);\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\n// BlockMorph menu:\r\n\r\nBlockMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        world = this.world(),\r\n        myself = this,\r\n        shiftClicked = world.currentKey === 16,\r\n        proc = this.activeProcess(),\r\n        vNames = proc && proc.context && proc.context.outerContext ?\r\n                proc.context.outerContext.variables.names() : [],\r\n        alternatives,\r\n        field,\r\n        rcvr,\r\n        top;\r\n\r\n    function addOption(label, toggle, test, onHint, offHint) {\r\n        var on = '\\u2611 ',\r\n            off = '\\u2610 ';\r\n        menu.addItem(\r\n            (test ? on : off) + localize(label),\r\n            toggle,\r\n            test ? onHint : offHint\r\n        );\r\n    }\r\n\r\n    function renameVar() {\r\n        var blck = myself.fullCopy();\r\n        blck.addShadow();\r\n        new DialogBoxMorph(\r\n            myself,\r\n            myself.userSetSpec,\r\n            myself\r\n        ).prompt(\r\n            \"Variable name\",\r\n            myself.blockSpec,\r\n            world,\r\n            blck.fullImage(), // pic\r\n            InputSlotMorph.prototype.getVarNamesDict.call(myself)\r\n        );\r\n    }\r\n\r\n    menu.addItem(\r\n        \"help...\",\r\n        'showHelp'\r\n    );\r\n    if (shiftClicked) {\r\n        top = this.topBlock();\r\n        if (top instanceof ReporterBlockMorph) {\r\n            menu.addItem(\r\n                \"script pic with result...\",\r\n                function () {\r\n                    top.exportResultPic();\r\n                },\r\n                'open a new window\\n' +\r\n                    'with a picture of both\\nthis script and its result',\r\n                new Color(100, 0, 0)\r\n            );\r\n        }\r\n    }\r\n    if (this.isTemplate) {\r\n        if (this.parent instanceof SyntaxElementMorph) { // in-line\r\n            if (this.selector === 'reportGetVar') { // script var definition\r\n                menu.addLine();\r\n                menu.addItem(\r\n                    'rename...',\r\n                    function () {\r\n                        myself.refactorThisVar(true); // just the template\r\n                    },\r\n                    'rename only\\nthis reporter'\r\n                );\r\n                menu.addItem(\r\n                    'rename all...',\r\n                    'refactorThisVar',\r\n                    'rename all blocks that\\naccess this variable'\r\n                );\r\n            }\r\n        } else { // in palette\r\n            if (this.selector === 'reportGetVar') {\r\n                rcvr = this.scriptTarget();\r\n                if (this.isInheritedVariable(false)) { // fully inherited\r\n                    addOption(\r\n                        'inherited',\r\n                        function () {\r\n                            rcvr.toggleInheritedVariable(myself.blockSpec);\r\n                        },\r\n                        true,\r\n                        'uncheck to\\ndisinherit',\r\n                        null\r\n                    );\r\n                } else { // not inherited\r\n                    if (this.isInheritedVariable(true)) { // shadowed\r\n                        addOption(\r\n                            'inherited',\r\n                            function () {\r\n                                rcvr.toggleInheritedVariable(myself.blockSpec);\r\n                            },\r\n                            false,\r\n                            null,\r\n                            localize('check to inherit\\nfrom')\r\n                                + ' ' + rcvr.exemplar.name\r\n                        );\r\n                    }\r\n                    addOption(\r\n                        'transient',\r\n                        'toggleTransientVariable',\r\n                        myself.isTransientVariable(),\r\n                        'uncheck to save contents\\nin the project',\r\n                        'check to prevent contents\\nfrom being saved'\r\n                    );\r\n                    menu.addLine();\r\n                    menu.addItem(\r\n                        'rename...',\r\n                        function () {\r\n                            myself.refactorThisVar(true); // just the template\r\n                        },\r\n                        'rename only\\nthis reporter'\r\n                    );\r\n                    menu.addItem(\r\n                        'rename all...',\r\n                        'refactorThisVar',\r\n                        'rename all blocks that\\naccess this variable'\r\n                    );\r\n                }\r\n            } else if (this.selector !== 'evaluateCustomBlock') {\r\n                menu.addItem(\r\n                    \"hide\",\r\n                    'hidePrimitive'\r\n                );\r\n            }\r\n\r\n            // allow toggling inheritable attributes\r\n            if (StageMorph.prototype.enableInheritance) {\r\n                rcvr = this.scriptTarget();\r\n                field = {\r\n                    xPosition: 'x position',\r\n                    yPosition: 'y position',\r\n                    direction: 'direction',\r\n                    getScale: 'size',\r\n                    getCostumeIdx: 'costume #'\r\n                }[this.selector];\r\n                if (field && rcvr && rcvr.exemplar) {\r\n                    menu.addLine();\r\n                    addOption(\r\n                        'inherited',\r\n                        function () {\r\n                            rcvr.toggleInheritanceForAttribute(field);\r\n                        },\r\n                        rcvr.inheritsAttribute(field),\r\n                        'uncheck to\\ndisinherit',\r\n                        localize('check to inherit\\nfrom')\r\n                            + ' ' + rcvr.exemplar.name\r\n                    );\r\n                }\r\n            }\r\n\r\n            if (StageMorph.prototype.enableCodeMapping) {\r\n                menu.addLine();\r\n                menu.addItem(\r\n                    'header mapping...',\r\n                    'mapToHeader'\r\n                );\r\n                menu.addItem(\r\n                    'code mapping...',\r\n                    'mapToCode'\r\n                );\r\n            }\r\n        }\r\n        return menu;\r\n    }\r\n    menu.addLine();\r\n    if (this.selector === 'reportGetVar') {\r\n        menu.addItem(\r\n            'rename...',\r\n            renameVar,\r\n            'rename only\\nthis reporter'\r\n        );\r\n    } else if (SpriteMorph.prototype.blockAlternatives[this.selector]) {\r\n        menu.addItem(\r\n            'relabel...',\r\n            function () {\r\n                myself.relabel(\r\n                    SpriteMorph.prototype.blockAlternatives[myself.selector]\r\n                );\r\n            }\r\n        );\r\n    } else if (this.isCustomBlock && this.alternatives) {\r\n        alternatives = this.alternatives();\r\n        if (alternatives.length > 0) {\r\n            menu.addItem(\r\n                'relabel...',\r\n                function () {myself.relabel(alternatives); }\r\n            );\r\n        }\r\n    }\r\n\r\n    menu.addItem(\r\n        \"duplicate\",\r\n        function () {\r\n            var dup = myself.fullCopy(),\r\n                ide = myself.parentThatIsA(IDE_Morph),\r\n                blockEditor = myself.parentThatIsA(BlockEditorMorph);\r\n            dup.pickUp(world);\r\n            // register the drop-origin, so the block can\r\n            // slide back to its former situation if dropped\r\n            // somewhere where it gets rejected\r\n            if (!ide && blockEditor) {\r\n                ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n            }\r\n            if (ide) {\r\n                world.hand.grabOrigin = {\r\n                    origin: ide.palette,\r\n                    position: ide.palette.center()\r\n                };\r\n            }\r\n        },\r\n        'make a copy\\nand pick it up'\r\n    );\r\n    if (this instanceof CommandBlockMorph && this.nextBlock()) {\r\n        menu.addItem(\r\n            (proc ? this.fullCopy() : this).thumbnail(0.5, 60),\r\n            function () {\r\n                var cpy = myself.fullCopy(),\r\n                    nb = cpy.nextBlock(),\r\n                    ide = myself.parentThatIsA(IDE_Morph),\r\n                    blockEditor = myself.parentThatIsA(BlockEditorMorph);\r\n                if (nb) {nb.destroy(); }\r\n                cpy.pickUp(world);\r\n                if (!ide && blockEditor) {\r\n                    ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n                }\r\n                if (ide) {\r\n                    world.hand.grabOrigin = {\r\n                        origin: ide.palette,\r\n                        position: ide.palette.center()\r\n                    };\r\n                }\r\n            },\r\n            'only duplicate this block'\r\n        );\r\n    }\r\n    menu.addItem(\r\n        \"delete\",\r\n        'userDestroy'\r\n    );\r\n    menu.addItem(\r\n        \"script pic...\",\r\n        function () {\r\n            var ide = myself.parentThatIsA(IDE_Morph) ||\r\n                myself.parentThatIsA(BlockEditorMorph).target.parentThatIsA(\r\n                    IDE_Morph\r\n            );\r\n            ide.saveCanvasAs(\r\n                myself.topBlock().scriptPic(),\r\n                (ide.projectName || localize('untitled')) + ' ' +\r\n                    localize('script pic')\r\n            );\r\n        },\r\n        'open a new window\\nwith a picture of this script'\r\n    );\r\n    if (shiftClicked) {\r\n        menu.addItem(\r\n            'download script',\r\n            function () {\r\n                var ide = myself.parentThatIsA(IDE_Morph),\r\n                    blockEditor = myself.parentThatIsA(BlockEditorMorph);\r\n                if (!ide && blockEditor) {\r\n                    ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n                }\r\n                if (ide) {\r\n                    ide.saveXMLAs(\r\n                        ide.serializer.serialize(myself),\r\n                        myself.selector + ' script',\r\n                        false);\r\n                }\r\n            },\r\n            'download this script\\nas an XML file',\r\n            new Color(100, 0, 0)\r\n            );\r\n    }\r\n    if (proc) {\r\n        if (vNames.length) {\r\n            menu.addLine();\r\n            vNames.forEach(function (vn) {\r\n                menu.addItem(\r\n                    vn + '...',\r\n                    function () {\r\n                        proc.doShowVar(vn);\r\n                    }\r\n                );\r\n            });\r\n        }\r\n        proc.homeContext.variables.names().forEach(function (vn) {\r\n            if (!contains(vNames, vn)) {\r\n                menu.addItem(\r\n                    vn + '...',\r\n                    function () {\r\n                        proc.doShowVar(vn);\r\n                    }\r\n                );\r\n            }\r\n        });\r\n        return menu;\r\n    }\r\n    if (this.parent.parentThatIsA(RingMorph)) {\r\n        menu.addLine();\r\n        menu.addItem(\"unringify\", 'unringify');\r\n        top = this.topBlock();\r\n        if (this instanceof ReporterBlockMorph ||\r\n                (!(top instanceof HatBlockMorph))) {\r\n            menu.addItem(\"ringify\", 'ringify');\r\n        }\r\n        return menu;\r\n    }\r\n    if (this.parent instanceof ReporterSlotMorph\r\n            || (this.parent instanceof CommandSlotMorph)\r\n            || (this instanceof HatBlockMorph)\r\n            || (this instanceof CommandBlockMorph\r\n                && (this.topBlock() instanceof HatBlockMorph))) {\r\n        return menu;\r\n    }\r\n    menu.addLine();\r\n    menu.addItem(\"ringify\", 'ringify');\r\n    if (StageMorph.prototype.enableCodeMapping) {\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'header mapping...',\r\n            'mapToHeader'\r\n        );\r\n        menu.addItem(\r\n            'code mapping...',\r\n            'mapToCode'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\nBlockMorph.prototype.developersMenu = function () {\r\n    var menu = BlockMorph.uber.developersMenu.call(this);\r\n    menu.addLine();\r\n    menu.addItem(\"delete block\", 'deleteBlock');\r\n    menu.addItem(\"spec...\", function () {\r\n\r\n        new DialogBoxMorph(\r\n            this,\r\n            this.userSetSpec,\r\n            this\r\n        ).prompt(\r\n            menu.title + '\\nspec',\r\n            this.blockSpec,\r\n            this.world()\r\n        );\r\n    });\r\n    return menu;\r\n};\r\n\r\nBlockMorph.prototype.hidePrimitive = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        dict,\r\n        cat;\r\n    if (!ide) {return; }\r\n    StageMorph.prototype.hiddenPrimitives[this.selector] = true;\r\n    dict = {\r\n        doWarp: 'control',\r\n        reifyScript: 'operators',\r\n        reifyReporter: 'operators',\r\n        reifyPredicate: 'operators',\r\n        doDeclareVariables: 'variables'\r\n    };\r\n    cat = dict[this.selector] || this.category;\r\n    if (cat === 'lists') {cat = 'variables'; }\r\n    ide.flushBlocksCache(cat);\r\n    ide.refreshPalette();\r\n};\r\n\r\nBlockMorph.prototype.isInheritedVariable = function (shadowedOnly) {\r\n    // private - only for variable getter template inside the palette\r\n    if (this.isTemplate &&\r\n            (this.selector === 'reportGetVar') &&\r\n            (this.parent instanceof FrameMorph)) {\r\n        return contains(\r\n            this.scriptTarget().inheritedVariableNames(shadowedOnly),\r\n            this.blockSpec\r\n        );\r\n    }\r\n    return false;\r\n};\r\n\r\nBlockMorph.prototype.isTransientVariable = function () {\r\n    // private - only for variable getter template inside the palette\r\n    var varFrame = this.scriptTarget().variables.silentFind(this.blockSpec);\r\n    return varFrame ? varFrame.vars[this.blockSpec].isTransient : false;\r\n};\r\n\r\nBlockMorph.prototype.toggleTransientVariable = function () {\r\n    // private - only for variable getter template inside the palette\r\n    var varFrame = this.scriptTarget().variables.silentFind(this.blockSpec);\r\n    if (!varFrame) {return; }\r\n    varFrame.vars[this.blockSpec].isTransient =\r\n        !(varFrame.vars[this.blockSpec].isTransient);\r\n};\r\n\r\nBlockMorph.prototype.deleteBlock = function () {\r\n    // delete just this one block, keep inputs and next block around\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        nb = this.nextBlock ? this.nextBlock() : null,\r\n        tobefixed,\r\n        isindef;\r\n    if (scripts) {\r\n        if (nb) {\r\n            scripts.add(nb);\r\n        }\r\n        this.inputs().forEach(function (inp) {\r\n            if (inp instanceof BlockMorph) {\r\n                scripts.add(inp);\r\n            }\r\n        });\r\n    }\r\n    if (this instanceof ReporterBlockMorph &&\r\n\t\t\t((this.parent instanceof BlockMorph)\r\n            \t|| (this.parent instanceof MultiArgMorph)\r\n            \t|| (this.parent instanceof ReporterSlotMorph))) {\r\n        this.parent.revertToDefaultInput(this);\r\n    } else { // CommandBlockMorph\r\n        if (this.parent && this.parent.fixLayout) {\r\n            tobefixed = this.parentThatIsA(ArgMorph);\r\n        } else { // must be in a custom block definition\r\n            isindef = true;\r\n        }\r\n    }\r\n    this.destroy();\r\n    if (isindef) {\r\n        /*\r\n            since the definition's body still points to this block\r\n            even after it has been destroyed, mark it to be deleted\r\n            later.\r\n        */\r\n        this.isCorpse = true;\r\n    }\r\n    if (tobefixed) {\r\n        tobefixed.fixLayout();\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.ringify = function () {\r\n    // wrap a Ring around me\r\n    var ring, top, center,\r\n        target = this.selectForEdit(); // copy-on-edit\r\n    if (target !== this) {\r\n        return this.ringify.call(target);\r\n    }\r\n    ring = new RingMorph();\r\n    top = this.topBlock();\r\n    center = top.fullBounds().center();\r\n    if (this.parent === null) {return null; }\r\n    top.fullChanged();\r\n    if (this.parent instanceof SyntaxElementMorph) {\r\n        if (this instanceof ReporterBlockMorph) {\r\n            this.parent.silentReplaceInput(this, ring);\r\n            ring.embed(this);\r\n        } else if (top) { // command\r\n            if (top instanceof HatBlockMorph) {\r\n                return;\r\n            }\r\n            top.parent.add(ring);\r\n            ring.embed(top);\r\n            ring.setCenter(center);\r\n        }\r\n    } else {\r\n        this.parent.add(ring);\r\n        ring.embed(this);\r\n        ring.setCenter(center);\r\n    }\r\n    this.fixBlockColor(null, true);\r\n    top.fullChanged();\r\n};\r\n\r\nBlockMorph.prototype.unringify = function () {\r\n    // remove a Ring around me, if any\r\n    var ring, top, center, scripts, block,\r\n        target = this.selectForEdit(); // copy-on-edit\r\n    if (target !== this) {\r\n        return this.unringify.call(target);\r\n    }\r\n    ring = this.parent.parentThatIsA(RingMorph);\r\n    top = this.topBlock();\r\n    scripts = this.parentThatIsA(ScriptsMorph);\r\n    if (ring === null) {return null; }\r\n    block = ring.contents();\r\n    center = ring.center();\r\n\r\n    top.fullChanged();\r\n    if (ring.parent instanceof SyntaxElementMorph) {\r\n        if (block instanceof ReporterBlockMorph) {\r\n            ring.parent.silentReplaceInput(ring, block);\r\n        } else if (scripts) {\r\n            scripts.add(block);\r\n            block.setFullCenter(center);\r\n            block.moveBy(20);\r\n            ring.parent.revertToDefaultInput(ring);\r\n        }\r\n    } else {\r\n        ring.parent.add(block);\r\n        block.setFullCenter(center);\r\n        ring.destroy();\r\n    }\r\n    this.fixBlockColor(null, true);\r\n    top.fullChanged();\r\n};\r\n\r\nBlockMorph.prototype.relabel = function (alternativeSelectors) {\r\n    var menu, oldInputs, myself,\r\n        target = this.selectForEdit(); // copy-on-edit\r\n    if (target !== this) {\r\n        return this.relabel.call(target, alternativeSelectors);\r\n    }\r\n    menu = new MenuMorph(this);\r\n    oldInputs = this.inputs();\r\n    myself = this;\r\n    alternativeSelectors.forEach(function (sel) {\r\n        var block = SpriteMorph.prototype.blockForSelector(sel);\r\n        block.restoreInputs(oldInputs);\r\n        block.fixBlockColor(null, true);\r\n        block.addShadow(new Point(3, 3));\r\n        menu.addItem(\r\n            block,\r\n            function () {\r\n                myself.setSelector(sel);\r\n            }\r\n        );\r\n    });\r\n    menu.popup(this.world(), this.bottomLeft().subtract(new Point(\r\n        8,\r\n        this instanceof CommandBlockMorph ? this.corner : 0\r\n    )));\r\n};\r\n\r\nBlockMorph.prototype.setSelector = function (aSelector) {\r\n    // private - used only for relabel()\r\n    var oldInputs = this.inputs(),\r\n        scripts = this.parentThatIsA(ScriptsMorph),\r\n        surplus,\r\n        info;\r\n    info = SpriteMorph.prototype.blocks[aSelector];\r\n    this.setCategory(info.category);\r\n    this.selector = aSelector;\r\n    this.setSpec(localize(info.spec));\r\n    surplus = this.restoreInputs(oldInputs);\r\n    this.fixLabelColor();\r\n\r\n    // place surplus blocks on scipts\r\n    if (scripts && surplus.length) {\r\n        surplus.forEach(function (blk) {\r\n            blk.moveBy(10);\r\n            scripts.add(blk);\r\n        });\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.restoreInputs = function (oldInputs) {\r\n    // private - used only for relabel()\r\n    // try to restore my previous inputs when my spec has been changed\r\n    // return an Array of left-over blocks, if any\r\n    var i = 0,\r\n        old,\r\n        nb,\r\n        leftOver = [],\r\n        myself = this;\r\n\r\n    this.inputs().forEach(function (inp) {\r\n        old = oldInputs[i];\r\n        if (old instanceof ReporterBlockMorph) {\r\n            myself.silentReplaceInput(inp, old.fullCopy());\r\n        } else if (old && inp instanceof InputSlotMorph) {\r\n            // original - turns empty numberslots to 0:\r\n            // inp.setContents(old.evaluate());\r\n            // \"fix\" may be wrong b/c constants\r\n            if (old.contents) {\r\n                inp.setContents(old.contents().text);\r\n            }\r\n        } else if (old instanceof CSlotMorph && inp instanceof CSlotMorph) {\r\n            nb = old.nestedBlock();\r\n            if (nb) {\r\n                inp.nestedBlock(nb.fullCopy());\r\n            }\r\n        }\r\n        i += 1;\r\n    });\r\n\r\n    // gather surplus blocks\r\n    for (i; i < oldInputs.length; i += 1) {\r\n        old = oldInputs[i];\r\n        if (old instanceof ReporterBlockMorph) {\r\n            leftOver.push(old);\r\n        } else if (old instanceof CommandSlotMorph) {\r\n            nb = old.nestedBlock();\r\n            if (nb) {\r\n                leftOver.push(nb);\r\n            }\r\n        }\r\n    }\r\n    this.cachedInputs = null;\r\n    return leftOver;\r\n};\r\n\r\nBlockMorph.prototype.showHelp = function () {\r\n    var myself = this,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        blockEditor,\r\n        pic = new Image(),\r\n        help,\r\n        comment,\r\n        block,\r\n        spec = this.isCustomBlock ?\r\n                this.definition.helpSpec() : this.selector,\r\n        ctx;\r\n\r\n    if (!ide) {\r\n        blockEditor = this.parentThatIsA(BlockEditorMorph);\r\n        if (blockEditor) {\r\n            ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n        }\r\n    }\r\n\r\n    pic.onload = function () {\r\n        help = newCanvas(new Point(pic.width, pic.height), true); // nonRetina\r\n        ctx = help.getContext('2d');\r\n        ctx.drawImage(pic, 0, 0);\r\n        new DialogBoxMorph().inform(\r\n            'Help',\r\n            null,\r\n            myself.world(),\r\n            help\r\n        );\r\n    };\r\n\r\n    if (this.isCustomBlock && this.definition.comment) {\r\n        block = this.fullCopy();\r\n        block.addShadow();\r\n        comment = this.definition.comment.fullCopy();\r\n        comment.contents.parse();\r\n        help = '';\r\n        comment.contents.lines.forEach(function (line) {\r\n            help = help + '\\n' + line;\r\n        });\r\n        new DialogBoxMorph().inform(\r\n            'Help',\r\n            help.substr(1),\r\n            myself.world(),\r\n            block.fullImage()\r\n        );\r\n    } else {\r\n        pic.src = ide.resourceURL('help', spec + '.png');\r\n    }\r\n};\r\n\r\n// BlockMorph code mapping\r\n\r\n/*\r\n    code mapping lets you use blocks to generate arbitrary text-based\r\n    source code that can be exported and compiled / embedded elsewhere,\r\n    it's not part of Snap's evaluator and not needed for Snap itself\r\n*/\r\n\r\nBlockMorph.prototype.mapToHeader = function () {\r\n    // open a dialog box letting the user map header code via the GUI\r\n    var key = this.selector.substr(0, 5) === 'reify' ?\r\n            'reify' : this.selector,\r\n        block = this.codeDefinitionHeader(),\r\n        myself = this,\r\n        help,\r\n        pic;\r\n    block.addShadow(new Point(3, 3));\r\n    pic = block.fullImageClassic();\r\n    if (this.isCustomBlock) {\r\n        help = 'Enter code that corresponds to the block\\'s definition. ' +\r\n            'Use the formal parameter\\nnames as shown and <body> to ' +\r\n            'reference the definition body\\'s generated text code.';\r\n    } else {\r\n        help = 'Enter code that corresponds to the block\\'s definition. ' +\r\n            'Choose your own\\nformal parameter names (ignoring the ones ' +\r\n            'shown).';\r\n    }\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            if (key === 'evaluateCustomBlock') {\r\n                myself.definition.codeHeader = code;\r\n            } else {\r\n                StageMorph.prototype.codeHeaders[key] = code;\r\n            }\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Header mapping',\r\n        key === 'evaluateCustomBlock' ? this.definition.codeHeader || ''\r\n                 : StageMorph.prototype.codeHeaders[key] || '',\r\n        this.world(),\r\n        pic,\r\n        help\r\n    );\r\n};\r\n\r\nBlockMorph.prototype.mapToCode = function () {\r\n    // open a dialog box letting the user map code via the GUI\r\n    var key = this.selector.substr(0, 5) === 'reify' ?\r\n            'reify' : this.selector,\r\n        block = this.codeMappingHeader(),\r\n        myself = this,\r\n        pic;\r\n    block.addShadow(new Point(3, 3));\r\n    pic = block.fullImageClassic();\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            if (key === 'evaluateCustomBlock') {\r\n                myself.definition.codeMapping = code;\r\n            } else {\r\n                StageMorph.prototype.codeMappings[key] = code;\r\n            }\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping',\r\n        key === 'evaluateCustomBlock' ? this.definition.codeMapping || ''\r\n                 : StageMorph.prototype.codeMappings[key] || '',\r\n        this.world(),\r\n        pic,\r\n        'Enter code that corresponds to the block\\'s operation ' +\r\n            '(usually a single\\nfunction invocation). Use <#n> to ' +\r\n            'reference actual arguments as shown.'\r\n    );\r\n};\r\n\r\nBlockMorph.prototype.mapHeader = function (aString, key) {\r\n    // primitive for programatically mapping header code\r\n    var sel = key || this.selector.substr(0, 5) === 'reify' ?\r\n            'reify' : this.selector;\r\n    if (aString) {\r\n        if (this.isCustomBlock) {\r\n            this.definition.codeHeader = aString;\r\n        } else {\r\n            StageMorph.prototype.codeHeaders[sel] = aString;\r\n        }\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.mapCode = function (aString, key) {\r\n    // primitive for programatically mapping code\r\n    var sel = key || this.selector.substr(0, 5) === 'reify' ?\r\n            'reify' : this.selector;\r\n    if (aString) {\r\n        if (this.isCustomBlock) {\r\n            this.definition.codeMapping = aString;\r\n        } else {\r\n            StageMorph.prototype.codeMappings[sel] = aString;\r\n        }\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.mappedCode = function (definitions) {\r\n    var key = this.selector.substr(0, 5) === 'reify' ?\r\n            'reify' : this.selector,\r\n        code,\r\n        codeLines,\r\n        count = 1,\r\n        header,\r\n        headers,\r\n        headerLines,\r\n        body,\r\n        bodyLines,\r\n        defKey = this.isCustomBlock ? this.definition.spec : key,\r\n        defs = definitions || {},\r\n        parts = [];\r\n    code = key === 'reportGetVar' ? this.blockSpec\r\n            : this.isCustomBlock ? this.definition.codeMapping || ''\r\n                    : StageMorph.prototype.codeMappings[key] || '';\r\n\r\n    // map header\r\n    if (key !== 'reportGetVar' && !defs.hasOwnProperty(defKey)) {\r\n        defs[defKey] = null; // create the property for recursive definitions\r\n        if (this.isCustomBlock) {\r\n            header = this.definition.codeHeader || '';\r\n            if (header.indexOf('<body') !== -1) { // replace with def mapping\r\n                body = '';\r\n                if (this.definition.body) {\r\n                    body = this.definition.body.expression.mappedCode(defs);\r\n                }\r\n                bodyLines = body.split('\\n');\r\n                headerLines = header.split('\\n');\r\n                headerLines.forEach(function (headerLine, idx) {\r\n                    var prefix = '',\r\n                        indent;\r\n                    if (headerLine.trimLeft().indexOf('<body') === 0) {\r\n                        indent = headerLine.indexOf('<body');\r\n                        prefix = headerLine.slice(0, indent);\r\n                    }\r\n                    headerLines[idx] = headerLine.replace(\r\n                        new RegExp('<body>'),\r\n                        bodyLines.join('\\n' + prefix)\r\n                    );\r\n                    headerLines[idx] = headerLines[idx].replace(\r\n                        new RegExp('<body>', 'g'),\r\n                        bodyLines.join('\\n')\r\n                    );\r\n                });\r\n                header = headerLines.join('\\n');\r\n            }\r\n            defs[defKey] = header;\r\n        } else {\r\n            defs[defKey] = StageMorph.prototype.codeHeaders[defKey];\r\n        }\r\n    }\r\n\r\n    codeLines = code.split('\\n');\r\n    this.inputs().forEach(function (input) {\r\n        parts.push(input.mappedCode(defs).toString());\r\n    });\r\n    parts.forEach(function (part) {\r\n        var partLines = part.split('\\n'),\r\n            placeHolder = '<#' + count + '>',\r\n            rx = new RegExp(placeHolder, 'g');\r\n        codeLines.forEach(function (codeLine, idx) {\r\n            var prefix = '',\r\n                indent;\r\n            if (codeLine.trimLeft().indexOf(placeHolder) === 0) {\r\n                indent = codeLine.indexOf(placeHolder);\r\n                prefix = codeLine.slice(0, indent);\r\n            }\r\n            codeLines[idx] = codeLine.replace(\r\n                new RegExp(placeHolder),\r\n                partLines.join('\\n' + prefix)\r\n            );\r\n            codeLines[idx] = codeLines[idx].replace(rx, partLines.join('\\n'));\r\n        });\r\n        count += 1;\r\n    });\r\n    code = codeLines.join('\\n');\r\n    if (this.nextBlock && this.nextBlock()) { // Command\r\n        code += ('\\n' + this.nextBlock().mappedCode(defs));\r\n    }\r\n    if (!definitions) { // top-level, add headers\r\n        headers = [];\r\n        Object.keys(defs).forEach(function (each) {\r\n            if (defs[each]) {\r\n                headers.push(defs[each]);\r\n            }\r\n        });\r\n        if (headers.length) {\r\n            return headers.join('\\n\\n')\r\n                + '\\n\\n'\r\n                + code;\r\n        }\r\n    }\r\n    return code;\r\n};\r\n\r\nBlockMorph.prototype.codeDefinitionHeader = function () {\r\n    var block = this.isCustomBlock ? new PrototypeHatBlockMorph(this.definition)\r\n            : SpriteMorph.prototype.blockForSelector(this.selector),\r\n        hat = new HatBlockMorph(),\r\n        count = 1;\r\n\r\n    if (this.isCustomBlock) {return block; }\r\n    block.inputs().forEach(function (input) {\r\n        var part = new TemplateSlotMorph('#' + count);\r\n        block.silentReplaceInput(input, part);\r\n        count += 1;\r\n    });\r\n    block.isPrototype = true;\r\n    hat.setCategory(\"control\");\r\n    hat.setSpec('%s');\r\n    hat.silentReplaceInput(hat.inputs()[0], block);\r\n    if (this.category === 'control') {\r\n        hat.alternateBlockColor();\r\n    }\r\n    return hat;\r\n};\r\n\r\nBlockMorph.prototype.codeMappingHeader = function () {\r\n    var block = this.isCustomBlock ? this.definition.blockInstance()\r\n            : SpriteMorph.prototype.blockForSelector(this.selector),\r\n        hat = new HatBlockMorph(),\r\n        count = 1;\r\n\r\n    block.inputs().forEach(function (input) {\r\n        var part = new TemplateSlotMorph('<#' + count + '>');\r\n        block.silentReplaceInput(input, part);\r\n        count += 1;\r\n    });\r\n    block.isPrototype = true;\r\n    hat.setCategory(\"control\");\r\n    hat.setSpec('%s');\r\n    hat.silentReplaceInput(hat.inputs()[0], block);\r\n    if (this.category === 'control') {\r\n        hat.alternateBlockColor();\r\n    }\r\n    return hat;\r\n};\r\n\r\n// Variable refactoring\r\n\r\nBlockMorph.prototype.refactorThisVar = function (justTheTemplate) {\r\n    // Rename all occurrences of the variable this block is holding,\r\n    // taking care of its lexical scope\r\n\r\n    var receiver = this.scriptTarget(),\r\n        oldName = this.instantiationSpec || this.blockSpec,\r\n        cpy = this.fullCopy();\r\n\r\n    cpy.addShadow();\r\n\r\n    new DialogBoxMorph(this, renameVarTo, this).prompt(\r\n        'Variable name',\r\n        oldName,\r\n        this.world(),\r\n        cpy.fullImage(), // pic\r\n        InputSlotMorph.prototype.getVarNamesDict.call(this)\r\n    );\r\n\r\n    function renameVarTo (newName) {\r\n        if (this.parent instanceof SyntaxElementMorph) {\r\n            if (this.parentThatIsA(BlockEditorMorph)) {\r\n                this.doRefactorBlockParameter(\r\n                    oldName,\r\n                    newName,\r\n                    justTheTemplate\r\n                );\r\n            } else if (this.parentThatIsA(RingMorph)) {\r\n                this.doRefactorRingParameter(oldName, newName, justTheTemplate);\r\n            } else {\r\n                this.doRefactorScriptVar(oldName, newName, justTheTemplate);\r\n            }\r\n        } else if (receiver.hasSpriteVariable(oldName)) {\r\n            this.doRefactorSpriteVar(oldName, newName, justTheTemplate);\r\n        } else {\r\n            this.doRefactorGlobalVar(oldName, newName, justTheTemplate);\r\n        }\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.varExistsError = function (ide, where) {\r\n    ide.inform(\r\n        'Variable exists',\r\n        'A variable with this name already exists ' +\r\n        (where || 'in this context') + '.'\r\n    );\r\n};\r\n\r\nBlockMorph.prototype.doRefactorBlockParameter = function (\r\n    oldName,\r\n    newName,\r\n    justTheTemplate\r\n) {\r\n    var fragMorph = this.parentThatIsA(BlockInputFragmentMorph),\r\n        fragment = fragMorph.fragment.copy(),\r\n        definer = fragMorph.parent,\r\n        editor = this.parentThatIsA(BlockEditorMorph),\r\n        scripts = editor.body.contents;\r\n\r\n    if (definer.anyChild(function (any) {\r\n        return (any.blockSpec === newName);\r\n    })) {\r\n        this.varExistsError(editor.target.parentThatIsA(IDE_Morph));\r\n        return;\r\n    }\r\n\r\n    fragment.labelString = newName;\r\n    fragMorph.updateBlockLabel(fragment);\r\n\r\n    if (justTheTemplate) {\r\n        return;\r\n    }\r\n\r\n    scripts.children.forEach(function (script) {\r\n        script.refactorVarInStack(oldName, newName);\r\n    });\r\n};\r\n\r\nBlockMorph.prototype.doRefactorRingParameter = function (\r\n    oldName,\r\n    newName,\r\n    justTheTemplate\r\n) {\r\n    var ring = this.parentThatIsA(RingMorph),\r\n        script = ring.contents(),\r\n        tb = this.topBlock();\r\n\r\n    if (contains(ring.inputNames(), newName)) {\r\n        this.varExistsError(this.parentThatIsA(IDE_Morph));\r\n        return;\r\n    }\r\n\r\n    tb.fullChanged();\r\n    this.setSpec(newName);\r\n\r\n    if (justTheTemplate) {\r\n        tb.fullChanged();\r\n        return;\r\n    }\r\n\r\n    if (script) {\r\n        script.refactorVarInStack(oldName, newName);\r\n    }\r\n\r\n    tb.fullChanged();\r\n};\r\n\r\nBlockMorph.prototype.doRefactorScriptVar = function (\r\n    oldName,\r\n    newName,\r\n    justTheTemplate\r\n) {\r\n    var definer = this.parentThatIsA(CommandBlockMorph),\r\n        receiver, ide;\r\n\r\n    if (definer.definesScriptVariable(newName)) {\r\n        receiver = this.scriptTarget();\r\n        ide = receiver.parentThatIsA(IDE_Morph);\r\n        this.varExistsError(ide);\r\n        return;\r\n    }\r\n\r\n    this.userSetSpec(newName);\r\n\r\n    if (justTheTemplate) {\r\n        return;\r\n    }\r\n\r\n    definer.refactorVarInStack(oldName, newName, true);\r\n};\r\n\r\nBlockMorph.prototype.doRefactorSpriteVar = function (\r\n    oldName,\r\n    newName,\r\n    justTheTemplate\r\n) {\r\n    var receiver = this.scriptTarget(),\r\n        ide = receiver.parentThatIsA(IDE_Morph),\r\n        oldWatcher = receiver.findVariableWatcher(oldName),\r\n        oldValue, newWatcher;\r\n\r\n    if (receiver.hasSpriteVariable(newName)) {\r\n        this.varExistsError(ide);\r\n        return;\r\n    } else if (!isNil(ide.globalVariables.vars[newName])) {\r\n        this.varExistsError(ide, 'as a global variable');\r\n        return;\r\n    } else {\r\n        oldValue = receiver.variables.getVar(oldName);\r\n        receiver.deleteVariable(oldName);\r\n        receiver.addVariable(newName, false);\r\n        receiver.variables.setVar(newName, oldValue);\r\n\r\n        if (oldWatcher && oldWatcher.isVisible) {\r\n            newWatcher = receiver.toggleVariableWatcher(\r\n                newName,\r\n                false\r\n            );\r\n            newWatcher.setPosition(oldWatcher.position());\r\n        }\r\n\r\n        if (!justTheTemplate) {\r\n            receiver.refactorVariableInstances(\r\n                oldName,\r\n                newName,\r\n                false\r\n            );\r\n            receiver.customBlocks.forEach(function (eachBlock) {\r\n                eachBlock.body.expression.refactorVarInStack(\r\n                    oldName,\r\n                    newName\r\n                );\r\n            });\r\n        }\r\n    }\r\n\r\n    ide.flushBlocksCache('variables');\r\n    ide.refreshPalette();\r\n};\r\n\r\nBlockMorph.prototype.doRefactorGlobalVar = function (\r\n    oldName,\r\n    newName,\r\n    justTheTemplate\r\n) {\r\n    var receiver = this.scriptTarget(),\r\n        ide = receiver.parentThatIsA(IDE_Morph),\r\n        stage = ide ? ide.stage : null,\r\n        oldWatcher = receiver.findVariableWatcher(oldName),\r\n        oldValue, newWatcher;\r\n\r\n    if (!isNil(ide.globalVariables.vars[newName])) {\r\n        this.varExistsError(ide);\r\n        return;\r\n    } else if (\r\n            detect(\r\n                stage.children,\r\n                function (any) {\r\n                    return any instanceof SpriteMorph &&\r\n                        any.hasSpriteVariable(newName);\r\n                })\r\n            ) {\r\n        this.varExistsError(ide, 'as a sprite local variable');\r\n        return;\r\n    } else {\r\n        oldValue = ide.globalVariables.getVar(oldName);\r\n        stage.deleteVariable(oldName);\r\n        stage.addVariable(newName, true);\r\n        ide.globalVariables.setVar(newName, oldValue);\r\n\r\n        if (oldWatcher && oldWatcher.isVisible) {\r\n            newWatcher = receiver.toggleVariableWatcher(\r\n                    newName,\r\n                    true\r\n                    );\r\n            newWatcher.setPosition(oldWatcher.position());\r\n        }\r\n\r\n        if (!justTheTemplate) {\r\n            stage.refactorVariableInstances(\r\n                oldName,\r\n                newName,\r\n                true\r\n            );\r\n            stage.globalBlocks.forEach(function (eachBlock) {\r\n                eachBlock.body.expression.refactorVarInStack(\r\n                    oldName,\r\n                    newName\r\n                );\r\n            });\r\n            stage.forAllChildren(function (child) {\r\n                if (child instanceof SpriteMorph) {\r\n                    child.refactorVariableInstances(\r\n                        oldName,\r\n                        newName,\r\n                        true\r\n                    );\r\n                    child.customBlocks.forEach(\r\n                        function (eachBlock) {\r\n                            eachBlock.body.expression\r\n                                .refactorVarInStack(\r\n                                    oldName,\r\n                                    newName\r\n                                );\r\n                        }\r\n                    );\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    ide.flushBlocksCache('variables');\r\n    ide.refreshPalette();\r\n};\r\n\r\n// BlockMorph drawing\r\n\r\nBlockMorph.prototype.eraseHoles = function (context) {\r\n    var myself = this,\r\n        isRing = this instanceof RingMorph,\r\n        shift = this.edge * 0.5,\r\n        gradient,\r\n        rightX,\r\n        holes = this.parts().filter(function (part) {\r\n            return part.isHole;\r\n        });\r\n\r\n    if (this.isPredicate && (holes.length > 0)) {\r\n        rightX = this.width() - this.rounding;\r\n        context.clearRect(\r\n            rightX,\r\n            0,\r\n            this.width(),\r\n            this.height()\r\n        );\r\n\r\n        // draw a 3D-ish vertical right edge\r\n        gradient = context.createLinearGradient(\r\n            rightX - this.edge,\r\n            0,\r\n            this.width(),\r\n            0\r\n        );\r\n        gradient.addColorStop(0, this.color.toString());\r\n        gradient.addColorStop(1, this.dark());\r\n        context.lineWidth = this.edge;\r\n        context.lineJoin = 'round';\r\n        context.lineCap = 'round';\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        context.moveTo(rightX - shift, this.edge + shift);\r\n        context.lineTo(rightX - shift, this.height() - this.edge - shift);\r\n        context.stroke();\r\n    }\r\n    holes.forEach(function (hole) {\r\n        var w = hole.width(),\r\n            h = Math.floor(hole.height()) - 2; // Opera needs this\r\n        context.clearRect(\r\n            hole.bounds.origin.x - myself.bounds.origin.x + 1,\r\n            hole.bounds.origin.y - myself.bounds.origin.y + 1,\r\n            isRing ? w - 2 : w + 1,\r\n            h\r\n        );\r\n    });\r\n\r\n};\r\n\r\n// BlockMorph highlighting\r\n\r\nBlockMorph.prototype.addHighlight = function (oldHighlight) {\r\n    var isHidden = !this.isVisible,\r\n        highlight;\r\n\r\n    if (isHidden) {this.show(); }\r\n    highlight = this.highlight(\r\n        oldHighlight ? oldHighlight.color : this.activeHighlight,\r\n        this.activeBlur,\r\n        this.activeBorder\r\n    );\r\n    this.addBack(highlight);\r\n    this.fullChanged();\r\n    if (isHidden) {this.hide(); }\r\n    return highlight;\r\n};\r\n\r\nBlockMorph.prototype.addErrorHighlight = function () {\r\n    var isHidden = !this.isVisible,\r\n        highlight;\r\n\r\n    if (isHidden) {this.show(); }\r\n    this.removeHighlight();\r\n    highlight = this.highlight(\r\n        this.errorHighlight,\r\n        this.activeBlur,\r\n        this.activeBorder\r\n    );\r\n    this.addBack(highlight);\r\n    this.fullChanged();\r\n    if (isHidden) {this.hide(); }\r\n    return highlight;\r\n};\r\n\r\nBlockMorph.prototype.removeHighlight = function () {\r\n    var highlight = this.getHighlight();\r\n    if (highlight !== null) {\r\n        this.fullChanged();\r\n        this.removeChild(highlight);\r\n    }\r\n    return highlight;\r\n};\r\n\r\nBlockMorph.prototype.toggleHighlight = function () {\r\n    if (this.getHighlight()) {\r\n        this.removeHighlight();\r\n    } else {\r\n        this.addHighlight();\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.highlight = function (color, blur, border) {\r\n    var highlight = new BlockHighlightMorph(),\r\n        fb = this.fullBounds(),\r\n        edge = useBlurredShadows && !MorphicPreferences.isFlat ?\r\n                blur : border;\r\n    highlight.setExtent(fb.extent().add(edge * 2));\r\n    highlight.color = color;\r\n    highlight.image = useBlurredShadows && !MorphicPreferences.isFlat ?\r\n            this.highlightImageBlurred(color, blur)\r\n                : this.highlightImage(color, border);\r\n    highlight.setPosition(fb.origin.subtract(new Point(edge, edge)));\r\n    return highlight;\r\n};\r\n\r\nBlockMorph.prototype.highlightImage = function (color, border) {\r\n    var fb, img, hi, ctx, out;\r\n    fb = this.fullBounds().extent();\r\n    img = this.fullImage();\r\n\r\n    hi = newCanvas(fb.add(border * 2));\r\n    ctx = hi.getContext('2d');\r\n\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.drawImage(img, border, 0);\r\n    ctx.drawImage(img, border * 2, 0);\r\n    ctx.drawImage(img, border * 2, border);\r\n    ctx.drawImage(img, border * 2, border * 2);\r\n    ctx.drawImage(img, border, border * 2);\r\n    ctx.drawImage(img, 0, border * 2);\r\n    ctx.drawImage(img, 0, border);\r\n\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(img, border, border);\r\n\r\n    out = newCanvas(fb.add(border * 2));\r\n    ctx = out.getContext('2d');\r\n    ctx.drawImage(hi, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, out.width, out.height);\r\n\r\n    return out;\r\n};\r\n\r\nBlockMorph.prototype.highlightImageBlurred = function (color, blur) {\r\n    var fb, img, hi, ctx;\r\n    fb = this.fullBounds().extent();\r\n    img = this.fullImage();\r\n\r\n    hi = newCanvas(fb.add(blur * 2));\r\n    ctx = hi.getContext('2d');\r\n    ctx.shadowBlur = blur;\r\n    ctx.shadowColor = color.toString();\r\n    ctx.drawImage(img, blur, blur);\r\n\r\n    ctx.shadowBlur = 0;\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(img, blur, blur);\r\n    return hi;\r\n};\r\n\r\nBlockMorph.prototype.getHighlight = function () {\r\n    var highlights;\r\n    highlights = this.children.slice(0).reverse().filter(\r\n        function (child) {\r\n            return child instanceof BlockHighlightMorph;\r\n        }\r\n    );\r\n    if (highlights.length !== 0) {\r\n        return highlights[0];\r\n    }\r\n    return null;\r\n};\r\n\r\nBlockMorph.prototype.outline = function (color, border) {\r\n    var highlight = new BlockHighlightMorph(),\r\n        fb = this.fullBounds(),\r\n        edge = border;\r\n    highlight.setExtent(fb.extent().add(edge * 2));\r\n    highlight.color = color;\r\n    highlight.image = this.highlightImage(color, border);\r\n    highlight.setPosition(fb.origin.subtract(new Point(edge, edge)));\r\n    return highlight;\r\n};\r\n\r\n// BlockMorph zebra coloring\r\n\r\nBlockMorph.prototype.fixBlockColor = function (nearestBlock, isForced) {\r\n    var nearest = nearestBlock,\r\n        clr,\r\n        cslot;\r\n\r\n    if (!this.zebraContrast && !isForced) {\r\n        return;\r\n    }\r\n    if (!this.zebraContrast && isForced) {\r\n        return this.forceNormalColoring(true);\r\n    }\r\n\r\n    if (!nearest) {\r\n        if (this.parent) {\r\n            if (this.isPrototype) {\r\n                nearest = null; // this.parent; // the PrototypeHatBlockMorph\r\n            } else if (this instanceof ReporterBlockMorph) {\r\n                nearest = this.parent.parentThatIsA(BlockMorph);\r\n            } else { // command\r\n                cslot = this.parentThatIsA(CommandSlotMorph);\r\n                if (cslot) {\r\n                    nearest = cslot.parentThatIsA(BlockMorph);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (!nearest) { // top block\r\n        clr = SpriteMorph.prototype.blockColor[this.category];\r\n        if (!this.color.eq(clr)) {\r\n            this.alternateBlockColor();\r\n        }\r\n    } else if (nearest.category === this.category) {\r\n        if (nearest.color.eq(this.color)) {\r\n            this.alternateBlockColor();\r\n        }\r\n    } else if (this.category && !this.color.eq(\r\n            SpriteMorph.prototype.blockColor[this.category]\r\n        )) {\r\n        this.alternateBlockColor();\r\n    }\r\n    if (isForced) {\r\n        this.fixChildrensBlockColor(true);\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.forceNormalColoring = function (silently) {\r\n    var clr = SpriteMorph.prototype.blockColor[this.category];\r\n    this.setColor(clr, silently);\r\n    this.setLabelColor(\r\n        new Color(255, 255, 255),\r\n        clr.darker(this.labelContrast),\r\n        new Point(-1, -1)\r\n    );\r\n    this.fixChildrensBlockColor(true);\r\n};\r\n\r\nBlockMorph.prototype.alternateBlockColor = function () {\r\n    var clr = SpriteMorph.prototype.blockColor[this.category];\r\n\r\n    if (this.color.eq(clr)) {\r\n        this.setColor(\r\n            this.zebraContrast < 0 ? clr.darker(Math.abs(this.zebraContrast))\r\n                : clr.lighter(this.zebraContrast),\r\n            this.hasLabels() // silently\r\n        );\r\n    } else {\r\n        this.setColor(clr, this.hasLabels()); // silently\r\n    }\r\n    this.fixLabelColor();\r\n    this.fixChildrensBlockColor(true); // has issues if not forced\r\n};\r\n\r\nBlockMorph.prototype.ghost = function () {\r\n    this.setColor(\r\n        SpriteMorph.prototype.blockColor[this.category].lighter(35)\r\n    );\r\n};\r\n\r\nBlockMorph.prototype.fixLabelColor = function () {\r\n    if (this.zebraContrast > 0 && this.category) {\r\n        var clr = SpriteMorph.prototype.blockColor[this.category];\r\n        if (this.color.eq(clr)) {\r\n            this.setLabelColor(\r\n                new Color(255, 255, 255),\r\n                clr.darker(this.labelContrast),\r\n                MorphicPreferences.isFlat ? null : new Point(-1, -1)\r\n            );\r\n        } else {\r\n            this.setLabelColor(\r\n                new Color(0, 0, 0),\r\n                clr.lighter(this.zebraContrast)\r\n                    .lighter(this.labelContrast * 2),\r\n                MorphicPreferences.isFlat ? null : new Point(1, 1)\r\n            );\r\n        }\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.fixChildrensBlockColor = function (isForced) {\r\n    var myself = this;\r\n    this.children.forEach(function (morph) {\r\n        if (morph instanceof CommandBlockMorph) {\r\n            morph.fixBlockColor(null, isForced);\r\n        } else if (morph instanceof SyntaxElementMorph) {\r\n            morph.fixBlockColor(myself, isForced);\r\n            if (morph instanceof BooleanSlotMorph) {\r\n                morph.drawNew();\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nBlockMorph.prototype.setCategory = function (aString) {\r\n    this.category = aString;\r\n    this.startLayout();\r\n    this.fixBlockColor();\r\n    this.endLayout();\r\n};\r\n\r\nBlockMorph.prototype.hasLabels = function () {\r\n    return this.children.some(function (any) {\r\n        return any instanceof StringMorph;\r\n    });\r\n};\r\n\r\n// BlockMorph copying\r\n\r\nBlockMorph.prototype.fullCopy = function () {\r\n    var ans = BlockMorph.uber.fullCopy.call(this);\r\n    ans.removeHighlight();\r\n    ans.isDraggable = true;\r\n    if (this.instantiationSpec) {\r\n        ans.setSpec(this.instantiationSpec);\r\n    }\r\n    ans.allChildren().filter(function (block) {\r\n        if (block instanceof SyntaxElementMorph) {\r\n            block.cachedInputs = null;\r\n            if (block.isCustomBlock) {\r\n                block.initializeVariables();\r\n            }\r\n        }\r\n        return !isNil(block.comment);\r\n    }).forEach(function (block) {\r\n        var cmnt = block.comment.fullCopy();\r\n        block.comment = cmnt;\r\n        cmnt.block = block;\r\n    });\r\n    ans.cachedInputs = null;\r\n    return ans;\r\n};\r\n\r\nBlockMorph.prototype.reactToTemplateCopy = function () {\r\n    this.forceNormalColoring();\r\n};\r\n\r\nBlockMorph.prototype.hasBlockVars = function () {\r\n    return this.anyChild(function (any) {\r\n        return any.isCustomBlock &&\r\n            any.isGlobal &&\r\n            any.definition.variableNames.length;\r\n    });\r\n};\r\n\r\n// BlockMorph events\r\n\r\nBlockMorph.prototype.mouseClickLeft = function () {\r\n    var top = this.topBlock(),\r\n        receiver = top.scriptTarget(),\r\n        shiftClicked = this.world().currentKey === 16,\r\n        stage;\r\n    if (shiftClicked && !this.isTemplate) {\r\n        return this.selectForEdit().focus(); // enable coopy-on-edit\r\n    }\r\n    if (top instanceof PrototypeHatBlockMorph) {\r\n        return top.mouseClickLeft();\r\n    }\r\n    if (receiver) {\r\n        stage = receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.threads.toggleProcess(top, receiver);\r\n        }\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.focus = function () {\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        world = this.world(),\r\n        focus;\r\n    if (!scripts || !ScriptsMorph.prototype.enableKeyboard) {return; }\r\n    if (scripts.focus) {scripts.focus.stopEditing(); }\r\n    world.stopEditing();\r\n    focus = new ScriptFocusMorph(scripts, this);\r\n    scripts.focus = focus;\r\n    focus.getFocus(world);\r\n    if (this instanceof HatBlockMorph) {\r\n        focus.nextCommand();\r\n    }\r\n};\r\n\r\nBlockMorph.prototype.activeProcess = function () {\r\n    var top = this.topBlock(),\r\n        receiver = top.scriptTarget(),\r\n        stage;\r\n    if (top instanceof PrototypeHatBlockMorph) {\r\n        return null;\r\n    }\r\n    if (receiver) {\r\n        stage = receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            return stage.threads.findProcess(top, receiver);\r\n        }\r\n    }\r\n    return null;\r\n};\r\n\r\n// BlockMorph thumbnail and script pic\r\n\r\nBlockMorph.prototype.thumbnail = function (scale, clipWidth) {\r\n    var nb = this.nextBlock(),\r\n        fadeout = 12,\r\n        ext,\r\n        trgt,\r\n        ctx,\r\n        gradient;\r\n\r\n    if (nb) {nb.isVisible = false; }\r\n    ext = this.fullBounds().extent();\r\n    trgt = newCanvas(new Point(\r\n        clipWidth ? Math.min(ext.x * scale, clipWidth) : ext.x * scale,\r\n        ext.y * scale\r\n    ));\r\n    ctx = trgt.getContext('2d');\r\n    ctx.scale(scale, scale);\r\n    ctx.drawImage(this.fullImage(), 0, 0);\r\n    // draw fade-out\r\n    if (clipWidth && ext.x * scale > clipWidth) {\r\n        gradient = ctx.createLinearGradient(\r\n            trgt.width / scale - fadeout,\r\n            0,\r\n            trgt.width / scale,\r\n            0\r\n        );\r\n        gradient.addColorStop(0, 'transparent');\r\n        gradient.addColorStop(1, 'black');\r\n        ctx.globalCompositeOperation = 'destination-out';\r\n        ctx.fillStyle = gradient;\r\n        ctx.fillRect(\r\n            trgt.width / scale - fadeout,\r\n            0,\r\n            trgt.width / scale,\r\n            trgt.height / scale\r\n        );\r\n    }\r\n    if (nb) {nb.isVisible = true; }\r\n    return trgt;\r\n};\r\n\r\nBlockMorph.prototype.scriptPic = function () {\r\n    // answer a canvas image that also includes comments\r\n    var scr = this.fullImage(),\r\n        fb = this.stackFullBounds(),\r\n        pic = newCanvas(fb.extent()),\r\n        ctx = pic.getContext('2d');\r\n    this.allComments().forEach(function (comment) {\r\n        ctx.drawImage(\r\n            comment.fullImageClassic(),\r\n            comment.fullBounds().left() - fb.left(),\r\n            comment.top() - fb.top()\r\n        );\r\n    });\r\n    ctx.drawImage(scr, 0, 0);\r\n    return pic;\r\n};\r\n\r\n// BlockMorph local method indicator drawing\r\n\r\nBlockMorph.prototype.drawMethodIcon = function (context) {\r\n    var ext = this.methodIconExtent(),\r\n        w = ext.x,\r\n        h = ext.y,\r\n        r = w / 2,\r\n        x = this.edge + this.labelPadding,\r\n        y = this.edge,\r\n        isNormal =\r\n            this.color === SpriteMorph.prototype.blockColor[this.category];\r\n\r\n    if (this.isPredicate) {\r\n        x = this.rounding;\r\n    }\r\n    if (this instanceof CommandBlockMorph) {\r\n        y += this.corner;\r\n    }\r\n    context.fillStyle = isNormal ? this.cachedClrBright : this.cachedClrDark;\r\n\r\n    // pin\r\n    context.beginPath();\r\n    context.arc(x + r, y + r, r, radians(-210), radians(30), false);\r\n    context.lineTo(x + r, y + h);\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    // hole\r\n    context.fillStyle = this.cachedClr;\r\n    context.beginPath();\r\n    context.arc(x + r, y + r, r * 0.4, radians(0), radians(360), false);\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\n// BlockMorph dragging and dropping\r\n\r\nBlockMorph.prototype.rootForGrab = function () {\r\n    let testOrigin = String(this.parent).search(\"FrameMorph\");\r\n    if (testOrigin > 0) {\r\n        grabOrigine = \"palette\"\r\n    } else {\r\n        grabOrigine = \"stage\"\r\n    }\r\n    return this;\r\n};\r\n\r\n/*\r\n    for demo purposes, allows you to drop arg morphs onto\r\n    blocks and forces a layout update. This section has\r\n    no relevance in end user mode.\r\n*/\r\n\r\nBlockMorph.prototype.wantsDropOf = function (aMorph) {\r\n    // override the inherited method\r\n    return (aMorph instanceof ArgMorph\r\n        || aMorph instanceof StringMorph\r\n        || aMorph instanceof TextMorph\r\n    ) && !this.isTemplate;\r\n};\r\n\r\nBlockMorph.prototype.reactToDropOf = function (droppedMorph) {\r\n    droppedMorph.isDraggable = false;\r\n    if (droppedMorph instanceof InputSlotMorph) {\r\n        droppedMorph.drawNew();\r\n    } else if (droppedMorph instanceof MultiArgMorph) {\r\n        droppedMorph.fixLayout();\r\n    }\r\n    this.fixLayout();\r\n    this.buildSpec();\r\n};\r\n\r\nBlockMorph.prototype.situation = function () {\r\n    // answer a dictionary specifying where I am right now, so\r\n    // I can slide back to it if I'm dropped somewhere else\r\n    if (!(this.parent instanceof TemplateSlotMorph)) {\r\n        var scripts = this.parentThatIsA(ScriptsMorph);\r\n        if (scripts) {\r\n            return {\r\n                origin: scripts,\r\n                position: this.position().subtract(scripts.position())\r\n            };\r\n        }\r\n    }\r\n    return BlockMorph.uber.situation.call(this);\r\n};\r\n\r\n// BlockMorph sticky comments\r\n\r\nBlockMorph.prototype.prepareToBeGrabbed = function (hand) {\r\n    var myself = this;\r\n    this.allComments().forEach(function (comment) {\r\n        comment.startFollowing(myself, hand.world);\r\n    });\r\n};\r\n\r\nBlockMorph.prototype.justDropped = function () {\r\n   \r\n    this.alpha = 1;\r\n    this.allComments().forEach(function (comment) {\r\n        comment.stopFollowing();\r\n    });\r\n};\r\n\r\nBlockMorph.prototype.allComments = function () {\r\n    return this.allChildren().filter(function (block) {\r\n        return !isNil(block.comment);\r\n    }).map(function (block) {\r\n        return block.comment;\r\n    });\r\n};\r\n\r\nBlockMorph.prototype.destroy = function (justThis) {\r\n    // private - use IDE_Morph.removeBlock() to first stop all my processes\r\n    morphRemover(this); // Remove Block jp \r\n    if (justThis) {\r\n        if (!isNil(this.comment)) {\r\n            this.comment.destroy();\r\n        }\r\n    } else {\r\n        this.allComments().forEach(function (comment) {\r\n            comment.destroy();\r\n        });\r\n    }\r\n    BlockMorph.uber.destroy.call(this);\r\n};\r\n\r\nBlockMorph.prototype.stackHeight = function () {\r\n    var fb = this.fullBounds(),\r\n        commentsBottom = Math.max(this.allComments().map(\r\n            function (comment) {return comment.bottom(); }\r\n        )) || this.bottom();\r\n    return Math.max(fb.bottom(), commentsBottom) - fb.top();\r\n};\r\n\r\nBlockMorph.prototype.stackFullBounds = function () {\r\n    var fb = this.fullBounds();\r\n    this.allComments().forEach(function (comment) {\r\n        fb.mergeWith(comment.bounds);\r\n    });\r\n    return fb;\r\n};\r\n\r\nBlockMorph.prototype.stackWidth = function () {\r\n    var fb = this.fullBounds(),\r\n        commentsRight = Math.max(this.allComments().map(\r\n            function (comment) {return comment.right(); }\r\n        )) || this.right();\r\n    return Math.max(fb.right(), commentsRight) - fb.left();\r\n};\r\n\r\nBlockMorph.prototype.snap = function () {\r\n    var top = this.topBlock(),\r\n        receiver,\r\n        stage,\r\n        ide;\r\n    morphOnSet(this);\r\n    top.allComments().forEach(function (comment) {\r\n        comment.align(top);\r\n    });\r\n    // fix highlights, if any\r\n    if (this.getHighlight() && (this !== top)) {\r\n        this.removeHighlight();\r\n    }\r\n    if (top.getHighlight()) {\r\n        top.addHighlight(top.removeHighlight());\r\n    }\r\n    // register generic hat blocks\r\n    if (this.selector === 'receiveCondition') {\r\n        receiver = top.scriptTarget();\r\n        if (receiver) {\r\n            stage = receiver.parentThatIsA(StageMorph);\r\n            if (stage) {\r\n                stage.enableCustomHatBlocks = true;\r\n                stage.threads.pauseCustomHatBlocks = false;\r\n                ide = stage.parentThatIsA(IDE_Morph);\r\n                if (ide) {\r\n                    ide.controlBar.stopButton.refresh();\r\n                }\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// CommandBlockMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a stackable jigsaw-shaped block.\r\n\r\n    I inherit from BlockMorph adding the following most important\r\n    public accessors:\r\n\r\n        nextBlock()       - set / get the block attached to my bottom\r\n        bottomBlock()     - answer the bottom block of my stack\r\n        blockSequence()   - answer an array of blocks starting with myself\r\n\r\n    and the following \"lexical awareness\" indicators:\r\n\r\n        partOfCustomCommand - temporary bool set by the evaluator\r\n        exitTag           - temporary string or number set by the evaluator\r\n*/\r\n\r\n// CommandBlockMorph inherits from BlockMorph:\r\n\r\nCommandBlockMorph.prototype = new BlockMorph();\r\nCommandBlockMorph.prototype.constructor = CommandBlockMorph;\r\nCommandBlockMorph.uber = BlockMorph.prototype;\r\n\r\n// CommandBlockMorph instance creation:\r\n\r\nfunction CommandBlockMorph() {\r\n    this.init();\r\n}\r\n\r\nCommandBlockMorph.prototype.init = function (silently) {\r\n    CommandBlockMorph.uber.init.call(this, silently);\r\n    this.setExtent(new Point(200, 100), silently);\r\n    this.partOfCustomCommand = false;\r\n    this.exitTag = null;\r\n    // this.cachedNextBlock = null; // don't serialize\r\n};\r\n\r\n// CommandBlockMorph enumerating:\r\n\r\nCommandBlockMorph.prototype.blockSequence = function () {\r\n    var nb = this.nextBlock(),\r\n        result = [this];\r\n    if (nb) {\r\n        result = result.concat(nb.blockSequence());\r\n    }\r\n    return result;\r\n};\r\n\r\nCommandBlockMorph.prototype.bottomBlock = function () {\r\n    // topBlock() also exists - inherited from SyntaxElementMorph\r\n    if (this.nextBlock()) {\r\n        return this.nextBlock().bottomBlock();\r\n    }\r\n    return this;\r\n};\r\n\r\nCommandBlockMorph.prototype.nextBlock = function (block) {\r\n    // set / get the block attached to my bottom\r\n    if (block) {\r\n        var nb = this.nextBlock(),\r\n            affected = this.parentThatIsA(CommandSlotMorph);\r\n        this.add(block);\r\n        // this.cachedNextBlock = block;\r\n        if (nb) {\r\n            block.bottomBlock().nextBlock(nb);\r\n        }\r\n        block.setPosition(\r\n            new Point(\r\n                this.left(),\r\n                this.bottom() - (this.corner)\r\n            )\r\n        );\r\n        if (affected) {\r\n            affected.fixLayout();\r\n        }\r\n    } else {\r\n        /* cachedNextBlock - has issues, disabled for now\r\n        if (!this.cachedNextBlock) {\r\n            this.cachedNextBlock = detect(\r\n                this.children,\r\n                function (child) {\r\n                    return child instanceof CommandBlockMorph\r\n                        && !child.isPrototype;\r\n                }\r\n            );\r\n        }\r\n        return this.cachedNextBlock;\r\n        */\r\n        return detect(\r\n            this.children,\r\n            function (child) {\r\n                return child instanceof CommandBlockMorph\r\n                    && !child.isPrototype;\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\n// CommandBlockMorph attach targets:\r\n\r\nCommandBlockMorph.prototype.topAttachPoint = function () {\r\n    return new Point(\r\n        this.dentCenter(),\r\n        this.top()\r\n    );\r\n};\r\n\r\nCommandBlockMorph.prototype.bottomAttachPoint = function () {\r\n    return new Point(\r\n        this.dentCenter(),\r\n        this.bottom()\r\n    );\r\n};\r\n\r\nCommandBlockMorph.prototype.wrapAttachPoint = function () {\r\n    var cslot = detect( // could be a method making uses of caching...\r\n        this.inputs(), // ... although these already are cached\r\n        function (each) {return each instanceof CSlotMorph; }\r\n    );\r\n    if (cslot && !cslot.nestedBlock()) {\r\n        return new Point(\r\n            cslot.left() + (cslot.inset * 2) + cslot.corner,\r\n            cslot.top() + (cslot.corner * 2)\r\n        );\r\n    }\r\n    return null;\r\n};\r\n\r\nCommandBlockMorph.prototype.dentLeft = function () {\r\n    return this.left()\r\n        + this.corner\r\n        + this.inset;\r\n};\r\n\r\nCommandBlockMorph.prototype.dentCenter = function () {\r\n    return this.dentLeft()\r\n        + this.corner\r\n        + (this.dent * 0.5);\r\n};\r\n\r\nCommandBlockMorph.prototype.attachTargets = function () {\r\n    var answer = [],\r\n        tp;\r\n    if (!(this instanceof HatBlockMorph)) {\r\n        tp = this.topAttachPoint();\r\n        if (!(this.parent instanceof SyntaxElementMorph)) {\r\n            answer.push({\r\n                point: tp,\r\n                element: this,\r\n                loc: 'top',\r\n                type: 'block'\r\n            });\r\n        }\r\n        if (ScriptsMorph.prototype.enableNestedAutoWrapping ||\r\n                !this.parentThatIsA(CommandSlotMorph)) {\r\n            answer.push({\r\n                point: tp,\r\n                element: this,\r\n                loc: 'wrap',\r\n                type: 'block'\r\n            });\r\n        }\r\n    }\r\n    if (!this.isStop()) {\r\n        answer.push({\r\n            point: this.bottomAttachPoint(),\r\n            element: this,\r\n            loc: 'bottom',\r\n            type: 'block'\r\n        });\r\n    }\r\n    return answer;\r\n};\r\n\r\nCommandBlockMorph.prototype.allAttachTargets = function (newParent) {\r\n    var myself = this,\r\n        target = newParent || this.parent,\r\n        answer = [],\r\n        topBlocks;\r\n\r\n    if (this instanceof HatBlockMorph && newParent.rejectsHats) {\r\n        return answer;\r\n    }\r\n    topBlocks = target.children.filter(function (child) {\r\n        return (child !== myself) &&\r\n            child instanceof SyntaxElementMorph &&\r\n            !child.isTemplate;\r\n    });\r\n    topBlocks.forEach(function (block) {\r\n        block.forAllChildren(function (child) {\r\n            if (child.attachTargets) {\r\n                child.attachTargets().forEach(function (at) {\r\n                    answer.push(at);\r\n                });\r\n            }\r\n        });\r\n    });\r\n    return answer;\r\n};\r\n\r\nCommandBlockMorph.prototype.closestAttachTarget = function (newParent) {\r\n    var target = newParent || this.parent,\r\n        bottomBlock = this.bottomBlock(),\r\n        answer = null,\r\n        thresh = Math.max(\r\n            this.corner * 2 + this.dent,\r\n            this.minSnapDistance\r\n        ),\r\n        dist,\r\n        ref = [],\r\n        minDist = 1000,\r\n        wrap;\r\n\r\n    if (!(this instanceof HatBlockMorph)) {\r\n        ref.push(\r\n            {\r\n                point: this.topAttachPoint(),\r\n                loc: 'top'\r\n            }\r\n        );\r\n        wrap = this.wrapAttachPoint();\r\n        if (wrap) {\r\n            ref.push(\r\n                {\r\n                    point: wrap,\r\n                    loc: 'wrap'\r\n                }\r\n            );\r\n        }\r\n    }\r\n    if (!bottomBlock.isStop()) {\r\n        ref.push(\r\n            {\r\n                point: bottomBlock.bottomAttachPoint(),\r\n                loc: 'bottom'\r\n            }\r\n        );\r\n    }\r\n    this.allAttachTargets(target).forEach(function (eachTarget) {\r\n        ref.forEach(function (eachRef) {\r\n            // match: either both locs are 'wrap' or both are different,\r\n            // none being 'wrap' (can this be expressed any better?)\r\n            if ((eachRef.loc === 'wrap' && (eachTarget.loc === 'wrap')) ||\r\n                ((eachRef.loc !== eachTarget.loc) &&\r\n                    (eachRef.loc !== 'wrap') && (eachTarget.loc !== 'wrap'))\r\n            ) {\r\n                dist = eachRef.point.distanceTo(eachTarget.point);\r\n                if ((dist < thresh) && (dist < minDist)) {\r\n                    minDist = dist;\r\n                    answer = eachTarget;\r\n                }\r\n            }\r\n        });\r\n    });\r\n    return answer;\r\n};\r\n\r\nCommandBlockMorph.prototype.snap = function (hand) {\r\n    var target = this.closestAttachTarget(),\r\n        scripts = this.parentThatIsA(ScriptsMorph),\r\n        before,\r\n        next,\r\n        offsetY,\r\n        cslot,\r\n        affected;\r\n\r\n    scripts.clearDropInfo();\r\n    scripts.lastDroppedBlock = this;\r\n    if (target === null) {\r\n        this.startLayout();\r\n        this.fixBlockColor();\r\n        this.endLayout();\r\n        CommandBlockMorph.uber.snap.call(this); // align stuck comments\r\n        if (hand) {\r\n            scripts.recordDrop(hand.grabOrigin);\r\n        }\r\n        return;\r\n    }\r\n\r\n    scripts.lastDropTarget = target;\r\n\r\n    this.startLayout();\r\n    if (target.loc === 'bottom') {\r\n        if (target.type === 'slot') {\r\n            this.removeHighlight();\r\n            scripts.lastNextBlock = target.element.nestedBlock();\r\n            target.element.nestedBlock(this);\r\n        } else {\r\n            scripts.lastNextBlock = target.element.nextBlock();\r\n            target.element.nextBlock(this);\r\n        }\r\n        if (this.isStop()) {\r\n            next = this.nextBlock();\r\n            if (next) {\r\n                scripts.add(next);\r\n                next.moveBy(this.extent().floorDivideBy(2));\r\n                affected = this.parentThatIsA(CommandSlotMorph);\r\n                if (affected) {\r\n                    affected.fixLayout();\r\n                }\r\n            }\r\n        }\r\n    } else if (target.loc === 'top') {\r\n        target.element.removeHighlight();\r\n        offsetY = this.bottomBlock().bottom() - this.bottom();\r\n        this.setBottom(target.element.top() + this.corner - offsetY);\r\n        this.setLeft(target.element.left());\r\n        this.bottomBlock().nextBlock(target.element);\r\n    } else if (target.loc === 'wrap') {\r\n        cslot = detect( // this should be a method making use of caching\r\n            this.inputs(), // these are already cached, so maybe it's okay\r\n            function (each) {return each instanceof CSlotMorph; }\r\n        );\r\n        // assume the cslot is (still) empty, was checked determining the target\r\n        before = (target.element.parent);\r\n        scripts.lastWrapParent = before;\r\n\r\n        // adjust position of wrapping block\r\n        this.moveBy(target.point.subtract(cslot.slotAttachPoint()));\r\n\r\n        // wrap c-slot around target\r\n        cslot.nestedBlock(target.element);\r\n        if (before instanceof CommandBlockMorph) {\r\n            before.nextBlock(this);\r\n        } else if (before instanceof CommandSlotMorph) {\r\n            before.nestedBlock(this);\r\n        }\r\n\r\n        // fix zebra coloring.\r\n        // this could probably be generalized into the fixBlockColor mechanism\r\n        target.element.blockSequence().forEach(\r\n            function (cmd) {cmd.fixBlockColor(); }\r\n        );\r\n    }\r\n    this.fixBlockColor();\r\n    this.endLayout();\r\n    CommandBlockMorph.uber.snap.call(this); // align stuck comments\r\n    if (hand) {\r\n        scripts.recordDrop(hand.grabOrigin);\r\n    }\r\n    if (this.snapSound) {\r\n        this.snapSound.play();\r\n    }\r\n};\r\n\r\nCommandBlockMorph.prototype.isStop = function () {\r\n    return ([\r\n        'doStopThis',\r\n        'doStop',\r\n        'doStopBlock',\r\n        'doStopAll',\r\n        'doForever',\r\n        'doReport',\r\n        'removeClone'\r\n    ].indexOf(this.selector) > -1);\r\n};\r\n\r\n// CommandBlockMorph deleting\r\n\r\nCommandBlockMorph.prototype.userDestroy = function () {\r\n    var target = this.selectForEdit(); // enable copy-on-edit\r\n    if (target !== this) {\r\n        return this.userDestroy.call(target);\r\n    }\r\n    if (this.nextBlock()) {\r\n        this.userDestroyJustThis();\r\n        return;\r\n    }\r\n\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        parent = this.parentThatIsA(SyntaxElementMorph),\r\n        cslot = this.parentThatIsA(CSlotMorph);\r\n\r\n    // for undrop / redrop\r\n    if (scripts) {\r\n        scripts.clearDropInfo();\r\n        scripts.lastDroppedBlock = this;\r\n        scripts.recordDrop(this.situation());\r\n        scripts.dropRecord.action = 'delete';\r\n    }\r\n\r\n    if (ide) {\r\n        // also stop all active processes hatted by this block\r\n        ide.removeBlock(this);\r\n    } else {\r\n        this.destroy();\r\n    }\r\n    if (cslot) {\r\n        cslot.fixLayout();\r\n    }\r\n    if (parent) {\r\n        parent.reactToGrabOf(this); // fix highlight\r\n    }\r\n};\r\n\r\nCommandBlockMorph.prototype.userDestroyJustThis = function () {\r\n    // delete just this one block, reattach next block to the previous one,\r\n    var scripts = this.parentThatIsA(ScriptsMorph),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        cs = this.parentThatIsA(CommandSlotMorph),\r\n        pb,\r\n        nb = this.nextBlock(),\r\n        above,\r\n        parent = this.parentThatIsA(SyntaxElementMorph),\r\n        cslot = this.parentThatIsA(CSlotMorph);\r\n\r\n    // for undrop / redrop\r\n    if (scripts) {\r\n        scripts.clearDropInfo();\r\n        scripts.lastDroppedBlock = this;\r\n        scripts.recordDrop(this.situation());\r\n        scripts.dropRecord.lastNextBlock = nb;\r\n        scripts.dropRecord.action = 'delete';\r\n    }\r\n\r\n    this.topBlock().fullChanged();\r\n    if (this.parent) {\r\n        pb = this.parent.parentThatIsA(CommandBlockMorph);\r\n    }\r\n    if (pb && (pb.nextBlock() === this)) {\r\n        above = pb;\r\n    } else if (cs && (cs.nestedBlock() === this)) {\r\n        above = cs;\r\n    }\r\n    if (ide) {\r\n        // also stop all active processes hatted by this block\r\n        ide.removeBlock(this, true); // just this block\r\n    } else {\r\n        this.destroy(true); // just this block\r\n    }\r\n    if (nb) {\r\n        if (above instanceof CommandSlotMorph) {\r\n            above.nestedBlock(nb);\r\n        } else if (above instanceof CommandBlockMorph) {\r\n            above.nextBlock(nb);\r\n        } else {\r\n            scripts.add(nb);\r\n        }\r\n    } else if (cslot) {\r\n        cslot.fixLayout();\r\n    }\r\n    if (parent) {\r\n        parent.reactToGrabOf(this); // fix highlight\r\n    }\r\n};\r\n\r\n// CommandBlockMorph drawing:\r\n\r\nCommandBlockMorph.prototype.drawNew = function () {\r\n    var context;\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n\r\n    // draw the 'flat' shape:\r\n    this.drawTop(context);\r\n    this.drawBody(context);\r\n    this.drawBottom(context);\r\n\r\n    // add 3D-Effect:\r\n    if (!MorphicPreferences.isFlat) {\r\n        this.drawTopDentEdge(context, 0, 0);\r\n        this.drawBottomDentEdge(context, 0, this.height() - this.corner);\r\n        this.drawLeftEdge(context);\r\n        this.drawRightEdge(context);\r\n        this.drawTopLeftEdge(context);\r\n        this.drawBottomRightEdge(context);\r\n    } else {\r\n        nop();\r\n       \r\n    }\r\n\r\n    // draw method icon if applicable\r\n    if (this.isCustomBlock && !this.isGlobal) {\r\n        this.drawMethodIcon(context);\r\n    }\r\n\r\n    // erase CommandSlots\r\n    this.eraseHoles(context);\r\n};\r\n\r\nCommandBlockMorph.prototype.drawBody = function (context) {\r\n    context.fillRect(\r\n        0,\r\n        Math.floor(this.corner),\r\n        this.width(),\r\n        this.height() - Math.floor(this.corner * 3) + 1\r\n    );\r\n};\r\n\r\nCommandBlockMorph.prototype.drawTop = function (context) {\r\n    context.beginPath();\r\n\r\n    // top left:\r\n    context.arc(\r\n        this.corner,\r\n        this.corner,\r\n        this.corner,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // dent:\r\n    this.drawDent(context, 0, 0);\r\n\r\n    // top right:\r\n    context.arc(\r\n        this.width() - this.corner,\r\n        this.corner,\r\n        this.corner,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawBottom = function (context) {\r\n    var y = this.height() - (this.corner * 2);\r\n\r\n    context.beginPath();\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        this.corner,\r\n        y,\r\n        this.corner,\r\n        radians(180),\r\n        radians(90),\r\n        true\r\n    );\r\n\r\n    if (!this.isStop()) {\r\n        this.drawDent(context, 0, this.height() - this.corner);\r\n    }\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        this.width() - this.corner,\r\n        y,\r\n        this.corner,\r\n        radians(90),\r\n        radians(0),\r\n        true\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawDent = function (context, x, y) {\r\n    var indent = x + this.corner * 2 + this.inset;\r\n\r\n    context.lineTo(x + this.corner + this.inset, y);\r\n    context.lineTo(indent, y + this.corner);\r\n    context.lineTo(indent + this.dent, y + this.corner);\r\n    context.lineTo(x + this.corner * 3 + this.inset + this.dent, y);\r\n    context.lineTo(this.width() - this.corner, y);\r\n};\r\n\r\nCommandBlockMorph.prototype.drawTopDentEdge = function (context, x, y) {\r\n    var shift = this.edge * 0.5,\r\n        indent = x + this.corner * 2 + this.inset,\r\n        upperGradient,\r\n        lowerGradient,\r\n        leftGradient,\r\n        lgx;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    upperGradient = context.createLinearGradient(\r\n        0,\r\n        y,\r\n        0,\r\n        y + this.edge\r\n    );\r\n    upperGradient.addColorStop(0, this.cachedClrBright);\r\n    upperGradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(this.corner, y + shift);\r\n    context.lineTo(x + this.corner + this.inset, y + shift);\r\n    context.stroke();\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        x + this.corner * 3 + this.inset + this.dent + shift,\r\n        y + shift\r\n    );\r\n    context.lineTo(this.width() - this.corner, y + shift);\r\n    context.stroke();\r\n\r\n    lgx = x + this.corner + this.inset;\r\n    leftGradient = context.createLinearGradient(\r\n        lgx - this.edge,\r\n        y + this.edge,\r\n        lgx,\r\n        y\r\n    );\r\n    leftGradient.addColorStop(0, this.cachedClr);\r\n    leftGradient.addColorStop(1, this.cachedClrBright);\r\n\r\n    context.strokeStyle = leftGradient;\r\n    context.beginPath();\r\n    context.moveTo(x + this.corner + this.inset, y + shift);\r\n    context.lineTo(indent, y + this.corner + shift);\r\n    context.stroke();\r\n\r\n    lowerGradient = context.createLinearGradient(\r\n        0,\r\n        y + this.corner,\r\n        0,\r\n        y + this.corner + this.edge\r\n    );\r\n    lowerGradient.addColorStop(0, this.cachedClrBright);\r\n    lowerGradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.strokeStyle = lowerGradient;\r\n    context.beginPath();\r\n    context.moveTo(indent, y + this.corner + shift);\r\n    context.lineTo(indent + this.dent, y + this.corner + shift);\r\n    context.stroke();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawBottomDentEdge = function (context, x, y) {\r\n    var shift = this.edge * 0.5,\r\n        indent = x + this.corner * 2 + this.inset,\r\n        upperGradient,\r\n        lowerGradient,\r\n        rightGradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    upperGradient = context.createLinearGradient(\r\n        0,\r\n        y - this.edge,\r\n        0,\r\n        y\r\n    );\r\n    upperGradient.addColorStop(0, this.cachedClr);\r\n    upperGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(this.corner, y - shift);\r\n    if (this.isStop()) {\r\n        context.lineTo(this.width() - this.corner, y - shift);\r\n    } else {\r\n        context.lineTo(x + this.corner + this.inset - shift, y - shift);\r\n    }\r\n    context.stroke();\r\n\r\n    if (this.isStop()) {    // draw straight bottom edge\r\n        return null;\r\n    }\r\n\r\n    lowerGradient = context.createLinearGradient(\r\n        0,\r\n        y + this.corner - this.edge,\r\n        0,\r\n        y + this.corner\r\n    );\r\n    lowerGradient.addColorStop(0, this.cachedClr);\r\n    lowerGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = lowerGradient;\r\n    context.beginPath();\r\n    context.moveTo(indent + shift, y + this.corner - shift);\r\n    context.lineTo(indent + this.dent, y + this.corner - shift);\r\n    context.stroke();\r\n\r\n    rightGradient = context.createLinearGradient(\r\n        x + indent + this.dent - this.edge,\r\n        y + this.corner - this.edge,\r\n        x + indent + this.dent,\r\n        y + this.corner\r\n    );\r\n    rightGradient.addColorStop(0, this.cachedClr);\r\n    rightGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = rightGradient;\r\n    context.beginPath();\r\n    context.moveTo(x + indent + this.dent, y + this.corner - shift);\r\n    context.lineTo(\r\n        x + this.corner * 3 + this.inset + this.dent,\r\n        y - shift\r\n    );\r\n    context.stroke();\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        x + this.corner * 3 + this.inset + this.dent,\r\n        y - shift\r\n    );\r\n    context.lineTo(this.width() - this.corner, y - shift);\r\n    context.stroke();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawFlatBottomDentEdge = function (context) {\r\n    if (!this.isStop()) {\r\n        context.fillStyle = this.color.darker(this.contrast / 2).toString();\r\n        context.beginPath();\r\n        this.drawDent(context, 0, this.height() - this.corner);\r\n        context.closePath();\r\n        context.fill();\r\n    }\r\n};\r\n\r\nCommandBlockMorph.prototype.drawLeftEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient = context.createLinearGradient(0, 0, this.edge, 0);\r\n\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, this.corner);\r\n    context.lineTo(shift, this.height() - this.corner * 2 - shift);\r\n    context.stroke();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawRightEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        x = this.width(),\r\n        gradient;\r\n\r\n    gradient = context.createLinearGradient(x - this.edge, 0, x, 0);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(x - shift, this.corner + shift);\r\n    context.lineTo(x - shift, this.height() - this.corner * 2);\r\n    context.stroke();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawTopLeftEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient;\r\n\r\n    gradient = context.createRadialGradient(\r\n        this.corner,\r\n        this.corner,\r\n        this.corner,\r\n        this.corner,\r\n        this.corner,\r\n        this.corner - this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.arc(\r\n        this.corner,\r\n        this.corner,\r\n        this.corner - shift,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.stroke();\r\n};\r\n\r\nCommandBlockMorph.prototype.drawBottomRightEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        x = this.width() - this.corner,\r\n        y = this.height() - this.corner * 2,\r\n        gradient;\r\n\r\n    gradient = context.createRadialGradient(\r\n        x,\r\n        y,\r\n        this.corner,\r\n        x,\r\n        y,\r\n        this.corner - this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.arc(\r\n        x,\r\n        y,\r\n        this.corner - shift,\r\n        radians(90),\r\n        radians(0),\r\n        true\r\n    );\r\n    context.stroke();\r\n};\r\n\r\n// HatBlockMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a script's top most block. I can attach command blocks at my\r\n    bottom, but not on top.\r\n\r\n*/\r\n\r\n// HatBlockMorph inherits from CommandBlockMorph:\r\n\r\nHatBlockMorph.prototype = new CommandBlockMorph();\r\nHatBlockMorph.prototype.constructor = HatBlockMorph;\r\nHatBlockMorph.uber = CommandBlockMorph.prototype;\r\n\r\n// HatBlockMorph instance creation:\r\n\r\nfunction HatBlockMorph() {\r\n    this.init();\r\n}\r\n\r\nHatBlockMorph.prototype.init = function () {\r\n    HatBlockMorph.uber.init.call(this, true); // silently\r\n    this.setExtent(new Point(300, 150));\r\n};\r\n\r\n// HatBlockMorph enumerating:\r\n\r\nHatBlockMorph.prototype.blockSequence = function () {\r\n    // override my inherited method so that I am not part of my sequence\r\n    var result = HatBlockMorph.uber.blockSequence.call(this);\r\n    result.shift();\r\n    return result;\r\n};\r\n\r\n// HatBlockMorph drawing:\r\n\r\nHatBlockMorph.prototype.drawTop = function (context) {\r\n    var s = this.hatWidth,\r\n        h = this.hatHeight,\r\n        r = ((4 * h * h) + (s * s)) / (8 * h),\r\n        a = degrees(4 * Math.atan(2 * h / s)),\r\n        sa = a / 2,\r\n        sp = Math.min(s * 1.7, this.width() - this.corner);\r\n\r\n    context.beginPath();\r\n\r\n    context.moveTo(0, h + this.corner);\r\n\r\n    // top arc:\r\n    context.arc(\r\n        s / 2,\r\n        r,\r\n        r,\r\n        radians(-sa - 90),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.bezierCurveTo(\r\n        s,\r\n        0,\r\n        s,\r\n        h,\r\n        sp,\r\n        h\r\n    );\r\n\r\n    // top right:\r\n    context.arc(\r\n        this.width() - this.corner,\r\n        h + this.corner,\r\n        this.corner,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nHatBlockMorph.prototype.drawBody = function (context) {\r\n    context.fillRect(\r\n        0,\r\n        this.hatHeight + Math.floor(this.corner) - 1,\r\n        this.width(),\r\n        this.height() - Math.floor(this.corner * 3) - this.hatHeight + 2\r\n    );\r\n};\r\n\r\nHatBlockMorph.prototype.drawLeftEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient = context.createLinearGradient(0, 0, this.edge, 0);\r\n\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, this.hatHeight + shift);\r\n    context.lineTo(shift, this.height() - this.corner * 2 - shift);\r\n    context.stroke();\r\n};\r\n\r\nHatBlockMorph.prototype.drawRightEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        x = this.width(),\r\n        gradient;\r\n\r\n    gradient = context.createLinearGradient(x - this.edge, 0, x, 0);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(x - shift, this.corner + this.hatHeight + shift);\r\n    context.lineTo(x - shift, this.height() - this.corner * 2);\r\n    context.stroke();\r\n};\r\n\r\nHatBlockMorph.prototype.drawTopDentEdge = function () {\r\n    return null;\r\n};\r\n\r\nHatBlockMorph.prototype.drawTopLeftEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        s = this.hatWidth,\r\n        h = this.hatHeight,\r\n        r = ((4 * h * h) + (s * s)) / (8 * h),\r\n        a = degrees(4 * Math.atan(2 * h / s)),\r\n        sa = a / 2,\r\n        sp = Math.min(s * 1.7, this.width() - this.corner),\r\n        gradient;\r\n\r\n    gradient = context.createRadialGradient(\r\n        s / 2,\r\n        r,\r\n        r - this.edge,\r\n        s / 2,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrBright);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        Math.round(s / 2),\r\n        r,\r\n        r - shift,\r\n        radians(-sa - 90),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.moveTo(s / 2, shift);\r\n    context.bezierCurveTo(\r\n        s,\r\n        shift,\r\n        s,\r\n        h + shift,\r\n        sp,\r\n        h + shift\r\n    );\r\n    context.lineTo(this.width() - this.corner, h + shift);\r\n    context.stroke();\r\n};\r\n\r\n// ReporterBlockMorph //////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a block with a return value, either round-ish or diamond shaped\r\n    I inherit all my important accessors from BlockMorph\r\n*/\r\n\r\n// ReporterBlockMorph inherits from BlockMorph:\r\n\r\nReporterBlockMorph.prototype = new BlockMorph();\r\nReporterBlockMorph.prototype.constructor = ReporterBlockMorph;\r\nReporterBlockMorph.uber = BlockMorph.prototype;\r\n\r\n// ReporterBlockMorph instance creation:\r\n\r\nfunction ReporterBlockMorph(isPredicate) {\r\n    this.init(isPredicate);\r\n}\r\n\r\nReporterBlockMorph.prototype.init = function (isPredicate, silently) {\r\n    ReporterBlockMorph.uber.init.call(this, silently);\r\n    this.isPredicate = isPredicate || false;\r\n    this.setExtent(new Point(200, 80), silently);\r\n    this.cachedSlotSpec = null; // don't serialize\r\n};\r\n\r\n// ReporterBlockMorph drag & drop:\r\n\r\nReporterBlockMorph.prototype.snap = function (hand) {\r\n    // passing the hand is optional (for when blocks are dragged & dropped)\r\n    var scripts = this.parent,\r\n        nb,\r\n        target;\r\n\r\n    this.cachedSlotSpec = null;\r\n    if (!(scripts instanceof ScriptsMorph)) {\r\n        return null;\r\n    }\r\n\r\n    scripts.clearDropInfo();\r\n    scripts.lastDroppedBlock = this;\r\n\r\n    target = scripts.closestInput(this, hand);\r\n    if (target !== null) {\r\n        scripts.lastReplacedInput = target;\r\n        scripts.lastDropTarget = target.parent;\r\n        if (target instanceof MultiArgMorph) {\r\n            scripts.lastPreservedBlocks = target.inputs();\r\n            scripts.lastReplacedInput = target.fullCopy();\r\n        } else if (target instanceof CommandSlotMorph) {\r\n            scripts.lastReplacedInput = target;\r\n            nb = target.nestedBlock();\r\n            if (nb) {\r\n                nb = nb.fullCopy();\r\n                scripts.add(nb);\r\n                nb.moveBy(nb.extent());\r\n                nb.fixBlockColor();\r\n                scripts.lastPreservedBlocks = [nb];\r\n            }\r\n        }\r\n        target.parent.replaceInput(target, this);\r\n        if (this.snapSound) {\r\n            this.snapSound.play();\r\n        }\r\n    }\r\n    this.startLayout();\r\n    this.fixBlockColor();\r\n    this.endLayout();\r\n    ReporterBlockMorph.uber.snap.call(this);\r\n    if (hand) {\r\n        scripts.recordDrop(hand.grabOrigin);\r\n    }\r\n};\r\n\r\nReporterBlockMorph.prototype.prepareToBeGrabbed = function (handMorph) {\r\n    var oldPos = this.position();\r\n\r\n    nop(handMorph);\r\n    if ((this.parent instanceof BlockMorph)\r\n            || (this.parent instanceof MultiArgMorph)\r\n            || (this.parent instanceof ReporterSlotMorph)) {\r\n        this.parent.revertToDefaultInput(this);\r\n        this.setPosition(oldPos);\r\n    }\r\n    ReporterBlockMorph.uber.prepareToBeGrabbed.call(this, handMorph);\r\n    this.alpha = 0.85;\r\n    this.cachedSlotSpec = null;\r\n};\r\n\r\n// ReporterBlockMorph enumerating\r\n\r\nReporterBlockMorph.prototype.blockSequence = function () {\r\n    // reporters don't have a sequence, answer myself\r\n    return this;\r\n};\r\n\r\n// ReporterBlockMorph evaluating\r\n\r\nReporterBlockMorph.prototype.isUnevaluated = function () {\r\n    // answer whether my parent block's slot is designated to be of an\r\n    // 'unevaluated' kind, denoting a spedial form\r\n    var spec = this.getSlotSpec();\r\n    return spec === '%anyUE' ||\r\n        spec === '%boolUE' ||\r\n        spec === '%f';\r\n};\r\n\r\nReporterBlockMorph.prototype.isLocked = function () {\r\n    // answer true if I can be exchanged by a dropped reporter\r\n    return this.isStatic || (this.getSlotSpec() === '%t');\r\n};\r\n\r\nReporterBlockMorph.prototype.getSlotSpec = function () {\r\n    // answer the spec of the slot I'm in, if any\r\n    // cached for performance\r\n    if (!this.cachedSlotSpec) {\r\n        this.cachedSlotSpec = this.determineSlotSpec();\r\n    }\r\n    return this.cachedSlotSpec;\r\n};\r\n\r\nReporterBlockMorph.prototype.determineSlotSpec = function () {\r\n    // private - answer the spec of the slot I'm in, if any\r\n    var parts, idx;\r\n    if (this.parent instanceof BlockMorph) {\r\n        parts = this.parent.parts().filter(\r\n            function (part) {\r\n                return !(part instanceof BlockHighlightMorph);\r\n            }\r\n        );\r\n        idx = parts.indexOf(this);\r\n        if (idx !== -1) {\r\n            if (this.parent.blockSpec) {\r\n                return this.parseSpec(this.parent.blockSpec)[idx];\r\n            }\r\n        }\r\n    }\r\n    if (this.parent instanceof MultiArgMorph) {\r\n        return this.parent.slotSpec;\r\n    }\r\n    if (this.parent instanceof TemplateSlotMorph) {\r\n        return this.parent.getSpec();\r\n    }\r\n    return null;\r\n};\r\n\r\n// ReporterBlockMorph events\r\n\r\nReporterBlockMorph.prototype.mouseClickLeft = function (pos) {\r\n    var label;\r\n    if (this.parent instanceof BlockInputFragmentMorph) {\r\n        return this.parent.mouseClickLeft();\r\n    }\r\n    if (this.parent instanceof TemplateSlotMorph) {\r\n        if (this.parent.parent && this.parent.parent.parent &&\r\n                this.parent.parent.parent instanceof RingMorph) {\r\n            label = \"Input name\";\r\n        } else if (this.parent.parent.elementSpec === '%blockVars') {\r\n            label = \"Block variable name\";\r\n        } else {\r\n            label = \"Script variable name\";\r\n        }\r\n        new DialogBoxMorph(\r\n            this,\r\n            this.userSetSpec,\r\n            this\r\n        ).prompt(\r\n            label,\r\n            this.blockSpec,\r\n            this.world()\r\n        );\r\n    } else {\r\n        ReporterBlockMorph.uber.mouseClickLeft.call(this, pos);\r\n    }\r\n};\r\n\r\n// ReporterBlock exporting picture with result bubble\r\n\r\nReporterBlockMorph.prototype.exportResultPic = function () {\r\n    var top = this.topBlock(),\r\n        receiver = top.scriptTarget(),\r\n        stage;\r\n    if (top !== this) {return; }\r\n    if (receiver) {\r\n        stage = receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.threads.stopProcess(top);\r\n            stage.threads.startProcess(top, receiver, false, true);\r\n        }\r\n    }\r\n};\r\n\r\n// ReporterBlockMorph deleting\r\n\r\nReporterBlockMorph.prototype.userDestroy = function () {\r\n    // make sure to restore default slot of parent block\r\n    var target = this.selectForEdit(); // enable copy-on-edit\r\n    if (target !== this) {\r\n        return this.userDestroy.call(target);\r\n    }\r\n\r\n    // for undrop / redrop\r\n    var scripts = this.parentThatIsA(ScriptsMorph);\r\n    if (scripts) {\r\n        scripts.clearDropInfo();\r\n        scripts.lastDroppedBlock = this;\r\n        scripts.recordDrop(this.situation());\r\n        scripts.dropRecord.action = 'delete';\r\n    }\r\n\r\n    this.topBlock().fullChanged();\r\n    this.prepareToBeGrabbed(this.world().hand);\r\n    this.destroy();\r\n};\r\n\r\n// ReporterBlockMorph drawing:\r\n\r\nReporterBlockMorph.prototype.drawNew = function () {\r\n    var context;\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n\r\n    if (this.isPredicate) {\r\n        this.drawDiamond(context);\r\n    } else {\r\n        this.drawRounded(context);\r\n    }\r\n\r\n    // draw method icon if applicable\r\n    if (this.isCustomBlock && !this.isGlobal) {\r\n        this.drawMethodIcon(context);\r\n    }\r\n    // erase CommandSlots\r\n    this.eraseHoles(context);\r\n};\r\n\r\nReporterBlockMorph.prototype.drawRounded = function (context) {\r\n    var h = this.height(),\r\n        r = Math.min(this.rounding, h / 2),\r\n        w = this.width(),\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.cachedClr;\r\n    context.beginPath();\r\n\r\n    // top left:\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // top right:\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // half-tone edges\r\n    // bottem left corner\r\n    gradient = context.createRadialGradient(\r\n        r,\r\n        h - r,\r\n        r - this.edge,\r\n        r,\r\n        h - r,\r\n        r + this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r - shift,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    gradient = context.createRadialGradient(\r\n        w - r,\r\n        r,\r\n        r - this.edge,\r\n        w - r,\r\n        r,\r\n        r + this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r - shift,\r\n        radians(-90),\r\n        radians(0),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, shift);\r\n    context.lineTo(w - r + shift, shift);\r\n    context.stroke();\r\n\r\n    // top edge: left corner\r\n    gradient = context.createRadialGradient(\r\n        r,\r\n        r,\r\n        r - this.edge,\r\n        r,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r - shift,\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createRadialGradient(\r\n        w - r,\r\n        h - r,\r\n        r - this.edge,\r\n        w - r,\r\n        h - r,\r\n        r\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r - shift,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, h - shift);\r\n    context.lineTo(w - r + shift, h - shift);\r\n    context.stroke();\r\n\r\n    // left edge: straight vertical line\r\n    gradient = context.createLinearGradient(0, 0, this.edge, 0);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, r);\r\n    context.lineTo(shift, h - r);\r\n    context.stroke();\r\n\r\n    // right edge: straight vertical line\r\n    gradient = context.createLinearGradient(w - this.edge, 0, w, 0);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, r + shift);\r\n    context.lineTo(w - shift, h - r);\r\n    context.stroke();\r\n\r\n};\r\n\r\nReporterBlockMorph.prototype.drawDiamond = function (context) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        h2 = Math.floor(h / 2),\r\n        r = this.rounding,\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.cachedClr;\r\n    context.beginPath();\r\n\r\n    context.moveTo(0, h2);\r\n    context.lineTo(r, 0);\r\n    context.lineTo(w - r, 0);\r\n    context.lineTo(w, h2);\r\n    context.lineTo(w - r, h);\r\n    context.lineTo(r, h);\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // half-tone edges\r\n    // bottom left corner\r\n    gradient = context.createLinearGradient(\r\n        -r,\r\n        0,\r\n        r,\r\n        0\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, h - shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    gradient = context.createLinearGradient(\r\n        w - r,\r\n        0,\r\n        w + r,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, h2);\r\n    context.lineTo(w - r, shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n    // top edge: left corner\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        r,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r, shift);\r\n    context.lineTo(w - r, shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createLinearGradient(\r\n        w - r,\r\n        0,\r\n        w,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - r, h - shift);\r\n    context.lineTo(w - shift, h2);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r + shift, h - shift);\r\n    context.lineTo(w - r - shift, h - shift);\r\n    context.closePath();\r\n    context.stroke();\r\n};\r\n\r\n// RingMorph /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a reporter block which reifies its contents, my outer shape is\r\n    always roundish (never diamond)\r\n*/\r\n\r\n// RingMorph inherits from ReporterBlockMorph:\r\n\r\nRingMorph.prototype = new ReporterBlockMorph();\r\nRingMorph.prototype.constructor = RingMorph;\r\nRingMorph.uber = ReporterBlockMorph.prototype;\r\n\r\n// RingMorph preferences settings:\r\n\r\nRingMorph.prototype.isCachingInputs = false;\r\n// RingMorph.prototype.edge = 2;\r\n// RingMorph.prototype.rounding = 9;\r\n// RingMorph.prototype.alpha = 0.8;\r\n// RingMorph.prototype.contrast = 85;\r\n\r\n// RingMorph instance creation:\r\n\r\nfunction RingMorph() {\r\n    this.init();\r\n}\r\n\r\nRingMorph.prototype.init = function () {\r\n    RingMorph.uber.init.call(this);\r\n    this.category = 'other';\r\n    this.alpha = RingMorph.prototype.alpha;\r\n    this.contrast = RingMorph.prototype.contrast;\r\n    this.setExtent(new Point(200, 80));\r\n};\r\n\r\n// RingMorph dragging and dropping\r\n\r\nRingMorph.prototype.rootForGrab = function () {\r\n    if (this.isDraggable) {\r\n        return this;\r\n    }\r\n    return BlockMorph.uber.rootForGrab.call(this);\r\n};\r\n\r\n// RingMorph ops - Note: these assume certain layouts defined elsewhere -\r\n\r\nRingMorph.prototype.embed = function (aBlock, inputNames) {\r\n    var slot;\r\n\r\n    // set my color\r\n    this.color = SpriteMorph.prototype.blockColor.other;\r\n    this.isDraggable = true;\r\n\r\n    // set my type, selector, and nested block:\r\n    if (aBlock instanceof CommandBlockMorph) {\r\n        this.isStatic = false;\r\n        this.setSpec('%rc %ringparms');\r\n        this.selector = 'reifyScript';\r\n        slot = this.parts()[0];\r\n        slot.nestedBlock(aBlock);\r\n    } else if (aBlock.isPredicate) {\r\n        this.isStatic = true;\r\n        this.setSpec('%rp %ringparms');\r\n        this.selector = 'reifyPredicate';\r\n        slot = this.parts()[0];\r\n        slot.silentReplaceInput(slot.contents(), aBlock);\r\n    } else if (aBlock instanceof BooleanSlotMorph) {\r\n        this.isStatic = false;\r\n        this.setSpec('%rp %ringparms');\r\n        this.selector = 'reifyPredicate';\r\n        slot = this.parts()[0];\r\n        slot.silentReplaceInput(slot.contents(), aBlock);\r\n    } else { // reporter or input slot)\r\n        this.isStatic = false;\r\n        this.setSpec('%rr %ringparms');\r\n        this.selector = 'reifyReporter';\r\n        slot = this.parts()[0];\r\n        slot.silentReplaceInput(slot.contents(), aBlock);\r\n    }\r\n\r\n    // set my inputs, if any\r\n    slot = this.parts()[1];\r\n    if (inputNames) {\r\n        inputNames.forEach(function (name) {\r\n            slot.addInput(name);\r\n        });\r\n    }\r\n\r\n    // ensure zebra coloring\r\n    this.fixBlockColor(null, true);\r\n};\r\n\r\nRingMorph.prototype.vanishForSimilar = function () {\r\n    // let me disappear if I am nesting a variable getter or Ring\r\n    // but only if I'm not already inside another ring\r\n    var slot = this.parts()[0],\r\n        block = slot.nestedBlock();\r\n\r\n    if (!block) {return null; }\r\n    if (!(this.parent instanceof SyntaxElementMorph)) {return null; }\r\n    if (this.parent instanceof RingReporterSlotMorph\r\n            || (this.parent instanceof RingCommandSlotMorph)) {\r\n        return null;\r\n    }\r\n    if (block.selector === 'reportGetVar' ||\r\n        block.selector === 'reportJSFunction' ||\r\n        (block instanceof RingMorph)\r\n    ) {\r\n        this.parent.silentReplaceInput(this, block);\r\n    }\r\n};\r\n\r\nRingMorph.prototype.contents = function () {\r\n    return this.parts()[0].nestedBlock();\r\n};\r\n\r\nRingMorph.prototype.inputNames = function () {\r\n    return this.parts()[1].evaluate();\r\n};\r\n\r\nRingMorph.prototype.dataType = function () {\r\n    switch (this.selector) {\r\n    case 'reifyScript':\r\n        return 'command';\r\n    case 'reifyPredicate':\r\n        return 'predicate';\r\n    default:\r\n        return 'reporter';\r\n    }\r\n};\r\n\r\n// RingMorph zebra coloring\r\n\r\nRingMorph.prototype.fixBlockColor = function (nearest, isForced) {\r\n    var slot = this.parts()[0];\r\n    RingMorph.uber.fixBlockColor.call(this, nearest, isForced);\r\n    slot.fixLayout();\r\n};\r\n\r\n// ScriptsMorph ////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I give feedback about possible drop targets and am in charge\r\n    of actually snapping blocks together.\r\n\r\n    My children are the top blocks of scripts.\r\n\r\n    I store a back-pointer to my owner, i.e. the object (sprite)\r\n    to whom my scripts apply.\r\n*/\r\n\r\n// ScriptsMorph inherits from FrameMorph:\r\n\r\nScriptsMorph.prototype = new FrameMorph();\r\nScriptsMorph.prototype.constructor = ScriptsMorph;\r\nScriptsMorph.uber = FrameMorph.prototype;\r\n\r\n// ScriptsMorph preference settings\r\n\r\nScriptsMorph.prototype.cleanUpMargin = 20;\r\nScriptsMorph.prototype.cleanUpSpacing = 15;\r\nScriptsMorph.prototype.isPreferringEmptySlots = true;\r\nScriptsMorph.prototype.enableKeyboard = true;\r\nScriptsMorph.prototype.enableNestedAutoWrapping = true;\r\n\r\n// ScriptsMorph instance creation:\r\n\r\nfunction ScriptsMorph() {\r\n    this.init();\r\n}\r\n\r\nScriptsMorph.prototype.init = function () {\r\n    this.feedbackColor = SyntaxElementMorph.prototype.feedbackColor;\r\n    this.feedbackMorph = new BoxMorph();\r\n    this.rejectsHats = false;\r\n\r\n    // \"undrop\" attributes:\r\n    this.lastDroppedBlock = null;\r\n    this.lastReplacedInput = null;\r\n    this.lastDropTarget = null;\r\n    this.lastPreservedBlocks = null;\r\n    this.lastNextBlock = null;\r\n    this.lastWrapParent = null;\r\n\r\n    // keyboard editing support:\r\n    this.focus = null;\r\n\r\n    ScriptsMorph.uber.init.call(this);\r\n    this.setColor(new Color(70, 70, 70));\r\n    this.noticesTransparentClick = true;\r\n\r\n    // initialize \"undrop\" queue\r\n    this.isAnimating = false;\r\n    this.dropRecord = null;\r\n    this.recordDrop();\r\n};\r\n\r\n// ScriptsMorph deep copying:\r\n\r\nScriptsMorph.prototype.fullCopy = function () {\r\n    var cpy = new ScriptsMorph(),\r\n        pos = this.position(),\r\n        child;\r\n    if (this.focus) {\r\n        this.focus.stopEditing();\r\n    }\r\n    this.children.forEach(function (morph) {\r\n        if (!morph.block) { // omit anchored comments\r\n            child = morph.fullCopy();\r\n            cpy.add(child);\r\n            child.setPosition(morph.position().subtract(pos));\r\n            if (child instanceof BlockMorph) {\r\n                child.allComments().forEach(function (comment) {\r\n                    comment.align(child);\r\n                });\r\n            }\r\n        }\r\n    });\r\n    cpy.adjustBounds();\r\n    return cpy;\r\n};\r\n\r\n// ScriptsMorph stepping:\r\n\r\nScriptsMorph.prototype.step = function () {\r\n    var world = this.world(),\r\n        hand = world.hand,\r\n        block;\r\n\r\n    if (this.feedbackMorph.parent) {\r\n        this.feedbackMorph.destroy();\r\n        this.feedbackMorph.parent = null;\r\n    }\r\n    if (this.focus && (!world.keyboardReceiver ||\r\n            world.keyboardReceiver instanceof StageMorph)) {\r\n        this.focus.getFocus(world);\r\n    }\r\n    if (hand.children.length === 0) {\r\n        return null;\r\n    }\r\n    if (!this.bounds.containsPoint(hand.bounds.origin)) {\r\n        return null;\r\n    }\r\n    block = hand.children[0];\r\n    if (!(block instanceof BlockMorph) && !(block instanceof CommentMorph)) {\r\n        return null;\r\n    }\r\n    if (!contains(hand.morphAtPointer().allParents(), this)) {\r\n        return null;\r\n    }\r\n    if (block instanceof CommentMorph) {\r\n        this.showCommentDropFeedback(block, hand);\r\n    } else if (block instanceof ReporterBlockMorph) {\r\n        this.showReporterDropFeedback(block, hand);\r\n    } else {\r\n        this.showCommandDropFeedback(block);\r\n    }\r\n};\r\n\r\nScriptsMorph.prototype.showReporterDropFeedback = function (block, hand) {\r\n    var target = this.closestInput(block, hand);\r\n\r\n    if (target === null) {\r\n        return null;\r\n    }\r\n    this.feedbackMorph.bounds = target.fullBounds()\r\n        .expandBy(Math.max(\r\n            block.edge * 2,\r\n            block.reporterDropFeedbackPadding\r\n        ));\r\n    this.feedbackMorph.edge = SyntaxElementMorph.prototype.rounding;\r\n    this.feedbackMorph.border = Math.max(\r\n        SyntaxElementMorph.prototype.edge,\r\n        3\r\n    );\r\n    this.add(this.feedbackMorph);\r\n    if (target instanceof MultiArgMorph) {\r\n        this.feedbackMorph.color =\r\n            SpriteMorph.prototype.blockColor.lists.copy();\r\n        this.feedbackMorph.borderColor =\r\n            SpriteMorph.prototype.blockColor.lists;\r\n    } else {\r\n        this.feedbackMorph.color = this.feedbackColor.copy();\r\n        this.feedbackMorph.borderColor = this.feedbackColor;\r\n    }\r\n    this.feedbackMorph.color.a = 0.5;\r\n    this.feedbackMorph.drawNew();\r\n    this.feedbackMorph.changed();\r\n};\r\n\r\nScriptsMorph.prototype.showCommandDropFeedback = function (block) {\r\n    var y, target;\r\n\r\n    target = block.closestAttachTarget(this);\r\n    if (!target) {\r\n        return null;\r\n    }\r\n    if (target.loc === 'wrap') {\r\n        this.showCSlotWrapFeedback(block, target.element);\r\n        return;\r\n    }\r\n    this.add(this.feedbackMorph);\r\n    this.feedbackMorph.border = 0;\r\n    this.feedbackMorph.edge = 0;\r\n    this.feedbackMorph.alpha = 1;\r\n    this.feedbackMorph.setExtent(new Point(\r\n        target.element.width(),\r\n        Math.max(\r\n            SyntaxElementMorph.prototype.corner,\r\n            SyntaxElementMorph.prototype.feedbackMinHeight\r\n        )\r\n    ));\r\n    this.feedbackMorph.color = this.feedbackColor;\r\n    this.feedbackMorph.drawNew();\r\n    this.feedbackMorph.changed();\r\n    y = target.point.y;\r\n    if (target.loc === 'bottom') {\r\n        if (target.type === 'block') {\r\n            if (target.element.nextBlock()) {\r\n                y -= SyntaxElementMorph.prototype.corner;\r\n            }\r\n        } else if (target.type === 'slot') {\r\n            if (target.element.nestedBlock()) {\r\n                y -= SyntaxElementMorph.prototype.corner;\r\n            }\r\n        }\r\n    }\r\n    this.feedbackMorph.setPosition(new Point(\r\n        target.element.left(),\r\n        y\r\n    ));\r\n};\r\n\r\nScriptsMorph.prototype.showCommentDropFeedback = function (comment, hand) {\r\n    var target = this.closestBlock(comment, hand);\r\n    if (!target) {\r\n        return null;\r\n    }\r\n\r\n    this.feedbackMorph.bounds = target.bounds\r\n        .expandBy(Math.max(\r\n            BlockMorph.prototype.edge * 2,\r\n            BlockMorph.prototype.reporterDropFeedbackPadding\r\n        ));\r\n    this.feedbackMorph.edge = SyntaxElementMorph.prototype.rounding;\r\n    this.feedbackMorph.border = Math.max(\r\n        SyntaxElementMorph.prototype.edge,\r\n        3\r\n    );\r\n    this.add(this.feedbackMorph);\r\n    this.feedbackMorph.color = comment.color.copy();\r\n    this.feedbackMorph.color.a = 0.25;\r\n    this.feedbackMorph.borderColor = comment.titleBar.color;\r\n    this.feedbackMorph.drawNew();\r\n    this.feedbackMorph.changed();\r\n};\r\n\r\nScriptsMorph.prototype.showCSlotWrapFeedback = function (srcBlock, trgBlock) {\r\n    var clr;\r\n    this.feedbackMorph.bounds = trgBlock.fullBounds()\r\n        .expandBy(BlockMorph.prototype.corner);\r\n    this.feedbackMorph.edge = SyntaxElementMorph.prototype.corner;\r\n    this.feedbackMorph.border = Math.max(\r\n        SyntaxElementMorph.prototype.edge,\r\n        3\r\n    );\r\n    this.add(this.feedbackMorph);\r\n    clr = srcBlock.color.lighter(40);\r\n    this.feedbackMorph.color = clr.copy();\r\n    this.feedbackMorph.color.a = 0.1;\r\n    this.feedbackMorph.borderColor = clr;\r\n    this.feedbackMorph.drawNew();\r\n    this.feedbackMorph.changed();\r\n};\r\n\r\nScriptsMorph.prototype.closestInput = function (reporter, hand) {\r\n    // passing the hand is optional (when dragging reporters)\r\n    var fb = reporter.fullBoundsNoShadow(),\r\n        stacks = this.children.filter(function (child) {\r\n            return (child instanceof BlockMorph) &&\r\n                (child.fullBounds().intersects(fb));\r\n        }),\r\n        blackList = reporter.allInputs(),\r\n        handPos,\r\n        target,\r\n        all;\r\n\r\n    all = [];\r\n    stacks.forEach(function (stack) {\r\n        all = all.concat(stack.allInputs());\r\n    });\r\n    if (all.length === 0) {return null; }\r\n\r\n    function touchingVariadicArrowsIfAny(inp, point) {\r\n        if (inp instanceof MultiArgMorph) {\r\n            if (point) {\r\n                return inp.arrows().bounds.containsPoint(point);\r\n            }\r\n            return inp.arrows().bounds.intersects(fb);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    if (this.isPreferringEmptySlots) {\r\n        if (hand) {\r\n            handPos = hand.position();\r\n            target = detect(\r\n                all,\r\n                function (input) {\r\n                    return (input instanceof InputSlotMorph\r\n                            || (input instanceof ArgMorph\r\n                                && !(input instanceof CommandSlotMorph)\r\n                                && !(input instanceof MultiArgMorph))\r\n                            || (input instanceof RingMorph\r\n                                && !input.contents())\r\n                            || input.isEmptySlot())\r\n                        && !input.isLocked()\r\n                        && input.bounds.containsPoint(handPos)\r\n                        && !contains(blackList, input);\r\n                }\r\n            );\r\n            if (target) {\r\n                return target;\r\n            }\r\n        }\r\n        target = detect(\r\n            all,\r\n            function (input) {\r\n                return (input instanceof InputSlotMorph\r\n                        || input instanceof ArgMorph\r\n                        || (input instanceof RingMorph\r\n                            && !input.contents())\r\n                        || input.isEmptySlot())\r\n                    && !input.isLocked()\r\n                    && input.bounds.intersects(fb)\r\n                    && !contains(blackList, input)\r\n                    && touchingVariadicArrowsIfAny(input);\r\n            }\r\n        );\r\n        if (target) {\r\n            return target;\r\n        }\r\n    }\r\n\r\n    if (hand) {\r\n        handPos = hand.position();\r\n        target = detect(\r\n            all,\r\n            function (input) {\r\n                return (input !== reporter)\r\n                    && !input.isLocked()\r\n                    && input.bounds.containsPoint(handPos)\r\n                    && !(input.parent instanceof PrototypeHatBlockMorph)\r\n                    && !contains(blackList, input);\r\n            }\r\n        );\r\n        if (target) {\r\n            return target;\r\n        }\r\n    }\r\n    return detect(\r\n        all,\r\n        function (input) {\r\n            return (input !== reporter)\r\n                && !input.isLocked()\r\n                && input.fullBounds().intersects(fb)\r\n                && !(input.parent instanceof PrototypeHatBlockMorph)\r\n                && !contains(blackList, input);\r\n        }\r\n    );\r\n};\r\n\r\nScriptsMorph.prototype.closestBlock = function (comment, hand) {\r\n    // passing the hand is optional (when dragging comments)\r\n    var fb = comment.bounds,\r\n        stacks = this.children.filter(function (child) {\r\n            return (child instanceof BlockMorph) &&\r\n                (child.fullBounds().intersects(fb));\r\n        }),\r\n        handPos,\r\n        target,\r\n        all;\r\n\r\n    all = [];\r\n    stacks.forEach(function (stack) {\r\n        all = all.concat(stack.allChildren().slice(0).reverse().filter(\r\n            function (child) {return child instanceof BlockMorph &&\r\n                !child.isTemplate; }\r\n        ));\r\n    });\r\n    if (all.length === 0) {return null; }\r\n\r\n    if (hand) {\r\n        handPos = hand.position();\r\n        target = detect(\r\n            all,\r\n            function (block) {\r\n                return !block.comment\r\n                    && !block.isPrototype\r\n                    && block.bounds.containsPoint(handPos);\r\n            }\r\n        );\r\n        if (target) {\r\n            return target;\r\n        }\r\n    }\r\n    return detect(\r\n        all,\r\n        function (block) {\r\n            return !block.comment\r\n                && !block.isPrototype\r\n                && block.bounds.intersects(fb);\r\n        }\r\n    );\r\n};\r\n\r\n// ScriptsMorph user menu\r\n\r\nScriptsMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        shiftClicked = this.world().currentKey === 16,\r\n        blockEditor,\r\n        myself = this,\r\n        obj = this.scriptTarget(),\r\n        hasUndropQueue,\r\n        stage = obj.parentThatIsA(StageMorph);\r\n\r\n    function addOption(label, toggle, test, onHint, offHint) {\r\n        var on = '\\u2611 ',\r\n            off = '\\u2610 ';\r\n        menu.addItem(\r\n            (test ? on : off) + localize(label),\r\n            toggle,\r\n            test ? onHint : offHint\r\n        );\r\n    }\r\n\r\n    if (!ide) {\r\n        blockEditor = this.parentThatIsA(BlockEditorMorph);\r\n        if (blockEditor) {\r\n            ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n        }\r\n    }\r\n    if (this.dropRecord) {\r\n        if (this.dropRecord.lastRecord) {\r\n            hasUndropQueue = true;\r\n            menu.addPair(\r\n                [\r\n                    new SymbolMorph(\r\n                        'turnBack',\r\n                        MorphicPreferences.menuFontSize\r\n                    ),\r\n                    localize('undrop')\r\n                ],\r\n                'undrop',\r\n                '^Z',\r\n                'undo the last\\nblock drop\\nin this pane'\r\n            );\r\n        }\r\n        if (this.dropRecord.nextRecord) {\r\n            hasUndropQueue = true;\r\n            menu.addPair(\r\n                [\r\n                    new SymbolMorph(\r\n                        'turnForward',\r\n                        MorphicPreferences.menuFontSize\r\n                    ),\r\n                    localize('redrop')\r\n                ],\r\n                'redrop',\r\n                '^Y',\r\n                'redo the last undone\\nblock drop\\nin this pane'\r\n            );\r\n        }\r\n        if (hasUndropQueue) {\r\n            if (shiftClicked) {\r\n                menu.addItem(\r\n                    \"clear undrop queue\",\r\n                    function () {\r\n                        myself.dropRecord = null;\r\n                        myself.clearDropInfo();\r\n                        myself.recordDrop();\r\n                    },\r\n                    'forget recorded block drops\\non this pane',\r\n                    new Color(100, 0, 0)\r\n                );\r\n            }\r\n            menu.addLine();\r\n        }\r\n    }\r\n\r\n    menu.addItem('clean up', 'cleanUp', 'arrange scripts\\nvertically');\r\n    menu.addItem('add comment', 'addComment');\r\n    menu.addItem(\r\n        'scripts pic...',\r\n        'exportScriptsPicture',\r\n        'open a new window\\nwith a picture of all scripts'\r\n    );\r\n    if (ide) {\r\n        menu.addLine();\r\n        if (!blockEditor && obj.exemplar) {\r\n                addOption(\r\n                    'inherited',\r\n                    function () {\r\n                        obj.toggleInheritanceForAttribute('scripts');\r\n                    },\r\n                    obj.inheritsAttribute('scripts'),\r\n                    'uncheck to\\ndisinherit',\r\n                    localize('check to inherit\\nfrom')\r\n                        + ' ' + obj.exemplar.name\r\n                );\r\n        }\r\n        menu.addItem(\r\n            'make a block...',\r\n            function () {\r\n                new BlockDialogMorph(\r\n                    null,\r\n                    function (definition) {\r\n                        if (definition.spec !== '') {\r\n                            if (definition.isGlobal) {\r\n                                stage.globalBlocks.push(definition);\r\n                            } else {\r\n                                obj.customBlocks.push(definition);\r\n                            }\r\n                            ide.flushPaletteCache();\r\n                            ide.refreshPalette();\r\n                            new BlockEditorMorph(definition, obj).popUp();\r\n                        }\r\n                    },\r\n                    myself\r\n                ).prompt(\r\n                    'Make a block',\r\n                    null,\r\n                    myself.world()\r\n                );\r\n            }\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\n// ScriptsMorph user menu features:\r\n\r\nScriptsMorph.prototype.cleanUp = function () {\r\n    var target = this.selectForEdit(), // enable copy-on-edit\r\n        origin = target.topLeft(),\r\n        y = target.cleanUpMargin;\r\n    target.children.sort(function (a, b) {\r\n        // make sure the prototype hat block always stays on top\r\n        return a instanceof PrototypeHatBlockMorph ? 0 : a.top() - b.top();\r\n    }).forEach(function (child) {\r\n        if (child instanceof CommentMorph && child.block) {\r\n            return; // skip anchored comments\r\n        }\r\n        child.setPosition(origin.add(new Point(target.cleanUpMargin, y)));\r\n        if (child instanceof BlockMorph) {\r\n            child.allComments().forEach(function (comment) {\r\n                comment.align(child, true); // ignore layer\r\n            });\r\n        }\r\n        y += child.stackHeight() + target.cleanUpSpacing;\r\n    });\r\n    if (target.parent) {\r\n        target.setPosition(target.parent.topLeft());\r\n    }\r\n    target.adjustBounds();\r\n};\r\n\r\nScriptsMorph.prototype.exportScriptsPicture = function () {\r\n    var pic = this.scriptsPicture(),\r\n        ide = this.world().children[0];\r\n    if (pic) {\r\n        ide.saveCanvasAs(\r\n            pic,\r\n            (ide.projectName || localize('untitled')) + ' ' +\r\n                localize('script pic')\r\n        );\r\n    }\r\n};\r\n\r\nScriptsMorph.prototype.scriptsPicture = function () {\r\n    // private - answer a canvas containing the pictures of all scripts\r\n    var boundingBox, pic, ctx;\r\n    if (this.children.length === 0) {return; }\r\n    boundingBox = this.children[0].fullBounds();\r\n    this.children.forEach(function (child) {\r\n        if (child.isVisible) {\r\n            boundingBox = boundingBox.merge(child.fullBounds());\r\n        }\r\n    });\r\n    pic = newCanvas(boundingBox.extent());\r\n    ctx = pic.getContext('2d');\r\n    this.children.forEach(function (child) {\r\n        var pos = child.fullBounds().origin;\r\n        if (child.isVisible) {\r\n            ctx.drawImage(\r\n                child.fullImageClassic(),\r\n                pos.x - boundingBox.origin.x,\r\n                pos.y - boundingBox.origin.y\r\n            );\r\n        }\r\n    });\r\n    return pic;\r\n};\r\n\r\nScriptsMorph.prototype.addComment = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        blockEditor = this.parentThatIsA(BlockEditorMorph),\r\n        world = this.world();\r\n    new CommentMorph().pickUp(world);\r\n    // register the drop-origin, so the element can\r\n    // slide back to its former situation if dropped\r\n    // somewhere where it gets rejected\r\n    if (!ide && blockEditor) {\r\n        ide = blockEditor.target.parentThatIsA(IDE_Morph);\r\n    }\r\n    if (ide) {\r\n        world.hand.grabOrigin = {\r\n            origin: ide.palette,\r\n            position: ide.palette.center()\r\n        };\r\n    }\r\n};\r\n\r\n// ScriptsMorph undrop / redrop\r\n\r\nScriptsMorph.prototype.undrop = function () {\r\n    var myself = this;\r\n    if (this.isAnimating) {return; }\r\n    if (!this.dropRecord || !this.dropRecord.lastRecord) {return; }\r\n    if (!this.dropRecord.situation) {\r\n        this.dropRecord.situation =\r\n            this.dropRecord.lastDroppedBlock.situation();\r\n    }\r\n    this.isAnimating = true;\r\n    this.dropRecord.lastDroppedBlock.slideBackTo(\r\n        this.dropRecord.lastOrigin,\r\n        null,\r\n        this.recoverLastDrop(),\r\n        function () {\r\n            myself.updateToolbar();\r\n            myself.isAnimating = false;\r\n        }\r\n    );\r\n    this.dropRecord = this.dropRecord.lastRecord;\r\n};\r\n\r\nScriptsMorph.prototype.redrop = function () {\r\n    var myself = this;\r\n    if (this.isAnimating) {return; }\r\n    if (!this.dropRecord || !this.dropRecord.nextRecord) {return; }\r\n    this.dropRecord = this.dropRecord.nextRecord;\r\n    if (this.dropRecord.action === 'delete') {\r\n        this.recoverLastDrop(true);\r\n        this.dropRecord.lastDroppedBlock.destroy();\r\n        this.updateToolbar();\r\n    } else {\r\n        this.isAnimating = true;\r\n        this.dropRecord.lastDroppedBlock.slideBackTo(\r\n            this.dropRecord.situation,\r\n            null,\r\n            this.recoverLastDrop(true),\r\n            function () {\r\n                myself.updateToolbar();\r\n                myself.isAnimating = false;\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\nScriptsMorph.prototype.recoverLastDrop = function (forRedrop) {\r\n    // retrieve the block last touched by the user and answer a function\r\n    // to be called after the animation that moves it back right before\r\n    // dropping it into its former situation\r\n    var rec = this.dropRecord,\r\n        dropped,\r\n        onBeforeDrop,\r\n        parent;\r\n\r\n    if (!rec || !rec.lastDroppedBlock) {\r\n        throw new Error('nothing to undrop');\r\n    }\r\n    dropped = rec.lastDroppedBlock;\r\n    parent = dropped.parent;\r\n    if (dropped instanceof CommandBlockMorph) {\r\n        if (rec.lastNextBlock) {\r\n            if (rec.action === 'delete') {\r\n                if (forRedrop) {\r\n                    this.add(rec.lastNextBlock);\r\n                }\r\n            } else {\r\n                this.add(rec.lastNextBlock);\r\n            }\r\n        }\r\n        if (rec.lastDropTarget) {\r\n            if (rec.lastDropTarget.loc === 'bottom') {\r\n                if (rec.lastDropTarget.type === 'slot') {\r\n                    if (rec.lastNextBlock) {\r\n                        rec.lastDropTarget.element.nestedBlock(\r\n                            rec.lastNextBlock\r\n                        );\r\n                    }\r\n                } else { // 'block'\r\n                    if (rec.lastNextBlock) {\r\n                        rec.lastDropTarget.element.nextBlock(\r\n                            rec.lastNextBlock\r\n                        );\r\n                    }\r\n                }\r\n            } else if (rec.lastDropTarget.loc === 'top') {\r\n                this.add(rec.lastDropTarget.element);\r\n            } else if (rec.lastDropTarget.loc === 'wrap') {\r\n                var cslot = detect( // could be cached...\r\n                    rec.lastDroppedBlock.inputs(), // ...although these are\r\n                    function (each) {return each instanceof CSlotMorph; }\r\n                );\r\n                if (rec.lastWrapParent instanceof CommandBlockMorph) {\r\n                    if (forRedrop) {\r\n                        onBeforeDrop = function () {\r\n                            cslot.nestedBlock(rec.lastDropTarget.element);\r\n                        };\r\n                    } else {\r\n                        rec.lastWrapParent.nextBlock(\r\n                            rec.lastDropTarget.element\r\n                        );\r\n                    }\r\n                } else if (rec.lastWrapParent instanceof CommandSlotMorph) {\r\n                    if (forRedrop) {\r\n                        onBeforeDrop = function () {\r\n                            cslot.nestedBlock(rec.lastDropTarget.element);\r\n                        };\r\n                    } else {\r\n                        rec.lastWrapParent.nestedBlock(\r\n                            rec.lastDropTarget.element\r\n                        );\r\n                    }\r\n                } else {\r\n                    this.add(rec.lastDropTarget.element);\r\n                }\r\n\r\n                // fix zebra coloring.\r\n                // this could be generalized into the fixBlockColor mechanism\r\n                rec.lastDropTarget.element.blockSequence().forEach(\r\n                    function (cmd) {cmd.fixBlockColor(); }\r\n                );\r\n                cslot.fixLayout();\r\n            }\r\n        }\r\n    } else if (dropped instanceof ReporterBlockMorph) {\r\n        if (rec.lastDropTarget) {\r\n            rec.lastDropTarget.replaceInput(\r\n                rec.lastDroppedBlock,\r\n                rec.lastReplacedInput\r\n            );\r\n            rec.lastDropTarget.fixBlockColor(null, true);\r\n            if (rec.lastPreservedBlocks) {\r\n                rec.lastPreservedBlocks.forEach(function (morph) {\r\n                    morph.destroy();\r\n                });\r\n            }\r\n        }\r\n    } else if (dropped instanceof CommentMorph) {\r\n        if (forRedrop && rec.lastDropTarget) {\r\n            onBeforeDrop = function () {\r\n                rec.lastDropTarget.element.comment = dropped;\r\n                dropped.block = rec.lastDropTarget.element;\r\n                dropped.align();\r\n            };\r\n        }\r\n    } else {\r\n        throw new Error('unsupported action for ' + dropped);\r\n    }\r\n    this.clearDropInfo();\r\n    dropped.prepareToBeGrabbed(this.world().hand);\r\n    if (dropped instanceof CommentMorph) {\r\n        dropped.removeShadow();\r\n    }\r\n    this.add(dropped);\r\n    parent.reactToGrabOf(dropped);\r\n    if (dropped instanceof ReporterBlockMorph && parent instanceof BlockMorph) {\r\n        parent.changed();\r\n    }\r\n    if (rec.action === 'delete') {\r\n        if (forRedrop && rec.lastNextBlock) {\r\n            if (parent instanceof CommandBlockMorph) {\r\n                parent.nextBlock(rec.lastNextBlock);\r\n            } else if (parent instanceof CommandSlotMorph) {\r\n                parent.nestedBlock(rec.lastNextBlock);\r\n            }\r\n        }\r\n\r\n        // animate \"undelete\"\r\n        if (!forRedrop) {\r\n            dropped.moveBy(new Point(-100, -20));\r\n        }\r\n    }\r\n    return onBeforeDrop;\r\n};\r\n\r\nScriptsMorph.prototype.clearDropInfo = function () {\r\n    this.lastDroppedBlock = null;\r\n    this.lastReplacedInput = null;\r\n    this.lastDropTarget = null;\r\n    this.lastPreservedBlocks = null;\r\n    this.lastNextBlock = null;\r\n    this.lastWrapParent = null;\r\n};\r\n\r\nScriptsMorph.prototype.recordDrop = function (lastGrabOrigin) {\r\n    // support for \"undrop\" / \"redrop\"\r\n     var record = {\r\n        lastDroppedBlock: this.lastDroppedBlock,\r\n        lastReplacedInput: this.lastReplacedInput,\r\n        lastDropTarget: this.lastDropTarget,\r\n        lastPreservedBlocks: this.lastPreservedBlocks,\r\n        lastNextBlock: this.lastNextBlock,\r\n        lastWrapParent: this.lastWrapParent,\r\n        lastOrigin: lastGrabOrigin,\r\n        action: null,\r\n        situation: null,\r\n        lastRecord: this.dropRecord,\r\n        nextRecord: null\r\n    };\r\n    if (this.dropRecord) {\r\n        this.dropRecord.nextRecord = record;\r\n    }\r\n    this.dropRecord = record;\r\n    this.updateToolbar();\r\n};\r\n\r\nScriptsMorph.prototype.addToolbar = function () {\r\n    var toolBar = new AlignmentMorph(),\r\n    \tmyself = this,\r\n        shade = new Color(140, 140, 140);\r\n\r\n    toolBar.respectHiddens = true;\r\n    toolBar.undoButton = new PushButtonMorph(\r\n        this,\r\n        \"undrop\",\r\n        new SymbolMorph(\"turnBack\", 12)\r\n    );\r\n    toolBar.undoButton.alpha = 0.2;\r\n    toolBar.undoButton.padding = 2;\r\n    // toolBar.undoButton.hint = 'undo the last\\nblock drop\\nin this pane';\r\n    toolBar.undoButton.labelShadowColor = shade;\r\n    toolBar.undoButton.drawNew();\r\n    toolBar.undoButton.fixLayout();\r\n    toolBar.add(toolBar.undoButton);\r\n\r\n    toolBar.redoButton = new PushButtonMorph(\r\n        this,\r\n        \"redrop\",\r\n        new SymbolMorph(\"turnForward\", 12)\r\n    );\r\n    toolBar.redoButton.alpha = 0.2;\r\n    toolBar.redoButton.padding = 2;\r\n    // toolBar.redoButton.hint = 'redo the last undone\\nblock drop\\nin this pane';\r\n    toolBar.redoButton.labelShadowColor = shade;\r\n    toolBar.redoButton.drawNew();\r\n    toolBar.redoButton.fixLayout();\r\n    toolBar.add(toolBar.redoButton);\r\n\r\n    toolBar.keyboardButton = new ToggleButtonMorph(\r\n    \tnull, // colors\r\n        this, // target\r\n        \"toggleKeyboardEntry\",\r\n        [\r\n            new SymbolMorph('keyboard', 12),\r\n            new SymbolMorph('keyboardFilled', 12)\r\n        ],\r\n\t\tfunction () { // query\r\n\t\t\treturn !isNil(myself.focus);\r\n\t\t}\r\n    );\r\n    toolBar.keyboardButton.alpha = 0.2;\r\n    toolBar.keyboardButton.padding = 2;\r\n    toolBar.keyboardButton.hint = 'use the keyboard\\nto enter blocks';\r\n    //toolBar.keyboardButton.pressColor = new Color(40, 40, 40);\r\n    toolBar.keyboardButton.labelShadowColor = shade;\r\n    toolBar.keyboardButton.drawNew();\r\n    toolBar.keyboardButton.fixLayout();\r\n    toolBar.add(toolBar.keyboardButton);\r\n\r\n    return toolBar;\r\n};\r\n\r\nScriptsMorph.prototype.updateToolbar = function () {\r\n    var sf = this.parentThatIsA(ScrollFrameMorph);\r\n    if (!sf) {return; }\r\n    if (!sf.toolBar) {\r\n        sf.toolBar = this.addToolbar();\r\n        sf.add(sf.toolBar);\r\n    }\r\n    if (this.enableKeyboard) {\r\n    \tsf.toolBar.keyboardButton.show();\r\n    \tsf.toolBar.keyboardButton.refresh();\r\n    } else {\r\n        sf.toolBar.keyboardButton.hide();\r\n    }\r\n    if (this.dropRecord) {\r\n        if (this.dropRecord.lastRecord) {\r\n            if (!sf.toolBar.undoButton.isVisible) {\r\n                sf.toolBar.undoButton.show();\r\n            }\r\n        } else {\r\n            if (sf.toolBar.undoButton.isVisible) {\r\n                sf.toolBar.undoButton.hide();\r\n            }\r\n        }\r\n        if (this.dropRecord.nextRecord) {\r\n            if (!sf.toolBar.redoButton.isVisible) {\r\n                sf.toolBar.redoButton.show();\r\n                sf.toolBar.undoButton.mouseLeave();\r\n            }\r\n        } else {\r\n            if (sf.toolBar.redoButton.isVisible) {\r\n                sf.toolBar.redoButton.hide();\r\n            }\r\n        }\r\n    }\r\n\tif (detect(\r\n\t\t\tsf.toolBar.children,\r\n            function (each) {return each.isVisible; }\r\n    )) {\r\n\t    sf.toolBar.fixLayout();\r\n\t    sf.adjustToolBar();\r\n\t}\r\n};\r\n\r\n// ScriptsMorph sorting blocks and comments\r\n\r\nScriptsMorph.prototype.sortedElements = function () {\r\n    // return all scripts and unattached comments\r\n    var scripts = this.children.filter(function (each) {\r\n        return each instanceof CommentMorph ? !each.block : true;\r\n    });\r\n    scripts.sort(function (a, b) {\r\n        // make sure the prototype hat block always stays on top\r\n        return a instanceof PrototypeHatBlockMorph ? 0 : a.top() - b.top();\r\n    });\r\n    return scripts;\r\n};\r\n\r\n// ScriptsMorph blocks layout fix\r\n\r\nScriptsMorph.prototype.fixMultiArgs = function () {\r\n    var oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n    this.forAllChildren(function (morph) {\r\n        if (morph instanceof MultiArgMorph) {\r\n            morph.fixLayout();\r\n        }\r\n    });\r\n    Morph.prototype.trackChanges = oldFlag;\r\n};\r\n\r\n// ScriptsMorph drag & drop:\r\n\r\nScriptsMorph.prototype.wantsDropOf = function (aMorph) {\r\n    // override the inherited method\r\n    if (aMorph instanceof HatBlockMorph) {\r\n        return !this.rejectsHats;\r\n    }\r\n    return aMorph instanceof SyntaxElementMorph ||\r\n        aMorph instanceof CommentMorph;\r\n};\r\n\r\nScriptsMorph.prototype.reactToDropOf = function (droppedMorph, hand) {\r\n    if (droppedMorph instanceof BlockMorph ||\r\n            droppedMorph instanceof CommentMorph) {\r\n        droppedMorph.snap(hand);\r\n    }\r\n    this.adjustBounds();\r\n};\r\n\r\n// ScriptsMorph events\r\n\r\nScriptsMorph.prototype.mouseClickLeft = function (pos) {\r\n    var shiftClicked = this.world().currentKey === 16;\r\n    if (shiftClicked) {\r\n        return this.edit(pos);\r\n    }\r\n    if (this.focus) {this.focus.stopEditing(); }\r\n};\r\n\r\nScriptsMorph.prototype.selectForEdit = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        rcvr = ide ? ide.currentSprite : null;\r\n    if (rcvr && rcvr.inheritsAttribute('scripts')) {\r\n        // copy on write:\r\n        this.feedbackMorph.destroy();\r\n        rcvr.shadowAttribute('scripts');\r\n        return rcvr.scripts;\r\n    }\r\n    return this;\r\n};\r\n\r\n// ScriptsMorph keyboard support\r\n\r\nScriptsMorph.prototype.edit = function (pos) {\r\n    var target,\r\n\t\tworld = this.world();\r\n    if (this.focus) {this.focus.stopEditing(); }\r\n    world.stopEditing();\r\n    if (!ScriptsMorph.prototype.enableKeyboard) {return; }\r\n    target = this.selectForEdit(); // enable copy-on-edit\r\n    target.focus = new ScriptFocusMorph(target, target, pos);\r\n    target.focus.getFocus(world);\r\n};\r\n\r\nScriptsMorph.prototype.toggleKeyboardEntry = function () {\r\n\t// when the user clicks the keyboard button in the toolbar\r\n    var target, sorted,\r\n        world = this.world();\r\n    if (this.focus) {\r\n    \tthis.focus.stopEditing();\r\n        return;\r\n    }\r\n    world.stopEditing();\r\n    if (!ScriptsMorph.prototype.enableKeyboard) {return; }\r\n    target = this.selectForEdit(); // enable copy-on-edit\r\n    target.focus = new ScriptFocusMorph(target, target, target.position());\r\n    target.focus.getFocus(world);\r\n    sorted = target.focus.sortedScripts();\r\n    if (sorted.length) {\r\n        target.focus.element = sorted[0];\r\n        if (target.focus.element instanceof HatBlockMorph) {\r\n            target.focus.nextCommand();\r\n        }\r\n    } else {\r\n        target.focus.moveBy(new Point(50, 50));\r\n    }\r\n    target.focus.fixLayout();\r\n};\r\n\r\n// ScriptsMorph context - scripts target\r\n\r\nScriptsMorph.prototype.scriptTarget = function () {\r\n    // answer the sprite or stage that this script editor acts on,\r\n    // if the user clicks on a block.\r\n    // NOTE: since scripts can be shared by more than a single sprite\r\n    // this method only gives the desired result within the context of\r\n    // the user actively clicking on a block inside the IDE\r\n    // there is no direct relationship between a block or a scripts editor\r\n    //  and a sprite.\r\n    var editor = this.parentThatIsA(IDE_Morph);\r\n    if (editor) {\r\n        return editor.currentSprite;\r\n    }\r\n    editor = this.parentThatIsA(BlockEditorMorph);\r\n    if (editor) {\r\n        return editor.target;\r\n    }\r\n    throw new Error('script target bannot be found for orphaned scripts');\r\n};\r\n\r\n\r\n// ArgMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a syntax element and the ancestor of all block inputs.\r\n    I am present in block labels.\r\n    Usually I am just a receptacle for inherited methods and attributes,\r\n    however, if my 'type' attribute is set to one of the following\r\n    values, I act as an iconic slot myself:\r\n\r\n        'list'    - a list symbol\r\n*/\r\n\r\n// ArgMorph inherits from SyntaxElementMorph:\r\n\r\nArgMorph.prototype = new SyntaxElementMorph();\r\nArgMorph.prototype.constructor = ArgMorph;\r\nArgMorph.uber = SyntaxElementMorph.prototype;\r\n\r\n// ArgMorph instance creation:\r\n\r\nfunction ArgMorph(type) {\r\n    this.init(type);\r\n}\r\n\r\nArgMorph.prototype.init = function (type, silently) {\r\n    this.type = type || null;\r\n    this.isHole = false;\r\n    ArgMorph.uber.init.call(this, silently);\r\n    this.color = new Color(0, 17, 173);\r\n    this.setExtent(new Point(50, 50), silently);\r\n};\r\n\r\n// ArgMorph preferences settings:\r\n\r\nArgMorph.prototype.executeOnSliderEdit = false;\r\n\r\n// ArgMorph events:\r\n\r\nArgMorph.prototype.reactToSliderEdit = function () {\r\n/*\r\n    directly execute the stack of blocks I'm part of if my\r\n    \"executeOnSliderEdit\" setting is turned on, obeying the stage's\r\n    thread safety setting. This feature allows for \"Bret Victor\" style\r\n    interactive coding.\r\n*/\r\n    var block, top, receiver, stage;\r\n    if (!this.executeOnSliderEdit) {return; }\r\n    block = this.parentThatIsA(BlockMorph);\r\n    if (block) {\r\n        top = block.topBlock();\r\n        receiver = top.scriptTarget();\r\n        if (top instanceof PrototypeHatBlockMorph) {\r\n            return;\r\n        }\r\n        if (receiver) {\r\n            stage = receiver.parentThatIsA(StageMorph);\r\n            if (stage && (stage.isThreadSafe ||\r\n                    Process.prototype.enableSingleStepping)) {\r\n                stage.threads.startProcess(top, receiver, stage.isThreadSafe);\r\n            } else {\r\n                top.mouseClickLeft();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// ArgMorph drag & drop: for demo puposes only\r\n\r\nArgMorph.prototype.justDropped = function () {\r\n    if (!(this instanceof CommandSlotMorph)) {\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\n// ArgMorph spec extrapolation (for demo purposes)\r\n\r\nArgMorph.prototype.getSpec = function () {\r\n    return '%s'; // default\r\n};\r\n\r\n// ArgMorph drawing\r\n\r\nArgMorph.prototype.drawNew = function () {\r\n    if (this.type === 'list') {\r\n        this.image = this.listIcon();\r\n        this.silentSetExtent(new Point(\r\n            this.image.width,\r\n            this.image.height\r\n        ));\r\n    } else if (this.type === 'object') {\r\n        this.image = this.objectIcon();\r\n        this.silentSetExtent(new Point(\r\n            this.image.width,\r\n            this.image.height\r\n        ));\r\n    } else {\r\n        ArgMorph.uber.drawNew.call(this);\r\n    }\r\n};\r\n\r\nArgMorph.prototype.listIcon = function () {\r\n    var frame = new Morph(),\r\n        first = new CellMorph(),\r\n        second = new CellMorph(),\r\n        source,\r\n        icon,\r\n        context,\r\n        ratio;\r\n\r\n    frame.color = new Color(255, 255, 255);\r\n    second.setPosition(first.bottomLeft().add(new Point(\r\n        0,\r\n        this.fontSize / 3\r\n    )));\r\n    first.add(second);\r\n    first.setPosition(frame.position().add(this.fontSize));\r\n    frame.add(first);\r\n    frame.bounds.corner = second.bounds.corner.add(this.fontSize);\r\n    frame.drawNew();\r\n    source = frame.fullImage();\r\n    ratio = (this.fontSize + this.edge) / source.height;\r\n    icon = newCanvas(new Point(\r\n        Math.ceil(source.width * ratio) + 1,\r\n        Math.ceil(source.height * ratio) + 1\r\n    ));\r\n    context = icon.getContext('2d');\r\n    context.fillStyle = 'black';\r\n    context.fillRect(0, 0, icon.width, icon.height);\r\n    context.scale(ratio, ratio);\r\n    context.drawImage(source, 1 / ratio, 1 / ratio);\r\n    return icon;\r\n};\r\n\r\nArgMorph.prototype.objectIcon = function () {\r\n    return this.labelPart('%turtle').image;\r\n};\r\n\r\n// ArgMorph evaluation\r\n\r\nArgMorph.prototype.isEmptySlot = function () {\r\n    return this.type !== null;\r\n};\r\n\r\n// CommandSlotMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a CommandBlock-shaped input slot. I can nest command blocks\r\n    and also accept    reporters (containing reified scripts).\r\n\r\n    my most important accessor is\r\n\r\n    nestedBlock()    - answer the command block I encompass, if any\r\n\r\n    My command spec is %cmd\r\n\r\n    evaluate() returns my nested block or null\r\n*/\r\n\r\n// CommandSlotMorph inherits from ArgMorph:\r\n\r\nCommandSlotMorph.prototype = new ArgMorph();\r\nCommandSlotMorph.prototype.constructor = CommandSlotMorph;\r\nCommandSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// CommandSlotMorph instance creation:\r\n\r\nfunction CommandSlotMorph() {\r\n    this.init();\r\n}\r\n\r\nCommandSlotMorph.prototype.init = function (silently) {\r\n    CommandSlotMorph.uber.init.call(this, null, true); // silently\r\n    this.color = new Color(0, 17, 173);\r\n    this.setExtent(\r\n        new Point(230, this.corner * 4 + this.cSlotPadding),\r\n        silently\r\n    );\r\n};\r\n\r\nCommandSlotMorph.prototype.getSpec = function () {\r\n    return '%cmd';\r\n};\r\n\r\n// CommandSlotMorph enumerating:\r\n\r\nCommandSlotMorph.prototype.topBlock = function () {\r\n    if (this.parent.topBlock) {\r\n        return this.parent.topBlock();\r\n    }\r\n    return this.nestedBlock();\r\n};\r\n\r\n// CommandSlotMorph nesting:\r\n\r\nCommandSlotMorph.prototype.nestedBlock = function (block) {\r\n    if (block) {\r\n        var nb = this.nestedBlock();\r\n        this.add(block);\r\n        if (nb) {\r\n            block.bottomBlock().nextBlock(nb);\r\n        }\r\n        this.fixLayout();\r\n    } else {\r\n        return detect(\r\n            this.children,\r\n            function (child) {\r\n                return child instanceof CommandBlockMorph;\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\n// CommandSlotMorph attach targets:\r\n\r\nCommandSlotMorph.prototype.slotAttachPoint = function () {\r\n    return new Point(\r\n        this.dentCenter(),\r\n        this.top() + this.corner * 2\r\n    );\r\n};\r\n\r\nCommandSlotMorph.prototype.dentLeft = function () {\r\n    return this.left()\r\n        + this.corner\r\n        + this.inset * 2;\r\n};\r\n\r\nCommandSlotMorph.prototype.dentCenter = function () {\r\n    return this.dentLeft()\r\n        + this.corner\r\n        + (this.dent * 0.5);\r\n};\r\n\r\nCommandSlotMorph.prototype.attachTargets = function () {\r\n    var answer = [];\r\n    answer.push({\r\n        point: this.slotAttachPoint(),\r\n        element: this,\r\n        loc: 'bottom',\r\n        type: 'slot'\r\n    });\r\n    return answer;\r\n};\r\n\r\n// CommandSlotMorph layout:\r\n\r\nCommandSlotMorph.prototype.fixLayout = function () {\r\n    var nb = this.nestedBlock();\r\n    if (this.parent) {\r\n        if (!this.color.eq(this.parent.color)) {\r\n            this.setColor(this.parent.color);\r\n        }\r\n    }\r\n    if (nb) {\r\n        nb.setPosition(\r\n            new Point(\r\n                this.left() + this.edge + this.rfBorder,\r\n                this.top() + this.edge + this.rfBorder\r\n            )\r\n        );\r\n        this.setWidth(nb.fullBounds().width()\r\n            + (this.edge + this.rfBorder) * 2\r\n            );\r\n        this.setHeight(nb.fullBounds().height()\r\n            + this.edge + (this.rfBorder * 2) - (this.corner - this.edge)\r\n            );\r\n    } else {\r\n        this.setHeight(this.corner * 4);\r\n        this.setWidth(\r\n            this.corner * 4\r\n                + this.inset\r\n                + this.dent\r\n        );\r\n    }\r\n    if (this.parent.fixLayout) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\n// CommandSlotMorph evaluating:\r\n\r\nCommandSlotMorph.prototype.evaluate = function () {\r\n    return this.nestedBlock();\r\n};\r\n\r\nCommandSlotMorph.prototype.isEmptySlot = function () {\r\n    return !this.isStatic && (this.nestedBlock() === null);\r\n};\r\n\r\n// CommandSlotMorph context menu ops\r\n\r\nCommandSlotMorph.prototype.attach = function () {\r\n    // for context menu demo and testing purposes\r\n    // override inherited version to adjust new owner's layout\r\n    var choices = this.overlappedMorphs(),\r\n        menu = new MenuMorph(this, 'choose new parent:'),\r\n        myself = this;\r\n\r\n    choices.forEach(function (each) {\r\n        menu.addItem(each.toString().slice(0, 50), function () {\r\n            each.add(myself);\r\n            myself.isDraggable = false;\r\n            if (each.fixLayout) {\r\n                each.fixLayout();\r\n            }\r\n        });\r\n    });\r\n    if (choices.length > 0) {\r\n        menu.popUpAtHand(this.world());\r\n    }\r\n};\r\n\r\n// CommandSlotMorph drawing:\r\n\r\nCommandSlotMorph.prototype.drawNew = function () {\r\n    var context;\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n    context.fillRect(0, 0, this.width(), this.height());\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.rfColor.toString();\r\n    this.drawFlat(context);\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    this.drawEdges(context);\r\n};\r\n\r\nCommandSlotMorph.prototype.drawFlat = function (context) {\r\n    var isFilled = this.nestedBlock() !== null,\r\n        ins = (isFilled ? this.inset : this.inset / 2),\r\n        dent = (isFilled ? this.dent : this.dent / 2),\r\n        indent = this.corner * 2 + ins,\r\n        edge = this.edge,\r\n        rf = (isFilled ? this.rfBorder : 0),\r\n        y = this.height() - this.corner - edge;\r\n\r\n    context.beginPath();\r\n\r\n    // top left:\r\n    context.arc(\r\n        this.corner + edge,\r\n        this.corner + edge,\r\n        this.corner,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // dent:\r\n    context.lineTo(this.corner + ins + edge + rf * 2, edge);\r\n    context.lineTo(indent + edge + rf * 2, this.corner + edge);\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2),\r\n        this.corner + edge\r\n    );\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2) + this.corner,\r\n        edge\r\n    );\r\n    context.lineTo(this.width() - this.corner - edge, edge);\r\n\r\n    // top right:\r\n    context.arc(\r\n        this.width() - this.corner - edge,\r\n        this.corner + edge,\r\n        this.corner,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        this.width() - this.corner - edge,\r\n        y,\r\n        this.corner,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        this.corner + edge,\r\n        y,\r\n        this.corner,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n};\r\n\r\nCommandSlotMorph.prototype.drawEdges = function (context) {\r\n    var isFilled = this.nestedBlock() !== null,\r\n        ins = (isFilled ? this.inset : this.inset / 2),\r\n        dent = (isFilled ? this.dent : this.dent / 2),\r\n        indent = this.corner * 2 + ins,\r\n        edge = this.edge,\r\n        rf = (isFilled ? this.rfBorder : 0),\r\n        shift = this.edge * 0.5,\r\n        gradient,\r\n        upperGradient,\r\n        lowerGradient,\r\n        rightGradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n\r\n    // bright:\r\n    // bottom horizontal line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.height(),\r\n        0,\r\n        this.height() - this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrBright);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.corner + edge, this.height() - shift);\r\n    context.lineTo(\r\n        this.width() - this.corner - edge,\r\n        this.height() - shift\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom right corner\r\n    gradient = context.createRadialGradient(\r\n        this.width() - (this.corner + edge),\r\n        this.height() - (this.corner + edge),\r\n        this.corner,\r\n        this.width() - (this.corner + edge),\r\n        this.height() - (this.corner + edge),\r\n        this.corner + edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        this.width() - (this.corner + edge),\r\n        this.height() - (this.corner + edge),\r\n        this.corner + shift,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // right vertical line\r\n    gradient = context.createLinearGradient(\r\n        this.width(),\r\n        0,\r\n        this.width() - this.edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrBright);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        this.width() - shift,\r\n        this.height() - this.corner - this.edge\r\n    );\r\n    context.lineTo(this.width() - shift, edge + this.corner);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.rfColor.darker(80).toString();\r\n\r\n    // left vertical side\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, edge + this.corner);\r\n    context.lineTo(shift, this.height() - edge - this.corner);\r\n    context.stroke();\r\n\r\n    // upper left corner\r\n    gradient = context.createRadialGradient(\r\n        this.corner + edge,\r\n        this.corner + edge,\r\n        this.corner,\r\n        this.corner + edge,\r\n        this.corner + edge,\r\n        this.corner + edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        this.corner + edge,\r\n        this.corner + edge,\r\n        this.corner + shift,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // upper edge (left side)\r\n    upperGradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    upperGradient.addColorStop(0, this.cachedClr);\r\n    upperGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(this.corner + edge, shift);\r\n    context.lineTo(\r\n        this.corner + ins + edge + rf * 2 - shift,\r\n        shift\r\n    );\r\n    context.stroke();\r\n\r\n    // dent bottom\r\n    lowerGradient = context.createLinearGradient(\r\n        0,\r\n        this.corner,\r\n        0,\r\n        this.corner + edge\r\n    );\r\n    lowerGradient.addColorStop(0, this.cachedClr);\r\n    lowerGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = lowerGradient;\r\n    context.beginPath();\r\n    context.moveTo(indent + edge + rf * 2 + shift, this.corner + shift);\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2),\r\n        this.corner + shift\r\n    );\r\n    context.stroke();\r\n\r\n    // dent right edge\r\n    rightGradient = context.createLinearGradient(\r\n        indent + edge  + rf * 2 + (dent - rf * 2) - shift,\r\n        this.corner,\r\n        indent + edge  + rf * 2 + (dent - rf * 2) + shift * 0.7,\r\n        this.corner + shift + shift * 0.7\r\n    );\r\n    rightGradient.addColorStop(0, this.cachedClr);\r\n    rightGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = rightGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2),\r\n        this.corner + shift\r\n    );\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2) + this.corner,\r\n        shift\r\n    );\r\n    context.stroke();\r\n\r\n    // upper edge (right side)\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2) + this.corner,\r\n        shift\r\n    );\r\n    context.lineTo(this.width() - this.corner - edge, shift);\r\n    context.stroke();\r\n};\r\n\r\n// RingCommandSlotMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a CommandBlock-shaped input slot for use in RingMorphs.\r\n    I can only nest command blocks, not reporters.\r\n\r\n    My command spec is %rc\r\n\r\n    evaluate() returns my nested block or null\r\n    (inherited from CommandSlotMorph)\r\n*/\r\n\r\n// RingCommandSlotMorph inherits from CommandSlotMorph:\r\n\r\nRingCommandSlotMorph.prototype = new CommandSlotMorph();\r\nRingCommandSlotMorph.prototype.constructor = RingCommandSlotMorph;\r\nRingCommandSlotMorph.uber = CommandSlotMorph.prototype;\r\n\r\n// RingCommandSlotMorph preferences settings\r\n\r\nRingCommandSlotMorph.prototype.rfBorder = 0;\r\nRingCommandSlotMorph.prototype.edge = RingMorph.prototype.edge;\r\n\r\n// RingCommandSlotMorph instance creation:\r\n\r\nfunction RingCommandSlotMorph() {\r\n    this.init();\r\n}\r\n\r\nRingCommandSlotMorph.prototype.init = function (silently) {\r\n    RingCommandSlotMorph.uber.init.call(this, silently);\r\n    this.isHole = true;\r\n    this.noticesTransparentClick = true;\r\n    this.color = new Color(0, 17, 173);\r\n    this.alpha = RingMorph.prototype.alpha;\r\n    this.contrast = RingMorph.prototype.contrast;\r\n};\r\n\r\nRingCommandSlotMorph.prototype.getSpec = function () {\r\n    return '%rc';\r\n};\r\n\r\n// RingCommandSlotMorph drawing:\r\n\r\nRingCommandSlotMorph.prototype.drawNew = function () {\r\n    var context;\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n\r\n    // draw the 'flat' shape:\r\n    this.drawFlat(context);\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    this.drawEdges(context);\r\n};\r\n\r\nRingCommandSlotMorph.prototype.drawFlat = function (context) {\r\n    var isFilled = this.nestedBlock() !== null,\r\n        ins = (isFilled ? this.inset : this.inset / 2),\r\n        dent = (isFilled ? this.dent : this.dent / 2),\r\n        indent = this.corner * 2 + ins,\r\n        edge = this.edge,\r\n        w = this.width(),\r\n        h = this.height(),\r\n        rf = (isFilled ? this.rfBorder : 0),\r\n        y = h - this.corner - edge;\r\n\r\n    // top half:\r\n\r\n    context.beginPath();\r\n    context.moveTo(0, h / 2);\r\n    context.lineTo(edge, h / 2);\r\n\r\n    // top left:\r\n    context.arc(\r\n        this.corner + edge,\r\n        this.corner + edge,\r\n        this.corner,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // dent:\r\n    context.lineTo(this.corner + ins + edge + rf * 2, edge);\r\n    context.lineTo(indent + edge + rf * 2, this.corner + edge);\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2),\r\n        this.corner + edge\r\n    );\r\n    context.lineTo(\r\n        indent + edge  + rf * 2 + (dent - rf * 2) + this.corner,\r\n        edge\r\n    );\r\n    context.lineTo(this.width() - this.corner - edge, edge);\r\n\r\n    // top right:\r\n    context.arc(\r\n        w - this.corner - edge,\r\n        this.corner + edge,\r\n        this.corner,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    context.lineTo(w - this.edge, h / 2);\r\n    context.lineTo(w, h / 2);\r\n    context.lineTo(w, 0);\r\n    context.lineTo(0, 0);\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    // bottom half:\r\n    context.beginPath();\r\n    context.moveTo(w, h / 2);\r\n    context.lineTo(w - edge, h / 2);\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        this.width() - this.corner - edge,\r\n        y,\r\n        this.corner,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        this.corner + edge,\r\n        y,\r\n        this.corner,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n\r\n    context.lineTo(edge, h / 2);\r\n    context.lineTo(0, h / 2);\r\n    context.lineTo(0, h);\r\n    context.lineTo(w, h);\r\n    context.closePath();\r\n    context.fill();\r\n\r\n};\r\n\r\n// CSlotMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a C-shaped input slot. I can nest command blocks and also accept\r\n    reporters (containing reified scripts).\r\n\r\n    my most important accessor is\r\n\r\n    nestedBlock()    - the command block I encompass, if any (inherited)\r\n\r\n    My command spec is %c\r\n\r\n    evaluate() returns my nested block or null\r\n*/\r\n\r\n// CSlotMorph inherits from CommandSlotMorph:\r\n\r\nCSlotMorph.prototype = new CommandSlotMorph();\r\nCSlotMorph.prototype.constructor = CSlotMorph;\r\nCSlotMorph.uber = CommandSlotMorph.prototype;\r\n\r\n// CSlotMorph instance creation:\r\n\r\nfunction CSlotMorph() {\r\n    this.init();\r\n}\r\n\r\nCSlotMorph.prototype.init = function (silently) {\r\n    CommandSlotMorph.uber.init.call(this, null, true); // silently\r\n    this.isHole = true;\r\n    this.isLambda = false; // see Process.prototype.evaluateInput\r\n    this.color = new Color(0, 17, 173);\r\n    this.setExtent(\r\n        new Point(230, this.corner * 4 + this.cSlotPadding),\r\n        silently\r\n    );\r\n};\r\n\r\nCSlotMorph.prototype.getSpec = function () {\r\n    return '%c';\r\n};\r\n\r\nCSlotMorph.prototype.mappedCode = function (definitions) {\r\n    var code = StageMorph.prototype.codeMappings.reify || '<#1>',\r\n        codeLines = code.split('\\n'),\r\n        nested = this.nestedBlock(),\r\n        part = nested ? nested.mappedCode(definitions) : '',\r\n        partLines = (part.toString()).split('\\n'),\r\n        rx = new RegExp('<#1>', 'g');\r\n\r\n    codeLines.forEach(function (codeLine, idx) {\r\n        var prefix = '',\r\n            indent;\r\n        if (codeLine.trimLeft().indexOf('<#1>') === 0) {\r\n            indent = codeLine.indexOf('<#1>');\r\n            prefix = codeLine.slice(0, indent);\r\n        }\r\n        codeLines[idx] = codeLine.replace(\r\n            new RegExp('<#1>'),\r\n            partLines.join('\\n' + prefix)\r\n        );\r\n        codeLines[idx] = codeLines[idx].replace(rx, partLines.join('\\n'));\r\n    });\r\n\r\n    return codeLines.join('\\n');\r\n};\r\n\r\n\r\n// CSlotMorph layout:\r\n\r\nCSlotMorph.prototype.fixLayout = function () {\r\n    var nb = this.nestedBlock();\r\n    if (nb) {\r\n        nb.setPosition(\r\n            new Point(\r\n                this.left() + this.inset,\r\n                this.top() + this.corner\r\n            )\r\n        );\r\n        this.setHeight(nb.fullBounds().height() + this.corner);\r\n        this.setWidth(nb.fullBounds().width() + (this.cSlotPadding * 2));\r\n    } else {\r\n        this.setHeight(this.corner * 4  + this.cSlotPadding); // default\r\n        this.setWidth(\r\n            this.corner * 4\r\n                + (this.inset * 2)\r\n                + this.dent\r\n                + (this.cSlotPadding * 2)\r\n        ); // default\r\n    }\r\n    if (this.parent.fixLayout) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\n// CSlotMorph drawing:\r\n\r\nCSlotMorph.prototype.drawNew = function () {\r\n    var context;\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n\r\n    // draw the 'flat' shape:\r\n    this.drawFlat(context);\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    this.drawTopRightEdge(context);\r\n    this.drawTopEdge(context, this.inset, this.corner);\r\n    this.drawTopLeftEdge(context);\r\n    this.drawBottomEdge(context);\r\n    this.drawRightEdge(context);\r\n};\r\n\r\nCSlotMorph.prototype.drawFlat = function (context) {\r\n    context.beginPath();\r\n\r\n    // top line:\r\n    context.moveTo(0, 0);\r\n    context.lineTo(this.width(), 0);\r\n\r\n    // top right:\r\n    context.arc(\r\n        this.width() - this.corner,\r\n        0,\r\n        this.corner,\r\n        radians(90),\r\n        radians(0),\r\n        true\r\n    );\r\n\r\n    // jigsaw shape:\r\n    context.lineTo(this.width() - this.corner, this.corner);\r\n    context.lineTo(\r\n        (this.inset * 2) + (this.corner * 3) + this.dent,\r\n        this.corner\r\n    );\r\n    context.lineTo(\r\n        (this.inset * 2) + (this.corner * 2) + this.dent,\r\n        this.corner * 2\r\n    );\r\n    context.lineTo(\r\n        (this.inset * 2) + (this.corner * 2),\r\n        this.corner * 2\r\n    );\r\n    context.lineTo(\r\n        (this.inset * 2) + this.corner,\r\n        this.corner\r\n    );\r\n    context.lineTo(\r\n        this.inset + this.corner,\r\n        this.corner\r\n    );\r\n    context.arc(\r\n        this.inset + this.corner,\r\n        this.corner * 2,\r\n        this.corner,\r\n        radians(270),\r\n        radians(180),\r\n        true\r\n    );\r\n\r\n    // bottom:\r\n    context.lineTo(\r\n        this.inset,\r\n        this.height() - (this.corner * 2)\r\n    );\r\n    context.arc(\r\n        this.inset + this.corner,\r\n        this.height() - (this.corner * 2),\r\n        this.corner,\r\n        radians(180),\r\n        radians(90),\r\n        true\r\n    );\r\n    context.lineTo(\r\n        this.width() - this.corner,\r\n        this.height() - this.corner\r\n    );\r\n    context.arc(\r\n        this.width() - this.corner,\r\n        this.height(),\r\n        this.corner,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n    context.lineTo(0, this.height());\r\n\r\n    // fill:\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nCSlotMorph.prototype.drawTopRightEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        x = this.width() - this.corner,\r\n        y = 0,\r\n        gradient;\r\n\r\n    gradient = context.createRadialGradient(\r\n        x,\r\n        y,\r\n        this.corner,\r\n        x,\r\n        y,\r\n        this.corner - this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.arc(\r\n        x,\r\n        y,\r\n        this.corner - shift,\r\n        radians(90),\r\n        radians(0),\r\n        true\r\n    );\r\n    context.stroke();\r\n};\r\n\r\nCSlotMorph.prototype.drawTopEdge = function (context, x, y) {\r\n    var shift = this.edge * 0.5,\r\n        indent = x + this.corner * 2 + this.inset,\r\n        upperGradient,\r\n        lowerGradient,\r\n        rightGradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    upperGradient = context.createLinearGradient(\r\n        0,\r\n        y - this.edge,\r\n        0,\r\n        y\r\n    );\r\n    upperGradient.addColorStop(0, this.cachedClr);\r\n    upperGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(x + this.corner, y - shift);\r\n    context.lineTo(x + this.corner + this.inset - shift, y - shift);\r\n    context.stroke();\r\n\r\n    lowerGradient = context.createLinearGradient(\r\n        0,\r\n        y + this.corner - this.edge,\r\n        0,\r\n        y + this.corner\r\n    );\r\n    lowerGradient.addColorStop(0, this.cachedClr);\r\n    lowerGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.strokeStyle = lowerGradient;\r\n    context.beginPath();\r\n    context.moveTo(indent + shift, y + this.corner - shift);\r\n    context.lineTo(indent + this.dent, y + this.corner - shift);\r\n    context.stroke();\r\n\r\n    rightGradient = context.createLinearGradient(\r\n        (x + this.inset + (this.corner * 2) + this.dent) - shift,\r\n        (y + this.corner - shift) - shift,\r\n        (x + this.inset + (this.corner * 2) + this.dent) + (shift * 0.7),\r\n        (y + this.corner - shift) + (shift * 0.7)\r\n    );\r\n    rightGradient.addColorStop(0, this.cachedClr);\r\n    rightGradient.addColorStop(1, this.cachedClrDark);\r\n\r\n\r\n    context.strokeStyle = rightGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        x + this.inset + (this.corner * 2) + this.dent,\r\n        y + this.corner - shift\r\n    );\r\n    context.lineTo(\r\n        x + this.corner * 3 + this.inset + this.dent,\r\n        y - shift\r\n    );\r\n    context.stroke();\r\n\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        x + this.corner * 3 + this.inset + this.dent,\r\n        y - shift\r\n    );\r\n    context.lineTo(this.width() - this.corner, y - shift);\r\n    context.stroke();\r\n};\r\n\r\nCSlotMorph.prototype.drawTopLeftEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient;\r\n\r\n    gradient = context.createRadialGradient(\r\n        this.corner + this.inset,\r\n        this.corner * 2,\r\n        this.corner,\r\n        this.corner + this.inset,\r\n        this.corner * 2,\r\n        this.corner + this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.arc(\r\n        this.corner + this.inset,\r\n        this.corner * 2,\r\n        this.corner + shift,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.stroke();\r\n};\r\n\r\nCSlotMorph.prototype.drawRightEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        x = this.inset,\r\n        gradient;\r\n\r\n    gradient = context.createLinearGradient(x - this.edge, 0, x, 0);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(x - shift, this.corner * 2);\r\n    context.lineTo(x - shift, this.height() - this.corner * 2);\r\n    context.stroke();\r\n};\r\n\r\nCSlotMorph.prototype.drawBottomEdge = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient,\r\n        upperGradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    upperGradient = context.createRadialGradient(\r\n        this.corner + this.inset,\r\n        this.height() - (this.corner * 2),\r\n        this.corner, /*- this.edge*/ // uncomment for half-tone\r\n        this.corner + this.inset,\r\n        this.height() - (this.corner * 2),\r\n        this.corner + this.edge\r\n    );\r\n    upperGradient.addColorStop(0, this.cachedClrBright);\r\n    upperGradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = upperGradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        this.corner + this.inset,\r\n        this.height() - (this.corner * 2),\r\n        this.corner + shift,\r\n        radians(180),\r\n        radians(90),\r\n        true\r\n    );\r\n    context.stroke();\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.height() - this.corner,\r\n        0,\r\n        this.height() - this.corner + this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(\r\n        this.inset + this.corner,\r\n        this.height() - this.corner + shift\r\n    );\r\n    context.lineTo(\r\n        this.width() - this.corner,\r\n        this.height() - this.corner + shift\r\n    );\r\n\r\n    context.stroke();\r\n};\r\n\r\n// InputSlotMorph //////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an editable text input slot. I can be either rectangular or\r\n    rounded, and can have an optional drop-down menu. If I'm set to\r\n    read-only I must have a drop-down menu and will assume a darker\r\n    shade of my parent's color.\r\n\r\n    my most important public attributes and accessors are:\r\n\r\n    setContents(str/float)    - display the argument (string or float)\r\n    contents().text            - get the displayed string\r\n    choices                    - a key/value list for my optional drop-down\r\n    isReadOnly                - governs whether I am editable or not\r\n    isNumeric                - governs my outer shape (round or rect)\r\n\r\n    my block specs are:\r\n\r\n    %s        - string input, rectangular\r\n    %n        - numerical input, semi-circular vertical edges\r\n    %anyUE    - any unevaluated\r\n\r\n    evaluate() returns my displayed string, cast to float if I'm numerical\r\n\r\n    there are also a number of specialized drop-down menu presets, refer\r\n    to BlockMorph for details.\r\n*/\r\n\r\n// InputSlotMorph inherits from ArgMorph:\r\n\r\nInputSlotMorph.prototype = new ArgMorph();\r\nInputSlotMorph.prototype.constructor = InputSlotMorph;\r\nInputSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// InputSlotMorph instance creation:\r\n\r\nfunction InputSlotMorph(text, isNumeric, choiceDict, isReadOnly) {\r\n    this.init(text, isNumeric, choiceDict, isReadOnly);\r\n}\r\n\r\nInputSlotMorph.prototype.init = function (\r\n    text,\r\n    isNumeric,\r\n    choiceDict,\r\n    isReadOnly\r\n) {\r\n    var contents = new StringMorph(''),\r\n        arrow = new ArrowMorph(\r\n            'down',\r\n            0,\r\n            Math.max(Math.floor(this.fontSize / 6), 1)\r\n        );\r\n\r\n    contents.fontSize = this.fontSize;\r\n    contents.isShowingBlanks = true;\r\n    contents.drawNew();\r\n\r\n    this.isUnevaluated = false;\r\n    this.choices = choiceDict || null; // object, function or selector\r\n    this.oldContentsExtent = contents.extent();\r\n    this.isNumeric = isNumeric || false;\r\n    this.isReadOnly = isReadOnly || false;\r\n    this.minWidth = 0; // can be chaged for text-type inputs (\"landscape\")\r\n    this.constant = null;\r\n\r\n    InputSlotMorph.uber.init.call(this, null, true);\r\n    this.color = new Color(255, 255, 255);\r\n    this.add(contents);\r\n    this.add(arrow);\r\n    contents.isEditable = true;\r\n    contents.isDraggable = false;\r\n    contents.enableSelecting();\r\n    this.setContents(text);\r\n};\r\n\r\n// InputSlotMorph accessing:\r\n\r\nInputSlotMorph.prototype.getSpec = function () {\r\n    if (this.isNumeric) {\r\n        return '%n';\r\n    }\r\n    return '%s'; // default\r\n};\r\n\r\nInputSlotMorph.prototype.contents = function () {\r\n    return detect(\r\n        this.children,\r\n        function (child) {\r\n            return (child instanceof StringMorph);\r\n        }\r\n    );\r\n};\r\n\r\nInputSlotMorph.prototype.arrow = function () {\r\n    return detect(\r\n        this.children,\r\n        function (child) {\r\n            return (child instanceof ArrowMorph);\r\n        }\r\n    );\r\n};\r\n\r\nInputSlotMorph.prototype.setContents = function (aStringOrFloat) {\r\n    var cnts = this.contents(),\r\n        dta = aStringOrFloat,\r\n        isConstant = dta instanceof Array;\r\n    if (isConstant) {\r\n        dta = localize(dta[0]);\r\n        cnts.isItalic = !this.isReadOnly;\r\n    } else { // assume dta is a localizable choice if it's a key in my choices\r\n        cnts.isItalic = false;\r\n        if (!isNil(this.choices) && this.choices[dta] instanceof Array) {\r\n            return this.setContents(this.choices[dta]);\r\n        }\r\n    }\r\n    cnts.text = dta;\r\n    if (isNil(dta)) {\r\n        cnts.text = '';\r\n    } else if (dta.toString) {\r\n        cnts.text = dta.toString();\r\n    }\r\n    cnts.drawNew();\r\n\r\n    // adjust to zebra coloring:\r\n    if (this.isReadOnly && (this.parent instanceof BlockMorph)) {\r\n        this.parent.fixLabelColor();\r\n    }\r\n\r\n    // remember the constant, if any\r\n    this.constant = isConstant ? aStringOrFloat : null;\r\n};\r\n\r\nInputSlotMorph.prototype.userSetContents = function (aStringOrFloat) {\r\n    // enable copy-on-edit for inherited scripts\r\n    this.selectForEdit().setContents(aStringOrFloat);\r\n};\r\n\r\n// InputSlotMorph drop-down menu:\r\n\r\nInputSlotMorph.prototype.dropDownMenu = function (enableKeyboard) {\r\n    var menu = this.menuFromDict(this.choices, null, enableKeyboard);\r\n    if (!menu) { // has already happened\r\n        return;\r\n    }\r\n    if (menu.items.length > 0) {\r\n        if (enableKeyboard) {\r\n            menu.popup(this.world(), this.bottomLeft());\r\n            menu.getFocus();\r\n        } else {\r\n            menu.popUpAtHand(this.world());\r\n        }\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.menuFromDict = function (\r\n    choices,\r\n    noEmptyOption,\r\n    enableKeyboard)\r\n{\r\n    var key,\r\n        menu = new MenuMorph(\r\n            this.userSetContents,\r\n            null,\r\n            this,\r\n            this.fontSize\r\n        );\r\n\r\n    if (choices instanceof Function) {\r\n        choices = choices.call(this);\r\n    } else if (isString(choices)) {\r\n        choices = this[choices](enableKeyboard);\r\n        if (!choices) { // menu has already happened\r\n            return;\r\n        }\r\n    }\r\n    if (!noEmptyOption) {\r\n        menu.addItem(' ', null);\r\n    }\r\n    for (key in choices) {\r\n        if (Object.prototype.hasOwnProperty.call(choices, key)) {\r\n            if (key[0] === '~') {\r\n                menu.addLine();\r\n            // } else if (key.indexOf('_def') === 0) {\r\n            //     menu.addItem(choices[key].blockInstance(), choices[key]);\r\n            } else if (choices[key] instanceof Object &&\r\n                    !(choices[key] instanceof Array) &&\r\n                    (typeof choices[key] !== 'function')) {\r\n                menu.addMenu(key, this.menuFromDict(choices[key], true));\r\n            } else {\r\n                menu.addItem(key, choices[key]);\r\n            }\r\n        }\r\n    }\r\n    return menu;\r\n};\r\n\r\nInputSlotMorph.prototype.messagesMenu = function () {\r\n    var dict = {},\r\n        rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        myself = this,\r\n        allNames = [];\r\n\r\n    stage.children.concat(stage).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            allNames = allNames.concat(morph.allMessageNames());\r\n        }\r\n    });\r\n    allNames.forEach(function (name) {\r\n        dict[name] = name;\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n    }\r\n    dict['new...'] = function () {\r\n\r\n        new DialogBoxMorph(\r\n            myself,\r\n            myself.setContents,\r\n            myself\r\n        ).prompt(\r\n            'Message name',\r\n            null,\r\n            myself.world()\r\n        );\r\n    };\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.messagesReceivedMenu = function () {\r\n    var dict = {'any message': ['any message']},\r\n        rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        myself = this,\r\n        allNames = [];\r\n\r\n    stage.children.concat(stage).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            allNames = allNames.concat(morph.allMessageNames());\r\n        }\r\n    });\r\n    allNames.forEach(function (name) {\r\n        dict[name] = name;\r\n    });\r\n    dict['~'] = null;\r\n    dict['new...'] = function () {\r\n\r\n        new DialogBoxMorph(\r\n            myself,\r\n            myself.setContents,\r\n            myself\r\n        ).prompt(\r\n            'Message name',\r\n            null,\r\n            myself.world()\r\n        );\r\n    };\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.collidablesMenu = function () {\r\n    var dict = {\r\n            'mouse-pointer' : ['mouse-pointer'],\r\n            edge : ['edge'],\r\n            'pen trails' : ['pen trails']\r\n        },\r\n        rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        allNames = [];\r\n\r\n    stage.children.forEach(function (morph) {\r\n        if (morph instanceof SpriteMorph && !morph.isTemporary) {\r\n            if (morph.name !== rcvr.name) {\r\n                allNames = allNames.concat(morph.name);\r\n            }\r\n        }\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.distancesMenu = function () {\r\n    var dict = {\r\n            'mouse-pointer' : ['mouse-pointer']\r\n        },\r\n        rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        allNames = [];\r\n\r\n    stage.children.forEach(function (morph) {\r\n        if (morph instanceof SpriteMorph && !morph.isTemporary) {\r\n            if (morph.name !== rcvr.name) {\r\n                allNames = allNames.concat(morph.name);\r\n            }\r\n        }\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.clonablesMenu = function () {\r\n    var dict = {},\r\n        rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        allNames = [];\r\n\r\n    if (rcvr instanceof SpriteMorph) {\r\n        dict.myself = ['myself'];\r\n    }\r\n    stage.children.forEach(function (morph) {\r\n        if (morph instanceof SpriteMorph && !morph.isTemporary) {\r\n            allNames = allNames.concat(morph.name);\r\n        }\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.objectsMenu = function () {\r\n    var rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        dict = {},\r\n        allNames = [];\r\n\r\n    dict[stage.name] = stage.name;\r\n    stage.children.forEach(function (morph) {\r\n        if (morph instanceof SpriteMorph && !morph.isTemporary) {\r\n            allNames.push(morph.name);\r\n        }\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.typesMenu = function () {\r\n    var dict = {\r\n        number : ['number'],\r\n        text : ['text'],\r\n        Boolean : ['Boolean'],\r\n        list : ['list']\r\n    };\r\n    if (SpriteMorph.prototype.enableFirstClass) {\r\n        dict.sprite = ['sprite'];\r\n    }\r\n    dict.costume = ['costume'];\r\n    dict.sound = ['sound'];\r\n    dict.command = ['command'];\r\n    dict.reporter = ['reporter'];\r\n    dict.predicate = ['predicate'];\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.gettablesMenu = function () {\r\n    var dict = {\r\n        neighbors : ['neighbors'],\r\n        self : ['self'],\r\n        'other sprites' : ['other sprites'],\r\n        clones : ['clones'],\r\n        'other clones' : ['other clones']\r\n    };\r\n    if (SpriteMorph.prototype.enableNesting) {\r\n        dict.parts = ['parts'];\r\n        dict.anchor = ['anchor'];\r\n    }\r\n    dict.stage = ['stage'];\r\n    if (StageMorph.prototype.enableInheritance) {\r\n        dict.children = ['children'];\r\n        dict.parent = ['parent'];\r\n        if (this.world().isDevMode) {\r\n            dict['temporary?'] = ['temporary?'];\r\n        }\r\n    }\r\n    dict.name = ['name'];\r\n    dict.costumes = ['costumes'];\r\n    dict.sounds = ['sounds'];\r\n    dict['dangling?'] = ['dangling?'];\r\n    dict['rotation x'] = ['rotation x'];\r\n    dict['rotation y'] = ['rotation y'];\r\n    dict['center x'] = ['center x'];\r\n    dict['center y'] = ['center y'];\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.attributesMenu = function () {\r\n    var block = this.parentThatIsA(BlockMorph),\r\n        objName = block.inputs()[1].evaluate(),\r\n        rcvr = block.scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        obj,\r\n        dict = {},\r\n        varNames = [];\r\n\r\n    if (objName === stage.name) {\r\n        obj = stage;\r\n    } else {\r\n        obj = detect(\r\n            stage.children,\r\n            function (morph) {\r\n                return morph.name === objName;\r\n            }\r\n        );\r\n    }\r\n    if (!obj) {\r\n        return dict;\r\n    }\r\n    if (obj instanceof SpriteMorph) {\r\n        dict = {\r\n            'x position' : ['x position'],\r\n            'y position' : ['y position'],\r\n            'direction' : ['direction'],\r\n            'costume #' : ['costume #'],\r\n            'costume name' : ['costume name'],\r\n            'size' : ['size']\r\n        };\r\n    } else { // the stage\r\n        dict = {\r\n            'costume #' : ['costume #'],\r\n            'costume name' : ['costume name']\r\n        };\r\n    }\r\n    varNames = obj.variables.names();\r\n    if (varNames.length > 0) {\r\n        dict['~'] = null;\r\n        varNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    /*\r\n    obj.customBlocks.forEach(function (def, i) {\r\n        dict['_def' + i] = def\r\n    });\r\n    */\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.costumesMenu = function () {\r\n    var rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        dict,\r\n        allNames = [];\r\n    if (rcvr instanceof SpriteMorph) {\r\n        dict = {Turtle : ['Turtle']};\r\n    } else { // stage\r\n        dict = {Empty : ['Empty']};\r\n    }\r\n    rcvr.costumes.asArray().forEach(function (costume) {\r\n        allNames = allNames.concat(costume.name);\r\n    });\r\n    if (allNames.length > 0) {\r\n        dict['~'] = null;\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.soundsMenu = function () {\r\n    var rcvr = this.parentThatIsA(BlockMorph).scriptTarget(),\r\n        allNames = [],\r\n        dict = {};\r\n\r\n    rcvr.sounds.asArray().forEach(function (sound) {\r\n        allNames = allNames.concat(sound.name);\r\n    });\r\n    if (allNames.length > 0) {\r\n        allNames.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.shadowedVariablesMenu = function () {\r\n    var block = this.parentThatIsA(BlockMorph),\r\n        vars,\r\n        attribs,\r\n        rcvr,\r\n        dict = {};\r\n\r\n    if (!block) {return dict; }\r\n    rcvr = block.scriptTarget();\r\n    if (this.parentThatIsA(RingMorph)) {\r\n    \t// show own local vars and attributes, because this is likely to be\r\n     \t// inside TELL, ASK or OF\r\n        vars = rcvr.variables.names();\r\n        vars.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n        attribs = rcvr.attributes;\r\n        /*\r\n        if (vars.length && attribs.length) {\r\n            dict['~'] = null; // add line\r\n        }\r\n        */\r\n        attribs.forEach(function (name) {\r\n            dict[name] = [name];\r\n        });\r\n    } else if (rcvr && rcvr.exemplar) {\r\n    \t// only show shadowed vars and attributes\r\n        vars = rcvr.inheritedVariableNames(true);\r\n        vars.forEach(function (name) {\r\n            dict[name] = name;\r\n        });\r\n        attribs = rcvr.shadowedAttributes();\r\n        /*\r\n        if (vars.length && attribs.length) {\r\n            dict['~'] = null; // add line\r\n        }\r\n        */\r\n        attribs.forEach(function (name) {\r\n            dict[name] = [name];\r\n        });\r\n    }\r\n    return dict;\r\n};\r\n\r\nInputSlotMorph.prototype.pianoKeyboardMenu = function () {\r\n    var menu, block, instrument;\r\n    block = this.parentThatIsA(BlockMorph);\r\n    if (block) {\r\n        instrument = block.scriptTarget().instrument;\r\n    }\r\n    menu = new PianoMenuMorph(\r\n        this.setContents,\r\n        this,\r\n        this.fontSize,\r\n        instrument\r\n    );\r\n    menu.popup(this.world(), new Point(\r\n        this.right() - (menu.width() / 2),\r\n        this.bottom()\r\n    ));\r\n    menu.selectKey(this.evaluate());\r\n};\r\n\r\nInputSlotMorph.prototype.setChoices = function (dict, readonly) {\r\n    // externally specify choices and read-only status,\r\n    // used for custom blocks\r\n    var cnts = this.contents();\r\n    this.choices = dict;\r\n    this.isReadOnly = readonly || false;\r\n    if (this.parent instanceof BlockMorph) {\r\n        this.parent.fixLabelColor();\r\n        if (!readonly) {\r\n            cnts.shadowOffset = new Point();\r\n            cnts.shadowColor = null;\r\n            cnts.setColor(new Color(0, 0, 0));\r\n        }\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\n// InputSlotMorph layout:\r\n\r\nInputSlotMorph.prototype.fixLayout = function () {\r\n    var width, height, arrowWidth,\r\n        contents = this.contents(),\r\n        arrow = this.arrow();\r\n\r\n    contents.isNumeric = this.isNumeric;\r\n    contents.isEditable = (!this.isReadOnly);\r\n    if (this.isReadOnly) {\r\n        contents.disableSelecting();\r\n        contents.color = new Color(254, 254, 254);\r\n    } else {\r\n        contents.enableSelecting();\r\n        contents.color = new Color(0, 0, 0);\r\n    }\r\n\r\n    if (this.choices) {\r\n        arrow.setSize(this.fontSize);\r\n        arrow.show();\r\n    } else {\r\n        arrow.hide();\r\n    }\r\n    arrowWidth = arrow.isVisible ? arrow.width() : 0;\r\n\r\n    height = contents.height() + this.edge * 2; // + this.typeInPadding * 2\r\n    if (this.isNumeric) {\r\n        width = contents.width()\r\n            + Math.floor(arrowWidth * 0.5)\r\n            + height\r\n            + this.typeInPadding * 2;\r\n    } else {\r\n        width = Math.max(\r\n            contents.width()\r\n                + arrowWidth\r\n                + this.edge * 2\r\n                + this.typeInPadding * 2,\r\n            contents.rawHeight ? // single vs. multi-line contents\r\n                        contents.rawHeight() + arrowWidth\r\n                                : fontHeight(contents.fontSize) / 1.3\r\n                                    + arrowWidth,\r\n            this.minWidth // for text-type slots\r\n        );\r\n    }\r\n    this.setExtent(new Point(width, height));\r\n    if (this.isNumeric) {\r\n        contents.setPosition(new Point(\r\n            Math.floor(height / 2),\r\n            this.edge\r\n        ).add(new Point(this.typeInPadding, 0)).add(this.position()));\r\n    } else {\r\n        contents.setPosition(new Point(\r\n            this.edge,\r\n            this.edge\r\n        ).add(new Point(this.typeInPadding, 0)).add(this.position()));\r\n    }\r\n\r\n    if (arrow.isVisible) {\r\n        arrow.setPosition(new Point(\r\n            this.right() - arrowWidth - this.edge,\r\n            contents.top()\r\n        ));\r\n    }\r\n\r\n    if (this.parent) {\r\n        if (this.parent.fixLayout) {\r\n            if (this.world()) {\r\n                this.startLayout();\r\n                this.parent.fixLayout();\r\n                this.endLayout();\r\n            } else {\r\n                this.parent.fixLayout();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// InputSlotMorph events:\r\n\r\nInputSlotMorph.prototype.mouseDownLeft = function (pos) {\r\n    var world;\r\n    if (this.isReadOnly || this.arrow().bounds.containsPoint(pos)) {\r\n        this.escalateEvent('mouseDownLeft', pos);\r\n    } else {\r\n        world = this.world();\r\n        if (world) {\r\n            world.stopEditing();\r\n        }\r\n        this.selectForEdit().contents().edit();\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.mouseClickLeft = function (pos) {\r\n    if (this.arrow().bounds.containsPoint(pos)) {\r\n        this.dropDownMenu();\r\n    } else if (this.isReadOnly) {\r\n        this.dropDownMenu();\r\n    } else {\r\n        this.contents().edit();\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.reactToKeystroke = function () {\r\n    var cnts;\r\n    if (this.constant) {\r\n        cnts = this.contents();\r\n        this.constant = null;\r\n        cnts.isItalic = false;\r\n        cnts.drawNew();\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.reactToEdit = function () {\r\n    this.contents().clearSelection();\r\n};\r\n\r\nInputSlotMorph.prototype.freshTextEdit = function (aStringOrTextMorph) {\r\n    this.onNextStep = function () {\r\n        aStringOrTextMorph.selectAll();\r\n    };\r\n};\r\n\r\n// InputSlotMorph menu:\r\n\r\nInputSlotMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    if (!StageMorph.prototype.enableCodeMapping) {\r\n        return this.parent.userMenu();\r\n    }\r\n    if (this.isNumeric) {\r\n        menu.addItem(\r\n            'code number mapping...',\r\n            'mapNumberToCode'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            'code string mapping...',\r\n            'mapStringToCode'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\n// InputSlotMorph code mapping\r\n\r\n/*\r\n    code mapping lets you use blocks to generate arbitrary text-based\r\n    source code that can be exported and compiled / embedded elsewhere,\r\n    it's not part of Snap's evaluator and not needed for Snap itself\r\n*/\r\n\r\nInputSlotMorph.prototype.mapStringToCode = function () {\r\n    // private - open a dialog box letting the user map code via the GUI\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            StageMorph.prototype.codeMappings.string = code;\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping - String <#1>',\r\n        StageMorph.prototype.codeMappings.string || '',\r\n        this.world()\r\n    );\r\n};\r\n\r\nInputSlotMorph.prototype.mapNumberToCode = function () {\r\n    // private - open a dialog box letting the user map code via the GUI\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            StageMorph.prototype.codeMappings.number = code;\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping - Number <#1>',\r\n        StageMorph.prototype.codeMappings.number || '',\r\n        this.world()\r\n    );\r\n};\r\n\r\nInputSlotMorph.prototype.mappedCode = function () {\r\n    var block = this.parentThatIsA(BlockMorph),\r\n        val = this.evaluate(),\r\n        code;\r\n\r\n    if (this.isNumeric) {\r\n        code = StageMorph.prototype.codeMappings.number || '<#1>';\r\n        return code.replace(/<#1>/g, val);\r\n    }\r\n    if (!isNaN(parseFloat(val))) {return val; }\r\n    if (!isString(val)) {return val; }\r\n    if (block && contains(\r\n            ['doSetVar', 'doChangeVar', 'doShowVar', 'doHideVar'],\r\n            block.selector\r\n        )) {\r\n        return val;\r\n    }\r\n    code = StageMorph.prototype.codeMappings.string || '<#1>';\r\n    return code.replace(/<#1>/g, val);\r\n};\r\n\r\n// InputSlotMorph evaluating:\r\n\r\nInputSlotMorph.prototype.evaluate = function () {\r\n/*\r\n    answer my content's text string. If I am numerical convert that\r\n    string to a number. If the conversion fails answer the string\r\n    (e.g. for special choices like 'any', 'all' or 'last') otherwise\r\n    the numerical value.\r\n*/\r\n    var num,\r\n        contents = this.contents();\r\n    if (this.constant) {\r\n        return this.constant;\r\n    }\r\n    if (this.isNumeric) {\r\n        num = parseFloat(contents.text || '0');\r\n        if (!isNaN(num)) {\r\n            return num;\r\n        }\r\n    }\r\n    return contents.text;\r\n};\r\n\r\nInputSlotMorph.prototype.isEmptySlot = function () {\r\n    return this.contents().text === '';\r\n};\r\n\r\n// InputSlotMorph single-stepping:\r\n\r\nInputSlotMorph.prototype.flash = function () {\r\n    // don't redraw the label b/c zebra coloring\r\n    if (!this.cachedNormalColor) {\r\n        this.cachedNormalColor = this.color;\r\n        this.color = this.activeHighlight;\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.unflash = function () {\r\n    // don't redraw the label b/c zebra coloring\r\n    if (this.cachedNormalColor) {\r\n        var clr = this.cachedNormalColor;\r\n        this.cachedNormalColor = null;\r\n        this.color = clr;\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\n// InputSlotMorph drawing:\r\n\r\nInputSlotMorph.prototype.drawNew = function () {\r\n    var context, borderColor, r;\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if (this.cachedNormalColor) { // if flashing\r\n        borderColor = this.color;\r\n    } else if (this.parent) {\r\n        borderColor = this.parent.color;\r\n    } else {\r\n        borderColor = new Color(120, 120, 120);\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n    if (this.isReadOnly && !this.cachedNormalColor) { // unless flashing\r\n        context.fillStyle = borderColor.darker().toString();\r\n    }\r\n\r\n    // cache my border colors\r\n    this.cachedClr = borderColor.toString();\r\n    this.cachedClrBright = borderColor.lighter(this.contrast)\r\n        .toString();\r\n    this.cachedClrDark = borderColor.darker(this.contrast).toString();\r\n\r\n    if (!this.isNumeric) {\r\n        context.fillRect(\r\n            this.edge,\r\n            this.edge,\r\n            this.width() - this.edge * 2,\r\n            this.height() - this.edge * 2\r\n        );\r\n        if (!MorphicPreferences.isFlat) {\r\n            this.drawRectBorder(context);\r\n        }\r\n    } else {\r\n        r = (this.height() - (this.edge * 2)) / 2;\r\n        context.beginPath();\r\n        context.arc(\r\n            r + this.edge,\r\n            r + this.edge,\r\n            r,\r\n            radians(90),\r\n            radians(-90),\r\n            false\r\n        );\r\n        context.arc(\r\n            this.width() - r - this.edge,\r\n            r + this.edge,\r\n            r,\r\n            radians(-90),\r\n            radians(90),\r\n            false\r\n        );\r\n        context.closePath();\r\n        context.fill();\r\n        if (!MorphicPreferences.isFlat) {\r\n            this.drawRoundBorder(context);\r\n        }\r\n    }\r\n};\r\n\r\nInputSlotMorph.prototype.drawRectBorder = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        gradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.edge, shift);\r\n    context.lineTo(this.width() - this.edge - shift, shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetY = 0;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        this.edge,\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, this.edge);\r\n    context.lineTo(shift, this.height() - this.edge - shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.height() - this.edge,\r\n        0,\r\n        this.height()\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.edge, this.height() - shift);\r\n    context.lineTo(this.width() - this.edge, this.height() - shift);\r\n    context.stroke();\r\n\r\n    gradient = context.createLinearGradient(\r\n        this.width() - this.edge,\r\n        0,\r\n        this.width(),\r\n        0\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(this.width() - shift, this.edge);\r\n    context.lineTo(this.width() - shift, this.height() - this.edge);\r\n    context.stroke();\r\n\r\n};\r\n\r\nInputSlotMorph.prototype.drawRoundBorder = function (context) {\r\n    var shift = this.edge * 0.5,\r\n        r = (this.height() - (this.edge * 2)) / 2,\r\n        start,\r\n        end,\r\n        gradient;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // straight top edge:\r\n    start = r + this.edge;\r\n    end = this.width() - r - this.edge;\r\n    if (end > start) {\r\n\r\n        context.shadowOffsetX = shift;\r\n        context.shadowOffsetY = shift;\r\n        context.shadowBlur = this.edge;\r\n        context.shadowColor = this.color.darker(80).toString();\r\n\r\n        gradient = context.createLinearGradient(\r\n            0,\r\n            0,\r\n            0,\r\n            this.edge\r\n        );\r\n        gradient.addColorStop(0, this.cachedClr);\r\n        gradient.addColorStop(1, this.cachedClrDark);\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n\r\n        context.moveTo(start, shift);\r\n        context.lineTo(end, shift);\r\n        context.stroke();\r\n\r\n        context.shadowOffsetX = 0;\r\n        context.shadowOffsetY = 0;\r\n        context.shadowBlur = 0;\r\n    }\r\n\r\n    // straight bottom edge:\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        this.height() - this.edge,\r\n        0,\r\n        this.height()\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r + this.edge, this.height() - shift);\r\n    context.lineTo(this.width() - r - this.edge, this.height() - shift);\r\n    context.stroke();\r\n\r\n    r = this.height() / 2;\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    // top edge: left corner\r\n    gradient = context.createRadialGradient(\r\n        r,\r\n        r,\r\n        r - this.edge,\r\n        r,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r - shift,\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createRadialGradient(\r\n        this.width() - r,\r\n        r,\r\n        r - this.edge,\r\n        this.width() - r,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        this.width() - r,\r\n        r,\r\n        r - shift,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n};\r\n\r\n\r\n\r\n\r\n\r\n// TemplateSlotMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a reporter block template sitting on a pedestal.\r\n    My block spec is\r\n\r\n    %t        - template\r\n\r\n    evaluate returns the embedded reporter template's label string\r\n*/\r\n\r\n// TemplateSlotMorph inherits from ArgMorph:\r\n\r\nTemplateSlotMorph.prototype = new ArgMorph();\r\nTemplateSlotMorph.prototype.constructor = TemplateSlotMorph;\r\nTemplateSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// TemplateSlotMorph instance creation:\r\n\r\nfunction TemplateSlotMorph(name) {\r\n    this.init(name);\r\n}\r\n\r\nTemplateSlotMorph.prototype.init = function (name) {\r\n    var template = new ReporterBlockMorph();\r\n    this.labelString = name || '';\r\n    template.isDraggable = false;\r\n    template.isTemplate = true;\r\n    if (modules.objects !== undefined) {\r\n        template.color = SpriteMorph.prototype.blockColor.variables;\r\n        template.category = 'variables';\r\n    } else {\r\n        template.color = new Color(243, 118, 29);\r\n        template.category = null;\r\n    }\r\n    template.setSpec(this.labelString);\r\n    template.selector = 'reportGetVar';\r\n    TemplateSlotMorph.uber.init.call(this);\r\n    this.add(template);\r\n    this.fixLayout();\r\n    this.isDraggable = false;\r\n    this.isStatic = true; // I cannot be exchanged\r\n};\r\n\r\n// TemplateSlotMorph accessing:\r\n\r\nTemplateSlotMorph.prototype.getSpec = function () {\r\n    return '%t';\r\n};\r\n\r\nTemplateSlotMorph.prototype.template = function () {\r\n    return this.children[0];\r\n};\r\n\r\nTemplateSlotMorph.prototype.contents = function () {\r\n    return this.template().blockSpec;\r\n};\r\n\r\nTemplateSlotMorph.prototype.setContents = function (aString) {\r\n    var tmp = this.template();\r\n    tmp.setSpec(aString);\r\n    tmp.fixBlockColor(); // fix zebra coloring\r\n    tmp.fixLabelColor();\r\n};\r\n\r\n// TemplateSlotMorph evaluating:\r\n\r\nTemplateSlotMorph.prototype.evaluate = function () {\r\n    return this.contents();\r\n};\r\n\r\n// TemplateSlotMorph layout:\r\n\r\nTemplateSlotMorph.prototype.fixLayout = function () {\r\n    var template = this.template();\r\n    this.setExtent(template.extent().add(this.edge * 2 + 2));\r\n    template.setPosition(this.position().add(this.edge + 1));\r\n    if (this.parent) {\r\n        if (this.parent.fixLayout) {\r\n            this.parent.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\n// TemplateSlotMorph drop behavior:\r\n\r\nTemplateSlotMorph.prototype.wantsDropOf = function (aMorph) {\r\n    return aMorph.selector === 'reportGetVar';\r\n};\r\n\r\nTemplateSlotMorph.prototype.reactToDropOf = function (droppedMorph) {\r\n    if (droppedMorph.selector === 'reportGetVar') {\r\n        droppedMorph.destroy();\r\n    }\r\n};\r\n\r\n// TemplateSlotMorph drawing:\r\n\r\nTemplateSlotMorph.prototype.drawNew = function () {\r\n    var context;\r\n    if (this.parent instanceof Morph) {\r\n        this.color = this.parent.color.copy();\r\n    }\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n    this.drawRounded(context);\r\n};\r\n\r\nTemplateSlotMorph.prototype.drawRounded = ReporterBlockMorph\r\n    .prototype.drawRounded;\r\n\r\n// TemplateSlotMorph single-stepping\r\n\r\nTemplateSlotMorph.prototype.flash = function () {\r\n    this.template().flash();\r\n};\r\n\r\nTemplateSlotMorph.prototype.unflash = function () {\r\n    this.template().unflash();\r\n};\r\n\r\n// BooleanSlotMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a diamond-shaped argument slot.\r\n    My block spec is\r\n\r\n    %b         - Boolean\r\n    %boolUE    - Boolean unevaluated\r\n\r\n    I can be directly edited. When the user clicks on me I toggle\r\n    between <true>, <false> and <null> values.\r\n\r\n    evaluate() returns my value.\r\n\r\n    my most important public attributes and accessors are:\r\n\r\n    value                      - user editable contents (Boolean or null)\r\n    setContents(Boolean/null)  - display the argument (Boolean or null)\r\n*/\r\n\r\n// BooleanSlotMorph inherits from ArgMorph:\r\n\r\nBooleanSlotMorph.prototype = new ArgMorph();\r\nBooleanSlotMorph.prototype.constructor = BooleanSlotMorph;\r\nBooleanSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// BooleanSlotMorph preferences settings\r\n\r\nBooleanSlotMorph.prototype.isTernary = true;\r\n\r\n// BooleanSlotMorph instance creation:\r\n\r\nfunction BooleanSlotMorph(initialValue) {\r\n    this.init(initialValue);\r\n}\r\n\r\nBooleanSlotMorph.prototype.init = function (initialValue) {\r\n    this.value = (typeof initialValue === 'boolean') ? initialValue : null;\r\n    this.isUnevaluated = false;\r\n    BooleanSlotMorph.uber.init.call(this);\r\n};\r\n\r\nBooleanSlotMorph.prototype.getSpec = function () {\r\n    return this.isUnevaluated ? '%boolUE' : '%b';\r\n};\r\n\r\n// BooleanSlotMorph accessing:\r\n\r\nBooleanSlotMorph.prototype.evaluate = function () {\r\n    return this.value;\r\n};\r\n\r\nBooleanSlotMorph.prototype.isEmptySlot = function () {\r\n    return this.value === null;\r\n};\r\n\r\nBooleanSlotMorph.prototype.isBinary = function () {\r\n    return !this.isTernary &&\r\n        isNil(this.parentThatIsA(RingMorph)) &&\r\n        !isNil(this.parentThatIsA(ScriptsMorph));\r\n};\r\n\r\nBooleanSlotMorph.prototype.setContents = function (boolOrNull, silently) {\r\n    this.value = (typeof boolOrNull === 'boolean') ? boolOrNull : null;\r\n    if (silently) {return; }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nBooleanSlotMorph.prototype.toggleValue = function () {\r\n    var target = this.selectForEdit(),\r\n        ide;\r\n    if (target !== this) {\r\n        return this.toggleValue.call(target);\r\n    }\r\n    ide = this.parentThatIsA(IDE_Morph);\r\n    if (this.isStatic || this.isBinary()) {\r\n        this.setContents(!this.value, true);\r\n    } else {\r\n        switch (this.value) {\r\n        case true:\r\n            this.value = false;\r\n            break;\r\n        case false:\r\n            this.value = null;\r\n            break;\r\n        default:\r\n            this.value = true;\r\n        }\r\n    }\r\n    if (ide && !ide.isAnimating) {\r\n        this.drawNew();\r\n        this.changed();\r\n        return;\r\n    }\r\n    this.drawNew(3);\r\n    this.changed();\r\n    this.nextSteps ([\r\n        function () {\r\n            this.drawNew(2);\r\n            this.changed();\r\n        },\r\n        function () {\r\n            this.drawNew(1);\r\n            this.changed();\r\n        },\r\n        function () {\r\n            this.drawNew();\r\n            this.changed();\r\n        },\r\n    ]);\r\n};\r\n\r\n// BooleanSlotMorph events:\r\n\r\nBooleanSlotMorph.prototype.mouseClickLeft = function () {\r\n    this.toggleValue();\r\n    if (isNil(this.value)) {return; }\r\n    this.reactToSliderEdit();\r\n};\r\n\r\nBooleanSlotMorph.prototype.mouseEnter = function () {\r\n    if (this.isStatic) {return; }\r\n    if (this.value === false && !this.isBinary()) {\r\n        var oldValue = this.value;\r\n        this.value = null;\r\n        this.drawNew(3);\r\n        this.changed();\r\n        this.value = oldValue;\r\n        return;\r\n    }\r\n    this.drawNew(1);\r\n    this.changed();\r\n};\r\n\r\nBooleanSlotMorph.prototype.mouseLeave = function () {\r\n    if (this.isStatic) {return; }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// BooleanSlotMorph menu:\r\n\r\nBooleanSlotMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    if (!StageMorph.prototype.enableCodeMapping) {\r\n        return this.parent.userMenu();\r\n    }\r\n    if (this.evaluate() === true) {\r\n        menu.addItem(\r\n            'code true mapping...',\r\n            'mapTrueToCode'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            'code false mapping...',\r\n            'mapFalseToCode'\r\n        );\r\n    }\r\n    return menu;\r\n};\r\n\r\n// BooleanSlotMorph code mapping\r\n\r\n/*\r\n    code mapping lets you use blocks to generate arbitrary text-based\r\n    source code that can be exported and compiled / embedded elsewhere,\r\n    it's not part of Snap's evaluator and not needed for Snap itself\r\n*/\r\n\r\nBooleanSlotMorph.prototype.mapTrueToCode = function () {\r\n    // private - open a dialog box letting the user map code via the GUI\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            StageMorph.prototype.codeMappings['true'] = code;\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping - true',\r\n        StageMorph.prototype.codeMappings['true'] || 'true',\r\n        this.world()\r\n    );\r\n};\r\n\r\nBooleanSlotMorph.prototype.mapFalseToCode = function () {\r\n    // private - open a dialog box letting the user map code via the GUI\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            StageMorph.prototype.codeMappings['false'] = code;\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping - false',\r\n        StageMorph.prototype.codeMappings['false'] || 'false',\r\n        this.world()\r\n    );\r\n};\r\n\r\nBooleanSlotMorph.prototype.mappedCode = function () {\r\n    if (this.evaluate() === true) {\r\n        return StageMorph.prototype.codeMappings.boolTrue || 'true';\r\n    }\r\n    return StageMorph.prototype.codeMappings.boolFalse || 'false';\r\n};\r\n\r\n// BooleanSlotMorph drawing:\r\n\r\nBooleanSlotMorph.prototype.drawNew = function (progress) {\r\n    // \"progress\" is an optional number sliding the knob\r\n    // on a range between 0 and 4\r\n    var context,\r\n        textLabel = this.isStatic ? this.textLabel() : null,\r\n        h;\r\n\r\n    if (textLabel) {\r\n        h = textLabel.height + (this.edge * 3);\r\n        this.silentSetExtent(new Point(\r\n            textLabel.width + (h * 1.5) + (this.edge * 2),\r\n            h\r\n        ));\r\n    } else {\r\n        this.silentSetExtent(new Point(\r\n            (this.fontSize + this.edge * 2) * 2,\r\n            this.fontSize + this.edge * 2\r\n        ));\r\n    }\r\n    if (!(this.cachedNormalColor)) { // unless flashing\r\n        this.color = this.parent ?\r\n                this.parent.color : new Color(200, 200, 200);\r\n    }\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    this.drawDiamond(context, progress);\r\n    this.drawLabel(context, textLabel);\r\n    this.drawKnob(context, progress);\r\n};\r\n\r\nBooleanSlotMorph.prototype.drawDiamond = function (context, progress) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        r = h / 2,\r\n        w2 = w / 2,\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    if (this.cachedNormalColor) { // if flashing\r\n        context.fillStyle = this.color.toString();\r\n    } else {\r\n        switch (this.value) {\r\n        case true:\r\n            context.fillStyle = 'rgb(0, 200, 0)';\r\n            break;\r\n        case false:\r\n            context.fillStyle = 'rgb(200, 0, 0)';\r\n            break;\r\n        default:\r\n            context.fillStyle = this.color.darker(25).toString();\r\n        }\r\n    }\r\n\r\n    if (progress && !this.isEmptySlot()) {\r\n        // left half:\r\n        context.fillStyle = 'rgb(0, 200, 0)';\r\n        context.beginPath();\r\n        context.moveTo(0, r);\r\n        context.lineTo(r, 0);\r\n        context.lineTo(w2, 0);\r\n        context.lineTo(w2, h);\r\n        context.lineTo(r, h);\r\n        context.closePath();\r\n        context.fill();\r\n\r\n        // right half:\r\n        context.fillStyle = 'rgb(200, 0, 0)';\r\n        context.beginPath();\r\n        context.moveTo(w2, 0);\r\n        context.lineTo(w - r, 0);\r\n        context.lineTo(w, r);\r\n        context.lineTo(w - r, h);\r\n        context.lineTo(w2, h);\r\n        context.closePath();\r\n        context.fill();\r\n    } else {\r\n        context.beginPath();\r\n        context.moveTo(0, r);\r\n        context.lineTo(r, 0);\r\n        context.lineTo(w - r, 0);\r\n        context.lineTo(w, r);\r\n        context.lineTo(w - r, h);\r\n        context.lineTo(r, h);\r\n        context.closePath();\r\n        context.fill();\r\n    }\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowBlur = shift;\r\n    context.shadowColor = 'black';\r\n\r\n    // top edge: left corner\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        r,\r\n        this.edge * 0.6,\r\n        r + (this.edge * 0.6)\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, r);\r\n    context.lineTo(r, shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // top edge: straight line\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r, shift);\r\n    context.lineTo(w - r, shift);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createLinearGradient(\r\n        w - r - (this.edge * 0.6),\r\n        h - (this.edge * 0.6),\r\n        w - r,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - r, h - shift);\r\n    context.lineTo(w - shift, r);\r\n    context.closePath();\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r, h - shift);\r\n    context.lineTo(w - r - shift, h - shift);\r\n    context.closePath();\r\n    context.stroke();\r\n};\r\n\r\nBooleanSlotMorph.prototype.drawLabel = function (context, textLabel) {\r\n    var w = this.width(),\r\n        r = this.height() / 2 - this.edge,\r\n        r2 = r / 2,\r\n        shift = this.edge / 2,\r\n        x,\r\n        y = this.height() / 2;\r\n\r\n    if (this.isEmptySlot()) {\r\n        return;\r\n    }\r\n    if (textLabel) {\r\n        y = (this.height() - textLabel.height) / 2;\r\n        if (this.value) {\r\n            x = this.height() / 2;\r\n        } else {\r\n            x = this.width() - (this.height() / 2) - textLabel.width;\r\n        }\r\n    if (!MorphicPreferences.isFlat) {\r\n        context.shadowOffsetX = -shift;\r\n        context.shadowOffsetY = -shift;\r\n        context.shadowBlur = shift;\r\n        context.shadowColor = this.value ? 'rgb(0, 100, 0)' : 'rgb(100, 0, 0)';\r\n    }\r\n        context.drawImage(textLabel, x, y);\r\n        return;\r\n    }\r\n    // \"tick:\"\r\n    x = r + (this.edge * 2) + shift;\r\n    if (!MorphicPreferences.isFlat) {\r\n        context.shadowOffsetX = -shift;\r\n        context.shadowOffsetY = -shift;\r\n        context.shadowBlur = shift;\r\n        context.shadowColor = 'rgb(0, 100, 0)';\r\n    }\r\n    context.strokeStyle = 'white';\r\n    context.lineWidth = this.edge + shift;\r\n    context.lineCap = 'round';\r\n    context.lineJoin = 'miter';\r\n    context.beginPath();\r\n    context.moveTo(x - r2, y);\r\n    context.lineTo(x, y + r2);\r\n    context.lineTo(x + r2, r2 + this.edge);\r\n    context.stroke();\r\n\r\n    // \"cross:\"\r\n    x = w - y - (this.edge * 2);\r\n    if (!MorphicPreferences.isFlat) {\r\n        context.shadowOffsetX = -shift;\r\n        context.shadowOffsetY = -shift;\r\n        context.shadowBlur = shift;\r\n        context.shadowColor = 'rgb(100, 0, 0)';\r\n    }\r\n    context.strokeStyle = 'white';\r\n    context.lineWidth = this.edge;\r\n    context.lineCap = 'butt';\r\n    context.beginPath();\r\n    context.moveTo(x - r2, y - r2);\r\n    context.lineTo(x + r2, y + r2);\r\n    context.moveTo(x - r2, y + r2);\r\n    context.lineTo(x + r2, y - r2);\r\n    context.stroke();\r\n};\r\n\r\nBooleanSlotMorph.prototype.drawKnob = function (context, progress) {\r\n    var w = this.width(),\r\n        r = this.height() / 2,\r\n        shift = this.edge / 2,\r\n        slideStep = (this.width() - this.height()) / 4 * (progress || 0),\r\n        gradient,\r\n        x,\r\n        y = r,\r\n        outline = PushButtonMorph.prototype.outline / 2,\r\n        outlineColor = PushButtonMorph.prototype.outlineColor,\r\n        color = PushButtonMorph.prototype.color,\r\n        contrast = PushButtonMorph.prototype.contrast,\r\n        topColor = color.lighter(contrast),\r\n        bottomColor = color.darker(contrast);\r\n\r\n    // draw the 'flat' shape:\r\n    switch (this.value) {\r\n    case false:\r\n        x = r + slideStep;\r\n        if (!MorphicPreferences.isFlat) {\r\n            context.shadowOffsetX = shift;\r\n            context.shadowOffsetY = 0;\r\n            context.shadowBlur = shift;\r\n            context.shadowColor = 'black';\r\n        }\r\n        break;\r\n    case true:\r\n        x = w - r - slideStep;\r\n        if (!MorphicPreferences.isFlat) {\r\n            context.shadowOffsetX = 0;\r\n            context.shadowOffsetY = 0;\r\n            context.shadowBlur = 0;\r\n        }\r\n        break;\r\n    default:\r\n        if (!progress) {return; }\r\n        x = r;\r\n        if (!MorphicPreferences.isFlat) {\r\n            context.shadowOffsetX = shift;\r\n            context.shadowOffsetY = 0;\r\n            context.shadowBlur = shift;\r\n            context.shadowColor = 'black';\r\n        }\r\n        context.globalAlpha = 0.2 * ((progress || 0) + 1);\r\n    }\r\n\r\n    context.fillStyle = color.toString();\r\n    context.beginPath();\r\n    context.arc(x, y, r, radians(0), radians(360));\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect\r\n    // outline:\r\n    context.shadowOffsetX = 0;\r\n    context.shadowBlur = 0;\r\n    context.shadowColor = 'black';\r\n    context.lineWidth = outline;\r\n    context.strokeStyle = outlineColor.toString();\r\n    context.beginPath();\r\n    context.arc(x, y, r - (outline / 2), radians(0), radians(360));\r\n    context.stroke();\r\n\r\n    // top-left:\r\n    gradient = context.createRadialGradient(\r\n        x,\r\n        y,\r\n        r - outline - this.edge,\r\n        x,\r\n        y,\r\n        r - outline\r\n    );\r\n    gradient.addColorStop(1, topColor.toString());\r\n    gradient.addColorStop(0, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.arc(\r\n        x,\r\n        y,\r\n        r - outline - this.edge / 2,\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom-right:\r\n    gradient = context.createRadialGradient(\r\n        x,\r\n        y,\r\n        r - outline - this.edge,\r\n        x,\r\n        y,\r\n        r - outline\r\n    );\r\n    gradient.addColorStop(1, bottomColor.toString());\r\n    gradient.addColorStop(0, color.toString());\r\n\r\n    context.strokeStyle = gradient;\r\n    context.lineCap = 'round';\r\n    context.lineWidth = this.edge;\r\n    context.beginPath();\r\n    context.arc(\r\n        x,\r\n        y,\r\n        r - outline - this.edge / 2,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n};\r\n\r\nBooleanSlotMorph.prototype.textLabel = function () {\r\n    if (this.isEmptySlot()) {return null; }\r\n    var t, f, img, lbl, x, y;\r\n    t = new StringMorph(\r\n        localize('true'),\r\n        this.fontSize,\r\n        null,\r\n        true, // bold\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        new Color(255, 255, 255)\r\n    ).image;\r\n    f = new StringMorph(\r\n        localize('false'),\r\n        this.fontSize,\r\n        null,\r\n        true, // bold\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        new Color(255, 255, 255)\r\n    ).image;\r\n    img = newCanvas(new Point(\r\n        Math.max(t.width, f.width),\r\n        Math.max(t.height, f.height)\r\n    ));\r\n    lbl = this.value ? t : f;\r\n    x = (img.width - lbl.width) / 2;\r\n    y = (img.height - lbl.height) / 2;\r\n    img.getContext('2d').drawImage(lbl, x, y);\r\n    return img;\r\n};\r\n\r\n// ArrowMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a triangular arrow shape, for use in drop-down menus etc.\r\n    My orientation is governed by my 'direction' property, which can be\r\n    'down', 'up', 'left' or 'right'.\r\n*/\r\n\r\n// ArrowMorph inherits from Morph:\r\n\r\nArrowMorph.prototype = new Morph();\r\nArrowMorph.prototype.constructor = ArrowMorph;\r\nArrowMorph.uber = Morph.prototype;\r\n\r\n// ArrowMorph instance creation:\r\n\r\nfunction ArrowMorph(direction, size, padding, color) {\r\n    this.init(direction, size, padding, color);\r\n}\r\n\r\nArrowMorph.prototype.init = function (direction, size, padding, color) {\r\n    this.direction = direction || 'down';\r\n    this.size = size || ((size === 0) ? 0 : 50);\r\n    this.padding = padding || 0;\r\n\r\n    ArrowMorph.uber.init.call(this, true); // silently\r\n    this.color = color || new Color(0, 0, 0);\r\n    this.setExtent(new Point(this.size, this.size));\r\n};\r\n\r\nArrowMorph.prototype.setSize = function (size) {\r\n    var min = Math.max(size, 1);\r\n    this.size = size;\r\n    this.setExtent(new Point(min, min));\r\n};\r\n\r\n// ArrowMorph displaying:\r\n\r\nArrowMorph.prototype.drawNew = function () {\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    var context = this.image.getContext('2d'),\r\n        pad = this.padding,\r\n        h = this.height(),\r\n        h2 = Math.floor(h / 2),\r\n        w = this.width(),\r\n        w2 = Math.floor(w / 2);\r\n\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n    if (this.direction === 'down') {\r\n        context.moveTo(pad, h2);\r\n        context.lineTo(w - pad, h2);\r\n        context.lineTo(w2, h - pad);\r\n    } else if (this.direction === 'up') {\r\n        context.moveTo(pad, h2);\r\n        context.lineTo(w - pad, h2);\r\n        context.lineTo(w2, pad);\r\n    } else if (this.direction === 'left') {\r\n        context.moveTo(pad, h2);\r\n        context.lineTo(w2, pad);\r\n        context.lineTo(w2, h - pad);\r\n    } else { // 'right'\r\n        context.moveTo(w2, pad);\r\n        context.lineTo(w - pad, h2);\r\n        context.lineTo(w2, h - pad);\r\n    }\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\n// TextSlotMorph //////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a multi-line input slot, primarily used in Snap's code-mapping\r\n    blocks.\r\n*/\r\n\r\n// TextSlotMorph inherits from InputSlotMorph:\r\n\r\nTextSlotMorph.prototype = new InputSlotMorph();\r\nTextSlotMorph.prototype.constructor = TextSlotMorph;\r\nTextSlotMorph.uber = InputSlotMorph.prototype;\r\n\r\n// TextSlotMorph instance creation:\r\n\r\nfunction TextSlotMorph(text, isNumeric, choiceDict, isReadOnly) {\r\n    this.init(text, isNumeric, choiceDict, isReadOnly);\r\n}\r\n\r\nTextSlotMorph.prototype.init = function (\r\n    text,\r\n    isNumeric,\r\n    choiceDict,\r\n    isReadOnly\r\n) {\r\n    var contents = new TextMorph(''),\r\n        arrow = new ArrowMorph(\r\n            'down',\r\n            0,\r\n            Math.max(Math.floor(this.fontSize / 6), 1)\r\n        );\r\n\r\n    contents.fontSize = this.fontSize;\r\n    contents.drawNew();\r\n\r\n    this.isUnevaluated = false;\r\n    this.choices = choiceDict || null; // object, function or selector\r\n    this.oldContentsExtent = contents.extent();\r\n    this.isNumeric = isNumeric || false;\r\n    this.isReadOnly = isReadOnly || false;\r\n    this.minWidth = 0; // can be chaged for text-type inputs (\"landscape\")\r\n    this.constant = null;\r\n\r\n    InputSlotMorph.uber.init.call(this, null, null, null, null, true); // sil.\r\n    this.color = new Color(255, 255, 255);\r\n    this.add(contents);\r\n    this.add(arrow);\r\n    contents.isEditable = true;\r\n    contents.isDraggable = false;\r\n    contents.enableSelecting();\r\n    this.setContents(text);\r\n\r\n};\r\n\r\n// TextSlotMorph accessing:\r\n\r\nTextSlotMorph.prototype.getSpec = function () {\r\n    if (this.isNumeric) {\r\n        return '%mln';\r\n    }\r\n    return '%mlt'; // default\r\n};\r\n\r\nTextSlotMorph.prototype.contents = function () {\r\n    return detect(\r\n        this.children,\r\n        function (child) {\r\n            return (child instanceof TextMorph);\r\n        }\r\n    );\r\n};\r\n\r\n// TextSlotMorph events:\r\n\r\nTextSlotMorph.prototype.layoutChanged = function () {\r\n    this.fixLayout();\r\n};\r\n\r\n// ColorSlotMorph //////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an editable input slot for a color. Users can edit my color by\r\n    clicking on me, in which case a display a color gradient palette\r\n    and let the user select another color. Note that the user isn't\r\n    restricted to selecting a color from the palette, any color from\r\n    anywhere within the World can be chosen.\r\n\r\n    my block spec is %clr\r\n\r\n    evaluate() returns my color\r\n*/\r\n\r\n// ColorSlotMorph  inherits from ArgMorph:\r\n\r\nColorSlotMorph.prototype = new ArgMorph();\r\nColorSlotMorph.prototype.constructor = ColorSlotMorph;\r\nColorSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// ColorSlotMorph  instance creation:\r\n\r\nfunction ColorSlotMorph(clr) {\r\n    this.init(clr);\r\n}\r\n\r\nColorSlotMorph.prototype.init = function (clr) {\r\n    ColorSlotMorph.uber.init.call(this, null, true); // silently\r\n    this.setColor(clr || new Color(145, 26, 68));\r\n};\r\n\r\nColorSlotMorph.prototype.getSpec = function () {\r\n    return '%clr';\r\n};\r\n\r\n// ColorSlotMorph  color sensing:\r\n\r\nColorSlotMorph.prototype.getUserColor = function () {\r\n    var myself = this,\r\n        world = this.world(),\r\n        hand = world.hand,\r\n        posInDocument = getDocumentPositionOf(world.worldCanvas),\r\n        mouseMoveBak = hand.processMouseMove,\r\n        mouseDownBak = hand.processMouseDown,\r\n        mouseUpBak = hand.processMouseUp,\r\n        pal = new ColorPaletteMorph(null, new Point(\r\n            this.fontSize * 16,\r\n            this.fontSize * 10\r\n        ));\r\n    world.add(pal);\r\n    pal.setPosition(this.bottomLeft().add(new Point(0, this.edge)));\r\n\r\n    hand.processMouseMove = function (event) {\r\n        var clr = world.getGlobalPixelColor(hand.position());\r\n        hand.setPosition(new Point(\r\n            event.pageX - posInDocument.x,\r\n            event.pageY - posInDocument.y\r\n        ));\r\n        if (!clr.a) {\r\n            // ignore transparent,\r\n            // needed for retina-display support\r\n            return;\r\n        }\r\n        myself.setColor(clr);\r\n    };\r\n\r\n    hand.processMouseDown = nop;\r\n\r\n    hand.processMouseUp = function () {\r\n        pal.destroy();\r\n        hand.processMouseMove = mouseMoveBak;\r\n        hand.processMouseDown = mouseDownBak;\r\n        hand.processMouseUp = mouseUpBak;\r\n    };\r\n};\r\n\r\n// ColorSlotMorph events:\r\n\r\nColorSlotMorph.prototype.mouseClickLeft = function () {\r\n    this.selectForEdit().getUserColor();\r\n};\r\n\r\n// ColorSlotMorph evaluating:\r\n\r\nColorSlotMorph.prototype.evaluate = function () {\r\n    return this.color;\r\n};\r\n\r\n// ColorSlotMorph drawing:\r\n\r\nColorSlotMorph.prototype.drawNew = function () {\r\n    var context, borderColor, side;\r\n\r\n    side = this.fontSize + this.edge * 2 + this.typeInPadding * 2;\r\n    this.silentSetExtent(new Point(side, side));\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if (this.parent) {\r\n        borderColor = this.parent.color;\r\n    } else {\r\n        borderColor = new Color(120, 120, 120);\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n\r\n    // cache my border colors\r\n    this.cachedClr = borderColor.toString();\r\n    this.cachedClrBright = borderColor.lighter(this.contrast)\r\n        .toString();\r\n    this.cachedClrDark = borderColor.darker(this.contrast).toString();\r\n\r\n    context.fillRect(\r\n        this.edge,\r\n        this.edge,\r\n        this.width() - this.edge * 2,\r\n        this.height() - this.edge * 2\r\n    );\r\n    if (!MorphicPreferences.isFlat) {\r\n        this.drawRectBorder(context);\r\n    }\r\n};\r\n\r\nColorSlotMorph.prototype.drawRectBorder =\r\n    InputSlotMorph.prototype.drawRectBorder;\r\n\r\n// BlockHighlightMorph /////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a glowing halo around a block or stack of blocks indicating that\r\n    a script is currently active or has encountered an error.\r\n    I halso have an optional readout that can display a thread count\r\n    if more than one process shares the same script\r\n*/\r\n\r\n// BlockHighlightMorph inherits from Morph:\r\n\r\nBlockHighlightMorph.prototype = new Morph();\r\nBlockHighlightMorph.prototype.constructor = BlockHighlightMorph;\r\nBlockHighlightMorph.uber = Morph.prototype;\r\n\r\n// BlockHighlightMorph instance creation:\r\n\r\nfunction BlockHighlightMorph() {\r\n    this.threadCount = 0;\r\n    this.init();\r\n}\r\n\r\n// BlockHighlightMorph thread count readout\r\n\r\nBlockHighlightMorph.prototype.readout = function () {\r\n    return this.children.length ? this.children[0] : null;\r\n};\r\n\r\nBlockHighlightMorph.prototype.updateReadout = function () {\r\n    var readout = this.readout(),\r\n        inset = useBlurredShadows && !MorphicPreferences.isFlat ?\r\n            SyntaxElementMorph.prototype.activeBlur * 0.4\r\n                : SyntaxElementMorph.prototype.activeBorder * -2;\r\n    if (this.threadCount < 2) {\r\n        if (readout) {\r\n            readout.destroy();\r\n        }\r\n        return;\r\n    }\r\n    if (readout) {\r\n        readout.contents = this.threadCount.toString();\r\n        readout.fullChanged();\r\n        readout.drawNew();\r\n        readout.fullChanged();\r\n    } else {\r\n        readout = new SpeechBubbleMorph(\r\n            this.threadCount.toString(),\r\n            this.color, // color,\r\n            null, // edge,\r\n            null, // border,\r\n            this.color.darker(), // borderColor,\r\n            null, // padding,\r\n            1 // isThought - don't draw a hook\r\n        );\r\n        this.add(readout);\r\n    }\r\n    readout.setPosition(this.position().add(inset));\r\n};\r\n\r\n// MultiArgMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an arity controlled list of input slots\r\n\r\n    my block specs are\r\n\r\n        %mult%x - where x is any single input slot\r\n        %inputs - for an additional text label 'with inputs'\r\n\r\n    evaluation is handles by the interpreter\r\n*/\r\n\r\n// MultiArgMorph inherits from ArgMorph:\r\n\r\nMultiArgMorph.prototype = new ArgMorph();\r\nMultiArgMorph.prototype.constructor = MultiArgMorph;\r\nMultiArgMorph.uber = ArgMorph.prototype;\r\n\r\n// MultiArgMorph instance creation:\r\n\r\nfunction MultiArgMorph(\r\n    slotSpec,\r\n    labelTxt,\r\n    min,\r\n    eSpec,\r\n    arrowColor,\r\n    labelColor,\r\n    shadowColor,\r\n    shadowOffset,\r\n    isTransparent\r\n) {\r\n    this.init(\r\n        slotSpec,\r\n        labelTxt,\r\n        min,\r\n        eSpec,\r\n        arrowColor,\r\n        labelColor,\r\n        shadowColor,\r\n        shadowOffset,\r\n        isTransparent\r\n    );\r\n}\r\n\r\nMultiArgMorph.prototype.init = function (\r\n    slotSpec,\r\n    labelTxt,\r\n    min,\r\n    eSpec,\r\n    arrowColor,\r\n    labelColor,\r\n    shadowColor,\r\n    shadowOffset,\r\n    isTransparent\r\n) {\r\n    var label,\r\n        arrows = new FrameMorph(),\r\n        leftArrow,\r\n        rightArrow,\r\n        i;\r\n\r\n    this.slotSpec = slotSpec || '%s';\r\n    this.labelText = localize(labelTxt || '');\r\n    this.minInputs = min || 0;\r\n    this.elementSpec = eSpec || null;\r\n    this.labelColor = labelColor || null;\r\n    this.shadowColor = shadowColor || null;\r\n    this.shadowOffset = shadowOffset || null;\r\n\r\n    this.canBeEmpty = true;\r\n    MultiArgMorph.uber.init.call(this, null, true); // silently\r\n\r\n    // MultiArgMorphs are transparent by default b/c of zebra coloring\r\n    this.alpha = isTransparent === false ? 1 : 0;\r\n    arrows.alpha = isTransparent === false ? 1 : 0;\r\n    arrows.noticesTransparentClick = true;\r\n    this.noticesTransparentclick = true;\r\n\r\n    // label text:\r\n    label = this.labelPart(this.labelText);\r\n    this.add(label);\r\n    label.hide();\r\n\r\n    // left arrow:\r\n    leftArrow = new ArrowMorph(\r\n        'left',\r\n        this.fontSize,\r\n        Math.max(Math.floor(this.fontSize / 6), 1),\r\n        arrowColor\r\n    );\r\n\r\n    // right arrow:\r\n    rightArrow = new ArrowMorph(\r\n        'right',\r\n        this.fontSize,\r\n        Math.max(Math.floor(this.fontSize / 6), 1),\r\n        arrowColor\r\n    );\r\n\r\n    // control panel:\r\n    arrows.add(leftArrow);\r\n    arrows.add(rightArrow);\r\n    arrows.drawNew();\r\n    arrows.acceptsDrops = false;\r\n\r\n    this.add(arrows);\r\n\r\n    // create the minimum number of inputs\r\n    for (i = 0; i < this.minInputs; i += 1) {\r\n        this.addInput();\r\n    }\r\n};\r\n\r\nMultiArgMorph.prototype.label = function () {\r\n    return this.children[0];\r\n};\r\n\r\nMultiArgMorph.prototype.arrows = function () {\r\n    return this.children[this.children.length - 1];\r\n};\r\n\r\nMultiArgMorph.prototype.getSpec = function () {\r\n    return '%mult' + this.slotSpec;\r\n};\r\n\r\n// MultiArgMorph defaults:\r\n\r\nMultiArgMorph.prototype.setContents = function (anArray) {\r\n    var inputs = this.inputs(), i;\r\n    for (i = 0; i < anArray.length; i += 1) {\r\n        if (anArray[i] !== null && (inputs[i])) {\r\n            inputs[i].setContents(anArray[i]);\r\n        }\r\n    }\r\n};\r\n\r\n// MultiArgMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children, so that my instances get restored correctly when\r\n    switching back out of app mode.\r\n*/\r\n\r\nMultiArgMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n};\r\n\r\nMultiArgMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n};\r\n\r\n// MultiArgMorph coloring:\r\n\r\nMultiArgMorph.prototype.setLabelColor = function (\r\n    textColor,\r\n    shadowColor,\r\n    shadowOffset\r\n) {\r\n    this.textColor = textColor;\r\n    this.shadowColor = shadowColor;\r\n    this.shadowOffset = shadowOffset;\r\n    MultiArgMorph.uber.setLabelColor.call(\r\n        this,\r\n        textColor,\r\n        shadowColor,\r\n        shadowOffset\r\n    );\r\n};\r\n\r\n// MultiArgMorph layout:\r\n\r\nMultiArgMorph.prototype.fixLayout = function () {\r\n    if (this.slotSpec === '%t') {\r\n        this.isStatic = true; // in this case I cannot be exchanged\r\n    }\r\n    if (this.parent) {\r\n        var label = this.label(), shadowColor, shadowOffset;\r\n        this.color = this.parent.color;\r\n        shadowColor = this.shadowColor ||\r\n            this.parent.color.darker(this.labelContrast);\r\n        shadowOffset = this.shadowOffset || label.shadowOffset;\r\n        this.arrows().color = this.color;\r\n\r\n        if (this.labelText !== '') {\r\n            if (!label.shadowColor.eq(shadowColor)) {\r\n                label.shadowColor = shadowColor;\r\n                label.shadowOffset = shadowOffset;\r\n                label.drawNew();\r\n            }\r\n        }\r\n\r\n    }\r\n    this.fixArrowsLayout();\r\n    MultiArgMorph.uber.fixLayout.call(this);\r\n    if (this.parent) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\nMultiArgMorph.prototype.fixArrowsLayout = function () {\r\n    var label = this.label(),\r\n        arrows = this.arrows(),\r\n        leftArrow = arrows.children[0],\r\n        rightArrow = arrows.children[1],\r\n        dim = new Point(rightArrow.width() / 2, rightArrow.height());\r\n    if (this.inputs().length < (this.minInputs + 1)) {\r\n        label.hide();\r\n        leftArrow.hide();\r\n        rightArrow.setPosition(\r\n            arrows.position().subtract(new Point(dim.x, 0))\r\n        );\r\n        arrows.setExtent(dim);\r\n    } else {\r\n        if (this.labelText !== '') {\r\n            label.show();\r\n        }\r\n        leftArrow.show();\r\n        rightArrow.setPosition(leftArrow.topCenter());\r\n        arrows.bounds.corner = rightArrow.bottomRight().copy();\r\n    }\r\n    arrows.drawNew();\r\n};\r\n\r\nMultiArgMorph.prototype.refresh = function () {\r\n    this.inputs().forEach(function (input) {\r\n        input.drawNew();\r\n    });\r\n};\r\n\r\nMultiArgMorph.prototype.drawNew = function () {\r\n    MultiArgMorph.uber.drawNew.call(this);\r\n    this.refresh();\r\n};\r\n\r\n// MultiArgMorph arity control:\r\n\r\nMultiArgMorph.prototype.addInput = function (contents) {\r\n    var i, name,\r\n        newPart = this.labelPart(this.slotSpec),\r\n        idx = this.children.length - 1;\r\n    // newPart.alpha = this.alpha ? 1 : (1 - this.alpha) / 2;\r\n    if (contents) {\r\n        newPart.setContents(contents);\r\n    } else if (this.elementSpec === '%scriptVars' ||\r\n            this.elementSpec === '%blockVars') {\r\n        name = '';\r\n        i = idx;\r\n        while (i > 0) {\r\n            name = String.fromCharCode(97 + (i - 1) % 26) + name;\r\n            i = Math.floor((i - 1) / 26);\r\n        }\r\n        newPart.setContents(name);\r\n    } else if (contains(['%parms', '%ringparms'], this.elementSpec)) {\r\n        newPart.setContents('#' + idx);\r\n    }\r\n    newPart.parent = this;\r\n    this.children.splice(idx, 0, newPart);\r\n    newPart.drawNew();\r\n    this.fixLayout();\r\n};\r\n\r\nMultiArgMorph.prototype.removeInput = function () {\r\n    var oldPart, scripts;\r\n    if (this.children.length > 1) {\r\n        oldPart = this.children[this.children.length - 2];\r\n        this.removeChild(oldPart);\r\n        if (oldPart instanceof BlockMorph) {\r\n            scripts = this.parentThatIsA(ScriptsMorph);\r\n            if (scripts) {\r\n                scripts.add(oldPart);\r\n            }\r\n        }\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\n// MultiArgMorph events:\r\n\r\nMultiArgMorph.prototype.mouseClickLeft = function (pos) {\r\n    // prevent expansion in the palette\r\n    // (because it can be hard or impossible to collapse again)\r\n    if (!this.parentThatIsA(ScriptsMorph)) {\r\n        this.escalateEvent('mouseClickLeft', pos);\r\n        return;\r\n    }\r\n    // if the <shift> key is pressed, repeat action 3 times\r\n    var target = this.selectForEdit(),\r\n        arrows = target.arrows(),\r\n        leftArrow = arrows.children[0],\r\n        rightArrow = arrows.children[1],\r\n        repetition = target.world().currentKey === 16 ? 3 : 1,\r\n        i;\r\n\r\n    target.startLayout();\r\n    if (rightArrow.bounds.containsPoint(pos)) {\r\n        for (i = 0; i < repetition; i += 1) {\r\n            if (rightArrow.isVisible) {\r\n                target.addInput();\r\n            }\r\n        }\r\n    } else if (leftArrow.bounds.containsPoint(pos)) {\r\n        for (i = 0; i < repetition; i += 1) {\r\n            if (leftArrow.isVisible) {\r\n                target.removeInput();\r\n            }\r\n        }\r\n    } else {\r\n        target.escalateEvent('mouseClickLeft', pos);\r\n    }\r\n    target.endLayout();\r\n};\r\n\r\n// MultiArgMorph menu:\r\n\r\nMultiArgMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        block = this.parentThatIsA(BlockMorph),\r\n        key = '',\r\n        myself = this;\r\n    if (!StageMorph.prototype.enableCodeMapping) {\r\n        return this.parent.userMenu();\r\n    }\r\n    if (block) {\r\n        if (block instanceof RingMorph) {\r\n            key = 'parms_';\r\n        } else if (block.selector === 'doDeclareVariables') {\r\n            key = 'tempvars_';\r\n        }\r\n    }\r\n    menu.addItem(\r\n        'code list mapping...',\r\n        function () {myself.mapCodeList(key); }\r\n    );\r\n    menu.addItem(\r\n        'code item mapping...',\r\n        function () {myself.mapCodeItem(key); }\r\n    );\r\n    menu.addItem(\r\n        'code delimiter mapping...',\r\n        function () {myself.mapCodeDelimiter(key); }\r\n    );\r\n    return menu;\r\n};\r\n\r\n// MultiArgMorph code mapping\r\n\r\n/*\r\n    code mapping lets you use blocks to generate arbitrary text-based\r\n    source code that can be exported and compiled / embedded elsewhere,\r\n    it's not part of Snap's evaluator and not needed for Snap itself\r\n*/\r\n\r\nMultiArgMorph.prototype.mapCodeDelimiter = function (key) {\r\n    this.mapToCode(key + 'delim', 'list item delimiter');\r\n};\r\n\r\nMultiArgMorph.prototype.mapCodeList = function (key) {\r\n    this.mapToCode(key + 'list', 'list contents <#1>');\r\n};\r\n\r\nMultiArgMorph.prototype.mapCodeItem = function (key) {\r\n    this.mapToCode(key + 'item', 'list item <#1>');\r\n};\r\n\r\nMultiArgMorph.prototype.mapToCode = function (key, label) {\r\n    // private - open a dialog box letting the user map code via the GUI\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (code) {\r\n            StageMorph.prototype.codeMappings[key] = code;\r\n        },\r\n        this\r\n    ).promptCode(\r\n        'Code mapping - ' + label,\r\n        StageMorph.prototype.codeMappings[key] || '',\r\n        this.world()\r\n    );\r\n};\r\n\r\nMultiArgMorph.prototype.mappedCode = function (definitions) {\r\n    var block = this.parentThatIsA(BlockMorph),\r\n        key = '',\r\n        code,\r\n        items = '',\r\n        itemCode,\r\n        delim,\r\n        count = 0,\r\n        parts = [];\r\n\r\n    if (block) {\r\n        if (block instanceof RingMorph) {\r\n            key = 'parms_';\r\n        } else if (block.selector === 'doDeclareVariables') {\r\n            key = 'tempvars_';\r\n        }\r\n    }\r\n\r\n    code = StageMorph.prototype.codeMappings[key + 'list'] || '<#1>';\r\n    itemCode = StageMorph.prototype.codeMappings[key + 'item'] || '<#1>';\r\n    delim = StageMorph.prototype.codeMappings[key + 'delim'] || ' ';\r\n\r\n    this.inputs().forEach(function (input) {\r\n        parts.push(itemCode.replace(/<#1>/g, input.mappedCode(definitions)));\r\n    });\r\n    parts.forEach(function (part) {\r\n        if (count) {\r\n            items += delim;\r\n        }\r\n        items += part;\r\n        count += 1;\r\n    });\r\n    code = code.replace(/<#1>/g, items);\r\n    return code;\r\n};\r\n\r\n// MultiArgMorph arity evaluating:\r\n\r\nMultiArgMorph.prototype.evaluate = function () {\r\n    // this is usually overridden by the interpreter. This method is only\r\n    // called (and needed) for the variables menu.\r\n\r\n    var result = [];\r\n    this.inputs().forEach(function (slot) {\r\n        result.push(slot.evaluate());\r\n    });\r\n    return result;\r\n};\r\n\r\nMultiArgMorph.prototype.isEmptySlot = function () {\r\n    return this.canBeEmpty ? this.inputs().length === 0 : false;\r\n};\r\n\r\n// ArgLabelMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a label string that is wrapped around an ArgMorph, usually\r\n    a MultiArgMorph, so to indicate that it has been replaced entirely\r\n    for an embedded reporter block\r\n\r\n    I don't have a block spec, I get embedded automatically by the parent\r\n    block's argument replacement mechanism\r\n\r\n    My evaluation method is the identity function, i.e. I simply pass my\r\n    input's value along.\r\n*/\r\n\r\n// ArgLabelMorph inherits from ArgMorph:\r\n\r\nArgLabelMorph.prototype = new ArgMorph();\r\nArgLabelMorph.prototype.constructor = ArgLabelMorph;\r\nArgLabelMorph.uber = ArgMorph.prototype;\r\n\r\n// MultiArgMorph instance creation:\r\n\r\nfunction ArgLabelMorph(argMorph, labelTxt) {\r\n    this.init(argMorph, labelTxt);\r\n}\r\n\r\nArgLabelMorph.prototype.init = function (argMorph, labelTxt) {\r\n    var label;\r\n\r\n    this.labelText = localize(labelTxt || 'input list:');\r\n    ArgLabelMorph.uber.init.call(this, null, true); // silently\r\n\r\n    this.isStatic = true; // I cannot be exchanged\r\n\r\n    // ArgLabelMorphs are transparent\r\n    this.alpha = 0;\r\n    this.noticesTransparentclick = true;\r\n\r\n    // label text:\r\n    label = this.labelPart(this.labelText);\r\n    this.add(label);\r\n\r\n    // argMorph\r\n    this.add(argMorph);\r\n};\r\n\r\nArgLabelMorph.prototype.label = function () {\r\n    return this.children[0];\r\n};\r\n\r\nArgLabelMorph.prototype.argMorph = function () {\r\n    return this.children[1];\r\n};\r\n\r\n// ArgLabelMorph layout:\r\n\r\nArgLabelMorph.prototype.fixLayout = function () {\r\n    var label = this.label(),\r\n        shadowColor,\r\n        shadowOffset;\r\n\r\n    if (this.parent) {\r\n        this.color = this.parent.color;\r\n        shadowOffset = label.shadowOffset || new Point();\r\n\r\n        // determine the shadow color for zebra coloring:\r\n        if (shadowOffset.x < 0) {\r\n            shadowColor = this.parent.color.darker(this.labelContrast);\r\n        } else {\r\n            shadowColor = this.parent.color.lighter(this.labelContrast);\r\n        }\r\n\r\n        if (this.labelText !== '') {\r\n            if (!label.shadowColor.eq(shadowColor)) {\r\n                label.shadowColor = shadowColor;\r\n                label.shadowOffset = shadowOffset;\r\n                label.drawNew();\r\n            }\r\n        }\r\n    }\r\n    ArgLabelMorph.uber.fixLayout.call(this);\r\n    if (this.parent) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\nArgLabelMorph.prototype.refresh = function () {\r\n    this.inputs().forEach(function (input) {\r\n        input.drawNew();\r\n    });\r\n};\r\n\r\nArgLabelMorph.prototype.drawNew = function () {\r\n    ArgLabelMorph.uber.drawNew.call(this);\r\n    this.refresh();\r\n};\r\n\r\n// ArgLabelMorph label color:\r\n\r\nArgLabelMorph.prototype.setLabelColor = function (\r\n    textColor,\r\n    shadowColor,\r\n    shadowOffset\r\n) {\r\n    if (this.labelText !== '') {\r\n        var label = this.label();\r\n        label.color = textColor;\r\n        label.shadowColor = shadowColor;\r\n        label.shadowOffset = shadowOffset;\r\n        label.drawNew();\r\n    }\r\n};\r\n\r\n// ArgLabelMorph events:\r\n\r\nArgLabelMorph.prototype.reactToGrabOf = function () {\r\n    if (this.parent instanceof SyntaxElementMorph) {\r\n        this.parent.revertToDefaultInput(this);\r\n    }\r\n};\r\n\r\n// ArgLabelMorph evaluating:\r\n\r\nArgLabelMorph.prototype.evaluate = function () {\r\n    // this is usually overridden by the interpreter. This method is only\r\n    // called (and needed) for the variables menu.\r\n\r\n    return this.argMorph().evaluate();\r\n};\r\n\r\nArgLabelMorph.prototype.isEmptySlot = function () {\r\n    return false;\r\n};\r\n\r\n// FunctionSlotMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an unevaluated, non-editable, rf-colored, rounded or diamond\r\n    input slot. My current (only) use is in the THE BLOCK block.\r\n\r\n    My command spec is %f\r\n*/\r\n\r\n// FunctionSlotMorph inherits from ArgMorph:\r\n\r\nFunctionSlotMorph.prototype = new ArgMorph();\r\nFunctionSlotMorph.prototype.constructor = FunctionSlotMorph;\r\nFunctionSlotMorph.uber = ArgMorph.prototype;\r\n\r\n// FunctionSlotMorph instance creation:\r\n\r\nfunction FunctionSlotMorph(isPredicate) {\r\n    this.init(isPredicate);\r\n}\r\n\r\nFunctionSlotMorph.prototype.init = function (isPredicate, silently) {\r\n    FunctionSlotMorph.uber.init.call(this, null, true); // silently\r\n    this.isPredicate = isPredicate || false;\r\n    this.color = this.rfColor;\r\n    this.setExtent(\r\n        new Point(\r\n            (this.fontSize + this.edge * 2) * 2,\r\n            this.fontSize + this.edge * 2\r\n        ),\r\n        silently\r\n    );\r\n};\r\n\r\nFunctionSlotMorph.prototype.getSpec = function () {\r\n    return '%f';\r\n};\r\n\r\n// FunctionSlotMorph drawing:\r\n\r\nFunctionSlotMorph.prototype.drawNew = function () {\r\n    var context, borderColor;\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if (this.parent) {\r\n        borderColor = this.parent.color;\r\n    } else {\r\n        borderColor = new Color(120, 120, 120);\r\n    }\r\n\r\n    // cache my border colors\r\n    this.cachedClr = borderColor.toString();\r\n    this.cachedClrBright = borderColor.lighter(this.contrast)\r\n        .toString();\r\n    this.cachedClrDark = borderColor.darker(this.contrast).toString();\r\n\r\n    if (this.isPredicate) {\r\n        this.drawDiamond(context);\r\n    } else {\r\n        this.drawRounded(context);\r\n    }\r\n};\r\n\r\nFunctionSlotMorph.prototype.drawRounded = function (context) {\r\n    var h = this.height(),\r\n        r = Math.min(this.rounding, h / 2),\r\n        w = this.width(),\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n\r\n    // top left:\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // top right:\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // bottom left corner\r\n    context.strokeStyle = this.cachedClr; //gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r - shift,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    context.strokeStyle = this.cachedClr; //gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r - shift,\r\n        radians(-90),\r\n        radians(0),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, shift);\r\n    context.lineTo(w - r + shift, shift);\r\n    context.stroke();\r\n\r\n    // top edge: left corner\r\n    gradient = context.createRadialGradient(\r\n        r,\r\n        r,\r\n        r - this.edge,\r\n        r,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r - shift,\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // left edge: straight vertical line\r\n    gradient = context.createLinearGradient(0, 0, this.edge, 0);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, r);\r\n    context.lineTo(shift, h - r);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createRadialGradient(\r\n        w - r,\r\n        h - r,\r\n        r - this.edge,\r\n        w - r,\r\n        h - r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r - shift,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, h - shift);\r\n    context.lineTo(w - r + shift, h - shift);\r\n    context.stroke();\r\n\r\n    // right edge: straight vertical line\r\n    gradient = context.createLinearGradient(w - this.edge, 0, w, 0);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, r + shift);\r\n    context.lineTo(w - shift, h - r);\r\n    context.stroke();\r\n\r\n};\r\n\r\nFunctionSlotMorph.prototype.drawDiamond = function (context) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        h2 = Math.floor(h / 2),\r\n        r = Math.min(this.rounding, h2),\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n\r\n    context.moveTo(0, h2);\r\n    context.lineTo(r, 0);\r\n    context.lineTo(w - r, 0);\r\n    context.lineTo(w, h2);\r\n    context.lineTo(w - r, h);\r\n    context.lineTo(r, h);\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // half-tone edges\r\n    // bottom left corner\r\n    context.strokeStyle = this.cachedClr;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, h - shift);\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    context.strokeStyle = this.cachedClr;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, h2);\r\n    context.lineTo(w - r, shift);\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n    // top edge: left corner\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        r,\r\n        0\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, shift);\r\n    context.stroke();\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r, shift);\r\n    context.lineTo(w - r, shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createLinearGradient(\r\n        w - r,\r\n        0,\r\n        w,\r\n        0\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - r, h - shift);\r\n    context.lineTo(w - shift, h2);\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r + shift, h - shift);\r\n    context.lineTo(w - r - shift, h - shift);\r\n    context.stroke();\r\n};\r\n\r\n// ReporterSlotMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a ReporterBlock-shaped input slot. I can nest as well as\r\n    accept reporter blocks (containing reified scripts).\r\n\r\n    my most important accessor is\r\n\r\n    nestedBlock()    - answer the reporter block I encompass, if any\r\n\r\n    My command spec is %r for reporters (round) and %p for\r\n    predicates (diamond)\r\n\r\n    evaluate() returns my nested block or null\r\n*/\r\n\r\n// ReporterSlotMorph inherits from FunctionSlotMorph:\r\n\r\nReporterSlotMorph.prototype = new FunctionSlotMorph();\r\nReporterSlotMorph.prototype.constructor = ReporterSlotMorph;\r\nReporterSlotMorph.uber = FunctionSlotMorph.prototype;\r\n\r\n// ReporterSlotMorph instance creation:\r\n\r\nfunction ReporterSlotMorph(isPredicate) {\r\n    this.init(isPredicate);\r\n}\r\n\r\nReporterSlotMorph.prototype.init = function (isPredicate) {\r\n    ReporterSlotMorph.uber.init.call(this, isPredicate, true);\r\n    this.add(this.emptySlot());\r\n    this.fixLayout();\r\n};\r\n\r\nReporterSlotMorph.prototype.emptySlot = function () {\r\n    var empty = new ArgMorph(),\r\n        shrink = this.rfBorder * 2 + this.edge * 2;\r\n    empty.color = this.rfColor;\r\n    empty.alpha = 0;\r\n    empty.setExtent(new Point(\r\n        (this.fontSize + this.edge * 2) * 2 - shrink,\r\n        this.fontSize + this.edge * 2 - shrink\r\n    ));\r\n    return empty;\r\n};\r\n\r\n// ReporterSlotMorph accessing:\r\n\r\nReporterSlotMorph.prototype.getSpec = function () {\r\n    return '%r';\r\n};\r\n\r\nReporterSlotMorph.prototype.contents = function () {\r\n    return this.children[0];\r\n};\r\n\r\nReporterSlotMorph.prototype.nestedBlock = function () {\r\n    var contents = this.contents();\r\n    return contents instanceof ReporterBlockMorph ? contents : null;\r\n};\r\n\r\n// ReporterSlotMorph evaluating:\r\n\r\nReporterSlotMorph.prototype.evaluate = function () {\r\n    return this.nestedBlock();\r\n};\r\n\r\nReporterSlotMorph.prototype.isEmptySlot = function () {\r\n    return this.nestedBlock() === null;\r\n};\r\n\r\n// ReporterSlotMorph layout:\r\n\r\nReporterSlotMorph.prototype.fixLayout = function () {\r\n    var contents = this.contents();\r\n    this.setExtent(contents.extent().add(\r\n        this.edge * 2 + this.rfBorder * 2\r\n    ));\r\n    contents.setCenter(this.center());\r\n    if (this.parent) {\r\n        if (this.parent.fixLayout) {\r\n            this.parent.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\n// RingReporterSlotMorph ///////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a ReporterBlock-shaped input slot for use in RingMorphs.\r\n    I can only nest reporter blocks (both round and diamond).\r\n\r\n    My command spec is %rr for reporters (round) and %rp for\r\n    predicates (diamond)\r\n\r\n    evaluate() returns my nested block or null\r\n    (inherited from ReporterSlotMorph\r\n*/\r\n\r\n// ReporterSlotMorph inherits from FunctionSlotMorph:\r\n\r\nRingReporterSlotMorph.prototype = new ReporterSlotMorph();\r\nRingReporterSlotMorph.prototype.constructor = RingReporterSlotMorph;\r\nRingReporterSlotMorph.uber = ReporterSlotMorph.prototype;\r\n\r\n// ReporterSlotMorph preferences settings:\r\n\r\nRingReporterSlotMorph.prototype.rfBorder\r\n    = RingCommandSlotMorph.prototype.rfBorder;\r\n\r\nRingReporterSlotMorph.prototype.edge\r\n    = RingCommandSlotMorph.prototype.edge;\r\n\r\n// RingReporterSlotMorph instance creation:\r\n\r\nfunction RingReporterSlotMorph(isPredicate) {\r\n    this.init(isPredicate);\r\n}\r\n\r\nRingReporterSlotMorph.prototype.init = function (isPredicate) {\r\n    RingReporterSlotMorph.uber.init.call(this, isPredicate, true);\r\n    this.alpha = RingMorph.prototype.alpha;\r\n    this.contrast = RingMorph.prototype.contrast;\r\n    this.isHole = true;\r\n};\r\n\r\n// RingReporterSlotMorph accessing:\r\n\r\nRingReporterSlotMorph.prototype.getSpec = function () {\r\n    return '%rr';\r\n};\r\n\r\nRingReporterSlotMorph.prototype.replaceInput = function (source, target) {\r\n    RingReporterSlotMorph.uber.replaceInput.call(this, source, target);\r\n    if (this.parent instanceof RingMorph) {\r\n        this.parent.vanishForSimilar();\r\n    }\r\n};\r\n\r\n// RingReporterSlotMorph drawing:\r\n\r\nRingReporterSlotMorph.prototype.drawRounded = function (context) {\r\n    var h = this.height(),\r\n        r = Math.min(this.rounding, h / 2),\r\n        w = this.width(),\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.cachedClr; //this.color.toString();\r\n\r\n    // top half:\r\n    context.beginPath();\r\n    context.moveTo(0, h / 2);\r\n\r\n    // top left:\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n\r\n    // top right:\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r,\r\n        radians(-90),\r\n        radians(-0),\r\n        false\r\n    );\r\n\r\n    context.lineTo(w, h / 2);\r\n    context.lineTo(w, 0);\r\n    context.lineTo(0, 0);\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    // bottom half:\r\n    context.beginPath();\r\n    context.moveTo(w, h / 2);\r\n\r\n    // bottom right:\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n\r\n    // bottom left:\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n\r\n    context.lineTo(0, h / 2);\r\n    context.lineTo(0, h);\r\n    context.lineTo(w, h);\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // bottom left corner\r\n    context.strokeStyle = this.cachedClr; //gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        h - r,\r\n        r - shift,\r\n        radians(90),\r\n        radians(180),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    context.strokeStyle = this.cachedClr; //gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        r,\r\n        r - shift,\r\n        radians(-90),\r\n        radians(0),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, shift);\r\n    context.lineTo(w - r + shift, shift);\r\n    context.stroke();\r\n\r\n    // top edge: left corner\r\n    gradient = context.createRadialGradient(\r\n        r,\r\n        r,\r\n        r - this.edge,\r\n        r,\r\n        r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        r,\r\n        r,\r\n        r - shift,\r\n        radians(180),\r\n        radians(270),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // left edge: straight vertical line\r\n    gradient = context.createLinearGradient(0, 0, this.edge, 0);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, r);\r\n    context.lineTo(shift, h - r);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createRadialGradient(\r\n        w - r,\r\n        h - r,\r\n        r - this.edge,\r\n        w - r,\r\n        h - r,\r\n        r\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.arc(\r\n        w - r,\r\n        h - r,\r\n        r - shift,\r\n        radians(0),\r\n        radians(90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r - shift, h - shift);\r\n    context.lineTo(w - r + shift, h - shift);\r\n    context.stroke();\r\n\r\n    // right edge: straight vertical line\r\n    gradient = context.createLinearGradient(w - this.edge, 0, w, 0);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, r + shift);\r\n    context.lineTo(w - shift, h - r);\r\n    context.stroke();\r\n};\r\n\r\nRingReporterSlotMorph.prototype.drawDiamond = function (context) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        h2 = Math.floor(h / 2),\r\n        r = Math.min(this.rounding, h2),\r\n        shift = this.edge / 2,\r\n        gradient;\r\n\r\n    // draw the 'flat' shape:\r\n    context.fillStyle = this.cachedClr;\r\n    context.beginPath();\r\n\r\n    context.moveTo(0, 0);\r\n    context.lineTo(0, h2);\r\n    context.lineTo(r, 0);\r\n    context.lineTo(w - r, 0);\r\n    context.lineTo(w, h2);\r\n    context.lineTo(w, 0);\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    context.moveTo(w, h2);\r\n    context.lineTo(w - r, h);\r\n    context.lineTo(r, h);\r\n    context.lineTo(0, h2);\r\n    context.lineTo(0, h);\r\n    context.lineTo(w, h);\r\n\r\n    context.closePath();\r\n    context.fill();\r\n\r\n    if (MorphicPreferences.isFlat) {return; }\r\n\r\n    // add 3D-Effect:\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    // half-tone edges\r\n    // bottom left corner\r\n    context.strokeStyle = this.cachedClr;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, h - shift);\r\n    context.stroke();\r\n\r\n    // top right corner\r\n    context.strokeStyle = this.cachedClr;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, h2);\r\n    context.lineTo(w - r, shift);\r\n    context.stroke();\r\n\r\n    // normal gradient edges\r\n    // top edge: left corner\r\n\r\n    context.shadowOffsetX = shift;\r\n    context.shadowOffsetY = shift;\r\n    context.shadowBlur = this.edge;\r\n    context.shadowColor = this.color.darker(80).toString();\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        r,\r\n        0\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(shift, h2);\r\n    context.lineTo(r, shift);\r\n    context.stroke();\r\n\r\n    // top edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r, shift);\r\n    context.lineTo(w - r, shift);\r\n    context.stroke();\r\n\r\n    context.shadowOffsetX = 0;\r\n    context.shadowOffsetY = 0;\r\n    context.shadowBlur = 0;\r\n\r\n    // bottom edge: right corner\r\n    gradient = context.createLinearGradient(\r\n        w - r,\r\n        0,\r\n        w,\r\n        0\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - r, h - shift);\r\n    context.lineTo(w - shift, h2);\r\n    context.stroke();\r\n\r\n    // bottom edge: straight line\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(r + shift, h - shift);\r\n    context.lineTo(w - r - shift, h - shift);\r\n    context.stroke();\r\n};\r\n\r\n// CommentMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an editable, multi-line non-scrolling text window. I can be collapsed\r\n    to a single abbreviated line or expanded to full. My width can be adjusted\r\n    by the user, by height is determined by the size of my text body. I can be\r\n    either placed in a scripting area or \"stuck\" to a block.\r\n*/\r\n\r\n// CommentMorph inherits from BoxMorph:\r\n\r\nCommentMorph.prototype = new BoxMorph();\r\nCommentMorph.prototype.constructor = CommentMorph;\r\nCommentMorph.uber = BoxMorph.prototype;\r\n\r\n// CommentMorph preferences settings (pseudo-inherited from SyntaxElement):\r\n\r\nCommentMorph.prototype.refreshScale = function () {\r\n    CommentMorph.prototype.fontSize = SyntaxElementMorph.prototype.fontSize;\r\n    CommentMorph.prototype.padding = 5 * SyntaxElementMorph.prototype.scale;\r\n    CommentMorph.prototype.rounding = 8 * SyntaxElementMorph.prototype.scale;\r\n};\r\n\r\nCommentMorph.prototype.refreshScale();\r\n\r\n// CommentMorph instance creation:\r\n\r\nfunction CommentMorph(contents) {\r\n    this.init(contents);\r\n}\r\n\r\nCommentMorph.prototype.init = function (contents) {\r\n    var myself = this,\r\n        scale = SyntaxElementMorph.prototype.scale;\r\n    this.block = null; // optional anchor block\r\n    this.stickyOffset = null; // not to be persisted\r\n    this.isCollapsed = false;\r\n    this.titleBar = new BoxMorph(\r\n        this.rounding,\r\n        1.000001 * scale, // shadow bug in Chrome,\r\n        new Color(255, 255, 180)\r\n    );\r\n    this.titleBar.color = new Color(255, 255, 180);\r\n    this.titleBar.setHeight(fontHeight(this.fontSize) + this.padding);\r\n    this.title = null;\r\n    this.arrow = new ArrowMorph(\r\n        'down',\r\n        this.fontSize\r\n    );\r\n    this.arrow.noticesTransparentClick = true;\r\n    this.arrow.mouseClickLeft = function () {myself.toggleExpand(); };\r\n    this.contents = new TextMorph(\r\n        contents || localize('add comment here...'),\r\n        this.fontSize\r\n    );\r\n    this.contents.isEditable = true;\r\n    this.contents.enableSelecting();\r\n    this.contents.maxWidth = 90 * scale;\r\n    this.contents.drawNew();\r\n    this.handle = new HandleMorph(\r\n        this.contents,\r\n        80,\r\n        this.fontSize * 2,\r\n        -2,\r\n        -2\r\n    );\r\n    this.handle.setExtent(new Point(11 * scale, 11 * scale));\r\n    this.anchor = null;\r\n\r\n    CommentMorph.uber.init.call(\r\n        this,\r\n        this.rounding,\r\n        1.000001 * scale, // shadow bug in Chrome,\r\n        new Color(255, 255, 180)\r\n    );\r\n    this.color = new Color(255, 255, 220);\r\n    this.isDraggable = true;\r\n    this.add(this.titleBar);\r\n    this.add(this.arrow);\r\n    this.add(this.contents);\r\n    this.add(this.handle);\r\n\r\n    this.fixLayout();\r\n};\r\n\r\n// CommentMorph ops:\r\n\r\nCommentMorph.prototype.fullCopy = function () {\r\n    var cpy = new CommentMorph(this.contents.text);\r\n    cpy.isCollapsed = this.isCollapsed;\r\n    cpy.setTextWidth(this.textWidth());\r\n    if (this.selectionID) { // for copy on write\r\n        cpy.selectionID = true;\r\n    }\r\n    return cpy;\r\n};\r\n\r\nCommentMorph.prototype.setTextWidth = function (pixels) {\r\n    this.contents.maxWidth = pixels;\r\n    this.contents.drawNew();\r\n    this.fixLayout();\r\n};\r\n\r\nCommentMorph.prototype.textWidth = function () {\r\n    return this.contents.maxWidth;\r\n};\r\n\r\nCommentMorph.prototype.text = function () {\r\n    return this.contents.text;\r\n};\r\n\r\nCommentMorph.prototype.toggleExpand = function () {\r\n    this.isCollapsed = !this.isCollapsed;\r\n    this.fixLayout();\r\n    this.align();\r\n};\r\n\r\n// CommentMorph layout:\r\n\r\nCommentMorph.prototype.layoutChanged = function () {\r\n    // react to a change of the contents area\r\n    this.fixLayout();\r\n    this.align();\r\n};\r\n\r\nCommentMorph.prototype.fixLayout = function () {\r\n    var label,\r\n        tw = this.contents.width() + 2 * this.padding,\r\n        myself = this,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    if (this.title) {\r\n        this.title.destroy();\r\n        this.title = null;\r\n    }\r\n    if (this.isCollapsed) {\r\n        this.contents.hide();\r\n        this.title = new FrameMorph();\r\n        this.title.alpha = 0;\r\n        this.title.acceptsDrops = false;\r\n        label = new StringMorph(\r\n            this.contents.text,\r\n            this.fontSize,\r\n            null, // style (sans-serif)\r\n            true // bold\r\n        );\r\n        label.rootForGrab = function () {\r\n            return myself;\r\n        };\r\n        this.title.add(label);\r\n        this.title.setHeight(label.height());\r\n        this.title.setWidth(\r\n            tw - this.arrow.width() - this.padding * 2 - this.rounding\r\n        );\r\n        this.add(this.title);\r\n    } else {\r\n        this.contents.show();\r\n    }\r\n    this.titleBar.setWidth(tw);\r\n    this.contents.setLeft(this.titleBar.left() + this.padding);\r\n    this.contents.setTop(this.titleBar.bottom() + this.padding);\r\n    this.arrow.direction = this.isCollapsed ? 'right' : 'down';\r\n    this.arrow.drawNew();\r\n    this.arrow.setCenter(this.titleBar.center());\r\n    this.arrow.setLeft(this.titleBar.left() + this.padding);\r\n    if (this.title) {\r\n        this.title.setPosition(\r\n            this.arrow.topRight().add(new Point(this.padding, 0))\r\n        );\r\n    }\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n    this.silentSetHeight(\r\n        this.titleBar.height()\r\n            + (this.isCollapsed ? 0 :\r\n                    this.padding\r\n                        + this.contents.height()\r\n                        + this.padding)\r\n    );\r\n    this.silentSetWidth(this.titleBar.width());\r\n    this.drawNew();\r\n    this.handle.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// CommentMorph menu:\r\n\r\nCommentMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        myself = this;\r\n\r\n    menu.addItem(\r\n        \"duplicate\",\r\n        function () {\r\n            myself.fullCopy().pickUp(myself.world());\r\n        },\r\n        'make a copy\\nand pick it up'\r\n    );\r\n    menu.addItem(\"delete\", 'userDestroy');\r\n    menu.addItem(\r\n        \"comment pic...\",\r\n        function () {\r\n            var ide = myself.parentThatIsA(IDE_Morph);\r\n            ide.saveCanvasAs(\r\n                myself.fullImageClassic(),\r\n                (ide.projectName || localize('untitled')) + ' ' +\r\n                    localize('comment pic')\r\n            );\r\n        },\r\n        'open a new window\\nwith a picture of this comment'\r\n    );\r\n    return menu;\r\n};\r\n\r\nCommentMorph.prototype.userDestroy = function () {\r\n    this.selectForEdit().destroy(); // enable copy-on-edit\r\n};\r\n\r\n// CommentMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children, so that my instances get restored correctly when\r\n    switching back out of app mode.\r\n*/\r\n\r\nCommentMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n};\r\n\r\nCommentMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n};\r\n\r\n// CommentMorph dragging & dropping\r\n\r\nCommentMorph.prototype.prepareToBeGrabbed = function (hand) {\r\n\r\n    // disassociate from the block I'm posted to\r\n    if (this.block) {\r\n        this.block.comment = null;\r\n        this.block = null;\r\n    }\r\n    if (this.anchor) {\r\n        this.anchor.destroy();\r\n        this.anchor = null;\r\n        // fix shadow, because it was added earlier\r\n        this.removeShadow();\r\n        this.addShadow();\r\n    }\r\n};\r\n\r\nCommentMorph.prototype.selectForEdit =\r\n    SyntaxElementMorph.prototype.selectForEdit;\r\n\r\nCommentMorph.prototype.snap = function (hand) {\r\n\r\n    // passing the hand is optional (for when blocks are dragged & dropped)\r\n    var scripts = this.parent,\r\n        target;\r\n\r\n    if (!(scripts instanceof ScriptsMorph)) {\r\n        return null;\r\n    }\r\n    scripts.clearDropInfo();\r\n    target = scripts.closestBlock(this, hand);\r\n    if (target !== null) {\r\n        target.comment = this;\r\n        this.block = target;\r\n        if (this.snapSound) {\r\n            this.snapSound.play();\r\n        }\r\n        scripts.lastDropTarget = {element: target};\r\n    }\r\n    this.align();\r\n    scripts.lastDroppedBlock = this;\r\n    if (hand) {\r\n        scripts.recordDrop(hand.grabOrigin);\r\n    }\r\n\r\n};\r\n\r\n// CommentMorph sticking to blocks\r\n\r\nCommentMorph.prototype.align = function (topBlock, ignoreLayer) {\r\n    if (this.block) {\r\n        var top = topBlock || this.block.topBlock(),\r\n            affectedBlocks,\r\n            tp,\r\n            bottom,\r\n            rightMost,\r\n            scripts = top.parentThatIsA(ScriptsMorph);\r\n        this.setTop(this.block.top() + this.block.corner);\r\n        tp = this.top();\r\n        bottom = this.bottom();\r\n        affectedBlocks = top.allChildren().filter(function (child) {\r\n            return child instanceof BlockMorph &&\r\n                child.bottom() > tp &&\r\n                child.top() < bottom;\r\n        });\r\n        rightMost = Math.max.apply(\r\n            null,\r\n            affectedBlocks.map(function (block) {return block.right(); })\r\n        );\r\n\r\n        this.setLeft(rightMost + 5);\r\n        if (!ignoreLayer && scripts) {\r\n            scripts.addBack(this); // push to back and show\r\n        }\r\n\r\n        if (!this.anchor) {\r\n            this.anchor = new Morph();\r\n            this.anchor.color = this.titleBar.color;\r\n        }\r\n        this.anchor.silentSetPosition(new Point(\r\n            this.block.right(),\r\n            this.top() + this.edge\r\n        ));\r\n        this.anchor.bounds.corner = new Point(\r\n            this.left(),\r\n            this.top() + this.edge + 1\r\n        );\r\n        this.anchor.drawNew();\r\n        this.addBack(this.anchor);\r\n        this.anchor.changed();\r\n    }\r\n};\r\n\r\nCommentMorph.prototype.startFollowing = function (topBlock, world) {\r\n    this.align(topBlock);\r\n    world.add(this);\r\n    this.addShadow();\r\n    this.stickyOffset = this.position().subtract(this.block.position());\r\n    this.step = function () {\r\n        if (!this.block) { // kludge - only needed for \"redo\"\r\n            this.stopFollowing();\r\n            return;\r\n        }\r\n        this.setPosition(this.block.position().add(this.stickyOffset));\r\n    };\r\n};\r\n\r\nCommentMorph.prototype.stopFollowing = function () {\r\n    this.removeShadow();\r\n    delete this.step;\r\n};\r\n\r\nCommentMorph.prototype.destroy = function () {\r\n    if (this.block) {\r\n        this.block.comment = null;\r\n    }\r\n    CommentMorph.uber.destroy.call(this);\r\n};\r\n\r\nCommentMorph.prototype.stackHeight = function () {\r\n    return this.height();\r\n};\r\n\r\n// ScriptFocusMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I offer keyboard navigation for syntax elements, blocks and scripts:\r\n\r\n    activate:\r\n      - shift + click on a scripting pane's background\r\n      - shift + click on any block\r\n      - shift + enter in the IDE's edit mode\r\n\r\n    stop editing:\r\n      - left-click on scripting pane's background\r\n      - esc\r\n\r\n    navigate among scripts:\r\n      - tab: next script\r\n      - backtab (shift + tab): last script\r\n\r\n    start editing a new script:\r\n      - shift + enter\r\n\r\n    navigate among commands within a script:\r\n      - down arrow: next command\r\n      - up arrow: last command\r\n\r\n    navigate among all elements within a script:\r\n      - right arrow: next element (block or input)\r\n      - left arrow: last element\r\n\r\n    move the currently edited script (stack of blocks):\r\n      - shift + arrow keys (left, right, up, down)\r\n\r\n    editing scripts:\r\n\r\n      - backspace:\r\n        * delete currently focused reporter\r\n        * delete command above current insertion mark (blinking)\r\n        * collapse currently focused variadic input by one element\r\n\r\n      - enter:\r\n        * edit currently focused input slot\r\n        * expand currently focused variadic input by one element\r\n\r\n      - space:\r\n        * activate currently focused input slot's pull-down menu, if any\r\n        * show a menu of reachable variables for the focused input or reporter\r\n\r\n      - any other key:\r\n        start searching for insertable matching blocks\r\n\r\n      - in menus triggered by this feature:\r\n        * navigate with up / down arrow keys\r\n        * trigger selection with enter\r\n        * cancel menu with esc\r\n\r\n      - in the search bar triggered b this feature:\r\n        * keep typing / deleting to narrow and update matches\r\n        * navigate among shown matches with up / down arrow keys\r\n        * insert selected match at the focus' position with enter\r\n        * cancel searching and inserting with esc\r\n\r\n    running the currently edited script:\r\n        * shift+ctrl+enter simulates clicking the edited script with the mouse\r\n*/\r\n\r\n// ScriptFocusMorph inherits from BoxMorph:\r\n\r\nScriptFocusMorph.prototype = new BoxMorph();\r\nScriptFocusMorph.prototype.constructor = ScriptFocusMorph;\r\nScriptFocusMorph.uber = BoxMorph.prototype;\r\n\r\n// ScriptFocusMorph instance creation:\r\n\r\nfunction ScriptFocusMorph(editor, initialElement, position) {\r\n    this.init(editor, initialElement, position);\r\n}\r\n\r\nScriptFocusMorph.prototype.init = function (\r\n    editor,\r\n    initialElement,\r\n    position\r\n) {\r\n    this.editor = editor; // a ScriptsMorph\r\n    this.element = initialElement;\r\n    this.atEnd = false;\r\n    ScriptFocusMorph.uber.init.call(this);\r\n    if (this.element instanceof ScriptsMorph) {\r\n        this.setPosition(position);\r\n    }\r\n};\r\n\r\n// ScriptFocusMorph keyboard focus:\r\n\r\nScriptFocusMorph.prototype.getFocus = function (world) {\r\n    if (!world) {world = this.world(); }\r\n    if (world && world.keyboardReceiver !== this) {\r\n        world.stopEditing();\r\n    }\r\n    world.keyboardReceiver = this;\r\n    this.fixLayout();\r\n    this.editor.updateToolbar();\r\n};\r\n\r\n// ScriptFocusMorph layout:\r\n\r\nScriptFocusMorph.prototype.fixLayout = function () {\r\n    this.changed();\r\n    if (this.element instanceof CommandBlockMorph ||\r\n            this.element instanceof CommandSlotMorph ||\r\n            this.element instanceof ScriptsMorph) {\r\n        this.manifestStatement();\r\n    } else {\r\n        this.manifestExpression();\r\n    }\r\n    this.editor.add(this); // come to front\r\n    this.scrollIntoView();\r\n    this.changed();\r\n};\r\n\r\nScriptFocusMorph.prototype.manifestStatement = function () {\r\n    var newScript = this.element instanceof ScriptsMorph,\r\n        y = this.element.top();\r\n    this.border = 0;\r\n    this.edge = 0;\r\n    this.alpha = 1;\r\n    this.color = this.editor.feedbackColor;\r\n    this.setExtent(new Point(\r\n        newScript ?\r\n                SyntaxElementMorph.prototype.hatWidth : this.element.width(),\r\n        Math.max(\r\n            SyntaxElementMorph.prototype.corner,\r\n            SyntaxElementMorph.prototype.feedbackMinHeight\r\n        )\r\n    ));\r\n    if (this.element instanceof CommandSlotMorph) {\r\n        y += SyntaxElementMorph.prototype.corner;\r\n    } else if (this.atEnd) {\r\n        y = this.element.bottom();\r\n    }\r\n    if (!newScript) {\r\n        this.setPosition(new Point(\r\n            this.element.left(),\r\n            y\r\n        ));\r\n    }\r\n    this.fps = 2;\r\n    this.show();\r\n    this.step = function () {\r\n        this.toggleVisibility();\r\n    };\r\n};\r\n\r\nScriptFocusMorph.prototype.manifestExpression = function () {\r\n    this.edge = SyntaxElementMorph.prototype.rounding;\r\n    this.border = Math.max(\r\n        SyntaxElementMorph.prototype.edge,\r\n        3\r\n    );\r\n    this.color = this.editor.feedbackColor.copy();\r\n    this.color.a = 0.5;\r\n    this.borderColor = this.editor.feedbackColor;\r\n\r\n    this.bounds = this.element.fullBounds()\r\n        .expandBy(Math.max(\r\n            SyntaxElementMorph.prototype.edge * 2,\r\n            SyntaxElementMorph.prototype.reporterDropFeedbackPadding\r\n        ));\r\n    this.drawNew();\r\n    delete this.fps;\r\n    delete this.step;\r\n    this.show();\r\n};\r\n\r\n// ScriptFocusMorph editing\r\n\r\nScriptFocusMorph.prototype.trigger = function () {\r\n    var current = this.element;\r\n    if (current instanceof MultiArgMorph) {\r\n        if (current.arrows().children[1].isVisible) {\r\n            current.addInput();\r\n            this.fixLayout();\r\n        }\r\n        return;\r\n    }\r\n    if (current.parent instanceof TemplateSlotMorph) {\r\n        current.mouseClickLeft();\r\n        return;\r\n    }\r\n    if (current instanceof BooleanSlotMorph) {\r\n        current.toggleValue();\r\n        return;\r\n    }\r\n    if (current instanceof InputSlotMorph) {\r\n        if (!current.isReadOnly) {\r\n            delete this.fps;\r\n            delete this.step;\r\n            this.hide();\r\n            this.world().onNextStep = function () {\r\n                current.contents().edit();\r\n                current.contents().selectAll();\r\n            };\r\n        } else if (current.choices) {\r\n            current.dropDownMenu(true);\r\n            delete this.fps;\r\n            delete this.step;\r\n            this.hide();\r\n        }\r\n    }\r\n};\r\n\r\nScriptFocusMorph.prototype.menu = function () {\r\n    var current = this.element;\r\n    if (current instanceof InputSlotMorph && current.choices) {\r\n        current.dropDownMenu(true);\r\n        delete this.fps;\r\n        delete this.step;\r\n        this.hide();\r\n    } else {\r\n        this.insertVariableGetter();\r\n    }\r\n};\r\n\r\nScriptFocusMorph.prototype.deleteLastElement = function () {\r\n    var current = this.element;\r\n    if (current.parent instanceof ScriptsMorph) {\r\n        if (this.atEnd || current instanceof ReporterBlockMorph) {\r\n            current.destroy();\r\n            this.element = this.editor;\r\n            this.atEnd = false;\r\n        }\r\n    } else if (current instanceof MultiArgMorph) {\r\n        if (current.arrows().children[0].isVisible) {\r\n            current.removeInput();\r\n        }\r\n    } else if (current instanceof BooleanSlotMorph) {\r\n        if (!current.isStatic) {\r\n            current.setContents(null);\r\n        }\r\n    } else if (current instanceof ReporterBlockMorph) {\r\n        if (!current.isTemplate) {\r\n            this.lastElement();\r\n            current.prepareToBeGrabbed();\r\n            current.destroy();\r\n        }\r\n    } else if (current instanceof CommandBlockMorph) {\r\n        if (this.atEnd) {\r\n            this.element = current.parent;\r\n            current.userDestroy();\r\n        } else {\r\n            if (current.parent instanceof CommandBlockMorph) {\r\n                current.parent.userDestroy();\r\n            }\r\n        }\r\n    }\r\n    this.editor.adjustBounds();\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.insertBlock = function (block) {\r\n    var pb, stage, ide, rcvr;\r\n    block.isTemplate = false;\r\n    block.isDraggable = true;\r\n\r\n\r\n\r\n    if (block.snapSound) {\r\n        block.snapSound.play();\r\n    }\r\n\r\n    if (this.element instanceof ScriptsMorph) {\r\n        this.editor.add(block);\r\n        this.element = block;\r\n        if (block instanceof CommandBlockMorph) {\r\n            block.setLeft(this.left());\r\n            if (block.isStop()) {\r\n                block.setTop(this.top());\r\n            } else {\r\n                block.setBottom(this.top());\r\n                this.atEnd = true;\r\n            }\r\n        } else {\r\n            block.setCenter(this.center());\r\n            block.setLeft(this.left());\r\n        }\r\n    } else if (this.element instanceof CommandBlockMorph) {\r\n        if (this.atEnd) {\r\n            this.element.nextBlock(block);\r\n            this.element = block;\r\n            this.fixLayout();\r\n        } else {\r\n            // to be done: special case if block.isStop()\r\n            pb = this.element.parent;\r\n            if (pb instanceof ScriptsMorph) { // top block\r\n                block.setLeft(this.element.left());\r\n                block.setBottom(this.element.top() + this.element.corner);\r\n                this.editor.add(block);\r\n                block.nextBlock(this.element);\r\n                this.fixLayout();\r\n            } else if (pb instanceof CommandSlotMorph) {\r\n                pb.nestedBlock(block);\r\n            } else if (pb instanceof CommandBlockMorph) {\r\n                pb.nextBlock(block);\r\n            }\r\n        }\r\n    } else if (this.element instanceof CommandSlotMorph) {\r\n        // to be done: special case if block.isStop()\r\n        this.element.nestedBlock(block);\r\n        this.element = block;\r\n        this.atEnd = true;\r\n    } else {\r\n        pb = this.element.parent;\r\n        if (pb instanceof ScriptsMorph) {\r\n            this.editor.add(block);\r\n            block.setPosition(this.element.position());\r\n            this.element.destroy();\r\n        } else {\r\n            pb.replaceInput(this.element, block);\r\n        }\r\n        this.element = block;\r\n    }\r\n    block.fixBlockColor();\r\n    this.editor.adjustBounds();\r\n    // block.scrollIntoView();\r\n    this.fixLayout();\r\n\r\n    // register generic hat blocks\r\n    if (block.selector === 'receiveCondition') {\r\n        rcvr = this.editor.scriptTarget();\r\n        if (rcvr) {\r\n            stage = rcvr.parentThatIsA(StageMorph);\r\n            if (stage) {\r\n                stage.enableCustomHatBlocks = true;\r\n                stage.threads.pauseCustomHatBlocks = false;\r\n                ide = stage.parentThatIsA(IDE_Morph);\r\n                if (ide) {\r\n                    ide.controlBar.stopButton.refresh();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // experimental: if the inserted block has inputs, go to the first one\r\n    if (block.inputs && block.inputs().length) {\r\n        this.element = block;\r\n        this.atEnd = false;\r\n        this.nextElement();\r\n    }\r\n};\r\n\r\nScriptFocusMorph.prototype.insertVariableGetter = function () {\r\n    var types = this.blockTypes(),\r\n        vars,\r\n        myself = this,\r\n        menu = new MenuMorph();\r\n    if (!types || !contains(types, 'reporter')) {\r\n        return;\r\n    }\r\n    vars = InputSlotMorph.prototype.getVarNamesDict.call(this.element);\r\n    Object.keys(vars).forEach(function (vName) {\r\n        var block = SpriteMorph.prototype.variableBlock(vName);\r\n        block.addShadow(new Point(3, 3));\r\n        menu.addItem(\r\n            block,\r\n            function () {\r\n                block.removeShadow();\r\n                myself.insertBlock(block);\r\n            }\r\n        );\r\n    });\r\n    if (menu.items.length > 0) {\r\n        menu.popup(this.world(), this.element.bottomLeft());\r\n        menu.getFocus();\r\n    }\r\n};\r\n\r\nScriptFocusMorph.prototype.stopEditing = function () {\r\n    this.editor.focus = null;\r\n    this.editor.updateToolbar();\r\n    this.world().keyboardReceiver = null;\r\n    this.destroy();\r\n};\r\n\r\n// ScriptFocusMorph navigation\r\n\r\nScriptFocusMorph.prototype.lastElement = function () {\r\n    var items = this.items(),\r\n        idx;\r\n    if (!items.length) {\r\n        this.shiftScript(new Point(-50, 0));\r\n        return;\r\n    }\r\n    if (this.atEnd) {\r\n        this.element = items[items.length - 1];\r\n        this.atEnd = false;\r\n    } else {\r\n        idx = items.indexOf(this.element) - 1;\r\n        if (idx < 0) {idx = items.length - 1; }\r\n        this.element = items[idx];\r\n    }\r\n    if (this.element instanceof CommandSlotMorph &&\r\n            this.element.nestedBlock()) {\r\n        this.lastElement();\r\n    } else if (this.element instanceof HatBlockMorph) {\r\n        if (items.length > 1) {\r\n            this.lastElement();\r\n        } else {\r\n            this.atEnd = true;\r\n        }\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.nextElement = function () {\r\n    var items = this.items(), idx, nb;\r\n    if (!items.length) {\r\n        this.shiftScript(new Point(50, 0));\r\n        return;\r\n    }\r\n    idx = items.indexOf(this.element) + 1;\r\n    if (idx >= items.length) {\r\n        idx = 0;\r\n    }\r\n    this.atEnd = false;\r\n    this.element = items[idx];\r\n    if (this.element instanceof CommandSlotMorph) {\r\n        nb = this.element.nestedBlock();\r\n        if (nb) {this.element = nb; }\r\n    } else if (this.element instanceof HatBlockMorph) {\r\n        if (items.length === 1) {\r\n            this.atEnd = true;\r\n        } else {\r\n            this.nextElement();\r\n        }\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.lastCommand = function () {\r\n    var cm = this.element.parentThatIsA(CommandBlockMorph),\r\n        pb;\r\n    if (!cm) {\r\n        if (this.element instanceof ScriptsMorph) {\r\n            this.shiftScript(new Point(0, -50));\r\n        }\r\n        return;\r\n    }\r\n    if (this.element instanceof CommandBlockMorph) {\r\n        if (this.atEnd) {\r\n            this.atEnd = false;\r\n        } else {\r\n            pb = cm.parent.parentThatIsA(CommandBlockMorph);\r\n            if (pb) {\r\n                this.element = pb;\r\n            } else {\r\n                pb = cm.topBlock().bottomBlock();\r\n                if (pb) {\r\n                    this.element = pb;\r\n                    this.atEnd = true;\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        this.element = cm;\r\n        this.atEnd = false;\r\n    }\r\n    if (this.element instanceof HatBlockMorph && !this.atEnd) {\r\n        this.lastCommand();\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.nextCommand = function () {\r\n    var cm = this.element,\r\n        tb,\r\n        nb,\r\n        cs;\r\n    if (cm instanceof ScriptsMorph) {\r\n        this.shiftScript(new Point(0, 50));\r\n        return;\r\n    }\r\n    while (!(cm instanceof CommandBlockMorph)) {\r\n        cm = cm.parent;\r\n        if (cm instanceof ScriptsMorph) {\r\n            return;\r\n        }\r\n    }\r\n    if (this.atEnd) {\r\n        cs = cm.parentThatIsA(CommandSlotMorph);\r\n        if (cs) {\r\n            this.element = cs.parentThatIsA(CommandBlockMorph);\r\n            this.atEnd = false;\r\n            this.nextCommand();\r\n        } else {\r\n            tb = cm.topBlock().parentThatIsA(CommandBlockMorph);\r\n            if (tb) {\r\n                this.element = tb;\r\n                this.atEnd = false;\r\n                if (this.element instanceof HatBlockMorph) {\r\n                    this.nextCommand();\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        nb = cm.nextBlock();\r\n        if (nb) {\r\n            this.element = nb;\r\n        } else {\r\n            this.element = cm;\r\n            this.atEnd = true;\r\n        }\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.nextScript = function () {\r\n    var scripts = this.sortedScripts(),\r\n        idx;\r\n    if (scripts.length < 1) {return; }\r\n    if (this.element instanceof ScriptsMorph) {\r\n        this.element = scripts[0];\r\n    }\r\n    idx = scripts.indexOf(this.element.topBlock()) + 1;\r\n    if (idx >= scripts.length) {idx = 0; }\r\n    this.element = scripts[idx];\r\n    this.element.scrollIntoView();\r\n    this.atEnd = false;\r\n    if (this.element instanceof HatBlockMorph) {\r\n        return this.nextElement();\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.lastScript = function () {\r\n    var scripts = this.sortedScripts(),\r\n        idx;\r\n    if (scripts.length < 1) {return; }\r\n    if (this.element instanceof ScriptsMorph) {\r\n        this.element = scripts[0];\r\n    }\r\n    idx = scripts.indexOf(this.element.topBlock()) - 1;\r\n    if (idx < 0) {idx = scripts.length - 1; }\r\n    this.element = scripts[idx];\r\n    this.element.scrollIntoView();\r\n    this.atEnd = false;\r\n    if (this.element instanceof HatBlockMorph) {\r\n        return this.nextElement();\r\n    }\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.shiftScript = function (deltaPoint) {\r\n    var tb;\r\n    if (this.element instanceof ScriptsMorph) {\r\n        this.moveBy(deltaPoint);\r\n    } else {\r\n        tb = this.element.topBlock();\r\n        if (tb && !(tb instanceof PrototypeHatBlockMorph)) {\r\n            tb.moveBy(deltaPoint);\r\n        }\r\n    }\r\n    this.editor.adjustBounds();\r\n    this.fixLayout();\r\n};\r\n\r\nScriptFocusMorph.prototype.newScript = function () {\r\n    var pos = this.position();\r\n    if (!(this.element instanceof ScriptsMorph)) {\r\n        pos = this.element.topBlock().fullBounds().bottomLeft().add(\r\n            new Point(0, 50)\r\n        );\r\n    }\r\n    this.setPosition(pos);\r\n    this.element = this.editor;\r\n    this.editor.adjustBounds();\r\n    this.fixLayout();\r\n};\r\n\r\n\r\nScriptFocusMorph.prototype.runScript = function () {\r\n    if (this.element instanceof ScriptsMorph) {return; }\r\n    this.element.topBlock().mouseClickLeft();\r\n};\r\n\r\nScriptFocusMorph.prototype.items = function () {\r\n    if (this.element instanceof ScriptsMorph) {return []; }\r\n    var script = this.element.topBlock();\r\n    return script.allChildren().filter(function (each) {\r\n        return each instanceof SyntaxElementMorph &&\r\n            !(each instanceof TemplateSlotMorph) &&\r\n            (!each.isStatic ||\r\n                each.choices ||\r\n                each instanceof BooleanSlotMorph ||\r\n                each instanceof RingMorph ||\r\n                each instanceof MultiArgMorph ||\r\n                each instanceof CommandSlotMorph);\r\n    });\r\n};\r\n\r\nScriptFocusMorph.prototype.sortedScripts = function () {\r\n    var scripts = this.editor.children.filter(function (each) {\r\n        return each instanceof BlockMorph;\r\n    });\r\n    scripts.sort(function (a, b) {\r\n        // make sure the prototype hat block always stays on top\r\n        return a instanceof PrototypeHatBlockMorph ? 0 : a.top() - b.top();\r\n    });\r\n    return scripts;\r\n};\r\n\r\n// ScriptFocusMorph undo / redo\r\n\r\nScriptFocusMorph.prototype.undrop = function () {\r\n    this.editor.undrop();\r\n};\r\n\r\nScriptFocusMorph.prototype.redrop = function () {\r\n    this.editor.redrop();\r\n};\r\n\r\n// ScriptFocusMorph block types\r\n\r\nScriptFocusMorph.prototype.blockTypes = function () {\r\n    // answer an array of possible block types that fit into\r\n    // the current situation, NULL if no block can be inserted\r\n\r\n    if (this.element.isTemplate) {return null; }\r\n    if (this.element instanceof ScriptsMorph) {\r\n        return ['hat', 'command', 'reporter', 'predicate', 'ring'];\r\n    }\r\n    if (this.element instanceof HatBlockMorph ||\r\n            this.element instanceof CommandSlotMorph) {\r\n        return ['command'];\r\n    }\r\n    if (this.element instanceof CommandBlockMorph) {\r\n        if (this.atEnd && this.element.isStop()) {\r\n            return null;\r\n        }\r\n        if (this.element.parent instanceof ScriptsMorph) {\r\n            return ['hat', 'command'];\r\n        }\r\n        return ['command'];\r\n    }\r\n    if (this.element instanceof ReporterBlockMorph) {\r\n        if (this.element.getSlotSpec() === '%n') {\r\n            return ['reporter'];\r\n        }\r\n        return ['reporter', 'predicate', 'ring'];\r\n    }\r\n    if (this.element.getSpec() === '%n') {\r\n        return ['reporter'];\r\n    }\r\n    if (this.element.isStatic) {\r\n        return null;\r\n    }\r\n    return ['reporter', 'predicate', 'ring'];\r\n};\r\n\r\n\r\n// ScriptFocusMorph keyboard events\r\n\r\nScriptFocusMorph.prototype.processKeyDown = function (event) {\r\n    this.processKeyEvent(\r\n        event,\r\n        this.reactToKeyEvent\r\n    );\r\n};\r\n\r\nScriptFocusMorph.prototype.processKeyUp = function (event) {\r\n    nop(event);\r\n};\r\n\r\nScriptFocusMorph.prototype.processKeyPress = function (event) {\r\n    nop(event);\r\n};\r\n\r\n\r\nScriptFocusMorph.prototype.processKeyEvent = function (event, action) {\r\n    var keyName, ctrl, shift;\r\n\r\n    this.world().hand.destroyTemporaries(); // remove result bubbles, if any\r\n    switch (event.keyCode) {\r\n    case 8:\r\n        keyName = 'backspace';\r\n        break;\r\n    case 9:\r\n        keyName = 'tab';\r\n        break;\r\n    case 13:\r\n        keyName = 'enter';\r\n        break;\r\n    case 16:\r\n    case 17:\r\n    case 18:\r\n        return;\r\n    case 27:\r\n        keyName = 'esc';\r\n        break;\r\n    case 32:\r\n        keyName = 'space';\r\n        break;\r\n    case 37:\r\n        keyName = 'left arrow';\r\n        break;\r\n    case 39:\r\n        keyName = 'right arrow';\r\n        break;\r\n    case 38:\r\n        keyName = 'up arrow';\r\n        break;\r\n    case 40:\r\n        keyName = 'down arrow';\r\n        break;\r\n    default:\r\n        keyName = String.fromCharCode(event.keyCode || event.charCode);\r\n    }\r\n    ctrl = (event.ctrlKey || event.metaKey) ? 'ctrl ' : '';\r\n    shift = event.shiftKey ? 'shift ' : '';\r\n    keyName = ctrl + shift + keyName;\r\n    action.call(this, keyName);\r\n};\r\n\r\nScriptFocusMorph.prototype.reactToKeyEvent = function (key) {\r\n    var evt = key.toLowerCase(),\r\n        shift = 50,\r\n        types,\r\n        vNames;\r\n\r\n    \r\n    switch (evt) {\r\n    case 'esc':\r\n        return this.stopEditing();\r\n    case 'enter':\r\n        return this.trigger();\r\n    case 'shift enter':\r\n        return this.newScript();\r\n    case 'ctrl shift enter':\r\n        return this.runScript();\r\n    case 'space':\r\n        return this.menu();\r\n    case 'left arrow':\r\n        return this.lastElement();\r\n    case 'shift left arrow':\r\n        return this.shiftScript(new Point(-shift, 0));\r\n    case 'right arrow':\r\n        return this.nextElement();\r\n    case 'shift right arrow':\r\n        return this.shiftScript(new Point(shift, 0));\r\n    case 'up arrow':\r\n        return this.lastCommand();\r\n    case 'shift up arrow':\r\n        return this.shiftScript(new Point(0, -shift));\r\n    case 'down arrow':\r\n        return this.nextCommand();\r\n    case 'shift down arrow':\r\n        return this.shiftScript(new Point(0, shift));\r\n    case 'tab':\r\n        return this.nextScript();\r\n    case 'shift tab':\r\n        return this.lastScript();\r\n    case 'backspace':\r\n        return this.deleteLastElement();\r\n    case 'ctrl z':\r\n        return this.undrop();\r\n    case 'ctrl y':\r\n    case 'ctrl shift z':\r\n        return this.redrop();\r\n    case 'ctrl [': // ignore the first press of the Mac cmd key\r\n        return;\r\n    default:\r\n        types = this.blockTypes();\r\n        if (!(this.element instanceof ScriptsMorph) &&\r\n                types && contains(types, 'reporter')) {\r\n            vNames = Object.keys(this.element.getVarNamesDict());\r\n        }\r\n        if (types) {\r\n            delete this.fps;\r\n            delete this.step;\r\n            this.show();\r\n            this.editor.scriptTarget().searchBlocks(\r\n                key,\r\n                types,\r\n                vNames,\r\n                this\r\n            );\r\n        }\r\n    }\r\n};\r\n//fin de blocks\r\n\r\n/*\r\n\r\n    threads.js\r\n\r\n    a tail call optimized blocks-based programming language interpreter\r\n    based on morphic.js and blocks.js\r\n    inspired by Scratch, Scheme and Squeak\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs blocks.js and objects.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        ThreadManager\r\n        Process\r\n        Context\r\n        Variable\r\n        VariableFrame\r\n\r\n\r\n    credits\r\n    -------\r\n    John Maloney and Dave Feinberg designed the original Scratch evaluator\r\n    Ivan Motyashov contributed initial porting from Squeak\r\n\r\n*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\n/*global ArgMorph, BlockMorph, CommandBlockMorph, CommandSlotMorph, Morph,\r\nMultiArgMorph, Point, ReporterBlockMorph, SyntaxElementMorph, contains, Costume,\r\ndegrees, detect, nop, radians, ReporterSlotMorph, CSlotMorph, RingMorph, Sound,\r\nIDE_Morph, ArgLabelMorph, localize, XML_Element, hex_sha512, TableDialogMorph,\r\nStageMorph, SpriteMorph, StagePrompterMorph, Note, modules, isString, copy,\r\nisNil, WatcherMorph, List, ListWatcherMorph, alert, console, TableMorph,\r\nTableFrameMorph, ColorSlotMorph, isSnapObject*/\r\n\r\nmodules.threads = '2017-December-01';\r\n\r\nvar ThreadManager;\r\nvar Process;\r\nvar Context;\r\nvar VariableFrame;\r\n\r\nfunction snapEquals(a, b) {\r\n    if (a instanceof List || (b instanceof List)) {\r\n        if (a instanceof List && (b instanceof List)) {\r\n            return a.equalTo(b);\r\n        }\r\n        return false;\r\n    }\r\n\r\n    var x = +a,\r\n        y = +b,\r\n        i,\r\n        specials = [true, false, ''];\r\n\r\n    // \"zum Schneckengang verdorben, was Adlerflug geworden wre\"\r\n    // collecting edge-cases that somebody complained about\r\n    // on Github. Folks, take it easy and keep it fun, okay?\r\n    // Shit like this is patently ugly and slows Snap down. Tnx!\r\n    for (i = 9; i <= 13; i += 1) {\r\n        specials.push(String.fromCharCode(i));\r\n    }\r\n    specials.push(String.fromCharCode(160));\r\n\r\n    // check for special values before coercing to numbers\r\n    if (isNaN(x) || isNaN(y) ||\r\n            [a, b].some(function (any) {return contains(specials, any) ||\r\n                  (isString(any) && (any.indexOf(' ') > -1)); })) {\r\n        x = a;\r\n        y = b;\r\n    }\r\n\r\n    // handle text comparison case-insensitive.\r\n    if (isString(x) && isString(y)) {\r\n        return x.toLowerCase() === y.toLowerCase();\r\n    }\r\n\r\n    return x === y;\r\n}\r\n\r\nfunction invoke(\r\n    action, // a BlockMorph or a Context, a reified (\"ringified\") block\r\n    contextArgs, // optional List of arguments for the context, or null\r\n    receiver, // sprite or environment, optional for contexts\r\n    timeout, // msecs\r\n    timeoutErrorMsg, // string\r\n    suppressErrors // bool\r\n) {\r\n    // execute the given block or context synchronously without yielding.\r\n    // Apply context (not a block) to a list of optional arguments.\r\n    // Receiver (sprite, stage or  environment), timeout etc. are optional.\r\n    // If a timeout (in milliseconds) is specified, abort execution\r\n    // after the timeout has been reached and throw an error.\r\n    // SuppressErrors (bool) if non-timeout errors occurring in the\r\n    // block are handled elsewhere.\r\n    // This is highly experimental.\r\n    // Caution: Kids, do not try this at home!\r\n    // Use ThreadManager::startProcess with a callback instead\r\n\r\n    var proc = new Process(),\r\n        deadline = (timeout ? Date.now() + timeout : null);\r\n\r\n    if (action instanceof Context) {\r\n        if (receiver) { // optional\r\n            action = proc.reportContextFor(receiver);\r\n        }\r\n        proc.initializeFor(action, contextArgs || new List());\r\n    } else if (action instanceof BlockMorph) {\r\n        proc.topBlock = action;\r\n        if (receiver) {\r\n            proc.homeContext = new Context();\r\n            proc.homeContext.receiver = receiver;\r\n            if (receiver.variables) {\r\n                proc.homeContext.variables.parentFrame = receiver.variables;\r\n            }\r\n        } else {\r\n            throw new Error('expecting a receiver but getting ' + receiver);\r\n        }\r\n        proc.context = new Context(\r\n            null,\r\n            action.blockSequence(),\r\n            proc.homeContext\r\n        );\r\n    } else if (action.evaluate) {\r\n        return action.evaluate();\r\n    } else {\r\n        throw new Error('expecting a block or ring but getting ' + action);\r\n    }\r\n    if (suppressErrors) {\r\n        proc.isCatchingErrors = false;\r\n    }\r\n    while (proc.isRunning()) {\r\n        if (deadline && (Date.now() > deadline)) {\r\n            throw (new Error(\r\n                localize(\r\n                    timeoutErrorMsg ||\r\n                        \"a synchronous Snap! script has timed out\")\r\n                )\r\n            );\r\n        }\r\n        proc.runStep(deadline);\r\n    }\r\n    return proc.homeContext.inputs[0];\r\n}\r\n\r\n// ThreadManager ///////////////////////////////////////////////////////\r\n\r\nfunction ThreadManager() {\r\n    this.processes = [];\r\n    this.wantsToPause = false; // single stepping support\r\n}\r\n\r\nThreadManager.prototype.pauseCustomHatBlocks = false;\r\n\r\nvar compteurGo = 0; // Wiquid Counting user try\r\n\r\nThreadManager.prototype.toggleProcess = function (block, receiver) {\r\n    var active = this.findProcess(block, receiver);\r\n    \r\n    compteur();//Wiquid : Block green flag and other trigger blocks\r\n\r\n    if (active) {\r\n\r\n        active.stop();\r\n    \r\n    } else {\r\n\r\n        return this.startProcess(block, receiver, null, null, null, true);\r\n    \r\n    }\r\n};\r\n\r\n//******************************* Wiquid ***********************************************\r\n\r\nfunction compteur(){\r\n    compteurGo++;\r\n    $container.find(\".compteur\").html(\"\\\"tentatives\\\" : \\\"\" + compteurGo + \"\\\"\");\r\n     var nbTry = config.testLimiter - compteurGo ;\r\n    \r\n    if(nbTry > 1){world.children[0].projectName = ' ATTENTION : Il vous reste '+ (nbTry) +' tentatives !';}\r\n    if(nbTry == 1){world.children[0].projectName = ' ATTENTION DERNIERE TENTATIVE !';}\r\n    world.children[0].controlBar.updateLabel();\r\n    \r\n    if( compteurGo >= config.testLimiter && config.testLimiter !=0 ){\r\n\r\n        $container.find(\".snapy\").append(\"<div class='bg_try_stop'></div\");\r\n        $container.find(\".snapy\").append(\"<div class='txt_try_stop'>Nombre d\\'essais maximum atteint. Soumettez votre rponse pour continuer.</div>\");\r\n        $container.find(\".world\").hide();\r\n    }\r\n}\r\n\r\n function morphOnSet(morph) {\r\n     if (morph) {\r\n         allMorphs.push(morph)\r\n     }\r\n     let evalParentMorph;\r\n\r\n     function correctParentMorph() {\r\n         if (!morph.parent.blockSpec) {\r\n             evalParentMorph = \"desktop\"\r\n         } else {\r\n             evalParentMorph = morph.parent.blockSpec\r\n         }\r\n         return evalParentMorph;\r\n     }\r\n     let ope;\r\n     if (grabOrigine == \"palette\") {\r\n         ope = \"ADD\"\r\n     } else {\r\n         ope = \"MOVE\"\r\n     }\r\n     snapsrc.actionOrder++;\r\n     $container.find(\".blockTracker\").append(\"\\\"\" + snapsrc.actionOrder + \"\\\" : \\\"\" + ope + \" - \" + morph.blockSpec + \" @ \" + correctParentMorph() + \"\\\",\");\r\n     return allMorphs\r\n }\r\n\r\n function morphRemover(morph) {\r\n     if (morph) {\r\n         allMorphs.push(morph)\r\n     }\r\n     let evalParentMorph;\r\n\r\n     function correctParentMorph() {\r\n         if (!morph.parent.blockSpec) {\r\n             evalParentMorph = \"desktop\"\r\n         } else {\r\n             evalParentMorph = morph.parent.blockSpec\r\n         }\r\n         return evalParentMorph;\r\n     }\r\n      snapsrc.actionOrder++;\r\n      $container.find(\".blockTracker\").append(\"\\\"\" + snapsrc.actionOrder + \"\\\" : \\\" DEL - \" + morph.blockSpec + \" @ \" + correctParentMorph() + \"\\\",\");\r\n     return allMorphs\r\n }\r\n\r\n var blockRunner = true; // Allow to write once for receiveCondition -> Block When\r\n snapsrc.blockReporter = [];\r\n\r\n\r\n//******************************* Wiquid ********************************************\r\n\r\nThreadManager.prototype.startProcess = function (\r\n    block,\r\n    receiver,\r\n    isThreadSafe,\r\n    exportResult, // bool\r\n    callback,\r\n    isClicked,\r\n    rightAway\r\n) {\r\n    var top = block.topBlock(),\r\n        active = this.findProcess(top, receiver),\r\n        glow,\r\n        newProc;\r\n    if (active) {\r\n        if (isThreadSafe) {\r\n            return active;\r\n        }\r\n        active.stop();\r\n        this.removeTerminatedProcesses();\r\n    }\r\n    newProc = new Process(top, receiver, callback, isClicked);\r\n    newProc.exportResult = exportResult;\r\n    newProc.isClicked = isClicked || false;\r\n\r\n    // show a highlight around the running stack\r\n    // if there are more than one active processes\r\n    // for a block, display the thread count\r\n    // next to it\r\n    glow = top.getHighlight();\r\n    if (glow) {\r\n        glow.threadCount = this.processesForBlock(top).length + 1;\r\n        glow.updateReadout();\r\n    } else {\r\n        top.addHighlight();\r\n    }\r\n\r\n    this.processes.push(newProc);\r\n    if (rightAway) {\r\n        newProc.runStep();\r\n    }\r\n    return newProc;\r\n};\r\n\r\nThreadManager.prototype.stopAll = function (excpt) {\r\n    // excpt is optional\r\n    this.processes.forEach(function (proc) {\r\n        if (proc !== excpt) {\r\n            proc.stop();\r\n        }\r\n    });\r\n};\r\n\r\nThreadManager.prototype.stopAllForReceiver = function (rcvr, excpt) {\r\n    // excpt is optional\r\n    this.processes.forEach(function (proc) {\r\n        if (proc.homeContext.receiver === rcvr && proc !== excpt) {\r\n            proc.stop();\r\n            if (rcvr.isTemporary) {\r\n                proc.isDead = true;\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nThreadManager.prototype.stopAllForBlock = function (aTopBlock) {\r\n    this.processesForBlock(aTopBlock, true).forEach(function (proc) {\r\n        proc.stop();\r\n    });\r\n};\r\n\r\nThreadManager.prototype.stopProcess = function (block, receiver) {\r\n    var active = this.findProcess(block, receiver);\r\n    if (active) {\r\n        active.stop();\r\n    }\r\n};\r\n\r\nThreadManager.prototype.pauseAll = function (stage) {\r\n    this.processes.forEach(function (proc) {\r\n        proc.pause();\r\n    });\r\n    if (stage) {\r\n        stage.pauseAllActiveSounds();\r\n    }\r\n};\r\n\r\nThreadManager.prototype.isPaused = function () {\r\n    return detect(this.processes, function (proc) {return proc.isPaused; })\r\n        !== null;\r\n};\r\n\r\nThreadManager.prototype.resumeAll = function (stage) {\r\n    this.processes.forEach(function (proc) {\r\n        proc.resume();\r\n    });\r\n    if (stage) {\r\n        stage.resumeAllActiveSounds();\r\n    }\r\n};\r\n\r\nThreadManager.prototype.step = function () {\r\n    // run each process until it gives up control, skipping processes\r\n    // for sprites that are currently picked up, then filter out any\r\n    // processes that have been terminated\r\n\r\n    var isInterrupted;\r\n    if (Process.prototype.enableSingleStepping) {\r\n        this.processes.forEach(function (proc) {\r\n            if (proc.isInterrupted) {\r\n                proc.runStep();\r\n                isInterrupted = true;\r\n            } else {\r\n                proc.lastYield = Date.now();\r\n            }\r\n        });\r\n        this.wantsToPause = (Process.prototype.flashTime > 0.5);\r\n        if (isInterrupted) {\r\n            if (this.wantsToPause) {\r\n                this.pauseAll();\r\n            }\r\n            return;\r\n        }\r\n    }\r\n\r\n    this.processes.forEach(function (proc) {\r\n        if (!proc.homeContext.receiver.isPickedUp() && !proc.isDead) {\r\n            proc.runStep();\r\n        }\r\n    });\r\n    this.removeTerminatedProcesses();\r\n};\r\n\r\nThreadManager.prototype.removeTerminatedProcesses = function () {\r\n    // and un-highlight their scripts\r\n    var remaining = [],\r\n        count,\r\n        myself = this;\r\n    this.processes.forEach(function (proc) {\r\n        var result,\r\n            glow;\r\n        if ((!proc.isRunning() && !proc.errorFlag) || proc.isDead) {\r\n            if (proc.topBlock instanceof BlockMorph) {\r\n                proc.unflash();\r\n                // adjust the thread count indicator, if any\r\n                count = myself.processesForBlock(proc.topBlock).length;\r\n                if (count) {\r\n                    glow = proc.topBlock.getHighlight() ||\r\n                        proc.topBlock.addHighlight();\r\n                    glow.threadCount = count;\r\n                    glow.updateReadout();\r\n                } else {\r\n                    proc.topBlock.removeHighlight();\r\n                }\r\n            }\r\n            if (proc.prompter) {\r\n                proc.prompter.destroy();\r\n                if (proc.homeContext.receiver.stopTalking) {\r\n                    proc.homeContext.receiver.stopTalking();\r\n                }\r\n            }\r\n            if (proc.topBlock instanceof ReporterBlockMorph ||\r\n                    proc.isShowingResult) {\r\n                result = proc.homeContext.inputs[0];\r\n                if (proc.onComplete instanceof Function) {\r\n                    proc.onComplete(result);\r\n                } else {\r\n                    if (result instanceof List) {\r\n                        proc.topBlock.showBubble(\r\n                            result.isTable() ?\r\n                                    new TableFrameMorph(\r\n                                        new TableMorph(result, 10)\r\n                                    )\r\n                                    : new ListWatcherMorph(result),\r\n                            proc.exportResult,\r\n                            proc.receiver\r\n                        );\r\n                    } else {\r\n                        proc.topBlock.showBubble(\r\n                            result,\r\n                            proc.exportResult,\r\n                            proc.receiver\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            remaining.push(proc);\r\n        }\r\n    });\r\n    this.processes = remaining;\r\n};\r\n\r\nThreadManager.prototype.findProcess = function (block, receiver) {\r\n    var top = block.topBlock();\r\n    return detect(\r\n        this.processes,\r\n        function (each) {\r\n            return each.topBlock === top && (each.receiver === receiver);\r\n        }\r\n    );\r\n};\r\n\r\nThreadManager.prototype.processesForBlock = function (block, only) {\r\n    var top = only ? block : block.topBlock();\r\n    return this.processes.filter(function (each) {\r\n            return each.topBlock === top &&\r\n                each.isRunning() &&\r\n                !each.isDead;\r\n    });\r\n};\r\n\r\nThreadManager.prototype.doWhen = function (block, receiver, stopIt) {\r\n    if (this.pauseCustomHatBlocks) {return; }\r\n    if ((!block) || this.findProcess(block, receiver)) {\r\n        return;\r\n    }\r\n    var pred = block.inputs()[0], world;\r\n    if (block.removeHighlight()) {\r\n        world = block.world();\r\n        if (world) {\r\n            world.hand.destroyTemporaries();\r\n        }\r\n    }\r\n    if (stopIt) {return; }\r\n    try {\r\n        if (invoke(\r\n            pred,\r\n            null,\r\n            receiver,\r\n            50,\r\n            'the predicate takes\\ntoo long for a\\ncustom hat block',\r\n            true // suppress errors => handle them right here instead\r\n        ) === true) {\r\n            this.startProcess(\r\n                block,\r\n                receiver,\r\n                null,\r\n                null,\r\n                null,\r\n                null,\r\n                true // atomic\r\n            );\r\n        }\r\n    } catch (error) {\r\n        block.addErrorHighlight();\r\n        block.showBubble(\r\n            error.name\r\n            + '\\n'\r\n            + error.message\r\n        );\r\n    }\r\n};\r\n\r\nThreadManager.prototype.toggleSingleStepping = function () {\r\n    Process.prototype.enableSingleStepping =\r\n        !Process.prototype.enableSingleStepping;\r\n    if (!Process.prototype.enableSingleStepping) {\r\n        this.processes.forEach(function (proc) {\r\n            if (!proc.isPaused) {\r\n                proc.unflash();\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\n// Process /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    A Process is what brings a stack of blocks to life. The process\r\n    keeps track of which block to run next, evaluates block arguments,\r\n    handles control structures, and so forth.\r\n\r\n    The ThreadManager is the (passive) scheduler, telling each process\r\n    when to run by calling its runStep() method. The runStep() method\r\n    will execute some number of blocks, then voluntarily yield control\r\n    so that the ThreadManager can run another process.\r\n\r\n    The Scratch etiquette is that a process should yield control at the\r\n    end of every loop iteration, and while it is running a timed command\r\n    (e.g. \"wait 5 secs\") or a synchronous command (e.g. \"broadcast xxx\r\n    and wait\"). Since Snap also has lambda and custom blocks Snap adds\r\n    yields at the beginning of each non-atomic custom command block\r\n    execution, and - to let users escape infinite loops and recursion -\r\n    whenever the process runs into a timeout.\r\n\r\n    a Process runs for a receiver, i.e. a sprite or the stage or any\r\n    blocks-scriptable object that we'll introduce.\r\n\r\n    structure:\r\n\r\n    topBlock            the stack's first block, of which all others\r\n                        are children\r\n    receiver            object (sprite) to which the process applies,\r\n                        cached from the top block\r\n    instrument          musical instrument type, cached from the receiver,\r\n                        so a single sprite can play several instruments\r\n                        at once\r\n    context             the Context describing the current state\r\n                        of this process\r\n    homeContext         stores information relevant to the whole process,\r\n                        i.e. its receiver, result etc.\r\n    isPaused            boolean indicating whether to pause\r\n    readyToYield        boolean indicating whether to yield control to\r\n                        another process\r\n    readyToTerminate    boolean indicating whether the stop method has\r\n                        been called\r\n    isDead              boolean indicating a terminated clone process\r\n    timeout             msecs after which to force yield\r\n    lastYield           msecs when the process last yielded\r\n    isFirstStep         boolean indicating whether on first step - for clones\r\n    errorFlag           boolean indicating whether an error was encountered\r\n    prompter            active instance of StagePrompterMorph\r\n    httpRequest         active instance of an HttpRequest or null\r\n    pauseOffset         msecs between the start of an interpolated operation\r\n                        and when the process was paused\r\n    isClicked           boolean flag indicating whether the process was\r\n                        initiated by a user-click on a block\r\n    isShowingResult     boolean flag indicating whether a \"report\" command\r\n                        has been executed in a user-clicked process\r\n    exportResult        boolean flag indicating whether a picture of the top\r\n                        block along with the result bubble shoud be exported\r\n    onComplete          an optional callback function to be executed when\r\n                        the process is done\r\n    procedureCount      number counting procedure call entries,\r\n                        used to tag custom block calls, so \"stop block\"\r\n                        invocations can catch them\r\n    flashingContext     for single stepping\r\n    isInterrupted       boolean, indicates intra-step flashing of blocks\r\n*/\r\n\r\nProcess.prototype = {};\r\nProcess.prototype.constructor = Process;\r\nProcess.prototype.timeout = 500; // msecs after which to force yield\r\nProcess.prototype.isCatchingErrors = true;\r\nProcess.prototype.enableLiveCoding = false; // experimental\r\nProcess.prototype.enableSingleStepping = false; // experimental\r\nProcess.prototype.flashTime = 0; // experimental\r\n// Process.prototype.enableJS = false;\r\n\r\n// Variables to track process\r\nvar blockRunner = true; // Allow to write once for receiveCondition -> Block When\r\nsnapsrc.blockReporter = [];\r\n\r\nfunction Process(topBlock, receiver, onComplete, yieldFirst) {\r\n    try {\r\n        if (typeof topBlock != \"undefined\") {\r\n            var blockInProcess = [];\r\n            scanChildren(topBlock);\r\n        }\r\n    } catch (error) {\r\n        runerCatcher();\r\n    }\r\n\r\n    function runerCatcher() {\r\n        if (blockRunner) {\r\n           //Error watcher jp\r\n            blockInProcess.push(\"Quand /b\");\r\n            blockRunner = false;\r\n        }\r\n    }\r\n\r\n    function scanChildren(blockToScan) {\r\n        if (blockToScan.children) {\r\n            var lastChild = blockToScan.children.length - 1;\r\n        }\r\n        var serialezedBlock = blockToScan.children[lastChild].toString();\r\n        var blockChain = {};\r\n        blockChain.Actor = receiver.name;\r\n        var blockString = \"\";\r\n\r\n        function scanBlock(BToScan) {\r\n    \r\n            function slotClosure() {\r\n                let slotClosure = false;\r\n                if (BToScan.parent.selector == \"doWarp\" ||\r\n                    BToScan.parent.selector == \"doForever\" ||\r\n                    BToScan.parent.selector == \"doRepeat\" ||\r\n                    BToScan.parent.selector == \"doUntil\" ||\r\n                    BToScan.parent.selector == \"doIf\" ||\r\n                    BToScan.parent.selector == \"doIfElse\"\r\n                ) {\r\n                    slotClosure = true\r\n                }\r\n                return slotClosure\r\n            }\r\n\r\n            //Slot closure\r\n            var closure = slotClosure();\r\n            let serBToScan = BToScan.toString();\r\n            if (closure && serBToScan.search(\"CSlotMorph\") < 0) {\r\n                blockString = blockString + \"];\";\r\n            }\r\n            for (let z = 0; z < BToScan.children.length; z++) {\r\n                let serChildren = BToScan.children[z].toString();\r\n                if (serChildren.search(\"StringMorph\") > 0) {\r\n                    if (typeof BToScan.children[z].text != \"undefined\") {\r\n                        blockString = blockString + \" \" + BToScan.children[z].text;\r\n                    }\r\n                } else if (serChildren.search(\"SymbolMorph\") > 0) {\r\n                    blockString = blockString + \" \" + BToScan.children[z].name;\r\n                } else if (serChildren.search(\"ColorSlotMorph\") > 0) {\r\n                    blockString = blockString + \" \" + BToScan.children[z].color.toString();\r\n                } else if (serChildren.search(\"RingMorph\") > 0) {\r\n                    //blockString = blockString + \";\"  \r\n                    scanBlock(BToScan.children[z]);\r\n                } else if (serChildren.search(\"RingReporterSlotMorph\") > 0) {\r\n                    //blockString = blockString + \";\"\r\n                    scanBlock(BToScan.children[z]);\r\n                } else if (serChildren.search(\"RingCommandSlotMorph\") > 0) {\r\n                    //blockString = blockString + \";\"\r\n                    scanBlock(BToScan.children[z]);\r\n                    blockString = blockString + \"]\";\r\n                } else if (serChildren.search(\"TemplateSlotMorph\") > 0) {\r\n                    blockString = blockString + \";\"\r\n                    scanBlock(BToScan.children[z]);\r\n                } else if (serChildren.search(\"MultiArgMorph\") > 0) {\r\n                    blockString = blockString + \";\"\r\n                    scanBlock(BToScan.children[z]);\r\n                    blockString = blockString + \"-\"\r\n                } else if (serChildren.search(\"InputSlotMorph\") > 0) {\r\n                    blockString = blockString + \"[\";\r\n                    scanBlock(BToScan.children[z]);\r\n                    blockString = blockString + \"]\";\r\n                } else if (serChildren.search(\"CSlotMorph\") > 0) {\r\n                    blockString = blockString + \":[\"\r\n                    scanBlock(BToScan.children[z]);\r\n                } else if (serChildren.search(\"CommandBlockMorph\") > 0) {\r\n                    if (BToScan.parent.selector == \"doWarp\" ||\r\n                        BToScan.parent.selector == \"doForever\" ||\r\n                        BToScan.parent.selector == \"doRepeat\" ||\r\n                        BToScan.parent.selector == \"doUntil\" ||\r\n                        BToScan.parent.selector == \"doIf\" ||\r\n                        BToScan.parent.selector == \"doIfElse\") {\r\n                        scanBlock(BToScan.children[z]);\r\n                    } else {\r\n                        blockString = blockString + \";\"\r\n                        scanBlock(BToScan.children[z]);\r\n                    }\r\n\r\n                } else if (serChildren.search(\"ReporterBlockMorph\") > 0) {\r\n                    blockString = blockString + \";\"\r\n                    scanBlock(BToScan.children[z]);\r\n                }\r\n\r\n            }\r\n            if (BToScan.selector == \"doForever\") {\r\n                blockString = blockString + \"];\";\r\n            }\r\n        }\r\n\r\n        //------------Caller--------------------\r\n        if (serialezedBlock.search(\"CommandBlockMorph\") > 0) {\r\n            scanBlock(blockToScan);\r\n        } else {\r\n            blockChain.push(\"{block Isol:\");\r\n            scanBlock(blockToScan);\r\n            blockChain.push(\"}\");\r\n            // Verify no process with hatBlockMorph\r\n            for (let i = 0; i < receiver.scripts.children.length; i++) {\r\n                let serNeighbour = receiver.scripts.children[i].toString();\r\n                if (serNeighbour.search(\"HatBlockMorph\") > 0) {\r\n                    scanBlock(receiver.scripts.children[i]);\r\n                }\r\n\r\n            }\r\n        }\r\n        //String Correction \r\n        blockString = blockString.replace(\"appelle;\", \"appelle:\");\r\n        blockString = blockString.replace(\"to;\", \"to[\");\r\n        blockString = blockString.replace(\"lance;\", \"lance[\");\r\n        blockString = blockString.replace(\"excute;\", \"excute[\");\r\n        blockString = blockString.replace(\"sinon\", \"]sinon\");\r\n        blockString = blockString.replace(\";]\", \"]\");\r\n        blockString = blockString.replace(\"jusqu'];\", \"jusqu'\");\r\n        blockString = blockString.replace(\"si;\", \"si\");\r\n        blockString = blockString.replace(\"si];\", \"si\");\r\n        blockString = blockString.replace(\"rpter[];\", \"rpter[\");\r\n        blockString = blockString.replace(\"rpter];\", \"rpter\");\r\n        blockString = blockString.replace(\"] rpter[];\", \"];rpter[\");\r\n        blockString = blockString.replace(\"; rpter[]; \", \"; rpter[\");\r\n\r\n        var countOpen = blockString.split(\"[\").length;\r\n        var countClose = blockString.split(\"]\").length;\r\n        if (countClose < countOpen) {\r\n            blockString = blockString + \"]\"; //Close slot if no block behind.\r\n        }\r\n        blockChain.Script = blockString;\r\n        snapsrc.blockReporter.push(blockChain);\r\n    }\r\n    this.topBlock = topBlock || null;\r\n    this.receiver = receiver;\r\n    this.instrument = receiver ? receiver.instrument : null;\r\n    this.readyToYield = false;\r\n    this.readyToTerminate = false;\r\n    this.isDead = false;\r\n    this.isClicked = false;\r\n    this.isShowingResult = false;\r\n    this.errorFlag = false;\r\n    this.context = null;\r\n    this.homeContext = new Context(null, null, null, receiver);\r\n    this.lastYield = Date.now();\r\n    this.isFirstStep = true;\r\n    this.isAtomic = false;\r\n    this.prompter = null;\r\n    this.httpRequest = null;\r\n    this.isPaused = false;\r\n    this.pauseOffset = null;\r\n    this.frameCount = 0;\r\n    this.exportResult = false;\r\n    this.onComplete = onComplete || null;\r\n    this.procedureCount = 0;\r\n    this.flashingContext = null; // experimental, for single-stepping\r\n    this.isInterrupted = false; // experimental, for single-stepping\r\n\r\n    if (topBlock) {\r\n        this.homeContext.variables.parentFrame =\r\n            this.homeContext.receiver.variables;\r\n        this.context = new Context(\r\n            null,\r\n            topBlock.blockSequence(),\r\n            this.homeContext\r\n        );\r\n        if (yieldFirst) {\r\n            this.pushContext('doYield'); // highlight top block\r\n        }\r\n    }\r\n}\r\n\r\n// Process accessing\r\n\r\nProcess.prototype.isRunning = function () {\r\n    return (this.context !== null) && (!this.readyToTerminate);\r\n};\r\n\r\n// Process entry points\r\n\r\nProcess.prototype.runStep = function (deadline) {\r\n    // a step is an an uninterruptable 'atom', it can consist\r\n    // of several contexts, even of several blocks\r\n\r\n    if (this.isPaused) { // allow pausing in between atomic steps:\r\n        return this.pauseStep();\r\n    }\r\n    this.readyToYield = false;\r\n    this.isInterrupted = false;\r\n\r\n    while (!this.readyToYield && !this.isInterrupted\r\n            && this.context\r\n            && (Date.now() - this.lastYield < this.timeout)\r\n    ) {\r\n        // also allow pausing inside atomic steps - for PAUSE block primitive:\r\n        if (this.isPaused) {\r\n            return this.pauseStep();\r\n        }\r\n        if (deadline && (Date.now() > deadline)) {\r\n            if (this.isAtomic &&\r\n                    this.homeContext.receiver &&\r\n                    this.homeContext.receiver.endWarp) {\r\n                this.homeContext.receiver.endWarp();\r\n            }\r\n            return;\r\n        }\r\n        this.evaluateContext();\r\n    }\r\n\r\n    this.lastYield = Date.now();\r\n    this.isFirstStep = false;\r\n\r\n    // make sure to redraw atomic things\r\n    if (this.isAtomic &&\r\n            this.homeContext.receiver &&\r\n            this.homeContext.receiver.endWarp) {\r\n        this.homeContext.receiver.endWarp();\r\n        this.homeContext.receiver.startWarp();\r\n    }\r\n\r\n    if (this.readyToTerminate) {\r\n        while (this.context) {\r\n            this.popContext();\r\n        }\r\n        if (this.homeContext.receiver) {\r\n            if (this.homeContext.receiver.endWarp) {\r\n                // pen optimization\r\n                this.homeContext.receiver.endWarp();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.stop = function () {\r\n    this.readyToYield = true;\r\n    this.readyToTerminate = true;\r\n    this.errorFlag = false;\r\n    if (this.context) {\r\n        this.context.stopMusic();\r\n    }\r\n};\r\n\r\nProcess.prototype.pause = function () {\r\n    if (this.readyToTerminate) {\r\n        return;\r\n    }\r\n    this.isPaused = true;\r\n    this.flashPausedContext();\r\n    if (this.context && this.context.startTime) {\r\n        this.pauseOffset = Date.now() - this.context.startTime;\r\n    }\r\n};\r\n\r\nProcess.prototype.resume = function () {\r\n    if (!this.enableSingleStepping) {\r\n        this.unflash();\r\n    }\r\n    this.isPaused = false;\r\n    this.pauseOffset = null;\r\n};\r\n\r\nProcess.prototype.pauseStep = function () {\r\n    this.lastYield = Date.now();\r\n    if (this.context && this.context.startTime) {\r\n        this.context.startTime = this.lastYield - this.pauseOffset;\r\n    }\r\n};\r\n\r\n// Process evaluation\r\n\r\nProcess.prototype.evaluateContext = function () {\r\n    var exp = this.context.expression;\r\n    this.frameCount += 1;\r\n    if (this.context.tag === 'exit') {\r\n        this.expectReport();\r\n    }\r\n    if (exp instanceof Array) {\r\n        return this.evaluateSequence(exp);\r\n    }\r\n    if (exp instanceof MultiArgMorph) {\r\n        return this.evaluateMultiSlot(exp, exp.inputs().length);\r\n    }\r\n    if (exp instanceof ArgLabelMorph) {\r\n        return this.evaluateArgLabel(exp);\r\n    }\r\n    if (exp instanceof ArgMorph || exp.bindingID) {\r\n        return this.evaluateInput(exp);\r\n    }\r\n    if (exp instanceof BlockMorph) {\r\n        return this.evaluateBlock(exp, exp.inputs().length);\r\n    }\r\n    if (isString(exp)) {\r\n        return this[exp].apply(this, this.context.inputs);\r\n    }\r\n    this.popContext(); // default: just ignore it\r\n};\r\n\r\nProcess.prototype.evaluateBlock = function (block, argCount) {\r\n    var selector = block.selector;\r\n    // check for special forms\r\n    if (selector === 'reportOr' ||\r\n            selector ===  'reportAnd' ||\r\n            selector === 'doReport') {\r\n        return this[selector](block);\r\n    }\r\n\r\n    // first evaluate all inputs, then apply the primitive\r\n    var rcvr = this.context.receiver || this.receiver,\r\n        inputs = this.context.inputs;\r\n\r\n    if (argCount > inputs.length) {\r\n        this.evaluateNextInput(block);\r\n    } else {\r\n        if (this.flashContext()) {return; } // yield to flash the block\r\n        if (this[selector]) {\r\n            rcvr = this;\r\n        }\r\n        if (this.isCatchingErrors) {\r\n            try {\r\n                this.returnValueToParentContext(\r\n                    rcvr[selector].apply(rcvr, inputs)\r\n                );\r\n                this.popContext();\r\n            } catch (error) {\r\n                this.handleError(error, block);\r\n            }\r\n        } else {\r\n            this.returnValueToParentContext(\r\n                rcvr[selector].apply(rcvr, inputs)\r\n            );\r\n            this.popContext();\r\n        }\r\n    }\r\n};\r\n\r\n// Process: Special Forms Blocks Primitives\r\n\r\nProcess.prototype.reportOr = function (block) {\r\n    var inputs = this.context.inputs;\r\n\r\n    if (inputs.length < 1) {\r\n        this.evaluateNextInput(block);\r\n    } else if (inputs[0]) {\r\n        if (this.flashContext()) {return; }\r\n        this.returnValueToParentContext(true);\r\n        this.popContext();\r\n    } else if (inputs.length < 2) {\r\n        this.evaluateNextInput(block);\r\n    } else {\r\n        if (this.flashContext()) {return; }\r\n        this.returnValueToParentContext(inputs[1] === true);\r\n        this.popContext();\r\n    }\r\n};\r\n\r\nProcess.prototype.reportAnd = function (block) {\r\n    var inputs = this.context.inputs;\r\n\r\n    if (inputs.length < 1) {\r\n        this.evaluateNextInput(block);\r\n    } else if (!inputs[0]) {\r\n        if (this.flashContext()) {return; }\r\n        this.returnValueToParentContext(false);\r\n        this.popContext();\r\n    } else if (inputs.length < 2) {\r\n        this.evaluateNextInput(block);\r\n    } else {\r\n        if (this.flashContext()) {return; }\r\n        this.returnValueToParentContext(inputs[1] === true);\r\n        this.popContext();\r\n    }\r\n};\r\n\r\nProcess.prototype.doReport = function (block) {\r\n    var outer = this.context.outerContext;\r\n    if (this.flashContext()) {return; } // flash the block here, special form\r\n    if (this.isClicked && (block.topBlock() === this.topBlock)) {\r\n        this.isShowingResult = true;\r\n    }\r\n    if (this.context.expression.partOfCustomCommand) {\r\n        this.doStopCustomBlock();\r\n        this.popContext();\r\n    } else {\r\n        while (this.context && this.context.tag !== 'exit') {\r\n            if (this.context.expression === 'doStopWarping') {\r\n                this.doStopWarping();\r\n            } else {\r\n                this.popContext();\r\n            }\r\n        }\r\n        if (this.context) {\r\n            if (this.context.expression === 'expectReport') {\r\n                // pop off inserted top-level exit context\r\n                this.popContext();\r\n            } else {\r\n                // un-tag and preserve original caller\r\n                this.context.tag = null;\r\n            }\r\n        }\r\n    }\r\n    // in any case evaluate (and ignore)\r\n    // the input, because it could be\r\n    // and HTTP Request for a hardware extension\r\n    this.pushContext(block.inputs()[0], outer);\r\n};\r\n\r\n// Process: Non-Block evaluation\r\n\r\nProcess.prototype.evaluateMultiSlot = function (multiSlot, argCount) {\r\n    // first evaluate all subslots, then return a list of their values\r\n    var inputs = this.context.inputs,\r\n        ans;\r\n    if (multiSlot.bindingID) {\r\n        if (this.isCatchingErrors) {\r\n            try {\r\n                ans = this.context.variables.getVar(multiSlot.bindingID);\r\n            } catch (error) {\r\n                this.handleError(error, multiSlot);\r\n            }\r\n        } else {\r\n            ans = this.context.variables.getVar(multiSlot.bindingID);\r\n        }\r\n        this.returnValueToParentContext(ans);\r\n        this.popContext();\r\n    } else {\r\n        if (argCount > inputs.length) {\r\n            this.evaluateNextInput(multiSlot);\r\n        } else {\r\n            this.returnValueToParentContext(new List(inputs));\r\n            this.popContext();\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.evaluateArgLabel = function (argLabel) {\r\n    // perform the ID function on an ArgLabelMorph element\r\n    var inputs = this.context.inputs;\r\n    if (inputs.length < 1) {\r\n        this.evaluateNextInput(argLabel);\r\n    } else {\r\n        this.returnValueToParentContext(inputs[0]);\r\n        this.popContext();\r\n    }\r\n};\r\n\r\nProcess.prototype.evaluateInput = function (input) {\r\n    // evaluate the input unless it is bound to an implicit parameter\r\n    var ans;\r\n    if (this.flashContext()) {return; } // yield to flash the current argMorph\r\n    if (input.bindingID) {\r\n        if (this.isCatchingErrors) {\r\n            try {\r\n                ans = this.context.variables.getVar(input.bindingID);\r\n            } catch (error) {\r\n                this.handleError(error, input);\r\n            }\r\n        } else {\r\n            ans = this.context.variables.getVar(input.bindingID);\r\n        }\r\n    } else {\r\n        ans = input.evaluate();\r\n        if (ans) {\r\n            if (input.constructor === CommandSlotMorph ||\r\n                    input.constructor === ReporterSlotMorph ||\r\n                    (input instanceof CSlotMorph &&\r\n                        (!input.isStatic || input.isLambda))) {\r\n                // I know, this still needs yet to be done right....\r\n                ans = this.reify(ans, new List());\r\n            }\r\n        }\r\n    }\r\n    this.returnValueToParentContext(ans);\r\n    this.popContext();\r\n};\r\n\r\nProcess.prototype.evaluateSequence = function (arr) {\r\n    var pc = this.context.pc,\r\n        outer = this.context.outerContext,\r\n        isCustomBlock = this.context.isCustomBlock;\r\n    if (pc === (arr.length - 1)) { // tail call elimination\r\n        this.context = new Context(\r\n            this.context.parentContext,\r\n            arr[pc],\r\n            this.context.outerContext,\r\n            this.context.receiver\r\n        );\r\n        this.context.isCustomBlock = isCustomBlock;\r\n    } else {\r\n        if (pc >= arr.length) {\r\n            this.popContext();\r\n        } else {\r\n            this.context.pc += 1;\r\n            this.pushContext(arr[pc], outer);\r\n        }\r\n    }\r\n};\r\n\r\n/*\r\n// version w/o tail call optimization:\r\n--------------------------------------\r\nCaution: we cannot just revert to this version of the method, because to make\r\ntail call elimination work many tweaks had to be done to various primitives.\r\nFor the most part these tweaks are about schlepping the outer context (for\r\nthe variable bindings) and the isCustomBlock flag along, and are indicated\r\nby a short comment in the code. But to really revert would take a good measure\r\nof trial and error as well as debugging. In the developers file archive there\r\nis a version of threads.js dated 120119(2) which basically resembles the\r\nlast version before introducing tail call optimization on 120123.\r\n*/\r\n\r\nProcess.prototype.evaluateNextInput = function (element) {\r\n    var nxt = this.context.inputs.length,\r\n        args = element.inputs(),\r\n        exp = args[nxt],\r\n        sel = this.context.expression.selector,\r\n        outer = this.context.outerContext; // for tail call elimination\r\n\r\n    if (exp.isUnevaluated) {\r\n        if (exp.isUnevaluated === true || exp.isUnevaluated()) {\r\n            // just return the input as-is\r\n            /*\r\n                Note: we only reify the input here, if it's not an\r\n                input to a reification primitive itself (THE BLOCK,\r\n                THE SCRIPT), because those allow for additional\r\n                explicit parameter bindings.\r\n            */\r\n            if (sel === 'reify' || sel === 'reportScript') {\r\n                this.context.addInput(exp);\r\n            } else {\r\n                this.context.addInput(this.reify(exp, new List()));\r\n            }\r\n        } else {\r\n            this.pushContext(exp, outer);\r\n        }\r\n    } else {\r\n        this.pushContext(exp, outer);\r\n    }\r\n};\r\n\r\nProcess.prototype.doYield = function () {\r\n    this.popContext();\r\n    if (!this.isAtomic) {\r\n        this.readyToYield = true;\r\n    }\r\n};\r\n\r\nProcess.prototype.expectReport = function () {\r\n    this.handleError(new Error(\"reporter didn't report\"));\r\n};\r\n\r\n// Process Exception Handling\r\n\r\nProcess.prototype.handleError = function (error, element) {\r\n    var m = element;\r\n    this.stop();\r\n    this.errorFlag = true;\r\n    this.topBlock.addErrorHighlight();\r\n    if (isNil(m) || isNil(m.world())) {m = this.topBlock; }\r\n    m.showBubble(\r\n        (m === element ? '' : 'Inside: ')\r\n            + error.name\r\n            + '\\n'\r\n            + error.message,\r\n        this.exportResult,\r\n        this.receiver\r\n    );\r\n};\r\n\r\nProcess.prototype.errorObsolete = function () {\r\n    throw new Error('a custom block definition is missing');\r\n};\r\n\r\n// Process Lambda primitives\r\n\r\nProcess.prototype.reify = function (topBlock, parameterNames, isCustomBlock) {\r\n    var context = new Context(\r\n            null,\r\n            null,\r\n            this.context ? this.context.outerContext : null\r\n        ),\r\n        i = 0;\r\n\r\n    if (topBlock) {\r\n        context.expression = this.enableLiveCoding ||\r\n            this.enableSingleStepping ?\r\n                topBlock : topBlock.fullCopy();\r\n        context.expression.show(); // be sure to make visible if in app mode\r\n\r\n        if (!isCustomBlock && !parameterNames.length()) {\r\n            // mark all empty slots with an identifier\r\n            context.expression.allEmptySlots().forEach(function (slot) {\r\n                i += 1;\r\n                if (slot instanceof MultiArgMorph) {\r\n                    slot.bindingID = ['arguments'];\r\n                } else {\r\n                    slot.bindingID = i;\r\n                }\r\n            });\r\n            // and remember the number of detected empty slots\r\n            context.emptySlots = i;\r\n        }\r\n\r\n    } else {\r\n        context.expression = this.enableLiveCoding ||\r\n            this.enableSingleStepping ? [this.context.expression]\r\n                : [this.context.expression.fullCopy()];\r\n    }\r\n\r\n    context.inputs = parameterNames.asArray();\r\n    context.receiver\r\n        = this.context ? this.context.receiver : this.receiver;\r\n    context.origin = context.receiver; // for serialization\r\n\r\n    return context;\r\n};\r\n\r\nProcess.prototype.reportScript = function (parameterNames, topBlock) {\r\n    return this.reify(topBlock, parameterNames);\r\n};\r\n\r\nProcess.prototype.reifyScript = function (topBlock, parameterNames) {\r\n    return this.reify(topBlock, parameterNames);\r\n};\r\n\r\nProcess.prototype.reifyReporter = function (topBlock, parameterNames) {\r\n    return this.reify(topBlock, parameterNames);\r\n};\r\n\r\nProcess.prototype.reifyPredicate = function (topBlock, parameterNames) {\r\n    return this.reify(topBlock, parameterNames);\r\n};\r\n\r\nProcess.prototype.reportJSFunction = function (parmNames, body) {\r\n    return Function.apply(\r\n        null,\r\n        parmNames.asArray().concat([body])\r\n    );\r\n};\r\n\r\nProcess.prototype.doRun = function (context, args) {\r\n    return this.evaluate(context, args, true);\r\n};\r\n\r\nProcess.prototype.evaluate = function (\r\n    context,\r\n    args,\r\n    isCommand\r\n) {\r\n    if (!context) {return null; }\r\n    if (context instanceof Function) {\r\n        \r\n        return context.apply(\r\n            this.blockReceiver(),\r\n            args.asArray().concat([this])\r\n        );\r\n    }\r\n    if (context.isContinuation) {\r\n        return this.runContinuation(context, args);\r\n    }\r\n    if (!(context instanceof Context)) {\r\n        throw new Error('expecting a ring but getting ' + context);\r\n    }\r\n\r\n    var outer = new Context(null, null, context.outerContext),\r\n        caller = this.context.parentContext,\r\n        exit,\r\n        runnable,\r\n        parms = args.asArray(),\r\n        i,\r\n        value;\r\n\r\n    if (!outer.receiver) {\r\n        outer.receiver = context.receiver; // for custom blocks\r\n    }\r\n    runnable = new Context(\r\n        this.context.parentContext,\r\n        context.expression,\r\n        outer,\r\n        context.receiver\r\n    );\r\n    this.context.parentContext = runnable;\r\n\r\n    if (context.expression instanceof ReporterBlockMorph) {\r\n        // auto-\"warp\" nested reporters\r\n        this.readyToYield = (Date.now() - this.lastYield > this.timeout);\r\n    }\r\n\r\n    // assign parameters if any were passed\r\n    if (parms.length > 0) {\r\n\r\n        // assign formal parameters\r\n        for (i = 0; i < context.inputs.length; i += 1) {\r\n            value = 0;\r\n            if (!isNil(parms[i])) {\r\n                value = parms[i];\r\n            }\r\n            outer.variables.addVar(context.inputs[i], value);\r\n        }\r\n\r\n        // assign implicit parameters if there are no formal ones\r\n        if (context.inputs.length === 0) {\r\n            // assign the actual arguments list to the special\r\n            // parameter ID ['arguments'], to be used for variadic inputs\r\n            outer.variables.addVar(['arguments'], args);\r\n\r\n            // in case there is only one input\r\n            // assign it to all empty slots\r\n            if (parms.length === 1) {\r\n                for (i = 1; i <= context.emptySlots; i += 1) {\r\n                    outer.variables.addVar(i, parms[0]);\r\n                }\r\n\r\n            // if the number of inputs matches the number\r\n            // of empty slots distribute them sequentially\r\n            } else if (parms.length === context.emptySlots) {\r\n                for (i = 1; i <= parms.length; i += 1) {\r\n                    outer.variables.addVar(i, parms[i - 1]);\r\n                }\r\n\r\n            } else if (context.emptySlots !== 1) {\r\n                throw new Error(\r\n                    localize('expecting') + ' ' + context.emptySlots + ' '\r\n                        + localize('input(s), but getting') + ' '\r\n                        + parms.length\r\n                );\r\n            }\r\n        }\r\n    }\r\n\r\n    if (runnable.expression instanceof CommandBlockMorph) {\r\n        runnable.expression = runnable.expression.blockSequence();\r\n        if (!isCommand) {\r\n            if (caller) {\r\n                // tag caller, so \"report\" can catch it later\r\n                caller.tag = 'exit';\r\n            } else {\r\n                // top-level context, insert a tagged exit context\r\n                // which \"report\" can catch later\r\n                exit = new Context(\r\n                    runnable.parentContext,\r\n                    'expectReport',\r\n                    outer,\r\n                    outer.receiver\r\n                );\r\n                exit.tag = 'exit';\r\n                runnable.parentContext = exit;\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.fork = function (context, args) {\r\n    var proc = new Process(),\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n    proc.instrument = this.instrument;\r\n    proc.receiver = this.receiver;\r\n    proc.initializeFor(context, args, this.enableSingleStepping);\r\n    // proc.pushContext('doYield');\r\n    stage.threads.processes.push(proc);\r\n};\r\n\r\nProcess.prototype.initializeFor = function (context, args, ignoreExit) {\r\n    // used by Process.fork() and global invoke()\r\n    if (context.isContinuation) {\r\n        throw new Error(\r\n            'continuations cannot be forked'\r\n        );\r\n    }\r\n    if (!(context instanceof Context)) {\r\n        throw new Error('expecting a ring but getting ' + context);\r\n    }\r\n\r\n    var outer = new Context(null, null, context.outerContext),\r\n        runnable = new Context(null,\r\n            context.expression,\r\n            outer\r\n            ),\r\n        parms = args.asArray(),\r\n        i,\r\n        value,\r\n        exit;\r\n\r\n    // remember the receiver\r\n    this.context = context.receiver;\r\n\r\n    // assign parameters if any were passed\r\n    if (parms.length > 0) {\r\n\r\n        // assign formal parameters\r\n        for (i = 0; i < context.inputs.length; i += 1) {\r\n            value = 0;\r\n            if (!isNil(parms[i])) {\r\n                value = parms[i];\r\n            }\r\n            outer.variables.addVar(context.inputs[i], value);\r\n        }\r\n\r\n        // assign implicit parameters if there are no formal ones\r\n        if (context.inputs.length === 0) {\r\n            // assign the actual arguments list to the special\r\n            // parameter ID ['arguments'], to be used for variadic inputs\r\n            outer.variables.addVar(['arguments'], args);\r\n\r\n            // in case there is only one input\r\n            // assign it to all empty slots\r\n            if (parms.length === 1) {\r\n                for (i = 1; i <= context.emptySlots; i += 1) {\r\n                    outer.variables.addVar(i, parms[0]);\r\n                }\r\n\r\n            // if the number of inputs matches the number\r\n            // of empty slots distribute them sequentially\r\n            } else if (parms.length === context.emptySlots) {\r\n                for (i = 1; i <= parms.length; i += 1) {\r\n                    outer.variables.addVar(i, parms[i - 1]);\r\n                }\r\n\r\n            } else if (context.emptySlots !== 1) {\r\n                throw new Error(\r\n                    localize('expecting') + ' ' + context.emptySlots + ' '\r\n                        + localize('input(s), but getting') + ' '\r\n                        + parms.length\r\n                );\r\n            }\r\n        }\r\n    }\r\n\r\n    if (runnable.expression instanceof CommandBlockMorph) {\r\n        runnable.expression = runnable.expression.blockSequence();\r\n\r\n        // insert a tagged exit context\r\n        // which \"report\" can catch later\r\n        // needed for invoke() situations\r\n        if (!ignoreExit) { // when single stepping LAUNCH\r\n\t        exit = new Context(\r\n    \t        runnable.parentContext,\r\n        \t    'expectReport',\r\n            \touter,\r\n            \touter.receiver\r\n        \t);\r\n        \texit.tag = 'exit';\r\n        \trunnable.parentContext = exit;\r\n    \t}\r\n    }\r\n\r\n    this.homeContext = new Context(); // context.outerContext;\r\n    this.homeContext.receiver = context.outerContext.receiver;\r\n    this.topBlock = context.expression;\r\n    this.context = runnable;\r\n};\r\n\r\n// Process stopping blocks primitives\r\n\r\nProcess.prototype.doStopBlock = function () {\r\n    var target = this.context.expression.exitTag;\r\n    if (isNil(target)) {\r\n        return this.doStopCustomBlock();\r\n    }\r\n    while (this.context &&\r\n            (isNil(this.context.tag) || (this.context.tag > target))) {\r\n        if (this.context.expression === 'doStopWarping') {\r\n            this.doStopWarping();\r\n        } else {\r\n            this.popContext();\r\n        }\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doStopCustomBlock = function () {\r\n    // fallback solution for \"report\" blocks inside\r\n    // custom command definitions and untagged \"stop\" blocks\r\n    while (this.context && !this.context.isCustomBlock) {\r\n        if (this.context.expression === 'doStopWarping') {\r\n            this.doStopWarping();\r\n        } else {\r\n            this.popContext();\r\n        }\r\n    }\r\n};\r\n\r\n// Process continuations primitives\r\n\r\nProcess.prototype.doCallCC = function (aContext, isReporter) {\r\n    this.evaluate(\r\n        aContext,\r\n        new List([this.context.continuation()]),\r\n        !isReporter\r\n    );\r\n};\r\n\r\nProcess.prototype.reportCallCC = function (aContext) {\r\n    this.doCallCC(aContext, true);\r\n};\r\n\r\nProcess.prototype.runContinuation = function (aContext, args) {\r\n    var parms = args.asArray();\r\n\r\n    // determine whether the continuations is to show the result\r\n    // in a value-balloon becuse the user has directly clicked on a reporter\r\n    if (aContext.expression === 'expectReport' && parms.length) {\r\n        this.stop();\r\n        this.homeContext.inputs[0] = parms[0];\r\n        return;\r\n    }\r\n\r\n    this.context.parentContext = aContext.copyForContinuationCall();\r\n    // passing parameter if any was passed\r\n    if (parms.length === 1) {\r\n        this.context.parentContext.outerContext.variables.addVar(\r\n            1,\r\n            parms[0]\r\n        );\r\n    }\r\n};\r\n\r\n// Process custom block primitives\r\n\r\nProcess.prototype.evaluateCustomBlock = function () {\r\n    var caller = this.context.parentContext,\r\n        block = this.context.expression,\r\n        method = block.isGlobal ? block.definition\r\n                : this.blockReceiver().getMethod(block.semanticSpec),\r\n        context = method.body,\r\n        declarations = method.declarations,\r\n        args = new List(this.context.inputs),\r\n        parms = args.asArray(),\r\n        runnable,\r\n        exit,\r\n        i,\r\n        value,\r\n        outer;\r\n\r\n    if (!context) {return null; }\r\n    this.procedureCount += 1;\r\n    outer = new Context();\r\n    outer.receiver = this.context.receiver;\r\n\r\n    outer.variables.parentFrame = block.variables;\r\n\r\n    // block (instance) var support, experimental:\r\n    // only splice in block vars if any are defined, because block vars\r\n    // can cause race conditions in global block definitions that\r\n    // access sprite-local variables at the same time.\r\n    if (method.variableNames.length) {\r\n        block.variables.parentFrame = outer.receiver ?\r\n                outer.receiver.variables : null;\r\n    } else {\r\n        // original code without block variables:\r\n        outer.variables.parentFrame = outer.receiver ?\r\n                outer.receiver.variables : null;\r\n    }\r\n\r\n    runnable = new Context(\r\n        this.context.parentContext,\r\n        context.expression,\r\n        outer,\r\n        outer.receiver\r\n    );\r\n    runnable.isCustomBlock = true;\r\n    this.context.parentContext = runnable;\r\n\r\n    // passing parameters if any were passed\r\n    if (parms.length > 0) {\r\n\r\n        // assign formal parameters\r\n        for (i = 0; i < context.inputs.length; i += 1) {\r\n            value = 0;\r\n            if (!isNil(parms[i])) {\r\n                value = parms[i];\r\n            }\r\n            outer.variables.addVar(context.inputs[i], value);\r\n\r\n            // if the parameter is an upvar,\r\n            // create a reference to the variable it points to\r\n            if (declarations[context.inputs[i]][0] === '%upvar') {\r\n                this.context.outerContext.variables.vars[value] =\r\n                    outer.variables.vars[context.inputs[i]];\r\n            }\r\n        }\r\n    }\r\n\r\n    // tag return target\r\n    if (method.type !== 'command') {\r\n        if (caller) {\r\n            // tag caller, so \"report\" can catch it later\r\n            caller.tag = 'exit';\r\n        } else {\r\n            // top-level context, insert a tagged exit context\r\n            // which \"report\" can catch later\r\n            exit = new Context(\r\n                runnable.parentContext,\r\n                'expectReport',\r\n                outer,\r\n                outer.receiver\r\n            );\r\n            exit.tag = 'exit';\r\n            runnable.parentContext = exit;\r\n        }\r\n        // auto-\"warp\" nested reporters\r\n        this.readyToYield = (Date.now() - this.lastYield > this.timeout);\r\n    } else {\r\n        // tag all \"stop this block\" blocks with the current\r\n        // procedureCount as exitTag, and mark all \"report\" blocks\r\n        // as being inside a custom command definition\r\n        runnable.expression.tagExitBlocks(this.procedureCount, true);\r\n\r\n        // tag the caller with the current procedure count, so\r\n        // \"stop this block\" blocks can catch it, but only\r\n        // if the caller hasn't been tagged already\r\n        if (caller && !caller.tag) {\r\n            caller.tag = this.procedureCount;\r\n        }\r\n        // yield commands unless explicitly \"warped\" or directly recursive\r\n        if (!this.isAtomic && method.isDirectlyRecursive()) {\r\n            this.readyToYield = true;\r\n        }\r\n    }\r\n    runnable.expression = runnable.expression.blockSequence();\r\n};\r\n\r\n// Process variables primitives\r\n\r\nProcess.prototype.doDeclareVariables = function (varNames) {\r\n    var varFrame = this.context.outerContext.variables;\r\n    varNames.asArray().forEach(function (name) {\r\n        varFrame.addVar(name);\r\n    });\r\n};\r\n\r\nProcess.prototype.doSetVar = function (varName, value) {\r\n    var varFrame = this.context.variables,\r\n        name = varName,\r\n        rcvr;\r\n    if (name instanceof Context) {\r\n        rcvr = this.blockReceiver();\r\n        if (name.expression.selector === 'reportGetVar') {\r\n            name.variables.setVar(\r\n                name.expression.blockSpec,\r\n                value,\r\n                rcvr\r\n            );\r\n            return;\r\n        }\r\n        this.doSet(name, value);\r\n        return;\r\n    }\r\n    varFrame.setVar(name, value, this.blockReceiver());\r\n};\r\n\r\nProcess.prototype.doChangeVar = function (varName, value) {\r\n    var varFrame = this.context.variables,\r\n        name = varName;\r\n\r\n    if (name instanceof Context) {\r\n        if (name.expression.selector === 'reportGetVar') {\r\n            name.variables.changeVar(\r\n                name.expression.blockSpec,\r\n                value,\r\n                this.blockReceiver()\r\n            );\r\n            return;\r\n        }\r\n    }\r\n    varFrame.changeVar(name, value, this.blockReceiver());\r\n};\r\n\r\nProcess.prototype.reportGetVar = function () {\r\n    // assumes a getter block whose blockSpec is a variable name\r\n    return this.context.variables.getVar(\r\n        this.context.expression.blockSpec\r\n    );\r\n};\r\n\r\nProcess.prototype.doShowVar = function (varName) {\r\n    var varFrame = this.context.variables,\r\n        stage,\r\n        watcher,\r\n        target,\r\n        label,\r\n        others,\r\n        isGlobal,\r\n        name = varName;\r\n\r\n    if (name instanceof Context) {\r\n        if (name.expression.selector === 'reportGetVar') {\r\n            name = name.expression.blockSpec;\r\n        } else {\r\n            this.doChangePrimitiveVisibility(name.expression, false);\r\n            return;\r\n        }\r\n    }\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            target = varFrame.silentFind(name);\r\n            if (!target) {return; }\r\n            // first try to find an existing (hidden) watcher\r\n            watcher = detect(\r\n                stage.children,\r\n                function (morph) {\r\n                    return morph instanceof WatcherMorph\r\n                        && morph.target === target\r\n                        && morph.getter === name;\r\n                }\r\n            );\r\n            if (watcher !== null) {\r\n                watcher.show();\r\n                watcher.fixLayout(); // re-hide hidden parts\r\n                return;\r\n            }\r\n            // if no watcher exists, create a new one\r\n            isGlobal = contains(\r\n                this.homeContext.receiver.globalVariables().names(),\r\n                varName\r\n            );\r\n            if (isGlobal || target.owner) {\r\n                label = name;\r\n            } else {\r\n                label = name + ' ' + localize('(temporary)');\r\n            }\r\n            watcher = new WatcherMorph(\r\n                label,\r\n                SpriteMorph.prototype.blockColor.variables,\r\n                target,\r\n                name\r\n            );\r\n            watcher.setPosition(stage.position().add(10));\r\n            others = stage.watchers(watcher.left());\r\n            if (others.length > 0) {\r\n                watcher.setTop(others[others.length - 1].bottom());\r\n            }\r\n            stage.add(watcher);\r\n            watcher.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doHideVar = function (varName) {\r\n    // if no varName is specified delete all watchers on temporaries\r\n    var varFrame = this.context.variables,\r\n        stage,\r\n        watcher,\r\n        target,\r\n        name = varName;\r\n\r\n    if (name instanceof Context) {\r\n        if (name.expression.selector === 'reportGetVar') {\r\n            name = name.expression.blockSpec;\r\n        } else {\r\n            this.doChangePrimitiveVisibility(name.expression, true);\r\n            return;\r\n        }\r\n    }\r\n    if (!name) {\r\n        this.doRemoveTemporaries();\r\n        return;\r\n    }\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            target = varFrame.find(name);\r\n            watcher = detect(\r\n                stage.children,\r\n                function (morph) {\r\n                    return morph instanceof WatcherMorph\r\n                        && morph.target === target\r\n                        && morph.getter === name;\r\n                }\r\n            );\r\n            if (watcher !== null) {\r\n                if (watcher.isTemporary()) {\r\n                    watcher.destroy();\r\n                } else {\r\n                    watcher.hide();\r\n                }\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doRemoveTemporaries = function () {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.watchers().forEach(function (watcher) {\r\n                if (watcher.isTemporary()) {\r\n                    watcher.destroy();\r\n                }\r\n            });\r\n        }\r\n    }\r\n};\r\n\r\n// Process hiding and showing primitives primitives :-)\r\n\r\nProcess.prototype.doChangePrimitiveVisibility = function (aBlock, hideIt) {\r\n    var ide = this.homeContext.receiver.parentThatIsA(IDE_Morph),\r\n        dict,\r\n        cat;\r\n    if (!ide || (aBlock.selector === 'evaluateCustomBlock')) {\r\n        return;\r\n    }\r\n    if (hideIt) {\r\n        StageMorph.prototype.hiddenPrimitives[aBlock.selector] = true;\r\n    } else {\r\n        delete StageMorph.prototype.hiddenPrimitives[aBlock.selector];\r\n    }\r\n    dict = {\r\n        doWarp: 'control',\r\n        reifyScript: 'operators',\r\n        reifyReporter: 'operators',\r\n        reifyPredicate: 'operators',\r\n        doDeclareVariables: 'variables'\r\n    };\r\n    cat = dict[this.selector] || this.category;\r\n    if (cat === 'lists') {cat = 'variables'; }\r\n    ide.flushBlocksCache(cat);\r\n    ide.refreshPalette();\r\n};\r\n\r\n// Process sprite inheritance primitives\r\n\r\nProcess.prototype.doDeleteAttr = function (attrName) {\r\n    var name = attrName,\r\n        rcvr = this.blockReceiver();\r\n    if (name instanceof Context) {\r\n        if (name.expression.selector === 'reportGetVar') {\r\n            name = name.expression.blockSpec;\r\n        } else { // attribute\r\n            name = {\r\n                xPosition: 'x position',\r\n                yPosition: 'y position',\r\n                direction: 'direction',\r\n                getCostumeIdx: 'costume #',\r\n                size: 'size'\r\n            }[name.expression.selector];\r\n            if (!isNil(name)) {\r\n                rcvr.inheritAttribute(name);\r\n            }\r\n            return; // error: cannot delete attribute...\r\n        }\r\n    }\r\n    if (name instanceof Array) {\r\n        return rcvr.inheritAttribute(this.inputOption(name));\r\n    }\r\n    if (contains(rcvr.inheritedVariableNames(true), name)) {\r\n        rcvr.deleteVariable(name);\r\n    }\r\n};\r\n\r\n// experimental message passing primitives\r\n\r\nProcess.prototype.doTellTo = function (sprite, context, args) {\r\n    this.doRun(\r\n        this.reportAttributeOf(context, sprite),\r\n        args\r\n    );\r\n};\r\n\r\nProcess.prototype.reportAskFor = function (sprite, context, args) {\r\n    this.evaluate(\r\n        this.reportAttributeOf(context, sprite),\r\n        args\r\n    );\r\n};\r\n\r\n// Process lists primitives\r\n\r\nProcess.prototype.reportNewList = function (elements) {\r\n    return elements;\r\n};\r\n\r\nProcess.prototype.reportCONS = function (car, cdr) {\r\n    this.assertType(cdr, 'list');\r\n    return new List().cons(car, cdr);\r\n};\r\n\r\nProcess.prototype.reportCDR = function (list) {\r\n    this.assertType(list, 'list');\r\n    return list.cdr();\r\n};\r\n\r\nProcess.prototype.doAddToList = function (element, list) {\r\n    this.assertType(list, 'list');\r\n    if (list.type) {\r\n        this.assertType(element, list.type);\r\n    }\r\n    list.add(element);\r\n};\r\n\r\nProcess.prototype.doDeleteFromList = function (index, list) {\r\n    var idx = index;\r\n    this.assertType(list, 'list');\r\n    if (this.inputOption(index) === 'all') {\r\n        return list.clear();\r\n    }\r\n    if (index === '') {\r\n        return null;\r\n    }\r\n    if (this.inputOption(index) === 'last') {\r\n        idx = list.length();\r\n    } else if (isNaN(+this.inputOption(index))) {\r\n        return null;\r\n    }\r\n    list.remove(idx);\r\n};\r\n\r\nProcess.prototype.doInsertInList = function (element, index, list) {\r\n    var idx = index;\r\n    this.assertType(list, 'list');\r\n    if (list.type) {\r\n        this.assertType(element, list.type);\r\n    }\r\n    if (index === '') {\r\n        return null;\r\n    }\r\n    if (this.inputOption(index) === 'any') {\r\n        idx = this.reportRandom(1, list.length() + 1);\r\n    }\r\n    if (this.inputOption(index) === 'last') {\r\n        idx = list.length() + 1;\r\n    }\r\n    list.add(element, idx);\r\n};\r\n\r\nProcess.prototype.doReplaceInList = function (index, list, element) {\r\n    var idx = index;\r\n    this.assertType(list, 'list');\r\n    if (list.type) {\r\n        this.assertType(element, list.type);\r\n    }\r\n    if (index === '') {\r\n        return null;\r\n    }\r\n    if (this.inputOption(index) === 'any') {\r\n        idx = this.reportRandom(1, list.length());\r\n    }\r\n    if (this.inputOption(index) === 'last') {\r\n        idx = list.length();\r\n    }\r\n    list.put(element, idx);\r\n};\r\n\r\nProcess.prototype.reportListItem = function (index, list) {\r\n    var idx = index;\r\n    this.assertType(list, 'list');\r\n    if (index === '') {\r\n        return '';\r\n    }\r\n    if (this.inputOption(index) === 'any') {\r\n        idx = this.reportRandom(1, list.length());\r\n    }\r\n    if (this.inputOption(index) === 'last') {\r\n        idx = list.length();\r\n    }\r\n    return list.at(idx);\r\n};\r\n\r\nProcess.prototype.reportListLength = function (list) {\r\n    this.assertType(list, 'list');\r\n    return list.length();\r\n};\r\n\r\nProcess.prototype.reportListContainsItem = function (list, element) {\r\n    this.assertType(list, 'list');\r\n    return list.contains(element);\r\n};\r\n\r\nProcess.prototype.doShowTable = function (list) {\r\n    // experimental\r\n    this.assertType(list, 'list');\r\n    new TableDialogMorph(list).popUp(this.blockReceiver().world());\r\n};\r\n\r\n// Process conditionals primitives\r\n\r\nProcess.prototype.doIf = function () {\r\n    var args = this.context.inputs,\r\n        outer = this.context.outerContext, // for tail call elimination\r\n        isCustomBlock = this.context.isCustomBlock;\r\n\r\n    this.popContext();\r\n    if (args[0]) {\r\n        if (args[1]) {\r\n            this.pushContext(args[1].blockSequence(), outer);\r\n            this.context.isCustomBlock = isCustomBlock;\r\n        }\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doIfElse = function () {\r\n    var args = this.context.inputs,\r\n        outer = this.context.outerContext, // for tail call elimination\r\n        isCustomBlock = this.context.isCustomBlock;\r\n\r\n    this.popContext();\r\n    if (args[0]) {\r\n        if (args[1]) {\r\n            this.pushContext(args[1].blockSequence(), outer);\r\n        }\r\n    } else {\r\n        if (args[2]) {\r\n            this.pushContext(args[2].blockSequence(), outer);\r\n        } else {\r\n            this.pushContext('doYield');\r\n        }\r\n    }\r\n    if (this.context) {\r\n        this.context.isCustomBlock = isCustomBlock;\r\n    }\r\n\r\n    this.pushContext();\r\n};\r\n\r\n// Process process related primitives\r\n\r\nProcess.prototype.doStop = function () {\r\n    this.stop();\r\n};\r\n\r\nProcess.prototype.doStopAll = function () {\r\n    var stage, ide;\r\n   \r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.threads.resumeAll(stage);\r\n            stage.keysPressed = {};\r\n            stage.threads.stopAll();\r\n            stage.stopAllActiveSounds();\r\n            stage.children.forEach(function (morph) {\r\n                if (morph.stopTalking) {\r\n                    morph.stopTalking();\r\n                }\r\n            });\r\n            stage.removeAllClones();\r\n        }\r\n        ide = stage.parentThatIsA(IDE_Morph);\r\n        if (ide) {ide.controlBar.pauseButton.refresh(); }\r\n    }\r\n};\r\n\r\nProcess.prototype.doStopThis = function (choice) {\r\n    switch (this.inputOption(choice)) {\r\n    case 'all':\r\n        this.doStopAll();\r\n        break;\r\n    case 'this script':\r\n        this.doStop();\r\n        break;\r\n    case 'this block':\r\n        this.doStopBlock();\r\n        break;\r\n    default:\r\n        this.doStopOthers(choice);\r\n    }\r\n};\r\n\r\nProcess.prototype.doStopOthers = function (choice) {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            switch (this.inputOption(choice)) {\r\n            case 'all but this script':\r\n                stage.threads.stopAll(this);\r\n                break;\r\n            case 'other scripts in sprite':\r\n                stage.threads.stopAllForReceiver(\r\n                    this.homeContext.receiver,\r\n                    this\r\n                );\r\n                break;\r\n            default:\r\n                nop();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doWarp = function (body) {\r\n    // execute my contents block atomically (more or less)\r\n    var outer = this.context.outerContext, // for tail call elimination\r\n        isCustomBlock = this.context.isCustomBlock,\r\n        stage;\r\n\r\n    this.popContext();\r\n\r\n    if (body) {\r\n        if (this.homeContext.receiver) {\r\n            if (this.homeContext.receiver.startWarp) {\r\n                // pen optimization\r\n                this.homeContext.receiver.startWarp();\r\n            }\r\n            stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n            if (stage) {\r\n                stage.fps = 0; // variable frame rate\r\n            }\r\n        }\r\n        this.pushContext('doYield');\r\n        this.context.isCustomBlock = isCustomBlock;\r\n        if (!this.isAtomic) {\r\n            this.pushContext('doStopWarping');\r\n        }\r\n        this.pushContext(body.blockSequence(), outer);\r\n        this.isAtomic = true;\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doStopWarping = function () {\r\n    var stage;\r\n    this.popContext();\r\n    this.isAtomic = false;\r\n    if (this.homeContext.receiver) {\r\n        if (this.homeContext.receiver.endWarp) {\r\n            // pen optimization\r\n            this.homeContext.receiver.endWarp();\r\n        }\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.fps = stage.frameRate; //  back to fixed frame rate\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.reportIsFastTracking = function () {\r\n    var ide;\r\n    if (this.homeContext.receiver) {\r\n        ide = this.homeContext.receiver.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            return ide.stage.isFastTracked;\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.doSetFastTracking = function (bool) {\r\n    var ide;\r\n    if (!this.reportIsA(bool, 'Boolean')) {\r\n        return;\r\n    }\r\n    if (this.homeContext.receiver) {\r\n        ide = this.homeContext.receiver.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            if (bool) {\r\n                ide.startFastTracking();\r\n            } else {\r\n                ide.stopFastTracking();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doPauseAll = function () {\r\n    var stage, ide;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.threads.pauseAll(stage);\r\n        }\r\n        ide = stage.parentThatIsA(IDE_Morph);\r\n        if (ide) {ide.controlBar.pauseButton.refresh(); }\r\n    }\r\n};\r\n\r\n// Process loop primitives\r\n\r\nProcess.prototype.doForever = function (body) {\r\n    this.context.inputs = []; // force re-evaluation of C-slot\r\n    this.pushContext('doYield');\r\n    if (body) {\r\n        this.pushContext(body.blockSequence());\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doRepeat = function (counter, body) {\r\n    var block = this.context.expression,\r\n        outer = this.context.outerContext, // for tail call elimination\r\n        isCustomBlock = this.context.isCustomBlock;\r\n\r\n    if (counter < 1) { // was '=== 0', which caused infinite loops on non-ints\r\n        return null;\r\n    }\r\n    this.popContext();\r\n    this.pushContext(block, outer);\r\n    this.context.isCustomBlock = isCustomBlock;\r\n    this.context.addInput(counter - 1);\r\n    this.pushContext('doYield');\r\n    if (body) {\r\n        this.pushContext(body.blockSequence());\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doUntil = function (goalCondition, body) {\r\n    if (goalCondition) {\r\n        this.popContext();\r\n        this.pushContext('doYield');\r\n        return null;\r\n    }\r\n    this.context.inputs = [];\r\n    this.pushContext('doYield');\r\n    if (body) {\r\n        this.pushContext(body.blockSequence());\r\n    }\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doWaitUntil = function (goalCondition) {\r\n    if (goalCondition) {\r\n        this.popContext();\r\n        this.pushContext('doYield');\r\n        return null;\r\n    }\r\n    this.context.inputs = [];\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.reportMap = function (reporter, list) {\r\n    // answer a new list containing the results of the reporter applied\r\n    // to each value of the given list. Distinguish between linked and\r\n    // arrayed lists.\r\n    // Note: This method utilizes the current context's inputs array to\r\n    // manage temporary variables, whose allocation to which slot are\r\n    // documented in each of the variants' code (linked or arrayed) below\r\n\r\n    var next;\r\n    if (list.isLinked) {\r\n        // this.context.inputs:\r\n        // [0] - reporter\r\n        // [1] - list (original source)\r\n        // -----------------------------\r\n        // [2] - result list (target)\r\n        // [3] - currently last element of result list\r\n        // [4] - current source list (what's left to map)\r\n        // [5] - current value of last function call\r\n\r\n        if (this.context.inputs.length < 3) {\r\n            this.context.addInput(new List());\r\n            this.context.inputs[2].isLinked = true;\r\n            this.context.addInput(this.context.inputs[2]);\r\n            this.context.addInput(list);\r\n        }\r\n        if (this.context.inputs[4].length() === 0) {\r\n            this.context.inputs[3].rest = list.cons(this.context.inputs[5]);\r\n            this.returnValueToParentContext(this.context.inputs[2].cdr());\r\n            return;\r\n        }\r\n        if (this.context.inputs.length > 5) {\r\n            this.context.inputs[3].rest = list.cons(this.context.inputs[5]);\r\n            this.context.inputs[3] = this.context.inputs[3].rest;\r\n            this.context.inputs.splice(5);\r\n        }\r\n        next = this.context.inputs[4].at(1);\r\n        this.context.inputs[4] = this.context.inputs[4].cdr();\r\n        this.pushContext();\r\n        this.evaluate(reporter, new List([next]));\r\n    } else { // arrayed\r\n        // this.context.inputs:\r\n        // [0] - reporter\r\n        // [1] - list (original source)\r\n        // -----------------------------\r\n        // [2..n] - result values (target)\r\n\r\n        if (this.context.inputs.length - 2 === list.length()) {\r\n            this.returnValueToParentContext(\r\n                new List(this.context.inputs.slice(2))\r\n            );\r\n            return;\r\n        }\r\n        next = list.at(this.context.inputs.length - 1);\r\n        this.pushContext();\r\n        this.evaluate(reporter, new List([next]));\r\n    }\r\n};\r\n\r\nProcess.prototype.doForEach = function (upvar, list, script) {\r\n    // perform a script for each element of a list, assigning the\r\n    // current iteration's element to a variable with the name\r\n    // specified in the \"upvar\" parameter, so it can be referenced\r\n    // within the script. Uses the context's - unused - fourth\r\n    // element as temporary storage for the current list index\r\n\r\n    if (isNil(this.context.inputs[3])) {this.context.inputs[3] = 1; }\r\n    var index = this.context.inputs[3];\r\n    this.context.outerContext.variables.addVar(upvar);\r\n    this.context.outerContext.variables.setVar(\r\n        upvar,\r\n        list.at(index)\r\n    );\r\n    if (index > list.length()) {return; }\r\n    this.context.inputs[3] += 1;\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n    this.evaluate(script, new List(), true);\r\n};\r\n\r\n// Process interpolated primitives\r\n\r\nProcess.prototype.doWait = function (secs) {\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n    }\r\n    if ((Date.now() - this.context.startTime) >= (secs * 1000)) {\r\n        if (!this.isAtomic && (secs === 0)) {\r\n            // \"wait 0 secs\" is a plain \"yield\"\r\n            // that can be overridden by \"warp\"\r\n            this.readyToYield = true;\r\n        }\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doGlide = function (secs, endX, endY) {\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n        this.context.startValue = new Point(\r\n            this.blockReceiver().xPosition(),\r\n            this.blockReceiver().yPosition()\r\n        );\r\n    }\r\n    if ((Date.now() - this.context.startTime) >= (secs * 1000)) {\r\n        this.blockReceiver().gotoXY(endX, endY);\r\n        return null;\r\n    }\r\n    this.blockReceiver().glide(\r\n        secs * 1000,\r\n        endX,\r\n        endY,\r\n        Date.now() - this.context.startTime,\r\n        this.context.startValue\r\n    );\r\n\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doSayFor = function (data, secs) {\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n        this.blockReceiver().bubble(data);\r\n    }\r\n    if ((Date.now() - this.context.startTime) >= (secs * 1000)) {\r\n        this.blockReceiver().stopTalking();\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doThinkFor = function (data, secs) {\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n        this.blockReceiver().doThink(data);\r\n    }\r\n    if ((Date.now() - this.context.startTime) >= (secs * 1000)) {\r\n        this.blockReceiver().stopTalking();\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.blockReceiver = function () {\r\n    return this.context ? this.context.receiver || this.homeContext.receiver\r\n            : this.homeContext.receiver || this.receiver;\r\n};\r\n\r\n// Process sound primitives (interpolated)\r\n\r\nProcess.prototype.doPlaySoundUntilDone = function (name) {\r\n    var sprite = this.blockReceiver();\r\n    if (this.context.activeAudio === null) {\r\n        this.context.activeAudio = sprite.playSound(name);\r\n    }\r\n    if (this.context.activeAudio.ended\r\n            || this.context.activeAudio.terminated) {\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doStopAllSounds = function () {\r\n    var stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        stage.threads.processes.forEach(function (thread) {\r\n            if (thread.context) {\r\n                thread.context.stopMusic();\r\n                if (thread.context.activeAudio) {\r\n                    thread.popContext();\r\n                }\r\n            }\r\n        });\r\n        stage.stopAllActiveSounds();\r\n    }\r\n};\r\n\r\n// Process user prompting primitives (interpolated)\r\n\r\nProcess.prototype.doAsk = function (data) {\r\n    var stage = this.homeContext.receiver.parentThatIsA(StageMorph),\r\n        rcvr = this.blockReceiver(),\r\n        isStage = rcvr instanceof StageMorph,\r\n        isHiddenSprite = rcvr instanceof SpriteMorph && !rcvr.isVisible,\r\n        activePrompter;\r\n\r\n    stage.keysPressed = {};\r\n    if (!this.prompter) {\r\n        activePrompter = detect(\r\n            stage.children,\r\n            function (morph) {return morph instanceof StagePrompterMorph; }\r\n        );\r\n        if (!activePrompter) {\r\n            if (!isStage && !isHiddenSprite) {\r\n                rcvr.bubble(data, false, true);\r\n            }\r\n            this.prompter = new StagePrompterMorph(\r\n                isStage || isHiddenSprite ? data : null\r\n            );\r\n            if (stage.scale < 1) {\r\n                this.prompter.setWidth(stage.width() - 10);\r\n            } else {\r\n                this.prompter.setWidth(stage.dimensions.x - 20);\r\n            }\r\n            this.prompter.fixLayout();\r\n            this.prompter.setCenter(stage.center());\r\n            this.prompter.setBottom(stage.bottom() - this.prompter.border);\r\n            stage.add(this.prompter);\r\n            this.prompter.inputField.edit();\r\n            stage.changed();\r\n        }\r\n    } else {\r\n        if (this.prompter.isDone) {\r\n            stage.lastAnswer = this.prompter.inputField.getValue();\r\n            this.prompter.destroy();\r\n            this.prompter = null;\r\n            if (!isStage) {rcvr.stopTalking(); }\r\n            return null;\r\n        }\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.reportLastAnswer = function () {\r\n    return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer;\r\n};\r\n\r\n// Process URI retrieval (interpolated)\r\n\r\nProcess.prototype.reportURL = function (url) {\r\n    var response;\r\n    if (!this.httpRequest) {\r\n        // use the location protocol unless the user specifies otherwise\r\n        if (url.indexOf('//') < 0 || url.indexOf('//') > 8) {\r\n            if (location.protocol === 'file:') {\r\n                // allow requests from locally loaded sources\r\n                url = 'https://' + url;\r\n            } else {\r\n                url = location.protocol + '//' + url;\r\n            }\r\n        }\r\n        this.httpRequest = new XMLHttpRequest();\r\n        this.httpRequest.open(\"GET\", url, true);\r\n        this.httpRequest.send(null);\r\n    } else if (this.httpRequest.readyState === 4) {\r\n        response = this.httpRequest.responseText;\r\n        this.httpRequest = null;\r\n        return response;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\n// Process event messages primitives\r\n\r\nProcess.prototype.doBroadcast = function (message) {\r\n    // messages are user-defined events, and by default global, same as in\r\n    // Scratch. An experimental feature, messages can be sent to a single\r\n    // sprite or to a list of sprites by using a 2-item list in the message\r\n    // slot, where the first slot is a message text, and the second slot\r\n    // its recipient(s), identified either by a single name or sprite, or by\r\n    // a list of names or sprites (can be a heterogeneous list).\r\n\r\n    var stage = this.homeContext.receiver.parentThatIsA(StageMorph),\r\n        thisObj,\r\n        msg = message,\r\n        trg,\r\n        rcvrs,\r\n        myself = this,\r\n        procs = [];\r\n\r\n    if (message instanceof List && (message.length() === 2)) {\r\n        thisObj = this.blockReceiver();\r\n        msg = message.at(1);\r\n        trg = message.at(2);\r\n        if (isSnapObject(trg)) {\r\n            rcvrs = [trg];\r\n        } else if (isString(trg)) {\r\n            // assume the string to be the name of a sprite or the stage\r\n            if (trg === stage.name) {\r\n                rcvrs = [stage];\r\n            } else {\r\n                rcvrs = [this.getOtherObject(trg, thisObj, stage)];\r\n            }\r\n        } else if (trg instanceof List) {\r\n            // assume all elements to be sprites or sprite names\r\n            rcvrs = trg.itemsArray().map(function (each) {\r\n                return myself.getOtherObject(each, thisObj, stage);\r\n            });\r\n        } else {\r\n            return; // abort\r\n        }\r\n    } else { // global\r\n        rcvrs = stage.children.concat(stage);\r\n    }\r\n    if (msg !== '') {\r\n        stage.lastMessage = message; // the actual data structure\r\n        rcvrs.forEach(function (morph) {\r\n            if (isSnapObject(morph)) {\r\n                morph.allHatBlocksFor(msg).forEach(function (block) {\r\n                    procs.push(stage.threads.startProcess(\r\n                        block,\r\n                        morph,\r\n                        stage.isThreadSafe\r\n                    ));\r\n                });\r\n            }\r\n        });\r\n    }\r\n    return procs;\r\n};\r\n\r\nProcess.prototype.doBroadcastAndWait = function (message) {\r\n    if (!this.context.activeSends) {\r\n        this.context.activeSends = this.doBroadcast(message);\r\n    }\r\n    this.context.activeSends = this.context.activeSends.filter(\r\n        function (proc) {\r\n            return proc.isRunning();\r\n        }\r\n    );\r\n    if (this.context.activeSends.length === 0) {\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.getLastMessage = function () {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            return stage.getLastMessage();\r\n        }\r\n    }\r\n    return '';\r\n};\r\n\r\n// Process type inference\r\n\r\nProcess.prototype.reportIsA = function (thing, typeString) {\r\n    return this.reportTypeOf(thing) === this.inputOption(typeString);\r\n};\r\n\r\nProcess.prototype.assertType = function (thing, typeString) {\r\n    // make sure \"thing\" is a particular type or any of a number of types\r\n    // and raise an error if not\r\n    // use responsibly wrt performance implications\r\n    var thingType = this.reportTypeOf(thing);\r\n    if (thingType === typeString) {return true; }\r\n    if (typeString instanceof Array && contains(typeString, thingType)) {\r\n        return true;\r\n    }\r\n    throw new Error('expecting ' + typeString + ' but getting ' + thingType);\r\n};\r\n\r\nProcess.prototype.assertAlive = function (thing) {\r\n    if (thing && thing.isCorpse) {\r\n        throw new Error('cannot operate on a deleted sprite');\r\n    }\r\n};\r\n\r\nProcess.prototype.reportTypeOf = function (thing) {\r\n    // answer a string denoting the argument's type\r\n    var exp;\r\n    if (thing === null || (thing === undefined)) {\r\n        return 'nothing';\r\n    }\r\n    if (thing === true || (thing === false)) {\r\n        return 'Boolean';\r\n    }\r\n    if (!isNaN(+thing)) {\r\n        return 'number';\r\n    }\r\n    if (isString(thing)) {\r\n        return 'text';\r\n    }\r\n    if (thing instanceof List) {\r\n        return 'list';\r\n    }\r\n    if (thing instanceof SpriteMorph) {\r\n        return 'sprite';\r\n    }\r\n    if (thing instanceof StageMorph) {\r\n        return 'stage';\r\n    }\r\n    if (thing instanceof Costume) {\r\n        return 'costume';\r\n    }\r\n    if (thing instanceof Sound) {\r\n        return 'sound';\r\n    }\r\n    if (thing instanceof Context) {\r\n        if (thing.expression instanceof RingMorph) {\r\n            return thing.expression.dataType();\r\n        }\r\n        if (thing.expression instanceof ReporterBlockMorph) {\r\n            if (thing.expression.isPredicate) {\r\n                return 'predicate';\r\n            }\r\n            return 'reporter';\r\n        }\r\n\r\n        if (thing.expression instanceof Array) {\r\n            exp = thing.expression[thing.pc || 0];\r\n            if (exp.isPredicate) {\r\n                return 'predicate';\r\n            }\r\n            if (exp instanceof RingMorph) {\r\n                return exp.dataType();\r\n            }\r\n            if (exp instanceof ReporterBlockMorph) {\r\n                return 'reporter';\r\n            }\r\n            if (exp instanceof CommandBlockMorph) {\r\n                return 'command';\r\n            }\r\n            return 'reporter'; // 'ring';\r\n        }\r\n\r\n        if (thing.expression instanceof CommandBlockMorph) {\r\n            return 'command';\r\n        }\r\n        return 'reporter'; // 'ring';\r\n    }\r\n    return 'undefined';\r\n};\r\n\r\n// Process math primtives\r\n\r\nProcess.prototype.reportSum = function (a, b) {\r\n    return +a + (+b);\r\n};\r\n\r\nProcess.prototype.reportDifference = function (a, b) {\r\n    return +a - +b;\r\n};\r\n\r\nProcess.prototype.reportProduct = function (a, b) {\r\n    return +a * +b;\r\n};\r\n\r\nProcess.prototype.reportQuotient = function (a, b) {\r\n    return +a / +b;\r\n};\r\n\r\nProcess.prototype.reportModulus = function (a, b) {\r\n    var x = +a,\r\n        y = +b;\r\n    return ((x % y) + y) % y;\r\n};\r\n\r\nProcess.prototype.reportRandom = function (min, max) {\r\n    var floor = +min,\r\n        ceil = +max;\r\n    if ((floor % 1 !== 0) || (ceil % 1 !== 0)) {\r\n        return Math.random() * (ceil - floor) + floor;\r\n    }\r\n    return Math.floor(Math.random() * (ceil - floor + 1)) + floor;\r\n};\r\n\r\nProcess.prototype.reportLessThan = function (a, b) {\r\n    var x = +a,\r\n        y = +b;\r\n    if (isNaN(x) || isNaN(y)) {\r\n        x = a;\r\n        y = b;\r\n    }\r\n    return x < y;\r\n};\r\n\r\nProcess.prototype.reportNot = function (bool) {\r\n    return !bool;\r\n};\r\n\r\nProcess.prototype.reportGreaterThan = function (a, b) {\r\n    var x = +a,\r\n        y = +b;\r\n    if (isNaN(x) || isNaN(y)) {\r\n        x = a;\r\n        y = b;\r\n    }\r\n    return x > y;\r\n};\r\n\r\nProcess.prototype.reportEquals = function (a, b) {\r\n    return snapEquals(a, b);\r\n};\r\n\r\nProcess.prototype.reportIsIdentical = function (a, b) {\r\n    var tag = 'idTag';\r\n    if (this.isImmutable(a) || this.isImmutable(b)) {\r\n        return snapEquals(a, b);\r\n    }\r\n\r\n    function clear() {\r\n        if (Object.prototype.hasOwnProperty.call(a, tag)) {\r\n            delete a[tag];\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(b, tag)) {\r\n            delete b[tag];\r\n        }\r\n    }\r\n\r\n    clear();\r\n    a[tag] = Date.now();\r\n    if (b[tag] === a[tag]) {\r\n        clear();\r\n        return true;\r\n    }\r\n    clear();\r\n    return false;\r\n};\r\n\r\nProcess.prototype.isImmutable = function (obj) {\r\n    // private\r\n    var type = this.reportTypeOf(obj);\r\n    return type === 'nothing' ||\r\n        type === 'Boolean' ||\r\n        type === 'text' ||\r\n        type === 'number' ||\r\n        type === 'undefined';\r\n};\r\n\r\nProcess.prototype.reportBoolean = function (bool) {\r\n    return bool;\r\n};\r\n\r\nProcess.prototype.reportRound = function (n) {\r\n    return Math.round(+n);\r\n};\r\n\r\nProcess.prototype.reportMonadic = function (fname, n) {\r\n    var x = +n,\r\n        result = 0;\r\n\r\n    switch (this.inputOption(fname)) {\r\n    case 'abs':\r\n        result = Math.abs(x);\r\n        break;\r\n    case 'ceiling':\r\n        result = Math.ceil(x);\r\n        break;\r\n    case 'floor':\r\n        result = Math.floor(x);\r\n        break;\r\n    case 'sqrt':\r\n        result = Math.sqrt(x);\r\n        break;\r\n    case 'sin':\r\n        result = Math.sin(radians(x));\r\n        break;\r\n    case 'cos':\r\n        result = Math.cos(radians(x));\r\n        break;\r\n    case 'tan':\r\n        result = Math.tan(radians(x));\r\n        break;\r\n    case 'asin':\r\n        result = degrees(Math.asin(x));\r\n        break;\r\n    case 'acos':\r\n        result = degrees(Math.acos(x));\r\n        break;\r\n    case 'atan':\r\n        result = degrees(Math.atan(x));\r\n        break;\r\n    case 'ln':\r\n        result = Math.log(x);\r\n        break;\r\n    case 'log': // base 10\r\n        result =  Math.log(x) / Math.LN10;\r\n        break;\r\n    case 'e^':\r\n        result = Math.exp(x);\r\n        break;\r\n    case '10^':\r\n        result = Math.pow(10, x);\r\n        break;\r\n    default:\r\n        nop();\r\n    }\r\n    return result;\r\n};\r\n\r\nProcess.prototype.reportTextFunction = function (fname, string) {\r\n    var x = (isNil(string) ? '' : string).toString(),\r\n        result = '';\r\n\r\n    switch (this.inputOption(fname)) {\r\n    case 'encode URI':\r\n        result = encodeURI(x);\r\n        break;\r\n    case 'decode URI':\r\n        result = decodeURI(x);\r\n        break;\r\n    case 'encode URI component':\r\n        result = encodeURIComponent(x);\r\n        break;\r\n    case 'decode URI component':\r\n        result = decodeURIComponent(x);\r\n        break;\r\n    case 'XML escape':\r\n        result = new XML_Element().escape(x);\r\n        break;\r\n    case 'XML unescape':\r\n        result = new XML_Element().unescape(x);\r\n        break;\r\n    case 'hex sha512 hash':\r\n        result = hex_sha512(x);\r\n        break;\r\n    default:\r\n        nop();\r\n    }\r\n    return result;\r\n};\r\n\r\nProcess.prototype.reportJoin = function (a, b) {\r\n    var x = (isNil(a) ? '' : a).toString(),\r\n        y = (isNil(b) ? '' : b).toString();\r\n    return x.concat(y);\r\n};\r\n\r\nProcess.prototype.reportJoinWords = function (aList) {\r\n    if (aList instanceof List) {\r\n        return aList.asText();\r\n    }\r\n    return (aList || '').toString();\r\n};\r\n\r\n// Process string ops\r\n\r\nProcess.prototype.reportLetter = function (idx, string) {\r\n    if (string instanceof List) { // catch a common user error\r\n        return '';\r\n    }\r\n    var i = +(idx || 0),\r\n        str = isNil(string) ? '' : string.toString();\r\n    return str[i - 1] || '';\r\n};\r\n\r\nProcess.prototype.reportStringSize = function (data) {\r\n    if (data instanceof List) { // catch a common user error\r\n        return data.length();\r\n    }\r\n\r\n    return isNil(data) ? 0 : data.toString().length;\r\n};\r\n\r\nProcess.prototype.reportUnicode = function (string) {\r\n    var str = (string || '').toString()[0];\r\n    return str ? str.charCodeAt(0) : 0;\r\n};\r\n\r\nProcess.prototype.reportUnicodeAsLetter = function (num) {\r\n    var code = +(num || 0);\r\n    return String.fromCharCode(code);\r\n};\r\n\r\nProcess.prototype.reportTextSplit = function (string, delimiter) {\r\n    var types = ['text', 'number'],\r\n        strType = this.reportTypeOf(string),\r\n        delType = this.reportTypeOf(this.inputOption(delimiter)),\r\n        str,\r\n        del;\r\n    if (!contains(types, strType)) {\r\n        throw new Error('expecting text instead of a ' + strType);\r\n    }\r\n    if (!contains(types, delType)) {\r\n        throw new Error('expecting a text delimiter instead of a ' + delType);\r\n    }\r\n    str = isNil(string) ? '' : string.toString();\r\n    switch (this.inputOption(delimiter)) {\r\n    case 'line':\r\n        // Unicode compliant line splitting (platform independent)\r\n        // http://www.unicode.org/reports/tr18/#Line_Boundaries\r\n        del = /\\r\\n|[\\n\\v\\f\\r\\x85\\u2028\\u2029]/;\r\n        break;\r\n    case 'tab':\r\n        del = '\\t';\r\n        break;\r\n    case 'cr':\r\n        del = '\\r';\r\n        break;\r\n    case 'whitespace':\r\n        str = str.trim();\r\n        del = /\\s+/;\r\n        break;\r\n    case 'letter':\r\n        del = '';\r\n        break;\r\n    case 'csv':\r\n        return this.parseCSV(string);\r\n    default:\r\n        del = isNil(delimiter) ? '' : delimiter.toString();\r\n    }\r\n    return new List(str.split(del));\r\n};\r\n\r\nProcess.prototype.parseCSV = function (string) {\r\n    // parse a single row of CSV data into a one-dimensional list\r\n    // this assumes that the whole csv data has already been split\r\n    // by lines.\r\n    // taken from:\r\n    // https://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript-which-contains-comma-in-data\r\n\r\n    var re_valid = /^\\s*(?:'[^'\\\\]*(?:\\\\[\\S\\s][^'\\\\]*)*'|\"[^\"\\\\]*(?:\\\\[\\S\\s][^\"\\\\]*)*\"|[^,'\"\\s\\\\]*(?:\\s+[^,'\"\\s\\\\]+)*)\\s*(?:,\\s*(?:'[^'\\\\]*(?:\\\\[\\S\\s][^'\\\\]*)*'|\"[^\"\\\\]*(?:\\\\[\\S\\s][^\"\\\\]*)*\"|[^,'\"\\s\\\\]*(?:\\s+[^,'\"\\s\\\\]+)*)\\s*)*$/,\r\n        re_value = /(?!\\s*$)\\s*(?:'([^'\\\\]*(?:\\\\[\\S\\s][^'\\\\]*)*)'|\"([^\"\\\\]*(?:\\\\[\\S\\s][^\"\\\\]*)*)\"|([^,'\"\\s\\\\]*(?:\\s+[^,'\"\\s\\\\]+)*))\\s*(?:,|$)/g,\r\n        a = [];\r\n\r\n    if (!re_valid.test(string)) {\r\n        return new List();\r\n    }\r\n    string.replace(\r\n        re_value,\r\n        function(m0, m1, m2, m3) {\r\n            if (m1 !== undefined) {\r\n                // remove backslash from \\' in single quoted values.\r\n                a.push(m1.replace(/\\\\'/g, \"'\"));\r\n            } else if (m2 !== undefined) {\r\n                // remove backslash from \\\" in double quoted values.\r\n                a.push(m2.replace(/\\\\\"/g, '\"'));\r\n            } else if (m3 !== undefined) {\r\n                a.push(m3);\r\n            }\r\n            return '';\r\n        }\r\n    );\r\n    // special case: empty last value.\r\n    if (/,\\s*$/.test(string)) {\r\n        a.push('');\r\n    }\r\n    return new List(a);\r\n};\r\n\r\n// Process debugging\r\n\r\nProcess.prototype.alert = function (data) {\r\n    // debugging primitives only work in dev mode, otherwise they're nop\r\n    var world;\r\n    if (this.homeContext.receiver) {\r\n        world = this.homeContext.receiver.world();\r\n        if (world.isDevMode) {\r\n            alert('Snap! ' + data.asArray());\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.log = function (data) {\r\n    // debugging primitives only work in dev mode, otherwise they're nop\r\n    var world;\r\n    if (this.homeContext.receiver) {\r\n        world = this.homeContext.receiver.world();\r\n        if (world.isDevMode) {\r\n        }\r\n    }\r\n};\r\n\r\n// Process motion primitives\r\n\r\nProcess.prototype.getOtherObject = function (name, thisObj, stageObj) {\r\n    // private, find the sprite indicated by the given name\r\n    // either onstage or in the World's hand\r\n\r\n    // experimental: deal with first-class sprites\r\n    if (isSnapObject(name)) {\r\n        return name;\r\n    }\r\n\r\n    var stage = isNil(stageObj) ?\r\n                thisObj.parentThatIsA(StageMorph) : stageObj,\r\n        thatObj = null;\r\n\r\n    if (stage) {\r\n        // find the corresponding sprite on the stage\r\n        thatObj = detect(\r\n            stage.children,\r\n            function (morph) {return morph.name === name; }\r\n        );\r\n        if (!thatObj) {\r\n            // check if the sprite in question is currently being\r\n            // dragged around\r\n            thatObj = detect(\r\n                stage.world().hand.children,\r\n                function (morph) {\r\n                    return morph instanceof SpriteMorph\r\n                        && morph.name === name;\r\n                }\r\n            );\r\n        }\r\n    }\r\n    return thatObj;\r\n};\r\n\r\nProcess.prototype.getObjectsNamed = function (name, thisObj, stageObj) {\r\n    // private, find all sprites and their clones indicated\r\n    // by the given name either onstage or in the World's hand\r\n\r\n    var stage = isNil(stageObj) ?\r\n                thisObj.parentThatIsA(StageMorph) : stageObj,\r\n        those = [];\r\n\r\n    function check(obj) {\r\n        return obj instanceof SpriteMorph && obj.isTemporary ?\r\n                obj.cloneOriginName === name : obj.name === name;\r\n    }\r\n\r\n    if (stage) {\r\n        // find the corresponding sprite on the stage\r\n        those = stage.children.filter(check);\r\n        if (!those.length) {\r\n            // check if a sprite in question is currently being\r\n            // dragged around\r\n            those = stage.world().hand.children.filter(check);\r\n        }\r\n    }\r\n    return those;\r\n};\r\n\r\nProcess.prototype.doFaceTowards = function (name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj;\r\n\r\n    if (thisObj) {\r\n        if (this.inputOption(name) === 'mouse-pointer') {\r\n            thisObj.faceToXY(this.reportMouseX(), this.reportMouseY());\r\n        } else {\r\n            if (name instanceof List) {\r\n                thisObj.faceToXY(\r\n                    name.at(1),\r\n                    name.at(2)\r\n                );\r\n                return;\r\n            }\r\n            thatObj = this.getOtherObject(name, this.homeContext.receiver);\r\n            if (thatObj) {\r\n                thisObj.faceToXY(\r\n                    thatObj.xPosition(),\r\n                    thatObj.yPosition()\r\n                );\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doGotoObject = function (name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj;\r\n\r\n    if (thisObj) {\r\n        if (this.inputOption(name) === 'mouse-pointer') {\r\n            thisObj.gotoXY(this.reportMouseX(), this.reportMouseY());\r\n        } else {\r\n            if (name instanceof List) {\r\n                thisObj.gotoXY(\r\n                    name.at(1),\r\n                    name.at(2)\r\n                );\r\n                return;\r\n            }\r\n            thatObj = this.getOtherObject(name, this.homeContext.receiver);\r\n            if (thatObj) {\r\n                thisObj.gotoXY(\r\n                    thatObj.xPosition(),\r\n                    thatObj.yPosition()\r\n                );\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n// Process temporary cloning (Scratch-style)\r\n\r\nProcess.prototype.createClone = function (name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj;\r\n\r\n    if (!name) {return; }\r\n    if (thisObj) {\r\n        if (this.inputOption(name) === 'myself') {\r\n            thisObj.createClone(!this.isFirstStep);\r\n        } else {\r\n            thatObj = this.getOtherObject(name, thisObj);\r\n            if (thatObj) {\r\n                thatObj.createClone(!this.isFirstStep);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.newClone = function (name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj;\r\n\r\n    if (!name) {return; }\r\n    if (thisObj) {\r\n        if (this.inputOption(name) === 'myself') {\r\n            return thisObj.newClone(!this.isFirstStep);\r\n        }\r\n        thatObj = this.getOtherObject(name, thisObj);\r\n        if (thatObj) {\r\n            return thatObj.newClone(!this.isFirstStep);\r\n        }\r\n    }\r\n};\r\n\r\n// Process sensing primitives\r\n\r\nProcess.prototype.reportTouchingObject = function (name) {\r\n    var thisObj = this.blockReceiver();\r\n\r\n    if (thisObj) {\r\n        return this.objectTouchingObject(thisObj, name);\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.objectTouchingObject = function (thisObj, name) {\r\n    // helper function for reportTouchingObject()\r\n    // also check for temparary clones, as in Scratch 2.0,\r\n    // and for any parts (subsprites)\r\n    var myself = this,\r\n        those,\r\n        stage,\r\n        box,\r\n        mouse;\r\n\r\n    if (this.inputOption(name) === 'mouse-pointer') {\r\n        mouse = thisObj.world().hand.position();\r\n        if (thisObj.bounds.containsPoint(mouse) &&\r\n                !thisObj.isTransparentAt(mouse)) {\r\n            return true;\r\n        }\r\n    } else {\r\n        stage = thisObj.parentThatIsA(StageMorph);\r\n\r\n        if (stage) {\r\n            if (this.inputOption(name) === 'edge') {\r\n                box = thisObj.bounds;\r\n                if (!thisObj.costume && thisObj.penBounds) {\r\n                    box = thisObj.penBounds.translateBy(thisObj.position());\r\n                }\r\n                if (!stage.bounds.containsRectangle(box)) {\r\n                    return true;\r\n                }\r\n            }\r\n            if (this.inputOption(name) === 'pen trails' &&\r\n                    thisObj.isTouching(stage.penTrailsMorph())) {\r\n                return true;\r\n            }\r\n            if (isSnapObject(name)) {\r\n                return thisObj.isTouching(name);\r\n            }\r\n            if (name instanceof List) { // assume all elements to be sprites\r\n                those = name.itemsArray();\r\n            } else {\r\n                those = this.getObjectsNamed(name, thisObj, stage); // clones\r\n            }\r\n            if (those.some(function (any) {\r\n                    return thisObj.isTouching(any);\r\n                })) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n    return thisObj.parts.some(\r\n        function (any) {\r\n            return myself.objectTouchingObject(any, name);\r\n        }\r\n    );\r\n};\r\n\r\nProcess.prototype.reportTouchingColor = function (aColor) {\r\n    // also check for any parts (subsprites)\r\n    var thisObj = this.blockReceiver(),\r\n        stage;\r\n\r\n    if (thisObj) {\r\n        stage = thisObj.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            if (thisObj.isTouching(stage.colorFiltered(aColor, thisObj))) {\r\n                return true;\r\n            }\r\n            return thisObj.parts.some(\r\n                function (any) {\r\n                    return any.isTouching(stage.colorFiltered(aColor, any));\r\n                }\r\n            );\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.reportColorIsTouchingColor = function (color1, color2) {\r\n    // also check for any parts (subsprites)\r\n    var thisObj = this.blockReceiver(),\r\n        stage;\r\n\r\n    if (thisObj) {\r\n        stage = thisObj.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            if (thisObj.colorFiltered(color1).isTouching(\r\n                    stage.colorFiltered(color2, thisObj)\r\n                )) {\r\n                return true;\r\n            }\r\n            return thisObj.parts.some(\r\n                function (any) {\r\n                    return any.colorFiltered(color1).isTouching(\r\n                        stage.colorFiltered(color2, any)\r\n                    );\r\n                }\r\n            );\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.reportDistanceTo = function (name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj,\r\n        stage,\r\n        rc,\r\n        point;\r\n\r\n    if (thisObj) {\r\n        rc = thisObj.rotationCenter();\r\n        point = rc;\r\n        if (this.inputOption(name) === 'mouse-pointer') {\r\n            point = thisObj.world().hand.position();\r\n        } else if (name instanceof List) {\r\n            return new Point(thisObj.xPosition(), thisObj.yPosition())\r\n                .distanceTo(new Point(name.at(1), name.at(2)));\r\n        }\r\n        stage = thisObj.parentThatIsA(StageMorph);\r\n        thatObj = this.getOtherObject(name, thisObj, stage);\r\n        if (thatObj) {\r\n            point = thatObj.rotationCenter();\r\n        }\r\n        return rc.distanceTo(point) / stage.scale;\r\n    }\r\n    return 0;\r\n};\r\n\r\nProcess.prototype.reportAttributeOf = function (attribute, name) {\r\n    var thisObj = this.blockReceiver(),\r\n        thatObj,\r\n        stage;\r\n\r\n    if (thisObj) {\r\n        this.assertAlive(thisObj);\r\n        stage = thisObj.parentThatIsA(StageMorph);\r\n        if (stage.name === name) {\r\n            thatObj = stage;\r\n        } else {\r\n            thatObj = this.getOtherObject(name, thisObj, stage);\r\n        }\r\n        if (thatObj) {\r\n            this.assertAlive(thatObj);\r\n            if (attribute instanceof Context) {\r\n                return this.reportContextFor(attribute, thatObj);\r\n            }\r\n            if (isString(attribute)) {\r\n                return thatObj.variables.getVar(attribute);\r\n            }\r\n            switch (this.inputOption(attribute)) {\r\n            case 'x position':\r\n                return thatObj.xPosition ? thatObj.xPosition() : '';\r\n            case 'y position':\r\n                return thatObj.yPosition ? thatObj.yPosition() : '';\r\n            case 'direction':\r\n                return thatObj.direction ? thatObj.direction() : '';\r\n            case 'costume #':\r\n                return thatObj.getCostumeIdx();\r\n            case 'costume name':\r\n                return thatObj.costume ? thatObj.costume.name\r\n                        : thatObj instanceof SpriteMorph ? localize('Turtle')\r\n                                : localize('Empty');\r\n            case 'size':\r\n                return thatObj.getScale ? thatObj.getScale() : '';\r\n            }\r\n        }\r\n    }\r\n    return '';\r\n};\r\n\r\nProcess.prototype.reportGet = function (query) {\r\n    // experimental, answer a reference to a first-class member\r\n    // or a list of first-class members\r\n    var thisObj = this.blockReceiver(),\r\n        neighborhood,\r\n        stage,\r\n        objName;\r\n\r\n    if (thisObj) {\r\n        switch (this.inputOption(query)) {\r\n        case 'self' :\r\n            return thisObj;\r\n        case 'other sprites':\r\n            stage = thisObj.parentThatIsA(StageMorph);\r\n            return new List(\r\n                stage.children.filter(function (each) {\r\n                    return each instanceof SpriteMorph &&\r\n                        each !== thisObj;\r\n                })\r\n            );\r\n        case 'parts':\r\n            return new List(thisObj.parts || []);\r\n        case 'anchor':\r\n            return thisObj.anchor || '';\r\n        case 'parent':\r\n            return thisObj.exemplar || '';\r\n        case 'children':\r\n            return new List(thisObj.specimens ? thisObj.specimens() : []);\r\n        case 'temporary?':\r\n            return thisObj.isTemporary || false;\r\n        case 'clones':\r\n            stage = thisObj.parentThatIsA(StageMorph);\r\n            objName = thisObj.name || thisObj.cloneOriginName;\r\n            return new List(\r\n                stage.children.filter(function (each) {\r\n                    return each.isTemporary &&\r\n                        (each !== thisObj) &&\r\n                        (each.cloneOriginName === objName);\r\n                })\r\n            );\r\n        case 'other clones':\r\n            return thisObj.isTemporary ?\r\n                    this.reportGet(['clones']) : new List();\r\n        case 'neighbors':\r\n            stage = thisObj.parentThatIsA(StageMorph);\r\n            neighborhood = thisObj.bounds.expandBy(new Point(\r\n                thisObj.width(),\r\n                thisObj.height()\r\n            ));\r\n            return new List(\r\n                stage.children.filter(function (each) {\r\n                    return each instanceof SpriteMorph &&\r\n                        (each !== thisObj) &&\r\n                        each.bounds.intersects(neighborhood);\r\n                })\r\n            );\r\n        case 'dangling?':\r\n            return !thisObj.rotatesWithAnchor;\r\n        case 'rotation x':\r\n            return thisObj.xPosition();\r\n        case 'rotation y':\r\n            return thisObj.yPosition();\r\n        case 'center x':\r\n            return thisObj.xCenter();\r\n        case 'center y':\r\n            return thisObj.yCenter();\r\n        case 'name':\r\n            return thisObj.name;\r\n        case 'stage':\r\n            return thisObj.parentThatIsA(StageMorph);\r\n        case 'costumes':\r\n            return thisObj.reportCostumes();\r\n        case 'sounds':\r\n            return thisObj.sounds;\r\n        }\r\n    }\r\n    return '';\r\n};\r\n\r\nProcess.prototype.doSet = function (attribute, value) {\r\n    // experimental, manipulate sprites' attributes\r\n    var name, rcvr;\r\n    if (!(attribute instanceof Context)) {\r\n        return;\r\n    }\r\n    rcvr = this.blockReceiver();\r\n    this.assertAlive(rcvr);\r\n    if (!(attribute instanceof Context) ||\r\n            attribute.expression.selector !== 'reportGet') {\r\n        throw new Error(localize('unsupported attribute'));\r\n    }\r\n    name = attribute.expression.inputs()[0].evaluate();\r\n    if (name instanceof Array) {\r\n        name = name[0];\r\n    }\r\n    switch (name) {\r\n    case 'anchor':\r\n        this.assertType(rcvr, 'sprite');\r\n        if (value instanceof SpriteMorph) {\r\n            // avoid circularity here, because the GUI already checks for\r\n            // conflicts while the user drags parts over prospective targets\r\n            if (!rcvr.enableNesting || contains(rcvr.allParts(), value)) {\r\n                throw new Error(\r\n                    localize('unable to nest\\n(disabled or circular?)')\r\n                );\r\n            }\r\n            value.attachPart(rcvr);\r\n        } else {\r\n            rcvr.detachFromAnchor();\r\n        }\r\n        break;\r\n    case 'parent':\r\n        this.assertType(rcvr, 'sprite');\r\n        value = value instanceof SpriteMorph ? value : null;\r\n        // needed: circularity avoidance\r\n        rcvr.setExemplar(value);\r\n        break;\r\n    case 'temporary?':\r\n        this.assertType(rcvr, 'sprite');\r\n        this.assertType(value, 'Boolean');\r\n        if (rcvr.world().isDevMode) {\r\n            if (value) {\r\n                rcvr.release();\r\n            } else {\r\n                rcvr.perpetuate();\r\n            }\r\n        }\r\n        break;\r\n    case 'dangling?':\r\n        this.assertType(rcvr, 'sprite');\r\n        this.assertType(value, 'Boolean');\r\n        rcvr.rotatesWithAnchor = !value;\r\n        rcvr.version = Date.now();\r\n        break;\r\n    case 'rotation x':\r\n        this.assertType(rcvr, 'sprite');\r\n        this.assertType(value, 'number');\r\n        rcvr.setRotationX(value);\r\n        break;\r\n    case 'rotation y':\r\n        this.assertType(rcvr, 'sprite');\r\n        this.assertType(value, 'number');\r\n        rcvr.setRotationY(value);\r\n        break;\r\n    default:\r\n        throw new Error(\r\n            '\"' + localize(name) + '\" ' + localize('is read-only')\r\n        );\r\n    }\r\n};\r\n\r\nProcess.prototype.reportContextFor = function (context, otherObj) {\r\n    // Private - return a copy of the context\r\n    // and bind it to another receiver\r\n    var result = copy(context);\r\n    result.receiver = otherObj;\r\n    if (result.outerContext) {\r\n        result.outerContext = copy(result.outerContext);\r\n        result.outerContext.variables = copy(result.outerContext.variables);\r\n        result.outerContext.receiver = otherObj;\r\n        result.outerContext.variables.parentFrame = otherObj.variables;\r\n    }\r\n    return result;\r\n};\r\n\r\nProcess.prototype.reportMouseX = function () {\r\n    var stage, world;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            world = stage.world();\r\n            if (world) {\r\n                return (world.hand.position().x - stage.center().x)\r\n                    / stage.scale;\r\n            }\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\nProcess.prototype.reportMouseY = function () {\r\n    var stage, world;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            world = stage.world();\r\n            if (world) {\r\n                return (stage.center().y - world.hand.position().y)\r\n                    / stage.scale;\r\n            }\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\nProcess.prototype.reportMouseDown = function () {\r\n    var world;\r\n    if (this.homeContext.receiver) {\r\n        world = this.homeContext.receiver.world();\r\n        if (world) {\r\n            return world.hand.mouseButton === 'left';\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.reportKeyPressed = function (keyString) {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            if (this.inputOption(keyString) === 'any key') {\r\n                return Object.keys(stage.keysPressed).length > 0;\r\n            }\r\n            return stage.keysPressed[keyString] !== undefined;\r\n        }\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.doResetTimer = function () {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.resetTimer();\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.reportTimer = function () {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            return stage.getTimer();\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\n// Process Dates and times in Snap\r\nProcess.prototype.reportDate = function (datefn) {\r\n    var currDate, func, result,\r\n        inputFn = this.inputOption(datefn),\r\n        // Map block options to built-in functions\r\n        dateMap = {\r\n            'year' : 'getFullYear',\r\n            'month' : 'getMonth',\r\n            'date': 'getDate',\r\n            'day of week' : 'getDay',\r\n            'hour' : 'getHours',\r\n            'minute' : 'getMinutes',\r\n            'second' : 'getSeconds',\r\n            'time in milliseconds' : 'getTime'\r\n        };\r\n\r\n    if (!dateMap[inputFn]) { return ''; }\r\n    currDate = new Date();\r\n    func = dateMap[inputFn];\r\n    result = currDate[func]();\r\n\r\n    // Show months as 1-12 and days as 1-7\r\n    if (inputFn === 'month' || inputFn === 'day of week') {\r\n        result += 1;\r\n    }\r\n    return result;\r\n};\r\n\r\n// Process code mapping\r\n\r\n/*\r\n    for generating textual source code using\r\n    blocks - not needed to run or debug Snap\r\n*/\r\n\r\nProcess.prototype.doMapCodeOrHeader = function (aContext, anOption, aString) {\r\n    if (this.inputOption(anOption) === 'code') {\r\n        return this.doMapCode(aContext, aString);\r\n    }\r\n    if (this.inputOption(anOption) === 'header') {\r\n        return this.doMapHeader(aContext, aString);\r\n    }\r\n    throw new Error(\r\n        ' \\'' + anOption + '\\'\\nis not a valid option'\r\n    );\r\n};\r\n\r\nProcess.prototype.doMapHeader = function (aContext, aString) {\r\n    if (aContext instanceof Context) {\r\n        if (aContext.expression instanceof SyntaxElementMorph) {\r\n            return aContext.expression.mapHeader(aString || '');\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doMapCode = function (aContext, aString) {\r\n    if (aContext instanceof Context) {\r\n        if (aContext.expression instanceof SyntaxElementMorph) {\r\n            return aContext.expression.mapCode(aString || '');\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doMapValueCode = function (type, aString) {\r\n    var tp = this.inputOption(type);\r\n    switch (tp) {\r\n    case 'String':\r\n        StageMorph.prototype.codeMappings.string = aString || '<#1>';\r\n        break;\r\n    case 'Number':\r\n        StageMorph.prototype.codeMappings.number = aString || '<#1>';\r\n        break;\r\n    case 'true':\r\n        StageMorph.prototype.codeMappings.boolTrue = aString || 'true';\r\n        break;\r\n    case 'false':\r\n        StageMorph.prototype.codeMappings.boolFalse = aString || 'true';\r\n        break;\r\n    default:\r\n        throw new Error(\r\n            localize('unsupported data type') + ' ' + tp\r\n        );\r\n    }\r\n\r\n};\r\n\r\nProcess.prototype.doMapListCode = function (part, kind, aString) {\r\n    var key1 = '',\r\n        key2 = 'delim';\r\n\r\n    if (this.inputOption(kind) === 'parameters') {\r\n        key1 = 'parms_';\r\n    } else if (this.inputOption(kind) === 'variables') {\r\n        key1 = 'tempvars_';\r\n    }\r\n\r\n    if (this.inputOption(part) === 'list') {\r\n        key2 = 'list';\r\n    } else if (this.inputOption(part) === 'item') {\r\n        key2 = 'item';\r\n    }\r\n\r\n    StageMorph.prototype.codeMappings[key1 + key2] = aString || '';\r\n};\r\n\r\nProcess.prototype.reportMappedCode = function (aContext) {\r\n    if (aContext instanceof Context) {\r\n        if (aContext.expression instanceof SyntaxElementMorph) {\r\n            return aContext.expression.mappedCode();\r\n        }\r\n    }\r\n    return '';\r\n};\r\n\r\n// Process music primitives\r\n\r\nProcess.prototype.doRest = function (beats) {\r\n    var tempo = this.reportTempo();\r\n    this.doWait(60 / tempo * beats);\r\n};\r\n\r\nProcess.prototype.reportTempo = function () {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            return stage.getTempo();\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\nProcess.prototype.doChangeTempo = function (delta) {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.changeTempo(delta);\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doSetTempo = function (bpm) {\r\n    var stage;\r\n    if (this.homeContext.receiver) {\r\n        stage = this.homeContext.receiver.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.setTempo(bpm);\r\n        }\r\n    }\r\n};\r\n\r\nProcess.prototype.doPlayNote = function (pitch, beats) {\r\n    var tempo = this.reportTempo();\r\n    this.doPlayNoteForSecs(\r\n        parseFloat(pitch || '0'),\r\n        60 / tempo * parseFloat(beats || '0')\r\n    );\r\n};\r\n\r\nProcess.prototype.doPlayNoteForSecs = function (pitch, secs) {\r\n    // interpolated\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n        this.context.activeNote = new Note(pitch);\r\n        this.context.activeNote.play(this.instrument);\r\n    }\r\n    if ((Date.now() - this.context.startTime) >= (secs * 1000)) {\r\n        if (this.context.activeNote) {\r\n            this.context.activeNote.stop();\r\n            this.context.activeNote = null;\r\n        }\r\n        return null;\r\n    }\r\n    this.pushContext('doYield');\r\n    this.pushContext();\r\n};\r\n\r\nProcess.prototype.doSetInstrument = function (num) {\r\n    this.instrument = +num;\r\n    this.receiver.instrument = +num;\r\n};\r\n\r\n// Process constant input options\r\n\r\nProcess.prototype.inputOption = function (dta) {\r\n    // private - for localization\r\n    return dta instanceof Array ? dta[0] : dta;\r\n};\r\n\r\n// Process stack\r\n\r\nProcess.prototype.pushContext = function (expression, outerContext) {\r\n    this.context = new Context(\r\n        this.context,\r\n        expression,\r\n        outerContext || (this.context ? this.context.outerContext : null),\r\n            // for tail call elimination\r\n        this.context ? // check needed due to tail call elimination\r\n                this.context.receiver : this.homeContext.receiver\r\n    );\r\n};\r\n\r\nProcess.prototype.popContext = function () {\r\n    if (this.context) {\r\n        this.context.stopMusic();\r\n    }\r\n    this.context = this.context ? this.context.parentContext : null;\r\n};\r\n\r\nProcess.prototype.returnValueToParentContext = function (value) {\r\n    // if no parent context exists treat value as result\r\n    if (value !== undefined) {\r\n        var target = this.context ? // in case of tail call elimination\r\n                this.context.parentContext || this.homeContext\r\n            : this.homeContext;\r\n        target.addInput(value);\r\n    }\r\n};\r\n\r\nProcess.prototype.reportStackSize = function () {\r\n    return this.context ? this.context.stackSize() : 0;\r\n};\r\n\r\nProcess.prototype.reportFrameCount = function () {\r\n    return this.frameCount;\r\n};\r\n\r\n// Process single-stepping\r\n\r\nProcess.prototype.flashContext = function () {\r\n    var expr = this.context.expression;\r\n    if (this.enableSingleStepping &&\r\n            !this.isAtomic &&\r\n            expr instanceof SyntaxElementMorph &&\r\n            !(expr instanceof CommandSlotMorph) &&\r\n            !this.context.isFlashing &&\r\n            expr.world() &&\r\n            !(expr instanceof ColorSlotMorph)) {\r\n        this.unflash();\r\n        expr.flash();\r\n        this.context.isFlashing = true;\r\n        this.flashingContext = this.context;\r\n        if (this.flashTime > 0 && (this.flashTime <= 0.5)) {\r\n            this.pushContext('doIdle');\r\n            this.context.addInput(this.flashTime);\r\n        } else {\r\n            this.pushContext('doInterrupt');\r\n        }\r\n        return true;\r\n    }\r\n    return false;\r\n};\r\n\r\nProcess.prototype.flashPausedContext = function () {\r\n    var flashable = this.context ? this.context.lastFlashable() : null;\r\n    if (flashable) {\r\n        this.unflash();\r\n        flashable.expression.flash();\r\n        flashable.isFlashing = true;\r\n        this.flashingContext = flashable;\r\n    }\r\n};\r\n\r\nProcess.prototype.doInterrupt = function () {\r\n    this.popContext();\r\n    if (!this.isAtomic) {\r\n        this.isInterrupted = true;\r\n    }\r\n};\r\n\r\nProcess.prototype.doIdle = function (secs) {\r\n    if (!this.context.startTime) {\r\n        this.context.startTime = Date.now();\r\n    }\r\n    if ((Date.now() - this.context.startTime) < (secs * 1000)) {\r\n        this.pushContext('doInterrupt');\r\n        return;\r\n    }\r\n    this.popContext();\r\n};\r\n\r\nProcess.prototype.unflash = function () {\r\n    if (this.flashingContext) {\r\n        this.flashingContext.expression.unflash();\r\n        this.flashingContext.isFlashing = false;\r\n        this.flashingContext = null;\r\n    }\r\n};\r\n\r\n// Context /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    A Context describes the state of a Process.\r\n\r\n    Each Process has a pointer to a Context containing its\r\n    state. Whenever the Process yields control, its Context\r\n    tells it exactly where it left off.\r\n\r\n    structure:\r\n\r\n    parentContext   the Context to return to when this one has\r\n                    been evaluated.\r\n    outerContext    the Context holding my lexical scope\r\n    expression      SyntaxElementMorph, an array of blocks to evaluate,\r\n                    null or a String denoting a selector, e.g. 'doYield'\r\n    origin          the object of origin, only used for serialization\r\n    receiver        the object to which the expression applies, if any\r\n    variables       the current VariableFrame, if any\r\n    inputs          an array of input values computed so far\r\n                    (if expression is a    BlockMorph)\r\n    pc              the index of the next block to evaluate\r\n                    (if expression is an array)\r\n    isContinuation  flag for marking a transient continuation context\r\n    startTime       time when the context was first evaluated\r\n    startValue      initial value for interpolated operations\r\n    activeAudio     audio buffer for interpolated operations, don't persist\r\n    activeNote      audio oscillator for interpolated ops, don't persist\r\n    isCustomBlock   marker for return ops\r\n    emptySlots      caches the number of empty slots for reification\r\n    tag             string or number to optionally identify the Context,\r\n                    as a \"return\" target (for the \"stop block\" primitive)\r\n    isFlashing      flag for single-stepping\r\n*/\r\n\r\nfunction Context(\r\n    parentContext,\r\n    expression,\r\n    outerContext,\r\n    receiver\r\n) {\r\n    this.outerContext = outerContext || null;\r\n    this.parentContext = parentContext || null;\r\n    this.expression = expression || null;\r\n    this.receiver = receiver || null;\r\n    this.origin = receiver || null; // only for serialization\r\n    this.variables = new VariableFrame();\r\n    if (this.outerContext) {\r\n        this.variables.parentFrame = this.outerContext.variables;\r\n        this.receiver = this.outerContext.receiver;\r\n    }\r\n    this.inputs = [];\r\n    this.pc = 0;\r\n    this.isContinuation = false;\r\n    this.startTime = null;\r\n    this.activeAudio = null;\r\n    this.activeNote = null;\r\n    this.isCustomBlock = false; // marks the end of a custom block's stack\r\n    this.emptySlots = 0; // used for block reification\r\n    this.tag = null;  // lexical catch-tag for custom blocks\r\n    this.isFlashing = false; // for single-stepping\r\n}\r\n\r\nContext.prototype.toString = function () {\r\n    var expr = this.expression;\r\n    if (expr instanceof Array) {\r\n        if (expr.length > 0) {\r\n            expr = '[' + expr[0] + ']';\r\n        }\r\n    }\r\n    return 'Context >> ' + expr + ' ' + this.variables;\r\n};\r\n\r\nContext.prototype.image = function () {\r\n    var ring = new RingMorph(),\r\n        block,\r\n        cont;\r\n\r\n    if (this.expression instanceof Morph) {\r\n        block = this.expression.fullCopy();\r\n\r\n        // replace marked call/cc block with empty slot\r\n        if (this.isContinuation) {\r\n            cont = detect(block.allInputs(), function (inp) {\r\n                return inp.bindingID === 1;\r\n            });\r\n            if (cont) {\r\n                block.revertToDefaultInput(cont, true);\r\n            }\r\n        }\r\n        ring.embed(block, this.inputs);\r\n        return ring.fullImage();\r\n    }\r\n    if (this.expression instanceof Array) {\r\n        block = this.expression[this.pc].fullCopy();\r\n        if (block instanceof RingMorph && !block.contents()) { // empty ring\r\n            return block.fullImage();\r\n        }\r\n        ring.embed(block, this.isContinuation ? [] : this.inputs);\r\n        return ring.fullImage();\r\n    }\r\n\r\n    // otherwise show an empty ring\r\n    ring.color = SpriteMorph.prototype.blockColor.other;\r\n    ring.setSpec('%rc %ringparms');\r\n\r\n    // also show my inputs, unless I'm a continuation\r\n    if (!this.isContinuation) {\r\n        this.inputs.forEach(function (inp) {\r\n            ring.parts()[1].addInput(inp);\r\n        });\r\n    }\r\n    return ring.fullImage();\r\n};\r\n\r\n// Context continuations:\r\n\r\nContext.prototype.continuation = function () {\r\n    var cont;\r\n    if (this.expression instanceof Array) {\r\n        cont = this;\r\n    } else if (this.parentContext) {\r\n        cont = this.parentContext;\r\n    } else {\r\n        cont = new Context(null, 'expectReport');\r\n        cont.isContinuation = true;\r\n        return cont;\r\n    }\r\n    cont = cont.copyForContinuation();\r\n    cont.tag = null;\r\n    cont.isContinuation = true;\r\n    return cont;\r\n};\r\n\r\nContext.prototype.copyForContinuation = function () {\r\n    var cpy = copy(this),\r\n        cur = cpy,\r\n        isReporter = !(this.expression instanceof Array ||\r\n            isString(this.expression));\r\n    if (isReporter) {\r\n        cur.prepareContinuationForBinding();\r\n        while (cur.parentContext) {\r\n            cur.parentContext = copy(cur.parentContext);\r\n            cur = cur.parentContext;\r\n            cur.inputs = [];\r\n        }\r\n    }\r\n    return cpy;\r\n};\r\n\r\nContext.prototype.copyForContinuationCall = function () {\r\n    var cpy = copy(this),\r\n        cur = cpy,\r\n        isReporter = !(this.expression instanceof Array ||\r\n            isString(this.expression));\r\n    if (isReporter) {\r\n        this.expression = this.expression.fullCopy();\r\n        this.inputs = [];\r\n        while (cur.parentContext) {\r\n            cur.parentContext = copy(cur.parentContext);\r\n            cur = cur.parentContext;\r\n            cur.inputs = [];\r\n        }\r\n    }\r\n    return cpy;\r\n};\r\n\r\nContext.prototype.prepareContinuationForBinding = function () {\r\n    var pos = this.inputs.length,\r\n        slot;\r\n    this.expression = this.expression.fullCopy();\r\n    slot = this.expression.inputs()[pos];\r\n    if (slot) {\r\n        this.inputs = [];\r\n        // mark slot containing the call/cc reporter with an identifier\r\n        slot.bindingID = 1;\r\n        // and remember the number of detected empty slots\r\n        this.emptySlots = 1;\r\n    }\r\n};\r\n\r\n// Context accessing:\r\n\r\nContext.prototype.addInput = function (input) {\r\n    this.inputs.push(input);\r\n};\r\n\r\n// Context music\r\n\r\nContext.prototype.stopMusic = function () {\r\n    if (this.activeNote) {\r\n        this.activeNote.stop();\r\n        this.activeNote = null;\r\n    }\r\n};\r\n\r\n// Context single-stepping:\r\n\r\nContext.prototype.lastFlashable = function () {\r\n    // for experimental single-stepping when pausing\r\n    if (this.expression instanceof SyntaxElementMorph &&\r\n            !(this.expression instanceof CommandSlotMorph)) {\r\n        return this;\r\n    } else if (this.parentContext) {\r\n        return this.parentContext.lastFlashable();\r\n    }\r\n    return null;\r\n};\r\n\r\n// Context debugging\r\n\r\nContext.prototype.stackSize = function () {\r\n    if (!this.parentContext) {\r\n        return 1;\r\n    }\r\n    return 1 + this.parentContext.stackSize();\r\n};\r\n\r\n// Variable /////////////////////////////////////////////////////////////////\r\n\r\nfunction Variable(value, isTransient) {\r\n    this.value = value;\r\n    this.isTransient = isTransient || false; // prevent value serialization\r\n}\r\n\r\nVariable.prototype.toString = function () {\r\n    return 'a ' + (this.isTransient ? 'transient ' : '') + 'Variable [' +\r\n        this.value + ']';\r\n};\r\n\r\nVariable.prototype.copy = function () {\r\n    return new Variable(this.value, this.isTransient);\r\n};\r\n\r\n// VariableFrame ///////////////////////////////////////////////////////\r\n\r\nfunction VariableFrame(parentFrame, owner) {\r\n    this.vars = {};\r\n    this.parentFrame = parentFrame || null;\r\n    this.owner = owner || null;\r\n}\r\n\r\nVariableFrame.prototype.toString = function () {\r\n    return 'a VariableFrame {' + this.names() + '}';\r\n};\r\n\r\nVariableFrame.prototype.copy = function () {\r\n    var frame = new VariableFrame(this.parentFrame),\r\n        myself = this;\r\n    this.names().forEach(function (vName) {\r\n        frame.addVar(vName, myself.getVar(vName));\r\n    });\r\n    return frame;\r\n};\r\n\r\nVariableFrame.prototype.deepCopy = function () {\r\n    // currently unused\r\n    var frame;\r\n    if (this.parentFrame) {\r\n        frame = new VariableFrame(this.parentFrame.deepCopy());\r\n    } else {\r\n        frame = new VariableFrame(this.parentFrame);\r\n    }\r\n    frame.vars = copy(this.vars);\r\n    return frame;\r\n};\r\n\r\nVariableFrame.prototype.find = function (name) {\r\n/*\r\n    answer the closest variable frame containing\r\n    the specified variable. otherwise throw an exception.\r\n*/\r\n    var frame = this.silentFind(name);\r\n    if (frame) {return frame; }\r\n    throw new Error(\r\n        localize('a variable of name \\'')\r\n            + name\r\n            + localize('\\'\\ndoes not exist in this context')\r\n    );\r\n};\r\n\r\nVariableFrame.prototype.silentFind = function (name) {\r\n/*\r\n    answer the closest variable frame containing\r\n    the specified variable. Otherwise return null.\r\n*/\r\n    if (this.vars[name] !== undefined) {\r\n        return this;\r\n    }\r\n    if (this.parentFrame) {\r\n        return this.parentFrame.silentFind(name);\r\n    }\r\n    return null;\r\n};\r\n\r\nVariableFrame.prototype.setVar = function (name, value, sender) {\r\n    // change the specified variable if it exists\r\n    // else throw an error, because variables need to be\r\n    // declared explicitly (e.g. through a \"script variables\" block),\r\n    // before they can be accessed.\r\n    // if the found frame is inherited by the sender sprite\r\n    // shadow it (create an explicit one for the sender)\r\n    // before setting the value (\"create-on-write\")\r\n\r\n    var frame = this.find(name);\r\n    if (frame) {\r\n        if (sender instanceof SpriteMorph &&\r\n                (frame.owner instanceof SpriteMorph) &&\r\n                (sender !== frame.owner)) {\r\n            sender.shadowVar(name, value);\r\n        } else {\r\n            frame.vars[name].value = value;\r\n        }\r\n    }\r\n};\r\n\r\nVariableFrame.prototype.changeVar = function (name, delta, sender) {\r\n    // change the specified variable if it exists\r\n    // else throw an error, because variables need to be\r\n    // declared explicitly (e.g. through a \"script variables\" block,\r\n    // before they can be accessed.\r\n    // if the found frame is inherited by the sender sprite\r\n    // shadow it (create an explicit one for the sender)\r\n    // before changing the value (\"create-on-write\")\r\n\r\n    var frame = this.find(name),\r\n        value,\r\n        newValue;\r\n    if (frame) {\r\n        value = parseFloat(frame.vars[name].value);\r\n        newValue = isNaN(value) ? delta : value + parseFloat(delta);\r\n        if (sender instanceof SpriteMorph &&\r\n                (frame.owner instanceof SpriteMorph) &&\r\n                (sender !== frame.owner)) {\r\n            sender.shadowVar(name, newValue);\r\n        } else {\r\n            frame.vars[name].value = newValue;\r\n        }\r\n\r\n    }\r\n};\r\n\r\nVariableFrame.prototype.getVar = function (name) {\r\n    var frame = this.silentFind(name),\r\n        value;\r\n    if (frame) {\r\n        value = frame.vars[name].value;\r\n        return (value === 0 ? 0\r\n                : value === false ? false\r\n                        : value === '' ? ''\r\n                            : value || 0); // don't return null\r\n    }\r\n    if (typeof name === 'number') {\r\n        // empty input with a Binding-ID called without an argument\r\n        return '';\r\n    }\r\n    throw new Error(\r\n        localize('a variable of name \\'')\r\n            + name\r\n            + localize('\\'\\ndoes not exist in this context')\r\n    );\r\n};\r\n\r\nVariableFrame.prototype.addVar = function (name, value) {\r\n    this.vars[name] = new Variable(value === 0 ? 0\r\n              : value === false ? false\r\n                       : value === '' ? '' : value || 0);\r\n};\r\n\r\nVariableFrame.prototype.deleteVar = function (name) {\r\n    var frame = this.find(name);\r\n    if (frame) {\r\n        delete frame.vars[name];\r\n    }\r\n};\r\n\r\n// VariableFrame tools\r\n\r\nVariableFrame.prototype.names = function () {\r\n    var each, names = [];\r\n    for (each in this.vars) {\r\n        if (Object.prototype.hasOwnProperty.call(this.vars, each)) {\r\n            names.push(each);\r\n        }\r\n    }\r\n    return names;\r\n};\r\n\r\nVariableFrame.prototype.allNamesDict = function () {\r\n    var dict = {}, current = this;\r\n\r\n    function addKeysToDict(srcDict, trgtDict) {\r\n        var eachKey;\r\n        for (eachKey in srcDict) {\r\n            if (Object.prototype.hasOwnProperty.call(srcDict, eachKey)) {\r\n                trgtDict[eachKey] = eachKey;\r\n            }\r\n        }\r\n    }\r\n\r\n    while (current) {\r\n        addKeysToDict(current.vars, dict);\r\n        current = current.parentFrame;\r\n    }\r\n    return dict;\r\n};\r\n\r\nVariableFrame.prototype.allNames = function () {\r\n/*\r\n    only show the names of the lexical scope, hybrid scoping is\r\n    reserved to the daring ;-)\r\n*/\r\n    var answer = [], each, dict = this.allNamesDict();\r\n\r\n    for (each in dict) {\r\n        if (Object.prototype.hasOwnProperty.call(dict, each)) {\r\n            answer.push(each);\r\n        }\r\n    }\r\n    return answer;\r\n};\r\n//fin de threads\r\n/*\r\n\r\n    objects.js\r\n\r\n    a scriptable microworld\r\n    based on morphic.js, blocks.js and threads.js\r\n    inspired by Scratch\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs blocks.js, threads.js, morphic.js and widgets.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        SpriteMorph\r\n        SpriteHighlightMorph\r\n        StageMorph\r\n        Costume\r\n            SVG_Costume\r\n        CostumeEditorMorph\r\n        Sound\r\n        Note\r\n        CellMorph\r\n        WatcherMorph\r\n        StagePrompterMorph\r\n\r\n        SpeechBubbleMorph*\r\n            SpriteBubbleMorph\r\n\r\n    * defined in Morphic.js\r\n\r\n\r\n    credits\r\n    -------\r\n    Ian Reynolds contributed initial porting of primitives from Squeak and\r\n    sound handling\r\n    Achal Dave contributed research and prototyping for creating music\r\n    using the Web Audio API\r\n    Yuan Yuan and Dylan Servilla contributed graphic effects for costumes\r\n\r\n*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\n/*global PaintEditorMorph, ListWatcherMorph, PushButtonMorph, ToggleMorph,\r\nDialogBoxMorph, InputFieldMorph, SpriteIconMorph, BlockMorph, SymbolMorph,\r\nThreadManager, VariableFrame, detect, BlockMorph, BoxMorph, Color, Animation,\r\nCommandBlockMorph, FrameMorph, HatBlockMorph, MenuMorph, Morph, MultiArgMorph,\r\nPoint, ReporterBlockMorph, ScriptsMorph, StringMorph, SyntaxElementMorph,\r\nTextMorph, contains, degrees, detect, newCanvas, nop, radians, Array,\r\nCursorMorph, Date, FrameMorph, HandMorph, Math, MenuMorph, Morph,\r\nMorphicPreferences, Object, PenMorph, Point, Rectangle, ScrollFrameMorph,\r\nSliderMorph, String, StringMorph, TextMorph, contains, copy, degrees, detect,\r\ndocument, isNaN, isString, newCanvas, nop, parseFloat, radians, window,\r\nmodules, IDE_Morph, VariableDialogMorph, HTMLCanvasElement, Context, List,\r\nSpeechBubbleMorph, RingMorph, isNil, FileReader, TableDialogMorph,\r\nBlockEditorMorph, BlockDialogMorph, PrototypeHatBlockMorph, localize,\r\nTableMorph, TableFrameMorph, normalizeCanvas, BooleanSlotMorph, HandleMorph,\r\nAlignmentMorph*/\r\n\r\nmodules.objects = '2017-December-12';\r\n\r\nvar SpriteMorph;\r\nvar StageMorph;\r\nvar SpriteBubbleMorph;\r\nvar Costume;\r\nvar SVG_Costume;\r\nvar CostumeEditorMorph;\r\nvar Sound;\r\nvar Note;\r\nvar CellMorph;\r\nvar WatcherMorph;\r\nvar StagePrompterMorph;\r\nvar Note;\r\nvar SpriteHighlightMorph;\r\n\r\nfunction isSnapObject(thing) {\r\n    return thing instanceof SpriteMorph || (thing instanceof StageMorph);\r\n}\r\n\r\n// SpriteMorph /////////////////////////////////////////////////////////\r\n\r\n// I am a scriptable object\r\n\r\n// SpriteMorph inherits from PenMorph:\r\n\r\nSpriteMorph.prototype = new PenMorph();\r\nSpriteMorph.prototype.constructor = SpriteMorph;\r\nSpriteMorph.uber = PenMorph.prototype;\r\n\r\n// SpriteMorph settings\r\n\r\nSpriteMorph.prototype.attributes =\r\n    [\r\n        'x position',\r\n        'y position',\r\n        'direction',\r\n        'size',\r\n        'costumes',\r\n        'costume #',\r\n        'sounds',\r\n        'scripts'\r\n    ];\r\n\r\nSpriteMorph.prototype.categories =\r\n    [\r\n        'motion',\r\n        'control',\r\n        'looks',\r\n        'sensing',\r\n        'sound',\r\n        'operators',\r\n        'pen',\r\n        'variables',\r\n        'lists',\r\n        'other'\r\n    ];\r\n\r\nSpriteMorph.prototype.blockColor = {\r\n    motion : new Color(74, 108, 212),\r\n    looks : new Color(143, 86, 227),\r\n    sound : new Color(207, 74, 217),\r\n    pen : new Color(0, 161, 120),\r\n    control : new Color(230, 168, 34),\r\n    sensing : new Color(4, 148, 220),\r\n    operators : new Color(98, 194, 19),\r\n    variables : new Color(243, 118, 29),\r\n    lists : new Color(217, 77, 17),\r\n    other: new Color(150, 150, 150)\r\n};\r\n\r\nSpriteMorph.prototype.paletteColor = new Color(55, 55, 55);\r\nSpriteMorph.prototype.paletteTextColor = new Color(230, 230, 230);\r\nSpriteMorph.prototype.sliderColor\r\n    = SpriteMorph.prototype.paletteColor.lighter(30);\r\nSpriteMorph.prototype.isCachingPrimitives = true;\r\n\r\nSpriteMorph.prototype.enableNesting = true;\r\nSpriteMorph.prototype.enableFirstClass = true;\r\nSpriteMorph.prototype.useFlatLineEnds = false;\r\nSpriteMorph.prototype.highlightColor = new Color(250, 200, 130);\r\nSpriteMorph.prototype.highlightBorder = 8;\r\n\r\nSpriteMorph.prototype.bubbleColor = new Color(255, 255, 255);\r\nSpriteMorph.prototype.bubbleFontSize = 14;\r\nSpriteMorph.prototype.bubbleFontIsBold = true;\r\nSpriteMorph.prototype.bubbleCorner = 10;\r\nSpriteMorph.prototype.bubbleBorder = 3;\r\nSpriteMorph.prototype.bubbleBorderColor = new Color(190, 190, 190);\r\nSpriteMorph.prototype.bubbleMaxTextWidth = 130;\r\n\r\nSpriteMorph.prototype.initBlocks = function () {\r\n    SpriteMorph.prototype.blocks = {\r\n\r\n        // Motion\r\n        forward: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'move %n steps',\r\n            defaults: [10]\r\n        },\r\n        turn: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'turn %clockwise %n degrees',\r\n            defaults: [15]\r\n        },\r\n        turnLeft: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'turn %counterclockwise %n degrees',\r\n            defaults: [15]\r\n        },\r\n        setHeading: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'point in direction %dir'\r\n        },\r\n        doFaceTowards: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'point towards %dst'\r\n        },\r\n        gotoXY: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'go to x: %n y: %n',\r\n            defaults: [0, 0]\r\n        },\r\n        doGotoObject: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'go to %dst'\r\n        },\r\n        doGlide: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'glide %n secs to x: %n y: %n',\r\n            defaults: [1, 0, 0]\r\n        },\r\n        changeXPosition: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'change x by %n',\r\n            defaults: [10]\r\n        },\r\n        setXPosition: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'set x to %n',\r\n            defaults: [0]\r\n        },\r\n        changeYPosition: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'change y by %n',\r\n            defaults: [10]\r\n        },\r\n        setYPosition: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'set y to %n',\r\n            defaults: [0]\r\n        },\r\n        bounceOffEdge: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'motion',\r\n            spec: 'if on edge, bounce'\r\n        },\r\n        xPosition: {\r\n            only: SpriteMorph,\r\n            type: 'reporter',\r\n            category: 'motion',\r\n            spec: 'x position'\r\n        },\r\n        yPosition: {\r\n            only: SpriteMorph,\r\n            type: 'reporter',\r\n            category: 'motion',\r\n            spec: 'y position'\r\n        },\r\n        direction: {\r\n            only: SpriteMorph,\r\n            type: 'reporter',\r\n            category: 'motion',\r\n            spec: 'direction'\r\n        },\r\n\r\n        // Looks\r\n        doSwitchToCostume: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'switch to costume %cst'\r\n        },\r\n        doWearNextCostume: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'next costume'\r\n        },\r\n        getCostumeIdx: {\r\n            type: 'reporter',\r\n            category: 'looks',\r\n            spec: 'costume #'\r\n        },\r\n        doSayFor: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'say %s for %n secs',\r\n            defaults: [localize('Hello!'), 2]\r\n        },\r\n        bubble: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'say %s',\r\n            defaults: [localize('Hello!')]\r\n        },\r\n        doThinkFor: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'think %s for %n secs',\r\n            defaults: [localize('Hmm...'), 2]\r\n        },\r\n        doThink: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'think %s',\r\n            defaults: [localize('Hmm...')]\r\n        },\r\n        changeEffect: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'change %eff effect by %n',\r\n            defaults: [null, 25]\r\n        },\r\n        setEffect: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'set %eff effect to %n',\r\n            defaults: [null, 0]\r\n        },\r\n        clearEffects: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'clear graphic effects'\r\n        },\r\n        changeScale: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'change size by %n',\r\n            defaults: [10]\r\n        },\r\n        setScale: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'set size to %n %',\r\n            defaults: [100]\r\n        },\r\n        getScale: {\r\n            only: SpriteMorph,\r\n            type: 'reporter',\r\n            category: 'looks',\r\n            spec: 'size'\r\n        },\r\n        show: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'show'\r\n        },\r\n        hide: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'hide'\r\n        },\r\n        comeToFront: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'go to front'\r\n        },\r\n        goBack: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'go back %n layers',\r\n            defaults: [1]\r\n        },\r\n        doScreenshot: {\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'save %imgsource as costume named %s',\r\n            defaults: [['pen trails'], localize('screenshot')]\r\n        },\r\n\r\n        // Looks - Debugging primitives for development mode\r\n        reportCostumes: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'looks',\r\n            spec: 'wardrobe'\r\n        },\r\n\r\n        alert: {\r\n            dev: true,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'alert %mult%s'\r\n        },\r\n        log: {\r\n            dev: true,\r\n            type: 'command',\r\n            category: 'looks',\r\n            spec: 'console log %mult%s'\r\n        },\r\n\r\n        // Sound\r\n        playSound: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'play sound %snd'\r\n        },\r\n        doPlaySoundUntilDone: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'play sound %snd until done'\r\n        },\r\n        doStopAllSounds: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'stop all sounds'\r\n        },\r\n        doRest: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'rest for %n beats',\r\n            defaults: [0.2]\r\n        },\r\n        doPlayNote: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'play note %note for %n beats',\r\n            defaults: [60, 0.5]\r\n        },\r\n        doSetInstrument: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'set instrument to %inst',\r\n            defaults: [1]\r\n        },\r\n        doChangeTempo: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'change tempo by %n',\r\n            defaults: [20]\r\n        },\r\n        doSetTempo: {\r\n            type: 'command',\r\n            category: 'sound',\r\n            spec: 'set tempo to %n bpm',\r\n            defaults: [60]\r\n        },\r\n        getTempo: {\r\n            type: 'reporter',\r\n            category: 'sound',\r\n            spec: 'tempo'\r\n        },\r\n\r\n        // Sound - Debugging primitives for development mode\r\n        reportSounds: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sound',\r\n            spec: 'jukebox'\r\n        },\r\n\r\n        // Pen\r\n        clear: {\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'clear'\r\n        },\r\n        down: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'pen down'\r\n        },\r\n        up: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'pen up'\r\n        },\r\n        setColor: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'set pen color to %clr'\r\n        },\r\n        changeHue: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'change pen color by %n',\r\n            defaults: [10]\r\n        },\r\n        setHue: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'set pen color to %n',\r\n            defaults: [0]\r\n        },\r\n        changeBrightness: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'change pen shade by %n',\r\n            defaults: [10]\r\n        },\r\n        setBrightness: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'set pen shade to %n',\r\n            defaults: [100]\r\n        },\r\n        changeSize: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'change pen size by %n',\r\n            defaults: [1]\r\n        },\r\n        setSize: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'set pen size to %n',\r\n            defaults: [1]\r\n        },\r\n        doStamp: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'stamp'\r\n        },\r\n        floodFill: {\r\n            only: SpriteMorph,\r\n            type: 'command',\r\n            category: 'pen',\r\n            spec: 'fill'\r\n        },\r\n        reportPenTrailsAsCostume: {\r\n            type: 'reporter',\r\n            category: 'pen',\r\n            spec: 'pen trails'\r\n        },\r\n\r\n        // Control\r\n        receiveGo: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when %greenflag clicked'\r\n        },\r\n        receiveKey: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when %keyHat key pressed'\r\n        },\r\n\r\n    /* migrated to a newer block version:\r\n\r\n        receiveClick: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when I am clicked'\r\n        },\r\n    */\r\n\r\n        receiveInteraction: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when I am %interaction',\r\n            defaults: ['clicked']\r\n        },\r\n        receiveMessage: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when I receive %msgHat'\r\n        },\r\n        receiveCondition: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when %b'\r\n        },\r\n        doBroadcast: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'broadcast %msg'\r\n        },\r\n        doBroadcastAndWait: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'broadcast %msg and wait'\r\n        },\r\n        getLastMessage: {\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'message'\r\n        },\r\n        doWait: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'wait %n secs',\r\n            defaults: [1]\r\n        },\r\n        doWaitUntil: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'wait until %b'\r\n        },\r\n        doForever: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'forever %c'\r\n        },\r\n        doRepeat: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'repeat %n %c',\r\n            defaults: [10]\r\n        },\r\n        doUntil: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'repeat until %b %c'\r\n        },\r\n        doIf: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'if %b %c'\r\n        },\r\n        doIfElse: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'if %b %c else %c'\r\n        },\r\n\r\n    /* migrated to a newer block version:\r\n\r\n        doStop: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'stop script'\r\n        },\r\n        doStopAll: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'stop all %stop'\r\n        },\r\n    */\r\n\r\n        doStopThis: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'stop %stopChoices'\r\n        },\r\n\r\n    /* migrated to doStopThis:\r\n\r\n        doStopOthers: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'stop %stopOthersChoices'\r\n        },\r\n    */\r\n\r\n        doRun: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'run %cmdRing %inputs'\r\n        },\r\n        fork: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'launch %cmdRing %inputs'\r\n        },\r\n        evaluate: {\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'call %repRing %inputs'\r\n        },\r\n    /*\r\n        doRunWithInputList: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'run %cmd with input list %l'\r\n        },\r\n\r\n        forkWithInputList: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'launch %cmd with input list %l'\r\n        },\r\n\r\n        evaluateWithInputList: {\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'call %r with input list %l'\r\n        },\r\n    */\r\n        doReport: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'report %s'\r\n        },\r\n    /*\r\n        doStopBlock: { // migrated to a newer block version\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'stop block'\r\n        },\r\n    */\r\n        doCallCC: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'run %cmdRing w/continuation'\r\n        },\r\n        reportCallCC: {\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'call %cmdRing w/continuation'\r\n        },\r\n        doWarp: {\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'warp %c'\r\n        },\r\n\r\n        // Message passing - very experimental\r\n\r\n        doTellTo: { // under construction +++\r\n            dev: true,\r\n            type: 'command',\r\n            category: 'control',\r\n            // spec: 'tell %spr to %cl' // I liked this version much better, -Jens\r\n            spec: 'tell %spr to %cmdRing %inputs'\r\n        },\r\n        reportAskFor: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'ask %spr for %repRing %inputs'\r\n        },\r\n\r\n        // Cloning\r\n\r\n        receiveOnClone: {\r\n            type: 'hat',\r\n            category: 'control',\r\n            spec: 'when I start as a clone'\r\n        },\r\n        createClone: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'create a clone of %cln'\r\n        },\r\n        newClone: {\r\n            type: 'reporter',\r\n            category: 'control',\r\n            spec: 'a new clone of %cln',\r\n            defaults: [['myself']]\r\n        },\r\n        removeClone: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'delete this clone'\r\n        },\r\n\r\n        // Debugging - pausing\r\n\r\n        doPauseAll: {\r\n            type: 'command',\r\n            category: 'control',\r\n            spec: 'pause all %pause'\r\n        },\r\n\r\n        // Sensing\r\n\r\n        reportTouchingObject: {\r\n            only: SpriteMorph,\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'touching %col ?'\r\n        },\r\n        reportTouchingColor: {\r\n            only: SpriteMorph,\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'touching %clr ?'\r\n        },\r\n        reportColorIsTouchingColor: {\r\n            only: SpriteMorph,\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'color %clr is touching %clr ?'\r\n        },\r\n        colorFiltered: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'filtered for %clr'\r\n        },\r\n        reportStackSize: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'stack size'\r\n        },\r\n        reportFrameCount: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'frames'\r\n        },\r\n        reportThreadCount: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'processes'\r\n        },\r\n        doAsk: {\r\n            type: 'command',\r\n            category: 'sensing',\r\n            spec: 'ask %s and wait',\r\n            defaults: [localize('what\\'s your name?')]\r\n        },\r\n        reportLastAnswer: { // retained for legacy compatibility\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'answer'\r\n        },\r\n        getLastAnswer: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'answer'\r\n        },\r\n        reportMouseX: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'mouse x'\r\n        },\r\n        reportMouseY: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'mouse y'\r\n        },\r\n        reportMouseDown: {\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'mouse down?'\r\n        },\r\n        reportKeyPressed: {\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'key %key pressed?'\r\n        },\r\n        reportDistanceTo: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'distance to %dst'\r\n        },\r\n        doResetTimer: {\r\n            type: 'command',\r\n            category: 'sensing',\r\n            spec: 'reset timer'\r\n        },\r\n        reportTimer: { // retained for legacy compatibility\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'timer'\r\n        },\r\n        getTimer: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'timer'\r\n        },\r\n        reportAttributeOf: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: '%att of %spr',\r\n            defaults: [['costume #']]\r\n        },\r\n        reportURL: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'url %s',\r\n            defaults: ['snap.berkeley.edu']\r\n        },\r\n        reportIsFastTracking: {\r\n            type: 'predicate',\r\n            category: 'sensing',\r\n            spec: 'turbo mode?'\r\n        },\r\n        doSetFastTracking: {\r\n            type: 'command',\r\n            category: 'sensing',\r\n            spec: 'set turbo mode to %b'\r\n        },\r\n        reportDate: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'current %dates'\r\n        },\r\n        reportGet: {\r\n            type: 'reporter',\r\n            category: 'sensing',\r\n            spec: 'my %get',\r\n            defaults: [['neighbors']]\r\n        },\r\n\r\n        // Operators\r\n        reifyScript: {\r\n            type: 'ring',\r\n            category: 'other',\r\n            spec: '%rc %ringparms',\r\n            alias: 'command ring lambda'\r\n        },\r\n        reifyReporter: {\r\n            type: 'ring',\r\n            category: 'other',\r\n            spec: '%rr %ringparms',\r\n            alias: 'reporter ring lambda'\r\n        },\r\n        reifyPredicate: {\r\n            type: 'ring',\r\n            category: 'other',\r\n            spec: '%rp %ringparms',\r\n            alias: 'predicate ring lambda'\r\n        },\r\n        reportSum: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%n + %n'\r\n        },\r\n        reportDifference: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%n \\u2212 %n',\r\n            alias: '-'\r\n        },\r\n        reportProduct: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%n \\u00D7 %n',\r\n            alias: '*'\r\n        },\r\n        reportQuotient: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%n / %n' // '%n \\u00F7 %n'\r\n        },\r\n        reportRound: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'round %n'\r\n        },\r\n        reportMonadic: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%fun of %n',\r\n            defaults: [null, 10]\r\n        },\r\n        reportModulus: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%n mod %n'\r\n        },\r\n        reportRandom: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'pick random %n to %n',\r\n            defaults: [1, 10]\r\n        },\r\n        reportLessThan: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%s < %s'\r\n        },\r\n        reportEquals: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%s = %s'\r\n        },\r\n        reportGreaterThan: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%s > %s'\r\n        },\r\n        reportAnd: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%b and %b'\r\n        },\r\n        reportOr: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%b or %b'\r\n        },\r\n        reportNot: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: 'not %b'\r\n        },\r\n        reportBoolean: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%bool',\r\n            alias: 'true boolean'\r\n        },\r\n        reportFalse: { // special case for keyboard entry and search\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: '%bool',\r\n            defaults: [false],\r\n            alias: 'false boolean'\r\n        },\r\n        reportJoinWords: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'join %words',\r\n            defaults: [localize('hello') + ' ', localize('world')]\r\n        },\r\n        reportLetter: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'letter %n of %s',\r\n            defaults: [1, localize('world')]\r\n        },\r\n        reportStringSize: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'length of %s',\r\n            defaults: [localize('world')]\r\n        },\r\n        reportUnicode: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'unicode of %s',\r\n            defaults: ['a']\r\n        },\r\n        reportUnicodeAsLetter: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'unicode %n as letter',\r\n            defaults: [65]\r\n        },\r\n        reportIsA: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: 'is %s a %typ ?',\r\n            defaults: [5]\r\n        },\r\n        reportIsIdentical: {\r\n            type: 'predicate',\r\n            category: 'operators',\r\n            spec: 'is %s identical to %s ?'\r\n        },\r\n        reportTextSplit: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'split %s by %delim',\r\n            defaults: [localize('hello') + ' ' + localize('world'), \" \"]\r\n        },\r\n        reportJSFunction: { // experimental\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'JavaScript function ( %mult%s ) { %code }'\r\n        },\r\n        reportTypeOf: { // only in dev mode for debugging\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'type of %s',\r\n            defaults: [5]\r\n        },\r\n        reportTextFunction: { // only in dev mode - experimental\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: '%txtfun of %s',\r\n            defaults: [null, \"Abelson & Sussman\"]\r\n        },\r\n\r\n    /*\r\n        reportScript: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'the script %parms %c'\r\n        },\r\n        reify: {\r\n            type: 'reporter',\r\n            category: 'operators',\r\n            spec: 'the %f block %parms'\r\n        },\r\n    */\r\n\r\n        // Variables\r\n        doSetVar: {\r\n            type: 'command',\r\n            category: 'variables',\r\n            spec: 'set %var to %s',\r\n            defaults: [null, 0]\r\n        },\r\n        doChangeVar: {\r\n            type: 'command',\r\n            category: 'variables',\r\n            spec: 'change %var by %n',\r\n            defaults: [null, 1]\r\n        },\r\n        doShowVar: {\r\n            type: 'command',\r\n            category: 'variables',\r\n            spec: 'show variable %var'\r\n        },\r\n        doHideVar: {\r\n            type: 'command',\r\n            category: 'variables',\r\n            spec: 'hide variable %var'\r\n        },\r\n        doDeclareVariables: {\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'script variables %scriptVars'\r\n        },\r\n\r\n        // inheritance - experimental\r\n        doDeleteAttr: {\r\n            type: 'command',\r\n            category: 'variables',\r\n            spec: 'inherit %shd'\r\n        },\r\n\r\n        // Lists\r\n        reportNewList: {\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: 'list %exp'\r\n        },\r\n        reportCONS: {\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: '%s in front of %l'\r\n        },\r\n        reportListItem: {\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: 'item %idx of %l',\r\n            defaults: [1]\r\n        },\r\n        reportCDR: {\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: 'all but first of %l'\r\n        },\r\n        reportListLength: {\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: 'length of %l'\r\n        },\r\n        reportListContainsItem: {\r\n            type: 'predicate',\r\n            category: 'lists',\r\n            spec: '%l contains %s',\r\n            defaults: [null, localize('thing')]\r\n        },\r\n        doAddToList: {\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'add %s to %l',\r\n            defaults: [localize('thing')]\r\n        },\r\n        doDeleteFromList: {\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'delete %ida of %l',\r\n            defaults: [1]\r\n        },\r\n        doInsertInList: {\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'insert %s at %idx of %l',\r\n            defaults: [localize('thing'), 1]\r\n        },\r\n        doReplaceInList: {\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'replace item %idx of %l with %s',\r\n            defaults: [1, null, localize('thing')]\r\n        },\r\n\r\n        // MAP - experimental\r\n        reportMap: {\r\n            dev: true,\r\n            type: 'reporter',\r\n            category: 'lists',\r\n            spec: 'map %repRing over %l'\r\n        },\r\n        doForEach: {\r\n            dev: true,\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'for %upvar in %l %cl',\r\n            defaults: [localize('each item')]\r\n        },\r\n\r\n        // Tables - experimental\r\n\r\n        doShowTable: {\r\n            dev: true,\r\n            type: 'command',\r\n            category: 'lists',\r\n            spec: 'show table %l'\r\n        },\r\n\r\n        // Code mapping - experimental\r\n        doMapCodeOrHeader: { // experimental\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'map %cmdRing to %codeKind %code'\r\n        },\r\n        doMapValueCode: { // experimental\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'map %mapValue to code %code',\r\n            defaults: [['String'], '<#1>']\r\n        },\r\n    /* obsolete - superseded by 'doMapValue'\r\n        doMapStringCode: { // experimental\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'map String to code %code',\r\n            defaults: ['<#1>']\r\n        },\r\n    */\r\n        doMapListCode: { // experimental\r\n            type: 'command',\r\n            category: 'other',\r\n            spec: 'map %codeListPart of %codeListKind to code %code'\r\n        },\r\n        reportMappedCode: { // experimental\r\n            type: 'reporter',\r\n            category: 'other',\r\n            spec: 'code of %cmdRing'\r\n        }\r\n    };\r\n};\r\n\r\nSpriteMorph.prototype.initBlocks();\r\n\r\nSpriteMorph.prototype.initBlockMigrations = function () {\r\n    // change blocks in existing projects to their updated version\r\n    SpriteMorph.prototype.blockMigrations = {\r\n        doStopAll: {\r\n            selector: 'doStopThis',\r\n            inputs: [['all']]\r\n        },\r\n        doStop: {\r\n            selector: 'doStopThis',\r\n            inputs: [['this script']]\r\n        },\r\n        doStopBlock: {\r\n            selector: 'doStopThis',\r\n            inputs: [['this block']]\r\n        },\r\n        doStopOthers: {\r\n            selector: 'doStopThis',\r\n            inputs: [['all']],\r\n            offset: 0\r\n        },\r\n        receiveClick: {\r\n            selector: 'receiveInteraction',\r\n            inputs: [['clicked']]\r\n        },\r\n        reportTrue: {\r\n            selector: 'reportBoolean',\r\n            inputs: [true]\r\n        },\r\n        reportFalse: {\r\n            selector: 'reportBoolean',\r\n            inputs: [false]\r\n        },\r\n        reportCostumes: {\r\n            selector: 'reportGet',\r\n            inputs: [['costumes']]\r\n        },\r\n        reportSounds: {\r\n            selector: 'reportGet',\r\n            inputs: [['sounds']]\r\n        },\r\n        doMapStringCode: {\r\n            selector: 'doMapValueCode',\r\n            inputs: [['String'], '<#1>'],\r\n            offset: 1\r\n        }\r\n    };\r\n};\r\n\r\nSpriteMorph.prototype.initBlockMigrations();\r\n\r\nSpriteMorph.prototype.blockAlternatives = {\r\n    // motion:\r\n    turn: ['turnLeft'],\r\n    turnLeft: ['turn'],\r\n    changeXPosition: ['changeYPosition', 'setXPosition', 'setYPosition'],\r\n    setXPosition: ['setYPosition', 'changeXPosition', 'changeYPosition'],\r\n    changeYPosition: ['changeXPosition', 'setYPosition', 'setXPosition'],\r\n    setYPosition: ['setXPosition', 'changeYPosition', 'changeXPosition'],\r\n    xPosition: ['yPosition'],\r\n    yPosition: ['xPosition'],\r\n\r\n    // looks:\r\n    doSayFor: ['doThinkFor', 'bubble', 'doThink', 'doAsk'],\r\n    doThinkFor: ['doSayFor', 'doThink', 'bubble', 'doAsk'],\r\n    bubble: ['doThink', 'doAsk', 'doSayFor', 'doThinkFor'],\r\n    doThink: ['bubble', 'doAsk', 'doSayFor', 'doThinkFor'],\r\n    show: ['hide'],\r\n    hide: ['show'],\r\n    changeEffect: ['setEffect'],\r\n    setEffect: ['changeEffect'],\r\n    changeScale: ['setScale'],\r\n    setScale: ['changeScale'],\r\n\r\n    // sound:\r\n    playSound: ['doPlaySoundUntilDone'],\r\n    doPlaySoundUntilDone: ['playSound'],\r\n    doChangeTempo: ['doSetTempo'],\r\n    doSetTempo: ['doChangeTempo'],\r\n\r\n    // pen:\r\n    clear: ['down', 'up', 'doStamp'],\r\n    down: ['up', 'clear', 'doStamp'],\r\n    up: ['down', 'clear', 'doStamp'],\r\n    doStamp: ['clear', 'down', 'up'],\r\n    changeHue: ['setHue', 'changeBrightness', 'setBrightness'],\r\n    setHue: ['changeHue', 'changeBrightness', 'setBrightness'],\r\n    changeBrightness: ['setBrightness', 'setHue', 'changeHue'],\r\n    setBrightness: ['changeBrightness', 'setHue', 'changeHue'],\r\n    changeSize: ['setSize'],\r\n    setSize: ['changeSize'],\r\n\r\n    // control:\r\n    doBroadcast: ['doBroadcastAndWait'],\r\n    doBroadcastAndWait: ['doBroadcast'],\r\n    doIf: ['doIfElse', 'doUntil'],\r\n    doIfElse: ['doIf', 'doUntil'],\r\n    doRepeat: ['doUntil'],\r\n    doUntil: ['doRepeat', 'doIf'],\r\n\r\n    // sensing:\r\n    doAsk: ['bubble', 'doThink', 'doSayFor', 'doThinkFor'],\r\n    getLastAnswer: ['getTimer'],\r\n    getTimer: ['getLastAnswer'],\r\n    reportMouseX: ['reportMouseY'],\r\n    reportMouseY: ['reportMouseX'],\r\n\r\n    // operators:\r\n    reportSum: ['reportDifference', 'reportProduct', 'reportQuotient'],\r\n    reportDifference: ['reportSum', 'reportProduct', 'reportQuotient'],\r\n    reportProduct: ['reportDifference', 'reportSum', 'reportQuotient'],\r\n    reportQuotient: ['reportDifference', 'reportProduct', 'reportSum'],\r\n    reportLessThan: ['reportEquals', 'reportGreaterThan'],\r\n    reportEquals: ['reportLessThan', 'reportGreaterThan'],\r\n    reportGreaterThan: ['reportEquals', 'reportLessThan'],\r\n    reportAnd: ['reportOr'],\r\n    reportOr: ['reportAnd'],\r\n\r\n    // variables\r\n    doSetVar: ['doChangeVar'],\r\n    doChangeVar: ['doSetVar'],\r\n    doShowVar: ['doHideVar'],\r\n    doHideVar: ['doShowVar']\r\n};\r\n\r\n// SpriteMorph instance creation\r\n\r\nfunction SpriteMorph(globals) {\r\n    this.init(globals);\r\n}\r\n\r\nSpriteMorph.prototype.init = function (globals) {\r\n    this.name = localize('Sprite');\r\n    this.instrument = null;\r\n    this.variables = new VariableFrame(globals || null, this);\r\n    this.scripts = new ScriptsMorph();\r\n    this.customBlocks = [];\r\n    this.costumes = new List();\r\n    this.costumes.type = 'costume';\r\n    this.costume = null;\r\n    this.sounds = new List();\r\n    this.sounds.type = 'sound';\r\n    this.normalExtent = new Point(60, 60); // only for costume-less situation\r\n    this.scale = 1;\r\n    this.rotationStyle = 1; // 1 = full, 2 = left/right, 0 = off\r\n    this.version = Date.now(); // for observer optimization\r\n    this.isTemporary = false; // indicate a temporary Scratch-style clone\r\n    this.isCorpse = false; // indicate whether a sprite/clone has been deleted\r\n    this.cloneOriginName = '';\r\n\r\n    // only temporarily for serialization\r\n    this.inheritedMethodsCache = [];\r\n\r\n    // sprite nesting properties\r\n    this.parts = []; // not serialized, only anchor (name)\r\n    this.anchor = null;\r\n    this.nestingScale = 1;\r\n    this.rotatesWithAnchor = true;\r\n    this.layers = null; // cache for dragging nested sprites, don't serialize\r\n\r\n    this.blocksCache = {}; // not to be serialized (!)\r\n    this.paletteCache = {}; // not to be serialized (!)\r\n    this.rotationOffset = new Point(); // not to be serialized (!)\r\n    this.idx = 0; // not to be serialized (!) - used for de-serialization\r\n    this.wasWarped = false; // not to be serialized, used for fast-tracking\r\n\r\n    this.graphicsValues = {\r\n        'color': 0,\r\n        'fisheye': 0,\r\n        'whirl': 0,\r\n        'pixelate': 0,\r\n        'mosaic': 0,\r\n        'duplicate': 0,\r\n        'negative': 0,\r\n        'comic': 0,\r\n        'confetti': 0,\r\n        'saturation': 0,\r\n        'brightness': 0\r\n    };\r\n\r\n    // sprite inheritance\r\n    this.exemplar = null;\r\n    this.instances = [];\r\n    this.cachedPropagation = false; // not to be persisted\r\n    this.inheritedAttributes = []; // 'x position', 'direction', 'size' etc...\r\n\r\n    SpriteMorph.uber.init.call(this);\r\n\r\n    this.isDraggable = true;\r\n    this.isDown = false;\r\n    this.heading = 90;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// SpriteMorph duplicating (fullCopy)\r\n\r\nSpriteMorph.prototype.fullCopy = function (forClone) {\r\n    var c = SpriteMorph.uber.fullCopy.call(this),\r\n        myself = this,\r\n        arr = [],\r\n        cb, effect;\r\n\r\n    c.instances = [];\r\n    c.stopTalking();\r\n    c.color = this.color.copy();\r\n    c.blocksCache = {};\r\n    c.paletteCache = {};\r\n    arr = [];\r\n    this.inheritedAttributes.forEach(function (att) {\r\n        arr.push(att);\r\n    });\r\n    c.inheritedAttributes = arr;\r\n    if (forClone) {\r\n        c.exemplar = this;\r\n        c.customBlocks = [];\r\n        c.variables = new VariableFrame(null, c);\r\n        c.variables.parentFrame = this.variables;\r\n        c.inheritedVariableNames().forEach(function (name) {\r\n            c.shadowVar(name, c.variables.getVar(name));\r\n        });\r\n        this.addSpecimen(c);\r\n        this.cachedPropagation = false;\r\n        ['scripts', 'costumes', 'sounds'].forEach(function (att) {\r\n            if (!contains(c.inheritedAttributes, att)) {\r\n                c.inheritedAttributes.push(att);\r\n            }\r\n        });\r\n    } else {\r\n        c.variables = this.variables.copy();\r\n        c.variables.owner = c;\r\n        c.scripts = this.scripts.fullCopy();\r\n        c.customBlocks = [];\r\n        this.customBlocks.forEach(function (def) {\r\n            cb = def.copyAndBindTo(c);\r\n            c.customBlocks.push(cb);\r\n            c.allBlockInstances(def).forEach(function (block) {\r\n                block.definition = cb;\r\n            });\r\n        });\r\n        arr = [];\r\n        this.costumes.asArray().forEach(function (costume) {\r\n            var cst = forClone ? costume : costume.copy();\r\n            arr.push(cst);\r\n            if (costume === myself.costume) {\r\n                c.costume = cst;\r\n            }\r\n        });\r\n        c.costumes = new List(arr);\r\n        arr = [];\r\n        this.sounds.asArray().forEach(function (sound) {\r\n            var snd = forClone ? sound : sound.copy();\r\n            arr.push(snd);\r\n        });\r\n        c.sounds = new List(arr);\r\n        arr = [];\r\n    }\r\n    c.nestingScale = 1;\r\n    c.rotatesWithAnchor = true;\r\n    c.anchor = null;\r\n    c.parts = [];\r\n    this.parts.forEach(function (part) {\r\n        var dp = part.fullCopy(forClone);\r\n        dp.nestingScale = part.nestingScale;\r\n        dp.rotatesWithAnchor = part.rotatesWithAnchor;\r\n        c.attachPart(dp);\r\n    });\r\n    c.graphicsValues = {};\r\n    for (effect in this.graphicsValues) {\r\n        if (this.graphicsValues.hasOwnProperty(effect)) {\r\n            c.graphicsValues[effect] = this.graphicsValues[effect];\r\n        }\r\n    }\r\n    return c;\r\n};\r\n\r\nSpriteMorph.prototype.appearIn = function (ide) {\r\n    // private - used in IDE_Morph.duplicateSprite()\r\n    if (!this.isTemporary) {\r\n        this.name = ide.newSpriteName(this.name);\r\n        ide.corral.addSprite(this);\r\n        ide.sprites.add(this);\r\n    }\r\n    ide.stage.add(this);\r\n    this.parts.forEach(function (part) {\r\n        part.appearIn(ide);\r\n    });\r\n};\r\n\r\n// SpriteMorph versioning\r\n\r\nSpriteMorph.prototype.setName = function (string) {\r\n    this.name = string || this.name;\r\n    this.version = Date.now();\r\n};\r\n\r\n// SpriteMorph rendering\r\n\r\nSpriteMorph.prototype.drawNew = function () {\r\n    var myself = this,\r\n        currentCenter,\r\n        facing, // actual costume heading based on my rotation style\r\n        isFlipped,\r\n        isLoadingCostume,\r\n        cst,\r\n        pic, // (flipped copy of) actual costume based on my rotation style\r\n        stageScale,\r\n        newX,\r\n        corners = [],\r\n        origin,\r\n        shift,\r\n        corner,\r\n        costumeExtent,\r\n        ctx,\r\n        handle;\r\n\r\n    if (this.isWarped) {\r\n        this.wantsRedraw = true;\r\n        return;\r\n    }\r\n    currentCenter = this.center();\r\n    isLoadingCostume = this.costume &&\r\n        typeof this.costume.loaded === 'function';\r\n    stageScale = this.parent instanceof StageMorph ?\r\n            this.parent.scale : 1;\r\n    facing = this.rotationStyle ? this.heading : 90;\r\n    if (this.rotationStyle === 2) {\r\n        facing = 90;\r\n        if ((this.heading > 180 && (this.heading < 360))\r\n                || (this.heading < 0 && (this.heading > -180))) {\r\n            isFlipped = true;\r\n        }\r\n    }\r\n    if (this.costume && !isLoadingCostume) {\r\n        pic = isFlipped ? this.costume.flipped() : this.costume;\r\n\r\n        // determine the rotated costume's bounding box\r\n        corners = pic.bounds().corners().map(function (point) {\r\n            return point.rotateBy(\r\n                radians(facing - 90),\r\n                myself.costume.center()\r\n            );\r\n        });\r\n        origin = corners[0];\r\n        corner = corners[0];\r\n        corners.forEach(function (point) {\r\n            origin = origin.min(point);\r\n            corner = corner.max(point);\r\n        });\r\n        costumeExtent = origin.corner(corner)\r\n            .extent().multiplyBy(this.scale * stageScale);\r\n\r\n        // determine the new relative origin of the rotated shape\r\n        shift = new Point(0, 0).rotateBy(\r\n            radians(-(facing - 90)),\r\n            pic.center()\r\n        ).subtract(origin);\r\n\r\n        // create a new, adequately dimensioned canvas\r\n        // and draw the costume on it\r\n        this.image = newCanvas(costumeExtent, true);\r\n        this.silentSetExtent(costumeExtent);\r\n        ctx = this.image.getContext('2d');\r\n        ctx.scale(this.scale * stageScale, this.scale * stageScale);\r\n        ctx.translate(shift.x, shift.y);\r\n        ctx.rotate(radians(facing - 90));\r\n        ctx.drawImage(pic.contents, 0, 0);\r\n\r\n        // apply graphics effects to image\r\n        this.image = this.applyGraphicsEffects(this.image);\r\n\r\n        // adjust my position to the rotation\r\n        this.setCenter(currentCenter, true); // just me\r\n\r\n        // determine my rotation offset\r\n        this.rotationOffset = shift\r\n            .translateBy(pic.rotationCenter)\r\n            .rotateBy(radians(-(facing - 90)), shift)\r\n            .scaleBy(this.scale * stageScale);\r\n    } else {\r\n        facing = isFlipped ? -90 : facing;\r\n        newX = Math.min(\r\n            Math.max(\r\n                this.normalExtent.x * this.scale * stageScale,\r\n                5\r\n            ),\r\n            1000\r\n        );\r\n        this.silentSetExtent(new Point(newX, newX));\r\n        this.image = newCanvas(this.extent(), true);\r\n        this.setCenter(currentCenter, true); // just me\r\n        SpriteMorph.uber.drawNew.call(this, facing);\r\n        this.rotationOffset = this.extent().divideBy(2);\r\n        this.image = this.applyGraphicsEffects(this.image);\r\n        if (isLoadingCostume) { // retry until costume is done loading\r\n            cst = this.costume;\r\n            handle = setInterval(\r\n                function () {\r\n                    myself.wearCostume(cst);\r\n                    clearInterval(handle);\r\n                },\r\n                100\r\n            );\r\n            return myself.wearCostume(null);\r\n\r\n        }\r\n    }\r\n    this.version = Date.now(); // for observer optimization\r\n};\r\n\r\nSpriteMorph.prototype.endWarp = function () {\r\n    this.isWarped = false;\r\n    if (this.wantsRedraw) {\r\n        var x = this.xPosition(),\r\n            y = this.yPosition();\r\n        this.drawNew();\r\n        this.silentGotoXY(x, y, true); // just me\r\n        this.wantsRedraw = false;\r\n    }\r\n    this.parent.changed();\r\n};\r\n\r\nSpriteMorph.prototype.rotationCenter = function () {\r\n    return this.position().add(this.rotationOffset);\r\n};\r\n\r\nSpriteMorph.prototype.colorFiltered = function (aColor) {\r\n    // answer a new Morph containing my image filtered by aColor\r\n    // ignore transparency (alpha)\r\n    var morph = new Morph(),\r\n        ext = this.extent(),\r\n        ctx,\r\n        src,\r\n        clr,\r\n        i,\r\n        dta;\r\n\r\n    src = normalizeCanvas(this.image, true).getContext('2d').getImageData(\r\n        0,\r\n        0,\r\n        ext.x,\r\n        ext.y\r\n    );\r\n    morph.image = newCanvas(ext, true);\r\n    morph.bounds = this.bounds.copy();\r\n    ctx = morph.image.getContext('2d');\r\n    dta = ctx.createImageData(ext.x, ext.y);\r\n    for (i = 0; i < ext.x * ext.y * 4; i += 4) {\r\n        clr = new Color(\r\n            src.data[i],\r\n            src.data[i + 1],\r\n            src.data[i + 2]\r\n        );\r\n        if (clr.eq(aColor)) {\r\n            dta.data[i] = src.data[i];\r\n            dta.data[i + 1] = src.data[i + 1];\r\n            dta.data[i + 2] = src.data[i + 2];\r\n            dta.data[i + 3] = 255;\r\n        }\r\n    }\r\n    ctx.putImageData(dta, 0, 0);\r\n    return morph;\r\n};\r\n\r\n// SpriteMorph block instantiation\r\n\r\nSpriteMorph.prototype.blockForSelector = function (selector, setDefaults) {\r\n    var migration, info, block, defaults, inputs, i;\r\n    migration = this.blockMigrations[selector];\r\n    info = this.blocks[migration ? migration.selector : selector];\r\n    if (!info) {return null; }\r\n    block = info.type === 'command' ? new CommandBlockMorph()\r\n        : info.type === 'hat' ? new HatBlockMorph()\r\n            : info.type === 'ring' ? new RingMorph()\r\n                : new ReporterBlockMorph(info.type === 'predicate');\r\n    block.color = this.blockColor[info.category];\r\n    block.category = info.category;\r\n    block.selector = migration ? migration.selector : selector;\r\n    if (contains(['reifyReporter', 'reifyPredicate'], block.selector)) {\r\n        block.isStatic = true;\r\n    }\r\n    block.setSpec(localize(info.spec));\r\n    if ((setDefaults && info.defaults) || (migration && migration.inputs)) {\r\n        defaults = migration ? migration.inputs : info.defaults;\r\n        block.defaults = defaults;\r\n        inputs = block.inputs();\r\n        if (inputs[0] instanceof MultiArgMorph) {\r\n            inputs[0].setContents(defaults);\r\n            inputs[0].defaults = defaults;\r\n        } else {\r\n            for (i = 0; i < defaults.length; i += 1) {\r\n                if (defaults[i] !== null) {\r\n                    inputs[i].setContents(defaults[i]);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return block;\r\n};\r\n\r\nSpriteMorph.prototype.variableBlock = function (varName) {\r\n    var block = new ReporterBlockMorph(false);\r\n    block.selector = 'reportGetVar';\r\n    block.color = this.blockColor.variables;\r\n    block.category = 'variables';\r\n    block.setSpec(varName);\r\n    block.isDraggable = true;\r\n    return block;\r\n};\r\n\r\n// SpriteMorph block templates\r\n\r\nSpriteMorph.prototype.blockTemplates = function (category) {\r\n    var blocks = [], myself = this, varNames, button,\r\n        cat = category || 'motion', txt,\r\n        inheritedVars = this.inheritedVariableNames();\r\n\r\n    function block(selector, isGhosted) {\r\n        if (StageMorph.prototype.hiddenPrimitives[selector]) {\r\n            return null;\r\n        }\r\n        var newBlock = SpriteMorph.prototype.blockForSelector(selector, true);\r\n        newBlock.isTemplate = true;\r\n        if (isGhosted) {newBlock.ghost(); }\r\n        return newBlock;\r\n    }\r\n\r\n    function variableBlock(varName) {\r\n        var newBlock = SpriteMorph.prototype.variableBlock(varName);\r\n        newBlock.isDraggable = false;\r\n        newBlock.isTemplate = true;\r\n        if (contains(inheritedVars, varName)) {\r\n            newBlock.ghost();\r\n        }\r\n        return newBlock;\r\n    }\r\n\r\n    function watcherToggle(selector) {\r\n        if (StageMorph.prototype.hiddenPrimitives[selector]) {\r\n            return null;\r\n        }\r\n        var info = SpriteMorph.prototype.blocks[selector];\r\n        return new ToggleMorph(\r\n            'checkbox',\r\n            this,\r\n            function () {\r\n                myself.toggleWatcher(\r\n                    selector,\r\n                    localize(info.spec),\r\n                    myself.blockColor[info.category]\r\n                );\r\n            },\r\n            null,\r\n            function () {\r\n                return myself.showingWatcher(selector);\r\n            },\r\n            null\r\n        );\r\n    }\r\n\r\n    function variableWatcherToggle(varName) {\r\n        return new ToggleMorph(\r\n            'checkbox',\r\n            this,\r\n            function () {\r\n                myself.toggleVariableWatcher(varName);\r\n            },\r\n            null,\r\n            function () {\r\n                return myself.showingVariableWatcher(varName);\r\n            },\r\n            null\r\n        );\r\n    }\r\n\r\n    function helpMenu() {\r\n        var menu = new MenuMorph(this);\r\n        menu.addItem('help...', 'showHelp');\r\n        return menu;\r\n    }\r\n\r\n    function addVar(pair) {\r\n        var ide;\r\n        if (pair) {\r\n            if (myself.isVariableNameInUse(pair[0], pair[1])) {\r\n                myself.inform('that name is already in use');\r\n            } else {\r\n                ide = myself.parentThatIsA(IDE_Morph);\r\n                myself.addVariable(pair[0], pair[1]);\r\n                if (!myself.showingVariableWatcher(pair[0])) {\r\n                    myself.toggleVariableWatcher(pair[0], pair[1]);\r\n                }\r\n                ide.flushBlocksCache('variables'); // b/c of inheritance\r\n                ide.refreshPalette();\r\n            }\r\n        }\r\n    }\r\n\r\n    if (cat === 'motion') {\r\n\r\n        blocks.push(block('forward'));\r\n        blocks.push(block('turn'));\r\n        blocks.push(block('turnLeft'));\r\n        blocks.push('-');\r\n        blocks.push(block('setHeading'));\r\n        blocks.push(block('doFaceTowards'));\r\n        blocks.push('-');\r\n        blocks.push(block('gotoXY'));\r\n        blocks.push(block('doGotoObject'));\r\n        blocks.push(block('doGlide'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeXPosition'));\r\n        blocks.push(block('setXPosition'));\r\n        blocks.push(block('changeYPosition'));\r\n        blocks.push(block('setYPosition'));\r\n        blocks.push('-');\r\n        blocks.push(block('bounceOffEdge'));\r\n        blocks.push('-');\r\n        blocks.push(watcherToggle('xPosition'));\r\n        blocks.push(block('xPosition', this.inheritsAttribute('x position')));\r\n        blocks.push(watcherToggle('yPosition'));\r\n        blocks.push(block('yPosition', this.inheritsAttribute('y position')));\r\n        blocks.push(watcherToggle('direction'));\r\n        blocks.push(block('direction', this.inheritsAttribute('direction')));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'looks') {\r\n\r\n        blocks.push(block('doSwitchToCostume'));\r\n        blocks.push(block('doWearNextCostume'));\r\n        blocks.push(watcherToggle('getCostumeIdx'));\r\n        blocks.push(block('getCostumeIdx', this.inheritsAttribute('costume #')));\r\n        blocks.push('-');\r\n        blocks.push(block('doSayFor'));\r\n        blocks.push(block('bubble'));\r\n        blocks.push(block('doThinkFor'));\r\n        blocks.push(block('doThink'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeEffect'));\r\n        blocks.push(block('setEffect'));\r\n        blocks.push(block('clearEffects'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeScale'));\r\n        blocks.push(block('setScale'));\r\n        blocks.push(watcherToggle('getScale'));\r\n        blocks.push(block('getScale', this.inheritsAttribute('size')));\r\n        blocks.push('-');\r\n        blocks.push(block('show'));\r\n        blocks.push(block('hide'));\r\n        blocks.push('-');\r\n        blocks.push(block('comeToFront'));\r\n        blocks.push(block('goBack'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('log'));\r\n            blocks.push(block('alert'));\r\n            blocks.push('-');\r\n            blocks.push(block('doScreenshot'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'sound') {\r\n\r\n        blocks.push(block('playSound'));\r\n        blocks.push(block('doPlaySoundUntilDone'));\r\n        blocks.push(block('doStopAllSounds'));\r\n        blocks.push('-');\r\n        blocks.push(block('doRest'));\r\n        blocks.push(block('doPlayNote'));\r\n        blocks.push(block('doSetInstrument'));\r\n        blocks.push('-');\r\n        blocks.push(block('doChangeTempo'));\r\n        blocks.push(block('doSetTempo'));\r\n        blocks.push(watcherToggle('getTempo'));\r\n        blocks.push(block('getTempo'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'pen') {\r\n\r\n        blocks.push(block('clear'));\r\n        blocks.push('-');\r\n        blocks.push(block('down'));\r\n        blocks.push(block('up'));\r\n        blocks.push('-');\r\n        blocks.push(block('setColor'));\r\n        blocks.push(block('changeHue'));\r\n        blocks.push(block('setHue'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeBrightness'));\r\n        blocks.push(block('setBrightness'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeSize'));\r\n        blocks.push(block('setSize'));\r\n        blocks.push('-');\r\n        blocks.push(block('doStamp'));\r\n        blocks.push(block('floodFill'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportPenTrailsAsCostume'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'control') {\r\n\r\n        blocks.push(block('receiveGo'));\r\n        blocks.push(block('receiveKey'));\r\n        blocks.push(block('receiveInteraction'));\r\n        blocks.push(block('receiveCondition'));\r\n        blocks.push(block('receiveMessage'));\r\n        blocks.push('-');\r\n        blocks.push(block('doBroadcast'));\r\n        blocks.push(block('doBroadcastAndWait'));\r\n        blocks.push(watcherToggle('getLastMessage'));\r\n        blocks.push(block('getLastMessage'));\r\n        blocks.push('-');\r\n        blocks.push(block('doWarp'));\r\n        blocks.push('-');\r\n        blocks.push(block('doWait'));\r\n        blocks.push(block('doWaitUntil'));\r\n        blocks.push('-');\r\n        blocks.push(block('doForever'));\r\n        blocks.push(block('doRepeat'));\r\n        blocks.push(block('doUntil'));\r\n        blocks.push('-');\r\n        blocks.push(block('doIf'));\r\n        blocks.push(block('doIfElse'));\r\n        blocks.push('-');\r\n        blocks.push(block('doReport'));\r\n    /*\r\n    // old STOP variants, migrated to a newer version, now redundant\r\n        blocks.push(block('doStopBlock'));\r\n        blocks.push(block('doStop'));\r\n        blocks.push(block('doStopAll'));\r\n    */\r\n        blocks.push(block('doStopThis'));\r\n    /*\r\n        // migrated to doStopThis, now redundant\r\n        blocks.push(block('doStopOthers'));\r\n    */\r\n        blocks.push('-');\r\n        blocks.push(block('doRun'));\r\n        blocks.push(block('fork'));\r\n        blocks.push(block('evaluate'));\r\n        blocks.push('-');\r\n        blocks.push(block('doTellTo'));\r\n        blocks.push(block('reportAskFor'));\r\n        blocks.push('-');\r\n        blocks.push(block('doCallCC'));\r\n        blocks.push(block('reportCallCC'));\r\n        blocks.push('-');\r\n        blocks.push(block('receiveOnClone'));\r\n        blocks.push(block('createClone'));\r\n        blocks.push(block('newClone'));\r\n        blocks.push(block('removeClone'));\r\n        blocks.push('-');\r\n        blocks.push(block('doPauseAll'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'sensing') {\r\n\r\n        blocks.push(block('reportTouchingObject'));\r\n        blocks.push(block('reportTouchingColor'));\r\n        blocks.push(block('reportColorIsTouchingColor'));\r\n        blocks.push('-');\r\n        blocks.push(block('doAsk'));\r\n        blocks.push(watcherToggle('getLastAnswer'));\r\n        blocks.push(block('getLastAnswer'));\r\n        blocks.push('-');\r\n        blocks.push(watcherToggle('reportMouseX'));\r\n        blocks.push(block('reportMouseX'));\r\n        blocks.push(watcherToggle('reportMouseY'));\r\n        blocks.push(block('reportMouseY'));\r\n        blocks.push(block('reportMouseDown'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportKeyPressed'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportDistanceTo'));\r\n        blocks.push('-');\r\n        blocks.push(block('doResetTimer'));\r\n        blocks.push(watcherToggle('getTimer'));\r\n        blocks.push(block('getTimer'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportAttributeOf'));\r\n\r\n        if (SpriteMorph.prototype.enableFirstClass) {\r\n            blocks.push(block('reportGet'));\r\n        }\r\n        blocks.push('-');\r\n\r\n        blocks.push(block('reportURL'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportIsFastTracking'));\r\n        blocks.push(block('doSetFastTracking'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportDate'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(watcherToggle('reportThreadCount'));\r\n            blocks.push(block('reportThreadCount'));\r\n            blocks.push(block('colorFiltered'));\r\n            blocks.push(block('reportStackSize'));\r\n            blocks.push(block('reportFrameCount'));\r\n        }\r\n\r\n\t/////////////////////////////////\r\n\r\n\t\tblocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'operators') {\r\n\r\n        blocks.push(block('reifyScript'));\r\n        blocks.push(block('reifyReporter'));\r\n        blocks.push(block('reifyPredicate'));\r\n        blocks.push('#');\r\n        blocks.push('-');\r\n        blocks.push(block('reportSum'));\r\n        blocks.push(block('reportDifference'));\r\n        blocks.push(block('reportProduct'));\r\n        blocks.push(block('reportQuotient'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportModulus'));\r\n        blocks.push(block('reportRound'));\r\n        blocks.push(block('reportMonadic'));\r\n        blocks.push(block('reportRandom'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportLessThan'));\r\n        blocks.push(block('reportEquals'));\r\n        blocks.push(block('reportGreaterThan'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportAnd'));\r\n        blocks.push(block('reportOr'));\r\n        blocks.push(block('reportNot'));\r\n        blocks.push(block('reportBoolean'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportJoinWords'));\r\n        blocks.push(block('reportTextSplit'));\r\n        blocks.push(block('reportLetter'));\r\n        blocks.push(block('reportStringSize'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportUnicode'));\r\n        blocks.push(block('reportUnicodeAsLetter'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportIsA'));\r\n        blocks.push(block('reportIsIdentical'));\r\n\r\n        if (true) { // (Process.prototype.enableJS) {\r\n            blocks.push('-');\r\n            blocks.push(block('reportJSFunction'));\r\n        }\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('reportTypeOf'));\r\n            blocks.push(block('reportTextFunction'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'variables') {\r\n\r\n        button = new PushButtonMorph(\r\n            null,\r\n            function () {\r\n                new VariableDialogMorph(\r\n                    null,\r\n                    addVar,\r\n                    myself\r\n                ).prompt(\r\n                    'Variable name',\r\n                    null,\r\n                    myself.world()\r\n                );\r\n            },\r\n            'Make a variable'\r\n        );\r\n        button.userMenu = helpMenu;\r\n        button.selector = 'addVariable';\r\n        button.showHelp = BlockMorph.prototype.showHelp;\r\n        blocks.push(button);\r\n\r\n        if (this.deletableVariableNames().length > 0) {\r\n            button = new PushButtonMorph(\r\n                null,\r\n                function () {\r\n                    var menu = new MenuMorph(\r\n                        myself.deleteVariable,\r\n                        null,\r\n                        myself\r\n                    );\r\n                    myself.deletableVariableNames().forEach(function (name) {\r\n                        menu.addItem(name, name);\r\n                    });\r\n                    menu.popUpAtHand(myself.world());\r\n                },\r\n                'Delete a variable'\r\n            );\r\n            button.userMenu = helpMenu;\r\n            button.selector = 'deleteVariable';\r\n            button.showHelp = BlockMorph.prototype.showHelp;\r\n            blocks.push(button);\r\n        }\r\n\r\n        blocks.push('-');\r\n\r\n        varNames = this.variables.allNames();\r\n        if (varNames.length > 0) {\r\n            varNames.forEach(function (name) {\r\n                blocks.push(variableWatcherToggle(name));\r\n                blocks.push(variableBlock(name));\r\n            });\r\n            blocks.push('-');\r\n        }\r\n\r\n        blocks.push(block('doSetVar'));\r\n        blocks.push(block('doChangeVar'));\r\n        blocks.push(block('doShowVar'));\r\n        blocks.push(block('doHideVar'));\r\n        blocks.push(block('doDeclareVariables'));\r\n\r\n    // inheritance:\r\n\r\n        if (StageMorph.prototype.enableInheritance) {\r\n            blocks.push('-');\r\n            blocks.push(block('doDeleteAttr'));\r\n        }\r\n\r\n    ///////////////////////////////\r\n\r\n        blocks.push('=');\r\n\r\n        blocks.push(block('reportNewList'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportCONS'));\r\n        blocks.push(block('reportListItem'));\r\n        blocks.push(block('reportCDR'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportListLength'));\r\n        blocks.push(block('reportListContainsItem'));\r\n        blocks.push('-');\r\n        blocks.push(block('doAddToList'));\r\n        blocks.push(block('doDeleteFromList'));\r\n        blocks.push(block('doInsertInList'));\r\n        blocks.push(block('doReplaceInList'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('reportMap'));\r\n            blocks.push('-');\r\n            blocks.push(block('doForEach'));\r\n            blocks.push(block('doShowTable'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n\r\n        if (StageMorph.prototype.enableCodeMapping) {\r\n            blocks.push(block('doMapCodeOrHeader'));\r\n            blocks.push(block('doMapValueCode'));\r\n            blocks.push(block('doMapListCode'));\r\n            blocks.push('-');\r\n            blocks.push(block('reportMappedCode'));\r\n            blocks.push('=');\r\n        }\r\n\r\n        blocks.push(this.makeBlockButton());\r\n\r\n \t}\r\n    return blocks;\r\n};\r\n\r\nSpriteMorph.prototype.makeBlockButton = function (category) {\r\n\t// answer a button that prompts the user to make a new block\r\n    var button = new PushButtonMorph(\r\n        this,\r\n\t\t'makeBlock',\r\n        'Make a block'\r\n    );\r\n\r\n    button.userMenu = function () {\r\n        var menu = new MenuMorph(this);\r\n        menu.addItem('help...', 'showHelp');\r\n        return menu;\r\n    };\r\n\r\n    button.selector = 'addCustomBlock';\r\n    button.showHelp = BlockMorph.prototype.showHelp;\r\n    return button;\r\n};\r\n\r\nSpriteMorph.prototype.makeBlock = function () {\r\n    // prompt the user to make a new block\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        stage = this.parentThatIsA(StageMorph),\r\n        category = ide.currentCategory,\r\n        clr = SpriteMorph.prototype.blockColor[category],\r\n        myself = this,\r\n        dlg;\r\n    dlg = new BlockDialogMorph(\r\n        null,\r\n        function (definition) {\r\n            if (definition.spec !== '') {\r\n                if (definition.isGlobal) {\r\n                    stage.globalBlocks.push(definition);\r\n                } else {\r\n                    myself.customBlocks.push(definition);\r\n                }\r\n                ide.flushPaletteCache();\r\n                ide.refreshPalette();\r\n                new BlockEditorMorph(definition, myself).popUp();\r\n            }\r\n        },\r\n        myself\r\n    );\r\n    if (category !== 'variables') {\r\n        dlg.category = category;\r\n        dlg.categories.children.forEach(function (each) {\r\n            each.refresh();\r\n        });\r\n        dlg.types.children.forEach(function (each) {\r\n            each.setColor(clr);\r\n        each.refresh();\r\n        });\r\n    }\r\n    dlg.prompt(\r\n        'Make a block',\r\n        null,\r\n        myself.world()\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.palette = function (category) {\r\n    if (!this.paletteCache[category]) {\r\n        this.paletteCache[category] = this.freshPalette(category);\r\n    }\r\n    return this.paletteCache[category];\r\n};\r\n\r\nSpriteMorph.prototype.freshPalette = function (category) {\r\n    var palette = new ScrollFrameMorph(null, null, this.sliderColor),\r\n        unit = SyntaxElementMorph.prototype.fontSize,\r\n        x = 0,\r\n        y = 5,\r\n        ry = 0,\r\n        blocks,\r\n        hideNextSpace = false,\r\n        myself = this,\r\n        stage = this.parentThatIsA(StageMorph),\r\n        oldFlag = Morph.prototype.trackChanges,\r\n        shade = new Color(140, 140, 140),\r\n        searchButton,\r\n        makeButton;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    palette.owner = this;\r\n    palette.padding = unit / 2;\r\n    palette.color = this.paletteColor;\r\n    palette.growth = new Point(0, MorphicPreferences.scrollBarSize);\r\n\r\n    // toolbar:\r\n    \r\n    palette.toolBar = new AlignmentMorph('column');\r\n\r\n    searchButton = new PushButtonMorph(\r\n        this,\r\n        \"searchBlocks\",\r\n        new SymbolMorph(\"magnifierOutline\", 16)\r\n    );\r\n    searchButton.alpha = 0.2;\r\n    searchButton.padding = 1;\r\n    searchButton.hint = localize('find blocks') + '...';\r\n    searchButton.labelShadowColor = shade;\r\n    searchButton.drawNew();\r\n    searchButton.fixLayout();\r\n\tpalette.toolBar.add(searchButton); // Wiquid control the magnify icon for blocks research\r\n\r\n    makeButton = new PushButtonMorph(\r\n        this,\r\n        \"makeBlock\",\r\n        new SymbolMorph(\"cross\", 16)\r\n    );\r\n    makeButton.alpha = 0.2;\r\n    makeButton.padding = 1;\r\n    makeButton.hint = localize('Make a block') + '...';\r\n    makeButton.labelShadowColor = shade;\r\n    makeButton.drawNew();\r\n    makeButton.fixLayout();\r\n    palette.toolBar.add(makeButton);// Wiquid control the plus icon to add blocks\r\n\r\n\tpalette.toolBar.fixLayout();\r\n    palette.add(palette.toolBar); // Wiquid control the whole toolbar\r\n\r\n    // menu:\r\n    palette.userMenu = function () {\r\n        var menu = new MenuMorph(),\r\n            ide = this.parentThatIsA(IDE_Morph),\r\n            more = {\r\n                operators:\r\n                    ['reifyScript', 'reifyReporter', 'reifyPredicate'],\r\n                control:\r\n                    ['doWarp'],\r\n                variables:\r\n                    [\r\n                        'doDeclareVariables',\r\n                        'reportNewList',\r\n                        'reportCONS',\r\n                        'reportListItem',\r\n                        'reportCDR',\r\n                        'reportListLength',\r\n                        'reportListContainsItem',\r\n                        'doAddToList',\r\n                        'doDeleteFromList',\r\n                        'doInsertInList',\r\n                        'doReplaceInList'\r\n                    ]\r\n            };\r\n\r\n        function hasHiddenPrimitives() {\r\n            var defs = SpriteMorph.prototype.blocks,\r\n                hiddens = StageMorph.prototype.hiddenPrimitives;\r\n            return Object.keys(hiddens).some(function (any) {\r\n                return !isNil(defs[any]) && (defs[any].category === category\r\n                    || contains((more[category] || []), any));\r\n            });\r\n        }\r\n\r\n        function canHidePrimitives() {\r\n            return palette.contents.children.some(function (any) {\r\n                return contains(\r\n                    Object.keys(SpriteMorph.prototype.blocks),\r\n                    any.selector\r\n                );\r\n            });\r\n        }\r\n\r\n        menu.addPair(\r\n            [\r\n                new SymbolMorph(\r\n                    'magnifyingGlass',\r\n                    MorphicPreferences.menuFontSize\r\n                ),\r\n                localize('find blocks') + '...'\r\n            ],\r\n            function () {myself.searchBlocks(); },\r\n            '^F'\r\n        );\r\n        if (canHidePrimitives()) {\r\n            menu.addItem(\r\n                'hide primitives',\r\n                function () {\r\n                    var defs = SpriteMorph.prototype.blocks;\r\n                    Object.keys(defs).forEach(function (sel) {\r\n                        if (defs[sel].category === category) {\r\n                            StageMorph.prototype.hiddenPrimitives[sel] = true;\r\n                        }\r\n                    });\r\n                    (more[category] || []).forEach(function (sel) {\r\n                        StageMorph.prototype.hiddenPrimitives[sel] = true;\r\n                    });\r\n                    ide.flushBlocksCache(category);\r\n                    ide.refreshPalette();\r\n                }\r\n            );\r\n        }\r\n        if (hasHiddenPrimitives()) {\r\n            menu.addItem(\r\n                'show primitives',\r\n                function () {\r\n                    var hiddens = StageMorph.prototype.hiddenPrimitives,\r\n                        defs = SpriteMorph.prototype.blocks;\r\n                    Object.keys(hiddens).forEach(function (sel) {\r\n                        if (defs[sel] && (defs[sel].category === category)) {\r\n                            delete StageMorph.prototype.hiddenPrimitives[sel];\r\n                        }\r\n                    });\r\n                    (more[category] || []).forEach(function (sel) {\r\n                        delete StageMorph.prototype.hiddenPrimitives[sel];\r\n                    });\r\n                    ide.flushBlocksCache(category);\r\n                    ide.refreshPalette();\r\n                }\r\n            );\r\n        }\r\n        return menu;\r\n    };\r\n\r\n    // primitives:\r\n\r\n    blocks = this.blocksCache[category];\r\n    if (!blocks) {\r\n        blocks = this.blockTemplates(category);\r\n        if (this.isCachingPrimitives) {\r\n            this.blocksCache[category] = blocks;\r\n        }\r\n    }\r\n\r\n    blocks.forEach(function (block) {\r\n        if (block === null) {\r\n            return;\r\n        }\r\n        if (block === '-') {\r\n            if (hideNextSpace) {return; }\r\n            y += unit * 0.8;\r\n            hideNextSpace = true;\r\n        } else if (block === '=') {\r\n            if (hideNextSpace) {return; }\r\n            y += unit * 1.6;\r\n            hideNextSpace = true;\r\n        } else if (block === '#') {\r\n            x = 0;\r\n            y = ry;\r\n        } else {\r\n            hideNextSpace = false;\r\n            if (x === 0) {\r\n                y += unit * 0.3;\r\n            }\r\n            block.setPosition(new Point(x, y));\r\n            palette.addContents(block);\r\n            if (block instanceof ToggleMorph\r\n                    || (block instanceof RingMorph)) {\r\n                x = block.right() + unit / 2;\r\n                ry = block.bottom();\r\n            } else {\r\n                // if (block.fixLayout) {block.fixLayout(); }\r\n                x = 0;\r\n                y += block.height();\r\n            }\r\n        }\r\n    });\r\n\r\n    // global custom blocks:\r\n\r\n    if (stage) {\r\n        y += unit * 1.6;\r\n\r\n        stage.globalBlocks.forEach(function (definition) {\r\n            var block;\r\n            if (definition.category === category ||\r\n                    (category === 'variables'\r\n                        && contains(\r\n                            ['lists', 'other'],\r\n                            definition.category\r\n                        ))) {\r\n                block = definition.templateInstance();\r\n                y += unit * 0.3;\r\n                block.setPosition(new Point(x, y));\r\n                palette.addContents(block);\r\n                x = 0;\r\n                y += block.height();\r\n            }\r\n        });\r\n    }\r\n\r\n    // local custom blocks:\r\n\r\n    y += unit * 1.6;\r\n    this.customBlocks.forEach(function (definition) {\r\n        var block;\r\n        if (definition.category === category ||\r\n                (category === 'variables'\r\n                    && contains(\r\n                        ['lists', 'other'],\r\n                        definition.category\r\n                    ))) {\r\n            block = definition.templateInstance();\r\n            y += unit * 0.3;\r\n            block.setPosition(new Point(x, y));\r\n            palette.addContents(block);\r\n            x = 0;\r\n            y += block.height();\r\n        }\r\n    });\r\n\r\n    // inherited custom blocks:\r\n\r\n    // y += unit * 1.6;\r\n    if (this.exemplar) {\r\n        this.inheritedBlocks(true).forEach(function (definition) {\r\n            var block;\r\n            if (definition.category === category ||\r\n                    (category === 'variables'\r\n                        && contains(\r\n                            ['lists', 'other'],\r\n                            definition.category\r\n                        ))) {\r\n                block = definition.templateInstance();\r\n                y += unit * 0.3;\r\n                block.setPosition(new Point(x, y));\r\n                palette.addContents(block);\r\n                block.ghost();\r\n                x = 0;\r\n                y += block.height();\r\n            }\r\n        });\r\n    }\r\n\r\n    //layout\r\n\r\n    palette.scrollX(palette.padding);\r\n    palette.scrollY(palette.padding);\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    return palette;\r\n};\r\n\r\n// SpriteMorph blocks searching\r\n\r\nSpriteMorph.prototype.blocksMatching = function (\r\n    searchString,\r\n    strictly,\r\n    types, // optional, ['hat', 'command', 'reporter', 'predicate']\r\n    varNames // optional, list of reachable unique variable names\r\n) {\r\n    // answer an array of block templates whose spec contains\r\n    // the given search string, ordered by descending relevance\r\n    // types is an optional array containing block types the search\r\n    // is limited to, e.g. \"command\", \"hat\", \"reporter\", \"predicate\".\r\n    // Note that \"predicate\" is not subsumed by \"reporter\" and has\r\n    // to be specified explicitly.\r\n    // if no types are specified all blocks are searched\r\n    var blocks = [],\r\n        blocksDict,\r\n        myself = this,\r\n        search = searchString.toLowerCase(),\r\n        stage = this.parentThatIsA(StageMorph),\r\n        reporterized;\r\n\r\n    if (!types || !types.length) {\r\n        types = ['hat', 'command', 'reporter', 'predicate', 'ring'];\r\n    }\r\n    if (!varNames) {varNames = []; }\r\n\r\n    function labelOf(aBlockSpec) {\r\n        var words = (BlockMorph.prototype.parseSpec(aBlockSpec)),\r\n            filtered = words.filter(\r\n                function (each) {return (each.indexOf('%') !== 0); }\r\n            );\r\n        return filtered.join(' ');\r\n    }\r\n\r\n    function fillDigits(anInt, totalDigits, fillChar) {\r\n        var ans = String(anInt);\r\n        while (ans.length < totalDigits) {ans = fillChar + ans; }\r\n        return ans;\r\n    }\r\n\r\n    function relevance(aBlockLabel, aSearchString) {\r\n        var lbl = ' ' + aBlockLabel,\r\n            idx = lbl.indexOf(aSearchString),\r\n            atWord;\r\n        if (idx === -1) {return -1; }\r\n        atWord = (lbl.charAt(idx - 1) === ' ');\r\n        if (strictly && !atWord) {return -1; }\r\n        return (atWord ? '1' : '2') + fillDigits(idx, 4, '0');\r\n    }\r\n\r\n    function primitive(selector) {\r\n        var newBlock = SpriteMorph.prototype.blockForSelector(selector, true);\r\n        newBlock.isTemplate = true;\r\n        return newBlock;\r\n    }\r\n\r\n    // variable getters\r\n    varNames.forEach(function (vName) {\r\n        var rel = relevance(labelOf(vName.toLowerCase()), search);\r\n        if (rel !== -1) {\r\n            blocks.push([myself.variableBlock(vName), rel + '1']);\r\n        }\r\n    });\r\n    // custom blocks\r\n    [this.customBlocks, stage.globalBlocks].forEach(function (blocksList) {\r\n        blocksList.forEach(function (definition) {\r\n            if (contains(types, definition.type)) {\r\n                var spec = localize(definition.blockSpec()).toLowerCase(),\r\n                    rel = relevance(labelOf(spec), search);\r\n                if (rel !== -1) {\r\n                    blocks.push([definition.templateInstance(), rel + '2']);\r\n                }\r\n            }\r\n        });\r\n    });\r\n    // primitives\r\n    blocksDict = SpriteMorph.prototype.blocks;\r\n    Object.keys(blocksDict).forEach(function (selector) {\r\n        if (!StageMorph.prototype.hiddenPrimitives[selector] &&\r\n                contains(types, blocksDict[selector].type)) {\r\n            var block = blocksDict[selector],\r\n                spec = localize(block.alias || block.spec).toLowerCase(),\r\n                rel = relevance(labelOf(spec), search);\r\n            if (\r\n                (rel !== -1) &&\r\n                    (!block.dev) &&\r\n                    (!block.only || (block.only === myself.constructor))\r\n            ) {\r\n                blocks.push([primitive(selector), rel + '3']);\r\n            }\r\n        }\r\n    });\r\n    // infix arithmetic expression\r\n    if (contains(types, 'reporter')) {\r\n        reporterized = this.reporterize(searchString);\r\n        if (reporterized) {\r\n            // reporterized.isTemplate = true;\r\n            // reporterized.isDraggable = false;\r\n            blocks.push([reporterized, '']);\r\n        }\r\n    }\r\n    blocks.sort(function (x, y) {return x[1] < y[1] ? -1 : 1; });\r\n    return blocks.map(function (each) {return each[0]; });\r\n};\r\n\r\nSpriteMorph.prototype.searchBlocks = function (\r\n    searchString,\r\n    types,\r\n    varNames,\r\n    scriptFocus\r\n) {\r\n    var myself = this,\r\n        unit = SyntaxElementMorph.prototype.fontSize,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        oldSearch = '',\r\n        searchBar = new InputFieldMorph(searchString || ''),\r\n        searchPane = ide.createPalette('forSearch'),\r\n        blocksList = [],\r\n        selection,\r\n        focus;\r\n\r\n    function showSelection() {\r\n        if (focus) {focus.destroy(); }\r\n        if (!selection || !scriptFocus) {return; }\r\n        focus = selection.outline(\r\n            MorphicPreferences.isFlat ? new Color(150, 200, 255)\r\n                    : new Color(255, 255, 255),\r\n            2\r\n        );\r\n        searchPane.contents.add(focus);\r\n        focus.scrollIntoView();\r\n    }\r\n\r\n    function show(blocks) {\r\n        var oldFlag = Morph.prototype.trackChanges,\r\n            x = searchPane.contents.left() + 5,\r\n            y = (searchBar.bottom() + unit);\r\n        blocksList = blocks;\r\n        selection = null;\r\n        if (blocks.length && scriptFocus) {\r\n            selection = blocks[0];\r\n        }\r\n        Morph.prototype.trackChanges = false;\r\n        searchPane.contents.children = [searchPane.contents.children[0]];\r\n        blocks.forEach(function (block) {\r\n            block.setPosition(new Point(x, y));\r\n            searchPane.addContents(block);\r\n            y += block.height();\r\n            y += unit * 0.3;\r\n        });\r\n        Morph.prototype.trackChanges = oldFlag;\r\n        showSelection();\r\n        searchPane.changed();\r\n    }\r\n\r\n    searchPane.owner = this;\r\n    searchPane.color = myself.paletteColor;\r\n    searchPane.contents.color = myself.paletteColor;\r\n    searchPane.addContents(searchBar);\r\n    searchBar.drawNew();\r\n    searchBar.setWidth(ide.logo.width() - 30);\r\n    searchBar.contrast = 90;\r\n    searchBar.setPosition(\r\n        searchPane.contents.topLeft().add(new Point(10, 10))\r\n    );\r\n    searchBar.drawNew();\r\n\r\n    searchPane.accept = function () {\r\n        var search;\r\n        if (scriptFocus) {\r\n            searchBar.cancel();\r\n            if (selection) {\r\n                scriptFocus.insertBlock(selection);\r\n            }\r\n        } else {\r\n            search = searchBar.getValue();\r\n            if (search.length > 0) {\r\n                show(myself.blocksMatching(search));\r\n            }\r\n        }\r\n    };\r\n\r\n    searchPane.reactToKeystroke = function (evt) {\r\n        var search, idx, code = evt ? evt.keyCode : 0;\r\n        switch (code) {\r\n        case 38: // up arrow\r\n            if (!scriptFocus || !selection) {return; }\r\n            idx = blocksList.indexOf(selection) - 1;\r\n            if (idx < 0) {\r\n                idx = blocksList.length - 1;\r\n            }\r\n            selection = blocksList[idx];\r\n            showSelection();\r\n            return;\r\n        case 40: // down arrow\r\n            if (!scriptFocus || !selection) {return; }\r\n            idx = blocksList.indexOf(selection) + 1;\r\n            if (idx >= blocksList.length) {\r\n                idx = 0;\r\n            }\r\n            selection = blocksList[idx];\r\n            showSelection();\r\n            return;\r\n        default:\r\n            search = searchBar.getValue();\r\n            if (search !== oldSearch) {\r\n                oldSearch = search;\r\n                show(myself.blocksMatching(\r\n                    search,\r\n                    search.length < 2,\r\n                    types,\r\n                    varNames\r\n                ));\r\n            }\r\n        }\r\n    };\r\n\r\n    searchBar.cancel = function () {\r\n        ide.refreshPalette();\r\n        ide.palette.adjustScrollBars();\r\n    };\r\n\r\n    ide.fixLayout('refreshPalette');\r\n    searchBar.edit();\r\n    if (searchString) {searchPane.reactToKeystroke(); }\r\n};\r\n\r\n// SpritMorph parsing simple arithmetic expressions to reporter blocks\r\n\r\nSpriteMorph.prototype.reporterize = function (expressionString) {\r\n    // highly experimental Christmas Easter Egg 2016 :-)\r\n    var ast;\r\n\r\n    function parseInfix(expression, operator, already) {\r\n        // very basic diadic infix parser for arithmetic expressions\r\n        // with strict left-to-right operator precedence (as in Smalltalk)\r\n        // which can be overriden by - nested - parentheses.\r\n        // assumes well-formed expressions, no graceful error handling yet.\r\n\r\n        var inputs = ['', ''],\r\n            idx = 0,\r\n            ch;\r\n\r\n        function format(value) {\r\n            return value instanceof Array || isNaN(+value) ? value : +value;\r\n        }\r\n\r\n        function nested() {\r\n            var level = 1,\r\n                expr = '';\r\n            while (idx < expression.length) {\r\n                ch = expression[idx];\r\n                idx += 1;\r\n                switch (ch) {\r\n                case '(':\r\n                    level += 1;\r\n                    break;\r\n                case ')':\r\n                    level -= 1;\r\n                    if (!level) {\r\n                        return expr;\r\n                    }\r\n                    break;\r\n                }\r\n                expr += ch;\r\n            }\r\n        }\r\n\r\n        while (idx < expression.length) {\r\n            ch = expression[idx];\r\n            idx += 1;\r\n            switch (ch) {\r\n            case ' ':\r\n                break;\r\n            case '(':\r\n                if (inputs[operator ? 1 : 0].length) {\r\n                    inputs[operator ? 1 : 0] = [\r\n                        inputs[operator ? 1 : 0],\r\n                        parseInfix(nested())\r\n                    ];\r\n                } else {\r\n                    inputs[operator ? 1 : 0] = parseInfix(nested());\r\n                }\r\n                break;\r\n            case '-':\r\n            case '+':\r\n            case '*':\r\n            case '/':\r\n            case '%':\r\n            case '=':\r\n            case '<':\r\n            case '>':\r\n            case '&':\r\n            case '|':\r\n                if (!operator && !inputs[0].length) {\r\n                    inputs[0] = ch;\r\n                } else if (operator) {\r\n                    if (!inputs[1].length) {\r\n                        inputs[1] = ch;\r\n                    } else {\r\n                        return parseInfix(\r\n                            expression.slice(idx),\r\n                            ch,\r\n                            [operator, already, format(inputs[1])]\r\n                        );\r\n                    }\r\n                } else {\r\n                    operator = ch;\r\n                    already = format(inputs[0]);\r\n                }\r\n                break;\r\n            default:\r\n                inputs[operator ? 1 : 0] += ch;\r\n            }\r\n        }\r\n        if (operator) {\r\n            return [operator, already, format(inputs[1])];\r\n        }\r\n        return format(inputs[0]);\r\n    }\r\n\r\n    function blockFromAST(ast) {\r\n        var block, selectors, monads, alias, key, sel, i, inps,\r\n            off = 1,\r\n            reverseDict = {};\r\n        selectors = {\r\n            '+': 'reportSum',\r\n            '-': 'reportDifference',\r\n            '*': 'reportProduct',\r\n            '/': 'reportQuotient',\r\n            '%': 'reportModulus',\r\n            '=': 'reportEquals',\r\n            '<': 'reportLessThan',\r\n            '>': 'reportGreaterThan',\r\n            '&': 'reportAnd',\r\n            '|': 'reportOr',\r\n            round: 'reportRound',\r\n            not: 'reportNot'\r\n        };\r\n        monads = ['abs', 'ceiling', 'floor', 'sqrt', 'sin', 'cos', 'tan',\r\n            'asin', 'acos', 'atan', 'ln', 'log', 'round', 'not'];\r\n        alias = {\r\n            ceil: 'ceiling',\r\n            '!' : 'not'\r\n        };\r\n        monads.concat(['true', 'false']).forEach(function (word) {\r\n            reverseDict[localize(word).toLowerCase()] = word;\r\n        });\r\n        key = alias[ast[0]] || reverseDict[ast[0].toLowerCase()] || ast[0];\r\n        if (contains(monads, key)) { // monadic\r\n            sel = selectors[key];\r\n            if (sel) { // single input\r\n                block = SpriteMorph.prototype.blockForSelector(sel);\r\n                inps = block.inputs();\r\n            } else { // two inputs, first is function name\r\n                block = SpriteMorph.prototype.blockForSelector('reportMonadic');\r\n                inps = block.inputs();\r\n                inps[0].setContents([key]);\r\n                off = 0;\r\n            }\r\n        } else { // diadic\r\n            block = SpriteMorph.prototype.blockForSelector(selectors[key]);\r\n            inps = block.inputs();\r\n        }\r\n        for (i = 1; i < ast.length; i += 1) {\r\n            if (ast[i] instanceof Array) {\r\n                block.silentReplaceInput(inps[i - off], blockFromAST(ast[i]));\r\n            } else if (isString(ast[i])) {\r\n                if (contains(\r\n                    ['true', 'false'], reverseDict[ast[i]] || ast[i])\r\n                ) {\r\n                    block.silentReplaceInput(\r\n                        inps[i - off],\r\n                        SpriteMorph.prototype.blockForSelector(\r\n                            (reverseDict[ast[i]] || ast[i]) === 'true' ?\r\n                                    'reportTrue' : 'reportFalse'\r\n                        )\r\n                    );\r\n                } else if (ast[i] !== '_') {\r\n                    block.silentReplaceInput(\r\n                        inps[i - off],\r\n                        SpriteMorph.prototype.variableBlock(ast[i])\r\n                    );\r\n                }\r\n            } else { // number\r\n                inps[i - off].setContents(ast[i]);\r\n            }\r\n        }\r\n        block.isDraggable = true;\r\n        block.fixLayout();\r\n        block.fixBlockColor(null, true);\r\n        return block;\r\n    }\r\n\r\n    if (expressionString.length > 100) {return null; }\r\n    try {\r\n        ast = parseInfix(expressionString);\r\n        return ast instanceof Array ? blockFromAST(ast) : null;\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n};\r\n\r\n// SpriteMorph variable management\r\n\r\nSpriteMorph.prototype.addVariable = function (name, isGlobal) {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (isGlobal) {\r\n        this.globalVariables().addVar(name);\r\n        if (ide) {\r\n            ide.flushBlocksCache('variables');\r\n        }\r\n    } else {\r\n        this.variables.addVar(name);\r\n        this.blocksCache.variables = null;\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.deleteVariable = function (varName) {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (!contains(this.inheritedVariableNames(true), varName)) {\r\n        // check only shadowed variables\r\n        this.deleteVariableWatcher(varName);\r\n    }\r\n    this.variables.deleteVar(varName);\r\n    if (ide) {\r\n        ide.flushBlocksCache('variables'); // b/c the var could be global\r\n        ide.refreshPalette();\r\n    }\r\n};\r\n\r\n// SpriteMorph costume management\r\n\r\nSpriteMorph.prototype.addCostume = function (costume) {\r\n    if (!costume.name) {\r\n        costume.name = 'costume' + (this.costumes.length() + 1);\r\n    }\r\n    this.shadowAttribute('costumes');\r\n    this.costumes.add(costume);\r\n};\r\n\r\nSpriteMorph.prototype.wearCostume = function (costume, noShadow) {\r\n    var x = this.xPosition ? this.xPosition() : null,\r\n        y = this.yPosition ? this.yPosition() : null,\r\n        idx = isNil(costume) ? null : this.costumes.asArray().indexOf(costume),\r\n        isWarped = this.isWarped;\r\n    if (isWarped) {\r\n        this.endWarp();\r\n    }\r\n    this.changed();\r\n    this.costume = costume;\r\n    this.drawNew();\r\n    this.changed();\r\n    if (isWarped) {\r\n        this.startWarp();\r\n    }\r\n    if (x !== null) {\r\n        this.silentGotoXY(x, y, true); // just me\r\n    }\r\n    if (this.positionTalkBubble) { // the stage doesn't talk\r\n        this.positionTalkBubble();\r\n    }\r\n    this.version = Date.now();\r\n\r\n    // propagate to children that inherit my costume #\r\n    if (!noShadow) {\r\n        this.shadowAttribute('costume #');\r\n    }\r\n    this.specimens().forEach(function (instance) {\r\n        if (instance.cachedPropagation) {\r\n            if (instance.inheritsAttribute('costume #')) {\r\n                if (idx === null) {\r\n                    instance.wearCostume(null, true);\r\n                } else if (idx === -1) {\r\n                    instance.wearCostume(costume, true);\r\n                } else {\r\n                    instance.doSwitchToCostume(idx + 1, true);\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n};\r\n\r\nSpriteMorph.prototype.getCostumeIdx = function () {\r\n    if (this.inheritsAttribute('costume #')) {\r\n        return this.exemplar.getCostumeIdx();\r\n    }\r\n    return this.costumes.asArray().indexOf(this.costume) + 1;\r\n};\r\n\r\nSpriteMorph.prototype.doWearNextCostume = function () {\r\n    var arr = this.costumes.asArray(),\r\n        idx;\r\n    if (arr.length > 1) {\r\n        idx = arr.indexOf(this.costume);\r\n        if (idx > -1) {\r\n            idx += 1;\r\n            if (idx > (arr.length - 1)) {\r\n                idx = 0;\r\n            }\r\n            this.wearCostume(arr[idx]);\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.doWearPreviousCostume = function () {\r\n    var arr = this.costumes.asArray(),\r\n        idx;\r\n    if (arr.length > 1) {\r\n        idx = arr.indexOf(this.costume);\r\n        if (idx > -1) {\r\n            idx -= 1;\r\n            if (idx < 0) {\r\n                idx = arr.length - 1;\r\n            }\r\n            this.wearCostume(arr[idx]);\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.doSwitchToCostume = function (id, noShadow) {\r\n    if (id instanceof Costume) { // allow first-class costumes\r\n        this.wearCostume(id, noShadow);\r\n        return;\r\n    }\r\n\r\n    var num,\r\n        arr = this.costumes.asArray(),\r\n        costume;\r\n    if (\r\n        contains(\r\n            [localize('Turtle'), localize('Empty')],\r\n            (id instanceof Array ? id[0] : null)\r\n        )\r\n    ) {\r\n        costume = null;\r\n    } else {\r\n        if (id === -1) {\r\n            this.doWearPreviousCostume();\r\n            return;\r\n        }\r\n        costume = detect(arr, function (cst) {\r\n            return cst.name === id;\r\n        });\r\n        if (costume === null) {\r\n            num = parseFloat(id);\r\n            if (num === 0) {\r\n                costume = null;\r\n            } else {\r\n                costume = arr[num - 1] || null;\r\n            }\r\n        }\r\n    }\r\n    this.wearCostume(costume, noShadow);\r\n};\r\n\r\nSpriteMorph.prototype.reportCostumes = function () {\r\n    return this.costumes;\r\n};\r\n\r\n// SpriteMorph sound management\r\n\r\nSpriteMorph.prototype.addSound = function (audio, name) {\r\n    this.shadowAttribute('sounds');\r\n    this.sounds.add(new Sound(audio, name));\r\n};\r\n\r\nSpriteMorph.prototype.playSound = function (name) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        sound = name instanceof Sound ? name : detect(\r\n            this.sounds.asArray(),\r\n            function (s) {return s.name === name; }\r\n        ),\r\n        active;\r\n    if (sound) {\r\n        active = sound.play();\r\n        if (stage) {\r\n            stage.activeSounds.push(active);\r\n            stage.activeSounds = stage.activeSounds.filter(function (aud) {\r\n                return !aud.ended && !aud.terminated;\r\n            });\r\n        }\r\n        return active;\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.reportSounds = function () {\r\n    return this.sounds;\r\n};\r\n\r\n// SpriteMorph user menu\r\n\r\nSpriteMorph.prototype.userMenu = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        menu = new MenuMorph(this);\r\n\r\n    if (ide && ide.isAppMode) {\r\n        // menu.addItem('help', 'nop');\r\n        return menu;\r\n    }\r\n    if (!this.isTemporary) {\r\n        menu.addItem(\"duplicate\", 'duplicate');\r\n        if (StageMorph.prototype.enableInheritance) {\r\n            menu.addItem(\"clone\", 'instantiate');\r\n            menu.addLine();\r\n        }\r\n    }\r\n    menu.addItem(\"delete\", 'remove');\r\n    menu.addItem(\"move\", 'moveCenter');\r\n    if (this.costume) {\r\n        menu.addItem(\r\n            \"pivot\",\r\n            'moveRotationCenter',\r\n            'edit the costume\\'s\\nrotation center'\r\n        );\r\n    }\r\n    if (this.isTemporary) {\r\n        if (StageMorph.prototype.enableInheritance) {\r\n            menu.addItem(\r\n                \"edit\",\r\n                'perpetuateAndEdit',\r\n                'make permanent and\\nshow in the sprite corral'\r\n            );\r\n        }\r\n    } else {\r\n        menu.addItem(\"edit\", 'edit');\r\n    }\r\n    menu.addLine();\r\n    if (this.anchor) {\r\n        menu.addItem(\r\n            localize('detach from') + ' ' + this.anchor.name,\r\n            'detachFromAnchor'\r\n        );\r\n    }\r\n    if (this.parts.length) {\r\n        menu.addItem('detach all parts', 'detachAllParts');\r\n    }\r\n    menu.addItem(\"export...\", 'exportSprite');\r\n    return menu;\r\n};\r\n\r\nSpriteMorph.prototype.exportSprite = function () {\r\n    if (this.isTemporary) {return; }\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.exportSprite(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.edit = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide && !ide.isAppMode) {\r\n        ide.selectSprite(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.showOnStage = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        this.keepWithin(stage);\r\n        stage.add(this);\r\n    }\r\n    this.show();\r\n};\r\n\r\nSpriteMorph.prototype.duplicate = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.duplicateSprite(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.instantiate = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.instantiateSprite(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.remove = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.removeSprite(this);\r\n    }\r\n};\r\n\r\n// SpriteMorph cloning\r\n\r\n/*\r\n    clones are temporary, partially shallow copies of sprites that don't\r\n    appear as icons in the corral. Clones get deleted when the red stop button\r\n    is pressed. Shallow-copying clones' scripts and costumes makes spawning\r\n    very fast, so they can be used for particle system simulations.\r\n    This speed-up, however, comes at the cost of some detrimental side\r\n    effects: Changes to a costume or a script of the original sprite are\r\n    in some cases shared with all of its clones, however such shared changes\r\n    are hard to predict for users and not actively propagated, so they don't\r\n    offer any reliable feature, and will not be supported as such.\r\n    Changes to the original sprite's scripts affect all of its clones, unless\r\n    the script contains any custom block whose definition contains one or more\r\n    block variables (in which case the script does get deep-copied).\r\n    The original sprite's scripting area, costumes wardrobe or sounds jukebox\r\n    are also not shared. therefore adding or deleting a script, sound or\r\n    costume in the original sprite has no effect on any of its clones.\r\n*/\r\n\r\nSpriteMorph.prototype.createClone = function (immediately) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        clone;\r\n    if (stage && stage.cloneCount <= 5000) {\r\n        clone = this.fullCopy(true);\r\n        clone.clonify(stage, immediately);\r\n    }\r\n    return clone;\r\n};\r\n\r\nSpriteMorph.prototype.newClone = function (immediately) {\r\n    var clone = this.createClone(immediately);\r\n    if (isNil(clone)) {\r\n        throw new Error('exceeding maximum number of clones');\r\n    }\r\n    return clone;\r\n};\r\n\r\nSpriteMorph.prototype.clonify = function (stage, immediately) {\r\n    var hats,\r\n        myself = this;\r\n    this.parts.forEach(function (part) {\r\n        part.clonify(stage);\r\n    });\r\n    stage.cloneCount += 1;\r\n    this.cloneOriginName = this.isTemporary ?\r\n            this.cloneOriginName : this.name;\r\n    this.isTemporary = true;\r\n    this.name = '';\r\n    stage.add(this);\r\n    hats = this.allHatBlocksFor('__clone__init__');\r\n    hats.forEach(function (block) {\r\n        stage.threads.startProcess(\r\n            block,\r\n            myself,\r\n            stage.isThreadSafe,\r\n            null, // export result\r\n            null, // callback\r\n            null, // is clicked\r\n            immediately // without yielding\r\n        );\r\n    });\r\n    this.endWarp();\r\n};\r\n\r\nSpriteMorph.prototype.initClone = function (hats) {\r\n    // used when manually instantiating a sprite in the IDE\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        myself = this;\r\n    if (stage) {\r\n        hats.forEach(function (block) {\r\n            stage.threads.startProcess(block, myself, stage.isThreadSafe);\r\n        });\r\n        this.endWarp();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.removeClone = function () {\r\n    var exemplar = this.exemplar;\r\n    if (this.isTemporary) {\r\n        // this.stopTalking();\r\n        this.parent.threads.stopAllForReceiver(this);\r\n        this.corpsify();\r\n        this.instances.forEach(function (child) {\r\n            if (child.isTemporary) {\r\n                child.setExemplar(exemplar);\r\n            }\r\n        });\r\n        this.destroy();\r\n        this.parent.cloneCount -= 1;\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.perpetuate = function () {\r\n    // make a temporary sprite (clone) permanent\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n\r\n\t// make sure my exemplar-chain is fully perpetuated\r\n    if (this.exemplar) {\r\n        this.exemplar.perpetuate();\r\n    }\r\n    if (!this.isTemporary || !stage || !ide) {\r\n        return;\r\n    }\r\n    this.isTemporary = false;\r\n    this.name = ide.newSpriteName(this.cloneOriginName);\r\n    this.cloneOriginName = '';\r\n    stage.cloneCount -= 1;\r\n    ide.corral.addSprite(this);\r\n    ide.sprites.add(this);\r\n    this.parts.forEach(function (part) {\r\n        part.perpetuate();\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.perpetuateAndEdit = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        this.perpetuate();\r\n        ide.selectSprite(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.release = function () {\r\n    // turn a permenent sprite that's an instance of another one\r\n    // into a temporary one (clone), that will vanish either when\r\n    // the \"delete this clone\" operation is executed or when the user\r\n    // hits the red stop sign button in the IDE\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        idx;\r\n\r\n    if (this.isTemporary || !this.exemplar || !stage || !ide) {\r\n        return;\r\n    }\r\n\r\n\t// make sure all parts and instances are also released\r\n    this.parts.forEach(function (part) {\r\n        part.release();\r\n    });\r\n    this.instances.forEach(function (inst) {\r\n    \tinst.release();\r\n    });\r\n    this.isTemporary = true;\r\n    this.name = '';\r\n    this.cloneOriginName = this.exemplar.name;\r\n    stage.cloneCount += 1;\r\n    idx = ide.sprites.asArray().indexOf(this) + 1;\r\n    stage.watchers().forEach(function (watcher) {\r\n        if (watcher.object() === this) {\r\n            watcher.destroy();\r\n        }\r\n    });\r\n    if (idx > 0) {\r\n        ide.sprites.remove(idx);\r\n    }\r\n    ide.createCorral();\r\n    ide.fixLayout();\r\n    if (ide.currentSprite === this) {\r\n        ide.currentSprite = detect(\r\n            stage.children,\r\n            function (morph) {\r\n                return morph instanceof SpriteMorph && !morph.isTemporary;\r\n            }\r\n        ) || this.stage;\r\n    }\r\n    ide.selectSprite(ide.currentSprite);\r\n};\r\n\r\n// SpriteMorph deleting\r\n\r\nSpriteMorph.prototype.corpsify = function () {\r\n    this.isCorpse = true;\r\n    this.version = Date.now();\r\n};\r\n\r\n// SpriteMorph primitives\r\n\r\n// SpriteMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to also hide/show all\r\n    nested parts.\r\n*/\r\n\r\nSpriteMorph.prototype.hide = function () {\r\n    SpriteMorph.uber.hide.call(this);\r\n    this.parts.forEach(function (part) {part.hide(); });\r\n};\r\n\r\nSpriteMorph.prototype.show = function () {\r\n    SpriteMorph.uber.show.call(this);\r\n    this.parts.forEach(function (part) {part.show(); });\r\n};\r\n\r\n// SpriteMorph pen color\r\n\r\nSpriteMorph.prototype.setColor = function (aColor) {\r\n    var x = this.xPosition(),\r\n        y = this.yPosition();\r\n    if (!this.color.eq(aColor)) {\r\n        this.color = aColor.copy();\r\n        if (!this.costume) {\r\n            this.drawNew();\r\n            this.silentGotoXY(x, y);\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.getHue = function () {\r\n    return this.color.hsv()[0] * 100;\r\n};\r\n\r\nSpriteMorph.prototype.setHue = function (num) {\r\n    var hsv = this.color.hsv(),\r\n        x = this.xPosition(),\r\n        y = this.yPosition();\r\n\r\n    hsv[0] = Math.max(Math.min(+num || 0, 100), 0) / 100;\r\n    hsv[1] = 1; // we gotta fix this at some time\r\n    this.color.set_hsv.apply(this.color, hsv);\r\n    if (!this.costume) {\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n    this.gotoXY(x, y);\r\n};\r\n\r\nSpriteMorph.prototype.changeHue = function (delta) {\r\n    this.setHue(this.getHue() + (+delta || 0));\r\n};\r\n\r\nSpriteMorph.prototype.getBrightness = function () {\r\n    return this.color.hsv()[2] * 100;\r\n};\r\n\r\nSpriteMorph.prototype.setBrightness = function (num) {\r\n    var hsv = this.color.hsv(),\r\n        x = this.xPosition(),\r\n        y = this.yPosition();\r\n\r\n    hsv[1] = 1; // we gotta fix this at some time\r\n    hsv[2] = Math.max(Math.min(+num || 0, 100), 0) / 100;\r\n    this.color.set_hsv.apply(this.color, hsv);\r\n    if (!this.costume) {\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n    this.gotoXY(x, y);\r\n};\r\n\r\nSpriteMorph.prototype.changeBrightness = function (delta) {\r\n    this.setBrightness(this.getBrightness() + (+delta || 0));\r\n};\r\n\r\n// SpriteMorph layers\r\n\r\nSpriteMorph.prototype.comeToFront = function () {\r\n    if (this.parent) {\r\n        this.parent.add(this);\r\n        this.changed();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.goBack = function (layers) {\r\n    var layer,\r\n        newLayer = +layers,\r\n        targetLayer;\r\n\r\n    if (!this.parent) {return null; }\r\n    layer = this.parent.children.indexOf(this);\r\n    this.parent.removeChild(this);\r\n    targetLayer = Math.max(layer - newLayer, 0);\r\n    this.parent.children.splice(targetLayer, null, this);\r\n    this.parent.changed();\r\n};\r\n\r\n// SpriteMorph collision detection optimization\r\n\r\nSpriteMorph.prototype.overlappingImage = function (otherSprite) {\r\n    // overrides method from Morph because Sprites aren't nested Morphs\r\n    var oRect = this.bounds.intersect(otherSprite.bounds),\r\n        oImg = newCanvas(oRect.extent(), true),\r\n        ctx = oImg.getContext('2d');\r\n\r\n    if (oRect.width() < 1 || oRect.height() < 1) {\r\n        return newCanvas(new Point(1, 1), true);\r\n    }\r\n    ctx.drawImage(\r\n        this.image,\r\n        this.left() - oRect.left(),\r\n        this.top() - oRect.top()\r\n    );\r\n    ctx.globalCompositeOperation = 'source-in';\r\n    ctx.drawImage(\r\n        otherSprite.image,\r\n        otherSprite.left() - oRect.left(),\r\n        otherSprite.top() - oRect.top()\r\n    );\r\n    return oImg;\r\n};\r\n\r\n// SpriteMorph stamping\r\n\r\nSpriteMorph.prototype.doStamp = function () {\r\n    var stage = this.parent,\r\n        context = stage.penTrails().getContext('2d'),\r\n        isWarped = this.isWarped,\r\n        originalAlpha = context.globalAlpha;\r\n\r\n    if (isWarped) {\r\n        this.endWarp();\r\n    }\r\n    context.save();\r\n    context.scale(1 / stage.scale, 1 / stage.scale);\r\n    context.globalAlpha = this.alpha;\r\n    context.drawImage(\r\n        this.image,\r\n        (this.left() - stage.left()),\r\n        (this.top() - stage.top())\r\n    );\r\n    context.globalAlpha = originalAlpha;\r\n    context.restore();\r\n    this.changed();\r\n    if (isWarped) {\r\n        this.startWarp();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.clear = function () {\r\n    this.parent.clearPenTrails();\r\n};\r\n\r\n// SpriteMorph pen size\r\n\r\nSpriteMorph.prototype.setSize = function (size) {\r\n    // pen size\r\n    if (!isNaN(size)) {\r\n        this.size = Math.min(Math.max(+size, 0.0001), 1000);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.changeSize = function (delta) {\r\n    this.setSize(this.size + (+delta || 0));\r\n};\r\n\r\n// SpriteMorph scale\r\n\r\nSpriteMorph.prototype.getScale = function () {\r\n    // answer my scale in percent\r\n    if (this.inheritsAttribute('size')) {\r\n        return this.exemplar.getScale();\r\n    }\r\n    return this.scale * 100;\r\n};\r\n\r\nSpriteMorph.prototype.setScale = function (percentage, noShadow) {\r\n    // set my (absolute) scale in percent\r\n    var x = this.xPosition(),\r\n        y = this.yPosition(),\r\n        isWarped = this.isWarped,\r\n        realScale,\r\n        growth;\r\n\r\n    if (isWarped) {\r\n        this.endWarp();\r\n    }\r\n    realScale = (+percentage || 0) / 100;\r\n    growth = realScale / this.nestingScale;\r\n    this.nestingScale = realScale;\r\n    this.scale = Math.max(realScale, 0.01);\r\n\r\n    // apply to myself\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n    if (isWarped) {\r\n        this.startWarp();\r\n    }\r\n    this.silentGotoXY(x, y, true); // just me\r\n    this.positionTalkBubble();\r\n\r\n    // propagate to nested parts\r\n    this.parts.forEach(function (part) {\r\n        var xDist = part.xPosition() - x,\r\n            yDist = part.yPosition() - y;\r\n        part.setScale(part.scale * 100 * growth);\r\n        part.silentGotoXY(\r\n            x + (xDist * growth),\r\n            y + (yDist * growth)\r\n        );\r\n    });\r\n\r\n    // propagate to children that inherit my scale\r\n    if (!noShadow) {\r\n        this.shadowAttribute('size');\r\n    }\r\n    this.instances.forEach(function (instance) {\r\n        if (instance.cachedPropagation) {\r\n            if (instance.inheritsAttribute('size')) {\r\n                instance.setScale(percentage, true);\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.changeScale = function (delta) {\r\n    this.setScale(this.getScale() + (+delta || 0));\r\n};\r\n\r\n// Spritemorph graphic effects\r\n\r\nSpriteMorph.prototype.graphicsChanged = function () {\r\n    var myself = this;\r\n    return Object.keys(this.graphicsValues).some(\r\n        function (any) {\r\n            return myself.graphicsValues[any] < 0 ||\r\n                    myself.graphicsValues[any] > 0;\r\n        }\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.applyGraphicsEffects = function (canvas) {\r\n  // For every effect: apply transform of that effect(canvas, stored value)\r\n  // Graphic effects from Scratch are heavily based on ScratchPlugin.c\r\n\r\n    var ctx, imagedata;\r\n\r\n    function transform_fisheye(imagedata, value) {\r\n        var pixels, newImageData, newPixels, centerX, centerY,\r\n            w, h, x, y, dx, dy, r, angle, srcX, srcY, i, srcI;\r\n\r\n        w = imagedata.width;\r\n        h = imagedata.height;\r\n        pixels = imagedata.data;\r\n        newImageData = ctx.createImageData(w, h);\r\n        newPixels = newImageData.data;\r\n\r\n        centerX = w / 2;\r\n        centerY = h / 2;\r\n        value = Math.max(0, (value + 100) / 100);\r\n        for (y = 0; y < h; y++) {\r\n            for (x = 0; x < w; x++) {\r\n                dx = (x - centerX) / centerX;\r\n                dy = (y - centerY) / centerY;\r\n                r = Math.pow(Math.sqrt(dx * dx + dy * dy), value);\r\n                if (r <= 1) {\r\n                    angle = Math.atan2(dy, dx);\r\n                    srcX = Math.floor(\r\n                        centerX + (r * Math.cos(angle) * centerX)\r\n                    );\r\n                    srcY = Math.floor(\r\n                        centerY + (r * Math.sin(angle) * centerY)\r\n                    );\r\n                } else {\r\n                    srcX = x;\r\n                    srcY = y;\r\n                }\r\n                i = (y * w + x) * 4;\r\n                srcI = (srcY * w + srcX) * 4;\r\n                newPixels[i] = pixels[srcI];\r\n                newPixels[i + 1] = pixels[srcI + 1];\r\n                newPixels[i + 2] = pixels[srcI + 2];\r\n                newPixels[i + 3] = pixels[srcI + 3];\r\n            }\r\n        }\r\n        return newImageData;\r\n    }\r\n\r\n    function transform_whirl(imagedata, value) {\r\n        var pixels, newImageData, newPixels, w, h, centerX, centerY,\r\n            x, y, radius, scaleX, scaleY, whirlRadians, radiusSquared,\r\n            dx, dy, d, factor, angle, srcX, srcY, i, srcI, sina, cosa;\r\n\r\n        w = imagedata.width;\r\n        h = imagedata.height;\r\n        pixels = imagedata.data;\r\n        newImageData = ctx.createImageData(w, h);\r\n        newPixels = newImageData.data;\r\n\r\n        centerX = w / 2;\r\n        centerY = h / 2;\r\n        radius = Math.min(centerX, centerY);\r\n        if (w < h) {\r\n            scaleX = h / w;\r\n            scaleY = 1;\r\n        } else {\r\n            scaleX = 1;\r\n            scaleY = w / h;\r\n        }\r\n        whirlRadians = -radians(value);\r\n        radiusSquared = radius * radius;\r\n        for (y = 0; y < h; y++) {\r\n            for (x = 0; x < w; x++) {\r\n                dx = scaleX * (x - centerX);\r\n                dy = scaleY * (y - centerY);\r\n                d = dx * dx + dy * dy;\r\n                if (d < radiusSquared) {\r\n                    factor = 1 - (Math.sqrt(d) / radius);\r\n                    angle = whirlRadians * (factor * factor);\r\n                    sina = Math.sin(angle);\r\n                    cosa = Math.cos(angle);\r\n                    srcX = Math.floor(\r\n                        (cosa * dx - sina * dy) / scaleX + centerX\r\n                    );\r\n                    srcY = Math.floor(\r\n                        (sina * dx + cosa * dy) / scaleY + centerY\r\n                    );\r\n                } else {\r\n                    srcX = x;\r\n                    srcY = y;\r\n                }\r\n                i = (y * w + x) * 4;\r\n                srcI = (srcY * w + srcX) * 4;\r\n                newPixels[i] = pixels[srcI];\r\n                newPixels[i + 1] = pixels[srcI + 1];\r\n                newPixels[i + 2] = pixels[srcI + 2];\r\n                newPixels[i + 3] = pixels[srcI + 3];\r\n            }\r\n        }\r\n        return newImageData;\r\n    }\r\n\r\n    function transform_pixelate(imagedata, value) {\r\n        var pixels, newImageData, newPixels, w, h,\r\n            x, y, srcX, srcY, i, srcI;\r\n\r\n        w = imagedata.width;\r\n        h = imagedata.height;\r\n        pixels = imagedata.data;\r\n        newImageData = ctx.createImageData(w, h);\r\n        newPixels = newImageData.data;\r\n\r\n        value = Math.floor(Math.abs(value / 10) + 1);\r\n        for (y = 0; y < h; y++) {\r\n            for (x = 0; x < w; x++) {\r\n                srcX = Math.floor(x / value) * value;\r\n                srcY = Math.floor(y / value) * value;\r\n                i = (y * w + x) * 4;\r\n                srcI = (srcY * w + srcX) * 4;\r\n                newPixels[i] = pixels[srcI];\r\n                newPixels[i + 1] = pixels[srcI + 1];\r\n                newPixels[i + 2] = pixels[srcI + 2];\r\n                newPixels[i + 3] = pixels[srcI + 3];\r\n            }\r\n        }\r\n        return newImageData;\r\n    }\r\n\r\n    function transform_mosaic(imagedata, value) {\r\n        var pixels, i, l, newImageData, newPixels, srcI;\r\n        pixels = imagedata.data;\r\n        newImageData = ctx.createImageData(imagedata.width, imagedata.height);\r\n        newPixels = newImageData.data;\r\n\r\n        value = Math.round((Math.abs(value) + 10) / 10);\r\n        value = Math.max(\r\n            0,\r\n            Math.min(value, Math.min(imagedata.width, imagedata.height))\r\n        );\r\n        for (i = 0, l = pixels.length; i < l; i += 4) {\r\n            srcI = i * value % l;\r\n            newPixels[i] = pixels[srcI];\r\n            newPixels[i + 1] = pixels[srcI + 1];\r\n            newPixels[i + 2] = pixels[srcI + 2];\r\n            newPixels[i + 3] = pixels[srcI + 3];\r\n        }\r\n        return newImageData;\r\n    }\r\n\r\n    function transform_duplicate(imagedata, value) {\r\n        var pixels, i;\r\n        pixels = imagedata.data;\r\n        for (i = 0; i < pixels.length; i += 4) {\r\n            pixels[i] = pixels[i * value];\r\n            pixels[i + 1] = pixels[i * value + 1];\r\n            pixels[i + 2] = pixels[i * value + 2];\r\n            pixels[i + 3] = pixels[i * value + 3];\r\n        }\r\n        return imagedata;\r\n    }\r\n\r\n    function transform_HSV(\r\n            imagedata,\r\n            hueShift,\r\n            saturationShift,\r\n            brightnessShift\r\n    ) {\r\n        var pixels, index, l, r, g, b, max, min, span,\r\n            h, s, v, i, f, p, q, t, newR, newG, newB;\r\n        pixels = imagedata.data;\r\n        for (index = 0, l = pixels.length; index < l; index += 4) {\r\n            r = pixels[index];\r\n            g = pixels[index + 1];\r\n            b = pixels[index + 2];\r\n\r\n            max = Math.max(r, g, b);\r\n            min = Math.min(r, g, b);\r\n            span = max - min;\r\n            if (span === 0) {\r\n                h = s = 0;\r\n            } else {\r\n                if (max === r) {\r\n                    h = (60 * (g - b)) / span;\r\n                } else if (max === g) {\r\n                    h = 120 + ((60 * (b - r)) / span);\r\n                } else if (max === b) {\r\n                    h = 240 + ((60 * (r - g)) / span);\r\n                }\r\n                s = (max - min) / max;\r\n            }\r\n            if (h < 0) {\r\n                h += 360;\r\n            }\r\n            v = max / 255;\r\n\r\n            h = (h + hueShift * 360 / 200) % 360;\r\n            s = Math.max(0, Math.min(s + saturationShift / 100, 1));\r\n            v = Math.max(0, Math.min(v + brightnessShift / 100, 1));\r\n\r\n            i = Math.floor(h / 60);\r\n            f = (h / 60) - i;\r\n            p = v * (1 - s);\r\n            q = v * (1 - (s * f));\r\n            t = v * (1 - (s * (1 - f)));\r\n\r\n            if (i === 0 || i === 6) {\r\n                newR = v;\r\n                newG = t;\r\n                newB = p;\r\n            } else if (i === 1) {\r\n                newR = q;\r\n                newG = v;\r\n                newB = p;\r\n            } else if (i === 2) {\r\n                newR = p;\r\n                newG = v;\r\n                newB = t;\r\n            } else if (i === 3) {\r\n                newR = p;\r\n                newG = q;\r\n                newB = v;\r\n            } else if (i === 4) {\r\n                newR = t;\r\n                newG = p;\r\n                newB = v;\r\n            } else if (i === 5) {\r\n                newR = v;\r\n                newG = p;\r\n                newB = q;\r\n            }\r\n\r\n            pixels[index] = newR * 255;\r\n            pixels[index + 1] = newG * 255;\r\n            pixels[index + 2] = newB * 255;\r\n        }\r\n        return imagedata;\r\n    }\r\n\r\n    function transform_negative (imagedata, value) {\r\n        var pixels, i, l, rcom, gcom, bcom;\r\n        pixels = imagedata.data;\r\n        for (i = 0, l = pixels.length; i < l; i += 4) {\r\n            rcom = 255 - pixels[i];\r\n            gcom = 255 - pixels[i + 1];\r\n            bcom = 255 - pixels[i + 2];\r\n\r\n            if (pixels[i] < rcom) { //compare to the complement\r\n                pixels[i] += value;\r\n            } else if (pixels[i] > rcom) {\r\n                pixels[i] -= value;\r\n            }\r\n            if (pixels[i + 1] < gcom) {\r\n                pixels[i + 1] += value;\r\n            } else if (pixels[i + 1] > gcom) {\r\n                pixels[i + 1] -= value;\r\n            }\r\n            if (pixels[i + 2] < bcom) {\r\n                pixels[i + 2] += value;\r\n            } else if (pixels[i + 2] > bcom) {\r\n                pixels[i + 2] -= value;\r\n            }\r\n        }\r\n        return imagedata;\r\n    }\r\n\r\n    function transform_comic (imagedata, value) {\r\n        var pixels, i, l;\r\n        pixels = imagedata.data;\r\n        for (i = 0, l = pixels.length; i < l; i += 4) {\r\n            pixels[i] += Math.sin(i * value) * 127 + 128;\r\n            pixels[i + 1] += Math.sin(i * value) * 127 + 128;\r\n            pixels[i + 2] += Math.sin(i * value) * 127 + 128;\r\n        }\r\n        return imagedata;\r\n    }\r\n\r\n    function transform_confetti (imagedata, value) {\r\n        var pixels, i, l;\r\n        pixels = imagedata.data;\r\n        for (i = 0, l = pixels.length; i < l; i += 1) {\r\n            pixels[i] = Math.sin(value * pixels[i]) * 127 + pixels[i];\r\n        }\r\n        return imagedata;\r\n    }\r\n\r\n    if (this.graphicsChanged()) {\r\n        ctx = canvas.getContext(\"2d\");\r\n        imagedata = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n\r\n        if (this.graphicsValues.fisheye) {\r\n            imagedata = transform_fisheye(\r\n                imagedata,\r\n                this.graphicsValues.fisheye\r\n            );\r\n        }\r\n        if (this.graphicsValues.whirl) {\r\n            imagedata = transform_whirl(\r\n                imagedata,\r\n                this.graphicsValues.whirl\r\n            );\r\n        }\r\n        if (this.graphicsValues.pixelate) {\r\n            imagedata = transform_pixelate(\r\n                imagedata,\r\n                this.graphicsValues.pixelate\r\n            );\r\n        }\r\n        if (this.graphicsValues.mosaic) {\r\n            imagedata = transform_mosaic(\r\n                imagedata,\r\n                this.graphicsValues.mosaic\r\n            );\r\n        }\r\n        if (this.graphicsValues.duplicate) {\r\n            imagedata = transform_duplicate(\r\n                imagedata,\r\n                this.graphicsValues.duplicate\r\n            );\r\n        }\r\n        if (this.graphicsValues.color ||\r\n                this.graphicsValues.saturation ||\r\n                this.graphicsValues.brightness) {\r\n            imagedata = transform_HSV(\r\n                imagedata,\r\n                this.graphicsValues.color,\r\n                this.graphicsValues.saturation,\r\n                this.graphicsValues.brightness\r\n            );\r\n        }\r\n        if (this.graphicsValues.negative) {\r\n            imagedata = transform_negative(\r\n                imagedata,\r\n                this.graphicsValues.negative\r\n            );\r\n        }\r\n        if (this.graphicsValues.comic) {\r\n            imagedata = transform_comic(\r\n                imagedata,\r\n                this.graphicsValues.comic\r\n            );\r\n        }\r\n        if (this.graphicsValues.confetti) {\r\n            imagedata = transform_confetti(\r\n                imagedata,\r\n                this.graphicsValues.confetti\r\n            );\r\n        }\r\n\r\n        ctx.putImageData(imagedata, 0, 0);\r\n    }\r\n\r\n    return canvas;\r\n};\r\n\r\nSpriteMorph.prototype.setEffect = function (effect, value) {\r\n    var eff = effect instanceof Array ? effect[0] : null;\r\n    if (eff === 'ghost') {\r\n        this.alpha = 1 - Math.min(Math.max(+value || 0, 0), 100) / 100;\r\n    } else {\r\n        this.graphicsValues[eff] = +value;\r\n    }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nSpriteMorph.prototype.getGhostEffect = function () {\r\n    return (1 - this.alpha) * 100;\r\n};\r\n\r\nSpriteMorph.prototype.changeEffect = function (effect, value) {\r\n    var eff = effect instanceof Array ? effect[0] : null;\r\n    if (eff === 'ghost') {\r\n        this.setEffect(effect, this.getGhostEffect() + (+value || 0));\r\n    } else {\r\n        this.setEffect(effect, +this.graphicsValues[eff] + (+value));\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.clearEffects = function () {\r\n    var effect;\r\n    for (effect in this.graphicsValues) {\r\n        if (this.graphicsValues.hasOwnProperty(effect)) {\r\n            this.setEffect([effect], 0);\r\n        }\r\n    }\r\n    this.setEffect(['ghost'], 0);\r\n};\r\n\r\n// SpriteMorph talk bubble\r\n\r\nSpriteMorph.prototype.stopTalking = function () {\r\n    var bubble = this.talkBubble();\r\n    if (bubble) {bubble.destroy(); }\r\n};\r\n\r\nSpriteMorph.prototype.doThink = function (data) {\r\n    this.bubble(data, true);\r\n};\r\n\r\nSpriteMorph.prototype.bubble = function (data, isThought, isQuestion) {\r\n    var bubble,\r\n        stage = this.parentThatIsA(StageMorph);\r\n\r\n    this.stopTalking();\r\n    if (data === '' || isNil(data)) {return; }\r\n    bubble = new SpriteBubbleMorph(\r\n        data,\r\n        stage,\r\n        isThought,\r\n        isQuestion\r\n    );\r\n    this.add(bubble);\r\n    this.positionTalkBubble();\r\n};\r\n\r\nSpriteMorph.prototype.talkBubble = function () {\r\n    return detect(\r\n        this.children,\r\n        function (morph) {return morph instanceof SpeechBubbleMorph; }\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.positionTalkBubble = function () {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        stageScale = stage ? stage.scale : 1,\r\n        bubble = this.talkBubble(),\r\n        middle = this.center().y;\r\n    if (!bubble) {return null; }\r\n    bubble.show();\r\n    if (!bubble.isPointingRight) {\r\n        bubble.isPointingRight = true;\r\n        bubble.drawNew();\r\n        bubble.changed();\r\n    }\r\n    bubble.setLeft(this.right());\r\n    bubble.setBottom(this.top());\r\n    while (!this.isTouching(bubble) && bubble.bottom() < middle) {\r\n        bubble.silentMoveBy(new Point(-1, 1).scaleBy(stageScale));\r\n    }\r\n    if (!stage) {return null; }\r\n    if (bubble.right() > stage.right()) {\r\n        bubble.isPointingRight = false;\r\n        bubble.drawNew();\r\n        bubble.setRight(this.center().x);\r\n    }\r\n    bubble.keepWithin(stage);\r\n    bubble.changed();\r\n};\r\n\r\n// dragging and dropping adjustments b/c of talk bubbles and parts\r\n\r\nSpriteMorph.prototype.prepareToBeGrabbed = function (hand) {\r\n    this.removeShadow();\r\n    this.recordLayers();\r\n    this.shadowAttribute('x position');\r\n    this.shadowAttribute('y position');\r\n    if (!this.bounds.containsPoint(hand.position()) &&\r\n            this.isCorrectingOutsideDrag()) {\r\n        this.setCenter(hand.position());\r\n    }\r\n    this.addShadow();\r\n};\r\n\r\nSpriteMorph.prototype.isCorrectingOutsideDrag = function () {\r\n    // make sure I don't \"trail behind\" the hand when dragged\r\n    // override for morphs that you want to be dragged outside\r\n    // their full bounds\r\n    return !this.parts.length;\r\n};\r\n\r\nSpriteMorph.prototype.justDropped = function () {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        myself = this;\r\n    if (stage) {\r\n        stage.enableCustomHatBlocks = true;\r\n    }\r\n    if (this.exemplar) {\r\n        this.inheritedAttributes.forEach(function (att) {\r\n            if (contains(['direction', 'size', 'costume #'], att)) {\r\n                // only refresh certain propagated attributes\r\n                myself.refreshInheritedAttribute(att);\r\n            }\r\n        });\r\n    }\r\n    this.restoreLayers();\r\n    this.positionTalkBubble();\r\n    this.receiveUserInteraction('dropped');\r\n   \r\n};\r\n\r\n// SpriteMorph drawing:\r\n\r\nSpriteMorph.prototype.drawLine = function (start, dest) {\r\n    var stagePos = this.parent.bounds.origin,\r\n        stageScale = this.parent.scale,\r\n        context = this.parent.penTrails().getContext('2d'),\r\n        from = start.subtract(stagePos).divideBy(stageScale),\r\n        to = dest.subtract(stagePos).divideBy(stageScale),\r\n        damagedFrom = from.multiplyBy(stageScale).add(stagePos),\r\n        damagedTo = to.multiplyBy(stageScale).add(stagePos),\r\n        damaged = damagedFrom.rectangle(damagedTo).expandBy(\r\n            Math.max(this.size * stageScale / 2, 1)\r\n        ).intersect(this.parent.visibleBounds()).spread();\r\n\r\n    if (this.isDown) {\r\n        context.lineWidth = this.size;\r\n        context.strokeStyle = this.color.toString();\r\n        if (this.useFlatLineEnds) {\r\n            context.lineCap = 'butt';\r\n            context.lineJoin = 'miter';\r\n        } else {\r\n            context.lineCap = 'round';\r\n            context.lineJoin = 'round';\r\n        }\r\n        context.beginPath();\r\n        context.moveTo(from.x, from.y);\r\n        context.lineTo(to.x, to.y);\r\n        context.stroke();\r\n        if (this.isWarped === false) {\r\n            this.world().broken.push(damaged);\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.floodFill = function () {\r\n    if (!this.parent.bounds.containsPoint(this.rotationCenter())) {\r\n        return;\r\n    }\r\n    if (this.color.a > 1) {\r\n        // fix a legacy bug in Morphic color detection\r\n        this.color.a = this.color.a / 255;\r\n    }\r\n    var layer = normalizeCanvas(this.parent.penTrails()),\r\n        width = layer.width,\r\n        height = layer.height,\r\n        ctx = layer.getContext('2d'),\r\n        img = ctx.getImageData(0, 0, width, height),\r\n        dta = img.data,\r\n        stack = [\r\n            Math.round((height / 2) - this.yPosition()) * width +\r\n            Math.round(this.xPosition() + (width / 2))\r\n        ],\r\n        current,\r\n        src;\r\n\r\n    function read(p) {\r\n        var d = p * 4;\r\n        return [dta[d], dta[d + 1], dta[d + 2], dta[d + 3]];\r\n    }\r\n\r\n    function check(p) {\r\n        return p[0] === src[0] &&\r\n            p[1] === src[1] &&\r\n            p[2] === src[2] &&\r\n            p[3] === src[3];\r\n    }\r\n\r\n    src = read(stack[0]);\r\n    if (src[0] === Math.round(this.color.r) &&\r\n            src[1] === Math.round(this.color.g) &&\r\n            src[2] === Math.round(this.color.b) &&\r\n            src[3] === Math.round(this.color.a * 255)) {\r\n        return;\r\n    }\r\n    while (stack.length > 0) {\r\n        current = stack.pop();\r\n        if (check(read(current))) {\r\n            if (current % width > 1) {\r\n                stack.push(current + 1);\r\n                stack.push(current - 1);\r\n            }\r\n            if (current > 0 && current < height * width) {\r\n                stack.push(current + width);\r\n                stack.push(current - width);\r\n            }\r\n        }\r\n        dta[current * 4] = Math.round(this.color.r);\r\n        dta[current * 4 + 1] = Math.round(this.color.g);\r\n        dta[current * 4 + 2] = Math.round(this.color.b);\r\n        dta[current * 4 + 3] = Math.round(this.color.a * 255);\r\n    }\r\n    ctx.putImageData(img, 0, 0);\r\n    this.parent.changed();\r\n};\r\n\r\n// SpriteMorph pen trails as costume\r\n\r\nSpriteMorph.prototype.reportPenTrailsAsCostume = function () {\r\n    var cst = new Costume(\r\n        this.parentThatIsA(StageMorph).trailsCanvas,\r\n        this.newCostumeName(localize('Costume'))\r\n    );\r\n    cst.shrinkWrap();\r\n    return cst;\r\n};\r\n\r\n// SpriteMorph motion - adjustments due to nesting\r\n\r\nSpriteMorph.prototype.moveBy = function (delta, justMe) {\r\n    // override the inherited default to make sure my parts follow\r\n    // unless it's justMe (a correction)\r\n    var start = this.isDown && !justMe && this.parent ?\r\n            this.rotationCenter() : null;\r\n    SpriteMorph.uber.moveBy.call(this, delta);\r\n    if (start) {\r\n        this.drawLine(start, this.rotationCenter());\r\n    }\r\n    if (!justMe) {\r\n        this.parts.forEach(function (part) {\r\n            part.moveBy(delta);\r\n        });\r\n        this.instances.forEach(function (instance) {\r\n            if (instance.cachedPropagation) {\r\n                var inheritsX = instance.inheritsAttribute('x position'),\r\n                    inheritsY = instance.inheritsAttribute('y position');\r\n                if (inheritsX && inheritsY) {\r\n                    instance.moveBy(delta);\r\n                } else if (inheritsX) {\r\n                    instance.moveBy(new Point(delta.x, 0));\r\n                } else if (inheritsY) {\r\n                    instance.moveBy(new Point(0, delta.y));\r\n                }\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.silentMoveBy = function (delta, justMe) {\r\n    SpriteMorph.uber.silentMoveBy.call(this, delta);\r\n    if (!justMe && this.parent instanceof HandMorph) {\r\n        this.parts.forEach(function (part) {\r\n            part.moveBy(delta);\r\n        });\r\n        this.instances.forEach(function (instance) {\r\n            if (instance.cachedPropagation) {\r\n                var inheritsX = instance.inheritsAttribute('x position'),\r\n                    inheritsY = instance.inheritsAttribute('y position');\r\n                if (inheritsX && inheritsY) {\r\n                    instance.moveBy(delta);\r\n                } else if (inheritsX) {\r\n                    instance.moveBy(new Point(delta.x, 0));\r\n                } else if (inheritsY) {\r\n                    instance.moveBy(new Point(0, delta.y));\r\n                }\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.rootForGrab = function () {\r\n    if (this.anchor) {\r\n        return this.anchor.rootForGrab();\r\n    }\r\n    return SpriteMorph.uber.rootForGrab.call(this);\r\n};\r\n\r\nSpriteMorph.prototype.setCenter = function (aPoint, justMe) {\r\n    // override the inherited default to make sure my parts follow\r\n    // unless it's justMe\r\n    var delta = aPoint.subtract(this.center());\r\n    this.moveBy(delta, justMe);\r\n};\r\n\r\nSpriteMorph.prototype.nestingBounds = function () {\r\n    // same as fullBounds(), except that it uses \"parts\" instead of children\r\n    // and special cases the costume-less \"arrow\" shape's bounding box\r\n    var result = this.bounds;\r\n    if (!this.costume && this.penBounds) {\r\n        result = this.penBounds.translateBy(this.position());\r\n    }\r\n    this.parts.forEach(function (part) {\r\n        if (part.isVisible) {\r\n            result = result.merge(part.nestingBounds());\r\n        }\r\n    });\r\n    return result;\r\n};\r\n\r\n// SpriteMorph motion primitives\r\n\r\nSpriteMorph.prototype.setPosition = function (aPoint, justMe) {\r\n    // override the inherited default to make sure my parts follow\r\n    // unless it's justMe\r\n    var delta = aPoint.subtract(this.topLeft());\r\n    if ((delta.x !== 0) || (delta.y !== 0)) {\r\n        this.moveBy(delta, justMe);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.forward = function (steps) {\r\n    var dest,\r\n        dist = steps * this.parent.scale || 0;\r\n\r\n    if (dist >= 0) {\r\n        dest = this.position().distanceAngle(dist, this.heading);\r\n    } else {\r\n        dest = this.position().distanceAngle(\r\n            Math.abs(dist),\r\n            (this.heading - 180)\r\n        );\r\n    }\r\n\r\n    this.shadowAttribute('x position');\r\n    this.shadowAttribute('y position');\r\n\r\n    this.setPosition(dest);\r\n    this.positionTalkBubble();\r\n};\r\n\r\nSpriteMorph.prototype.setHeading = function (degrees, noShadow) {\r\n    var x = this.xPosition(),\r\n        y = this.yPosition(),\r\n        dir = !isFinite(degrees) ? 0 : +degrees,\r\n        turn = dir - this.heading;\r\n\r\n    // apply to myself\r\n    if (this.rotationStyle) { // optimization, only redraw if rotatable\r\n        this.changed();\r\n        SpriteMorph.uber.setHeading.call(this, dir);\r\n        this.silentGotoXY(x, y, true); // just me\r\n        this.positionTalkBubble();\r\n    } else {\r\n        this.heading = ((+degrees % 360) + 360) % 360;\r\n    }\r\n\r\n    // propagate to my parts\r\n    this.parts.forEach(function (part) {\r\n        var pos = new Point(part.xPosition(), part.yPosition()),\r\n            trg = pos.rotateBy(radians(turn), new Point(x, y));\r\n        if (part.rotatesWithAnchor) {\r\n            part.turn(turn);\r\n        }\r\n        part.gotoXY(trg.x, trg.y);\r\n    });\r\n\r\n    // propagate to children that inherit my direction\r\n    if (!noShadow) {\r\n        this.shadowAttribute('direction');\r\n    }\r\n    this.instances.forEach(function (instance) {\r\n        if (instance.cachedPropagation) {\r\n            if (instance.inheritsAttribute('direction')) {\r\n                instance.setHeading(degrees, true);\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.faceToXY = function (x, y) {\r\n    var deltaX = (x - this.xPosition()) * this.parent.scale,\r\n        deltaY = (y - this.yPosition()) * this.parent.scale,\r\n        angle = Math.abs(deltaX) < 0.001 ? (deltaY < 0 ? 90 : 270)\r\n                : Math.round(\r\n                (deltaX >= 0 ? 0 : 180)\r\n                    - (Math.atan(deltaY / deltaX) * 57.2957795131)\r\n            );\r\n    this.setHeading(angle + 90);\r\n};\r\n\r\nSpriteMorph.prototype.turn = function (degrees) {\r\n    this.setHeading(this.heading + (+degrees || 0));\r\n};\r\n\r\nSpriteMorph.prototype.turnLeft = function (degrees) {\r\n    this.setHeading(this.heading - (+degrees || 0));\r\n};\r\n\r\nSpriteMorph.prototype.xPosition = function () {\r\n    if (this.inheritsAttribute('x position')) {\r\n        return this.exemplar.xPosition();\r\n    }\r\n\r\n    var stage = this.parentThatIsA(StageMorph);\r\n\r\n    if (!stage && this.parent.grabOrigin) { // I'm currently being dragged\r\n        stage = this.parent.grabOrigin.origin;\r\n    }\r\n    if (stage) {\r\n        return (this.rotationCenter().x - stage.center().x) / stage.scale;\r\n    }\r\n    return this.rotationCenter().x;\r\n};\r\n\r\nSpriteMorph.prototype.yPosition = function () {\r\n    if (this.inheritsAttribute('y position')) {\r\n        return this.exemplar.yPosition();\r\n    }\r\n\r\n    var stage = this.parentThatIsA(StageMorph);\r\n\r\n    if (!stage && this.parent.grabOrigin) { // I'm currently being dragged\r\n        stage = this.parent.grabOrigin.origin;\r\n    }\r\n    if (stage) {\r\n        return (stage.center().y - this.rotationCenter().y) / stage.scale;\r\n    }\r\n    return this.rotationCenter().y;\r\n};\r\n\r\nSpriteMorph.prototype.direction = function () {\r\n    if (this.inheritsAttribute('direction')) {\r\n        return this.exemplar.direction();\r\n    }\r\n    return this.heading;\r\n};\r\n\r\nSpriteMorph.prototype.penSize = function () {\r\n    return this.size;\r\n};\r\n\r\nSpriteMorph.prototype.gotoXY = function (x, y, justMe, noShadow) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        newX,\r\n        newY,\r\n        dest;\r\n\r\n    if (!stage) {return; }\r\n    if (!noShadow) {\r\n        this.shadowAttribute('x position');\r\n        this.shadowAttribute('y position');\r\n    }\r\n    x = !isFinite(+x) ? 0 : +x;\r\n    y = !isFinite(+y) ? 0 : +y;\r\n    newX = stage.center().x + x * stage.scale;\r\n    newY = stage.center().y - y * stage.scale;\r\n    if (this.costume) {\r\n        dest = new Point(newX, newY).subtract(this.rotationOffset);\r\n    } else {\r\n        dest = new Point(newX, newY).subtract(this.extent().divideBy(2));\r\n    }\r\n    this.setPosition(dest, justMe);\r\n    this.positionTalkBubble();\r\n};\r\n\r\nSpriteMorph.prototype.silentGotoXY = function (x, y, justMe) {\r\n    // move without drawing\r\n    // don't shadow coordinate attributes\r\n    var penState = this.isDown;\r\n    this.isDown = false;\r\n    this.gotoXY(x, y, justMe, true); // don't shadow coordinates\r\n    this.isDown = penState;\r\n};\r\n\r\nSpriteMorph.prototype.setXPosition = function (num) {\r\n    this.shadowAttribute('x position');\r\n    this.gotoXY(+num || 0, this.yPosition(), false, true);\r\n};\r\n\r\nSpriteMorph.prototype.changeXPosition = function (delta) {\r\n    this.setXPosition(this.xPosition() + (+delta || 0));\r\n};\r\n\r\nSpriteMorph.prototype.setYPosition = function (num) {\r\n    this.shadowAttribute('y position');\r\n    this.gotoXY(this.xPosition(), +num || 0, false, true);\r\n};\r\n\r\nSpriteMorph.prototype.changeYPosition = function (delta) {\r\n    this.setYPosition(this.yPosition() + (+delta || 0));\r\n};\r\n\r\nSpriteMorph.prototype.glide = function (\r\n    duration,\r\n    endX,\r\n    endY,\r\n    elapsed,\r\n    startPoint\r\n) {\r\n    var fraction, endPoint, rPos;\r\n    endPoint = new Point(endX, endY);\r\n    fraction = Math.max(Math.min(elapsed / duration, 1), 0);\r\n    rPos = startPoint.add(\r\n        endPoint.subtract(startPoint).multiplyBy(fraction)\r\n    );\r\n    this.gotoXY(rPos.x, rPos.y);\r\n};\r\n\r\nSpriteMorph.prototype.bounceOffEdge = function () {\r\n    // taking nested parts into account\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        fb = this.nestingBounds(),\r\n        dirX,\r\n        dirY;\r\n\r\n    if (!stage) {return null; }\r\n    if (stage.bounds.containsRectangle(fb)) {return null; }\r\n\r\n    dirX = Math.cos(radians(this.heading - 90));\r\n    dirY = -(Math.sin(radians(this.heading - 90)));\r\n\r\n    if (fb.left() < stage.left()) {\r\n        dirX = Math.abs(dirX);\r\n    }\r\n    if (fb.right() > stage.right()) {\r\n        dirX = -(Math.abs(dirX));\r\n    }\r\n    if (fb.top() < stage.top()) {\r\n        dirY = -(Math.abs(dirY));\r\n    }\r\n    if (fb.bottom() > stage.bottom()) {\r\n        dirY = Math.abs(dirY);\r\n    }\r\n\r\n    this.shadowAttribute('x position');\r\n    this.shadowAttribute('y position');\r\n    this.shadowAttribute('direction');\r\n\r\n    this.setHeading(degrees(Math.atan2(-dirY, dirX)) + 90);\r\n    this.setPosition(this.position().add(\r\n        fb.amountToTranslateWithin(stage.bounds)\r\n    ));\r\n    this.positionTalkBubble();\r\n};\r\n\r\n// SpriteMorph rotation center / fixation point manipulation\r\n\r\nSpriteMorph.prototype.setRotationX = function (absoluteX) {\r\n  this.setRotationCenter(new Point(absoluteX, this.yPosition()));\r\n};\r\n\r\nSpriteMorph.prototype.setRotationY = function (absoluteY) {\r\n  this.setRotationCenter(new Point(this.xPosition(), absoluteY));\r\n};\r\n\r\nSpriteMorph.prototype.setRotationCenter = function (absoluteCoordinate) {\r\n    var delta, normal;\r\n    if (!this.costume) {\r\n        throw new Error('setting the rotation center requires a costume');\r\n    }\r\n    delta = absoluteCoordinate.subtract(\r\n        new Point(this.xPosition(), this.yPosition())\r\n    ).divideBy(this.scale).rotateBy(radians(90 - this.heading));\r\n    normal = this.costume.rotationCenter.add(new Point(delta.x, -delta.y));\r\n    this.costume.rotationCenter = normal;\r\n    this.drawNew();\r\n};\r\n\r\nSpriteMorph.prototype.moveRotationCenter = function () {\r\n    // make this a method of Snap >> SpriteMorph\r\n    this.world().activeHandle = new HandleMorph(\r\n        this,\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        'movePivot'\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.setPivot = function (worldCoordinate) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        cntr;\r\n    if (stage) {\r\n        cntr = stage.center();\r\n        this.setRotationCenter(\r\n            new Point(\r\n                (worldCoordinate.x - cntr.x) / stage.scale,\r\n                (cntr.y - worldCoordinate.y) / stage.scale\r\n            )\r\n        );\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.xCenter = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n\r\n    if (!stage && this.parent.grabOrigin) { // I'm currently being dragged\r\n        stage = this.parent.grabOrigin.origin;\r\n    }\r\n    if (stage) {\r\n        return (this.center().x - stage.center().x) / stage.scale;\r\n    }\r\n    return this.center().x;\r\n};\r\n\r\nSpriteMorph.prototype.yCenter = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n\r\n    if (!stage && this.parent.grabOrigin) { // I'm currently being dragged\r\n        stage = this.parent.grabOrigin.origin;\r\n    }\r\n    if (stage) {\r\n        return (stage.center().y - this.center().y) / stage.scale;\r\n    }\r\n    return this.center().y;\r\n};\r\n\r\n// SpriteMorph message broadcasting\r\n\r\nSpriteMorph.prototype.allMessageNames = function () {\r\n    var msgs = [],\r\n        all = this.scripts.children.slice();\r\n    this.customBlocks.forEach(function (def) {\r\n        if (def.body) {\r\n            all.push(def.body.expression);\r\n        }\r\n        def.scripts.forEach(function (scr) {\r\n            all.push(scr);\r\n        });\r\n    });\r\n    if (this.globalBlocks) {\r\n        this.globalBlocks.forEach(function (def) {\r\n            if (def.body) {\r\n                all.push(def.body.expression);\r\n            }\r\n            def.scripts.forEach(function (scr) {\r\n                all.push(scr);\r\n            });\r\n        });\r\n    }\r\n    all.forEach(function (script) {\r\n        script.allChildren().forEach(function (morph) {\r\n            var txt;\r\n            if (morph.selector && contains(\r\n                ['receiveMessage', 'doBroadcast', 'doBroadcastAndWait'],\r\n                morph.selector\r\n            )) {\r\n                txt = morph.inputs()[0].evaluate();\r\n                if (isString(txt) && txt !== '') {\r\n                    if (!contains(msgs, txt)) {\r\n                        msgs.push(txt);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    });\r\n    return msgs;\r\n};\r\n\r\nSpriteMorph.prototype.allHatBlocksFor = function (message) {\r\n    if (typeof message === 'number') {message = message.toString(); }\r\n    return this.scripts.children.filter(function (morph) {\r\n        var event;\r\n        if (morph.selector) {\r\n            if (morph.selector === 'receiveMessage') {\r\n                event = morph.inputs()[0].evaluate();\r\n                return event === message\r\n                    || (event instanceof Array\r\n                        && message !== '__shout__go__'\r\n                        && message !== '__clone__init__');\r\n            }\r\n            if (morph.selector === 'receiveGo') {\r\n                return message === '__shout__go__';\r\n            }\r\n            if (morph.selector === 'receiveOnClone') {\r\n                return message === '__clone__init__';\r\n            }\r\n        }\r\n        return false;\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.allHatBlocksForKey = function (key) {\r\n    return this.scripts.children.filter(function (morph) {\r\n        if (morph.selector) {\r\n            if (morph.selector === 'receiveKey') {\r\n                var evt = morph.inputs()[0].evaluate()[0];\r\n                return evt === key || evt === 'any key';\r\n            }\r\n        }\r\n        return false;\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.allHatBlocksForInteraction = function (interaction) {\r\n    return this.scripts.children.filter(function (morph) {\r\n        if (morph.selector) {\r\n            if (morph.selector === 'receiveInteraction') {\r\n                return morph.inputs()[0].evaluate()[0] === interaction;\r\n            }\r\n        }\r\n        return false;\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.allGenericHatBlocks = function () {\r\n    return this.scripts.children.filter(function (morph) {\r\n        if (morph.selector) {\r\n            return morph.selector === 'receiveCondition';\r\n        }\r\n        return false;\r\n    });\r\n};\r\n\r\n// SpriteMorph events\r\n\r\nSpriteMorph.prototype.mouseClickLeft = function () {\r\n    return this.receiveUserInteraction('clicked');\r\n};\r\n\r\nSpriteMorph.prototype.mouseEnter = function () {\r\n    return this.receiveUserInteraction('mouse-entered');\r\n};\r\n\r\nSpriteMorph.prototype.mouseDownLeft = function () {\r\n    return this.receiveUserInteraction('pressed');\r\n};\r\n\r\nSpriteMorph.prototype.receiveUserInteraction = function (interaction) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        procs = [],\r\n        myself = this,\r\n        hats;\r\n\r\n    if (!stage) {return; } // currently dragged\r\n    hats = this.allHatBlocksForInteraction(interaction);\r\n    hats.forEach(function (block) {\r\n        procs.push(stage.threads.startProcess(\r\n            block,\r\n            myself,\r\n            stage.isThreadSafe\r\n        ));\r\n    });\r\n    return procs;\r\n};\r\n\r\nSpriteMorph.prototype.mouseDoubleClick = function () {\r\n    if (this.isTemporary) {return; }\r\n    this.edit();\r\n};\r\n\r\n// SpriteMorph timer\r\n\r\nSpriteMorph.prototype.getTimer = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.getTimer();\r\n    }\r\n    return 0;\r\n};\r\n\r\n// SpriteMorph tempo\r\n\r\nSpriteMorph.prototype.getTempo = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.getTempo();\r\n    }\r\n    return 0;\r\n};\r\n\r\n// SpriteMorph last message\r\n\r\nSpriteMorph.prototype.getLastMessage = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.getLastMessage();\r\n    }\r\n    return '';\r\n};\r\n\r\n// SpriteMorph user prompting\r\n\r\nSpriteMorph.prototype.getLastAnswer = function () {\r\n    return this.parentThatIsA(StageMorph).lastAnswer;\r\n};\r\n\r\n// SpriteMorph mouse coordinates\r\n\r\nSpriteMorph.prototype.reportMouseX = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.reportMouseX();\r\n    }\r\n    return 0;\r\n};\r\n\r\nSpriteMorph.prototype.reportMouseY = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.reportMouseY();\r\n    }\r\n    return 0;\r\n};\r\n\r\n// SpriteMorph thread count (for debugging)\r\n\r\nSpriteMorph.prototype.reportThreadCount = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (stage) {\r\n        return stage.threads.processes.length;\r\n    }\r\n    return 0;\r\n};\r\n\r\n// SpriteMorph variable refactoring\r\n\r\nSpriteMorph.prototype.refactorVariableInstances = function (\r\n    oldName,\r\n    newName,\r\n    isGlobal\r\n) {\r\n    if (isGlobal && this.hasSpriteVariable(oldName)) {\r\n        return;\r\n    }\r\n\r\n    this.scripts.children.forEach(function (child) {\r\n        if (child instanceof BlockMorph) {\r\n            child.refactorVarInStack(oldName, newName);\r\n        }\r\n    });\r\n\r\n};\r\n\r\n// SpriteMorph variable watchers (for palette checkbox toggling)\r\n\r\nSpriteMorph.prototype.findVariableWatcher = function (varName) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        globals = this.globalVariables(),\r\n        myself = this;\r\n    if (stage === null) {\r\n        return null;\r\n    }\r\n    return detect(\r\n        stage.children,\r\n        function (morph) {\r\n            return morph instanceof WatcherMorph\r\n                    && (morph.target === myself.variables\r\n                            || morph.target === globals)\r\n                    && morph.getter === varName;\r\n        }\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.toggleVariableWatcher = function (varName, isGlobal) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        globals = this.globalVariables(),\r\n        watcher,\r\n        others;\r\n    if (stage === null) {\r\n        return null;\r\n    }\r\n    watcher = this.findVariableWatcher(varName);\r\n    if (watcher !== null) {\r\n        if (watcher.isVisible) {\r\n            watcher.hide();\r\n        } else {\r\n            watcher.show();\r\n            watcher.fixLayout(); // re-hide hidden parts\r\n            watcher.keepWithin(stage);\r\n        }\r\n        return;\r\n    }\r\n\r\n    // if no watcher exists, create a new one\r\n    if (isNil(isGlobal)) {\r\n        isGlobal = contains(globals.names(), varName);\r\n    }\r\n    watcher = new WatcherMorph(\r\n        varName,\r\n        this.blockColor.variables,\r\n        isGlobal ? globals : this.variables,\r\n        varName\r\n    );\r\n    watcher.setPosition(stage.position().add(10));\r\n    others = stage.watchers(watcher.left());\r\n    if (others.length > 0) {\r\n        watcher.setTop(others[others.length - 1].bottom());\r\n    }\r\n    stage.add(watcher);\r\n    watcher.fixLayout();\r\n    watcher.keepWithin(stage);\r\n    return watcher;\r\n};\r\n\r\nSpriteMorph.prototype.showingVariableWatcher = function (varName) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        watcher;\r\n    if (stage === null) {\r\n        return false;\r\n    }\r\n    watcher = this.findVariableWatcher(varName);\r\n    if (watcher) {\r\n        return watcher.isVisible;\r\n    }\r\n    return false;\r\n};\r\n\r\nSpriteMorph.prototype.deleteVariableWatcher = function (varName) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        watcher;\r\n    if (stage === null) {\r\n        return null;\r\n    }\r\n    watcher = this.findVariableWatcher(varName);\r\n    if (watcher !== null) {\r\n        watcher.destroy();\r\n    }\r\n};\r\n\r\n// SpriteMorph non-variable watchers\r\n\r\nSpriteMorph.prototype.toggleWatcher = function (selector, label, color) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        watcher,\r\n        others;\r\n    if (!stage) { return; }\r\n    watcher = this.watcherFor(stage, selector);\r\n    if (watcher) {\r\n        if (watcher.isVisible) {\r\n            watcher.hide();\r\n        } else {\r\n            watcher.show();\r\n            watcher.fixLayout(); // re-hide hidden parts\r\n            watcher.keepWithin(stage);\r\n        }\r\n        return;\r\n    }\r\n\r\n    // if no watcher exists, create a new one\r\n    watcher = new WatcherMorph(\r\n        label,\r\n        color,\r\n        WatcherMorph.prototype.isGlobal(selector) ? stage : this,\r\n        selector\r\n    );\r\n    watcher.setPosition(stage.position().add(10));\r\n    others = stage.watchers(watcher.left());\r\n    if (others.length > 0) {\r\n        watcher.setTop(others[others.length - 1].bottom());\r\n    }\r\n    stage.add(watcher);\r\n    watcher.fixLayout();\r\n    watcher.keepWithin(stage);\r\n};\r\n\r\nSpriteMorph.prototype.showingWatcher = function (selector) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        watcher;\r\n    if (stage === null) {\r\n        return false;\r\n    }\r\n    watcher = this.watcherFor(stage, selector);\r\n    if (watcher) {\r\n        return watcher.isVisible;\r\n    }\r\n    return false;\r\n};\r\n\r\nSpriteMorph.prototype.watcherFor = function (stage, selector) {\r\n    var myself = this;\r\n    return detect(stage.children, function (morph) {\r\n        return morph instanceof WatcherMorph &&\r\n            morph.getter === selector &&\r\n             morph.target === (morph.isGlobal(selector) ? stage : myself);\r\n    });\r\n};\r\n\r\n// SpriteMorph custom blocks\r\n\r\nSpriteMorph.prototype.deleteAllBlockInstances = function (definition) {\r\n    var stage,\r\n        blocks = definition.isGlobal ? this.allBlockInstances(definition)\r\n            : this.allIndependentInvocationsOf(definition.blockSpec());\r\n    blocks.forEach(function (each) {\r\n        each.deleteBlock();\r\n    });\r\n\r\n    // purge custom block definitions of \"corpses\"\r\n    // i.e. blocks that have been marked for deletion\r\n    if (definition.isGlobal) {\r\n        stage = this.parentThatIsA(StageMorph);\r\n        if (stage) {\r\n            stage.globalBlocks.forEach(function (def) {\r\n                def.purgeCorpses();\r\n            });\r\n            stage.children.concat(stage).forEach(function (sprite) {\r\n                if (sprite.isSnapObject) {\r\n                    sprite.customBlocks.forEach(function (def) {\r\n                        def.purgeCorpses();\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    } else {\r\n        this.allSpecimens().concat(this).forEach(function (sprite) {\r\n            sprite.customBlocks.forEach(function (def) {\r\n                def.purgeCorpses();\r\n            });\r\n        });\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.allBlockInstances = function (definition) {\r\n    var stage, objects, blocks = [], inDefinitions;\r\n    if (definition.isGlobal) {\r\n        stage = this.parentThatIsA(StageMorph);\r\n        objects = stage.children.filter(function (morph) {\r\n            return morph instanceof SpriteMorph;\r\n        });\r\n        objects.push(stage);\r\n        objects.forEach(function (sprite) {\r\n            blocks = blocks.concat(sprite.allLocalBlockInstances(definition));\r\n        });\r\n        inDefinitions = [];\r\n        stage.globalBlocks.forEach(function (def) {\r\n            def.scripts.forEach(function (eachScript) {\r\n                eachScript.allChildren().forEach(function (c) {\r\n                    if (c.isCustomBlock && (c.definition === definition)) {\r\n                        inDefinitions.push(c);\r\n                    }\r\n                });\r\n            });\r\n            if (def.body) {\r\n                def.body.expression.allChildren().forEach(function (c) {\r\n                    if (c.isCustomBlock && (c.definition === definition)) {\r\n                        inDefinitions.push(c);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n        return blocks.concat(inDefinitions);\r\n    }\r\n    return this.allLocalBlockInstances(definition);\r\n};\r\n\r\nSpriteMorph.prototype.allIndependentInvocationsOf = function (aSpec) {\r\n    var blocks;\r\n    if (this.exemplar && this.exemplar.getMethod(aSpec)) {\r\n        // shadows an inherited method, don't delete\r\n        return [];\r\n    }\r\n    blocks = this.allInvocationsOf(aSpec);\r\n    this.instances.forEach(function (sprite) {\r\n        sprite.addAllInvocationsOf(aSpec, blocks);\r\n    });\r\n    return blocks;\r\n};\r\n\r\nSpriteMorph.prototype.allDependentInvocationsOf = function (aSpec) {\r\n    var blocks;\r\n    blocks = this.allInvocationsOf(aSpec);\r\n    this.instances.forEach(function (sprite) {\r\n        sprite.addAllInvocationsOf(aSpec, blocks);\r\n    });\r\n    return blocks;\r\n};\r\n\r\nSpriteMorph.prototype.allInvocationsOf = function (aSpec) {\r\n    // only inside the receiver, without the inheritance branches\r\n    var inScripts, inDefinitions, inBlockEditors, blocks;\r\n\r\n    inScripts = this.scripts.allChildren().filter(function (c) {\r\n        return c.isCustomBlock && !c.isGlobal && (c.blockSpec === aSpec);\r\n    });\r\n\r\n    inDefinitions = [];\r\n    this.customBlocks.forEach(function (def) {\r\n        def.scripts.forEach(function (eachScript) {\r\n            eachScript.allChildren().forEach(function (c) {\r\n                if (c.isCustomBlock && !c.isGlobal &&\r\n                    (c.blockSpec === aSpec)\r\n                ) {\r\n                    inDefinitions.push(c);\r\n                }\r\n            });\r\n        });\r\n        if (def.body) {\r\n            def.body.expression.allChildren().forEach(function (c) {\r\n                if (c.isCustomBlock && !c.isGlobal &&\r\n                    (c.blockSpec === aSpec)\r\n                ) {\r\n                    inDefinitions.push(c);\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    inBlockEditors = this.allEditorBlockInstances(null, aSpec);\r\n    blocks = inScripts.concat(inDefinitions).concat(inBlockEditors);\r\n    return blocks;\r\n};\r\n\r\nSpriteMorph.prototype.addAllInvocationsOf = function (aSpec, anArray) {\r\n    if (!this.getLocalMethod(aSpec)) {\r\n        this.allInvocationsOf(aSpec).forEach(function (block) {\r\n            anArray.push(block);\r\n        });\r\n        this.instances.forEach(function (sprite) {\r\n            sprite.addAllInvocationsOf(aSpec, anArray);\r\n        });\r\n    }\r\n};\r\n\r\n\r\nSpriteMorph.prototype.allLocalBlockInstances = function (definition) {\r\n    var inScripts, inDefinitions, inBlockEditors, inPalette, result;\r\n\r\n    inScripts = this.scripts.allChildren().filter(function (c) {\r\n        return c.isCustomBlock && (c.definition === definition);\r\n    });\r\n\r\n    inDefinitions = [];\r\n    this.customBlocks.forEach(function (def) {\r\n        if (def.body) {\r\n            def.body.expression.allChildren().forEach(function (c) {\r\n                if (c.isCustomBlock && (c.definition === definition)) {\r\n                    inDefinitions.push(c);\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    inBlockEditors = this.allEditorBlockInstances(definition);\r\n    inPalette = this.paletteBlockInstance(definition);\r\n\r\n    result = inScripts.concat(inDefinitions).concat(inBlockEditors);\r\n    if (inPalette) {\r\n        result.push(inPalette);\r\n    }\r\n    return result;\r\n};\r\n\r\nSpriteMorph.prototype.allEditorBlockInstances = function (definition, spec) {\r\n    // either pass a definition for global custom blocks\r\n    // or a spec for local ones\r\n    var inBlockEditors = [],\r\n        world = this.world();\r\n\r\n    if (!world) {return []; } // when copying a sprite\r\n\r\n    this.world().children.forEach(function (morph) {\r\n        if (morph instanceof BlockEditorMorph) {\r\n            morph.body.contents.allChildren().forEach(function (block) {\r\n                if (definition) { // global\r\n                    if (!block.isPrototype\r\n                            && !(block instanceof PrototypeHatBlockMorph)\r\n                            && (block.definition === definition)) {\r\n                        inBlockEditors.push(block);\r\n                    }\r\n                } else { // local\r\n                    if (block.isCustomBlock\r\n                            && !block.isGlobal\r\n                            && !block.isPrototype\r\n                            && !(block instanceof PrototypeHatBlockMorph)\r\n                            && (block.blockSpec === spec)) {\r\n                        inBlockEditors.push(block);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n    return inBlockEditors;\r\n};\r\n\r\nSpriteMorph.prototype.paletteBlockInstance = function (definition) {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (!ide) {return null; }\r\n    return detect(\r\n        ide.palette.contents.children,\r\n        function (block) {\r\n            return block.isCustomBlock &&\r\n                (block.definition === definition);\r\n        }\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.usesBlockInstance = function (\r\n    definition,\r\n    forRemoval, // optional bool\r\n    skipGlobals, // optional bool\r\n    skipBlocks // optional array with ignorable definitions\r\n) {\r\n    var inDefinitions,\r\n        inScripts = detect(\r\n            this.scripts.allChildren(),\r\n            function (c) {\r\n                return c.isCustomBlock && (c.definition === definition);\r\n            }\r\n        );\r\n\r\n    if (inScripts) {return true; }\r\n\r\n    if (definition.isGlobal && !skipGlobals) {\r\n        inDefinitions = [];\r\n        this.parentThatIsA(StageMorph).globalBlocks.forEach(\r\n            function (def) {\r\n                if (forRemoval && (definition === def)) {return; }\r\n                if (skipBlocks && contains(skipBlocks, def)) {return; }\r\n                if (def.body) {\r\n                    def.body.expression.allChildren().forEach(function (c) {\r\n                        if (c.isCustomBlock && (c.definition === definition)) {\r\n                            inDefinitions.push(c);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        );\r\n        if (inDefinitions.length > 0) {return true; }\r\n    }\r\n\r\n    inDefinitions = [];\r\n    this.customBlocks.forEach(function (def) {\r\n        if (def.body) {\r\n            def.body.expression.allChildren().forEach(function (c) {\r\n                if (c.isCustomBlock && (c.definition === definition)) {\r\n                    inDefinitions.push(c);\r\n                }\r\n            });\r\n        }\r\n    });\r\n    return (inDefinitions.length > 0);\r\n};\r\n\r\nSpriteMorph.prototype.doubleDefinitionsFor = function (definition) {\r\n    var spec = definition.blockSpec(),\r\n        blockList,\r\n        idx,\r\n        stage;\r\n\r\n    if (definition.isGlobal) {\r\n        stage = this.parentThatIsA(StageMorph);\r\n        if (!stage) {return []; }\r\n        blockList = stage.globalBlocks;\r\n    } else {\r\n        blockList = this.customBlocks;\r\n    }\r\n    idx = blockList.indexOf(definition);\r\n    if (idx === -1) {return []; }\r\n    return blockList.filter(function (def, i) {\r\n        return def.blockSpec() === spec && (i !== idx);\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.replaceDoubleDefinitionsFor = function (definition) {\r\n    var doubles = this.doubleDefinitionsFor(definition),\r\n        myself = this,\r\n        stage,\r\n        ide;\r\n    doubles.forEach(function (double) {\r\n        myself.allBlockInstances(double).forEach(function (block) {\r\n            block.definition = definition;\r\n            block.refresh();\r\n        });\r\n    });\r\n    if (definition.isGlobal) {\r\n        stage = this.parentThatIsA(StageMorph);\r\n        stage.globalBlocks = stage.globalBlocks.filter(function (def) {\r\n            return !contains(doubles, def);\r\n        });\r\n    } else {\r\n        this.customBlocks = this.customBlocks.filter(function (def) {\r\n            return !contains(doubles, def);\r\n        });\r\n    }\r\n    ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.flushPaletteCache();\r\n        ide.refreshPalette();\r\n    }\r\n};\r\n\r\n// SpriteMorph inheritance - general\r\n\r\nSpriteMorph.prototype.chooseExemplar = function () {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        myself = this,\r\n        other = stage.children.filter(function (m) {\r\n            return m instanceof SpriteMorph &&\r\n                !m.isTemporary &&\r\n                (!contains(m.allExemplars(), myself));\r\n        }),\r\n        menu;\r\n    menu = new MenuMorph(\r\n        function (aSprite) {myself.setExemplar(aSprite); },\r\n        localize('current parent') +\r\n            ':\\n' +\r\n            (this.exemplar ? this.exemplar.name : localize('none'))\r\n    );\r\n    other.forEach(function (eachSprite) {\r\n        menu.addItem(eachSprite.name, eachSprite);\r\n    });\r\n    menu.addLine();\r\n    menu.addItem(localize('none'), null);\r\n    menu.popUpAtHand(this.world());\r\n};\r\n\r\nSpriteMorph.prototype.setExemplar = function (another) {\r\n    var ide;\r\n    this.emancipate();\r\n    this.exemplar = another;\r\n    if (another) {\r\n        this.variables.parentFrame = another.variables;\r\n        another.addSpecimen(this);\r\n    } else {\r\n        this.variables.parentFrame = this.globalVariables();\r\n    }\r\n    if (!this.isTemporary) {\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            ide.flushBlocksCache('variables');\r\n            ide.refreshPalette();\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.prune = function () {\r\n    // sever ties with all my specimen, if any,\r\n    this.instances.forEach(function (child) {\r\n        child.shadowAllAttributes();\r\n        child.shadowAllMethods();\r\n        child.shadowAllVars();\r\n        child.exemplar = null;\r\n    });\r\n    this.instances = [];\r\n};\r\n\r\nSpriteMorph.prototype.emancipate = function () {\r\n    // sever all relations with my exemplar, if any,\r\n    // and make sure I am the root of my specimen\r\n    if (this.exemplar) {\r\n        if (!this.isTemporary) {\r\n            this.shadowAllAttributes();\r\n            this.shadowAllMethods();\r\n            this.shadowAllVars();\r\n        }\r\n        this.exemplar.removeSpecimen(this); // optimization\r\n        this.exemplar = null;\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.allExemplars = function () {\r\n    // including myself\r\n    var all = [],\r\n        current = this;\r\n    while (!isNil(current)) {\r\n        all.push(current);\r\n        current = current.exemplar;\r\n    }\r\n    return all;\r\n};\r\n\r\nSpriteMorph.prototype.specimens = function () {\r\n    // without myself\r\n    return this.instances;\r\n};\r\n\r\nSpriteMorph.prototype.allSpecimens = function () {\r\n    // without myself\r\n    var all = this.instances.slice();\r\n    this.instances.forEach(function (child) {\r\n        all.push.apply(all, child.allSpecimens());\r\n    });\r\n    return all;\r\n};\r\n\r\nSpriteMorph.prototype.addSpecimen = function (another) {\r\n    // private - use setExemplar() to establish an inheritance relationship\r\n    this.instances.push(another);\r\n};\r\n\r\nSpriteMorph.prototype.removeSpecimen = function(another) {\r\n    // private - use setExemplar(null) to cancel an inheritance relationship\r\n    var idx = this.instances.indexOf(another);\r\n    if (idx !== -1) {\r\n        this.instances.splice(idx, 1);\r\n    }\r\n};\r\n\r\n// SpriteMorph inheritance - attributes\r\n\r\nSpriteMorph.prototype.inheritsAttribute = function (aName) {\r\n    return !isNil(this.exemplar) && contains(this.inheritedAttributes, aName);\r\n};\r\n\r\nSpriteMorph.prototype.updatePropagationCache = function () {\r\n    // private - indicate whether one of my inherited attributes is technically\r\n    // propagated down from my exemplar, instead of truly shared.\r\n    // (only) needed for internal optimization caching\r\n    var myself = this;\r\n    this.cachedPropagation = !isNil(this.exemplar) && detect(\r\n        ['x position', 'y position', 'direction', 'size', 'costume #'],\r\n        function (att) {\r\n            return contains(myself.inheritedAttributes, att);\r\n        }\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.shadowedAttributes = function () {\r\n    // answer an array of attribute names that can be deleted/shared\r\n    var inherited = this.inheritedAttributes;\r\n    return this.attributes.filter(function (each) {\r\n        return !contains(inherited, each);\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.shadowAllAttributes = function () {\r\n    var myself = this;\r\n    this.attributes.forEach(function (att) {\r\n        myself.shadowAttribute(att);\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.shadowAttribute = function (aName) {\r\n    var ide, wardrobe, jukebox,\r\n        myself = this,\r\n        pos;\r\n    if (!this.inheritsAttribute(aName)) {\r\n        return;\r\n    }\r\n    ide = this.parentThatIsA(IDE_Morph);\r\n    this.inheritedAttributes = this.inheritedAttributes.filter(\r\n        function (each) {return each !== aName; }\r\n    );\r\n    if (aName === 'costumes') {\r\n        wardrobe = new List();\r\n        this.costumes.asArray().forEach(function (costume) {\r\n            var cst = costume.copy();\r\n            wardrobe.add(cst);\r\n            if (costume === myself.costume) {\r\n                myself.wearCostume(cst);\r\n            }\r\n        });\r\n        this.costumes = wardrobe;\r\n        this.instances.forEach(function (obj) {\r\n            if (obj.inheritsAttribute('costumes')) {\r\n                obj.refreshInheritedAttribute('costumes');\r\n            }\r\n        });\r\n    } else if (aName === 'sounds') {\r\n        jukebox = new List();\r\n        this.sounds.asArray().forEach(function (sound) {\r\n            jukebox.add(sound.copy());\r\n        });\r\n        this.sounds = jukebox;\r\n        this.instances.forEach(function (obj) {\r\n            if (obj.inheritsAttribute('sounds')) {\r\n                obj.refreshInheritedAttribute('sounds');\r\n            }\r\n        });\r\n    } else if (aName === 'scripts') {\r\n        ide.stage.threads.stopAllForReceiver(this);\r\n        pos = this.scripts.position();\r\n        this.scripts = this.exemplar.scripts.fullCopy();\r\n        if (ide && (contains(ide.currentSprite.allExemplars(), this))) {\r\n            ide.createSpriteEditor();\r\n            ide.fixLayout('selectSprite');\r\n            this.scripts.fixMultiArgs();\r\n            this.scripts.setPosition(pos);\r\n            ide.spriteEditor.adjustScrollBars();\r\n        }\r\n        this.instances.forEach(function (obj) {\r\n            if (obj.inheritsAttribute('scripts')) {\r\n                obj.refreshInheritedAttribute('scripts');\r\n            }\r\n        });\r\n    } else {\r\n        this.updatePropagationCache();\r\n        if (ide && !this.isTemporary) {\r\n            ide.flushBlocksCache(); // optimization: specify category if known\r\n            ide.refreshPalette();\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.inheritAttribute = function (aName) {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (!this.exemplar || !contains(this.attributes, aName)) {\r\n        return;\r\n    }\r\n    if (!this.inheritsAttribute(aName)) {\r\n        this.inheritedAttributes.push(aName);\r\n        this.refreshInheritedAttribute(aName);\r\n        if (ide) {\r\n            ide.flushBlocksCache(); // optimization: specify category\r\n            ide.refreshPalette();\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.refreshInheritedAttribute = function (aName) {\r\n    var ide, idx;\r\n    switch (aName) {\r\n    case 'x position':\r\n    case 'y position':\r\n        this.cachedPropagation = true;\r\n        this.gotoXY(this.xPosition(), this.yPosition(), false, true);\r\n        break;\r\n    case 'direction':\r\n        this.cachedPropagation = true;\r\n        this.setHeading(this.direction(), true);\r\n        break;\r\n    case 'size':\r\n        this.cachedPropagation = true;\r\n        this.setScale(this.getScale(), true);\r\n        break;\r\n    case 'costume #':\r\n        this.cachedPropagation = true;\r\n        this.doSwitchToCostume(this.getCostumeIdx(), true);\r\n        break;\r\n    case 'costumes':\r\n        idx = this.getCostumeIdx();\r\n        this.costumes = this.exemplar.costumes;\r\n        this.doSwitchToCostume(idx, true);\r\n        this.instances.forEach(function (sprite) {\r\n            if (sprite.inheritsAttribute('costumes')) {\r\n                sprite.refreshInheritedAttribute('costumes');\r\n            }\r\n        });\r\n        break;\r\n    case 'sounds':\r\n        this.sounds = this.exemplar.sounds;\r\n        this.instances.forEach(function (sprite) {\r\n            if (sprite.inheritsAttribute('sounds')) {\r\n                sprite.refreshInheritedAttribute('sounds');\r\n            }\r\n        });\r\n        break;\r\n    case 'scripts':\r\n        this.scripts = this.exemplar.scripts;\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            ide.stage.threads.stopAllForReceiver(this);\r\n            if (contains(ide.currentSprite.allExemplars(), this)) {\r\n                ide.createSpriteEditor();\r\n                ide.fixLayout('selectSprite');\r\n            }\r\n        }\r\n        this.instances.forEach(function (sprite) {\r\n            if (sprite.inheritsAttribute('scripts')) {\r\n                sprite.refreshInheritedAttribute('scripts');\r\n            }\r\n        });\r\n        break;\r\n    default:\r\n        nop();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.toggleInheritanceForAttribute = function (aName) {\r\n    if (this.inheritsAttribute(aName)) {\r\n        this.shadowAttribute(aName);\r\n    } else {\r\n        this.inheritAttribute(aName);\r\n    }\r\n};\r\n\r\n// SpriteMorph inheritance - variables\r\n\r\nSpriteMorph.prototype.isVariableNameInUse = function (vName, isGlobal) {\r\n    if (isGlobal) {\r\n        return contains(this.variables.allNames(), vName);\r\n    }\r\n    if (contains(this.variables.names(), vName)) {return true; }\r\n    return contains(this.globalVariables().names(), vName);\r\n};\r\n\r\nSpriteMorph.prototype.globalVariables = function () {\r\n    var current = this.variables.parentFrame;\r\n    while (current.owner) {\r\n        current = current.parentFrame;\r\n    }\r\n    return current;\r\n};\r\n\r\nSpriteMorph.prototype.shadowAllVars = function () {\r\n    var myself = this;\r\n    this.inheritedVariableNames().forEach(function (name) {\r\n        myself.shadowVar(name, myself.variables.getVar(name));\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.shadowVar = function (name, value) {\r\n    var ide;\r\n    this.variables.addVar(name, value);\r\n    if (!this.isTemporary) {\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            ide.flushBlocksCache('variables');\r\n            ide.refreshPalette();\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.toggleInheritedVariable = function (vName) {\r\n    if (contains(this.inheritedVariableNames(true), vName)) { // is shadowed\r\n        this.deleteVariable(vName);\r\n    } else if (contains(this.inheritedVariableNames(), vName)) { // inherited\r\n        this.shadowVar(vName, this.variables.getVar(vName));\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.inheritedVariableNames = function (shadowedOnly) {\r\n    var names = [],\r\n        own = this.variables.names(),\r\n        current = this.variables.parentFrame;\r\n\r\n    function test(each) {\r\n        return shadowedOnly ? contains(own, each) : !contains(own, each);\r\n    }\r\n\r\n    while (current.owner instanceof SpriteMorph) {\r\n        names.push.apply(\r\n            names,\r\n            current.names().filter(test)\r\n        );\r\n        current = current.parentFrame;\r\n    }\r\n    return names;\r\n};\r\n\r\nSpriteMorph.prototype.deletableVariableNames = function () {\r\n    var locals = this.variables.names(),\r\n        inherited = this.inheritedVariableNames();\r\n    return locals.concat(\r\n        this.globalVariables().names().filter(\r\n            function (each) {\r\n                return !contains(locals, each) && !contains(inherited, each);\r\n            }\r\n        )\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.hasSpriteVariable = function (varName) {\r\n    return contains(this.variables.names(), varName);\r\n};\r\n\r\n// SpriteMorph inheritance - custom blocks\r\n\r\nSpriteMorph.prototype.getMethod = function (spec) {\r\n    return this.allBlocks()[spec];\r\n};\r\n\r\nSpriteMorph.prototype.getLocalMethod = function (spec) {\r\n    return this.ownBlocks()[spec];\r\n};\r\n\r\nSpriteMorph.prototype.ownBlocks = function () {\r\n    var dict = {};\r\n    this.customBlocks.forEach(function (def) {\r\n        dict[def.blockSpec()] = def;\r\n    });\r\n    return dict;\r\n};\r\n\r\nSpriteMorph.prototype.allBlocks = function (valuesOnly) {\r\n    var dict = {};\r\n    this.allExemplars().reverse().forEach(function (sprite) {\r\n        sprite.customBlocks.forEach(function (def) {\r\n            dict[def.blockSpec()] = def;\r\n        });\r\n    });\r\n    if (valuesOnly) {\r\n        return Object.keys(dict).map(function (key) {return dict[key]; });\r\n    }\r\n    return dict;\r\n};\r\n\r\nSpriteMorph.prototype.inheritedBlocks = function (valuesOnly) {\r\n    var dict = {},\r\n        own = Object.keys(this.ownBlocks()),\r\n        others = this.allExemplars().reverse();\r\n    others.pop();\r\n    others.forEach(function (sprite) {\r\n        sprite.customBlocks.forEach(function (def) {\r\n            var spec = def.blockSpec();\r\n            if (!contains(own, spec)) {\r\n                dict[spec] = def;\r\n            }\r\n        });\r\n    });\r\n    if (valuesOnly) {\r\n        return Object.keys(dict).map(function (key) {return dict[key]; });\r\n    }\r\n    return dict;\r\n};\r\n\r\nSpriteMorph.prototype.shadowAllMethods = function () {\r\n    var ide,\r\n        myself = this;\r\n    this.inheritedMethods().forEach(function (dup) {\r\n        myself.customBlocks.push(dup);\r\n    });\r\n    if (!this.isTemporary) {\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            ide.flushPaletteCache();\r\n            ide.refreshPalette();\r\n        }\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.inheritedMethods = function () {\r\n    // private - pre-serialization preparation\r\n    var myself = this;\r\n    return this.inheritedBlocks(true).map(function (def) {\r\n        return def.copyAndBindTo(myself, true); // header only\r\n    });\r\n};\r\n\r\n// SpriteMorph thumbnail\r\n\r\nSpriteMorph.prototype.thumbnail = function (extentPoint) {\r\n/*\r\n    answer a new Canvas of extentPoint dimensions containing\r\n    my thumbnail representation keeping the originial aspect ratio\r\n*/\r\n    var src = this.image, // at this time sprites aren't composite morphs\r\n        scale = Math.min(\r\n            (extentPoint.x / src.width),\r\n            (extentPoint.y / src.height)\r\n        ),\r\n        xOffset = (extentPoint.x - (src.width * scale)) / 2,\r\n        yOffset = (extentPoint.y - (src.height * scale)) / 2,\r\n        trg = newCanvas(extentPoint),\r\n        ctx = trg.getContext('2d');\r\n\r\n    function xOut(style, alpha, width) {\r\n        var inset = Math.min(extentPoint.x, extentPoint.y) / 10;\r\n        ctx.strokeStyle = style;\r\n        ctx.globalAlpha = alpha;\r\n        ctx.compositeOperation = 'lighter';\r\n        ctx.lineWidth = width || 1;\r\n        ctx.moveTo(inset, inset);\r\n        ctx.lineTo(trg.width - inset, trg.height - inset);\r\n        ctx.moveTo(inset, trg.height - inset);\r\n        ctx.lineTo(trg.width - inset, inset);\r\n        ctx.stroke();\r\n    }\r\n\r\n    ctx.save();\r\n    if (this.isCorpse) {\r\n        ctx.globalAlpha = 0.3;\r\n    }\r\n    if (src.width && src.height) {\r\n        ctx.scale(scale, scale);\r\n        ctx.drawImage(\r\n            src,\r\n            Math.floor(xOffset / scale),\r\n            Math.floor(yOffset / scale)\r\n        );\r\n    }\r\n    if (this.isCorpse) {\r\n        ctx.restore();\r\n        xOut('white', 0.8, 6);\r\n        xOut('black', 0.8, 1);\r\n    }\r\n    return trg;\r\n};\r\n\r\nSpriteMorph.prototype.fullThumbnail = function (extentPoint) {\r\n    // containing parts and anchor symbols, if any\r\n    var thumb = this.thumbnail(extentPoint),\r\n        ctx = thumb.getContext('2d'),\r\n        ext = extentPoint.divideBy(3),\r\n        i = 0;\r\n\r\n    ctx.restore();\r\n    if (this.anchor) {\r\n        ctx.drawImage(\r\n            this.anchor.thumbnail(ext),\r\n            0,\r\n            0\r\n        );\r\n    }\r\n    for (i = 0; i < 3; i += 1) {\r\n        if (this.parts[i]) {\r\n            ctx.drawImage(\r\n                this.parts[i].thumbnail(ext),\r\n                i * ext.x,\r\n                extentPoint.y - ext.y\r\n            );\r\n        }\r\n    }\r\n    return thumb;\r\n};\r\n\r\n// SpriteMorph Boolean visual representation\r\n\r\nSpriteMorph.prototype.booleanMorph = function (bool) {\r\n    var sym = new BooleanSlotMorph(bool);\r\n    sym.isStatic = true;\r\n    sym.drawNew();\r\n    return sym;\r\n};\r\n\r\n// SpriteMorph nesting\r\n/*\r\n    simulate Morphic trees\r\n*/\r\n\r\nSpriteMorph.prototype.attachPart = function (aSprite) {\r\n    var v = Date.now();\r\n    if (aSprite.anchor) {\r\n        aSprite.anchor.detachPart(aSprite);\r\n    }\r\n    this.parts.push(aSprite);\r\n    this.version = v;\r\n    aSprite.anchor = this;\r\n    this.allParts().forEach(function (part) {\r\n        part.nestingScale = part.scale;\r\n    });\r\n    aSprite.version = v;\r\n};\r\n\r\nSpriteMorph.prototype.detachPart = function (aSprite) {\r\n    var idx = this.parts.indexOf(aSprite),\r\n        v;\r\n    if (idx !== -1) {\r\n        v = Date.now();\r\n        this.parts.splice(idx, 1);\r\n        this.version = v;\r\n        aSprite.anchor = null;\r\n        aSprite.version = v;\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.detachAllParts = function () {\r\n    var v = Date.now();\r\n\r\n    this.parts.forEach(function (part) {\r\n        part.anchor = null;\r\n        part.version = v;\r\n    });\r\n    this.parts = [];\r\n    this.version = v;\r\n};\r\n\r\nSpriteMorph.prototype.detachFromAnchor = function () {\r\n    if (this.anchor) {\r\n        this.anchor.detachPart(this);\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.allParts = function () {\r\n    // includes myself\r\n    var result = [this];\r\n    this.parts.forEach(function (part) {\r\n        result = result.concat(part.allParts());\r\n    });\r\n    return result;\r\n};\r\n\r\nSpriteMorph.prototype.allAnchors = function () {\r\n    // includes myself\r\n    var result = [this];\r\n    if (this.anchor !== null) {\r\n        result = result.concat(this.anchor.allAnchors());\r\n    }\r\n    return result;\r\n};\r\n\r\nSpriteMorph.prototype.recordLayers = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (!stage) {\r\n        this.layerCache = null;\r\n        return;\r\n    }\r\n    this.layers = this.allParts();\r\n    this.layers.forEach(function (part) {\r\n        var bubble = part.talkBubble();\r\n        if (bubble) {bubble.hide(); }\r\n    });\r\n    this.layers.sort(function (x, y) {\r\n        return stage.children.indexOf(x) < stage.children.indexOf(y) ?\r\n                -1 : 1;\r\n    });\r\n};\r\n\r\nSpriteMorph.prototype.restoreLayers = function () {\r\n    if (this.layers && this.layers.length > 1) {\r\n        this.layers.forEach(function (sprite) {\r\n            sprite.comeToFront();\r\n            sprite.positionTalkBubble();\r\n        });\r\n    }\r\n    this.layers = null;\r\n};\r\n\r\n// SpriteMorph destroying\r\n\r\nSpriteMorph.prototype.destroy = function () {\r\n    // make sure to sever all inheritance ties to other sprites\r\n    if (this.anchor) {\r\n        this.anchor.detachPart(this);\r\n    }\r\n    this.emancipate();\r\n    if (!this.isTemporary) {\r\n        this.prune();\r\n    }\r\n    SpriteMorph.uber.destroy.call(this);\r\n};\r\n\r\n// SpriteMorph highlighting\r\n\r\nSpriteMorph.prototype.flash = function () {\r\n\tvar world = this.world(),\r\n\t\tmyself = this;\r\n    this.addHighlight();\r\n\tworld.animations.push(new Animation(\r\n\t\tnop,\r\n  \t\tnop,\r\n    \t0,\r\n     \t800,\r\n      \tnop,\r\n      \tfunction () {myself.removeHighlight(); }\r\n\t));\r\n};\r\n\r\nSpriteMorph.prototype.addHighlight = function (oldHighlight) {\r\n    var isHidden = !this.isVisible,\r\n        highlight;\r\n\r\n    if (isHidden) {this.show(); }\r\n    highlight = this.highlight(\r\n        oldHighlight ? oldHighlight.color : this.highlightColor,\r\n        this.highlightBorder\r\n    );\r\n    this.addBack(highlight);\r\n    this.fullChanged();\r\n    if (isHidden) {this.hide(); }\r\n    return highlight;\r\n};\r\n\r\nSpriteMorph.prototype.removeHighlight = function () {\r\n    var highlight = this.getHighlight();\r\n    if (highlight !== null) {\r\n        this.fullChanged();\r\n        this.removeChild(highlight);\r\n    }\r\n    return highlight;\r\n};\r\n\r\nSpriteMorph.prototype.toggleHighlight = function () {\r\n    if (this.getHighlight()) {\r\n        this.removeHighlight();\r\n    } else {\r\n        this.addHighlight();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.highlight = function (color, border) {\r\n    var highlight = new SpriteHighlightMorph(),\r\n        fb = this.bounds, // sprites are not nested in a Morphic way\r\n        edge = border,\r\n        ctx;\r\n\r\n    highlight.setExtent(fb.extent().add(edge * 2));\r\n    highlight.color = color;\r\n    highlight.image = this.highlightImage(color, border);\r\n    ctx = highlight.image.getContext('2d');\r\n    ctx.drawImage(\r\n        this.highlightImage(new Color(255, 255, 255), 4),\r\n        border - 4,\r\n        border - 4\r\n    );\r\n    ctx.drawImage(\r\n        this.highlightImage(new Color(50, 50, 50), 2),\r\n        border - 2,\r\n        border - 2\r\n    );\r\n    ctx.drawImage(\r\n        this.highlightImage(new Color(255, 255, 255), 1),\r\n        border - 1,\r\n        border - 1\r\n    );\r\n    highlight.setPosition(fb.origin.subtract(new Point(edge, edge)));\r\n    return highlight;\r\n};\r\n\r\nSpriteMorph.prototype.highlightImage = function (color, border) {\r\n    var fb, img, hi, ctx, out;\r\n    fb = this.extent();\r\n    img = this.image;\r\n\r\n    hi = newCanvas(fb.add(border * 2));\r\n    ctx = hi.getContext('2d');\r\n\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.drawImage(img, border, 0);\r\n    ctx.drawImage(img, border * 2, 0);\r\n    ctx.drawImage(img, border * 2, border);\r\n    ctx.drawImage(img, border * 2, border * 2);\r\n    ctx.drawImage(img, border, border * 2);\r\n    ctx.drawImage(img, 0, border * 2);\r\n    ctx.drawImage(img, 0, border);\r\n\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.drawImage(img, border, border);\r\n\r\n    out = newCanvas(fb.add(border * 2));\r\n    ctx = out.getContext('2d');\r\n    ctx.drawImage(hi, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, out.width, out.height);\r\n\r\n    return out;\r\n};\r\n\r\nSpriteMorph.prototype.getHighlight = function () {\r\n    var highlights;\r\n    highlights = this.children.slice(0).reverse().filter(\r\n        function (child) {\r\n            return child instanceof SpriteHighlightMorph;\r\n        }\r\n    );\r\n    if (highlights.length !== 0) {\r\n        return highlights[0];\r\n    }\r\n    return null;\r\n};\r\n\r\n// SpriteMorph nesting events\r\n\r\nSpriteMorph.prototype.mouseEnterDragging = function () {\r\n    var obj;\r\n    if (!this.enableNesting) {return; }\r\n    obj = this.world().hand.children[0];\r\n    if (this.wantsDropOf(obj)) {\r\n        this.addHighlight();\r\n    }\r\n};\r\n\r\nSpriteMorph.prototype.mouseLeave = function () {\r\n    this.receiveUserInteraction('mouse-departed');\r\n    if (!this.enableNesting) {return; }\r\n    this.removeHighlight();\r\n};\r\n\r\nSpriteMorph.prototype.wantsDropOf = function (morph) {\r\n    // allow myself to be the anchor of another sprite\r\n    // by drag & drop\r\n    return this.enableNesting\r\n        && morph instanceof SpriteIconMorph\r\n        && !contains(morph.object.allParts(), this);\r\n};\r\n\r\nSpriteMorph.prototype.reactToDropOf = function (morph, hand) {\r\n    this.removeHighlight();\r\n    this.attachPart(morph.object);\r\n    this.world().add(morph);\r\n    morph.slideBackTo(hand.grabOrigin);\r\n};\r\n\r\n// SpriteMorph screenshots\r\n\r\nSpriteMorph.prototype.newCostumeName = function (name, ignoredCostume) {\r\n    var ix = name.indexOf('('),\r\n        stem = (ix < 0) ? name : name.substring(0, ix),\r\n        count = 1,\r\n        newName = stem,\r\n        all = this.costumes.asArray().filter(\r\n            function (each) {return each !== ignoredCostume; }\r\n        ).map(\r\n            function (each) {return each.name; }\r\n        );\r\n    while (contains(all, newName)) {\r\n        count += 1;\r\n        newName = stem + '(' + count + ')';\r\n    }\r\n    return newName;\r\n};\r\n\r\nSpriteMorph.prototype.doScreenshot = function (imgSource, data) {\r\n    var canvas,\r\n        stage = this.parentThatIsA(StageMorph),\r\n        costume;\r\n    data = this.newCostumeName(data);\r\n    if (imgSource[0] === undefined) {\r\n        return;\r\n    }\r\n    if (imgSource[0] === \"pen trails\") {\r\n        canvas = stage.trailsCanvas;\r\n        costume = new Costume(canvas, data).copy(); // prevent mutation\r\n    } else if (imgSource[0] === \"stage image\") {\r\n        canvas = stage.fullImageClassic();\r\n        costume = new Costume(canvas, data);\r\n    }\r\n    this.addCostume(costume);\r\n};\r\n\r\n// SpriteHighlightMorph /////////////////////////////////////////////////\r\n\r\n// SpriteHighlightMorph inherits from Morph:\r\n\r\nSpriteHighlightMorph.prototype = new Morph();\r\nSpriteHighlightMorph.prototype.constructor = SpriteHighlightMorph;\r\nSpriteHighlightMorph.uber = Morph.prototype;\r\n\r\n// SpriteHighlightMorph instance creation:\r\n\r\nfunction SpriteHighlightMorph() {\r\n    this.init();\r\n}\r\n\r\n// StageMorph /////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I inherit from FrameMorph and copy from SpriteMorph.\r\n*/\r\n\r\n// StageMorph inherits from FrameMorph:\r\n\r\nStageMorph.prototype = new FrameMorph();\r\nStageMorph.prototype.constructor = StageMorph;\r\nStageMorph.uber = FrameMorph.prototype;\r\n\r\n// StageMorph preferences settings\r\n\r\nStageMorph.prototype.dimensions = new Point(480, 360); // unscaled extent\r\nStageMorph.prototype.frameRate = 0; // unscheduled per default\r\n\r\nStageMorph.prototype.isCachingPrimitives\r\n    = SpriteMorph.prototype.isCachingPrimitives;\r\n\r\nStageMorph.prototype.sliderColor\r\n    = SpriteMorph.prototype.sliderColor;\r\n\r\nStageMorph.prototype.paletteTextColor\r\n    = SpriteMorph.prototype.paletteTextColor;\r\n\r\nStageMorph.prototype.hiddenPrimitives = {};\r\nStageMorph.prototype.codeMappings = {};\r\nStageMorph.prototype.codeHeaders = {};\r\nStageMorph.prototype.enableCodeMapping = false;\r\nStageMorph.prototype.enableInheritance = true;\r\nStageMorph.prototype.enableSublistIDs = false;\r\n\r\n// StageMorph instance creation\r\n\r\nfunction StageMorph(globals) {\r\n    this.init(globals);\r\n}\r\n\r\nStageMorph.prototype.init = function (globals) {\r\n    this.name = localize('Stage');\r\n    this.instrument = null;\r\n    this.threads = new ThreadManager();\r\n    this.variables = new VariableFrame(globals || null, this);\r\n    this.scripts = new ScriptsMorph();\r\n    this.customBlocks = [];\r\n    this.globalBlocks = [];\r\n    this.costumes = new List();\r\n    this.costume = null;\r\n    this.sounds = new List();\r\n    this.version = Date.now(); // for observers\r\n    this.isFastTracked = false;\r\n    this.enableCustomHatBlocks = true;\r\n    this.cloneCount = 0;\r\n\r\n    this.timerStart = Date.now();\r\n    this.tempo = 60; // bpm\r\n    this.lastMessage = '';\r\n\r\n    this.watcherUpdateFrequency = 2;\r\n    this.lastWatcherUpdate = Date.now();\r\n\r\n    this.scale = 1; // for display modes, do not persist\r\n\r\n    this.keysPressed = {}; // for handling keyboard events, do not persist\r\n    this.blocksCache = {}; // not to be serialized (!)\r\n    this.paletteCache = {}; // not to be serialized (!)\r\n    this.lastAnswer = ''; // last user input, do not persist\r\n    this.activeSounds = []; // do not persist\r\n\r\n    this.trailsCanvas = null;\r\n    this.isThreadSafe = false;\r\n\r\n    this.graphicsValues = {\r\n        'color': 0,\r\n        'fisheye': 0,\r\n        'whirl': 0,\r\n        'pixelate': 0,\r\n        'mosaic': 0,\r\n        'duplicate': 0,\r\n        'negative': 0,\r\n        'comic': 0,\r\n        'confetti': 0,\r\n        'saturation': 0,\r\n        'brightness': 0\r\n    };\r\n\r\n    StageMorph.uber.init.call(this);\r\n\r\n    this.acceptsDrops = false;\r\n    this.setColor(new Color(255, 255, 255));\r\n    this.fps = this.frameRate;\r\n};\r\n\r\n// StageMorph scaling\r\n\r\nStageMorph.prototype.setScale = function (number) {\r\n    var delta = number / this.scale,\r\n        pos = this.position(),\r\n        relativePos,\r\n        bubble,\r\n        oldFlag = Morph.prototype.trackChanges,\r\n        myself = this;\r\n\r\n    if (delta === 1) {return; }\r\n    Morph.prototype.trackChanges = false;\r\n    this.scale = number;\r\n    this.setExtent(this.dimensions.multiplyBy(number));\r\n\r\n    // now move and resize all children - sprites, bubbles, watchers etc..\r\n    this.children.forEach(function (morph) {\r\n        relativePos = morph.position().subtract(pos);\r\n        morph.drawNew();\r\n        morph.setPosition(\r\n            relativePos.multiplyBy(delta).add(pos),\r\n            true // just me (for nested sprites)\r\n        );\r\n        if (morph instanceof SpriteMorph) {\r\n            bubble = morph.talkBubble();\r\n            if (bubble) {\r\n                bubble.setScale(number);\r\n                morph.positionTalkBubble();\r\n            }\r\n        } else if (morph instanceof StagePrompterMorph) {\r\n            if (myself.scale < 1) {\r\n                morph.setWidth(myself.width() - 10);\r\n            } else {\r\n                morph.setWidth(myself.dimensions.x - 20);\r\n            }\r\n            morph.fixLayout();\r\n            morph.setCenter(myself.center());\r\n            morph.setBottom(myself.bottom());\r\n        }\r\n    });\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n};\r\n\r\n// StageMorph rendering\r\n\r\nStageMorph.prototype.drawNew = function () {\r\n    var ctx;\r\n    StageMorph.uber.drawNew.call(this);\r\n    if (this.costume) {\r\n        ctx = this.image.getContext('2d');\r\n        ctx.scale(this.scale, this.scale);\r\n        ctx.drawImage(\r\n            this.costume.contents,\r\n            (this.width() / this.scale - this.costume.width()) / 2,\r\n            (this.height() / this.scale - this.costume.height()) / 2\r\n        );\r\n        this.image = this.applyGraphicsEffects(this.image);\r\n    }\r\n    this.version = Date.now(); // for observer optimization\r\n};\r\n\r\nStageMorph.prototype.drawOn = function (aCanvas, aRect) {\r\n    // make sure to draw the pen trails canvas as well\r\n    var rectangle, area, delta, src, context, w, h, sl, st, ws, hs;\r\n    if (!this.isVisible) {\r\n        return null;\r\n    }\r\n    rectangle = aRect || this.bounds;\r\n    area = rectangle.intersect(this.bounds);\r\n    if (area.extent().gt(new Point(0, 0))) {\r\n        delta = this.position().neg();\r\n        src = area.copy().translateBy(delta);\r\n        context = aCanvas.getContext('2d');\r\n        context.globalAlpha = this.alpha;\r\n\r\n        sl = src.left();\r\n        st = src.top();\r\n        w = Math.min(src.width(), this.image.width - sl);\r\n        h = Math.min(src.height(), this.image.height - st);\r\n\r\n        if (w < 1 || h < 1) {\r\n            return null;\r\n        }\r\n        context.drawImage(\r\n            this.image,\r\n            sl,\r\n            st,\r\n            w,\r\n            h,\r\n            area.left(),\r\n            area.top(),\r\n            w,\r\n            h\r\n        );\r\n\r\n        // pen trails\r\n        ws = w / this.scale;\r\n        hs = h / this.scale;\r\n        context.save();\r\n        context.scale(this.scale, this.scale);\r\n        try {\r\n            context.drawImage(\r\n                this.penTrails(),\r\n                sl / this.scale,\r\n                st / this.scale,\r\n                ws,\r\n                hs,\r\n                area.left() / this.scale,\r\n                area.top() / this.scale,\r\n                ws,\r\n                hs\r\n            );\r\n        } catch (err) { // sometimes triggered only by Firefox\r\n            context.restore();\r\n            context.drawImage(\r\n                this.penTrails(),\r\n                0,\r\n                0,\r\n                this.dimensions.x,\r\n                this.dimensions.y,\r\n                this.left(),\r\n                this.top(),\r\n                this.dimensions.x * this.scale,\r\n                this.dimensions.y * this.scale\r\n            );\r\n        }\r\n        context.restore();\r\n    }\r\n};\r\n\r\nStageMorph.prototype.clearPenTrails = function () {\r\n    this.trailsCanvas = newCanvas(this.dimensions);\r\n    this.changed();\r\n};\r\n\r\nStageMorph.prototype.penTrails = function () {\r\n    if (!this.trailsCanvas) {\r\n        this.trailsCanvas = newCanvas(this.dimensions);\r\n    }\r\n    return this.trailsCanvas;\r\n};\r\n\r\nStageMorph.prototype.penTrailsMorph = function () {\r\n    // for collision detection purposes\r\n    var morph = new Morph(),\r\n        trails = this.penTrails(),\r\n        ctx;\r\n    morph.bounds = this.bounds.copy();\r\n    morph.image = newCanvas(this.extent());\r\n    ctx = morph.image.getContext('2d');\r\n    ctx.drawImage(\r\n        trails,\r\n        0,\r\n        0,\r\n        trails.width,\r\n        trails.height,\r\n        0,\r\n        0,\r\n        this.image.width,\r\n        this.image.height\r\n    );\r\n    return morph;\r\n};\r\n\r\nStageMorph.prototype.colorFiltered = function (aColor, excludedSprite) {\r\n    // answer a new Morph containing my image filtered by aColor\r\n    // ignore the excludedSprite, because its collision is checked\r\n    // ignore transparency (alpha)\r\n    var morph = new Morph(),\r\n        ext = this.extent(),\r\n        img = this.thumbnail(ext, excludedSprite),\r\n        ctx,\r\n        src,\r\n        clr,\r\n        i,\r\n        dta;\r\n\r\n    src = normalizeCanvas(img, true).getContext('2d').getImageData(\r\n        0,\r\n        0,\r\n        ext.x,\r\n        ext.y\r\n    );\r\n    morph.bounds = this.bounds.copy();\r\n    morph.image = newCanvas(ext, true);\r\n    ctx = morph.image.getContext('2d');\r\n    dta = ctx.createImageData(ext.x, ext.y);\r\n    for (i = 0; i < ext.x * ext.y * 4; i += 4) {\r\n        clr = new Color(\r\n            src.data[i],\r\n            src.data[i + 1],\r\n            src.data[i + 2]\r\n        );\r\n        if (clr.eq(aColor)) {\r\n            dta.data[i] = src.data[i];\r\n            dta.data[i + 1] = src.data[i + 1];\r\n            dta.data[i + 2] = src.data[i + 2];\r\n            dta.data[i + 3] = 255;\r\n        }\r\n    }\r\n    ctx.putImageData(dta, 0, 0);\r\n    return morph;\r\n};\r\n\r\n// StageMorph pixel access:\r\n\r\nStageMorph.prototype.getPixelColor = function (aPoint) {\r\n    var point, context, data;\r\n\tif (this.trailsCanvas) {\r\n        point = aPoint.subtract(this.bounds.origin);\r\n        context = this.trailsCanvas.getContext('2d');\r\n        data = context.getImageData(point.x, point.y, 1, 1);\r\n        if (data.data[3] === 0) {\r\n        \treturn StageMorph.uber.getPixelColor.call(this, aPoint);\r\n        }\r\n        return new Color(\r\n            data.data[0],\r\n            data.data[1],\r\n            data.data[2],\r\n            data.data[3] / 255\r\n        );\r\n \t}\r\n};\r\n\r\n// StageMorph accessing\r\n\r\nStageMorph.prototype.watchers = function (leftPos) {\r\n/*\r\n    answer an array of all currently visible watchers.\r\n    If leftPos is specified, filter the list for all\r\n    shown or hidden watchers whose left side equals\r\n    the given border (for automatic positioning)\r\n*/\r\n    return this.children.filter(function (morph) {\r\n        if (morph instanceof WatcherMorph) {\r\n            if (leftPos) {\r\n                return morph.left() === leftPos;\r\n            }\r\n            return morph.isVisible;\r\n        }\r\n        return false;\r\n    });\r\n};\r\n\r\n// StageMorph timer\r\n\r\nStageMorph.prototype.resetTimer = function () {\r\n    this.timerStart = Date.now();\r\n};\r\n\r\nStageMorph.prototype.getTimer = function () {\r\n    var elapsed = Math.floor((Date.now() - this.timerStart) / 100);\r\n    return elapsed / 10;\r\n};\r\n\r\n// StageMorph tempo\r\n\r\nStageMorph.prototype.setTempo = function (bpm) {\r\n    this.tempo = Math.max(20, (+bpm || 0));\r\n};\r\n\r\nStageMorph.prototype.changeTempo = function (delta) {\r\n    this.setTempo(this.getTempo() + (+delta || 0));\r\n};\r\n\r\nStageMorph.prototype.getTempo = function () {\r\n    return +this.tempo;\r\n};\r\n\r\n// StageMorph messages\r\n\r\nStageMorph.prototype.getLastMessage = function () {\r\n    return this.lastMessage || '';\r\n};\r\n\r\n// StageMorph Mouse Coordinates\r\n\r\nStageMorph.prototype.reportMouseX = function () {\r\n    var world = this.world();\r\n    if (world) {\r\n        return (world.hand.position().x - this.center().x) / this.scale;\r\n    }\r\n    return 0;\r\n};\r\n\r\nStageMorph.prototype.reportMouseY = function () {\r\n    var world = this.world();\r\n    if (world) {\r\n        return (this.center().y - world.hand.position().y) / this.scale;\r\n    }\r\n    return 0;\r\n};\r\n\r\n// StageMorph drag & drop\r\n\r\nStageMorph.prototype.wantsDropOf = function (aMorph) {\r\n    return aMorph instanceof SpriteMorph ||\r\n        aMorph instanceof WatcherMorph ||\r\n        aMorph instanceof ListWatcherMorph ||\r\n        aMorph instanceof SpriteIconMorph;\r\n};\r\n\r\nStageMorph.prototype.reactToDropOf = function (morph, hand) {\r\n    if (morph instanceof SpriteIconMorph) { // detach sprite from anchor\r\n        if (morph.object.anchor) {\r\n            morph.object.anchor.detachPart(morph.object);\r\n        }\r\n        this.world().add(morph);\r\n        morph.slideBackTo(hand.grabOrigin);\r\n    }\r\n};\r\n\r\n// StageMorph stepping\r\n\r\nStageMorph.prototype.step = function () {\r\n    var current, elapsed, leftover, ide, world = this.world();\r\n\r\n    // handle keyboard events\r\n    if (world.keyboardReceiver === null) {\r\n        world.keyboardReceiver = this;\r\n    }\r\n    if (world.currentKey === null) {\r\n        this.keyPressed = null;\r\n    }\r\n\r\n    // manage threads\r\n    if (this.enableCustomHatBlocks) {\r\n        this.stepGenericConditions();\r\n    }\r\n    if (this.isFastTracked && this.threads.processes.length) {\r\n        this.children.forEach(function (morph) {\r\n            if (morph instanceof SpriteMorph) {\r\n                morph.wasWarped = morph.isWarped;\r\n                if (!morph.isWarped) {\r\n                    morph.startWarp();\r\n                }\r\n            }\r\n        });\r\n        while ((Date.now() - this.lastTime) < 17) { // approx. 60 fps\r\n            this.threads.step();\r\n        }\r\n        this.children.forEach(function (morph) {\r\n            if (morph instanceof SpriteMorph) {\r\n                if (!morph.wasWarped) {\r\n                    morph.endWarp();\r\n                }\r\n            }\r\n        });\r\n        this.changed();\r\n    } else {\r\n        this.threads.step();\r\n\r\n        // single-stepping hook:\r\n        if (this.threads.wantsToPause) {\r\n            ide = this.parentThatIsA(IDE_Morph);\r\n            if (ide) {\r\n                ide.controlBar.pauseButton.refresh();\r\n            }\r\n        }\r\n    }\r\n\r\n    // update watchers\r\n    current = Date.now();\r\n    elapsed = current - this.lastWatcherUpdate;\r\n    leftover = (1000 / this.watcherUpdateFrequency) - elapsed;\r\n    if (leftover < 1) {\r\n        this.watchers().forEach(function (w) {\r\n            w.update();\r\n        });\r\n        this.lastWatcherUpdate = Date.now();\r\n    }\r\n};\r\n\r\nStageMorph.prototype.stepGenericConditions = function (stopAll) {\r\n    var hatCount = 0,\r\n        myself = this,\r\n        ide;\r\n    this.children.concat(this).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            morph.allGenericHatBlocks().forEach(function (block) {\r\n                hatCount += 1;\r\n                myself.threads.doWhen(block, morph, stopAll);\r\n            });\r\n        }\r\n    });\r\n    if (!hatCount) {\r\n        this.enableCustomHatBlocks = false;\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n        if (ide) {\r\n            ide.controlBar.stopButton.refresh();\r\n        }\r\n    }\r\n};\r\n\r\nStageMorph.prototype.developersMenu = function () {\r\n    var myself = this,\r\n        menu = StageMorph.uber.developersMenu.call(this);\r\n    menu.addItem(\r\n        \"stop\",\r\n        function () {\r\n            myself.threads.stopAll();\r\n        },\r\n        'terminate all running threads'\r\n    );\r\n    return menu;\r\n};\r\n\r\n// StageMorph keyboard events\r\n\r\nStageMorph.prototype.processKeyDown = function (event) {\r\n    this.processKeyEvent(\r\n        event,\r\n        this.fireKeyEvent\r\n    );\r\n};\r\n\r\nStageMorph.prototype.processKeyUp = function (event) {\r\n    this.processKeyEvent(\r\n        event,\r\n        this.removePressedKey\r\n    );\r\n};\r\n\r\nStageMorph.prototype.processKeyEvent = function (event, action) {\r\n    var keyName;\r\n\r\n    // this.inspectKeyEvent(event);\r\n    switch (event.keyCode) {\r\n    case 13:\r\n        keyName = 'enter';\r\n        if (event.ctrlKey || event.metaKey) {\r\n            keyName = 'ctrl enter';\r\n        } else if (event.shiftKey) {\r\n            keyName = 'shift enter';\r\n        }\r\n        break;\r\n    case 27:\r\n        keyName = 'esc';\r\n        break;\r\n    case 32:\r\n        keyName = 'space';\r\n        break;\r\n    case 37:\r\n        keyName = 'left arrow';\r\n        break;\r\n    case 39:\r\n        keyName = 'right arrow';\r\n        break;\r\n    case 38:\r\n        keyName = 'up arrow';\r\n        break;\r\n    case 40:\r\n        keyName = 'down arrow';\r\n        break;\r\n    default:\r\n        keyName = String.fromCharCode(event.keyCode || event.charCode);\r\n        if (event.ctrlKey || event.metaKey) {\r\n            keyName = 'ctrl ' + (event.shiftKey ? 'shift ' : '') + keyName;\r\n        }\r\n    }\r\n    action.call(this, keyName);\r\n};\r\n\r\nStageMorph.prototype.fireKeyEvent = function (key) {\r\n    var evt = key.toLowerCase(),\r\n        procs = [],\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        myself = this;\r\n\r\n    this.keysPressed[evt] = true;\r\n    if (evt === 'ctrl enter') {\r\n        return this.fireGreenFlagEvent();\r\n    }\r\n    if (evt === 'shift enter') {\r\n        return this.editScripts();\r\n    }\r\n    if (evt === 'ctrl f') {\r\n        if (!ide.isAppMode) {ide.currentSprite.searchBlocks(); }\r\n        return;\r\n    }\r\n    if (evt === 'ctrl z') {\r\n        if (!ide.isAppMode) {ide.currentSprite.scripts.undrop(); }\r\n         return;\r\n    }\r\n    if (evt === 'ctrl shift z' || (evt === 'ctrl y')) {\r\n        if (!ide.isAppMode) {ide.currentSprite.scripts.redrop(); }\r\n         return;\r\n    }\r\n    if (evt === 'ctrl n') {\r\n        if (!ide.isAppMode) {ide.createNewProject(); }\r\n        return;\r\n    }\r\n    if (evt === 'ctrl o') {\r\n        if (!ide.isAppMode) {ide.openProjectsBrowser(); }\r\n        return;\r\n    }\r\n    if (evt === 'ctrl s') {\r\n        if (!ide.isAppMode) {ide.save(); }\r\n        return;\r\n    }\r\n    if (evt === 'ctrl shift s') {\r\n        if (!ide.isAppMode) {return ide.saveProjectsBrowser(); }\r\n        return;\r\n    }\r\n    if (evt === 'esc') {\r\n        return this.fireStopAllEvent();\r\n    }\r\n    this.children.concat(this).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            morph.allHatBlocksForKey(evt).forEach(function (block) {\r\n                procs.push(myself.threads.startProcess(\r\n                    block,\r\n                    morph,\r\n                    myself.isThreadSafe\r\n                ));\r\n            });\r\n        }\r\n    });\r\n    return procs;\r\n};\r\n\r\nStageMorph.prototype.removePressedKey = function (key) {\r\n    delete this.keysPressed[key.toLowerCase()];\r\n};\r\n\r\nStageMorph.prototype.processKeyPress = function (event) {\r\n    nop(event);\r\n};\r\n\r\nStageMorph.prototype.inspectKeyEvent\r\n    = CursorMorph.prototype.inspectKeyEvent;\r\n\r\nStageMorph.prototype.fireGreenFlagEvent = function () {\r\n    compteur();//Wiquid green flag trigger counter 1.\r\n    var procs = [],\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        myself = this;\r\n\r\n    this.children.concat(this).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            morph.allHatBlocksFor('__shout__go__').forEach(function (block) {\r\n                procs.push(myself.threads.startProcess(\r\n                    block,\r\n                    morph,\r\n                    myself.isThreadSafe\r\n                ));\r\n            });\r\n        }\r\n    });\r\n    if (ide) {\r\n        ide.controlBar.pauseButton.refresh();\r\n    }\r\n    return procs;\r\n};\r\n\r\nStageMorph.prototype.fireStopAllEvent = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    this.threads.resumeAll(this.stage);\r\n    this.keysPressed = {};\r\n    this.threads.stopAll();\r\n    this.stopAllActiveSounds();\r\n    this.children.forEach(function (morph) {\r\n        if (morph.stopTalking) {\r\n            morph.stopTalking();\r\n        }\r\n    });\r\n    this.removeAllClones();\r\n    if (ide) {\r\n        ide.nextSteps([\r\n            nop,\r\n            function () {ide.controlBar.pauseButton.refresh(); }\r\n        ]);\r\n    }\r\n};\r\n\r\nStageMorph.prototype.removeAllClones = function () {\r\n    var myself = this,\r\n        clones = this.children.filter(\r\n            function (morph) {\r\n                return morph instanceof SpriteMorph && morph.isTemporary;\r\n            }\r\n        );\r\n    clones.forEach(function (clone) {\r\n        myself.threads.stopAllForReceiver(clone);\r\n        clone.detachFromAnchor();\r\n        clone.corpsify();\r\n        clone.destroy();\r\n    });\r\n    this.cloneCount = 0;\r\n};\r\n\r\nStageMorph.prototype.editScripts = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        scripts,\r\n        sorted;\r\n    if (ide.isAppMode || !ScriptsMorph.prototype.enableKeyboard) {return; }\r\n    scripts = this.parentThatIsA(\r\n        IDE_Morph\r\n    ).currentSprite.scripts.selectForEdit(); // shadow on edit, if inherited\r\n    scripts.edit(scripts.position());\r\n    sorted = scripts.focus.sortedScripts();\r\n    if (sorted.length) {\r\n        scripts.focus.element = sorted[0];\r\n        if (scripts.focus.element instanceof HatBlockMorph) {\r\n            scripts.focus.nextCommand();\r\n        }\r\n    } else {\r\n        scripts.focus.moveBy(new Point(50, 50));\r\n    }\r\n    scripts.focus.fixLayout();\r\n};\r\n\r\n// StageMorph block templates\r\n\r\nStageMorph.prototype.blockTemplates = function (category) {\r\n    var blocks = [], myself = this, varNames, button,\r\n        cat = category || 'motion', txt;\r\n\r\n    function block(selector) {\r\n        if (myself.hiddenPrimitives[selector]) {\r\n            return null;\r\n        }\r\n        var newBlock = SpriteMorph.prototype.blockForSelector(selector, true);\r\n        newBlock.isTemplate = true;\r\n        return newBlock;\r\n    }\r\n\r\n    function variableBlock(varName) {\r\n        var newBlock = SpriteMorph.prototype.variableBlock(varName);\r\n        newBlock.isDraggable = false;\r\n        newBlock.isTemplate = true;\r\n        return newBlock;\r\n    }\r\n\r\n    function watcherToggle(selector) {\r\n        if (myself.hiddenPrimitives[selector]) {\r\n            return null;\r\n        }\r\n        var info = SpriteMorph.prototype.blocks[selector];\r\n        return new ToggleMorph(\r\n            'checkbox',\r\n            this,\r\n            function () {\r\n                myself.toggleWatcher(\r\n                    selector,\r\n                    localize(info.spec),\r\n                    myself.blockColor[info.category]\r\n                );\r\n            },\r\n            null,\r\n            function () {\r\n                return myself.showingWatcher(selector);\r\n            },\r\n            null\r\n        );\r\n    }\r\n\r\n    function variableWatcherToggle(varName) {\r\n        return new ToggleMorph(\r\n            'checkbox',\r\n            this,\r\n            function () {\r\n                myself.toggleVariableWatcher(varName);\r\n            },\r\n            null,\r\n            function () {\r\n                return myself.showingVariableWatcher(varName);\r\n            },\r\n            null\r\n        );\r\n    }\r\n\r\n    function addVar(pair) {\r\n        if (pair) {\r\n            if (myself.isVariableNameInUse(pair[0])) {\r\n                myself.inform('that name is already in use');\r\n            } else {\r\n                myself.addVariable(pair[0], pair[1]);\r\n                myself.toggleVariableWatcher(pair[0], pair[1]);\r\n                myself.blocksCache[cat] = null;\r\n                myself.paletteCache[cat] = null;\r\n                myself.parentThatIsA(IDE_Morph).refreshPalette();\r\n            }\r\n        }\r\n    }\r\n\r\n    if (cat === 'motion') {\r\n\r\n        txt = new TextMorph(localize(\r\n            'Stage selected:\\nno motion primitives'\r\n        ));\r\n        txt.fontSize = 9;\r\n        txt.setColor(this.paletteTextColor);\r\n        blocks.push(txt);\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'looks') {\r\n\r\n        blocks.push(block('doSwitchToCostume'));\r\n        blocks.push(block('doWearNextCostume'));\r\n        blocks.push(watcherToggle('getCostumeIdx'));\r\n        blocks.push(block('getCostumeIdx'));\r\n        blocks.push('-');\r\n        blocks.push(block('changeEffect'));\r\n        blocks.push(block('setEffect'));\r\n        blocks.push(block('clearEffects'));\r\n        blocks.push('-');\r\n        blocks.push(block('show'));\r\n        blocks.push(block('hide'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('log'));\r\n            blocks.push(block('alert'));\r\n            blocks.push('-');\r\n            blocks.push(block('doScreenshot'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'sound') {\r\n\r\n        blocks.push(block('playSound'));\r\n        blocks.push(block('doPlaySoundUntilDone'));\r\n        blocks.push(block('doStopAllSounds'));\r\n        blocks.push('-');\r\n        blocks.push(block('doRest'));\r\n        blocks.push(block('doPlayNote'));\r\n        blocks.push(block('doSetInstrument'));\r\n        blocks.push('-');\r\n        blocks.push(block('doChangeTempo'));\r\n        blocks.push(block('doSetTempo'));\r\n        blocks.push(watcherToggle('getTempo'));\r\n        blocks.push(block('getTempo'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'pen') {\r\n\r\n        blocks.push(block('clear'));\r\n        blocks.push(block('reportPenTrailsAsCostume'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'control') {\r\n\r\n        blocks.push(block('receiveGo'));\r\n        blocks.push(block('receiveKey'));\r\n        blocks.push(block('receiveInteraction'));\r\n        blocks.push(block('receiveCondition'));\r\n        blocks.push(block('receiveMessage'));\r\n        blocks.push('-');\r\n        blocks.push(block('doBroadcast'));\r\n        blocks.push(block('doBroadcastAndWait'));\r\n        blocks.push(watcherToggle('getLastMessage'));\r\n        blocks.push(block('getLastMessage'));\r\n        blocks.push('-');\r\n        blocks.push(block('doWarp'));\r\n        blocks.push('-');\r\n        blocks.push(block('doWait'));\r\n        blocks.push(block('doWaitUntil'));\r\n        blocks.push('-');\r\n        blocks.push(block('doForever'));\r\n        blocks.push(block('doRepeat'));\r\n        blocks.push(block('doUntil'));\r\n        blocks.push('-');\r\n        blocks.push(block('doIf'));\r\n        blocks.push(block('doIfElse'));\r\n        blocks.push('-');\r\n        blocks.push(block('doReport'));\r\n    \r\n        blocks.push(block('doStopThis'));\r\n        blocks.push(block('doStopOthers'));\r\n        blocks.push('-');\r\n        blocks.push(block('doRun'));\r\n        blocks.push(block('fork'));\r\n        blocks.push(block('evaluate'));\r\n        blocks.push('-');\r\n        blocks.push(block('doTellTo'));\r\n        blocks.push(block('reportAskFor'));\r\n        blocks.push('-');\r\n        blocks.push(block('doCallCC'));\r\n        blocks.push(block('reportCallCC'));\r\n        blocks.push('-');\r\n        blocks.push(block('createClone'));\r\n        blocks.push(block('newClone'));\r\n        blocks.push('-');\r\n        blocks.push(block('doPauseAll'));\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'sensing') {\r\n\r\n        blocks.push(block('doAsk'));\r\n        blocks.push(watcherToggle('getLastAnswer'));\r\n        blocks.push(block('getLastAnswer'));\r\n        blocks.push('-');\r\n        blocks.push(watcherToggle('reportMouseX'));\r\n        blocks.push(block('reportMouseX'));\r\n        blocks.push(watcherToggle('reportMouseY'));\r\n        blocks.push(block('reportMouseY'));\r\n        blocks.push(block('reportMouseDown'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportKeyPressed'));\r\n        blocks.push('-');\r\n        blocks.push(block('doResetTimer'));\r\n        blocks.push(watcherToggle('getTimer'));\r\n        blocks.push(block('getTimer'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportAttributeOf'));\r\n\r\n        if (SpriteMorph.prototype.enableFirstClass) {\r\n            blocks.push(block('reportGet'));\r\n        }\r\n        blocks.push('-');\r\n\r\n        blocks.push(block('reportURL'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportIsFastTracking'));\r\n        blocks.push(block('doSetFastTracking'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportDate'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(watcherToggle('reportThreadCount'));\r\n            blocks.push(block('reportThreadCount'));\r\n            blocks.push(block('colorFiltered'));\r\n            blocks.push(block('reportStackSize'));\r\n            blocks.push(block('reportFrameCount'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'operators') {\r\n\r\n        blocks.push(block('reifyScript'));\r\n        blocks.push(block('reifyReporter'));\r\n        blocks.push(block('reifyPredicate'));\r\n        blocks.push('#');\r\n        blocks.push('-');\r\n        blocks.push(block('reportSum'));\r\n        blocks.push(block('reportDifference'));\r\n        blocks.push(block('reportProduct'));\r\n        blocks.push(block('reportQuotient'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportModulus'));\r\n        blocks.push(block('reportRound'));\r\n        blocks.push(block('reportMonadic'));\r\n        blocks.push(block('reportRandom'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportLessThan'));\r\n        blocks.push(block('reportEquals'));\r\n        blocks.push(block('reportGreaterThan'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportAnd'));\r\n        blocks.push(block('reportOr'));\r\n        blocks.push(block('reportNot'));\r\n        blocks.push(block('reportBoolean'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportJoinWords'));\r\n        blocks.push(block('reportTextSplit'));\r\n        blocks.push(block('reportLetter'));\r\n        blocks.push(block('reportStringSize'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportUnicode'));\r\n        blocks.push(block('reportUnicodeAsLetter'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportIsA'));\r\n        blocks.push(block('reportIsIdentical'));\r\n\r\n        if (true) { // (Process.prototype.enableJS) {\r\n            blocks.push('-');\r\n            blocks.push(block('reportJSFunction'));\r\n        }\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(\r\n                'development mode \\ndebugging primitives:'\r\n            );\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('reportTypeOf'));\r\n            blocks.push(block('reportTextFunction'));\r\n        }\r\n\r\n    //////////////////////////////////\r\n\r\n        blocks.push('=');\r\n        blocks.push(this.makeBlockButton(cat));\r\n\r\n    } else if (cat === 'variables') {\r\n\r\n        button = new PushButtonMorph(\r\n            null,\r\n            function () {\r\n                new VariableDialogMorph(\r\n                    null,\r\n                    addVar,\r\n                    myself\r\n                ).prompt(\r\n                    'Variable name',\r\n                    null,\r\n                    myself.world()\r\n                );\r\n            },\r\n            'Make a variable'\r\n        );\r\n        blocks.push(button);\r\n\r\n        if (this.variables.allNames().length > 0) {\r\n            button = new PushButtonMorph(\r\n                null,\r\n                function () {\r\n                    var menu = new MenuMorph(\r\n                        myself.deleteVariable,\r\n                        null,\r\n                        myself\r\n                    );\r\n                    myself.variables.allNames().forEach(function (name) {\r\n                        menu.addItem(name, name);\r\n                    });\r\n                    menu.popUpAtHand(myself.world());\r\n                },\r\n                'Delete a variable'\r\n            );\r\n            blocks.push(button);\r\n        }\r\n\r\n        blocks.push('-');\r\n\r\n        varNames = this.variables.allNames();\r\n        if (varNames.length > 0) {\r\n            varNames.forEach(function (name) {\r\n                blocks.push(variableWatcherToggle(name));\r\n                blocks.push(variableBlock(name));\r\n            });\r\n            blocks.push('-');\r\n        }\r\n\r\n        blocks.push(block('doSetVar'));\r\n        blocks.push(block('doChangeVar'));\r\n        blocks.push(block('doShowVar'));\r\n        blocks.push(block('doHideVar'));\r\n        blocks.push(block('doDeclareVariables'));\r\n        blocks.push('=');\r\n        blocks.push(block('reportNewList'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportCONS'));\r\n        blocks.push(block('reportListItem'));\r\n        blocks.push(block('reportCDR'));\r\n        blocks.push('-');\r\n        blocks.push(block('reportListLength'));\r\n        blocks.push(block('reportListContainsItem'));\r\n        blocks.push('-');\r\n        blocks.push(block('doAddToList'));\r\n        blocks.push(block('doDeleteFromList'));\r\n        blocks.push(block('doInsertInList'));\r\n        blocks.push(block('doReplaceInList'));\r\n\r\n    // for debugging: ///////////////\r\n\r\n        if (this.world().isDevMode) {\r\n            blocks.push('-');\r\n            txt = new TextMorph(localize(\r\n                'development mode \\ndebugging primitives:'\r\n            ));\r\n            txt.fontSize = 9;\r\n            txt.setColor(this.paletteTextColor);\r\n            blocks.push(txt);\r\n            blocks.push('-');\r\n            blocks.push(block('reportMap'));\r\n            blocks.push('-');\r\n            blocks.push(block('doForEach'));\r\n            blocks.push(block('doShowTable'));\r\n        }\r\n\r\n    /////////////////////////////////\r\n\r\n        blocks.push('=');\r\n\r\n        if (StageMorph.prototype.enableCodeMapping) {\r\n            blocks.push(block('doMapCodeOrHeader'));\r\n            blocks.push(block('doMapValueCode'));\r\n            blocks.push(block('doMapListCode'));\r\n            blocks.push('-');\r\n            blocks.push(block('reportMappedCode'));\r\n            blocks.push('=');\r\n        }\r\n\r\n        blocks.push(this.makeBlockButton());\r\n    }\r\n    return blocks;\r\n};\r\n\r\n// StageMorph primitives\r\n\r\nStageMorph.prototype.clear = function () {\r\n    this.clearPenTrails();\r\n};\r\n\r\n// StageMorph user menu\r\n\r\nStageMorph.prototype.userMenu = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        menu = new MenuMorph(this),\r\n        myself = this;\r\n\r\n    if (ide && ide.isAppMode) {\r\n        // menu.addItem('help', 'nop');\r\n        return menu;\r\n    }\r\n    menu.addItem(\"edit\", 'edit');\r\n    menu.addItem(\"show all\", 'showAll');\r\n    menu.addItem(\r\n        \"pic...\",\r\n        function () {\r\n            ide.saveCanvasAs(\r\n                myself.fullImageClassic(),\r\n                myself.name\r\n            );\r\n        },\r\n        'open a new window\\nwith a picture of the stage'\r\n    );\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'pen trails',\r\n        function () {\r\n            var costume = ide.currentSprite.reportPenTrailsAsCostume().copy();\r\n            ide.currentSprite.addCostume(costume);\r\n            ide.currentSprite.wearCostume(costume);\r\n            ide.hasChangedMedia = true;\r\n            ide.spriteBar.tabBar.tabTo('costumes');\r\n        },\r\n        ide.currentSprite instanceof SpriteMorph ?\r\n            'turn all pen trails and stamps\\n' +\r\n                'into a new costume for the\\ncurrently selected sprite'\r\n                    : 'turn all pen trails and stamps\\n' +\r\n                        'into a new background for the stage'\r\n    );\r\n    return menu;\r\n};\r\n\r\nStageMorph.prototype.showAll = function () {\r\n    var myself = this;\r\n    this.children.forEach(function (m) {\r\n        if (m instanceof SpriteMorph) {\r\n            if (!m.anchor) {\r\n                m.show();\r\n                m.keepWithin(myself);\r\n            }\r\n        } else {\r\n            m.show();\r\n            m.keepWithin(myself);\r\n            if (m.fixLayout) {m.fixLayout(); }\r\n        }\r\n    });\r\n};\r\n\r\nStageMorph.prototype.edit = SpriteMorph.prototype.edit;\r\n\r\n// StageMorph thumbnail\r\n\r\nStageMorph.prototype.thumbnail = function (extentPoint, excludedSprite) {\r\n/*\r\n    answer a new Canvas of extentPoint dimensions containing\r\n    my thumbnail representation keeping the originial aspect ratio\r\n*/\r\n    var myself = this,\r\n        src = this.image,\r\n        scale = Math.min(\r\n            (extentPoint.x / src.width),\r\n            (extentPoint.y / src.height)\r\n        ),\r\n        trg = newCanvas(extentPoint),\r\n        ctx = trg.getContext('2d'),\r\n        fb,\r\n        fimg;\r\n\r\n    ctx.scale(scale, scale);\r\n    ctx.drawImage(\r\n        src,\r\n        0,\r\n        0\r\n    );\r\n    ctx.drawImage(\r\n        this.penTrails(),\r\n        0,\r\n        0,\r\n        this.dimensions.x * this.scale,\r\n        this.dimensions.y * this.scale\r\n    );\r\n    this.children.forEach(function (morph) {\r\n        if (morph.isVisible && (morph !== excludedSprite)) {\r\n            fb = morph.fullBounds();\r\n            fimg = morph.fullImage();\r\n            if (fimg.width && fimg.height) {\r\n                ctx.drawImage(\r\n                    morph.fullImage(),\r\n                    fb.origin.x - myself.bounds.origin.x,\r\n                    fb.origin.y - myself.bounds.origin.y\r\n                );\r\n            }\r\n        }\r\n    });\r\n    return trg;\r\n};\r\n\r\n// StageMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children.\r\n*/\r\n\r\nStageMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n};\r\n\r\nStageMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n};\r\n\r\n// StageMorph cloning override\r\n\r\nStageMorph.prototype.createClone = nop;\r\nStageMorph.prototype.newClone = nop;\r\n\r\n// StageMorph pseudo-inherited behavior\r\n\r\nStageMorph.prototype.categories = SpriteMorph.prototype.categories;\r\nStageMorph.prototype.blockColor = SpriteMorph.prototype.blockColor;\r\nStageMorph.prototype.paletteColor = SpriteMorph.prototype.paletteColor;\r\nStageMorph.prototype.setName = SpriteMorph.prototype.setName;\r\nStageMorph.prototype.makeBlockButton = SpriteMorph.prototype.makeBlockButton;\r\nStageMorph.prototype.makeBlock = SpriteMorph.prototype.makeBlock;\r\nStageMorph.prototype.palette = SpriteMorph.prototype.palette;\r\nStageMorph.prototype.freshPalette = SpriteMorph.prototype.freshPalette;\r\nStageMorph.prototype.blocksMatching = SpriteMorph.prototype.blocksMatching;\r\nStageMorph.prototype.searchBlocks = SpriteMorph.prototype.searchBlocks;\r\nStageMorph.prototype.reporterize = SpriteMorph.prototype.reporterize;\r\nStageMorph.prototype.showingWatcher = SpriteMorph.prototype.showingWatcher;\r\nStageMorph.prototype.addVariable = SpriteMorph.prototype.addVariable;\r\nStageMorph.prototype.deleteVariable = SpriteMorph.prototype.deleteVariable;\r\n\r\n// StageMorph block rendering\r\n\r\nStageMorph.prototype.doScreenshot\r\n    = SpriteMorph.prototype.doScreenshot;\r\n\r\nStageMorph.prototype.newCostumeName\r\n    = SpriteMorph.prototype.newCostumeName;\r\n\r\nStageMorph.prototype.blockForSelector\r\n    = SpriteMorph.prototype.blockForSelector;\r\n\r\n// StageMorph variable watchers (for palette checkbox toggling)\r\n\r\nStageMorph.prototype.findVariableWatcher\r\n    = SpriteMorph.prototype.findVariableWatcher;\r\n\r\nStageMorph.prototype.toggleVariableWatcher\r\n    = SpriteMorph.prototype.toggleVariableWatcher;\r\n\r\nStageMorph.prototype.showingVariableWatcher\r\n    = SpriteMorph.prototype.showingVariableWatcher;\r\n\r\nStageMorph.prototype.deleteVariableWatcher\r\n    = SpriteMorph.prototype.deleteVariableWatcher;\r\n\r\n// StageMorph background management\r\n\r\nStageMorph.prototype.addCostume\r\n    = SpriteMorph.prototype.addCostume;\r\n\r\nStageMorph.prototype.wearCostume\r\n    = SpriteMorph.prototype.wearCostume;\r\n\r\nStageMorph.prototype.getCostumeIdx\r\n    = SpriteMorph.prototype.getCostumeIdx;\r\n\r\nStageMorph.prototype.doWearNextCostume\r\n    = SpriteMorph.prototype.doWearNextCostume;\r\n\r\nStageMorph.prototype.doWearPreviousCostume\r\n    = SpriteMorph.prototype.doWearPreviousCostume;\r\n\r\nStageMorph.prototype.doSwitchToCostume\r\n    = SpriteMorph.prototype.doSwitchToCostume;\r\n\r\nStageMorph.prototype.reportCostumes\r\n    = SpriteMorph.prototype.reportCostumes;\r\n\r\n// StageMorph graphic effects\r\n\r\nStageMorph.prototype.graphicsChanged\r\n    = SpriteMorph.prototype.graphicsChanged;\r\n\r\nStageMorph.prototype.applyGraphicsEffects\r\n    = SpriteMorph.prototype.applyGraphicsEffects;\r\n\r\nStageMorph.prototype.setEffect\r\n    = SpriteMorph.prototype.setEffect;\r\n\r\nStageMorph.prototype.getGhostEffect\r\n    = SpriteMorph.prototype.getGhostEffect;\r\n\r\nStageMorph.prototype.changeEffect\r\n    = SpriteMorph.prototype.changeEffect;\r\n\r\nStageMorph.prototype.clearEffects\r\n    = SpriteMorph.prototype.clearEffects;\r\n\r\n// StageMorph sound management\r\n\r\nStageMorph.prototype.addSound\r\n    = SpriteMorph.prototype.addSound;\r\n\r\nStageMorph.prototype.playSound\r\n    = SpriteMorph.prototype.playSound;\r\n\r\nStageMorph.prototype.stopAllActiveSounds = function () {\r\n    this.activeSounds.forEach(function (audio) {\r\n        audio.pause();\r\n    });\r\n    this.activeSounds = [];\r\n};\r\n\r\nStageMorph.prototype.pauseAllActiveSounds = function () {\r\n    this.activeSounds.forEach(function (audio) {\r\n        audio.pause();\r\n    });\r\n};\r\n\r\nStageMorph.prototype.resumeAllActiveSounds = function () {\r\n    this.activeSounds.forEach(function (audio) {\r\n        audio.play();\r\n    });\r\n};\r\n\r\nStageMorph.prototype.reportSounds\r\n    = SpriteMorph.prototype.reportSounds;\r\n\r\n// StageMorph non-variable watchers\r\n\r\nStageMorph.prototype.toggleWatcher\r\n    = SpriteMorph.prototype.toggleWatcher;\r\n\r\nStageMorph.prototype.showingWatcher\r\n    = SpriteMorph.prototype.showingWatcher;\r\n\r\nStageMorph.prototype.watcherFor =\r\n    SpriteMorph.prototype.watcherFor;\r\n\r\nStageMorph.prototype.getLastAnswer\r\n    = SpriteMorph.prototype.getLastAnswer;\r\n\r\nStageMorph.prototype.reportThreadCount\r\n    = SpriteMorph.prototype.reportThreadCount;\r\n\r\n// StageMorph message broadcasting\r\n\r\nStageMorph.prototype.allMessageNames\r\n    = SpriteMorph.prototype.allMessageNames;\r\n\r\nStageMorph.prototype.allHatBlocksFor\r\n    = SpriteMorph.prototype.allHatBlocksFor;\r\n\r\nStageMorph.prototype.allHatBlocksForKey\r\n    = SpriteMorph.prototype.allHatBlocksForKey;\r\n\r\nStageMorph.prototype.allHatBlocksForInteraction\r\n    = SpriteMorph.prototype.allHatBlocksForInteraction;\r\n\r\nStageMorph.prototype.allGenericHatBlocks\r\n    = SpriteMorph.prototype.allGenericHatBlocks;\r\n\r\n// StageMorph events\r\n\r\nStageMorph.prototype.mouseClickLeft\r\n    = SpriteMorph.prototype.mouseClickLeft;\r\n\r\nStageMorph.prototype.mouseEnter\r\n    = SpriteMorph.prototype.mouseEnter;\r\n\r\nStageMorph.prototype.mouseLeave = function () {\r\n    this.receiveUserInteraction('mouse-departed');\r\n};\r\n\r\nStageMorph.prototype.mouseDownLeft\r\n    = SpriteMorph.prototype.mouseDownLeft;\r\n\r\nStageMorph.prototype.receiveUserInteraction\r\n    = SpriteMorph.prototype.receiveUserInteraction;\r\n\r\n// StageMorph custom blocks\r\n\r\nStageMorph.prototype.deleteAllBlockInstances\r\n    = SpriteMorph.prototype.deleteAllBlockInstances;\r\n\r\nStageMorph.prototype.allBlockInstances\r\n    = SpriteMorph.prototype.allBlockInstances;\r\n\r\nStageMorph.prototype.allLocalBlockInstances\r\n    = SpriteMorph.prototype.allLocalBlockInstances;\r\n\r\nStageMorph.prototype.allEditorBlockInstances\r\n    = SpriteMorph.prototype.allEditorBlockInstances;\r\n\r\nStageMorph.prototype.paletteBlockInstance\r\n    = SpriteMorph.prototype.paletteBlockInstance;\r\n\r\nStageMorph.prototype.usesBlockInstance\r\n    = SpriteMorph.prototype.usesBlockInstance;\r\n\r\nStageMorph.prototype.doubleDefinitionsFor\r\n    = SpriteMorph.prototype.doubleDefinitionsFor;\r\n\r\nStageMorph.prototype.replaceDoubleDefinitionsFor\r\n    = SpriteMorph.prototype.replaceDoubleDefinitionsFor;\r\n\r\nStageMorph.prototype.allInvocationsOf\r\n    = SpriteMorph.prototype.allInvocationsOf;\r\n\r\nStageMorph.prototype.allIndependentInvocationsOf\r\n    = SpriteMorph.prototype.allInvocationsOf;\r\n\r\nStageMorph.prototype.allDependentInvocationsOf\r\n    = SpriteMorph.prototype.allInvocationsOf;\r\n\r\n// StageMorph inheritance support - general\r\n\r\nStageMorph.prototype.specimens = function () {\r\n    return [];\r\n};\r\n\r\nStageMorph.prototype.allSpecimens = function () {\r\n    return [];\r\n};\r\n\r\nStageMorph.prototype.shadowAttribute = nop;\r\n\r\n// StageMorph inheritance support - attributes\r\n\r\nStageMorph.prototype.inheritsAttribute = function () {\r\n    return false;\r\n};\r\n\r\n// StageMorph inheritance support - variables\r\n\r\nStageMorph.prototype.isVariableNameInUse\r\n    = SpriteMorph.prototype.isVariableNameInUse;\r\n\r\nStageMorph.prototype.globalVariables\r\n    = SpriteMorph.prototype.globalVariables;\r\n\r\nStageMorph.prototype.inheritedVariableNames = function () {\r\n    return [];\r\n};\r\n\r\n// StageMorph inheritance - custom blocks\r\n\r\nStageMorph.prototype.getMethod\r\n    = SpriteMorph.prototype.getMethod;\r\n\r\nStageMorph.prototype.getLocalMethod\r\n    = SpriteMorph.prototype.getLocalMethod;\r\n\r\nStageMorph.prototype.ownBlocks\r\n    = SpriteMorph.prototype.ownBlocks;\r\n\r\nStageMorph.prototype.allBlocks = function (valuesOnly) {\r\n    var dict = this.ownBlocks();\r\n    if (valuesOnly) {\r\n        return Object.keys(dict).map(function (key) {return dict[key]; });\r\n    }\r\n    return dict;\r\n};\r\n\r\nStageMorph.prototype.inheritedBlocks = function () {\r\n    return [];\r\n};\r\n\r\n// StageMorph variable refactoring\r\n\r\nStageMorph.prototype.hasSpriteVariable\r\n    = SpriteMorph.prototype.hasSpriteVariable;\r\n\r\nStageMorph.prototype.refactorVariableInstances\r\n    = SpriteMorph.prototype.refactorVariableInstances;\r\n\r\n// StageMorph pen trails as costume\r\n\r\nStageMorph.prototype.reportPenTrailsAsCostume = function () {\r\n    return new Costume(\r\n        this.trailsCanvas,\r\n        this.newCostumeName(localize('Background'))\r\n    );\r\n};\r\n\r\n// SpriteBubbleMorph ////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a sprite's scaleable speech bubble. I rely on SpriteMorph\r\n    for my preferences settings\r\n*/\r\n\r\n// SpriteBubbleMorph inherits from SpeechBubbleMorph:\r\n\r\nSpriteBubbleMorph.prototype = new SpeechBubbleMorph();\r\nSpriteBubbleMorph.prototype.constructor = SpriteBubbleMorph;\r\nSpriteBubbleMorph.uber = SpeechBubbleMorph.prototype;\r\n\r\n// SpriteBubbleMorph instance creation:\r\n\r\nfunction SpriteBubbleMorph(data, stage, isThought, isQuestion) {\r\n    this.init(data, stage, isThought, isQuestion);\r\n}\r\n\r\nSpriteBubbleMorph.prototype.init = function (\r\n    data,\r\n    stage,\r\n    isThought,\r\n    isQuestion\r\n) {\r\n    var sprite = SpriteMorph.prototype;\r\n    this.stage = stage;\r\n    this.scale = stage ? stage.scale : 1;\r\n    this.data = data;\r\n    this.isQuestion = isQuestion;\r\n\r\n    SpriteBubbleMorph.uber.init.call(\r\n        this,\r\n        this.dataAsMorph(data),\r\n        sprite.bubbleColor,\r\n        null,\r\n        null,\r\n        isQuestion ? sprite.blockColor.sensing : sprite.bubbleBorderColor,\r\n        null,\r\n        isThought\r\n    );\r\n};\r\n\r\n// SpriteBubbleMorph contents formatting\r\n\r\nSpriteBubbleMorph.prototype.dataAsMorph = function (data, toggle) {\r\n    var contents,\r\n        isTable,\r\n        sprite = SpriteMorph.prototype,\r\n        isText,\r\n        img,\r\n        scaledImg,\r\n        width;\r\n    if (data instanceof Morph) {\r\n        if (isSnapObject(data)) {\r\n            img = data.thumbnail(new Point(40, 40));\r\n            contents = new Morph();\r\n            contents.silentSetWidth(img.width);\r\n            contents.silentSetHeight(img.height);\r\n            contents.image = img;\r\n            contents.version = data.version;\r\n            contents.step = function () {\r\n                if (this.version !== data.version) {\r\n                    img = data.thumbnail(new Point(40, 40));\r\n                    this.image = img;\r\n                    this.version = data.version;\r\n                    this.changed();\r\n                }\r\n            };\r\n        } else {\r\n            contents = data;\r\n        }\r\n    } else if (isString(data)) {\r\n        isText = true;\r\n        contents = new TextMorph(\r\n            data,\r\n            sprite.bubbleFontSize * this.scale,\r\n            null, // fontStyle\r\n            sprite.bubbleFontIsBold,\r\n            false, // italic\r\n            'center'\r\n        );\r\n    } else if (typeof data === 'boolean') {\r\n        img = sprite.booleanMorph(data).fullImage();\r\n        contents = new Morph();\r\n        contents.silentSetWidth(img.width);\r\n        contents.silentSetHeight(img.height);\r\n        contents.image = img;\r\n    } else if (data instanceof Costume) {\r\n        img = data.thumbnail(new Point(40, 40));\r\n        contents = new Morph();\r\n        contents.silentSetWidth(img.width);\r\n        contents.silentSetHeight(img.height);\r\n        contents.image = img;\r\n    } else if (data instanceof Sound) {\r\n        contents = new SymbolMorph('notes', 30);\r\n    } else if (data instanceof HTMLCanvasElement) {\r\n        contents = new Morph();\r\n        contents.silentSetWidth(data.width);\r\n        contents.silentSetHeight(data.height);\r\n        contents.image = data;\r\n    } else if (data instanceof List) {\r\n        if (toggle && this.contentsMorph) {\r\n            isTable = (this.contentsMorph instanceof ListWatcherMorph);\r\n        } else {\r\n            isTable = data.isTable();\r\n        }\r\n\r\n        if (isTable) { // (!toggle && data.isTable()) {\r\n            contents = new TableFrameMorph(new TableMorph(data, 10));\r\n            if (this.stage) {\r\n                contents.expand(this.stage.extent().translateBy(\r\n                    -2 * (this.edge + this.border + this.padding)\r\n                ));\r\n            }\r\n        } else {\r\n            contents = new ListWatcherMorph(data);\r\n            contents.update(true);\r\n            contents.step = contents.update;\r\n            if (this.stage) {\r\n                contents.expand(this.stage.extent().translateBy(\r\n                    -2 * (this.edge + this.border + this.padding)\r\n                ));\r\n            }\r\n        }\r\n        contents.isDraggable = false;\r\n    } else if (data instanceof Context) {\r\n        img = data.image();\r\n        contents = new Morph();\r\n        contents.silentSetWidth(img.width);\r\n        contents.silentSetHeight(img.height);\r\n        contents.image = img;\r\n    } else {\r\n        contents = new TextMorph(\r\n            data.toString(),\r\n            sprite.bubbleFontSize * this.scale,\r\n            null, // fontStyle\r\n            sprite.bubbleFontIsBold,\r\n            false, // italic\r\n            'center'\r\n        );\r\n    }\r\n    if (contents instanceof TextMorph) {\r\n        // reflow text boundaries\r\n        width = Math.max(\r\n            contents.width(),\r\n            sprite.bubbleCorner * 2 * this.scale\r\n        );\r\n        if (isText) {\r\n            width = Math.min(width, sprite.bubbleMaxTextWidth * this.scale);\r\n        }\r\n        contents.setWidth(width);\r\n    } else if (!(data instanceof List)) {\r\n        // scale contents image\r\n        scaledImg = newCanvas(contents.extent().multiplyBy(this.scale));\r\n        scaledImg.getContext('2d').drawImage(\r\n            contents.image,\r\n            0,\r\n            0,\r\n            scaledImg.width,\r\n            scaledImg.height\r\n        );\r\n        contents.image = scaledImg;\r\n        contents.bounds = contents.bounds.scaleBy(this.scale);\r\n    }\r\n    return contents;\r\n};\r\n\r\n// SpriteBubbleMorph scaling\r\n\r\nSpriteBubbleMorph.prototype.setScale = function (scale) {\r\n    this.scale = scale;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// SpriteBubbleMorph drawing:\r\n\r\nSpriteBubbleMorph.prototype.drawNew = function (toggle) {\r\n    var sprite = SpriteMorph.prototype;\r\n\r\n    // scale my settings\r\n    this.edge = sprite.bubbleCorner * this.scale;\r\n    this.border = sprite.bubbleBorder * this.scale;\r\n    this.padding = sprite.bubbleCorner / 2 * this.scale;\r\n\r\n    // re-build my contents\r\n    if (this.contentsMorph) {\r\n        this.contentsMorph.destroy();\r\n    }\r\n    this.contentsMorph = this.dataAsMorph(this.data, toggle);\r\n    this.add(this.contentsMorph);\r\n\r\n    // adjust my layout\r\n    this.silentSetWidth(this.contentsMorph.width()\r\n        + (this.padding ? this.padding * 2 : this.edge * 2));\r\n    this.silentSetHeight(this.contentsMorph.height()\r\n        + this.edge\r\n        + this.border * 2\r\n        + this.padding * 2\r\n        + 2);\r\n\r\n    // draw my outline\r\n    SpeechBubbleMorph.uber.drawNew.call(this);\r\n\r\n    // position my contents\r\n    this.contentsMorph.setPosition(this.position().add(\r\n        new Point(\r\n            this.padding || this.edge,\r\n            this.border + this.padding + 1\r\n        )\r\n    ));\r\n};\r\n\r\n// SpriteBubbleMorph resizing:\r\n\r\nSpriteBubbleMorph.prototype.fixLayout = function () {\r\n    // to be used when resizing list watchers\r\n    // otherwise use drawNew() to force re-layout\r\n\r\n    var sprite = SpriteMorph.prototype;\r\n\r\n    this.changed();\r\n    // scale my settings\r\n    this.edge = sprite.bubbleCorner * this.scale;\r\n    this.border = sprite.bubbleBorder * this.scale;\r\n    this.padding = sprite.bubbleCorner / 2 * this.scale;\r\n\r\n    // adjust my layout\r\n    this.silentSetWidth(this.contentsMorph.width()\r\n        + (this.padding ? this.padding * 2 : this.edge * 2));\r\n    this.silentSetHeight(this.contentsMorph.height()\r\n        + this.edge\r\n        + this.border * 2\r\n        + this.padding * 2\r\n        + 2);\r\n\r\n    // draw my outline\r\n    SpeechBubbleMorph.uber.drawNew.call(this);\r\n\r\n    // position my contents\r\n    this.contentsMorph.setPosition(this.position().add(\r\n        new Point(\r\n            this.padding || this.edge,\r\n            this.border + this.padding + 1\r\n        )\r\n    ));\r\n    this.changed();\r\n};\r\n\r\n// Costume /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a picture that's \"wearable\" by a sprite. My rotationCenter is\r\n    relative to my contents position.\r\n*/\r\n\r\n// Costume instance creation\r\n\r\nfunction Costume(canvas, name, rotationCenter) {\r\n    this.contents = canvas ? normalizeCanvas(canvas, true)\r\n            : newCanvas(null, true);\r\n    this.shrinkToFit(this.maxExtent());\r\n    this.name = name || null;\r\n    this.rotationCenter = rotationCenter || this.center();\r\n    this.version = Date.now(); // for observer optimization\r\n    this.loaded = null; // for de-serialization only\r\n}\r\n\r\nCostume.prototype.maxExtent = function () {\r\n    return StageMorph.prototype.dimensions;\r\n};\r\n\r\nCostume.prototype.toString = function () {\r\n    return 'a Costume(' + this.name + ')';\r\n};\r\n\r\n// Costume dimensions - all relative\r\n\r\nCostume.prototype.extent = function () {\r\n    return new Point(this.contents.width, this.contents.height);\r\n};\r\n\r\nCostume.prototype.center = function () {\r\n    return this.extent().divideBy(2);\r\n};\r\n\r\nCostume.prototype.width = function () {\r\n    return this.contents.width;\r\n};\r\n\r\nCostume.prototype.height = function () {\r\n    return this.contents.height;\r\n};\r\n\r\nCostume.prototype.bounds = function () {\r\n    return new Rectangle(0, 0, this.width(), this.height());\r\n};\r\n\r\n// Costume shrink-wrapping\r\n\r\nCostume.prototype.shrinkWrap = function () {\r\n    // adjust my contents'  bounds to my visible bounding box\r\n    var bb = this.boundingBox(),\r\n        ext = bb.extent(),\r\n        pic = newCanvas(ext, true),\r\n        ctx = pic.getContext('2d');\r\n\r\n    ctx.drawImage(\r\n        this.contents,\r\n        bb.origin.x,\r\n        bb.origin.y,\r\n        ext.x,\r\n        ext.y,\r\n        0,\r\n        0,\r\n        ext.x,\r\n        ext.y\r\n    );\r\n    this.rotationCenter = this.rotationCenter.subtract(bb.origin);\r\n    this.contents = pic;\r\n    this.version = Date.now();\r\n};\r\n\r\nCostume.prototype.canvasBoundingBox = function (pic) {\r\n    // answer the rectangle surrounding my contents' non-transparent pixels\r\n    var row,\r\n        col,\r\n        w = pic.width,\r\n        h = pic.height,\r\n        ctx = pic.getContext('2d'),\r\n        dta = ctx.getImageData(0, 0, w, h);\r\n\r\n    function getAlpha(x, y) {\r\n        return dta.data[((y * w * 4) + (x * 4)) + 3];\r\n    }\r\n\r\n    function getLeft() {\r\n        for (col = 0; col <= w; col += 1) {\r\n            for (row = 0; row <= h; row += 1) {\r\n                if (getAlpha(col, row)) {\r\n                    return col;\r\n                }\r\n            }\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    function getTop() {\r\n        for (row = 0; row <= h; row += 1) {\r\n            for (col = 0; col <= w; col += 1) {\r\n                if (getAlpha(col, row)) {\r\n                    return row;\r\n                }\r\n            }\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    function getRight() {\r\n        for (col = w; col >= 0; col -= 1) {\r\n            for (row = h; row >= 0; row -= 1) {\r\n                if (getAlpha(col, row)) {\r\n                    return Math.min(col + 1, w);\r\n                }\r\n            }\r\n        }\r\n        return w;\r\n    }\r\n\r\n    function getBottom() {\r\n        for (row = h; row >= 0; row -= 1) {\r\n            for (col = w; col >= 0; col -= 1) {\r\n                if (getAlpha(col, row)) {\r\n                    return Math.min(row + 1, h);\r\n                }\r\n            }\r\n        }\r\n        return h;\r\n    }\r\n\r\n    return new Rectangle(getLeft(), getTop(), getRight(), getBottom());\r\n};\r\n\r\nCostume.prototype.boundingBox = function () {\r\n    return this.canvasBoundingBox(this.contents);\r\n};\r\n\r\n// Costume duplication\r\n\r\nCostume.prototype.copy = function () {\r\n    var canvas = newCanvas(this.extent(), true),\r\n        cpy,\r\n        ctx;\r\n    ctx = canvas.getContext('2d');\r\n    ctx.drawImage(this.contents, 0, 0);\r\n    cpy = new Costume(canvas, this.name ? copy(this.name) : null);\r\n    cpy.rotationCenter = this.rotationCenter.copy();\r\n    return cpy;\r\n};\r\n\r\n// Costume flipping\r\n\r\nCostume.prototype.flipped = function () {\r\n/*\r\n    answer a copy of myself flipped horizontally\r\n    (mirrored along a vertical axis), used for\r\n    SpriteMorph's rotation style type 2\r\n*/\r\n    var canvas = newCanvas(this.extent(), true),\r\n        ctx = canvas.getContext('2d'),\r\n        flipped;\r\n\r\n    ctx.translate(this.width(), 0);\r\n    ctx.scale(-1, 1);\r\n    ctx.drawImage(this.contents, 0, 0);\r\n    flipped = new Costume(\r\n        canvas,\r\n        this.name,\r\n        new Point(\r\n            this.width() - this.rotationCenter.x,\r\n            this.rotationCenter.y\r\n        )\r\n    );\r\n    return flipped;\r\n};\r\n\r\n// Costume actions\r\n\r\nCostume.prototype.edit = function (aWorld, anIDE, isnew, oncancel, onsubmit) {\r\n    var myself = this,\r\n        editor = new PaintEditorMorph();\r\n    editor.oncancel = oncancel || nop;\r\n    editor.openIn(\r\n        aWorld,\r\n        isnew ?\r\n                newCanvas(StageMorph.prototype.dimensions, true) :\r\n                this.contents,\r\n        isnew ?\r\n                null :\r\n                this.rotationCenter,\r\n        function (img, rc) {\r\n            myself.contents = img;\r\n            myself.rotationCenter = rc;\r\n            myself.version = Date.now();\r\n            aWorld.changed();\r\n            if (anIDE) {\r\n                if (anIDE.currentSprite instanceof SpriteMorph) {\r\n                    // don't shrinkwrap stage costumes\r\n                    myself.shrinkWrap();\r\n                }\r\n                anIDE.currentSprite.wearCostume(myself, true); // don't shadow\r\n                anIDE.hasChangedMedia = true;\r\n            }\r\n            (onsubmit || nop)();\r\n        }\r\n    );\r\n};\r\n\r\nCostume.prototype.editRotationPointOnly = function (aWorld) {\r\n    var editor = new CostumeEditorMorph(this),\r\n        action,\r\n        dialog,\r\n        txt;\r\n\r\n    action = function () {editor.accept(); };\r\n    dialog = new DialogBoxMorph(this, action);\r\n    txt = new TextMorph(\r\n        localize('click or drag crosshairs to move the rotation center'),\r\n        dialog.fontSize,\r\n        dialog.fontStyle,\r\n        true,\r\n        false,\r\n        'center',\r\n        null,\r\n        null,\r\n        new Point(1, 1),\r\n        new Color(255, 255, 255)\r\n    );\r\n\r\n    dialog.labelString = 'Costume Editor';\r\n    dialog.createLabel();\r\n    dialog.setPicture(editor);\r\n    dialog.addBody(txt);\r\n    dialog.addButton('ok', 'Ok');\r\n    dialog.addButton('cancel', 'Cancel');\r\n    dialog.fixLayout();\r\n    dialog.drawNew();\r\n    dialog.fixLayout();\r\n    dialog.popUp(aWorld);\r\n};\r\n\r\n// Costume thumbnail\r\n\r\nCostume.prototype.shrinkToFit = function (extentPoint) {\r\n    if (extentPoint.x < this.width() || (extentPoint.y < this.height())) {\r\n        this.contents = this.thumbnail(extentPoint);\r\n    }\r\n};\r\n\r\nCostume.prototype.thumbnail = function (extentPoint) {\r\n/*\r\n    answer a new Canvas of extentPoint dimensions containing\r\n    my thumbnail representation keeping the originial aspect ratio\r\n*/\r\n    var src = this.contents, // at this time sprites aren't composite morphs\r\n        scale = Math.min(\r\n            (extentPoint.x / src.width),\r\n            (extentPoint.y / src.height)\r\n        ),\r\n        xOffset = (extentPoint.x - (src.width * scale)) / 2,\r\n        yOffset = (extentPoint.y - (src.height * scale)) / 2,\r\n        trg = newCanvas(extentPoint),\r\n        ctx = trg.getContext('2d');\r\n\r\n    if (!src || src.width + src.height === 0) {return trg; }\r\n    ctx.scale(scale, scale);\r\n    ctx.drawImage(\r\n        src,\r\n        Math.floor(xOffset / scale),\r\n        Math.floor(yOffset / scale)\r\n    );\r\n    return trg;\r\n};\r\n\r\n// Costume catching \"tainted\" canvases\r\n\r\nCostume.prototype.isTainted = function () {\r\n    // find out whether the canvas has been tainted by cross-origin data\r\n    // assumes that if reading image data throws an error it is tainted\r\n    try {\r\n        this.contents.getContext('2d').getImageData(\r\n            0,\r\n            0,\r\n            this.contents.width,\r\n            this.contents.height\r\n        );\r\n    } catch (err) {\r\n        return true;\r\n    }\r\n    return false;\r\n};\r\n\r\n// SVG_Costume /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a costume containing an SVG image.\r\n*/\r\n\r\n// SVG_Costume inherits from Costume:\r\n\r\nSVG_Costume.prototype = new Costume();\r\nSVG_Costume.prototype.constructor = SVG_Costume;\r\nSVG_Costume.uber = Costume.prototype;\r\n\r\n// SVG_Costume instance creation\r\n\r\nfunction SVG_Costume(svgImage, name, rotationCenter) {\r\n    this.contents = svgImage;\r\n    this.shrinkToFit(this.maxExtent());\r\n    this.name = name || null;\r\n    this.rotationCenter = rotationCenter || this.center();\r\n    this.version = Date.now(); // for observer optimization\r\n    this.loaded = null; // for de-serialization only\r\n}\r\n\r\nSVG_Costume.prototype.toString = function () {\r\n    return 'an SVG_Costume(' + this.name + ')';\r\n};\r\n\r\n// SVG_Costume duplication\r\n\r\nSVG_Costume.prototype.copy = function () {\r\n    var img = new Image(),\r\n        cpy;\r\n    img.src = this.contents.src;\r\n    cpy = new SVG_Costume(img, this.name ? copy(this.name) : null);\r\n    cpy.rotationCenter = this.rotationCenter.copy();\r\n    return cpy;\r\n};\r\n\r\n// SVG_Costume flipping\r\n\r\n/*\r\n    flipping is currently inherited from Costume, which rasterizes it.\r\n    Therefore flipped SVG costumes may appear pixelated until we add\r\n    a method to either truly flip SVGs or change the Sprite's drawNew()\r\n    method to scale the costume before flipping it\r\n*/\r\n\r\n// SVG_Costume thumbnail\r\n\r\nSVG_Costume.prototype.shrinkToFit = function (extentPoint) {\r\n    // overridden for unrasterized SVGs\r\n    nop(extentPoint);\r\n    return;\r\n};\r\n\r\n// CostumeEditorMorph ////////////////////////////////////////////////////////\r\n\r\n// CostumeEditorMorph inherits from Morph:\r\n\r\nCostumeEditorMorph.prototype = new Morph();\r\nCostumeEditorMorph.prototype.constructor = CostumeEditorMorph;\r\nCostumeEditorMorph.uber = Morph.prototype;\r\n\r\n// CostumeEditorMorph preferences settings:\r\nCostumeEditorMorph.prototype.size = Costume.prototype.maxExtent();\r\n\r\n// CostumeEditorMorph instance creation\r\n\r\nfunction CostumeEditorMorph(costume) {\r\n    this.init(costume);\r\n}\r\n\r\nCostumeEditorMorph.prototype.init = function (costume) {\r\n    this.costume = costume || new Costume();\r\n    this.rotationCenter = this.costume.rotationCenter.copy();\r\n    this.margin = new Point(0, 0);\r\n    CostumeEditorMorph.uber.init.call(this);\r\n    this.noticesTransparentClick = true;\r\n};\r\n\r\n// CostumeEditorMorph edit ops\r\n\r\nCostumeEditorMorph.prototype.accept = function () {\r\n    this.costume.rotationCenter = this.rotationCenter.copy();\r\n    this.costume.version = Date.now();\r\n};\r\n\r\n// CostumeEditorMorph displaying\r\n\r\nCostumeEditorMorph.prototype.drawNew = function () {\r\n    var rp, ctx;\r\n\r\n    this.margin = this.size.subtract(this.costume.extent()).divideBy(2);\r\n    rp = this.rotationCenter.add(this.margin);\r\n\r\n    this.silentSetExtent(this.size);\r\n\r\n    this.image = newCanvas(this.extent());\r\n\r\n    // draw the background\r\n    if (!this.cachedTexture) {\r\n        this.cachedTexture = this.createTexture();\r\n\r\n    }\r\n    this.drawCachedTexture();\r\n\r\n    ctx = this.image.getContext('2d');\r\n\r\n    // draw the costume\r\n    ctx.drawImage(this.costume.contents, this.margin.x, this.margin.y);\r\n\r\n    // draw crosshairs:\r\n    ctx.globalAlpha = 0.5;\r\n\r\n    // circle around center:\r\n    ctx.fillStyle = 'white';\r\n    ctx.beginPath();\r\n    ctx.arc(\r\n        rp.x,\r\n        rp.y,\r\n        20,\r\n        radians(0),\r\n        radians(360),\r\n        false\r\n    );\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    ctx.stroke();\r\n\r\n    ctx.beginPath();\r\n    ctx.arc(\r\n        rp.x,\r\n        rp.y,\r\n        10,\r\n        radians(0),\r\n        radians(360),\r\n        false\r\n    );\r\n    ctx.stroke();\r\n\r\n    // horizontal line:\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, rp.y);\r\n    ctx.lineTo(this.costume.width() + this.margin.x * 2, rp.y);\r\n    ctx.stroke();\r\n\r\n    // vertical line:\r\n    ctx.beginPath();\r\n    ctx.moveTo(rp.x, 0);\r\n    ctx.lineTo(rp.x, this.costume.height() + this.margin.y * 2);\r\n    ctx.stroke();\r\n};\r\n\r\nCostumeEditorMorph.prototype.createTexture = function () {\r\n    var size = 5,\r\n        texture = newCanvas(new Point(size * 2, size * 2)),\r\n        ctx = texture.getContext('2d'),\r\n        grey = new Color(230, 230, 230);\r\n\r\n    ctx.fillStyle = 'white';\r\n    ctx.fillRect(0, 0, size * 2, size * 2);\r\n    ctx.fillStyle = grey.toString();\r\n    ctx.fillRect(0, 0, size, size);\r\n    ctx.fillRect(size, size, size, size);\r\n    return texture;\r\n};\r\n\r\n\r\n// CostumeEditorMorph events\r\n\r\nCostumeEditorMorph.prototype.mouseDownLeft = function (pos) {\r\n    this.rotationCenter = pos.subtract(\r\n        this.position().add(this.margin)\r\n    );\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nCostumeEditorMorph.prototype.mouseMove\r\n    = CostumeEditorMorph.prototype.mouseDownLeft;\r\n\r\n// Sound /////////////////////////////////////////////////////////////\r\n\r\n// Sound instance creation\r\n\r\nfunction Sound(audio, name) {\r\n    this.audio = audio; // mandatory\r\n    this.name = name || \"Sound\";\r\n}\r\n\r\nSound.prototype.play = function () {\r\n    // return an instance of an audio element which can be terminated\r\n    // externally (i.e. by the stage)\r\n    var aud = document.createElement('audio');\r\n    aud.src = this.audio.src;\r\n    aud.play();\r\n    return aud;\r\n};\r\n\r\nSound.prototype.copy = function () {\r\n    var snd = document.createElement('audio'),\r\n        cpy;\r\n\r\n    snd.src = this.audio.src;\r\n    cpy = new Sound(snd, this.name ? copy(this.name) : null);\r\n    return cpy;\r\n};\r\n\r\nSound.prototype.toDataURL = function () {\r\n    return this.audio.src;\r\n};\r\n\r\n// Note /////////////////////////////////////////////////////////\r\n\r\n// I am a single musical note\r\n\r\n// Note instance creation\r\n\r\nfunction Note(pitch) {\r\n    this.pitch = pitch === 0 ? 0 : pitch || 69;\r\n    this.setupContext();\r\n    this.oscillator = null;\r\n}\r\n\r\n// Note shared properties\r\n\r\nNote.prototype.audioContext = null;\r\nNote.prototype.gainNode = null;\r\n\r\n// Note audio context\r\n\r\nNote.prototype.setupContext = function () {\r\n    if (this.audioContext) { return; }\r\n    var AudioContext = (function () {\r\n        // cross browser some day?\r\n        var ctx = window.AudioContext ||\r\n            window.mozAudioContext ||\r\n            window.msAudioContext ||\r\n            window.oAudioContext ||\r\n            window.webkitAudioContext;\r\n        if (!ctx.prototype.createGain) {\r\n            ctx.prototype.createGain = ctx.prototype.createGainNode;\r\n        }\r\n        return ctx;\r\n    }());\r\n    if (!AudioContext) {\r\n        throw new Error('Web Audio API is not supported\\nin this browser');\r\n    }\r\n    Note.prototype.audioContext = new AudioContext();\r\n    Note.prototype.gainNode = Note.prototype.audioContext.createGain();\r\n    Note.prototype.gainNode.gain.value = 0.25; // reduce volume by 1/4\r\n};\r\n\r\n// Note playing\r\n\r\nNote.prototype.play = function (type) {\r\n    this.oscillator = this.audioContext.createOscillator();\r\n    if (!this.oscillator.start) {\r\n        this.oscillator.start = this.oscillator.noteOn;\r\n    }\r\n    if (!this.oscillator.stop) {\r\n        this.oscillator.stop = this.oscillator.noteOff;\r\n    }\r\n    this.oscillator.type = [\r\n        'sine',\r\n        'square',\r\n        'sawtooth',\r\n        'triangle'\r\n    ][(type || 1) - 1];\r\n    this.oscillator.frequency.value =\r\n        Math.pow(2, (this.pitch - 69) / 12) * 440;\r\n    this.oscillator.connect(this.gainNode);\r\n    this.gainNode.connect(this.audioContext.destination);\r\n    this.oscillator.start(0);\r\n};\r\n\r\nNote.prototype.stop = function () {\r\n    if (this.oscillator) {\r\n        this.oscillator.stop(0);\r\n        this.oscillator = null;\r\n    }\r\n};\r\n\r\n// CellMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a spreadsheet style cell that can display either a string,\r\n    a Morph, a Canvas or a toString() representation of anything else.\r\n    I can be used in variable watchers or list view element cells.\r\n*/\r\n\r\n// CellMorph inherits from BoxMorph:\r\n\r\nCellMorph.prototype = new BoxMorph();\r\nCellMorph.prototype.constructor = CellMorph;\r\nCellMorph.uber = BoxMorph.prototype;\r\n\r\n// CellMorph instance creation:\r\n\r\nfunction CellMorph(contents, color, idx, parentCell) {\r\n    this.init(contents, color, idx, parentCell);\r\n}\r\n\r\nCellMorph.prototype.init = function (contents, color, idx, parentCell) {\r\n    this.contents = (contents === 0 ? 0\r\n            : contents === false ? false\r\n                    : contents || '');\r\n    this.isEditable = isNil(idx) ? false : true;\r\n    this.idx = idx || null; // for list watchers\r\n    this.parentCell = parentCell || null; // for list circularity detection\r\n    CellMorph.uber.init.call(\r\n        this,\r\n        SyntaxElementMorph.prototype.corner,\r\n        1.000001, // shadow bug in Chrome,\r\n        new Color(255, 255, 255)\r\n    );\r\n    this.color = color || new Color(255, 140, 0);\r\n    this.isBig = false;\r\n    this.version = null; // only for observing sprites\r\n    this.drawNew();\r\n};\r\n\r\n// CellMorph accessing:\r\n\r\nCellMorph.prototype.big = function () {\r\n    this.isBig = true;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nCellMorph.prototype.normal = function () {\r\n    this.isBig = false;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// CellMorph circularity testing:\r\n\r\n\r\nCellMorph.prototype.isCircular = function (list) {\r\n    if (!this.parentCell) {return false; }\r\n    if (list instanceof List) {\r\n        return this.contents === list || this.parentCell.isCircular(list);\r\n    }\r\n    return this.parentCell.isCircular(this.contents);\r\n};\r\n\r\n// CellMorph layout:\r\n\r\nCellMorph.prototype.fixLayout = function () {\r\n    var listwatcher;\r\n    this.changed();\r\n    this.drawNew();\r\n    this.changed();\r\n    if (this.parent && this.parent.fixLayout) { // variable watcher\r\n        this.parent.fixLayout();\r\n    } else {\r\n        listwatcher = this.parentThatIsA(ListWatcherMorph);\r\n        if (listwatcher) {\r\n            listwatcher.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\n// CellMorph drawing:\r\n\r\nCellMorph.prototype.update = function () {\r\n    // special case for observing sprites\r\n    if (!isSnapObject(this.contents)) {\r\n        return;\r\n    }\r\n    if (this.version !== this.contents.version) {\r\n        this.drawNew();\r\n    }\r\n};\r\n\r\nCellMorph.prototype.drawNew = function (toggle, type) {\r\n    var context,\r\n        txt,\r\n        img,\r\n        fontSize = SyntaxElementMorph.prototype.fontSize,\r\n        isSameList = this.contentsMorph instanceof ListWatcherMorph\r\n                && (this.contentsMorph.list === this.contents),\r\n        isSameTable = this.contentsMorph instanceof TableFrameMorph\r\n                && (this.contentsMorph.tableMorph.table === this.contents);\r\n\r\n    if (this.isBig) {\r\n        fontSize = fontSize * 1.5;\r\n    }\r\n\r\n    // re-build my contents\r\n    if (toggle || (this.contentsMorph && !isSameList && !isSameTable)) {\r\n        this.contentsMorph.destroy();\r\n        this.version = null;\r\n    }\r\n\r\n    if (toggle || (!isSameList && !isSameTable)) {\r\n        if (this.contents instanceof Morph) {\r\n            if (isSnapObject(this.contents)) {\r\n                img = this.contents.thumbnail(new Point(40, 40));\r\n                this.contentsMorph = new Morph();\r\n                this.contentsMorph.silentSetWidth(img.width);\r\n                this.contentsMorph.silentSetHeight(img.height);\r\n                this.contentsMorph.image = img;\r\n                this.version = this.contents.version;\r\n            } else {\r\n                this.contentsMorph = this.contents;\r\n            }\r\n        } else if (isString(this.contents)) {\r\n            txt  = this.contents.length > 500 ?\r\n                    this.contents.slice(0, 500) + '...' : this.contents;\r\n            this.contentsMorph = new TextMorph(\r\n                txt,\r\n                fontSize,\r\n                null,\r\n                true,\r\n                false,\r\n                'left' // was formerly 'center', reverted b/c of code-mapping\r\n            );\r\n            if (this.isEditable) {\r\n                this.contentsMorph.isEditable = true;\r\n                this.contentsMorph.enableSelecting();\r\n            }\r\n            this.contentsMorph.setColor(new Color(255, 255, 255));\r\n        } else if (typeof this.contents === 'boolean') {\r\n            img = SpriteMorph.prototype.booleanMorph.call(\r\n                null,\r\n                this.contents\r\n            ).fullImage();\r\n            this.contentsMorph = new Morph();\r\n            this.contentsMorph.silentSetWidth(img.width);\r\n            this.contentsMorph.silentSetHeight(img.height);\r\n            this.contentsMorph.image = img;\r\n        } else if (this.contents instanceof HTMLCanvasElement) {\r\n            this.contentsMorph = new Morph();\r\n            this.contentsMorph.silentSetWidth(this.contents.width);\r\n            this.contentsMorph.silentSetHeight(this.contents.height);\r\n            this.contentsMorph.image = this.contents;\r\n        } else if (this.contents instanceof Context) {\r\n            img = this.contents.image();\r\n            this.contentsMorph = new Morph();\r\n            this.contentsMorph.silentSetWidth(img.width);\r\n            this.contentsMorph.silentSetHeight(img.height);\r\n            this.contentsMorph.image = img;\r\n        } else if (this.contents instanceof Costume) {\r\n            img = this.contents.thumbnail(new Point(40, 40));\r\n            this.contentsMorph = new Morph();\r\n            this.contentsMorph.silentSetWidth(img.width);\r\n            this.contentsMorph.silentSetHeight(img.height);\r\n            this.contentsMorph.image = img;\r\n        } else if (this.contents instanceof Sound) {\r\n            this.contentsMorph = new SymbolMorph('notes', 30);\r\n        } else if (this.contents instanceof List) {\r\n            if ('table' === type || (!toggle && this.contents.isTable())) {\r\n                this.contentsMorph = new TableFrameMorph(new TableMorph(\r\n                    this.contents,\r\n                    10\r\n                ));\r\n                this.contentsMorph.expand(new Point(200, 150));\r\n            } else {\r\n                if (this.isCircular()) {\r\n                    this.contentsMorph = new TextMorph(\r\n                        '(...)',\r\n                        fontSize,\r\n                        null,\r\n                        false, // bold\r\n                        true, // italic\r\n                        'center'\r\n                    );\r\n                    this.contentsMorph.setColor(new Color(255, 255, 255));\r\n                } else {\r\n                    this.contentsMorph = new ListWatcherMorph(\r\n                        this.contents,\r\n                        this\r\n                    );\r\n                }\r\n            }\r\n            this.contentsMorph.isDraggable = false;\r\n        } else {\r\n            this.contentsMorph = new TextMorph(\r\n                !isNil(this.contents) ? this.contents.toString() : '',\r\n                fontSize,\r\n                null,\r\n                true,\r\n                false,\r\n                'center'\r\n            );\r\n            if (this.isEditable) {\r\n                this.contentsMorph.isEditable = true;\r\n                this.contentsMorph.enableSelecting();\r\n            }\r\n            this.contentsMorph.setColor(new Color(255, 255, 255));\r\n        }\r\n        this.add(this.contentsMorph);\r\n    }\r\n\r\n    // adjust my layout\r\n    this.silentSetHeight(this.contentsMorph.height()\r\n        + this.edge\r\n        + this.border * 2);\r\n    this.silentSetWidth(Math.max(\r\n        this.contentsMorph.width() + this.edge * 2,\r\n        (this.contents instanceof Context ||\r\n            this.contents instanceof List ? 0 :\r\n                    SyntaxElementMorph.prototype.fontSize * 3.5)\r\n    ));\r\n\r\n    // draw my outline\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if ((this.edge === 0) && (this.border === 0)) {\r\n        BoxMorph.uber.drawNew.call(this);\r\n        return null;\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        Math.max(this.edge - this.border, 0),\r\n        this.border\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n    if (this.border > 0 && !MorphicPreferences.isFlat) {\r\n        context.lineWidth = this.border;\r\n        context.strokeStyle = this.borderColor.toString();\r\n        context.beginPath();\r\n        this.outlinePath(context, this.edge, this.border / 2);\r\n        context.closePath();\r\n        context.stroke();\r\n\r\n        context.shadowOffsetX = this.border;\r\n        context.shadowOffsetY = this.border;\r\n        context.shadowBlur = this.border;\r\n        context.shadowColor = this.color.darker(80).toString();\r\n        this.drawShadow(context, this.edge, this.border / 2);\r\n    }\r\n\r\n    // position my contents\r\n    if (toggle || (!isSameList && !isSameTable)) {\r\n        this.contentsMorph.setCenter(this.center());\r\n    }\r\n};\r\n\r\nCellMorph.prototype.drawShadow = function (context, radius, inset) {\r\n    var offset = radius + inset,\r\n        w = this.width(),\r\n        h = this.height();\r\n\r\n    // bottom left:\r\n    context.beginPath();\r\n    context.moveTo(0, h - offset);\r\n    context.lineTo(0, offset);\r\n    context.stroke();\r\n\r\n    // top left:\r\n    context.beginPath();\r\n    context.arc(\r\n        offset,\r\n        offset,\r\n        radius,\r\n        radians(-180),\r\n        radians(-90),\r\n        false\r\n    );\r\n    context.stroke();\r\n\r\n    // top right:\r\n    context.beginPath();\r\n    context.moveTo(offset, 0);\r\n    context.lineTo(w - offset, 0);\r\n    context.stroke();\r\n};\r\n\r\n// CellMorph editing (inside list watchers):\r\n\r\nCellMorph.prototype.layoutChanged = function () {\r\n    var context,\r\n        fontSize = SyntaxElementMorph.prototype.fontSize,\r\n        listWatcher = this.parentThatIsA(ListWatcherMorph);\r\n\r\n    if (this.isBig) {\r\n        fontSize = fontSize * 1.5;\r\n    }\r\n\r\n    // adjust my layout\r\n    this.silentSetHeight(this.contentsMorph.height()\r\n        + this.edge\r\n        + this.border * 2);\r\n    this.silentSetWidth(Math.max(\r\n        this.contentsMorph.width() + this.edge * 2,\r\n        (this.contents instanceof Context ||\r\n            this.contents instanceof List ? 0 : this.height() * 2)\r\n    ));\r\n\r\n\r\n    // draw my outline\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if ((this.edge === 0) && (this.border === 0)) {\r\n        BoxMorph.uber.drawNew.call(this);\r\n        return null;\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        Math.max(this.edge - this.border, 0),\r\n        this.border\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n    if (this.border > 0 && !MorphicPreferences.isFlat) {\r\n        context.lineWidth = this.border;\r\n        context.strokeStyle = this.borderColor.toString();\r\n        context.beginPath();\r\n        this.outlinePath(context, this.edge, this.border / 2);\r\n        context.closePath();\r\n        context.stroke();\r\n\r\n        context.shadowOffsetX = this.border;\r\n        context.shadowOffsetY = this.border;\r\n        context.shadowBlur = this.border;\r\n        context.shadowColor = this.color.darker(80).toString();\r\n        this.drawShadow(context, this.edge, this.border / 2);\r\n    }\r\n\r\n    // position my contents\r\n    this.contentsMorph.setCenter(this.center());\r\n\r\n    if (listWatcher) {\r\n        listWatcher.fixLayout();\r\n    }\r\n};\r\n\r\nCellMorph.prototype.reactToEdit = function (textMorph) {\r\n    var listWatcher;\r\n    if (!isNil(this.idx)) {\r\n        listWatcher = this.parentThatIsA(ListWatcherMorph);\r\n        if (listWatcher) {\r\n            listWatcher.list.put(textMorph.text, this.idx);\r\n        }\r\n    }\r\n};\r\n\r\nCellMorph.prototype.mouseClickLeft = function (pos) {\r\n    if (this.isEditable && this.contentsMorph instanceof TextMorph) {\r\n        this.contentsMorph.selectAllAndEdit();\r\n    } else {\r\n        this.escalateEvent('mouseClickLeft', pos);\r\n    }\r\n};\r\n\r\nCellMorph.prototype.mouseDoubleClick = function (pos) {\r\n    if (List.prototype.enableTables &&\r\n            this.currentValue instanceof List) {\r\n        new TableDialogMorph(this.contents).popUp(this.world());\r\n    } else {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    }\r\n};\r\n\r\n// WatcherMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a little window which observes some value and continuously\r\n    updates itself accordingly.\r\n\r\n    My target can be either a SpriteMorph or a VariableFrame.\r\n*/\r\n\r\n// WatcherMorph inherits from BoxMorph:\r\n\r\nWatcherMorph.prototype = new BoxMorph();\r\nWatcherMorph.prototype.constructor = WatcherMorph;\r\nWatcherMorph.uber = BoxMorph.prototype;\r\n\r\n// WatcherMorph instance creation:\r\n\r\nfunction WatcherMorph(label, color, target, getter, isHidden) {\r\n    this.init(label, color, target, getter, isHidden);\r\n}\r\n\r\nWatcherMorph.prototype.init = function (\r\n    label,\r\n    color,\r\n    target,\r\n    getter,\r\n    isHidden\r\n) {\r\n    // additional properties\r\n    this.labelText = label || '';\r\n    this.version = null;\r\n    this.objName = '';\r\n\r\n    // initialize inherited properties\r\n    WatcherMorph.uber.init.call(\r\n        this,\r\n        SyntaxElementMorph.prototype.rounding,\r\n        1.000001, // shadow bug in Chrome,\r\n        new Color(120, 120, 120)\r\n    );\r\n\r\n    // override inherited behavior\r\n    this.color = new Color(220, 220, 220);\r\n    this.readoutColor = color;\r\n    this.style = 'normal';\r\n    this.target = target || null; // target obj (Sprite) or VariableFrame\r\n    this.getter = getter || null; // callback or variable name (string)\r\n    this.currentValue = null;\r\n    this.labelMorph = null;\r\n    this.sliderMorph = null;\r\n    this.cellMorph = null;\r\n    this.isDraggable = true;\r\n    this.fixLayout();\r\n    this.update();\r\n    if (isHidden) { // for de-serializing\r\n        this.hide();\r\n    }\r\n};\r\n\r\n// WatcherMorph accessing:\r\n\r\nWatcherMorph.prototype.isTemporary = function () {\r\n    var stage = this.parentThatIsA(StageMorph);\r\n    if (this.target instanceof VariableFrame) {\r\n        if (stage) {\r\n            if (this.target === stage.variables.parentFrame) {\r\n                return false; // global\r\n            }\r\n        }\r\n        return this.target.owner === null;\r\n    }\r\n    return false;\r\n};\r\n\r\nWatcherMorph.prototype.object = function () {\r\n    // answer the actual sprite I refer to\r\n    return this.target instanceof VariableFrame ?\r\n            this.target.owner : this.target;\r\n};\r\n\r\nWatcherMorph.prototype.isGlobal = function (selector) {\r\n    return contains(\r\n        ['getLastAnswer', 'getLastMessage', 'getTempo', 'getTimer',\r\n             'reportMouseX', 'reportMouseY', 'reportThreadCount'],\r\n        selector\r\n    );\r\n};\r\n\r\n// WatcherMorph slider accessing:\r\n\r\nWatcherMorph.prototype.setSliderMin = function (num, noUpdate) {\r\n    if (this.target instanceof VariableFrame) {\r\n        this.sliderMorph.setSize(1, noUpdate);\r\n        this.sliderMorph.setStart(num, noUpdate);\r\n        this.sliderMorph.setSize(this.sliderMorph.rangeSize() / 5, noUpdate);\r\n    }\r\n};\r\n\r\nWatcherMorph.prototype.setSliderMax = function (num, noUpdate) {\r\n    if (this.target instanceof VariableFrame) {\r\n        this.sliderMorph.setSize(1, noUpdate);\r\n        this.sliderMorph.setStop(num, noUpdate);\r\n        this.sliderMorph.setSize(this.sliderMorph.rangeSize() / 5, noUpdate);\r\n    }\r\n};\r\n\r\n// WatcherMorph updating:\r\n\r\nWatcherMorph.prototype.update = function () {\r\n    var newValue, sprite, num, att,\r\n        isGhosted = false;\r\n\r\n    if (this.target && this.getter) {\r\n        this.updateLabel();\r\n        if (this.target instanceof VariableFrame) {\r\n            newValue = this.target.vars[this.getter] ?\r\n                    this.target.vars[this.getter].value : undefined;\r\n            if (newValue === undefined && this.target.owner) {\r\n                sprite = this.target.owner;\r\n                if (contains(sprite.inheritedVariableNames(), this.getter)) {\r\n                    newValue = this.target.getVar(this.getter);\r\n                    // ghost cell color\r\n                    this.cellMorph.setColor(\r\n                        SpriteMorph.prototype.blockColor.variables\r\n                            .lighter(35)\r\n                    );\r\n                } else {\r\n                    this.destroy();\r\n                    return;\r\n                }\r\n            } else {\r\n                // un-ghost the cell color\r\n                this.cellMorph.setColor(\r\n                    SpriteMorph.prototype.blockColor.variables\r\n                );\r\n            }\r\n        } else {\r\n            newValue = this.target[this.getter]();\r\n\r\n            // determine whether my getter is an inherited attribute\r\n            att = {\r\n                xPosition: 'x position',\r\n                yPosition: 'y position',\r\n                direction: 'direction',\r\n                getCostumeIdx: 'costume #',\r\n                getScale: 'size'} [this.getter];\r\n            isGhosted = att ? this.target.inheritsAttribute(att) : false;\r\n        }\r\n        if (newValue !== '' && !isNil(newValue)) {\r\n            num = +newValue;\r\n            if (typeof newValue !== 'boolean' && !isNaN(num)) {\r\n                newValue = Math.round(newValue * 1000000000) / 1000000000;\r\n            }\r\n        }\r\n        if (newValue !== this.currentValue) {\r\n            this.changed();\r\n            this.cellMorph.contents = newValue;\r\n            if (isSnapObject(this.target)) {\r\n                if (isGhosted) {\r\n                    this.cellMorph.setColor(this.readoutColor.lighter(35));\r\n                } else {\r\n                    this.cellMorph.setColor(this.readoutColor);\r\n                }\r\n            }\r\n            this.cellMorph.drawNew();\r\n            if (!isNaN(newValue)) {\r\n                this.sliderMorph.value = newValue;\r\n                this.sliderMorph.drawNew();\r\n            }\r\n            this.fixLayout();\r\n            this.currentValue = newValue;\r\n        }\r\n    }\r\n    if (this.cellMorph.contentsMorph instanceof ListWatcherMorph) {\r\n        this.cellMorph.contentsMorph.update();\r\n    } else if (isSnapObject(this.cellMorph.contents)) {\r\n        this.cellMorph.update();\r\n    }\r\n};\r\n\r\nWatcherMorph.prototype.updateLabel = function () {\r\n    // check whether the target object's name has been changed\r\n    var obj = this.object();\r\n\r\n    if (!obj || this.isGlobal(this.getter)) { return; }\r\n    if (obj.version !== this.version) {\r\n        this.objName = obj.name ? obj.name + ' ' : ' ';\r\n        if (this.labelMorph) {\r\n            this.labelMorph.destroy();\r\n            this.labelMorph = null;\r\n            this.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\n// WatcherMorph layout:\r\n\r\nWatcherMorph.prototype.fixLayout = function () {\r\n    var fontSize = SyntaxElementMorph.prototype.fontSize, isList,\r\n        myself = this;\r\n\r\n    this.changed();\r\n\r\n    // create my parts\r\n    if (this.labelMorph === null) {\r\n        this.labelMorph = new StringMorph(\r\n            this.objName + this.labelText,\r\n            fontSize,\r\n            null,\r\n            true,\r\n            false,\r\n            false,\r\n            MorphicPreferences.isFlat ? new Point() : new Point(1, 1),\r\n            new Color(255, 255, 255)\r\n        );\r\n        this.add(this.labelMorph);\r\n    }\r\n    if (this.cellMorph === null) {\r\n        this.cellMorph = new CellMorph('', this.readoutColor);\r\n        this.add(this.cellMorph);\r\n    }\r\n    if (this.sliderMorph === null) {\r\n        this.sliderMorph = new SliderMorph(\r\n            0,\r\n            100,\r\n            0,\r\n            20,\r\n            'horizontal'\r\n        );\r\n        this.sliderMorph.alpha = 1;\r\n        this.sliderMorph.button.color = this.color.darker();\r\n        this.sliderMorph.color = this.color.lighter(60);\r\n        this.sliderMorph.button.highlightColor = this.color.darker();\r\n        this.sliderMorph.button.highlightColor.b += 50;\r\n        this.sliderMorph.button.pressColor = this.color.darker();\r\n        this.sliderMorph.button.pressColor.b += 100;\r\n        this.sliderMorph.setHeight(fontSize);\r\n        this.sliderMorph.action = function (num) {\r\n            myself.target.setVar(\r\n                myself.getter,\r\n                Math.round(num),\r\n                myself.target.owner\r\n            );\r\n        };\r\n        this.add(this.sliderMorph);\r\n    }\r\n\r\n    // adjust my layout\r\n    isList = this.cellMorph.contents instanceof List;\r\n    if (isList) { this.style = 'normal'; }\r\n\r\n    if (this.style === 'large') {\r\n        this.labelMorph.hide();\r\n        this.sliderMorph.hide();\r\n        this.cellMorph.big();\r\n        this.cellMorph.setPosition(this.position());\r\n        this.setExtent(this.cellMorph.extent().subtract(1));\r\n        return;\r\n    }\r\n\r\n    this.labelMorph.show();\r\n    this.sliderMorph.show();\r\n    this.cellMorph.normal();\r\n    this.labelMorph.setPosition(this.position().add(new Point(\r\n        this.edge,\r\n        this.border + SyntaxElementMorph.prototype.typeInPadding\r\n    )));\r\n\r\n    if (isList) {\r\n        this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(\r\n            new Point(0, SyntaxElementMorph.prototype.typeInPadding)\r\n        ));\r\n    } else {\r\n        this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(\r\n            fontSize / 3,\r\n            0\r\n        )));\r\n        this.labelMorph.setTop(\r\n            this.cellMorph.top()\r\n                + (this.cellMorph.height() - this.labelMorph.height()) / 2\r\n        );\r\n    }\r\n\r\n    if (this.style === 'slider') {\r\n        this.sliderMorph.silentSetPosition(new Point(\r\n            this.labelMorph.left(),\r\n            this.cellMorph.bottom()\r\n                + SyntaxElementMorph.prototype.typeInPadding\r\n        ));\r\n        this.sliderMorph.setWidth(this.cellMorph.right()\r\n            - this.labelMorph.left());\r\n        this.silentSetHeight(\r\n            this.cellMorph.height()\r\n                + this.sliderMorph.height()\r\n                + this.border * 2\r\n                + SyntaxElementMorph.prototype.typeInPadding * 3\r\n        );\r\n    } else {\r\n        this.sliderMorph.hide();\r\n        this.bounds.corner.y = this.cellMorph.bottom()\r\n            + this.border\r\n            + SyntaxElementMorph.prototype.typeInPadding;\r\n    }\r\n    this.bounds.corner.x = Math.max(\r\n        this.cellMorph.right(),\r\n        this.labelMorph.right()\r\n    ) + this.edge\r\n        + SyntaxElementMorph.prototype.typeInPadding;\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\n// WatcherMorph events:\r\n\r\nWatcherMorph.prototype.mouseDoubleClick = function (pos) {\r\n    if (List.prototype.enableTables &&\r\n            this.currentValue instanceof List) {\r\n        new TableDialogMorph(this.currentValue).popUp(this.world());\r\n    } else {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    }\r\n};\r\n\r\n// WatcherMorph dragging and dropping:\r\n\r\nWatcherMorph.prototype.rootForGrab = function () {\r\n    // prevent watchers to be dragged in presentation mode\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide && ide.isAppMode) {\r\n        return ide;\r\n    }\r\n    return this;\r\n};\r\n\r\n\r\n// WatcherMorph user menu:\r\n\r\nWatcherMorph.prototype.userMenu = function () {\r\n    var myself = this,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        menu = new MenuMorph(this),\r\n        on = '\\u25CF',\r\n        off = '\\u25CB',\r\n        vNames;\r\n\r\n    function monitor(vName) {\r\n        var stage = myself.parentThatIsA(StageMorph),\r\n            varFrame = myself.currentValue.outerContext.variables;\r\n        menu.addItem(\r\n            vName + '...',\r\n            function () {\r\n                var watcher = detect(\r\n                    stage.children,\r\n                    function (morph) {\r\n                        return morph instanceof WatcherMorph\r\n                            && morph.target === varFrame\r\n                            && morph.getter === vName;\r\n                    }\r\n                ),\r\n                    others;\r\n                if (watcher !== null) {\r\n                    watcher.show();\r\n                    watcher.fixLayout(); // re-hide hidden parts\r\n                    return;\r\n                }\r\n                watcher = new WatcherMorph(\r\n                    vName + ' ' + localize('(temporary)'),\r\n                    SpriteMorph.prototype.blockColor.variables,\r\n                    varFrame,\r\n                    vName\r\n                );\r\n                watcher.setPosition(stage.position().add(10));\r\n                others = stage.watchers(watcher.left());\r\n                if (others.length > 0) {\r\n                    watcher.setTop(others[others.length - 1].bottom());\r\n                }\r\n                stage.add(watcher);\r\n                watcher.fixLayout();\r\n            }\r\n        );\r\n    }\r\n\r\n    if (ide && ide.isAppMode) { // prevent context menu in app mode\r\n        return;\r\n    }\r\n\r\n    menu.addItem(\r\n        (this.style === 'normal' ? on : off) + ' ' + localize('normal'),\r\n        'styleNormal'\r\n    );\r\n    menu.addItem(\r\n        (this.style === 'large' ? on : off) + ' ' + localize('large'),\r\n        'styleLarge'\r\n    );\r\n    if (this.target instanceof VariableFrame) {\r\n        menu.addItem(\r\n            (this.style === 'slider' ? on : off) + ' ' + localize('slider'),\r\n            'styleSlider'\r\n        );\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'slider min...',\r\n            'userSetSliderMin'\r\n        );\r\n        menu.addItem(\r\n            'slider max...',\r\n            'userSetSliderMax'\r\n        );\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'import...',\r\n            function () {\r\n                var inp = document.createElement('input'),\r\n                    ide = myself.parentThatIsA(IDE_Morph);\r\n                if (ide.filePicker) {\r\n                    document.body.removeChild(ide.filePicker);\r\n                    ide.filePicker = null;\r\n                }\r\n                inp.type = 'file';\r\n                inp.style.color = \"transparent\";\r\n                inp.style.backgroundColor = \"transparent\";\r\n                inp.style.border = \"none\";\r\n                inp.style.outline = \"none\";\r\n                inp.style.position = \"absolute\";\r\n                inp.style.top = \"0px\";\r\n                inp.style.left = \"0px\";\r\n                inp.style.width = \"0px\";\r\n                inp.style.height = \"0px\";\r\n                inp.style.display = \"none\";\r\n                inp.addEventListener(\r\n                    \"change\",\r\n                    function () {\r\n                        var file;\r\n                        function txtOnlyMsg(ftype) {\r\n                            ide.inform(\r\n                                'Unable to import',\r\n                                'Snap! can only import \"text\" files.\\n' +\r\n                                    'You selected a file of type \"' +\r\n                                    ftype +\r\n                                    '\".'\r\n                            );\r\n                        }\r\n\r\n                        function readText(aFile) {\r\n                            var frd = new FileReader();\r\n                            frd.onloadend = function (e) {\r\n                                myself.target.setVar(\r\n                                    myself.getter,\r\n                                    e.target.result\r\n                                );\r\n                            };\r\n\r\n                            if (aFile.type.indexOf(\"text\") === 0) {\r\n                                frd.readAsText(aFile);\r\n                            } else {\r\n                                txtOnlyMsg(aFile.type);\r\n                            }\r\n                        }\r\n\r\n                        document.body.removeChild(inp);\r\n                        ide.filePicker = null;\r\n                        if (inp.files.length > 0) {\r\n                            file = inp.files[inp.files.length - 1];\r\n                            readText(file);\r\n                        }\r\n                    },\r\n                    false\r\n                );\r\n                document.body.appendChild(inp);\r\n                ide.filePicker = inp;\r\n                inp.click();\r\n            }\r\n        );\r\n        if (isString(this.currentValue) || !isNaN(+this.currentValue)) {\r\n            menu.addItem(\r\n                'export...',\r\n                function () {\r\n                    var ide = myself.parentThatIsA(IDE_Morph);\r\n                    ide.saveFileAs(\r\n                        myself.currentValue.toString(),\r\n                        'text/plain;charset=utf-8',\r\n                        myself.getter // variable name\r\n                    );\r\n                }\r\n            );\r\n        } else if (this.currentValue instanceof Context) {\r\n            vNames = this.currentValue.outerContext.variables.names();\r\n            if (vNames.length) {\r\n                menu.addLine();\r\n                vNames.forEach(function (vName) {\r\n                    monitor(vName);\r\n                });\r\n            }\r\n        }\r\n    }\r\n    return menu;\r\n};\r\n\r\nWatcherMorph.prototype.setStyle = function (style) {\r\n    this.style = style;\r\n    this.fixLayout();\r\n};\r\n\r\nWatcherMorph.prototype.styleNormal = function () {\r\n    this.setStyle('normal');\r\n};\r\n\r\nWatcherMorph.prototype.styleLarge = function () {\r\n    this.setStyle('large');\r\n};\r\n\r\nWatcherMorph.prototype.styleSlider = function () {\r\n    this.setStyle('slider');\r\n};\r\n\r\nWatcherMorph.prototype.userSetSliderMin = function () {\r\n    new DialogBoxMorph(\r\n        this,\r\n        this.setSliderMin,\r\n        this\r\n    ).prompt(\r\n        \"Slider minimum value\",\r\n        this.sliderMorph.start.toString(),\r\n        this.world(),\r\n        null, // pic\r\n        null, // choices\r\n        null, // read only\r\n        true // numeric\r\n    );\r\n};\r\n\r\nWatcherMorph.prototype.userSetSliderMax = function () {\r\n    new DialogBoxMorph(\r\n        this,\r\n        this.setSliderMax,\r\n        this\r\n    ).prompt(\r\n        \"Slider maximum value\",\r\n        this.sliderMorph.stop.toString(),\r\n        this.world(),\r\n        null, // pic\r\n        null, // choices\r\n        null, // read only\r\n        true // numeric\r\n    );\r\n};\r\n\r\n// WatcherMorph drawing:\r\n\r\nWatcherMorph.prototype.drawNew = function () {\r\n    var context,\r\n        gradient;\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    if (MorphicPreferences.isFlat || (this.edge === 0 && this.border === 0)) {\r\n        BoxMorph.uber.drawNew.call(this);\r\n        return;\r\n    }\r\n    gradient = context.createLinearGradient(0, 0, 0, this.height());\r\n    gradient.addColorStop(0, this.color.lighter().toString());\r\n    gradient.addColorStop(1, this.color.darker().toString());\r\n    context.fillStyle = gradient;\r\n    context.beginPath();\r\n    this.outlinePath(\r\n        context,\r\n        Math.max(this.edge - this.border, 0),\r\n        this.border\r\n    );\r\n    context.closePath();\r\n    context.fill();\r\n    if (this.border > 0) {\r\n        gradient = context.createLinearGradient(0, 0, 0, this.height());\r\n        gradient.addColorStop(0, this.borderColor.lighter().toString());\r\n        gradient.addColorStop(1, this.borderColor.darker().toString());\r\n        context.lineWidth = this.border;\r\n        context.strokeStyle = gradient;\r\n        context.beginPath();\r\n        this.outlinePath(context, this.edge, this.border / 2);\r\n        context.closePath();\r\n        context.stroke();\r\n    }\r\n};\r\n\r\n// StagePrompterMorph ////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a sensor-category-colored input box at the bottom of the stage\r\n    which lets the user answer to a question. If I am opened from within\r\n    the context of a sprite, my question can be anything that is displayable\r\n    in a SpeechBubble and will be, if I am opened from within the stage\r\n    my question will be shown as a single line of text within my label morph.\r\n*/\r\n\r\n// StagePrompterMorph inherits from BoxMorph:\r\n\r\nStagePrompterMorph.prototype = new BoxMorph();\r\nStagePrompterMorph.prototype.constructor = StagePrompterMorph;\r\nStagePrompterMorph.uber = BoxMorph.prototype;\r\n\r\n// StagePrompterMorph instance creation:\r\n\r\nfunction StagePrompterMorph(question) {\r\n    this.init(question);\r\n}\r\n\r\nStagePrompterMorph.prototype.init = function (question) {\r\n    // question is optional in case the Stage is asking\r\n    var myself = this;\r\n\r\n    // additional properties\r\n    this.isDone = false;\r\n    if (question) {\r\n        this.label = new StringMorph(\r\n            question,\r\n            SpriteMorph.prototype.bubbleFontSize,\r\n            null, // fontStyle\r\n            SpriteMorph.prototype.bubbleFontIsBold,\r\n            false, // italic\r\n            'left'\r\n        );\r\n    } else {\r\n        this.label = null;\r\n    }\r\n    this.inputField = new InputFieldMorph();\r\n    this.button = new PushButtonMorph(\r\n        null,\r\n        function () {myself.accept(); },\r\n        '\\u2713'\r\n    );\r\n\r\n    // initialize inherited properties\r\n    StagePrompterMorph.uber.init.call(\r\n        this,\r\n        SyntaxElementMorph.prototype.rounding,\r\n        SpriteMorph.prototype.bubbleBorder,\r\n        SpriteMorph.prototype.blockColor.sensing\r\n    );\r\n\r\n    // override inherited behavior\r\n    this.color = new Color(255, 255, 255);\r\n    if (this.label) {this.add(this.label); }\r\n    this.add(this.inputField);\r\n    this.add(this.button);\r\n    this.setWidth(StageMorph.prototype.dimensions.x - 20);\r\n    this.fixLayout();\r\n};\r\n\r\n// StagePrompterMorph layout:\r\n\r\nStagePrompterMorph.prototype.fixLayout = function () {\r\n    var y = 0;\r\n    if (this.label) {\r\n        this.label.setPosition(new Point(\r\n            this.left() + this.edge,\r\n            this.top() + this.edge\r\n        ));\r\n        y = this.label.bottom() - this.top();\r\n    }\r\n    this.inputField.setPosition(new Point(\r\n        this.left() + this.edge,\r\n        this.top() + y + this.edge\r\n    ));\r\n    this.inputField.setWidth(\r\n        this.width()\r\n            - this.edge * 2\r\n            - this.button.width()\r\n            - this.border\r\n    );\r\n    this.button.setCenter(this.inputField.center());\r\n    this.button.setLeft(this.inputField.right() + this.border);\r\n    this.setHeight(\r\n        this.inputField.bottom()\r\n            - this.top()\r\n            + this.edge\r\n    );\r\n};\r\n\r\n// StagePrompterMorph events:\r\n\r\nStagePrompterMorph.prototype.mouseClickLeft = function () {\r\n    this.inputField.edit();\r\n};\r\n\r\nStagePrompterMorph.prototype.accept = function () {\r\n    this.isDone = true;\r\n};\r\n//fin de objects.js\r\n/*\r\n\r\n    gui.js\r\n\r\n    a programming environment\r\n    based on morphic.js, blocks.js, threads.js and objects.js\r\n    inspired by Scratch\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs blocks.js, threads.js, objects.js and morphic.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        IDE_Morph\r\n        ProjectDialogMorph\r\n        SpriteIconMorph\r\n        TurtleIconMorph\r\n        CostumeIconMorph\r\n        WardrobeMorph\r\n        StageHandleMorph\r\n        PaletteHandleMorph\r\n        CamSnapshotDialogMorph\r\n\r\n\r\n    credits\r\n    -------\r\n    Nathan Dinsmore contributed saving and loading of projects,\r\n    ypr-Snap! project conversion and countless bugfixes\r\n    Ian Reynolds contributed handling and visualization of sounds\r\n    Michael Ball contributed the LibraryImportDialogMorph and countless\r\n    utilities to load libraries from relative urls\r\n\r\n*/\r\n\r\n/*global modules, Morph, SpriteMorph, SyntaxElementMorph, Color,\r\nListWatcherMorph, TextMorph, newCanvas, useBlurredShadows, VariableFrame,\r\nStringMorph, Point, MenuMorph, morphicVersion, DialogBoxMorph,\r\nToggleButtonMorph, contains, ScrollFrameMorph, StageMorph, PushButtonMorph,\r\nInputFieldMorph, FrameMorph, Process, nop, SnapSerializer, ListMorph, detect,\r\nAlignmentMorph, TabMorph, Costume, MorphicPreferences, Sound, BlockMorph,\r\nToggleMorph, InputSlotDialogMorph, ScriptsMorph, isNil, SymbolMorph,\r\nBlockExportDialogMorph, BlockImportDialogMorph, SnapTranslator, localize,\r\nList, ArgMorph, SnapCloud, Uint8Array, HandleMorph, SVG_Costume,\r\nfontHeight, hex_sha512, sb, CommentMorph, CommandBlockMorph, BooleanSlotMorph,\r\nBlockLabelPlaceHolderMorph, Audio, SpeechBubbleMorph, ScriptFocusMorph,\r\nXML_Element, WatcherMorph, BlockRemovalDialogMorph, saveAs, TableMorph,\r\nisSnapObject, isRetinaEnabled, disableRetinaSupport, enableRetinaSupport,\r\nisRetinaSupported, SliderMorph, Animation*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.gui = '2017-December-01';\r\n\r\n// Declarations\r\n\r\nvar IDE_Morph;\r\nvar ProjectDialogMorph;\r\nvar LibraryImportDialogMorph;\r\nvar SpriteIconMorph;\r\nvar CostumeIconMorph;\r\nvar TurtleIconMorph;\r\nvar WardrobeMorph;\r\nvar SoundIconMorph;\r\nvar JukeboxMorph;\r\nvar StageHandleMorph;\r\nvar PaletteHandleMorph;\r\nvar CamSnapshotDialogMorph;\r\n\r\n// IDE_Morph ///////////////////////////////////////////////////////////\r\n\r\n// I am SNAP's top-level frame, the Editor window\r\n\r\n// IDE_Morph inherits from Morph:\r\n\r\nIDE_Morph.prototype = new Morph();\r\nIDE_Morph.prototype.constructor = IDE_Morph;\r\nIDE_Morph.uber = Morph.prototype;\r\n\r\n// IDE_Morph preferences settings and skins\r\n\r\nIDE_Morph.prototype.setDefaultDesign = function () {\r\n    MorphicPreferences.isFlat = false;\r\n    SpriteMorph.prototype.paletteColor = new Color(55, 55, 55);\r\n    SpriteMorph.prototype.paletteTextColor = new Color(230, 230, 230);\r\n    StageMorph.prototype.paletteTextColor\r\n        = SpriteMorph.prototype.paletteTextColor;\r\n    StageMorph.prototype.paletteColor = SpriteMorph.prototype.paletteColor;\r\n    SpriteMorph.prototype.sliderColor\r\n        = SpriteMorph.prototype.paletteColor.lighter(30);\r\n\r\n    IDE_Morph.prototype.buttonContrast = 30;\r\n    IDE_Morph.prototype.backgroundColor = new Color(40, 40, 40);\r\n    IDE_Morph.prototype.frameColor = SpriteMorph.prototype.paletteColor;\r\n\r\n    IDE_Morph.prototype.groupColor\r\n        = SpriteMorph.prototype.paletteColor.lighter(8);\r\n    IDE_Morph.prototype.sliderColor = SpriteMorph.prototype.sliderColor;\r\n    IDE_Morph.prototype.buttonLabelColor = new Color(255, 255, 255);\r\n    IDE_Morph.prototype.tabColors = [\r\n        IDE_Morph.prototype.groupColor.darker(40),\r\n        IDE_Morph.prototype.groupColor.darker(60),\r\n        IDE_Morph.prototype.groupColor\r\n    ];\r\n    IDE_Morph.prototype.rotationStyleColors = IDE_Morph.prototype.tabColors;\r\n    IDE_Morph.prototype.appModeColor = new Color();\r\n    IDE_Morph.prototype.scriptsPaneTexture = this.scriptsTexture();\r\n    IDE_Morph.prototype.padding = 5;\r\n\r\n    SpriteIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    CostumeIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    SoundIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    TurtleIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n};\r\n\r\nIDE_Morph.prototype.setFlatDesign = function () {\r\n    MorphicPreferences.isFlat = true;\r\n    SpriteMorph.prototype.paletteColor = new Color(255, 255, 255);\r\n    SpriteMorph.prototype.paletteTextColor = new Color(70, 70, 70);\r\n    StageMorph.prototype.paletteTextColor\r\n        = SpriteMorph.prototype.paletteTextColor;\r\n    StageMorph.prototype.paletteColor = SpriteMorph.prototype.paletteColor;\r\n    SpriteMorph.prototype.sliderColor = SpriteMorph.prototype.paletteColor;\r\n\r\n    IDE_Morph.prototype.buttonContrast = 30;\r\n    IDE_Morph.prototype.backgroundColor = new Color(200, 200, 200);\r\n    IDE_Morph.prototype.frameColor = new Color(255, 255, 255);\r\n\r\n    IDE_Morph.prototype.groupColor = new Color(230, 230, 230);\r\n    IDE_Morph.prototype.sliderColor = SpriteMorph.prototype.sliderColor;\r\n    IDE_Morph.prototype.buttonLabelColor = new Color(70, 70, 70);\r\n    IDE_Morph.prototype.tabColors = [\r\n        IDE_Morph.prototype.groupColor.lighter(60),\r\n        IDE_Morph.prototype.groupColor.darker(10),\r\n        IDE_Morph.prototype.groupColor\r\n    ];\r\n    IDE_Morph.prototype.rotationStyleColors = [\r\n        IDE_Morph.prototype.groupColor,\r\n        IDE_Morph.prototype.groupColor.darker(10),\r\n        IDE_Morph.prototype.groupColor.darker(30)\r\n    ];\r\n    IDE_Morph.prototype.appModeColor = IDE_Morph.prototype.frameColor;\r\n    IDE_Morph.prototype.scriptsPaneTexture = null;\r\n    IDE_Morph.prototype.padding = 1;\r\n\r\n    SpriteIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    CostumeIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    SoundIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n    TurtleIconMorph.prototype.labelColor\r\n        = IDE_Morph.prototype.buttonLabelColor;\r\n};\r\n\r\nIDE_Morph.prototype.scriptsTexture = function () {\r\n    var pic = newCanvas(new Point(100, 100)), // bigger scales faster\r\n        ctx = pic.getContext('2d'),\r\n        i;\r\n    for (i = 0; i < 100; i += 4) {\r\n        ctx.fillStyle = this.frameColor.toString();\r\n        ctx.fillRect(i, 0, 1, 100);\r\n        ctx.fillStyle = this.groupColor.lighter(6).toString();\r\n        ctx.fillRect(i + 1, 0, 1, 100);\r\n        ctx.fillRect(i + 3, 0, 1, 100);\r\n        ctx.fillStyle = this.groupColor.toString();\r\n        ctx.fillRect(i + 2, 0, 1, 100);\r\n    }\r\n    return pic;\r\n};\r\n\r\nIDE_Morph.prototype.setDefaultDesign();\r\n\r\n// IDE_Morph instance creation:\r\n\r\nfunction IDE_Morph(isAutoFill) {\r\n    this.init(isAutoFill);\r\n}\r\n\r\nIDE_Morph.prototype.init = function (isAutoFill) {\r\n    // global font setting\r\n    MorphicPreferences.globalFontFamily = 'Helvetica, Arial';\r\n\r\n    // restore saved user preferences\r\n    this.userLanguage = null; // user language preference for startup\r\n    this.projectsInURLs = false;\r\n    this.applySavedSettings();\r\n\r\n    // additional properties:\r\n    this.cloudMsg = null;\r\n    this.source = 'local';\r\n    this.serializer = new SnapSerializer();\r\n\r\n    this.globalVariables = new VariableFrame();\r\n    this.currentSprite = new SpriteMorph(this.globalVariables);\r\n    this.sprites = new List([this.currentSprite]);\r\n    this.currentCategory = 'motion';\r\n    this.currentTab = 'scripts';\r\n    this.projectName = 'Education nationale';//Wiquid Snap for Tao project name \r\n    this.projectNotes = '';\r\n\r\n    //***************** Wiquid *********************\r\n    \r\n    // Insert Snap logo\r\n    this.logoURL =\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAYCAYAAACBbx+6AAAEJGlDQ1BJQ0MgUHJvZmlsZQAAOBGFVd9v21QUPolvUqQWPyBYR4eKxa9VU1u5GxqtxgZJk6XtShal6dgqJOQ6N4mpGwfb6baqT3uBNwb8AUDZAw9IPCENBmJ72fbAtElThyqqSUh76MQPISbtBVXhu3ZiJ1PEXPX6yznfOec7517bRD1fabWaGVWIlquunc8klZOnFpSeTYrSs9RLA9Sr6U4tkcvNEi7BFffO6+EdigjL7ZHu/k72I796i9zRiSJPwG4VHX0Z+AxRzNRrtksUvwf7+Gm3BtzzHPDTNgQCqwKXfZwSeNHHJz1OIT8JjtAq6xWtCLwGPLzYZi+3YV8DGMiT4VVuG7oiZpGzrZJhcs/hL49xtzH/Dy6bdfTsXYNY+5yluWO4D4neK/ZUvok/17X0HPBLsF+vuUlhfwX4j/rSfAJ4H1H0qZJ9dN7nR19frRTeBt4Fe9FwpwtN+2p1MXscGLHR9SXrmMgjONd1ZxKzpBeA71b4tNhj6JGoyFNp4GHgwUp9qplfmnFW5oTdy7NamcwCI49kv6fN5IAHgD+0rbyoBc3SOjczohbyS1drbq6pQdqumllRC/0ymTtej8gpbbuVwpQfyw66dqEZyxZKxtHpJn+tZnpnEdrYBbueF9qQn93S7HQGGHnYP7w6L+YGHNtd1FJitqPAR+hERCNOFi1i1alKO6RQnjKUxL1GNjwlMsiEhcPLYTEiT9ISbN15OY/jx4SMshe9LaJRpTvHr3C/ybFYP1PZAfwfYrPsMBtnE6SwN9ib7AhLwTrBDgUKcm06FSrTfSj187xPdVQWOk5Q8vxAfSiIUc7Z7xr6zY/+hpqwSyv0I0/QMTRb7RMgBxNodTfSPqdraz/sDjzKBrv4zu2+a2t0/HHzjd2Lbcc2sG7GtsL42K+xLfxtUgI7YHqKlqHK8HbCCXgjHT1cAdMlDetv4FnQ2lLasaOl6vmB0CMmwT/IPszSueHQqv6i/qluqF+oF9TfO2qEGTumJH0qfSv9KH0nfS/9TIp0Wboi/SRdlb6RLgU5u++9nyXYe69fYRPdil1o1WufNSdTTsp75BfllPy8/LI8G7AUuV8ek6fkvfDsCfbNDP0dvRh0CrNqTbV7LfEEGDQPJQadBtfGVMWEq3QWWdufk6ZSNsjG2PQjp3ZcnOWWing6noonSInvi0/Ex+IzAreevPhe+CawpgP1/pMTMDo64G0sTCXIM+KdOnFWRfQKdJvQzV1+Bt8OokmrdtY2yhVX2a+qrykJfMq4Ml3VR4cVzTQVz+UoNne4vcKLoyS+gyKO6EHe+75Fdt0Mbe5bRIf/wjvrVmhbqBN97RD1vxrahvBOfOYzoosH9bq94uejSOQGkVM6sN/7HelL4t10t9F4gPdVzydEOx83Gv+uNxo7XyL/FtFl8z9ZAHF4bBsrEwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAwBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuMS4yIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOllSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOlhSZXNvbHV0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdGVEYXRlPjIwMTMtMDItMTRUMDA6Mjk6NTE8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIEZpcmV3b3JrcyBDUzYgKE1hY2ludG9zaCk8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTMtMDItMTRUMDA6MzM6MjE8L3htcDpNb2RpZnlEYXRlPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KLdsGnQAACsBJREFUWAmdV2lwVUUWPt333rdkJYGXEFmMEIIChZJkkCVoMsgoS9XIJC9Y4wyLjCCWOhQzf2Z9iU6V5TJa45QOoiQgKENeWATcdfIYQtiSuADB0ZCENSSEJJCXvO3e7vn6PYK4QtlVd+s+fc7Xp79zTl8mpaRrtjLGyUMQjAkfXz00zbDTRCmtieicwTi7XWOUwRiRZVGTJPYmMfmfUNg4mL3sTKfS7ytjegGRII8U17T3AwLsWoC9Xqa53dJSOk6vSxtjEj3AJBUbOmXpQNkfEhFirBtY+7EehveUeDtLUkvrD8vPhWDlhrStHb70VFcUh4/pVCCh5se1y4DhGy/xqAo3PMlwqZUALF0G21KevpBz+VRaMh/a0SPhNbYTcjUaWc2WxS5GuBWycRuTlkgC+DGSiVlAf29qEk/ovCSOcUaekYs7vFEbSq9ql3VH36/zBmcpeN/Bi6vAtpa7VqYm8ue7/ErU8UQonFF+80P7Wq9lo/kVV7ams4WQ+22CkyX4A7SJdPanG399riU6FzbUCtxuUAWaf0gfKyPuPuplUQ83ljFbwsj04cSZk/oDZ0eu6OmmKG+laF7rmuuwsV3hiHaMmGNJ5pKWA99SDMP13bk8N7te+nYTFXyDq6c3pmVZEbkKvlmBuRdAnCeIzr+cuVgGv6XrOzqw/8CpYggalHNb17lWou/JWJdsFsSfvGlJ+8b2DUPjQ6ZVLsjQ4xPaFrnc0s/y2uLcY4/fEpDc1hfU+0PkaKvdNvH8gMLL9pivrEwruNMH9NVX+HriteFTpWX9Bd6cDcuHwZ81klm7MsOjz1BbvaUCUoFTOr6hjwpLDg01SXEOIyfXpy+UJGaRZE6bzooipjxl13hewGq/JOSo/FGR5t20TEZmuQ8sCZO2MiJYPHRGcGVA/Z5wmJbU7cjtzFteb9TfkBsNUCrF8kuJVVMZYsNHBZ6rgK8dPVdwczkncxIAd5Ow7Q1HhqzOXt7waUmJVxs/vlGWIi0V+Hy8urrALFzic4R6k14H2Nxvcbi1In0FiPKiILHopsWdG9RqVbvnvgM/90f0f8IFOzQmqiySGhf8JgCOGIm9m6srCq5re2PaYveO9Wx0v4jPGpbQ126Mp0YaJ8NXjw+8T/9F3QTQdS8RT9K/CjhsBj5My9xpaNoqzthtmADAsf7eiD4P7+21VTmPDCgaeBYWkj6tpCGLh+LbjdS2SNCfMIVZzEVcNtVW5X2s5Cbfe2iETeNZ8Zo5OCJIVve4DssP5RcYOg4L6TS20z5jfP1g0PEnyO9xjBuHa6puParmco2GCEk2kuJ1XXUAE2t6IcuW9SiFHMlxF8y+UBuodGN07HL0gvFt8Pyv8osaFtRsydkcG4vdgykNY7iQb0i973ioN9HPJeXC86kk+eDpRQ1/Zzb2oqGxZ6Djjl7L6OFMpswY1DXkpwu6PBozt+UX6a9izGYROwNQo4EnGa4bNK2o/pnaLblPCKEJCcLDox/Gci+IfLqrKcq9cHefCzzJBgNTrwalMbkO38e4Effv6cX12/OL6+bMmdNkVzLSYeuC/GC8zsTcg1zqRbBwF77fw+gfZMSaivr2HBzr5ia7SwrjVkvyDSGLrwyYxmTUGy4lzxLE1pI0ZlrMnAnQH+l6/OPKDnagH/w9gzp6NApYVbMCT6z6cMNYmp7C02HM3rYpaQietGbNcmNPVV6zya0iy+wvB7i5TIt7q8d5aVd+Sd3Y/W9MaMcmdSPy39m7JfelPVtv/WLf1pxjJLgH0wNMaoNqt+Ud3Lclb2/Nm5PO7t06sQOxXgk9ffBVOipVB+Te2leVs1ON7a+6/UvJHUsts68TFFkKoGmgQa0pZbMOQ0xWKlhEp9an3QG3LzjXLQ+hNzkQsGeiuzOX6hWTscjJLfheOqX4wD/IDPxG0xyPChFUoOfBS50QcWD8SpMGaqDF/OByNCCnF3+8CgzLQZrWoDAbIOJAhQugTxB2k1lZGZcej1CZorbS3YWd3A/5LMG1EORfmTNhcjcHWB4rkYwLQY9DQQfc/jRSXDrj/BZlXRWE0lJi00r2OQsLfTo88Bk8+ZglgvPhpWHS4g8oOfAMsQrzlxsXFigjw0II17SihtXg50rk/5OSeCVq5rsYC8AxIfUEsLiC1kU2NbWRxmvqCc/jtMJkrXfSR7Xe22pVn04lKItAeXLdkKVxDnZnX1D8kmtyn2lxg5OcApkNVCgtDyx5aGpATRpotVW52xFUB6FzBNBq0PO11CalDeAtFHQ2B8sYJwW/v3brpN1q/p33HqozdTYH3BUAj4uHqysyo/OPVI4Lz5hXk8LszjxUxbdVWuOkaXr3xaPRtHb6tSHDMLG0PyiPZS45v6nRy2zx/iFn0TfzvJcluKT0z7+/JvdsIC7ZsNjnQSnCNkfYzizbfdjW8TDnBehlQBf+WoWSIhH7p/ingtLOSdxSOP+TT03G0oSuPYy+bAS/nRi34I/sKcUNE/dX5Xx2R1F9hnA4X8K8AAl5BHTYLZg4Q660adG0ZgltVWIc3XCxX3jU6se5ZfhEuasmOd540O+nueja3G9qRTYuHxZcttgltlDYHFCUhqB5RVhmlabrCvw5NX+gMXAV3AZH5WZQJQfyz4SliSBi7ZBRJbsZYJ2SMXBYjtCleCq/uP4SvkdhzMUFLQf/TWQcA4s74POO79PVGRcfD/X20xGkH3V4ijYY2CHJelBQ6p9bXmW+9yvlsz8rOdCEyYMxBl3SH5baof9W5h1UE6YV1z2GatQbmx27pyWKhkjEXJRl7ziGntcaA0M/ECgoNoOOpmo9R3plXErY1EI9prMAGPbZtMi/NNKGSU67E/Sgb/vGGY3Pr/I6d57MnBrkGc1wDg4+Fa7KyI6hEkfIv6nvupfJUM+WikwH+rbItzNkS0Xae3IPpaj+671KS0uRW69PPr/o0AfTiureupY8whCnfyEPnL1gHUfobVF+2dWGEznyshtHvxOvDv39ifaIPcnJ57Z+MfyI9b8xW3Ewb+FkQTyh6ctTbt9sj+eSOoqWUTX3+YiqqwtRsAgHLylaym8ea0p+j8b6nCR1BL3OkDFQa6HBStQTHfXhnsjsw92Rpx1JupV47OW7F6Q43x95MZhjM7Q+k2u9xAQzLwQnvJnz8LtNav3IrUgRAw05OerC6FN1Stm2ZlhcWDfvZswqQDoaAf4hQNgECAY4v+gesSh4vOmdMfasg03q9Eb1GaTlLlP8lPLEetfv4JA/gpN7kXEEsoQOziLww8KkJN2pn6DuUOF7s7avzsm0h+TGeQub7Pon+cHwKMRkV0RKwwaMYV0L/HX4Qv9nsA0PX90G0KsnQJeVMu7xyH6IbFOXOuiP88hw67q028C5DdJKykX/8azZX4ZodkwROq78ZMI7BQC7KXNxxyNq4d1mhKfomqAbnGTvTmYC2bfDdqPIsPemRNRxgQ3qQV543u9MYK5AUHKnBRlN1iR0htxR9QhhHDy5dxyx7/1NAT2QyaU6XMcgxe4nKtKfQ/RPxg6/gB32Y4HOKFM4fMjIj6CcgVnFGvGS4YvPHb567o96v7z7X6fE92mCsBcV0dVIbPjkLE15tNubmnzRr1fYDZofjsQogC0DXHWqYjbskSoYK0biz6V+DTPUVkSPVN+w4T3vliWNlfAbeD8OlHR9VSmviBbAFaCY+v4/AzCl6siiSKoAAAAASUVORK5CYII=\";\r\n    //this.logoURL = \"http://wiquid.fr/depp/snaplogo.png\";\r\n    //this.resourceURL('snap_logo_sm.png');\r\n\r\n    //***********************************************\r\n    \r\n    this.logo = null;\r\n    this.controlBar = null;\r\n    this.categories = null;\r\n    this.palette = null;\r\n    this.paletteHandle = null;\r\n    this.spriteBar = null;\r\n    this.spriteEditor = null;\r\n    this.stage = null;\r\n    this.stageHandle = null;\r\n    this.corralBar = null;\r\n    this.corral = null;\r\n\r\n    this.isAutoFill = isAutoFill === undefined ? true : isAutoFill;\r\n    this.isAppMode = false;\r\n    this.isSmallStage = false;\r\n    this.filePicker = null;\r\n    this.hasChangedMedia = false;\r\n\r\n    this.isAnimating = true;\r\n\r\n    this.paletteWidth = 200; // initially same as logo width\r\n    this.stageRatio = 1; // for IDE animations, e.g. when zooming\r\n\r\n\tthis.wasSingleStepping = false; // for toggling to and from app mode\r\n\r\n    this.loadNewProject = false; // flag when starting up translated\r\n    this.shield = null;\r\n\r\n    this.savingPreferences = true; // for bh's infamous \"Eisenbergification\"\r\n\r\n    // initialize inherited properties:\r\n    IDE_Morph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.color = this.backgroundColor;\r\n    \r\n};\r\n\r\nIDE_Morph.prototype.openIn = function (world) {\r\n    var hash, usr, myself = this, urlLanguage = null;\r\n\r\n    // get persistent user data, if any\r\n    if (this.hasLocalStorage()) {\r\n        usr = localStorage['-snap-user'];\r\n        if (usr) {\r\n            usr = SnapCloud.parseResponse(usr)[0];\r\n            if (usr) {\r\n                SnapCloud.username = usr.username || null;\r\n                SnapCloud.password = usr.password || null;\r\n                if (SnapCloud.username) {\r\n                    this.source = 'cloud';\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    this.buildPanes();\r\n    world.add(this);\r\n    world.userMenu = this.userMenu;\r\n\r\n    // override SnapCloud's user message with Morphic\r\n    SnapCloud.message = function (string) {\r\n        var m = new MenuMorph(null, string),\r\n            intervalHandle;\r\n        m.popUpCenteredInWorld(world);\r\n        intervalHandle = setInterval(function () {\r\n            m.destroy();\r\n            clearInterval(intervalHandle);\r\n        }, 2000);\r\n    };\r\n\r\n    // prevent non-DialogBoxMorphs from being dropped\r\n    // onto the World in user-mode\r\n    world.reactToDropOf = function (morph) {\r\n        if (!(morph instanceof DialogBoxMorph)) {\r\n            if (world.hand.grabOrigin) {\r\n                morph.slideBackTo(world.hand.grabOrigin);\r\n            } else {\r\n                world.hand.grab(morph);\r\n            }\r\n        }\r\n    };\r\n\r\n    this.reactToWorldResize(world.bounds);\r\n\r\n    function getURL(url) {\r\n        try {\r\n            var request = new XMLHttpRequest();\r\n            request.open('GET', url, false);\r\n            request.send();\r\n            if (request.status === 200) {\r\n                return request.responseText;\r\n            }\r\n            throw new Error('unable to retrieve ' + url);\r\n        } catch (err) {\r\n            myself.showMessage('unable to retrieve project');\r\n            return '';\r\n        }\r\n    }\r\n\r\n\tfunction applyFlags(dict) {\r\n        if (dict.editMode) {\r\n            myself.toggleAppMode(false);\r\n        } else {\r\n            myself.toggleAppMode(true);\r\n        }\r\n        if (!dict.noRun) {\r\n            myself.runScripts();\r\n        }\r\n        if (dict.hideControls) {\r\n            myself.controlBar.hide();\r\n            window.onbeforeunload = nop;\r\n        }\r\n        if (dict.noExitWarning) {\r\n            window.onbeforeunload = nop;\r\n        }\r\n\t}\r\n\r\n    function interpretUrlAnchors() {\r\n        var dict, idx;\r\n\r\n        if (location.hash.substr(0, 6) === '#open:') {\r\n            hash = location.hash.substr(6);\r\n            if (hash.charAt(0) === '%'\r\n                    || hash.search(/\\%(?:[0-9a-f]{2})/i) > -1) {\r\n                hash = decodeURIComponent(hash);\r\n            }\r\n            if (contains(\r\n                    ['project', 'blocks', 'sprites', 'snapdata'].map(\r\n                        function (each) {\r\n                            return hash.substr(0, 8).indexOf(each);\r\n                        }\r\n                    ),\r\n                    1\r\n                )) {\r\n                this.droppedText(hash);\r\n            } else {\r\n                this.droppedText(getURL(hash));\r\n            }\r\n        } else if (location.hash.substr(0, 5) === '#run:') {\r\n            hash = location.hash.substr(5);\r\n            idx = hash.indexOf(\"&\");\r\n            if (idx > 0) {\r\n                hash = hash.slice(0, idx);\r\n            }\r\n            if (hash.charAt(0) === '%'\r\n                    || hash.search(/\\%(?:[0-9a-f]{2})/i) > -1) {\r\n                hash = decodeURIComponent(hash);\r\n            }\r\n            if (hash.substr(0, 8) === '<project>') {\r\n                this.rawOpenProjectString(hash);\r\n            } else {\r\n                this.rawOpenProjectString(getURL(hash));\r\n            }\r\n            applyFlags(SnapCloud.parseDict(location.hash.substr(5)));\r\n        } else if (location.hash.substr(0, 9) === '#present:') {\r\n            this.shield = new Morph();\r\n            this.shield.color = this.color;\r\n            this.shield.setExtent(this.parent.extent());\r\n            this.parent.add(this.shield);\r\n            myself.showMessage('Fetching project\\nfrom the cloud...');\r\n\r\n            // make sure to lowercase the username\r\n            dict = SnapCloud.parseDict(location.hash.substr(9));\r\n            dict.Username = dict.Username.toLowerCase();\r\n\r\n            SnapCloud.getPublicProject(\r\n                SnapCloud.encodeDict(dict),\r\n                function (projectData) {\r\n                    var msg;\r\n                    myself.nextSteps([\r\n                        function () {\r\n                            msg = myself.showMessage('Opening project...');\r\n                        },\r\n                        function () {nop(); }, // yield (bug in Chrome)\r\n                        function () {\r\n                            if (projectData.indexOf('<snapdata') === 0) {\r\n                                myself.rawOpenCloudDataString(projectData);\r\n                            } else if (\r\n                                projectData.indexOf('<project') === 0\r\n                            ) {\r\n                                myself.rawOpenProjectString(projectData);\r\n                            }\r\n                            myself.hasChangedMedia = true;\r\n                        },\r\n                        function () {\r\n                            myself.shield.destroy();\r\n                            myself.shield = null;\r\n                            msg.destroy();\r\n                            applyFlags(dict);\r\n                        }\r\n                    ]);\r\n                },\r\n                this.cloudError()\r\n            );\r\n        } else if (location.hash.substr(0, 7) === '#cloud:') {\r\n            this.shield = new Morph();\r\n            this.shield.alpha = 0;\r\n            this.shield.setExtent(this.parent.extent());\r\n            this.parent.add(this.shield);\r\n            myself.showMessage('Fetching project\\nfrom the cloud...');\r\n\r\n            // make sure to lowercase the username\r\n            dict = SnapCloud.parseDict(location.hash.substr(7));\r\n            dict.Username = dict.Username.toLowerCase();\r\n\r\n            SnapCloud.getPublicProject(\r\n                SnapCloud.encodeDict(dict),\r\n                function (projectData) {\r\n                    var msg;\r\n                    myself.nextSteps([\r\n                        function () {\r\n                            msg = myself.showMessage('Opening project...');\r\n                        },\r\n                        function () {nop(); }, // yield (bug in Chrome)\r\n                        function () {\r\n                            if (projectData.indexOf('<snapdata') === 0) {\r\n                                myself.rawOpenCloudDataString(projectData);\r\n                            } else if (\r\n                                projectData.indexOf('<project') === 0\r\n                            ) {\r\n                                myself.rawOpenProjectString(projectData);\r\n                            }\r\n                            myself.hasChangedMedia = true;\r\n                        },\r\n                        function () {\r\n                            myself.shield.destroy();\r\n                            myself.shield = null;\r\n                            msg.destroy();\r\n                            myself.toggleAppMode(false);\r\n                        }\r\n                    ]);\r\n                },\r\n                this.cloudError()\r\n            );\r\n        } else if (location.hash.substr(0, 4) === '#dl:') {\r\n            myself.showMessage('Fetching project\\nfrom the cloud...');\r\n\r\n            // make sure to lowercase the username\r\n            dict = SnapCloud.parseDict(location.hash.substr(4));\r\n            dict.Username = dict.Username.toLowerCase();\r\n\r\n            SnapCloud.getPublicProject(\r\n                SnapCloud.encodeDict(dict),\r\n                function (projectData) {\r\n                \tmyself.saveXMLAs(projectData, dict.ProjectName);\r\n                 \tmyself.showMessage(\r\n                  \t   'Saved project\\n' + dict.ProjectName,\r\n                      \t2\r\n                 \t);\r\n                },\r\n                this.cloudError()\r\n            );\r\n        } else if (location.hash.substr(0, 6) === '#lang:') {\r\n            urlLanguage = location.hash.substr(6);\r\n            this.setLanguage(urlLanguage);\r\n            this.loadNewProject = true;\r\n        } else if (location.hash.substr(0, 7) === '#signup') {\r\n            this.createCloudAccount();\r\n        }\r\n    this.loadNewProject = false;\r\n\r\n    }\r\n\r\n    if (this.userLanguage) {\r\n        this.loadNewProject = true;\r\n        this.setLanguage(this.userLanguage, interpretUrlAnchors);\r\n    } else {\r\n        interpretUrlAnchors.call(this);\r\n    }\r\n\r\n    \r\n};\r\n\r\n// IDE_Morph construction\r\n\r\nIDE_Morph.prototype.buildPanes = function () {\r\n    this.createLogo();\r\n    this.createControlBar();\r\n    this.createCategories();\r\n    this.createPalette();\r\n    this.createStage();\r\n    this.createSpriteBar();\r\n    this.createSpriteEditor();\r\n    this.createCorralBar();\r\n    this.createCorral();\r\n};\r\n\r\nIDE_Morph.prototype.createLogo = function () {\r\n    var myself = this;\r\n\r\n    if (this.logo) {\r\n        this.logo.destroy();\r\n    }\r\n\r\n    this.logo = new Morph();\r\n    this.logo.texture = this.logoURL;\r\n    this.logo.drawNew = function () {\r\n        this.image = newCanvas(this.extent());\r\n        var context = this.image.getContext('2d'),\r\n            gradient = context.createLinearGradient(\r\n                0,\r\n                0,\r\n                this.width(),\r\n                0\r\n            );\r\n        gradient.addColorStop(0, 'black');\r\n        gradient.addColorStop(0.5, myself.frameColor.toString());\r\n        context.fillStyle = MorphicPreferences.isFlat ?\r\n                myself.frameColor.toString() : gradient;\r\n        context.fillRect(0, 0, this.width(), this.height());\r\n        if (this.texture) {\r\n            this.drawTexture(this.texture);\r\n        }\r\n    };\r\n\r\n    this.logo.drawCachedTexture = function () {\r\n        var context = this.image.getContext('2d');\r\n        context.drawImage(\r\n            this.cachedTexture,\r\n            5,\r\n            Math.round((this.height() - this.cachedTexture.height) / 2)\r\n        );\r\n        this.changed();\r\n    };\r\n\r\n    this.logo.mouseClickLeft = function () {\r\n        myself.snapMenu();\r\n    };\r\n\r\n    this.logo.color = new Color();\r\n    this.logo.setExtent(new Point(200, 28)); // dimensions are fixed\r\n    this.add(this.logo);\r\n};\r\n\r\nIDE_Morph.prototype.createControlBar = function () {\r\n    // assumes the logo has already been created\r\n    var padding = 5,\r\n        button,\r\n        slider,\r\n        stopButton,\r\n        pauseButton,\r\n        startButton,\r\n        projectButton,\r\n        settingsButton,\r\n        stageSizeButton,\r\n        appModeButton,\r\n        steppingButton,\r\n        cloudButton,\r\n        x,\r\n        colors = [\r\n            this.groupColor,\r\n            this.frameColor.darker(50),\r\n            this.frameColor.darker(50)\r\n        ],\r\n        myself = this;\r\n\r\n    if (this.controlBar) {\r\n        this.controlBar.destroy();\r\n    }\r\n\r\n    this.controlBar = new Morph();\r\n    this.controlBar.color = this.frameColor;\r\n    this.controlBar.setHeight(this.logo.height()); // height is fixed\r\n    this.controlBar.mouseClickLeft = function () {\r\n        this.world().fillPage();\r\n    };\r\n    this.add(this.controlBar);\r\n\r\n    //smallStageButton\r\n    button = new ToggleButtonMorph(\r\n        null, //colors,\r\n        myself, // the IDE is the target\r\n        'toggleStageSize',\r\n        [\r\n            new SymbolMorph('smallStage', 14),\r\n            new SymbolMorph('normalStage', 14)\r\n        ],\r\n        function () {  // query\r\n            return myself.isSmallStage;\r\n        }\r\n    );\r\n\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'stage size\\nsmall & normal';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    stageSizeButton = button;\r\n    this.controlBar.add(stageSizeButton);\r\n    this.controlBar.stageSizeButton = button; // for refreshing\r\n\r\n    //appModeButton\r\n    button = new ToggleButtonMorph(\r\n        null, //colors,\r\n        myself, // the IDE is the target\r\n        'toggleAppMode',\r\n        [\r\n            new SymbolMorph('fullScreen', 14),\r\n            new SymbolMorph('normalScreen', 14)\r\n        ],\r\n        function () {  // query\r\n            return myself.isAppMode;\r\n        }\r\n    );\r\n\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'app & edit\\nmodes';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    appModeButton = button;\r\n    this.controlBar.add(appModeButton);\r\n    this.controlBar.appModeButton = appModeButton; // for refreshing\r\n\r\n    //steppingButton\r\n    button = new ToggleButtonMorph(\r\n        null, //colors,\r\n        myself, // the IDE is the target\r\n        'toggleSingleStepping',\r\n        [\r\n            new SymbolMorph('footprints', 16),\r\n            new SymbolMorph('footprints', 16)\r\n        ],\r\n        function () {  // query\r\n            return Process.prototype.enableSingleStepping;\r\n        }\r\n    );\r\n\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = new Color(153, 255, 213);\r\n//    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    button.hint = 'Visible stepping';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    steppingButton = button;\r\n    this.controlBar.add(steppingButton);\r\n    this.controlBar.steppingButton = steppingButton; // for refreshing\r\n\r\n    // stopButton\r\n    button = new ToggleButtonMorph(\r\n        null, // colors\r\n        this, // the IDE is the target\r\n        'stopAllScripts',\r\n        [\r\n            new SymbolMorph('octagon', 14),\r\n            new SymbolMorph('square', 14)\r\n        ],\r\n        function () {  // query\r\n            return myself.stage ?\r\n                    myself.stage.enableCustomHatBlocks &&\r\n                        myself.stage.threads.pauseCustomHatBlocks\r\n                        : true;\r\n        }\r\n    );\r\n\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = new Color(200, 0, 0);\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'stop\\nevery-\\nthing';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    stopButton = button;\r\n    this.controlBar.add(stopButton);\r\n    this.controlBar.stopButton = stopButton; // for refreshing\r\n\r\n    //pauseButton\r\n    button = new ToggleButtonMorph(\r\n        null, //colors,\r\n        this, // the IDE is the target\r\n        'togglePauseResume',\r\n        [\r\n            new SymbolMorph('pause', 12),\r\n            new SymbolMorph('pointRight', 14)\r\n        ],\r\n        function () {  // query\r\n            return myself.isPaused();\r\n        }\r\n    );\r\n\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = new Color(255, 220, 0);\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'pause/resume\\nall scripts';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    pauseButton = button;\r\n    this.controlBar.add(pauseButton);\r\n    this.controlBar.pauseButton = pauseButton; // for refreshing\r\n\r\n    // startButton\r\n    button = new PushButtonMorph(\r\n        this,\r\n        'pressStart',\r\n        new SymbolMorph('flag', 14)\r\n    );\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = new Color(0, 200, 0);\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'start green\\nflag scripts';\r\n    button.fixLayout();\r\n    startButton = button;\r\n    this.controlBar.add(startButton);\r\n    this.controlBar.startButton = startButton;\r\n\r\n    // steppingSlider\r\n    slider = new SliderMorph(\r\n        61,\r\n        1,\r\n        Process.prototype.flashTime * 100 + 1,\r\n        6,\r\n        'horizontal'\r\n    );\r\n    slider.action = function (num) {\r\n        Process.prototype.flashTime = (num - 1) / 100;\r\n        myself.controlBar.refreshResumeSymbol();\r\n    };\r\n    // slider.alpha = MorphicPreferences.isFlat ? 0.1 : 0.3;\r\n    slider.color = new Color(153, 255, 213);\r\n    slider.alpha = 0.3;\r\n    slider.setExtent(new Point(50, 14));\r\n    this.controlBar.add(slider);\r\n    this.controlBar.steppingSlider = slider;\r\n\r\n    // projectButton\r\n    button = new PushButtonMorph(\r\n        this,\r\n        'projectMenu',\r\n        new SymbolMorph('file', 14)\r\n        //'\\u270E'\r\n    );\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'open, save, & annotate project';\r\n    button.fixLayout();\r\n    projectButton = button;\r\n    //this.controlBar.add(projectButton); // Wiquid : Control button menu create save file\r\n    this.controlBar.projectButton = projectButton; // for menu positioning\r\n\r\n    // settingsButton\r\n    button = new PushButtonMorph(\r\n        this,\r\n        'settingsMenu',\r\n        new SymbolMorph('gears', 14)\r\n        //'\\u2699'\r\n    );\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'edit settings';\r\n    button.fixLayout();\r\n    settingsButton = button;\r\n    //this.controlBar.add(settingsButton);\r\n    this.controlBar.settingsButton = settingsButton; // for menu positioning\r\n\r\n    // cloudButton\r\n    button = new PushButtonMorph(\r\n        this,\r\n        'cloudMenu',\r\n        new SymbolMorph('cloud', 11)\r\n    );\r\n    button.corner = 12;\r\n    button.color = colors[0];\r\n    button.highlightColor = colors[1];\r\n    button.pressColor = colors[2];\r\n    button.labelMinExtent = new Point(36, 18);\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = this.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.drawNew();\r\n    // button.hint = 'cloud operations';\r\n    button.fixLayout();\r\n    cloudButton = button;\r\n    //this.controlBar.add(cloudButton);\r\n    this.controlBar.cloudButton = cloudButton; // for menu positioning\r\n\r\n    this.controlBar.fixLayout = function () {\r\n        x = this.right() - padding;\r\n        [stopButton, pauseButton, startButton].forEach(\r\n            function (button) {\r\n                button.setCenter(myself.controlBar.center());\r\n                button.setRight(x);\r\n                x -= button.width();\r\n                x -= padding;\r\n            }\r\n        );\r\n\r\n        x = Math.min(\r\n            startButton.left() - (3 * padding + 2 * stageSizeButton.width()),\r\n            myself.right() - StageMorph.prototype.dimensions.x *\r\n                (myself.isSmallStage ? myself.stageRatio : 1)\r\n        );\r\n        [stageSizeButton, appModeButton].forEach(\r\n            function (button) {\r\n                x += padding;\r\n                button.setCenter(myself.controlBar.center());\r\n                button.setLeft(x);\r\n                x += button.width();\r\n            }\r\n        );\r\n\r\n        slider.setCenter(myself.controlBar.center());\r\n        slider.setRight(stageSizeButton.left() - padding);\r\n\r\n        steppingButton.setCenter(myself.controlBar.center());\r\n        steppingButton.setRight(slider.left() - padding);\r\n\r\n        settingsButton.setCenter(myself.controlBar.center());\r\n        settingsButton.setLeft(this.left());\r\n\r\n        cloudButton.setCenter(myself.controlBar.center());\r\n        cloudButton.setRight(settingsButton.left() - padding);\r\n\r\n        projectButton.setCenter(myself.controlBar.center());\r\n        projectButton.setRight(cloudButton.left() - padding);\r\n\r\n        this.refreshSlider();\r\n        this.updateLabel();\r\n    };\r\n\r\n    this.controlBar.refreshSlider = function () {\r\n        if (Process.prototype.enableSingleStepping && !myself.isAppMode) {\r\n            slider.drawNew();\r\n            slider.show();\r\n        } else {\r\n            slider.hide();\r\n        }\r\n        this.refreshResumeSymbol();\r\n    };\r\n\r\n    this.controlBar.refreshResumeSymbol = function () {\r\n        var pauseSymbols;\r\n        if (Process.prototype.enableSingleStepping &&\r\n                Process.prototype.flashTime > 0.5) {\r\n            myself.stage.threads.pauseAll(myself.stage);\r\n            pauseSymbols = [\r\n                new SymbolMorph('pause', 12),\r\n                new SymbolMorph('stepForward', 14)\r\n            ];\r\n        } else {\r\n            pauseSymbols = [\r\n                new SymbolMorph('pause', 12),\r\n                new SymbolMorph('pointRight', 14)\r\n            ];\r\n        }\r\n        pauseButton.labelString = pauseSymbols;\r\n        pauseButton.createLabel();\r\n        pauseButton.fixLayout();\r\n        pauseButton.refresh();\r\n    };\r\n\r\n    this.controlBar.updateLabel = function () {\r\n        var suffix = myself.world().isDevMode ?\r\n                ' - ' + localize('development mode') : '';\r\n\r\n        if (this.label) {\r\n            this.label.destroy();\r\n        }\r\n        if (myself.isAppMode) {\r\n            return;\r\n        }\r\n\r\n        this.label = new StringMorph(\r\n            (myself.projectName || localize('untitled')) + suffix,\r\n            14,\r\n            'sans-serif',\r\n            true,\r\n            false,\r\n            false,\r\n            MorphicPreferences.isFlat ? null : new Point(2, 1),\r\n            myself.frameColor.darker(myself.buttonContrast)\r\n        );\r\n        this.label.color = myself.buttonLabelColor;\r\n        this.label.drawNew();\r\n        this.add(this.label);\r\n        this.label.setCenter(this.center());\r\n        this.label.setLeft(this.settingsButton.right() + padding);\r\n    };\r\n};\r\n\r\nIDE_Morph.prototype.createCategories = function () {\r\n    var myself = this;\r\n\r\n    if (this.categories) {\r\n        this.categories.destroy();\r\n    }\r\n    this.categories = new Morph();\r\n    this.categories.color = this.groupColor;\r\n    this.categories.silentSetWidth(this.paletteWidth);\r\n\r\n    function addCategoryButton(category) {\r\n        var labelWidth = 75,\r\n            colors = [\r\n                myself.frameColor,\r\n                myself.frameColor.darker(50),\r\n                SpriteMorph.prototype.blockColor[category]\r\n            ],\r\n            button;\r\n\r\n        button = new ToggleButtonMorph(\r\n            colors,\r\n            myself, // the IDE is the target\r\n            function () {\r\n                myself.currentCategory = category;\r\n                myself.categories.children.forEach(function (each) {\r\n                    each.refresh();\r\n                });\r\n                myself.refreshPalette(true);\r\n            },\r\n            category[0].toUpperCase().concat(category.slice(1)), // label\r\n            function () {  // query\r\n                return myself.currentCategory === category;\r\n            },\r\n            null, // env\r\n            null, // hint\r\n            null, // template cache\r\n            labelWidth, // minWidth\r\n            true // has preview\r\n        );\r\n\r\n        button.corner = 8;\r\n        button.padding = 0;\r\n        button.labelShadowOffset = new Point(-1, -1);\r\n        button.labelShadowColor = colors[1];\r\n        button.labelColor = myself.buttonLabelColor;\r\n        button.fixLayout();\r\n        button.refresh();\r\n        myself.categories.add(button);\r\n        return button;\r\n    }\r\n\r\n    function fixCategoriesLayout() {\r\n        var buttonWidth = myself.categories.children[0].width(),\r\n            buttonHeight = myself.categories.children[0].height(),\r\n            border = 3,\r\n            rows =  Math.ceil((myself.categories.children.length) / 2),\r\n            xPadding = (200 // myself.logo.width()\r\n                - border\r\n                - buttonWidth * 2) / 3,\r\n            yPadding = 2,\r\n            l = myself.categories.left(),\r\n            t = myself.categories.top(),\r\n            i = 0,\r\n            row,\r\n            col;\r\n\r\n        myself.categories.children.forEach(function (button) {\r\n            i += 1;\r\n            row = Math.ceil(i / 2);\r\n            col = 2 - (i % 2);\r\n            button.setPosition(new Point(\r\n                l + (col * xPadding + ((col - 1) * buttonWidth)),\r\n                t + (row * yPadding + ((row - 1) * buttonHeight) + border)\r\n            ));\r\n        });\r\n\r\n        myself.categories.setHeight(\r\n            (rows + 1) * yPadding\r\n                + rows * buttonHeight\r\n                + 2 * border\r\n        );\r\n    }\r\n\r\n    SpriteMorph.prototype.categories.forEach(function (cat) {\r\n        if (!contains(['lists', 'other'], cat)) {\r\n           addCategoryButton(cat);\r\n        }\r\n    });\r\n    fixCategoriesLayout();\r\n    this.add(this.categories); // Wiquid : Control display button node categories\r\n};\r\n\r\nIDE_Morph.prototype.createPalette = function (forSearching) {\r\n    // assumes that the logo pane has already been created\r\n    // needs the categories pane for layout\r\n    var myself = this;\r\n\r\n    if (this.palette) {\r\n        this.palette.destroy();\r\n    }\r\n\r\n    if (forSearching) {\r\n        this.palette = new ScrollFrameMorph(\r\n            null,\r\n            null,\r\n            this.currentSprite.sliderColor\r\n        );\r\n\r\n    } else {\r\n        this.palette = this.currentSprite.palette(this.currentCategory);\r\n    }\r\n    this.palette.isDraggable = false;\r\n    this.palette.acceptsDrops = true;\r\n    this.palette.enableAutoScrolling = false;\r\n    this.palette.contents.acceptsDrops = false;\r\n\r\n    this.palette.reactToDropOf = function (droppedMorph, hand) {\r\n\r\n        if (droppedMorph instanceof DialogBoxMorph) {\r\n            myself.world().add(droppedMorph);\r\n        } else if (droppedMorph instanceof SpriteMorph) {\r\n            myself.removeSprite(droppedMorph);\r\n        } else if (droppedMorph instanceof SpriteIconMorph) {\r\n            droppedMorph.destroy();\r\n            myself.removeSprite(droppedMorph.object);\r\n        } else if (droppedMorph instanceof CostumeIconMorph) {\r\n            myself.currentSprite.wearCostume(null);\r\n            droppedMorph.perish();\r\n        } else if (droppedMorph instanceof BlockMorph) {\r\n            myself.stage.threads.stopAllForBlock(droppedMorph);\r\n            if (hand && hand.grabOrigin.origin instanceof ScriptsMorph) {\r\n                hand.grabOrigin.origin.clearDropInfo();\r\n                hand.grabOrigin.origin.lastDroppedBlock = droppedMorph;\r\n                hand.grabOrigin.origin.recordDrop(hand.grabOrigin);\r\n            }\r\n            droppedMorph.perish();\r\n        } else {\r\n            droppedMorph.perish();\r\n        }\r\n    };\r\n\r\n    this.palette.contents.reactToDropOf = function (droppedMorph) {\r\n        // for \"undrop\" operation\r\n        if (droppedMorph instanceof BlockMorph) {\r\n            droppedMorph.destroy();\r\n        }\r\n    };\r\n\r\n    this.palette.setWidth(this.logo.width());\r\n    this.add(this.palette); // Wiquid :  control node palette.\r\n    return this.palette;\r\n};\r\n\r\nIDE_Morph.prototype.createPaletteHandle = function () {\r\n    // assumes that the palette has already been created\r\n    if (this.paletteHandle) {this.paletteHandle.destroy(); }\r\n    this.paletteHandle = new PaletteHandleMorph(this.categories);\r\n    panel_Left = this;\r\n    this.add(this.paletteHandle);\r\n};\r\n\r\nIDE_Morph.prototype.createStage = function () {\r\n    // assumes that the logo pane has already been created\r\n    if (this.stage) {this.stage.destroy(); }\r\n    StageMorph.prototype.frameRate = 0;\r\n    this.stage = new StageMorph(this.globalVariables);\r\n    this.stage.setExtent(this.stage.dimensions); // dimensions are fixed\r\n    if (this.currentSprite instanceof SpriteMorph) {\r\n        this.currentSprite.setPosition(\r\n            this.stage.center().subtract(\r\n                this.currentSprite.extent().divideBy(2)\r\n            )\r\n        );\r\n        this.stage.add(this.currentSprite);\r\n    }\r\n    this.add(this.stage);\r\n};\r\n\r\nIDE_Morph.prototype.createStageHandle = function () {\r\n    // assumes that the stage has already been created\r\n    if (this.stageHandle) {this.stageHandle.destroy(); }\r\n    this.stageHandle = new StageHandleMorph(this.stage);\r\n    this.add(this.stageHandle);\r\n};\r\n\r\nIDE_Morph.prototype.createSpriteBar = function () {\r\n    // assumes that the categories pane has already been created\r\n    var rotationStyleButtons = [],\r\n        thumbSize = new Point(45, 45),\r\n        nameField,\r\n        padlock,\r\n        thumbnail,\r\n        tabCorner = 15,\r\n        tabColors = this.tabColors,\r\n        tabBar = new AlignmentMorph('row', -tabCorner * 2),\r\n        tab,\r\n        symbols = ['\\u2192', '\\u21BB', '\\u2194'],\r\n        labels = ['don\\'t rotate', 'can rotate', 'only face left/right'],\r\n        myself = this;\r\n\r\n    if (this.spriteBar) {\r\n        this.spriteBar.destroy();\r\n    }\r\n\r\n    this.spriteBar = new Morph();\r\n    this.spriteBar.color = this.frameColor;\r\n    this.add(this.spriteBar);\r\n\r\n    function addRotationStyleButton(rotationStyle) {\r\n        var colors = myself.rotationStyleColors,\r\n            button;\r\n\r\n        button = new ToggleButtonMorph(\r\n            colors,\r\n            myself, // the IDE is the target\r\n            function () {\r\n                if (myself.currentSprite instanceof SpriteMorph) {\r\n                    myself.currentSprite.rotationStyle = rotationStyle;\r\n                    myself.currentSprite.changed();\r\n                    myself.currentSprite.drawNew();\r\n                    myself.currentSprite.changed();\r\n                }\r\n                rotationStyleButtons.forEach(function (each) {\r\n                    each.refresh();\r\n                });\r\n            },\r\n            symbols[rotationStyle], // label\r\n            function () {  // query\r\n                return myself.currentSprite instanceof SpriteMorph\r\n                    && myself.currentSprite.rotationStyle === rotationStyle;\r\n            },\r\n            null, // environment\r\n            localize(labels[rotationStyle])\r\n        );\r\n\r\n        button.corner = 8;\r\n        button.labelMinExtent = new Point(11, 11);\r\n        button.padding = 0;\r\n        button.labelShadowOffset = new Point(-1, -1);\r\n        button.labelShadowColor = colors[1];\r\n        button.labelColor = myself.buttonLabelColor;\r\n        button.fixLayout();\r\n        button.refresh();\r\n        rotationStyleButtons.push(button);\r\n        button.setPosition(myself.spriteBar.position().add(2));\r\n        button.setTop(button.top()\r\n            + ((rotationStyleButtons.length - 1) * (button.height() + 2))\r\n            );\r\n        myself.spriteBar.add(button);\r\n        if (myself.currentSprite instanceof StageMorph) {\r\n            button.hide();\r\n        }\r\n        return button;\r\n    }\r\n\r\n    addRotationStyleButton(1);\r\n    addRotationStyleButton(2);\r\n    addRotationStyleButton(0);\r\n    this.rotationStyleButtons = rotationStyleButtons;\r\n\r\n    thumbnail = new Morph();\r\n    thumbnail.setExtent(thumbSize);\r\n    thumbnail.image = this.currentSprite.thumbnail(thumbSize);\r\n    thumbnail.setPosition(\r\n        rotationStyleButtons[0].topRight().add(new Point(5, 3))\r\n    );\r\n    this.spriteBar.add(thumbnail);\r\n\r\n    thumbnail.fps = 3;\r\n\r\n    thumbnail.step = function () {\r\n        if (thumbnail.version !== myself.currentSprite.version) {\r\n            thumbnail.image = myself.currentSprite.thumbnail(thumbSize);\r\n            thumbnail.changed();\r\n            thumbnail.version = myself.currentSprite.version;\r\n        }\r\n    };\r\n\r\n    nameField = new InputFieldMorph(this.currentSprite.name);\r\n    nameField.setWidth(100); // fixed dimensions\r\n    nameField.contrast = 90;\r\n    nameField.setPosition(thumbnail.topRight().add(new Point(10, 3)));\r\n    this.spriteBar.add(nameField);\r\n    nameField.drawNew();\r\n    nameField.accept = function () {\r\n        var newName = nameField.getValue();\r\n        myself.currentSprite.setName(\r\n            myself.newSpriteName(newName, myself.currentSprite)\r\n        );\r\n        nameField.setContents(myself.currentSprite.name);\r\n    };\r\n    this.spriteBar.reactToEdit = nameField.accept;\r\n\r\n    // padlock\r\n    padlock = new ToggleMorph(\r\n        'checkbox',\r\n        null,\r\n        function () {\r\n            myself.currentSprite.isDraggable =\r\n                !myself.currentSprite.isDraggable;\r\n        },\r\n        localize('draggable'),\r\n        function () {\r\n            return myself.currentSprite.isDraggable;\r\n        }\r\n    );\r\n    padlock.label.isBold = false;\r\n    padlock.label.setColor(this.buttonLabelColor);\r\n    padlock.color = tabColors[2];\r\n    padlock.highlightColor = tabColors[0];\r\n    padlock.pressColor = tabColors[1];\r\n\r\n    padlock.tick.shadowOffset = MorphicPreferences.isFlat ?\r\n            new Point() : new Point(-1, -1);\r\n    padlock.tick.shadowColor = new Color(); // black\r\n    padlock.tick.color = this.buttonLabelColor;\r\n    padlock.tick.isBold = false;\r\n    padlock.tick.drawNew();\r\n\r\n    padlock.setPosition(nameField.bottomLeft().add(2));\r\n    padlock.drawNew();\r\n    this.spriteBar.add(padlock);\r\n    if (this.currentSprite instanceof StageMorph) {\r\n        padlock.hide();\r\n    }\r\n\r\n    // tab bar\r\n    tabBar.tabTo = function (tabString) {\r\n        var active;\r\n        myself.currentTab = tabString;\r\n        this.children.forEach(function (each) {\r\n            each.refresh();\r\n            if (each.state) {active = each; }\r\n        });\r\n        active.refresh(); // needed when programmatically tabbing\r\n        myself.createSpriteEditor();\r\n        myself.fixLayout('tabEditor');\r\n    };\r\n\r\n    tab = new TabMorph(\r\n        tabColors,\r\n        null, // target\r\n        function () {tabBar.tabTo('scripts'); },\r\n        localize('Scripts'), // label\r\n        function () {  // query\r\n            return myself.currentTab === 'scripts';\r\n        }\r\n    );\r\n    tab.padding = 3;\r\n    tab.corner = tabCorner;\r\n    tab.edge = 1;\r\n    tab.labelShadowOffset = new Point(-1, -1);\r\n    tab.labelShadowColor = tabColors[1];\r\n    tab.labelColor = this.buttonLabelColor;\r\n    tab.drawNew();\r\n    tab.fixLayout();\r\n    tabBar.add(tab);\r\n\r\n    tab = new TabMorph(\r\n        tabColors,\r\n        null, // target\r\n        function () {tabBar.tabTo('costumes'); },\r\n        localize(this.currentSprite instanceof SpriteMorph ?\r\n            'Costumes' : 'Backgrounds'\r\n        ),\r\n        function () {  // query\r\n            return myself.currentTab === 'costumes';\r\n        }\r\n    );\r\n    tab.padding = 3;\r\n    tab.corner = tabCorner;\r\n    tab.edge = 1;\r\n    tab.labelShadowOffset = new Point(-1, -1);\r\n    tab.labelShadowColor = tabColors[1];\r\n    tab.labelColor = this.buttonLabelColor;\r\n    tab.drawNew();\r\n    tab.fixLayout();\r\n    tabBar.add(tab);\r\n\r\n    tab = new TabMorph(\r\n        tabColors,\r\n        null, // target\r\n        function () {tabBar.tabTo('sounds'); },\r\n        localize('Sounds'), // label\r\n        function () {  // query\r\n            return myself.currentTab === 'sounds';\r\n        }\r\n    );\r\n    tab.padding = 3;\r\n    tab.corner = tabCorner;\r\n    tab.edge = 1;\r\n    tab.labelShadowOffset = new Point(-1, -1);\r\n    tab.labelShadowColor = tabColors[1];\r\n    tab.labelColor = this.buttonLabelColor;\r\n    tab.drawNew();\r\n    tab.fixLayout();\r\n    tabBar.add(tab);\r\n\r\n    tabBar.fixLayout();\r\n    tabBar.children.forEach(function (each) {\r\n        each.refresh();\r\n    });\r\n    this.spriteBar.tabBar = tabBar;\r\n    this.spriteBar.add(this.spriteBar.tabBar);\r\n\r\n    this.spriteBar.fixLayout = function () {\r\n        this.tabBar.setLeft(this.left());\r\n        this.tabBar.setBottom(this.bottom());\r\n    };\r\n};\r\n\r\nIDE_Morph.prototype.createSpriteEditor = function () {\r\n    // assumes that the logo pane and the stage have already been created\r\n    var scripts = this.currentSprite.scripts,\r\n        myself = this;\r\n\r\n    if (this.spriteEditor) {\r\n        this.spriteEditor.destroy();\r\n    }\r\n\r\n    if (this.currentTab === 'scripts') {\r\n        scripts.isDraggable = false;\r\n        scripts.color = this.groupColor;\r\n        scripts.cachedTexture = this.scriptsPaneTexture;\r\n\r\n        this.spriteEditor = new ScrollFrameMorph(\r\n            scripts,\r\n            null,\r\n            this.sliderColor\r\n        );\r\n        this.spriteEditor.padding = 10;\r\n        this.spriteEditor.growth = 50;\r\n        this.spriteEditor.isDraggable = false;\r\n        this.spriteEditor.acceptsDrops = false;\r\n        this.spriteEditor.contents.acceptsDrops = true;\r\n\r\n        scripts.scrollFrame = this.spriteEditor;\r\n        scripts.updateToolbar();\r\n        this.add(this.spriteEditor);\r\n        this.spriteEditor.scrollX(this.spriteEditor.padding);\r\n        this.spriteEditor.scrollY(this.spriteEditor.padding);\r\n    } else if (this.currentTab === 'costumes') {\r\n        this.spriteEditor = new WardrobeMorph(\r\n            this.currentSprite,\r\n            this.sliderColor\r\n        );\r\n        this.spriteEditor.color = this.groupColor;\r\n        this.add(this.spriteEditor);\r\n        this.spriteEditor.updateSelection();\r\n\r\n        this.spriteEditor.acceptsDrops = false;\r\n        this.spriteEditor.contents.acceptsDrops = false;\r\n    } else if (this.currentTab === 'sounds') {\r\n        this.spriteEditor = new JukeboxMorph(\r\n            this.currentSprite,\r\n            this.sliderColor\r\n        );\r\n        this.spriteEditor.color = this.groupColor;\r\n        this.add(this.spriteEditor);\r\n        this.spriteEditor.updateSelection();\r\n        this.spriteEditor.acceptDrops = false;\r\n        this.spriteEditor.contents.acceptsDrops = false;\r\n    } else {\r\n        this.spriteEditor = new Morph();\r\n        this.spriteEditor.color = this.groupColor;\r\n        this.spriteEditor.acceptsDrops = true;\r\n        this.spriteEditor.reactToDropOf = function (droppedMorph) {\r\n            if (droppedMorph instanceof DialogBoxMorph) {\r\n                myself.world().add(droppedMorph);\r\n            } else if (droppedMorph instanceof SpriteMorph) {\r\n                myself.removeSprite(droppedMorph);\r\n            } else {\r\n                droppedMorph.destroy();\r\n            }\r\n        };\r\n        this.add(this.spriteEditor);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.createCorralBar = function () {\r\n    // assumes the stage has already been created\r\n    var padding = 5,\r\n        newbutton,\r\n        paintbutton,\r\n        cambutton,\r\n        colors = [\r\n            this.groupColor,\r\n            this.frameColor.darker(50),\r\n            this.frameColor.darker(50)\r\n        ];\r\n\r\n    if (this.corralBar) {\r\n        this.corralBar.destroy();\r\n    }\r\n\r\n    this.corralBar = new Morph();\r\n    this.corralBar.color = this.frameColor;\r\n    this.corralBar.setHeight(this.logo.height()); // height is fixed\r\n    this.add(this.corralBar);\r\n\r\n    // new sprite button\r\n    newbutton = new PushButtonMorph(\r\n        this,\r\n        \"addNewSprite\",\r\n        new SymbolMorph(\"turtle\", 14)\r\n    );\r\n    newbutton.corner = 12;\r\n    newbutton.color = colors[0];\r\n    newbutton.highlightColor = colors[1];\r\n    newbutton.pressColor = colors[2];\r\n    newbutton.labelMinExtent = new Point(36, 18);\r\n    newbutton.padding = 0;\r\n    newbutton.labelShadowOffset = new Point(-1, -1);\r\n    newbutton.labelShadowColor = colors[1];\r\n    newbutton.labelColor = this.buttonLabelColor;\r\n    newbutton.contrast = this.buttonContrast;\r\n    newbutton.drawNew();\r\n    newbutton.hint = \"add a new Turtle sprite\";\r\n    newbutton.fixLayout();\r\n    newbutton.setCenter(this.corralBar.center());\r\n    newbutton.setLeft(this.corralBar.left() + padding);\r\n    this.corralBar.add(newbutton);\r\n\r\n    paintbutton = new PushButtonMorph(\r\n        this,\r\n        \"paintNewSprite\",\r\n        new SymbolMorph(\"brush\", 15)\r\n    );\r\n    paintbutton.corner = 12;\r\n    paintbutton.color = colors[0];\r\n    paintbutton.highlightColor = colors[1];\r\n    paintbutton.pressColor = colors[2];\r\n    paintbutton.labelMinExtent = new Point(36, 18);\r\n    paintbutton.padding = 0;\r\n    paintbutton.labelShadowOffset = new Point(-1, -1);\r\n    paintbutton.labelShadowColor = colors[1];\r\n    paintbutton.labelColor = this.buttonLabelColor;\r\n    paintbutton.contrast = this.buttonContrast;\r\n    paintbutton.drawNew();\r\n    paintbutton.hint = \"paint a new sprite\";\r\n    paintbutton.fixLayout();\r\n    paintbutton.setCenter(this.corralBar.center());\r\n    paintbutton.setLeft(\r\n        this.corralBar.left() + padding + newbutton.width() + padding\r\n    );\r\n    this.corralBar.add(paintbutton);\r\n\r\n    if (CamSnapshotDialogMorph.prototype.enableCamera) {\r\n        cambutton = new PushButtonMorph(\r\n                this,\r\n                \"newCamSprite\",\r\n                new SymbolMorph(\"camera\", 15)\r\n                );\r\n        cambutton.corner = 12;\r\n        cambutton.color = colors[0];\r\n        cambutton.highlightColor = colors[1];\r\n        cambutton.pressColor = colors[2];\r\n        cambutton.labelMinExtent = new Point(36, 18);\r\n        cambutton.padding = 0;\r\n        cambutton.labelShadowOffset = new Point(-1, -1);\r\n        cambutton.labelShadowColor = colors[1];\r\n        cambutton.labelColor = this.buttonLabelColor;\r\n        cambutton.contrast = this.buttonContrast;\r\n        cambutton.drawNew();\r\n        cambutton.hint = \"take a camera snapshot and\\nimport it as a new sprite\";\r\n        cambutton.fixLayout();\r\n        cambutton.setCenter(this.corralBar.center());\r\n        cambutton.setLeft(\r\n            this.corralBar.left() +\r\n            padding +\r\n            newbutton.width() +\r\n            padding +\r\n            paintbutton.width() +\r\n            padding\r\n        );\r\n        this.corralBar.add(cambutton);\r\n        document.addEventListener(\r\n            'cameraDisabled',\r\n            function (event) {\r\n                cambutton.disable();\r\n                cambutton.hint =\r\n                    CamSnapshotDialogMorph.prototype.notSupportedMessage;\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.createCorral = function () {\r\n    // assumes the corral bar has already been created\r\n    var frame, template, padding = 5, myself = this;\r\n\r\n    this.createStageHandle();\r\n    this.createPaletteHandle();\r\n\r\n    if (this.corral) {\r\n        this.corral.destroy();\r\n    }\r\n\r\n    this.corral = new Morph();\r\n    this.corral.color = this.groupColor;\r\n    this.add(this.corral);\r\n\r\n    this.corral.stageIcon = new SpriteIconMorph(this.stage);\r\n    this.corral.stageIcon.isDraggable = false;\r\n    this.corral.add(this.corral.stageIcon);\r\n\r\n    frame = new ScrollFrameMorph(null, null, this.sliderColor);\r\n    frame.acceptsDrops = false;\r\n    frame.contents.acceptsDrops = false;\r\n\r\n    frame.contents.wantsDropOf = function (morph) {\r\n        return morph instanceof SpriteIconMorph;\r\n    };\r\n\r\n    frame.contents.reactToDropOf = function (spriteIcon) {\r\n        myself.corral.reactToDropOf(spriteIcon);\r\n    };\r\n\r\n    frame.alpha = 0;\r\n\r\n    this.sprites.asArray().forEach(function (morph) {\r\n        if (!morph.isTemporary) {\r\n            template = new SpriteIconMorph(morph, template);\r\n            frame.contents.add(template);\r\n        }\r\n    });\r\n\r\n    this.corral.frame = frame;\r\n    this.corral.add(frame);\r\n\r\n    this.corral.fixLayout = function () {\r\n        this.stageIcon.setCenter(this.center());\r\n        this.stageIcon.setLeft(this.left() + padding);\r\n        this.frame.setLeft(this.stageIcon.right() + padding);\r\n        this.frame.setExtent(new Point(\r\n            this.right() - this.frame.left(),\r\n            this.height()\r\n        ));\r\n        this.arrangeIcons();\r\n        this.refresh();\r\n    };\r\n\r\n    this.corral.arrangeIcons = function () {\r\n        var x = this.frame.left(),\r\n            y = this.frame.top(),\r\n            max = this.frame.right(),\r\n            start = this.frame.left();\r\n\r\n        this.frame.contents.children.forEach(function (icon) {\r\n            var w = icon.width();\r\n\r\n            if (x + w > max) {\r\n                x = start;\r\n                y += icon.height(); // they're all the same\r\n            }\r\n            icon.setPosition(new Point(x, y));\r\n            x += w;\r\n        });\r\n        this.frame.contents.adjustBounds();\r\n    };\r\n\r\n    this.corral.addSprite = function (sprite) {\r\n        this.frame.contents.add(new SpriteIconMorph(sprite));\r\n        this.fixLayout();\r\n    };\r\n\r\n    this.corral.refresh = function () {\r\n        this.stageIcon.refresh();\r\n        this.frame.contents.children.forEach(function (icon) {\r\n            icon.refresh();\r\n        });\r\n    };\r\n\r\n    this.corral.wantsDropOf = function (morph) {\r\n        return morph instanceof SpriteIconMorph;\r\n    };\r\n\r\n    this.corral.reactToDropOf = function (spriteIcon) {\r\n        var idx = 1,\r\n            pos = spriteIcon.position();\r\n        spriteIcon.destroy();\r\n        this.frame.contents.children.forEach(function (icon) {\r\n            if (pos.gt(icon.position()) || pos.y > icon.bottom()) {\r\n                idx += 1;\r\n            }\r\n        });\r\n        myself.sprites.add(spriteIcon.object, idx);\r\n        myself.createCorral();\r\n        myself.fixLayout();\r\n    };\r\n};\r\n\r\n// IDE_Morph layout\r\n\r\nIDE_Morph.prototype.fixLayout = function (situation) {\r\n    // situation is a string, i.e.\r\n    // 'selectSprite' or 'refreshPalette' or 'tabEditor'\r\n    var padding = this.padding,\r\n        maxPaletteWidth;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    if (situation !== 'refreshPalette') {\r\n        // controlBar\r\n        this.controlBar.setPosition(this.logo.topRight());\r\n        this.controlBar.setWidth(this.right() - this.controlBar.left());\r\n        this.controlBar.fixLayout();\r\n\r\n        // categories\r\n        this.categories.setLeft(this.logo.left());\r\n        this.categories.setTop(this.logo.bottom());\r\n        this.categories.setWidth(this.paletteWidth);\r\n    }\r\n\r\n    // palette\r\n    this.palette.setLeft(this.logo.left());\r\n    this.palette.setTop(this.categories.bottom());\r\n    this.palette.setHeight(this.bottom() - this.palette.top());\r\n    this.palette.setWidth(this.paletteWidth);\r\n\r\n    if (situation !== 'refreshPalette') {\r\n        // stage\r\n        if (this.isAppMode) {\r\n            this.stage.setScale(Math.floor(Math.min(\r\n                (this.width() - padding * 2) / this.stage.dimensions.x,\r\n                (this.height() - this.controlBar.height() * 2 - padding * 2)\r\n                    / this.stage.dimensions.y\r\n            ) * 10) / 10);\r\n            this.stage.setCenter(this.center());\r\n        } else {\r\n            this.stage.setScale(this.isSmallStage ? this.stageRatio : 1);\r\n            this.stage.setTop(this.logo.bottom() + padding);\r\n            this.stage.setRight(this.right());\r\n            maxPaletteWidth = Math.max(\r\n                200,\r\n                this.width() -\r\n                    this.stage.width() -\r\n                    this.spriteBar.tabBar.width() -\r\n                    (this.padding * 2)\r\n            );\r\n            if (this.paletteWidth > maxPaletteWidth) {\r\n                this.paletteWidth = maxPaletteWidth;\r\n                this.fixLayout();\r\n            }\r\n            this.stageHandle.fixLayout();\r\n            this.paletteHandle.fixLayout();\r\n        }\r\n\r\n        // spriteBar\r\n        this.spriteBar.setLeft(this.paletteWidth + padding);\r\n        this.spriteBar.setTop(this.logo.bottom() + padding);\r\n        this.spriteBar.setExtent(new Point(\r\n            Math.max(0, this.stage.left() - padding - this.spriteBar.left()),\r\n            this.categories.bottom() - this.spriteBar.top() - padding\r\n        ));\r\n        this.spriteBar.fixLayout();\r\n\r\n        // spriteEditor\r\n        if (this.spriteEditor.isVisible) {\r\n            this.spriteEditor.setPosition(this.spriteBar.bottomLeft());\r\n            this.spriteEditor.setExtent(new Point(\r\n                this.spriteBar.width(),\r\n                this.bottom() - this.spriteEditor.top()\r\n            ));\r\n        }\r\n\r\n        // corralBar\r\n        this.corralBar.setLeft(this.stage.left());\r\n        this.corralBar.setTop(this.stage.bottom() + padding);\r\n        this.corralBar.setWidth(this.stage.width());\r\n\r\n        // corral\r\n        if (!contains(['selectSprite', 'tabEditor'], situation)) {\r\n            this.corral.setPosition(this.corralBar.bottomLeft());\r\n            this.corral.setWidth(this.stage.width());\r\n            this.corral.setHeight(this.bottom() - this.corral.top());\r\n            this.corral.fixLayout();\r\n        }\r\n    }\r\n\r\n    Morph.prototype.trackChanges = true;\r\n    this.changed();\r\n};\r\n\r\nIDE_Morph.prototype.setProjectName = function (string) {\r\n    this.projectName = string.replace(/['\"]/g, ''); // filter quotation marks\r\n    this.hasChangedMedia = true;\r\n    this.controlBar.updateLabel();\r\n};\r\n\r\n// IDE_Morph resizing\r\n\r\nIDE_Morph.prototype.setExtent = function (point) {\r\n    var padding = new Point(430, 110),\r\n        minExt,\r\n        ext,\r\n        maxWidth,\r\n        minWidth,\r\n        maxHeight,\r\n        minRatio,\r\n        maxRatio;\r\n\r\n    // determine the minimum dimensions making sense for the current mode\r\n    if (this.isAppMode) {\r\n        minExt = StageMorph.prototype.dimensions.add(\r\n            this.controlBar.height() + 10\r\n        );\r\n    } else {\r\n        if (this.stageRatio > 1) {\r\n            minExt = padding.add(StageMorph.prototype.dimensions);\r\n        } else {\r\n            minExt = padding.add(\r\n                StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)\r\n            );\r\n        }\r\n    }\r\n    ext = point.max(minExt);\r\n\r\n    // adjust stage ratio if necessary\r\n    maxWidth = ext.x -\r\n        (200 + this.spriteBar.tabBar.width() + (this.padding * 2));\r\n    minWidth = SpriteIconMorph.prototype.thumbSize.x * 3;\r\n    maxHeight = (ext.y - SpriteIconMorph.prototype.thumbSize.y * 3.5);\r\n    minRatio = minWidth / this.stage.dimensions.x;\r\n    maxRatio = Math.min(\r\n        (maxWidth / this.stage.dimensions.x),\r\n        (maxHeight / this.stage.dimensions.y)\r\n    );\r\n    this.stageRatio = Math.min(maxRatio, Math.max(minRatio, this.stageRatio));\r\n\r\n    // apply\r\n    IDE_Morph.uber.setExtent.call(this, ext);\r\n    this.fixLayout();\r\n};\r\n\r\n// IDE_Morph events\r\n\r\nIDE_Morph.prototype.reactToWorldResize = function (rect) {\r\n    if (this.isAutoFill) {\r\n        this.setPosition(rect.origin);\r\n        this.setExtent(rect.extent());\r\n    }\r\n    if (this.filePicker) {\r\n        document.body.removeChild(this.filePicker);\r\n        this.filePicker = null;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.droppedImage = function (aCanvas, name) {\r\n    var costume = new Costume(\r\n        aCanvas,\r\n        this.currentSprite.newCostumeName(\r\n            name ? name.split('.')[0] : '' // up to period\r\n        )\r\n    );\r\n\r\n    if (costume.isTainted()) {\r\n        this.inform(\r\n            'Unable to import this image',\r\n            'The picture you wish to import has been\\n' +\r\n                'tainted by a restrictive cross-origin policy\\n' +\r\n                'making it unusable for costumes in Snap!. \\n\\n' +\r\n                'Try downloading this picture first to your\\n' +\r\n                'computer, and import it from there.'\r\n        );\r\n        return;\r\n    }\r\n\r\n    this.currentSprite.addCostume(costume);\r\n    this.currentSprite.wearCostume(costume);\r\n    this.spriteBar.tabBar.tabTo('costumes');\r\n    this.hasChangedMedia = true;\r\n};\r\n\r\nIDE_Morph.prototype.droppedSVG = function (anImage, name) {\r\n    var costume = new SVG_Costume(anImage, name.split('.')[0]);\r\n    this.currentSprite.addCostume(costume);\r\n    this.currentSprite.wearCostume(costume);\r\n    this.spriteBar.tabBar.tabTo('costumes');\r\n    this.hasChangedMedia = true;\r\n};\r\n\r\nIDE_Morph.prototype.droppedAudio = function (anAudio, name) {\r\n    this.currentSprite.addSound(anAudio, name.split('.')[0]); // up to period\r\n    this.spriteBar.tabBar.tabTo('sounds');\r\n    this.hasChangedMedia = true;\r\n};\r\n\r\nIDE_Morph.prototype.droppedText = function (aString, name) {\r\n    var lbl = name ? name.split('.')[0] : '';\r\n    if (aString.indexOf('<project') === 0) {\r\n        \r\n        location.hash = '';\r\n        return this.openProjectString(aString);\r\n    }\r\n    if (aString.indexOf('<snapdata') === 0) {\r\n        location.hash = '';\r\n        return this.openCloudDataString(aString);\r\n    }\r\n    if (aString.indexOf('<blocks') === 0) {\r\n        return this.openBlocksString(aString, lbl, true);\r\n    }\r\n    if (aString.indexOf('<sprites') === 0) {\r\n        return this.openSpritesString(aString);\r\n    }\r\n    if (aString.indexOf('<media') === 0) {\r\n        return this.openMediaString(aString);\r\n    }\r\n    if (aString.indexOf('<script') === 0) {\r\n        return this.openScriptString(aString);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.droppedBinary = function (anArrayBuffer, name) {\r\n    // dynamically load ypr->Snap!\r\n    var ypr = document.getElementById('ypr'),\r\n        myself = this,\r\n        suffix = name.substring(name.length - 3);\r\n\r\n    if (suffix.toLowerCase() !== 'ypr') {return; }\r\n\r\n    function loadYPR(buffer, lbl) {\r\n        var reader = new sb.Reader(),\r\n            pname = lbl.split('.')[0]; // up to period\r\n        reader.onload = function (info) {\r\n            myself.droppedText(new sb.XMLWriter().write(pname, info));\r\n        };\r\n        reader.readYPR(new Uint8Array(buffer));\r\n    }\r\n\r\n    if (!ypr) {\r\n        ypr = document.createElement('script');\r\n        ypr.id = 'ypr';\r\n        ypr.onload = function () {loadYPR(anArrayBuffer, name); };\r\n        document.head.appendChild(ypr);\r\n        ypr.src = 'ypr.js';\r\n    } else {\r\n        loadYPR(anArrayBuffer, name);\r\n    }\r\n};\r\n\r\n// IDE_Morph button actions\r\n\r\nIDE_Morph.prototype.refreshPalette = function (shouldIgnorePosition) {\r\n    var oldTop = this.palette.contents.top();\r\n\r\n    this.createPalette();\r\n    this.fixLayout('refreshPalette');\r\n    if (!shouldIgnorePosition) {\r\n        this.palette.contents.setTop(oldTop);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.pressStart = function () {\r\n    if (this.world().currentKey === 16) { // shiftClicked\r\n        this.toggleFastTracking();\r\n    } else {\r\n        this.stage.threads.pauseCustomHatBlocks = false;\r\n        this.controlBar.stopButton.refresh();\r\n        this.runScripts();\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.toggleFastTracking = function () {\r\n    if (this.stage.isFastTracked) {\r\n        this.stopFastTracking();\r\n    } else {\r\n        this.startFastTracking();\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.toggleVariableFrameRate = function () {\r\n    if (StageMorph.prototype.frameRate) {\r\n        StageMorph.prototype.frameRate = 0;\r\n        this.stage.fps = 0;\r\n    } else {\r\n        StageMorph.prototype.frameRate = 30;\r\n        this.stage.fps = 30;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.toggleSingleStepping = function () {\r\n    this.stage.threads.toggleSingleStepping();\r\n    this.controlBar.steppingButton.refresh();\r\n    this.controlBar.refreshSlider();\r\n};\r\n\r\nIDE_Morph.prototype.toggleCameraSupport = function () {\r\n    CamSnapshotDialogMorph.prototype.enableCamera =\r\n        !CamSnapshotDialogMorph.prototype.enableCamera;\r\n    this.spriteBar.tabBar.tabTo(this.currentTab);\r\n    this.createCorralBar();\r\n    this.fixLayout();\r\n};\r\n\r\nIDE_Morph.prototype.startFastTracking = function () {\r\n    this.stage.isFastTracked = true;\r\n    this.stage.fps = 0;\r\n    this.controlBar.startButton.labelString = new SymbolMorph('flash', 14);\r\n    this.controlBar.startButton.drawNew();\r\n    this.controlBar.startButton.fixLayout();\r\n};\r\n\r\nIDE_Morph.prototype.stopFastTracking = function () {\r\n    this.stage.isFastTracked = false;\r\n    this.stage.fps = this.stage.frameRate;\r\n    this.controlBar.startButton.labelString = new SymbolMorph('flag', 14);\r\n    this.controlBar.startButton.drawNew();\r\n    this.controlBar.startButton.fixLayout();\r\n};\r\n\r\nIDE_Morph.prototype.runScripts = function () {\r\n    this.stage.fireGreenFlagEvent();\r\n};\r\n\r\nIDE_Morph.prototype.togglePauseResume = function () {\r\n    if (this.stage.threads.isPaused()) {\r\n        this.stage.threads.resumeAll(this.stage);\r\n    } else {\r\n        this.stage.threads.pauseAll(this.stage);\r\n    }\r\n    this.controlBar.pauseButton.refresh();\r\n};\r\n\r\nIDE_Morph.prototype.isPaused = function () {\r\n    if (!this.stage) {return false; }\r\n    return this.stage.threads.isPaused();\r\n};\r\n\r\nIDE_Morph.prototype.stopAllScripts = function () {\r\n    if (this.stage.enableCustomHatBlocks) {\r\n        this.stage.threads.pauseCustomHatBlocks =\r\n            !this.stage.threads.pauseCustomHatBlocks;\r\n    } else {\r\n        this.stage.threads.pauseCustomHatBlocks = false;\r\n    }\r\n    this.controlBar.stopButton.refresh();\r\n    this.stage.fireStopAllEvent();\r\n};\r\n\r\nIDE_Morph.prototype.selectSprite = function (sprite) {\r\n    if (this.currentSprite && this.currentSprite.scripts.focus) {\r\n        this.currentSprite.scripts.focus.stopEditing();\r\n    }\r\n    this.currentSprite = sprite;\r\n    this.createPalette();\r\n    this.createSpriteBar();\r\n    this.createSpriteEditor();\r\n    this.corral.refresh();\r\n    this.fixLayout('selectSprite');\r\n    this.currentSprite.scripts.fixMultiArgs();\r\n};\r\n\r\n// IDE_Morph retina display support\r\n\r\nIDE_Morph.prototype.toggleRetina = function () {\r\n    if (isRetinaEnabled()) {\r\n        disableRetinaSupport();\r\n    } else {\r\n        enableRetinaSupport();\r\n    }\r\n    this.world().fillPage();\r\n    IDE_Morph.prototype.scriptsPaneTexture = this.scriptsTexture();\r\n    this.stage.clearPenTrails();\r\n    this.drawNew();\r\n    this.refreshIDE();\r\n};\r\n\r\n// IDE_Morph skins\r\n\r\nIDE_Morph.prototype.defaultDesign = function () {\r\n    this.setDefaultDesign();\r\n    this.refreshIDE();\r\n    this.removeSetting('design');\r\n};\r\n\r\nIDE_Morph.prototype.flatDesign = function () {\r\n    this.setFlatDesign();\r\n    this.refreshIDE();\r\n    this.saveSetting('design', 'flat');\r\n};\r\n\r\nIDE_Morph.prototype.refreshIDE = function () {\r\n    var projectData ;\r\n\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            projectData = this.serializer.serialize(this.stage);\r\n        } catch (err) {\r\n            this.showMessage('Serialization failed: ' + err);\r\n        }\r\n    } else {\r\n        projectData = this.serializer.serialize(this.stage);\r\n    }\r\n    SpriteMorph.prototype.initBlocks();\r\n    this.buildPanes();\r\n    this.fixLayout();\r\n    if (this.loadNewProject) {\r\n        this.newProject();\r\n    } else {\r\n        this.openProjectString(projectData);\r\n    }\r\n};\r\n\r\n// IDE_Morph settings persistance\r\n\r\nIDE_Morph.prototype.applySavedSettings = function () {\r\n    var design = this.getSetting('design'),\r\n        zoom = this.getSetting('zoom'),\r\n        /*language = this.getSetting('language'),*/\r\n        language = 'fr',\r\n        click = this.getSetting('click'),\r\n        longform = this.getSetting('longform'),\r\n        longurls = this.getSetting('longurls'),\r\n        plainprototype = this.getSetting('plainprototype'),\r\n        keyboard = this.getSetting('keyboard'),\r\n        tables = this.getSetting('tables'),\r\n        tableLines = this.getSetting('tableLines'),\r\n        autoWrapping = this.getSetting('autowrapping');\r\n\r\n    // design\r\n    if (design === 'flat') {\r\n        this.setFlatDesign();\r\n    } else {\r\n        this.setDefaultDesign();\r\n    }\r\n\r\n    // blocks zoom\r\n    if (zoom) {\r\n        SyntaxElementMorph.prototype.setScale(Math.min(zoom, 12));\r\n        CommentMorph.prototype.refreshScale();\r\n        SpriteMorph.prototype.initBlocks();\r\n    }\r\n\r\n    // language\r\n    if (language && language !== 'en') {\r\n        this.userLanguage = language;\r\n    } else {\r\n        this.userLanguage = null;\r\n    }\r\n\r\n    //  click\r\n    if (click && !BlockMorph.prototype.snapSound) {\r\n        BlockMorph.prototype.toggleSnapSound();\r\n    }\r\n\r\n    // long form\r\n    if (longform) {\r\n        InputSlotDialogMorph.prototype.isLaunchingExpanded = true;\r\n    }\r\n\r\n    // project data in URLs\r\n    if (longurls) {\r\n        this.projectsInURLs = true;\r\n    } else {\r\n        this.projectsInURLs = false;\r\n    }\r\n\r\n    // keyboard editing\r\n    if (keyboard === 'false') {\r\n        ScriptsMorph.prototype.enableKeyboard = false;\r\n    } else {\r\n        ScriptsMorph.prototype.enableKeyboard = true;\r\n    }\r\n\r\n    // tables\r\n    if (tables === 'false') {\r\n        List.prototype.enableTables = false;\r\n    } else {\r\n        List.prototype.enableTables = true;\r\n    }\r\n\r\n    // tableLines\r\n    if (tableLines) {\r\n        TableMorph.prototype.highContrast = true;\r\n    } else {\r\n        TableMorph.prototype.highContrast = false;\r\n    }\r\n\r\n    // nested auto-wrapping\r\n    if (autoWrapping === 'false') {\r\n        ScriptsMorph.prototype.enableNestedAutoWrapping = false;\r\n    } else {\r\n        ScriptsMorph.prototype.enableNestedAutoWrapping = true;\r\n    }\r\n\r\n    // plain prototype labels\r\n    if (plainprototype) {\r\n        BlockLabelPlaceHolderMorph.prototype.plainLabel = true;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.saveSetting = function (key, value) {\r\n    if (!this.savingPreferences) {\r\n        return;\r\n    }\r\n    if (this.hasLocalStorage()) {\r\n        localStorage['-snap-setting-' + key] = value;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.getSetting = function (key) {\r\n    if (this.hasLocalStorage()) {\r\n        return localStorage['-snap-setting-' + key];\r\n    }\r\n    return null;\r\n};\r\n\r\nIDE_Morph.prototype.removeSetting = function (key) {\r\n    if (this.hasLocalStorage()) {\r\n        delete localStorage['-snap-setting-' + key];\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.hasLocalStorage = function () {\r\n\t// checks whether localStorage is available,\r\n    // this kludgy try/catch mechanism is needed\r\n    // because Safari 11 is paranoid about accessing\r\n    // localstorage from the file:// protocol\r\n\ttry {\r\n\t\treturn !isNil(localStorage);\r\n\t} catch (err) {\r\n    \treturn false;\r\n\t}\r\n};\r\n\r\n// IDE_Morph sprite list access\r\n\r\nIDE_Morph.prototype.addNewSprite = function () {\r\n    var sprite = new SpriteMorph(this.globalVariables),\r\n        rnd = Process.prototype.reportRandom;\r\n    sprite.name = this.newSpriteName(sprite.name);\r\n    sprite.setCenter(this.stage.center());\r\n    this.stage.add(sprite);\r\n\r\n    // randomize sprite properties\r\n    sprite.setHue(rnd.call(this, 0, 100));\r\n    sprite.setBrightness(rnd.call(this, 50, 100));\r\n    sprite.turn(rnd.call(this, 1, 360));\r\n    sprite.setXPosition(rnd.call(this, -220, 220));\r\n    sprite.setYPosition(rnd.call(this, -160, 160));\r\n\r\n    this.sprites.add(sprite);\r\n    this.corral.addSprite(sprite);\r\n    this.selectSprite(sprite);\r\n};\r\n\r\nIDE_Morph.prototype.paintNewSprite = function () {\r\n    var sprite = new SpriteMorph(this.globalVariables),\r\n        cos = new Costume(),\r\n        myself = this;\r\n\r\n    sprite.name = this.newSpriteName(sprite.name);\r\n    sprite.setCenter(this.stage.center());\r\n    this.stage.add(sprite);\r\n    this.sprites.add(sprite);\r\n    this.corral.addSprite(sprite);\r\n    this.selectSprite(sprite);\r\n    cos.edit(\r\n        this.world(),\r\n        this,\r\n        true,\r\n        function () {myself.removeSprite(sprite); },\r\n        function () {\r\n            sprite.addCostume(cos);\r\n            sprite.wearCostume(cos);\r\n        }\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.newCamSprite = function () {\r\n    var sprite = new SpriteMorph(this.globalVariables),\r\n        camDialog,\r\n        myself = this;\r\n\r\n    sprite.name = this.newSpriteName(sprite.name);\r\n    sprite.setCenter(this.stage.center());\r\n    this.stage.add(sprite);\r\n    this.sprites.add(sprite);\r\n    this.corral.addSprite(sprite);\r\n    this.selectSprite(sprite);\r\n\r\n    camDialog = new CamSnapshotDialogMorph(\r\n        this,\r\n        sprite,\r\n        function () { myself.removeSprite(sprite); },\r\n        function (costume) {\r\n            sprite.addCostume(costume);\r\n            sprite.wearCostume(costume);\r\n            this.close();\r\n        });\r\n\r\n    camDialog.popUp(this.world());\r\n};\r\n\r\nIDE_Morph.prototype.duplicateSprite = function (sprite) {\r\n    var duplicate = sprite.fullCopy();\r\n    duplicate.setPosition(this.world().hand.position());\r\n    duplicate.appearIn(this);\r\n    duplicate.keepWithin(this.stage);\r\n    this.selectSprite(duplicate);\r\n};\r\n\r\nIDE_Morph.prototype.instantiateSprite = function (sprite) {\r\n    var instance = sprite.fullCopy(true),\r\n        hats = instance.allHatBlocksFor('__clone__init__');\r\n    instance.appearIn(this);\r\n    if (hats.length) {\r\n        instance.initClone(hats);\r\n    } else {\r\n        instance.setPosition(this.world().hand.position());\r\n        instance.keepWithin(this.stage);\r\n    }\r\n    this.selectSprite(instance);\r\n};\r\n\r\nIDE_Morph.prototype.removeSprite = function (sprite) {\r\n    var idx, myself = this;\r\n    sprite.parts.forEach(function (part) {myself.removeSprite(part); });\r\n    idx = this.sprites.asArray().indexOf(sprite) + 1;\r\n    this.stage.threads.stopAllForReceiver(sprite);\r\n    sprite.corpsify();\r\n    sprite.destroy();\r\n    this.stage.watchers().forEach(function (watcher) {\r\n        if (watcher.object() === sprite) {\r\n            watcher.destroy();\r\n        }\r\n    });\r\n    if (idx > 0) {\r\n        this.sprites.remove(idx);\r\n    }\r\n    this.createCorral();\r\n    this.fixLayout();\r\n    this.currentSprite = detect(\r\n        this.stage.children,\r\n        function (morph) {\r\n            return morph instanceof SpriteMorph && !morph.isTemporary;\r\n        }\r\n    ) || this.stage;\r\n\r\n    this.selectSprite(this.currentSprite);\r\n};\r\n\r\nIDE_Morph.prototype.newSpriteName = function (name, ignoredSprite) {\r\n    var ix = name.indexOf('('),\r\n        stem = (ix < 0) ? name : name.substring(0, ix),\r\n        count = 1,\r\n        newName = stem,\r\n        all = this.sprites.asArray().concat(this.stage).filter(\r\n            function (each) {return each !== ignoredSprite; }\r\n        ).map(\r\n            function (each) {return each.name; }\r\n        );\r\n    while (contains(all, newName)) {\r\n        count += 1;\r\n        newName = stem + '(' + count + ')';\r\n    }\r\n    return newName;\r\n};\r\n\r\n// IDE_Morph deleting scripts\r\n\r\nIDE_Morph.prototype.removeBlock = function (aBlock, justThis) {\r\n    this.stage.threads.stopAllForBlock(aBlock);\r\n    aBlock.destroy(justThis);\r\n};\r\n\r\n// IDE_Morph menus\r\n\r\nIDE_Morph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    // menu.addItem('help', 'nop');\r\n    return menu;\r\n};\r\n\r\nIDE_Morph.prototype.snapMenu = function () {\r\n    var menu,\r\n        myself = this,\r\n        world = this.world();\r\n\r\n    menu = new MenuMorph(this);\r\n    menu.addItem('About...', 'aboutSnap');\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'Reference manual',\r\n        function () {\r\n            var url = myself.resourceURL('help', 'SnapManual.pdf');\r\n            window.open(url, 'SnapReferenceManual');\r\n        }\r\n    );\r\n    menu.addItem(\r\n        'Snap! website',\r\n        function () {\r\n            window.open('http://snap.berkeley.edu/', 'SnapWebsite');\r\n        }\r\n    );\r\n    menu.addItem(\r\n        'Download source',\r\n        function () {\r\n            window.open(\r\n                'http://snap.berkeley.edu/snapsource/snap.zip',\r\n                'SnapSource'\r\n            );\r\n        }\r\n    );\r\n    if (world.isDevMode) {\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'Switch back to user mode',\r\n            'switchToUserMode',\r\n            'disable deep-Morphic\\ncontext menus'\r\n                + '\\nand show user-friendly ones',\r\n            new Color(0, 100, 0)\r\n        );\r\n    } else if (world.currentKey === 16) { // shift-click\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'Switch to dev mode',\r\n            'switchToDevMode',\r\n            'enable Morphic\\ncontext menus\\nand inspectors,'\r\n                + '\\nnot user-friendly!',\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n    menu.popup(world, this.logo.bottomLeft());\r\n};\r\n\r\nIDE_Morph.prototype.cloudMenu = function () {\r\n    var menu,\r\n        myself = this,\r\n        world = this.world(),\r\n        pos = this.controlBar.cloudButton.bottomLeft(),\r\n        shiftClicked = (world.currentKey === 16);\r\n\r\n    menu = new MenuMorph(this);\r\n    if (shiftClicked) {\r\n        menu.addItem(\r\n            'url...',\r\n            'setCloudURL',\r\n            null,\r\n            new Color(100, 0, 0)\r\n        );\r\n        menu.addLine();\r\n    }\r\n    if (!SnapCloud.username) {\r\n        menu.addItem(\r\n            'Login...',\r\n            'initializeCloud'\r\n        );\r\n        menu.addItem(\r\n            'Signup...',\r\n            'createCloudAccount'\r\n        );\r\n        menu.addItem(\r\n            'Reset Password...',\r\n            'resetCloudPassword'\r\n        );\r\n    } else {\r\n        menu.addItem(\r\n            localize('Logout') + ' ' + SnapCloud.username,\r\n            'logout'\r\n        );\r\n        menu.addItem(\r\n            'Change Password...',\r\n            'changeCloudPassword'\r\n        );\r\n    }\r\n    if (shiftClicked) {\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'export project media only...',\r\n            function () {\r\n                if (myself.projectName) {\r\n                    myself.exportProjectMedia(myself.projectName);\r\n                } else {\r\n                    myself.prompt('Export Project As...', function (name) {\r\n                        myself.exportProjectMedia(name);\r\n                    }, null, 'exportProject');\r\n                }\r\n            },\r\n            null,\r\n            this.hasChangedMedia ? new Color(100, 0, 0) : new Color(0, 100, 0)\r\n        );\r\n        menu.addItem(\r\n            'export project without media...',\r\n            function () {\r\n                if (myself.projectName) {\r\n                    myself.exportProjectNoMedia(myself.projectName);\r\n                } else {\r\n                    myself.prompt('Export Project As...', function (name) {\r\n                        myself.exportProjectNoMedia(name);\r\n                    }, null, 'exportProject');\r\n                }\r\n            },\r\n            null,\r\n            new Color(100, 0, 0)\r\n        );\r\n        menu.addItem(\r\n            'export project as cloud data...',\r\n            function () {\r\n                if (myself.projectName) {\r\n                    myself.exportProjectAsCloudData(myself.projectName);\r\n                } else {\r\n                    myself.prompt('Export Project As...', function (name) {\r\n                        myself.exportProjectAsCloudData(name);\r\n                    }, null, 'exportProject');\r\n                }\r\n            },\r\n            null,\r\n            new Color(100, 0, 0)\r\n        );\r\n        menu.addLine();\r\n        menu.addItem(\r\n            'open shared project from cloud...',\r\n            function () {\r\n                myself.prompt('Author name', function (usr) {\r\n                    myself.prompt('Project name...', function (prj) {\r\n                        var id = 'Username=' +\r\n                            encodeURIComponent(usr.toLowerCase()) +\r\n                            '&ProjectName=' +\r\n                            encodeURIComponent(prj);\r\n                        myself.showMessage(\r\n                            'Fetching project\\nfrom the cloud...'\r\n                        );\r\n                        SnapCloud.getPublicProject(\r\n                            id,\r\n                            function (projectData) {\r\n                                var msg;\r\n                                if (!Process.prototype.isCatchingErrors) {\r\n                                    window.open(\r\n                                        'data:text/xml,' + projectData\r\n                                    );\r\n                                }\r\n                                myself.nextSteps([\r\n                                    function () {\r\n                                        msg = myself.showMessage(\r\n                                            'Opening project...'\r\n                                        );\r\n                                    },\r\n                                    function () {nop(); }, // yield (Chrome)\r\n                                    function () {\r\n                                        myself.rawOpenCloudDataString(\r\n                                            projectData\r\n                                        );\r\n                                    },\r\n                                    function () {\r\n                                        msg.destroy();\r\n                                    }\r\n                                ]);\r\n                            },\r\n                            myself.cloudError()\r\n                        );\r\n\r\n                    }, null, 'project');\r\n                }, null, 'project');\r\n            },\r\n            null,\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n    menu.popup(world, pos);\r\n};\r\n\r\nIDE_Morph.prototype.settingsMenu = function () {\r\n    var menu,\r\n        stage = this.stage,\r\n        world = this.world(),\r\n        myself = this,\r\n        pos = this.controlBar.settingsButton.bottomLeft(),\r\n        shiftClicked = (world.currentKey === 16);\r\n\r\n    function addPreference(label, toggle, test, onHint, offHint, hide) {\r\n        var on = '\\u2611 ',\r\n            off = '\\u2610 ';\r\n        if (!hide || shiftClicked) {\r\n            menu.addItem(\r\n                (test ? on : off) + localize(label),\r\n                toggle,\r\n                test ? onHint : offHint,\r\n                hide ? new Color(100, 0, 0) : null\r\n            );\r\n        }\r\n    }\r\n\r\n    menu = new MenuMorph(this);\r\n    menu.addItem('Language...', 'languageMenu');\r\n    menu.addItem(\r\n        'Zoom blocks...',\r\n        'userSetBlocksScale'\r\n    );\r\n    menu.addItem(\r\n        'Stage size...',\r\n        'userSetStageSize'\r\n    );\r\n    if (shiftClicked) {\r\n        menu.addItem(\r\n            'Dragging threshold...',\r\n            'userSetDragThreshold',\r\n            'specify the distance the hand has to move\\n' +\r\n                'before it picks up an object',\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n    menu.addLine();\r\n    \r\n    if (isRetinaSupported()) {\r\n        addPreference(\r\n            'Retina display support',\r\n            'toggleRetina',\r\n            isRetinaEnabled(),\r\n            'uncheck for lower resolution,\\nsaves computing resources',\r\n            'check for higher resolution,\\nuses more computing resources'\r\n        );\r\n    }\r\n    addPreference(\r\n        'Input sliders',\r\n        'toggleInputSliders',\r\n        MorphicPreferences.useSliderForInput,\r\n        'uncheck to disable\\ninput sliders for\\nentry fields',\r\n        'check to enable\\ninput sliders for\\nentry fields'\r\n    );\r\n    if (MorphicPreferences.useSliderForInput) {\r\n        addPreference(\r\n            'Execute on slider change',\r\n            'toggleSliderExecute',\r\n            ArgMorph.prototype.executeOnSliderEdit,\r\n            'uncheck to suppress\\nrunning scripts\\nwhen moving the slider',\r\n            'check to run\\nthe edited script\\nwhen moving the slider'\r\n        );\r\n    }\r\n    addPreference(\r\n        'Turbo mode',\r\n        'toggleFastTracking',\r\n        this.stage.isFastTracked,\r\n        'uncheck to run scripts\\nat normal speed',\r\n        'check to prioritize\\nscript execution'\r\n    );\r\n    addPreference(\r\n        'Visible stepping',\r\n        'toggleSingleStepping',\r\n        Process.prototype.enableSingleStepping,\r\n        'uncheck to turn off\\nvisible stepping',\r\n        'check to turn on\\n visible stepping (slow)',\r\n        false\r\n    );\r\n    addPreference(\r\n        'Ternary Boolean slots',\r\n        function () {\r\n        \tBooleanSlotMorph.prototype.isTernary =\r\n        \t\t!BooleanSlotMorph.prototype.isTernary;\r\n      \t},\r\n        BooleanSlotMorph.prototype.isTernary,\r\n        'uncheck to limit\\nBoolean slots to true / false',\r\n        'check to allow\\nempty Boolean slots',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Camera support',\r\n        'toggleCameraSupport',\r\n        CamSnapshotDialogMorph.prototype.enableCamera,\r\n        'uncheck to disable\\ncamera support',\r\n        'check to enable\\ncamera support',\r\n        true\r\n    );\r\n    menu.addLine(); // everything visible below is persistent\r\n    addPreference(\r\n        'Blurred shadows',\r\n        'toggleBlurredShadows',\r\n        useBlurredShadows,\r\n        'uncheck to use solid drop\\nshadows and highlights',\r\n        'check to use blurred drop\\nshadows and highlights',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Zebra coloring',\r\n        'toggleZebraColoring',\r\n        BlockMorph.prototype.zebraContrast,\r\n        'uncheck to disable alternating\\ncolors for nested block',\r\n        'check to enable alternating\\ncolors for nested blocks',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Dynamic input labels',\r\n        'toggleDynamicInputLabels',\r\n        SyntaxElementMorph.prototype.dynamicInputLabels,\r\n        'uncheck to disable dynamic\\nlabels for variadic inputs',\r\n        'check to enable dynamic\\nlabels for variadic inputs',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Prefer empty slot drops',\r\n        'togglePreferEmptySlotDrops',\r\n        ScriptsMorph.prototype.isPreferringEmptySlots,\r\n        'uncheck to allow dropped\\nreporters to kick out others',\r\n        'settings menu prefer empty slots hint',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Long form input dialog',\r\n        'toggleLongFormInputDialog',\r\n        InputSlotDialogMorph.prototype.isLaunchingExpanded,\r\n        'uncheck to use the input\\ndialog in short form',\r\n        'check to always show slot\\ntypes in the input dialog'\r\n    );\r\n    addPreference(\r\n        'Plain prototype labels',\r\n        'togglePlainPrototypeLabels',\r\n        BlockLabelPlaceHolderMorph.prototype.plainLabel,\r\n        'uncheck to always show (+) symbols\\nin block prototype labels',\r\n        'check to hide (+) symbols\\nin block prototype labels'\r\n    );\r\n    addPreference(\r\n        'Virtual keyboard',\r\n        'toggleVirtualKeyboard',\r\n        MorphicPreferences.useVirtualKeyboard,\r\n        'uncheck to disable\\nvirtual keyboard support\\nfor mobile devices',\r\n        'check to enable\\nvirtual keyboard support\\nfor mobile devices',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Clicking sound',\r\n        function () {\r\n            BlockMorph.prototype.toggleSnapSound();\r\n            if (BlockMorph.prototype.snapSound) {\r\n                myself.saveSetting('click', true);\r\n            } else {\r\n                myself.removeSetting('click');\r\n            }\r\n        },\r\n        BlockMorph.prototype.snapSound,\r\n        'uncheck to turn\\nblock clicking\\nsound off',\r\n        'check to turn\\nblock clicking\\nsound on'\r\n    );\r\n    addPreference(\r\n        'Animations',\r\n        function () {myself.isAnimating = !myself.isAnimating; },\r\n        myself.isAnimating,\r\n        'uncheck to disable\\nIDE animations',\r\n        'check to enable\\nIDE animations',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Cache Inputs',\r\n        function () {\r\n            BlockMorph.prototype.isCachingInputs =\r\n                !BlockMorph.prototype.isCachingInputs;\r\n        },\r\n        BlockMorph.prototype.isCachingInputs,\r\n        'uncheck to stop caching\\ninputs (for debugging the evaluator)',\r\n        'check to cache inputs\\nboosts recursion',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Rasterize SVGs',\r\n        function () {\r\n            MorphicPreferences.rasterizeSVGs =\r\n                !MorphicPreferences.rasterizeSVGs;\r\n        },\r\n        MorphicPreferences.rasterizeSVGs,\r\n        'uncheck for smooth\\nscaling of vector costumes',\r\n        'check to rasterize\\nSVGs on import',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Flat design',\r\n        function () {\r\n            if (MorphicPreferences.isFlat) {\r\n                return myself.defaultDesign();\r\n            }\r\n            myself.flatDesign();\r\n        },\r\n        MorphicPreferences.isFlat,\r\n        'uncheck for default\\nGUI design',\r\n        'check for alternative\\nGUI design',\r\n        false\r\n    );\r\n    addPreference(\r\n        'Nested auto-wrapping',\r\n        function () {\r\n            ScriptsMorph.prototype.enableNestedAutoWrapping =\r\n                !ScriptsMorph.prototype.enableNestedAutoWrapping;\r\n            if (ScriptsMorph.prototype.enableNestedAutoWrapping) {\r\n                myself.removeSetting('autowrapping');\r\n            } else {\r\n                myself.saveSetting('autowrapping', false);\r\n            }\r\n        },\r\n        ScriptsMorph.prototype.enableNestedAutoWrapping,\r\n        'uncheck to confine auto-wrapping\\nto top-level block stacks',\r\n        'check to enable auto-wrapping\\ninside nested block stacks',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Project URLs',\r\n        function () {\r\n            myself.projectsInURLs = !myself.projectsInURLs;\r\n            if (myself.projectsInURLs) {\r\n                myself.saveSetting('longurls', true);\r\n            } else {\r\n                myself.removeSetting('longurls');\r\n            }\r\n        },\r\n        myself.projectsInURLs,\r\n        'uncheck to disable\\nproject data in URLs',\r\n        'check to enable\\nproject data in URLs',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Sprite Nesting',\r\n        function () {\r\n            SpriteMorph.prototype.enableNesting =\r\n                !SpriteMorph.prototype.enableNesting;\r\n        },\r\n        SpriteMorph.prototype.enableNesting,\r\n        'uncheck to disable\\nsprite composition',\r\n        'check to enable\\nsprite composition',\r\n        true\r\n    );\r\n    addPreference(\r\n        'First-Class Sprites',\r\n        function () {\r\n            SpriteMorph.prototype.enableFirstClass =\r\n                !SpriteMorph.prototype.enableFirstClass;\r\n            myself.currentSprite.blocksCache.sensing = null;\r\n            myself.currentSprite.paletteCache.sensing = null;\r\n            myself.refreshPalette();\r\n        },\r\n        SpriteMorph.prototype.enableFirstClass,\r\n        'uncheck to disable support\\nfor first-class sprites',\r\n        'check to enable support\\n for first-class sprite',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Keyboard Editing',\r\n        function () {\r\n            ScriptsMorph.prototype.enableKeyboard =\r\n                !ScriptsMorph.prototype.enableKeyboard;\r\n            myself.currentSprite.scripts.updateToolbar();\r\n            if (ScriptsMorph.prototype.enableKeyboard) {\r\n                myself.removeSetting('keyboard');\r\n            } else {\r\n                myself.saveSetting('keyboard', false);\r\n            }\r\n        },\r\n        ScriptsMorph.prototype.enableKeyboard,\r\n        'uncheck to disable\\nkeyboard editing support',\r\n        'check to enable\\nkeyboard editing support',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Table support',\r\n        function () {\r\n            List.prototype.enableTables =\r\n                !List.prototype.enableTables;\r\n            if (List.prototype.enableTables) {\r\n                myself.removeSetting('tables');\r\n            } else {\r\n                myself.saveSetting('tables', false);\r\n            }\r\n        },\r\n        List.prototype.enableTables,\r\n        'uncheck to disable\\nmulti-column list views',\r\n        'check for multi-column\\nlist view support',\r\n        true\r\n    );\r\n    if (List.prototype.enableTables) {\r\n        addPreference(\r\n            'Table lines',\r\n            function () {\r\n                TableMorph.prototype.highContrast =\r\n                    !TableMorph.prototype.highContrast;\r\n                if (TableMorph.prototype.highContrast) {\r\n                    myself.saveSetting('tableLines', true);\r\n                } else {\r\n                    myself.removeSetting('tableLines');\r\n                }\r\n            },\r\n            TableMorph.prototype.highContrast,\r\n            'uncheck for less contrast\\nmulti-column list views',\r\n            'check for higher contrast\\ntable views',\r\n            true\r\n        );\r\n    }\r\n    addPreference(\r\n        'Live coding support',\r\n        function () {\r\n            Process.prototype.enableLiveCoding =\r\n                !Process.prototype.enableLiveCoding;\r\n        },\r\n        Process.prototype.enableLiveCoding,\r\n        'EXPERIMENTAL! uncheck to disable live\\ncustom control structures',\r\n        'EXPERIMENTAL! check to enable\\n live custom control structures',\r\n        true\r\n    );\r\n    menu.addLine(); // everything below this line is stored in the project\r\n    addPreference(\r\n        'Thread safe scripts',\r\n        function () {stage.isThreadSafe = !stage.isThreadSafe; },\r\n        this.stage.isThreadSafe,\r\n        'uncheck to allow\\nscript reentrance',\r\n        'check to disallow\\nscript reentrance'\r\n    );\r\n    addPreference(\r\n        'Prefer smooth animations',\r\n        'toggleVariableFrameRate',\r\n        StageMorph.prototype.frameRate,\r\n        'uncheck for greater speed\\nat variable frame rates',\r\n        'check for smooth, predictable\\nanimations across computers',\r\n        true\r\n    );\r\n    addPreference(\r\n        'Flat line ends',\r\n        function () {\r\n            SpriteMorph.prototype.useFlatLineEnds =\r\n                !SpriteMorph.prototype.useFlatLineEnds;\r\n        },\r\n        SpriteMorph.prototype.useFlatLineEnds,\r\n        'uncheck for round ends of lines',\r\n        'check for flat ends of lines'\r\n    );\r\n    addPreference(\r\n        'Codification support',\r\n        function () {\r\n            StageMorph.prototype.enableCodeMapping =\r\n                !StageMorph.prototype.enableCodeMapping;\r\n            myself.currentSprite.blocksCache.variables = null;\r\n            myself.currentSprite.paletteCache.variables = null;\r\n            myself.refreshPalette();\r\n        },\r\n        StageMorph.prototype.enableCodeMapping,\r\n        'uncheck to disable\\nblock to text mapping features',\r\n        'check for block\\nto text mapping features',\r\n        false\r\n    );\r\n    addPreference(\r\n        'Inheritance support',\r\n        function () {\r\n            StageMorph.prototype.enableInheritance =\r\n                !StageMorph.prototype.enableInheritance;\r\n            myself.currentSprite.blocksCache.variables = null;\r\n            myself.currentSprite.paletteCache.variables = null;\r\n            myself.refreshPalette();\r\n        },\r\n        StageMorph.prototype.enableInheritance,\r\n        'uncheck to disable\\nsprite inheritance features',\r\n        'check for sprite\\ninheritance features',\r\n        false\r\n    );\r\n    addPreference(\r\n        'Persist linked sublist IDs',\r\n        function () {\r\n            StageMorph.prototype.enableSublistIDs =\r\n                !StageMorph.prototype.enableSublistIDs;\r\n        },\r\n        StageMorph.prototype.enableSublistIDs,\r\n        'uncheck to disable\\nsaving linked sublist identities',\r\n        'check to enable\\nsaving linked sublist identities',\r\n        true\r\n    );\r\n    menu.popup(world, pos);\r\n};\r\n\r\nIDE_Morph.prototype.projectMenu = function () {\r\n    var menu,\r\n        myself = this,\r\n        world = this.world(),\r\n        pos = this.controlBar.projectButton.bottomLeft(),\r\n        graphicsName = this.currentSprite instanceof SpriteMorph ?\r\n                'Costumes' : 'Backgrounds',\r\n        shiftClicked = (world.currentKey === 16);\r\n\r\n    menu = new MenuMorph(this);\r\n    menu.addItem('Project notes...', 'editProjectNotes');\r\n    menu.addLine();\r\n    menu.addPair('New', 'createNewProject', '^N');\r\n    menu.addPair('Open...', 'openProjectsBrowser', '^O');\r\n    menu.addPair('Save', \"save\", '^S');\r\n    menu.addItem('Save As...', 'saveProjectsBrowser');\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'Import...',\r\n        function () {\r\n            var inp = document.createElement('input');\r\n            if (myself.filePicker) {\r\n                document.body.removeChild(myself.filePicker);\r\n                myself.filePicker = null;\r\n            }\r\n            inp.type = 'file';\r\n            inp.style.color = \"transparent\";\r\n            inp.style.backgroundColor = \"transparent\";\r\n            inp.style.border = \"none\";\r\n            inp.style.outline = \"none\";\r\n            inp.style.position = \"absolute\";\r\n            inp.style.top = \"0px\";\r\n            inp.style.left = \"0px\";\r\n            inp.style.width = \"0px\";\r\n            inp.style.height = \"0px\";\r\n            inp.style.display = \"none\";\r\n            inp.addEventListener(\r\n                \"change\",\r\n                function () {\r\n                    document.body.removeChild(inp);\r\n                    myself.filePicker = null;\r\n                    world.hand.processDrop(inp.files);\r\n                },\r\n                false\r\n            );\r\n            document.body.appendChild(inp);\r\n            myself.filePicker = inp;\r\n            inp.click();     \r\n        },\r\n        'file menu import hint' // looks up the actual text in the translator\r\n    );\r\n\r\n    if (shiftClicked) {\r\n        menu.addItem(\r\n            localize(\r\n                'Export project...') + ' ' + localize('(in a new window)'\r\n            ),\r\n            function () {\r\n                if (myself.projectName) {\r\n                    myself.exportProject(myself.projectName, shiftClicked);\r\n                } else {\r\n                    myself.prompt('Export Project As...', function (name) {\r\n                        // false - override the shiftClick setting to use XML\r\n                        myself.exportProject(name, false);\r\n                    }, null, 'exportProject');\r\n                }\r\n            },\r\n            'show project data as XML\\nin a new browser window',\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n    menu.addItem(\r\n        shiftClicked ?\r\n                'Export project as plain text...' : 'Export project...',\r\n        function () {\r\n            if (myself.projectName) {\r\n                myself.exportProject(myself.projectName, shiftClicked);\r\n            } else {\r\n                myself.prompt('Export Project As...', function (name) {\r\n                    myself.exportProject(name, shiftClicked);\r\n                }, null, 'exportProject');\r\n            }\r\n        },\r\n        'save project data as XML\\nto your downloads folder',\r\n        shiftClicked ? new Color(100, 0, 0) : null\r\n    );\r\n\r\n    if (this.stage.globalBlocks.length) {\r\n        menu.addItem(\r\n            'Export blocks...',\r\n            function () {myself.exportGlobalBlocks(); },\r\n            'show global custom block definitions as XML' +\r\n                '\\nin a new browser window'\r\n        );\r\n        menu.addItem(\r\n            'Unused blocks...',\r\n            function () {myself.removeUnusedBlocks(); },\r\n            'find unused global custom blocks' +\r\n                '\\nand remove their definitions'\r\n        );\r\n    }\r\n\r\n    menu.addItem(\r\n        'Export summary...',\r\n        function () {myself.exportProjectSummary(); },\r\n        'open a new browser browser window\\n with a summary of this project'\r\n    );\r\n\r\n    if (shiftClicked) {\r\n        menu.addItem(\r\n            'Export summary with drop-shadows...',\r\n            function () {myself.exportProjectSummary(true); },\r\n            'open a new browser browser window' +\r\n                '\\nwith a summary of this project' +\r\n                '\\nwith drop-shadows on all pictures.' +\r\n                '\\nnot supported by all browsers',\r\n            new Color(100, 0, 0)\r\n        );\r\n        menu.addItem(\r\n            'Export all scripts as pic...',\r\n            function () {myself.exportScriptsPicture(); },\r\n            'show a picture of all scripts\\nand block definitions',\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'Import tools',\r\n        function () {\r\n            myself.getURL(\r\n                myself.resourceURL('tools.xml'),\r\n                function (txt) {\r\n                    myself.droppedText(txt, 'tools');\r\n                }\r\n            );\r\n        },\r\n        'load the official library of\\npowerful blocks'\r\n    );\r\n    menu.addItem(\r\n        'Libraries...',\r\n        function() {\r\n            myself.getURL(\r\n                myself.resourceURL('libraries', 'LIBRARIES'),\r\n                function (txt) {\r\n                    var libraries = myself.parseResourceFile(txt);\r\n                    new LibraryImportDialogMorph(myself, libraries).popUp();\r\n                }\r\n            );\r\n        },\r\n        'Select categories of additional blocks to add to this project.'\r\n    );\r\n\r\n    menu.addItem(\r\n        localize(graphicsName) + '...',\r\n        function () {\r\n            myself.importMedia(graphicsName);\r\n        },\r\n        'Select a costume from the media library'\r\n    );\r\n    menu.addItem(\r\n        localize('Sounds') + '...',\r\n        function () {\r\n            myself.importMedia('Sounds');\r\n        },\r\n        'Select a sound from the media library'\r\n    );\r\n\r\n    menu.popup(world, pos);\r\n};\r\n\r\nIDE_Morph.prototype.resourceURL = function () {\r\n    // Take in variadic inputs that represent an a nested folder structure.\r\n    // Method can be easily overridden if running in a custom location.\r\n    // Default Snap! simply returns a path (relative to snap.html)\r\n    var args = Array.prototype.slice.call(arguments, 0);\r\n    return args.join('/');\r\n};\r\n\r\nIDE_Morph.prototype.getMediaList = function (dirname, callback) {\r\n    // Invoke the given callback with a list of files in a directory\r\n    // based on the contents file.\r\n    // If no callback is specified, synchronously return the list of files\r\n    // Note: Synchronous fetching has been deprecated and should be switched\r\n    var url = this.resourceURL(dirname, dirname.toUpperCase()),\r\n        async = callback instanceof Function,\r\n        myself = this,\r\n        data;\r\n\r\n    function alphabetically(x, y) {\r\n        return x.name.toLowerCase() < y.name.toLowerCase() ? -1 : 1;\r\n    }\r\n\r\n    if (async) {\r\n        this.getURL(\r\n            url,\r\n            function (txt) {\r\n                var data = myself.parseResourceFile(txt);\r\n                data.sort(alphabetically);\r\n                callback.call(this, data);\r\n            }\r\n        );\r\n    } else {\r\n        data = this.parseResourceFile(this.getURL(url));\r\n        data.sort(alphabetically);\r\n        return data;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.parseResourceFile = function (text) {\r\n    // A Resource File lists all the files that could be loaded in a submenu\r\n    // Examples are libraries/LIBRARIES, Costumes/COSTUMES, etc\r\n    // The file format is tab-delimited, with unix newlines:\r\n    // file-name, Display Name, Help Text (optional)\r\n    var parts,\r\n        items = [];\r\n\r\n    text.split('\\n').map(function (line) {\r\n        return line.trim();\r\n    }).filter(function (line) {\r\n        return line.length > 0;\r\n    }).forEach(function (line) {\r\n        parts = line.split('\\t').map(function (str) { return str.trim(); });\r\n\r\n        if (parts.length < 2) {return; }\r\n\r\n        items.push({\r\n            fileName: parts[0],\r\n            name: parts[1],\r\n            description: parts.length > 2 ? parts[2] : ''\r\n        });\r\n    });\r\n\r\n    return items;\r\n};\r\n\r\nIDE_Morph.prototype.importMedia = function (folderName) {\r\n    // open a dialog box letting the user browse available \"built-in\"\r\n    // costumes, backgrounds or sounds\r\n    var myself = this,\r\n        msg = this.showMessage('Opening ' + folderName + '...');\r\n    this.getMediaList(\r\n        folderName,\r\n        function (items) {\r\n            msg.destroy();\r\n            myself.popupMediaImportDialog(folderName, items);\r\n        }\r\n    );\r\n\r\n};\r\n\r\nIDE_Morph.prototype.popupMediaImportDialog = function (folderName, items) {\r\n    // private - this gets called by importMedia() and creates\r\n    // the actual dialog\r\n    var dialog = new DialogBoxMorph().withKey('import' + folderName),\r\n        frame = new ScrollFrameMorph(),\r\n        selectedIcon = null,\r\n        turtle = new SymbolMorph('turtle', 60),\r\n        myself = this,\r\n        world = this.world(),\r\n        handle;\r\n\r\n    frame.acceptsDrops = false;\r\n    frame.contents.acceptsDrops = false;\r\n    frame.color = myself.groupColor;\r\n    frame.fixLayout = nop;\r\n    dialog.labelString = folderName;\r\n    dialog.createLabel();\r\n    dialog.addBody(frame);\r\n    dialog.addButton('ok', 'Import');\r\n    dialog.addButton('cancel', 'Cancel');\r\n\r\n    dialog.ok = function () {\r\n        if (selectedIcon) {\r\n            if (selectedIcon.object instanceof Sound) {\r\n                myself.droppedAudio(\r\n                    selectedIcon.object.copy().audio,\r\n                    selectedIcon.labelString\r\n                );\r\n            } else if (selectedIcon.object instanceof SVG_Costume) {\r\n                myself.droppedSVG(\r\n                    selectedIcon.object.contents,\r\n                    selectedIcon.labelString\r\n                );\r\n            } else {\r\n                myself.droppedImage(\r\n                    selectedIcon.object.contents,\r\n                    selectedIcon.labelString\r\n                );\r\n            }\r\n        }\r\n    };\r\n\r\n    dialog.fixLayout = function () {\r\n        var th = fontHeight(this.titleFontSize) + this.titlePadding * 2,\r\n            x = 0,\r\n            y = 0,\r\n            fp, fw;\r\n        this.buttons.fixLayout();\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.body.setExtent(new Point(\r\n            this.width() - this.padding * 2,\r\n            this.height() - this.padding * 3 - th - this.buttons.height()\r\n        ));\r\n        fp = this.body.position();\r\n        fw = this.body.width();\r\n        frame.contents.children.forEach(function (icon) {\r\n              icon.setPosition(fp.add(new Point(x, y)));\r\n            x += icon.width();\r\n            if (x + icon.width() > fw) {\r\n                x = 0;\r\n                y += icon.height();\r\n            }\r\n        });\r\n        frame.contents.adjustBounds();\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    };\r\n\r\n    items.forEach(function (item) {\r\n        // Caution: creating very many thumbnails can take a long time!\r\n        var url = myself.resourceURL(folderName, item.fileName),\r\n            img = new Image(),\r\n            suffix = url.slice(url.lastIndexOf('.') + 1).toLowerCase(),\r\n            isSVG = suffix === 'svg' && !MorphicPreferences.rasterizeSVGs,\r\n            isSound = contains(['wav', 'mp3'], suffix),\r\n            cstTemplate,\r\n            sndTemplate,\r\n            icon;\r\n\r\n        if (isSound) {\r\n            sndTemplate = icon = new SoundIconMorph(\r\n                new Sound(new Audio(), item.name),\r\n                sndTemplate\r\n            );\r\n        } else {\r\n            cstTemplate = icon = new CostumeIconMorph(\r\n                new Costume(turtle.image, item.name),\r\n                cstTemplate\r\n            );\r\n        }\r\n        icon.isDraggable = false;\r\n        icon.userMenu = nop;\r\n        icon.action = function () {\r\n            if (selectedIcon === icon) {return; }\r\n            var prevSelected = selectedIcon;\r\n            selectedIcon = icon;\r\n            if (prevSelected) {prevSelected.refresh(); }\r\n        };\r\n        icon.doubleClickAction = dialog.ok;\r\n        icon.query = function () {\r\n            return icon === selectedIcon;\r\n        };\r\n        frame.addContents(icon);\r\n        if (isSound) {\r\n            icon.object.audio.onloadeddata = function () {\r\n                icon.createThumbnail();\r\n                icon.fixLayout();\r\n                icon.refresh();\r\n            };\r\n\r\n            icon.object.audio.src = url;\r\n            icon.object.audio.load();\r\n        } else if (isSVG) {\r\n            img.onload = function () {\r\n                icon.object = new SVG_Costume(img, item.name);\r\n                icon.refresh();\r\n            };\r\n            myself.getURL(\r\n                url,\r\n                function (txt) {\r\n                    img.src = 'data:image/svg+xml;base64,' +\r\n                         window.btoa(txt);\r\n                }\r\n            );\r\n        } else {\r\n            img.onload = function () {\r\n                var canvas = newCanvas(new Point(img.width, img.height), true);\r\n                canvas.getContext('2d').drawImage(img, 0, 0);\r\n                icon.object = new Costume(canvas, item.name);\r\n                icon.refresh();\r\n            };\r\n            img.src = url;\r\n        }\r\n    });\r\n    dialog.popUp(world);\r\n    dialog.setExtent(new Point(400, 300));\r\n    dialog.setCenter(world.center());\r\n    dialog.drawNew();\r\n\r\n    handle = new HandleMorph(\r\n        dialog,\r\n        300,\r\n        280,\r\n        dialog.corner,\r\n        dialog.corner\r\n    );\r\n};\r\n\r\n// IDE_Morph menu actions\r\n\r\nIDE_Morph.prototype.aboutSnap = function () {\r\n    var dlg, aboutTxt, noticeTxt, creditsTxt, versions = '', translations,\r\n        module, btn1, btn2, btn3, btn4, licenseBtn, translatorsBtn,\r\n        world = this.world();\r\n\r\n    aboutTxt = 'Snap! 4.1.1 - dev -\\nBuild Your Own Blocks\\n\\n'\r\n        + 'Copyright \\u24B8 2017 Jens M\\u00F6nig and '\r\n        + 'Brian Harvey\\n'\r\n        + 'jens@moenig.org, bh@cs.berkeley.edu\\n\\n'\r\n\r\n        + 'Snap! is developed by the University of California, Berkeley\\n'\r\n        + '          with support from the National Science Foundation (NSF), '\r\n        + 'MioSoft,          \\n'\r\n        + 'the Communications Design Group (CDG) at SAP Labs, and the\\n'\r\n        + 'Human Advancement Research Community (HARC) at YC Research.\\n'\r\n\r\n        + 'The design of Snap! is influenced and inspired by Scratch,\\n'\r\n        + 'from the Lifelong Kindergarten group at the MIT Media Lab\\n\\n'\r\n\r\n        + 'for more information see http://snap.berkeley.edu\\n'\r\n        + 'and http://scratch.mit.edu';\r\n\r\n    noticeTxt = localize('License')\r\n        + '\\n\\n'\r\n        + 'Snap! is free software: you can redistribute it and/or modify\\n'\r\n        + 'it under the terms of the GNU Affero General Public License as\\n'\r\n        + 'published by the Free Software Foundation, either version 3 of\\n'\r\n        + 'the License, or (at your option) any later version.\\n\\n'\r\n\r\n        + 'This program is distributed in the hope that it will be useful,\\n'\r\n        + 'but WITHOUT ANY WARRANTY; without even the implied warranty of\\n'\r\n        + 'MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\\n'\r\n        + 'GNU Affero General Public License for more details.\\n\\n'\r\n\r\n        + 'You should have received a copy of the\\n'\r\n        + 'GNU Affero General Public License along with this program.\\n'\r\n        + 'If not, see http://www.gnu.org/licenses/\\n\\n'\r\n\r\n        + 'Want to use Snap! but scared by the open-source license?\\n'\r\n        + 'Get in touch with us, we\\'ll make it work.';\r\n\r\n    creditsTxt = localize('Contributors')\r\n        + '\\n\\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, '\r\n        + '\\ncountless bugfixes and optimizations'\r\n        + '\\nKartik Chandra: Paint Editor'\r\n        + '\\nMichael Ball: Time/Date UI, Library Import Dialog,'\r\n        + '\\ncountless bugfixes and optimizations'\r\n        + '\\nBartosz Leper: Retina Display Support'\r\n        + '\\nBernat Romagosa: Countless contributions'\r\n        + '\\n\"Ava\" Yuan Yuan, Dylan Servilla: Graphic Effects'\r\n        + '\\nKyle Hotchkiss: Block search design'\r\n        + '\\nBrian Broll: Many bugfixes and optimizations'\r\n        + '\\nIan Reynolds: UI Design, Event Bindings, '\r\n        + 'Sound primitives'\r\n        + '\\nIvan Motyashov: Initial Squeak Porting'\r\n        + '\\nLucas Karahadian: Piano Keyboard Design'\r\n        + '\\nDavide Della Casa: Morphic Optimizations'\r\n        + '\\nAchal Dave: Web Audio'\r\n        + '\\nJoe Otto: Morphic Testing and Debugging';\r\n\r\n    for (module in modules) {\r\n        if (Object.prototype.hasOwnProperty.call(modules, module)) {\r\n            versions += ('\\n' + module + ' (' +\r\n                            modules[module] + ')');\r\n        }\r\n    }\r\n    if (versions !== '') {\r\n        versions = localize('current module versions:') + ' \\n\\n' +\r\n            'morphic (' + morphicVersion + ')' +\r\n            versions;\r\n    }\r\n    translations = localize('Translations') + '\\n' + SnapTranslator.credits();\r\n\r\n    dlg = new DialogBoxMorph();\r\n    dlg.inform('About Snap', aboutTxt, world);\r\n    btn1 = dlg.buttons.children[0];\r\n    translatorsBtn = dlg.addButton(\r\n        function () {\r\n            dlg.body.text = translations;\r\n            dlg.body.drawNew();\r\n            btn1.show();\r\n            btn2.show();\r\n            btn3.hide();\r\n            btn4.hide();\r\n            licenseBtn.hide();\r\n            translatorsBtn.hide();\r\n            dlg.fixLayout();\r\n            dlg.drawNew();\r\n            dlg.setCenter(world.center());\r\n        },\r\n        'Translators...'\r\n    );\r\n    btn2 = dlg.addButton(\r\n        function () {\r\n            dlg.body.text = aboutTxt;\r\n            dlg.body.drawNew();\r\n            btn1.show();\r\n            btn2.hide();\r\n            btn3.show();\r\n            btn4.show();\r\n            licenseBtn.show();\r\n            translatorsBtn.hide();\r\n            dlg.fixLayout();\r\n            dlg.drawNew();\r\n            dlg.setCenter(world.center());\r\n        },\r\n        'Back...'\r\n    );\r\n    btn2.hide();\r\n    licenseBtn = dlg.addButton(\r\n        function () {\r\n            dlg.body.text = noticeTxt;\r\n            dlg.body.drawNew();\r\n            btn1.show();\r\n            btn2.show();\r\n            btn3.hide();\r\n            btn4.hide();\r\n            licenseBtn.hide();\r\n            translatorsBtn.hide();\r\n            dlg.fixLayout();\r\n            dlg.drawNew();\r\n            dlg.setCenter(world.center());\r\n        },\r\n        'License...'\r\n    );\r\n    btn3 = dlg.addButton(\r\n        function () {\r\n            dlg.body.text = versions;\r\n            dlg.body.drawNew();\r\n            btn1.show();\r\n            btn2.show();\r\n            btn3.hide();\r\n            btn4.hide();\r\n            licenseBtn.hide();\r\n            translatorsBtn.hide();\r\n            dlg.fixLayout();\r\n            dlg.drawNew();\r\n            dlg.setCenter(world.center());\r\n        },\r\n        'Modules...'\r\n    );\r\n    btn4 = dlg.addButton(\r\n        function () {\r\n            dlg.body.text = creditsTxt;\r\n            dlg.body.drawNew();\r\n            btn1.show();\r\n            btn2.show();\r\n            translatorsBtn.show();\r\n            btn3.hide();\r\n            btn4.hide();\r\n            licenseBtn.hide();\r\n            dlg.fixLayout();\r\n            dlg.drawNew();\r\n            dlg.setCenter(world.center());\r\n        },\r\n        'Credits...'\r\n    );\r\n    translatorsBtn.hide();\r\n    dlg.fixLayout();\r\n    dlg.drawNew();\r\n};\r\n\r\nIDE_Morph.prototype.editProjectNotes = function () {\r\n    var dialog = new DialogBoxMorph().withKey('projectNotes'),\r\n        frame = new ScrollFrameMorph(),\r\n        text = new TextMorph(this.projectNotes || ''),\r\n        ok = dialog.ok,\r\n        myself = this,\r\n        size = 250,\r\n        world = this.world();\r\n\r\n    frame.padding = 6;\r\n    frame.setWidth(size);\r\n    frame.acceptsDrops = false;\r\n    frame.contents.acceptsDrops = false;\r\n\r\n    text.setWidth(size - frame.padding * 2);\r\n    text.setPosition(frame.topLeft().add(frame.padding));\r\n    text.enableSelecting();\r\n    text.isEditable = true;\r\n\r\n    frame.setHeight(size);\r\n    frame.fixLayout = nop;\r\n    frame.edge = InputFieldMorph.prototype.edge;\r\n    frame.fontSize = InputFieldMorph.prototype.fontSize;\r\n    frame.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    frame.contrast = InputFieldMorph.prototype.contrast;\r\n    frame.drawNew = InputFieldMorph.prototype.drawNew;\r\n    frame.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    frame.addContents(text);\r\n    text.drawNew();\r\n\r\n    dialog.ok = function () {\r\n        myself.projectNotes = text.text;\r\n        ok.call(this);\r\n    };\r\n\r\n    dialog.justDropped = function () {\r\n        text.edit();\r\n    };\r\n\r\n    dialog.labelString = 'Project Notes';\r\n    dialog.createLabel();\r\n    dialog.addBody(frame);\r\n    frame.drawNew();\r\n    dialog.addButton('ok', 'OK');\r\n    dialog.addButton('cancel', 'Cancel');\r\n    dialog.fixLayout();\r\n    dialog.drawNew();\r\n    dialog.popUp(world);\r\n    dialog.setCenter(world.center());\r\n    text.edit();\r\n};\r\n\r\nIDE_Morph.prototype.newProject = function () {\r\n    this.source = SnapCloud.username ? 'cloud' : 'local';\r\n    if (this.stage) {\r\n        this.stage.destroy();\r\n    }\r\n    if (location.hash.substr(0, 6) !== '#lang:') {\r\n        location.hash = '';\r\n    }\r\n    this.globalVariables = new VariableFrame();\r\n    this.currentSprite = new SpriteMorph(this.globalVariables);\r\n    this.sprites = new List([this.currentSprite]);\r\n    StageMorph.prototype.dimensions = new Point(480, 360);\r\n    StageMorph.prototype.hiddenPrimitives = {};\r\n    StageMorph.prototype.codeMappings = {};\r\n    StageMorph.prototype.codeHeaders = {};\r\n    StageMorph.prototype.enableCodeMapping = false;\r\n    StageMorph.prototype.enableInheritance = true;\r\n    StageMorph.prototype.enableSublistIDs = false;\r\n    SpriteMorph.prototype.useFlatLineEnds = false;\r\n    Process.prototype.enableLiveCoding = false;\r\n    this.setProjectName('');\r\n    this.projectNotes = '';\r\n    this.createStage();\r\n    this.add(this.stage);\r\n    this.createCorral();\r\n    this.selectSprite(this.stage.children[0]);\r\n    this.fixLayout();\r\n};\r\n\r\nIDE_Morph.prototype.save = function () {\r\n  \r\n    if (this.source === 'examples') {\r\n        this.source = 'local'; // cannot save to examples\r\n    }\r\n    if (this.projectName) {\r\n        if (this.source === 'local') { // as well as 'examples'\r\n            this.saveProject(this.projectName);\r\n        } else { // 'cloud'\r\n            this.saveProjectToCloud(this.projectName);\r\n        }\r\n    } else {\r\n        this.saveProjectsBrowser();\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.saveProject = function (name) {\r\n  \r\n    var myself = this;\r\n    this.nextSteps([\r\n        function () {\r\n            myself.showMessage('Saving...');\r\n        },\r\n        function () {\r\n            myself.rawSaveProject(name);\r\n        }\r\n    ]);\r\n};\r\n\r\n// Serialize a project and save to the browser.\r\nIDE_Morph.prototype.rawSaveProject = function (name) {\r\n    var str; \r\n    if (name) {\r\n        this.setProjectName(name);\r\n        if (Process.prototype.isCatchingErrors) {\r\n            try {\r\n                localStorage['-snap-project-' + name]\r\n                    = str = this.serializer.serialize(this.stage); // Wiquid : Solution to save project \r\n                this.setURL('#open:' + str);\r\n                this.showMessage('Saved!', 1);\r\n                //stageSaver = this.serializer.serialize(this.stage);\r\n            } catch (err) {\r\n                this.showMessage('Save failed: ' + err);\r\n            }\r\n        } else {\r\n            localStorage['-snap-project-' + name]\r\n                = str = this.serializer.serialize(this.stage);\r\n            this.setURL('#open:' + str);\r\n            this.showMessage('Saved!', 1);\r\n            //stageSaver = this.serializer.serialize(this.stage);\r\n        }\r\n    }\r\n};\r\n\r\n\r\nIDE_Morph.prototype.exportProject = function (name, plain) {\r\n    // Export project XML, saving a file to disk\r\n    // newWindow requests displaying the project in a new tab.\r\n    var menu, str, dataPrefix;\r\n\r\n    if (name) {\r\n        this.setProjectName(name);\r\n        dataPrefix = 'data:text/' + plain ? 'plain,' : 'xml,';\r\n        try {\r\n            menu = this.showMessage('Exporting');\r\n            str = this.serializer.serialize(this.stage);\r\n            this.setURL('#open:' + dataPrefix + encodeURIComponent(str));\r\n            this.saveXMLAs(str, name);\r\n            menu.destroy();\r\n            this.showMessage('Exported!', 1);\r\n        } catch (err) {\r\n            if (Process.prototype.isCatchingErrors) {\r\n                this.showMessage('Export failed: ' + err);\r\n            } else {\r\n                throw err;\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.exportGlobalBlocks = function () {\r\n    if (this.stage.globalBlocks.length > 0) {\r\n        new BlockExportDialogMorph(\r\n            this.serializer,\r\n            this.stage.globalBlocks\r\n        ).popUp(this.world());\r\n    } else {\r\n        this.inform(\r\n            'Export blocks',\r\n            'this project doesn\\'t have any\\n'\r\n                + 'custom global blocks yet'\r\n        );\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.removeUnusedBlocks = function () {\r\n    var targets = this.sprites.asArray().concat([this.stage]),\r\n        globalBlocks = this.stage.globalBlocks,\r\n        unused = [],\r\n        isDone = false,\r\n        found;\r\n\r\n    function scan() {\r\n        return globalBlocks.filter(function (def) {\r\n            if (contains(unused, def)) {return false; }\r\n            return targets.every(function (each, trgIdx) {\r\n                return !(each.usesBlockInstance(def, true, trgIdx, unused));\r\n            });\r\n        });\r\n    }\r\n\r\n    while (!isDone) {\r\n        found = scan();\r\n        if (found.length) {\r\n            unused = unused.concat(found);\r\n        } else {\r\n            isDone = true;\r\n        }\r\n    }\r\n    if (unused.length > 0) {\r\n        new BlockRemovalDialogMorph(\r\n            unused,\r\n            this.stage\r\n        ).popUp(this.world());\r\n    } else {\r\n        this.inform(\r\n            'Remove unused blocks',\r\n            'there are currently no unused\\n'\r\n                + 'global custom blocks in this project'\r\n        );\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.exportSprite = function (sprite) {\r\n    var str = this.serializer.serialize(sprite.allParts());\r\n    str = '<sprites app=\"'\r\n        + this.serializer.app\r\n        + '\" version=\"'\r\n        + this.serializer.version\r\n        + '\">'\r\n        + str\r\n        + '</sprites>';\r\n    this.saveXMLAs(str, sprite.name);\r\n};\r\n\r\nIDE_Morph.prototype.exportScriptsPicture = function () {\r\n    var pics = [],\r\n        pic,\r\n        padding = 20,\r\n        w = 0,\r\n        h = 0,\r\n        y = 0,\r\n        ctx;\r\n\r\n    // collect all script pics\r\n    this.sprites.asArray().forEach(function (sprite) {\r\n        pics.push(sprite.image);\r\n        pics.push(sprite.scripts.scriptsPicture());\r\n        sprite.customBlocks.forEach(function (def) {\r\n            pics.push(def.scriptsPicture());\r\n        });\r\n    });\r\n    pics.push(this.stage.image);\r\n    pics.push(this.stage.scripts.scriptsPicture());\r\n    this.stage.customBlocks.forEach(function (def) {\r\n        pics.push(def.scriptsPicture());\r\n    });\r\n\r\n    // collect global block pics\r\n    this.stage.globalBlocks.forEach(function (def) {\r\n        pics.push(def.scriptsPicture());\r\n    });\r\n\r\n    pics = pics.filter(function (each) {return !isNil(each); });\r\n\r\n    // determine dimensions of composite\r\n    pics.forEach(function (each) {\r\n        w = Math.max(w, each.width);\r\n        h += (each.height);\r\n        h += padding;\r\n    });\r\n    h -= padding;\r\n    pic = newCanvas(new Point(w, h));\r\n    ctx = pic.getContext('2d');\r\n\r\n    // draw all parts\r\n    pics.forEach(function (each) {\r\n        ctx.drawImage(each, 0, y);\r\n        y += padding;\r\n        y += each.height;\r\n    });\r\n    this.saveCanvasAs(pic, this.projectName || localize('Untitled'));\r\n};\r\n\r\nIDE_Morph.prototype.exportProjectSummary = function (useDropShadows) {\r\n    var html, head, meta, css, body, pname, notes, toc, globalVars,\r\n        stage = this.stage;\r\n\r\n    function addNode(tag, node, contents) {\r\n        if (!node) {node = body; }\r\n        return new XML_Element(tag, contents, node);\r\n    }\r\n\r\n    function add(contents, tag, node) {\r\n        if (!tag) {tag = 'p'; }\r\n        if (!node) {node = body; }\r\n        return new XML_Element(tag, contents, node);\r\n    }\r\n\r\n    function addImage(canvas, node, inline) {\r\n        if (!node) {node = body; }\r\n        var para = !inline ? addNode('p', node) : null,\r\n            pic = addNode('img', para || node);\r\n        pic.attributes.src = canvas.toDataURL();\r\n        return pic;\r\n    }\r\n\r\n    function addVariables(varFrame) {\r\n        var names = varFrame.names().sort(),\r\n            isFirst = true,\r\n            ul;\r\n        if (names.length) {\r\n            add(localize('Variables'), 'h3');\r\n            names.forEach(function (name) {\r\n               \r\n                var watcher, listMorph, li, img;\r\n\r\n                if (isFirst) {\r\n                    ul = addNode('ul');\r\n                    isFirst = false;\r\n                }\r\n                li = addNode('li', ul);\r\n                watcher = new WatcherMorph(\r\n                    name,\r\n                    SpriteMorph.prototype.blockColor.variables,\r\n                    varFrame,\r\n                    name\r\n                );\r\n                listMorph = watcher.cellMorph.contentsMorph;\r\n                if (listMorph instanceof ListWatcherMorph) {\r\n                    listMorph.expand();\r\n                }\r\n                img = addImage(watcher.fullImageClassic(), li);\r\n                img.attributes.class = 'script';\r\n            });\r\n        }\r\n    }\r\n\r\n    function addBlocks(definitions) {\r\n        if (definitions.length) {\r\n            add(localize('Blocks'), 'h3');\r\n            SpriteMorph.prototype.categories.forEach(function (category) {\r\n                var isFirst = true,\r\n                    ul;\r\n                definitions.forEach(function (def) {\r\n                    var li, blockImg;\r\n                    if (def.category === category) {\r\n                        if (isFirst) {\r\n                            add(\r\n                                localize(\r\n                                    category[0].toUpperCase().concat(\r\n                                        category.slice(1)\r\n                                    )\r\n                                ),\r\n                                'h4'\r\n                            );\r\n                            ul = addNode('ul');\r\n                            isFirst = false;\r\n                        }\r\n                        li = addNode('li', ul);\r\n                        blockImg = addImage(\r\n                            def.templateInstance().scriptPic(),\r\n                            li\r\n                        );\r\n                        blockImg.attributes.class = 'script';\r\n                        def.sortedElements().forEach(function (script) {\r\n                            var defImg = addImage(\r\n                                script instanceof BlockMorph ?\r\n                                        script.scriptPic()\r\n                                                : script.fullImageClassic(),\r\n                                li\r\n                            );\r\n                            defImg.attributes.class = 'script';\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    }\r\n\r\n    pname = this.projectName || localize('untitled');\r\n\r\n    html = new XML_Element('html');\r\n    html.attributes.lang = SnapTranslator.language;\r\n    // html.attributes.contenteditable = 'true';\r\n\r\n    head = addNode('head', html);\r\n\r\n    meta = addNode('meta', head);\r\n    meta.attributes.charset = 'UTF-8';\r\n\r\n    if (useDropShadows) {\r\n        css = 'img {' +\r\n            'vertical-align: top;' +\r\n            'filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));' +\r\n            '-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));' +\r\n            '-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));' +\r\n            '}' +\r\n            '.toc {' +\r\n            'vertical-align: middle;' +\r\n            'padding: 2px 1em 2px 1em;' +\r\n            '}';\r\n    } else {\r\n        css = 'img {' +\r\n            'vertical-align: top;' +\r\n            '}' +\r\n            '.toc {' +\r\n            'vertical-align: middle;' +\r\n            'padding: 2px 1em 2px 1em;' +\r\n            '}' +\r\n            '.sprite {' +\r\n            'border: 1px solid lightgray;' +\r\n            '}';\r\n    }\r\n    addNode('style', head, css);\r\n\r\n    add(pname, 'title', head);\r\n\r\n\r\n    body = addNode('body', html);\r\n    add(pname, 'h1');\r\n\r\n    if (location.hash.indexOf('#present:') === 0) {\r\n        add(location.toString(), 'a', body).attributes.href =\r\n            location.toString();\r\n        addImage(\r\n            stage.thumbnail(stage.dimensions)\r\n        ).attributes.class = 'sprite';\r\n        add(this.serializer.app, 'h4');\r\n    } else {\r\n        add(this.serializer.app, 'h4');\r\n        addImage(\r\n            stage.thumbnail(stage.dimensions)\r\n        ).attributes.class = 'sprite';\r\n    }\r\n\r\n    // project notes\r\n    notes = Process.prototype.reportTextSplit(this.projectNotes, 'line');\r\n    notes.asArray().forEach(\r\n        function (paragraph) {add(paragraph); }\r\n    );\r\n\r\n    // table of contents\r\n    add(localize('Contents'), 'h4');\r\n    toc = addNode('ul');\r\n\r\n    // sprites & stage\r\n    this.sprites.asArray().concat([stage]).forEach(function (sprite) {\r\n        var tocEntry = addNode('li', toc),\r\n            scripts = sprite.scripts.sortedElements(),\r\n            cl = sprite.costumes.length(),\r\n            pic,\r\n            ol;\r\n\r\n        addNode('hr');\r\n        addImage(\r\n            sprite.thumbnail(new Point(40, 40)),\r\n            tocEntry,\r\n            true\r\n        ).attributes.class = 'toc';\r\n        add(sprite.name, 'a', tocEntry).attributes.href = '#' + sprite.name;\r\n\r\n        add(sprite.name, 'h2').attributes.id = sprite.name;\r\n        // if (sprite instanceof SpriteMorph || sprite.costume) {\r\n        pic = addImage(\r\n            sprite.thumbnail(sprite.extent().divideBy(stage.scale))\r\n        );\r\n        pic.attributes.class = 'sprite';\r\n        if (sprite instanceof SpriteMorph) {\r\n            if (sprite.exemplar) {\r\n                addImage(\r\n                    sprite.exemplar.thumbnail(new Point(40, 40)),\r\n                    add(localize('Kind of') + ' ' + sprite.exemplar.name),\r\n                    true\r\n                ).attributes.class = 'toc';\r\n            }\r\n            if (sprite.anchor) {\r\n                addImage(\r\n                    sprite.anchor.thumbnail(new Point(40, 40)),\r\n                    add(localize('Part of') + ' ' + sprite.anchor.name),\r\n                    true\r\n                ).attributes.class = 'toc';\r\n            }\r\n            if (sprite.parts.length) {\r\n                add(localize('Parts'), 'h3');\r\n                ol = addNode('ul');\r\n                sprite.parts.forEach(function (part) {\r\n                    var li = addNode('li', ol, part.name);\r\n                    addImage(part.thumbnail(new Point(40, 40)), li, true)\r\n                        .attributes.class = 'toc';\r\n                });\r\n            }\r\n        }\r\n\r\n        // costumes\r\n        if (cl > 1 || (sprite.getCostumeIdx() !== cl)) {\r\n            add(localize('Costumes'), 'h3');\r\n            ol = addNode('ol');\r\n            sprite.costumes.asArray().forEach(function (costume) {\r\n                var li = addNode('li', ol, costume.name);\r\n                addImage(costume.thumbnail(new Point(40, 40)), li, true)\r\n                    .attributes.class = 'toc';\r\n            });\r\n        }\r\n\r\n        // sounds\r\n        if (sprite.sounds.length()) {\r\n            add(localize('Sounds'), 'h3');\r\n            ol = addNode('ol');\r\n            sprite.sounds.asArray().forEach(function (sound) {\r\n                add(sound.name, 'li', ol);\r\n            });\r\n        }\r\n\r\n        // variables\r\n        addVariables(sprite.variables);\r\n\r\n        // scripts\r\n        if (scripts.length) {\r\n            add(localize('Scripts'), 'h3');\r\n            scripts.forEach(function (script) {\r\n                var img = addImage(script instanceof BlockMorph ?\r\n                        script.scriptPic()\r\n                                : script.fullImageClassic());\r\n                img.attributes.class = 'script';\r\n            });\r\n        }\r\n\r\n        // custom blocks\r\n        addBlocks(sprite.customBlocks);\r\n    });\r\n\r\n    // globals\r\n    globalVars = stage.globalVariables();\r\n    if (Object.keys(globalVars.vars).length || stage.globalBlocks.length) {\r\n        addNode('hr');\r\n        add(\r\n            localize('For all Sprites'),\r\n            'a',\r\n            addNode('li', toc)\r\n        ).attributes.href = '#global';\r\n        add(localize('For all Sprites'), 'h2').attributes.id = 'global';\r\n\r\n        // variables\r\n        addVariables(globalVars);\r\n\r\n        // custom blocks\r\n        addBlocks(stage.globalBlocks);\r\n    }\r\n\r\n    this.saveFileAs(\r\n        '<!DOCTYPE html>' + html.toString(),\r\n        'text/html;charset=utf-8',\r\n        pname\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.openProjectString = function (str) {\r\n    var msg,\r\n        myself = this;\r\n    this.nextSteps([\r\n        function () {\r\n            msg = myself.showMessage('Opening project...');\r\n        },\r\n        function () {nop(); }, // yield (bug in Chrome)\r\n        function () {\r\n            myself.rawOpenProjectString(str);\r\n        },\r\n        function () {\r\n            msg.destroy();\r\n        }\r\n    ]);\r\n};\r\n\r\nIDE_Morph.prototype.rawOpenProjectString = function (str) {\r\n    \r\n    this.toggleAppMode(false);\r\n    this.spriteBar.tabBar.tabTo('scripts');\r\n    StageMorph.prototype.hiddenPrimitives = {};\r\n    StageMorph.prototype.codeMappings = {};\r\n    StageMorph.prototype.codeHeaders = {};\r\n    StageMorph.prototype.enableCodeMapping = false;\r\n    StageMorph.prototype.enableInheritance = true;\r\n    StageMorph.prototype.enableSublistIDs = false;\r\n    Process.prototype.enableLiveCoding = false;\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            this.serializer.openProject(\r\n                this.serializer.load(str, this),\r\n                this\r\n            ); \r\n        } catch (err) {\r\n            this.showMessage('Load failed: ' + err);\r\n        }\r\n    } else {\r\n        this.serializer.openProject(\r\n            this.serializer.load(str, this),\r\n            this\r\n        );\r\n    }\r\n    this.stopFastTracking();\r\n\r\n     getSnapProjectScript = str; \r\n     config.customSnapContext.trigger('rawDefinitionChange',[str]);\r\n     importString = str;// Needed for persistance in authoring\r\n     config.snapScript = str; // needed because in local scope it keeps init value\r\n};\r\n\r\n\r\nIDE_Morph.prototype.openBlocksString = function (str, name, silently) {\r\n    var msg,\r\n        myself = this;\r\n    this.nextSteps([\r\n        function () {\r\n            msg = myself.showMessage('Opening blocks...');\r\n        },\r\n        function () {nop(); }, // yield (bug in Chrome)\r\n        function () {\r\n            myself.rawOpenBlocksString(str, name, silently);\r\n        },\r\n        function () {\r\n            msg.destroy();\r\n        }\r\n    ]);\r\n};\r\n\r\nIDE_Morph.prototype.rawOpenBlocksString = function (str, name, silently) {\r\n    // name is optional (string), so is silently (bool)\r\n    var blocks,\r\n        myself = this;\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            blocks = this.serializer.loadBlocks(str, myself.stage);\r\n            \r\n        } catch (err) {\r\n            this.showMessage('Load failed: ' + err);\r\n        }\r\n    } else {\r\n        blocks = this.serializer.loadBlocks(str, myself.stage);\r\n    }\r\n    if (silently) {\r\n        blocks.forEach(function (def) {\r\n            def.receiver = myself.stage;\r\n            myself.stage.globalBlocks.push(def);\r\n            myself.stage.replaceDoubleDefinitionsFor(def);\r\n        });\r\n        this.flushPaletteCache();\r\n        this.refreshPalette();\r\n        this.showMessage(\r\n            'Imported Blocks Module' + (name ? ': ' + name : '') + '.',\r\n            2\r\n        );\r\n    } else {\r\n        new BlockImportDialogMorph(blocks, this.stage, name).popUp();\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.openSpritesString = function (str) {\r\n    var msg,\r\n        myself = this;\r\n    this.nextSteps([\r\n        function () {\r\n            msg = myself.showMessage('Opening sprite...');\r\n        },\r\n        function () {nop(); }, // yield (bug in Chrome)\r\n        function () {\r\n            myself.rawOpenSpritesString(str);\r\n        },\r\n        function () {\r\n            msg.destroy();\r\n        }\r\n    ]);\r\n};\r\n\r\nIDE_Morph.prototype.rawOpenSpritesString = function (str) {\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            this.serializer.loadSprites(str, this);\r\n        } catch (err) {\r\n            this.showMessage('Load failed: ' + err);\r\n        }\r\n    } else {\r\n        this.serializer.loadSprites(str, this);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.openMediaString = function (str) {\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            this.serializer.loadMedia(str);\r\n        } catch (err) {\r\n            this.showMessage('Load failed: ' + err);\r\n        }\r\n    } else {\r\n        this.serializer.loadMedia(str);\r\n    }\r\n    this.showMessage('Imported Media Module.', 2);\r\n};\r\n\r\nIDE_Morph.prototype.openScriptString = function (str) {\r\n    var msg,\r\n        myself = this;\r\n    this.nextSteps([\r\n        function () {\r\n            msg = myself.showMessage('Opening script...');\r\n        },\r\n        function () {nop(); }, // yield (bug in Chrome)\r\n        function () {\r\n            myself.rawOpenScriptString(str);\r\n        },\r\n        function () {\r\n            msg.destroy();\r\n        }\r\n    ]);\r\n};\r\n\r\nIDE_Morph.prototype.rawOpenScriptString = function (str) {\r\n    var xml,\r\n        script,\r\n        scripts = this.currentSprite.scripts;\r\n\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            xml = this.serializer.parse(str, this.currentSprite);\r\n            script = this.serializer.loadScript(xml, this.currentSprite);\r\n        } catch (err) {\r\n            this.showMessage('Load failed: ' + err);\r\n        }\r\n    } else {\r\n        xml = this.serializer.loadScript(str, this.currentSprite);\r\n        script = this.serializer.loadScript(xml, this.currentSprite);\r\n    }\r\n    script.setPosition(this.world().hand.position());\r\n    scripts.add(script);\r\n    scripts.adjustBounds();\r\n    scripts.lastDroppedBlock = script;\r\n    scripts.recordDrop(\r\n\t\t{\r\n            origin: this.palette,\r\n            position: this.palette.center()\r\n        }\r\n    );\r\n    this.showMessage(\r\n        'Imported Script.',\r\n        2\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.openProject = function (name) {\r\n    var str;\r\n    if (name) {\r\n        this.showMessage('opening project\\n' + name);\r\n        this.setProjectName(name);\r\n        str = localStorage['-snap-project-' + name];\r\n        this.openProjectString(str);\r\n        this.setURL('#open:' + str);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.setURL = function (str) {\r\n    // Set the URL to a project's XML contents\r\n    if (this.projectsInURLs) {\r\n        location.hash = str;\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.saveFileAs = function (\r\n    contents,\r\n    fileType,\r\n    fileName\r\n) {\r\n    /** Allow for downloading a file to a disk.\r\n        This relies the FileSaver.js library which exports saveAs()\r\n        Two utility methods saveImageAs and saveXMLAs should be used first.\r\n    */\r\n    var blobIsSupported = false,\r\n        world = this.world(),\r\n        fileExt,\r\n        dialog;\r\n\r\n    // fileType is a <kind>/<ext>;<charset> format.\r\n    fileExt = fileType.split('/')[1].split(';')[0];\r\n    // handle text/plain as a .txt file\r\n    fileExt = '.' + (fileExt === 'plain' ? 'txt' : fileExt);\r\n\r\n    function dataURItoBlob(text, mimeType) {\r\n        var i,\r\n            data = text,\r\n            components = text.split(','),\r\n            hasTypeStr = text.indexOf('data:') === 0;\r\n        // Convert to binary data, in format Blob() can use.\r\n        if (hasTypeStr && components[0].indexOf('base64') > -1) {\r\n            text = atob(components[1]);\r\n            data = new Uint8Array(text.length);\r\n            i = text.length;\r\n            while (i--) {\r\n                data[i] = text.charCodeAt(i);\r\n            }\r\n        }\r\n        return new Blob([data], {type: mimeType });\r\n    }\r\n\r\n    try {\r\n        blobIsSupported = !!new Blob();\r\n    } catch (e) {}\r\n\r\n    if (blobIsSupported) {\r\n        if (!(contents instanceof Blob)) {\r\n            contents = dataURItoBlob(contents, fileType);\r\n        }\r\n        // download a file and delegate to FileSaver\r\n        // false: Do not preprend a BOM to the file.\r\n        saveAs(contents, fileName + fileExt, false);\r\n    } else {\r\n        dialog = new DialogBoxMorph();\r\n        dialog.inform(\r\n            localize('Could not export') + ' ' + fileName,\r\n            'unable to export text',\r\n            world\r\n        );\r\n        dialog.fixLayout();\r\n        dialog.drawNew();\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.saveCanvasAs = function (canvas, fileName) {\r\n    // Export a Canvas object as a PNG image\r\n    // Note: This commented out due to poor browser support.\r\n    // cavas.toBlob() is currently supported in Firefox, IE, Chrome but\r\n    // browsers prevent easily saving the generated files.\r\n    // Do not re-enable without revisiting issue #1191\r\n    // if (canvas.toBlob) {\r\n    //     var myself = this;\r\n    //     canvas.toBlob(function (blob) {\r\n    //         myself.saveFileAs(blob, 'image/png', fileName);\r\n    //     });\r\n    //     return;\r\n    // }\r\n\r\n    this.saveFileAs(canvas.toDataURL(), 'image/png', fileName);\r\n};\r\n\r\nIDE_Morph.prototype.saveXMLAs = function(xml, fileName) {\r\n    // wrapper to saving XML files with a proper type tag.\r\n    this.saveFileAs(xml, 'text/xml;chartset=utf-8', fileName);\r\n};\r\n\r\nIDE_Morph.prototype.switchToUserMode = function () {\r\n    var world = this.world();\r\n\r\n    world.isDevMode = false;\r\n    Process.prototype.isCatchingErrors = true;\r\n    this.controlBar.updateLabel();\r\n    this.isAutoFill = true;\r\n    this.isDraggable = false;\r\n    this.reactToWorldResize(world.bounds.copy());\r\n    this.siblings().forEach(function (morph) {\r\n        if (morph instanceof DialogBoxMorph) {\r\n            world.add(morph); // bring to front\r\n        } else {\r\n            morph.destroy();\r\n        }\r\n    });\r\n    this.flushBlocksCache();\r\n    this.refreshPalette();\r\n    // prevent non-DialogBoxMorphs from being dropped\r\n    // onto the World in user-mode\r\n    world.reactToDropOf = function (morph) {\r\n        if (!(morph instanceof DialogBoxMorph)) {\r\n            if (world.hand.grabOrigin) {\r\n                morph.slideBackTo(world.hand.grabOrigin);\r\n            } else {\r\n                world.hand.grab(morph);\r\n            }\r\n        }\r\n    };\r\n    this.showMessage('entering user mode', 1);\r\n\r\n};\r\n\r\nIDE_Morph.prototype.switchToDevMode = function () {\r\n    var world = this.world();\r\n\r\n    world.isDevMode = true;\r\n    Process.prototype.isCatchingErrors = false;\r\n    this.controlBar.updateLabel();\r\n    this.isAutoFill = false;\r\n    this.isDraggable = true;\r\n    this.setExtent(world.extent().subtract(100));\r\n    this.setPosition(world.position().add(20));\r\n    this.flushBlocksCache();\r\n    this.refreshPalette();\r\n    // enable non-DialogBoxMorphs to be dropped\r\n    // onto the World in dev-mode\r\n    delete world.reactToDropOf;\r\n    this.showMessage(\r\n        'entering development mode.\\n\\n'\r\n            + 'error catching is turned off,\\n'\r\n            + 'use the browser\\'s web console\\n'\r\n            + 'to see error messages.'\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.flushBlocksCache = function (category) {\r\n    // if no category is specified, the whole cache gets flushed\r\n    if (category) {\r\n        this.stage.blocksCache[category] = null;\r\n        this.stage.children.forEach(function (m) {\r\n            if (m instanceof SpriteMorph) {\r\n                m.blocksCache[category] = null;\r\n            }\r\n        });\r\n    } else {\r\n        this.stage.blocksCache = {};\r\n        this.stage.children.forEach(function (m) {\r\n            if (m instanceof SpriteMorph) {\r\n                m.blocksCache = {};\r\n            }\r\n        });\r\n    }\r\n    this.flushPaletteCache(category);\r\n};\r\n\r\nIDE_Morph.prototype.flushPaletteCache = function (category) {\r\n    // if no category is specified, the whole cache gets flushed\r\n    if (category) {\r\n        this.stage.paletteCache[category] = null;\r\n        this.stage.children.forEach(function (m) {\r\n            if (m instanceof SpriteMorph) {\r\n                m.paletteCache[category] = null;\r\n            }\r\n        });\r\n    } else {\r\n        this.stage.paletteCache = {};\r\n        this.stage.children.forEach(function (m) {\r\n            if (m instanceof SpriteMorph) {\r\n                m.paletteCache = {};\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.toggleZebraColoring = function () {\r\n    var scripts = [];\r\n\r\n    if (!BlockMorph.prototype.zebraContrast) {\r\n        BlockMorph.prototype.zebraContrast = 40;\r\n    } else {\r\n        BlockMorph.prototype.zebraContrast = 0;\r\n    }\r\n\r\n    // select all scripts:\r\n    this.stage.children.concat(this.stage).forEach(function (morph) {\r\n        if (isSnapObject(morph)) {\r\n            scripts = scripts.concat(\r\n                morph.scripts.children.filter(function (morph) {\r\n                    return morph instanceof BlockMorph;\r\n                })\r\n            );\r\n        }\r\n    });\r\n\r\n    // force-update all scripts:\r\n    scripts.forEach(function (topBlock) {\r\n        topBlock.fixBlockColor(null, true);\r\n    });\r\n};\r\n\r\nIDE_Morph.prototype.toggleDynamicInputLabels = function () {\r\n    var projectData;\r\n    SyntaxElementMorph.prototype.dynamicInputLabels =\r\n        !SyntaxElementMorph.prototype.dynamicInputLabels;\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            projectData = this.serializer.serialize(this.stage);\r\n        } catch (err) {\r\n            this.showMessage('Serialization failed: ' + err);\r\n        }\r\n    } else {\r\n        projectData = this.serializer.serialize(this.stage);\r\n    }\r\n    SpriteMorph.prototype.initBlocks();\r\n    this.spriteBar.tabBar.tabTo('scripts');\r\n    this.createCategories();\r\n    this.createCorralBar();\r\n    this.openProjectString(projectData);\r\n};\r\n\r\nIDE_Morph.prototype.toggleBlurredShadows = function () {\r\n    window.useBlurredShadows = !useBlurredShadows;\r\n};\r\n\r\nIDE_Morph.prototype.toggleLongFormInputDialog = function () {\r\n    InputSlotDialogMorph.prototype.isLaunchingExpanded =\r\n        !InputSlotDialogMorph.prototype.isLaunchingExpanded;\r\n    if (InputSlotDialogMorph.prototype.isLaunchingExpanded) {\r\n        this.saveSetting('longform', true);\r\n    } else {\r\n        this.removeSetting('longform');\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.togglePlainPrototypeLabels = function () {\r\n    BlockLabelPlaceHolderMorph.prototype.plainLabel =\r\n        !BlockLabelPlaceHolderMorph.prototype.plainLabel;\r\n    if (BlockLabelPlaceHolderMorph.prototype.plainLabel) {\r\n        this.saveSetting('plainprototype', true);\r\n    } else {\r\n        this.removeSetting('plainprototype');\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.togglePreferEmptySlotDrops = function () {\r\n    ScriptsMorph.prototype.isPreferringEmptySlots =\r\n        !ScriptsMorph.prototype.isPreferringEmptySlots;\r\n};\r\n\r\nIDE_Morph.prototype.toggleVirtualKeyboard = function () {\r\n    MorphicPreferences.useVirtualKeyboard =\r\n        !MorphicPreferences.useVirtualKeyboard;\r\n};\r\n\r\nIDE_Morph.prototype.toggleInputSliders = function () {\r\n    MorphicPreferences.useSliderForInput =\r\n        !MorphicPreferences.useSliderForInput;\r\n};\r\n\r\nIDE_Morph.prototype.toggleSliderExecute = function () {\r\n    ArgMorph.prototype.executeOnSliderEdit =\r\n        !ArgMorph.prototype.executeOnSliderEdit;\r\n};\r\n\r\nIDE_Morph.prototype.toggleAppMode = function (appMode) {\r\n    var world = this.world(),\r\n        elements = [\r\n            this.logo,\r\n            this.controlBar.cloudButton,\r\n            this.controlBar.projectButton,\r\n            this.controlBar.settingsButton,\r\n            this.controlBar.steppingButton,\r\n            this.controlBar.stageSizeButton,\r\n            this.paletteHandle,\r\n            this.stageHandle,\r\n            this.corral,\r\n            this.corralBar,\r\n            this.spriteEditor,\r\n            this.spriteBar,\r\n            this.palette,\r\n            this.categories\r\n        ];\r\n\r\n    this.isAppMode = isNil(appMode) ? !this.isAppMode : appMode;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n    if (this.isAppMode) {\r\n\t\tthis.wasSingleStepping = Process.prototype.enableSingleStepping;\r\n\t\tif (this.wasSingleStepping) {\r\n     \t\tthis.toggleSingleStepping();\r\n    \t}\r\n        this.setColor(this.appModeColor);\r\n        this.controlBar.setColor(this.color);\r\n        this.controlBar.appModeButton.refresh();\r\n        elements.forEach(function (e) {\r\n            e.hide();\r\n        });\r\n        world.children.forEach(function (morph) {\r\n            if (morph instanceof DialogBoxMorph) {\r\n                morph.hide();\r\n            }\r\n        });\r\n        if (world.keyboardReceiver instanceof ScriptFocusMorph) {\r\n            world.keyboardReceiver.stopEditing();\r\n        }\r\n    } else {\r\n        if (this.wasSingleStepping && !Process.prototype.enableSingleStepping) {\r\n             this.toggleSingleStepping();\r\n        }\r\n        this.setColor(this.backgroundColor);\r\n        this.controlBar.setColor(this.frameColor);\r\n        elements.forEach(function (e) {\r\n            e.show();\r\n        });\r\n        this.stage.setScale(1);\r\n        // show all hidden dialogs\r\n        world.children.forEach(function (morph) {\r\n            if (morph instanceof DialogBoxMorph) {\r\n                morph.show();\r\n            }\r\n        });\r\n        // prevent scrollbars from showing when morph appears\r\n        world.allChildren().filter(function (c) {\r\n            return c instanceof ScrollFrameMorph;\r\n        }).forEach(function (s) {\r\n            s.adjustScrollBars();\r\n        });\r\n        // prevent rotation and draggability controls from\r\n        // showing for the stage\r\n        if (this.currentSprite === this.stage) {\r\n            this.spriteBar.children.forEach(function (child) {\r\n                if (child instanceof PushButtonMorph) {\r\n                    child.hide();\r\n                }\r\n            });\r\n        }\r\n        // update undrop controls\r\n        this.currentSprite.scripts.updateToolbar();\r\n    }\r\n    this.setExtent(this.world().extent()); // resume trackChanges\r\n};\r\n\r\nIDE_Morph.prototype.toggleStageSize = function (isSmall, forcedRatio) {\r\n    var myself = this,\r\n        smallRatio = forcedRatio || 0.5,\r\n        msecs = this.isAnimating ? 100 : 0,\r\n        world = this.world(),\r\n        shiftClicked = (world.currentKey === 16),\r\n        altClicked = (world.currentKey === 18);\r\n\r\n    function toggle() {\r\n        myself.isSmallStage = isNil(isSmall) ? !myself.isSmallStage : isSmall;\r\n    }\r\n\r\n    function zoomTo(targetRatio) {\r\n        myself.isSmallStage = true;\r\n        world.animations.push(new Animation(\r\n            function (ratio) {\r\n                myself.stageRatio = ratio;\r\n                myself.setExtent(world.extent());\r\n            },\r\n            function () {\r\n                return myself.stageRatio;\r\n            },\r\n            targetRatio - myself.stageRatio,\r\n            msecs,\r\n            null, // easing\r\n            function () {\r\n                myself.isSmallStage = (targetRatio !== 1);\r\n                myself.controlBar.stageSizeButton.refresh();\r\n            }\r\n        ));\r\n    }\r\n\r\n    if (shiftClicked) {\r\n        smallRatio = SpriteIconMorph.prototype.thumbSize.x * 3 /\r\n            this.stage.dimensions.x;\r\n        if (!this.isSmallStage || (smallRatio === this.stageRatio)) {\r\n            toggle();\r\n        }\r\n    } else if (altClicked) {\r\n        smallRatio = this.width() / 2 /\r\n            this.stage.dimensions.x;\r\n        if (!this.isSmallStage || (smallRatio === this.stageRatio)) {\r\n            toggle();\r\n        }\r\n    } else {\r\n        toggle();\r\n    }\r\n    if (this.isSmallStage) {\r\n        zoomTo(smallRatio);\r\n    } else {\r\n        zoomTo(1);\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.setPaletteWidth = function (newWidth) {\r\n    var msecs = this.isAnimating ? 100 : 0,\r\n        world = this.world(),\r\n        myself = this;\r\n\r\n    world.animations.push(new Animation(\r\n        function (newWidth) {\r\n            myself.paletteWidth = newWidth;\r\n            myself.setExtent(world.extent());\r\n        },\r\n        function () {\r\n            return myself.paletteWidth;\r\n        },\r\n        newWidth - myself.paletteWidth,\r\n        msecs\r\n    ));\r\n};\r\n\r\nIDE_Morph.prototype.createNewProject = function () {\r\n    var myself = this;\r\n    this.confirm(\r\n        'Replace the current project with a new one?',\r\n        'New Project',\r\n        function () {myself.newProject(); }\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.openProjectsBrowser = function () {\r\n    new ProjectDialogMorph(this, 'open').popUp();\r\n};\r\n\r\nIDE_Morph.prototype.saveProjectsBrowser = function () {\r\n    if (this.source === 'examples') {\r\n        this.source = 'local'; // cannot save to examples\r\n    }\r\n    new ProjectDialogMorph(this, 'save').popUp();\r\n};\r\n\r\n// IDE_Morph localization\r\n\r\nIDE_Morph.prototype.languageMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        world = this.world(),\r\n        pos = this.controlBar.settingsButton.bottomLeft(),\r\n        myself = this;\r\n    SnapTranslator.languages().forEach(function (lang) {\r\n        menu.addItem(\r\n            (SnapTranslator.language === lang ? '\\u2713 ' : '    ') +\r\n                SnapTranslator.languageName(lang),\r\n            function () {\r\n                myself.loadNewProject = false;\r\n                myself.setLanguage(lang);\r\n            }\r\n        );\r\n    });\r\n    menu.popup(world, pos);\r\n};\r\n\r\n//********************Wiquid************************\r\n\r\nIDE_Morph.prototype.setLanguage = function (lang, callback) {\r\n    \r\n    if(getSnapProjectScript != \"scriptPlaceHolder\"){importString = getSnapProjectScript;}\r\n      this.openDefaultProject(importString); //Wiquid SOLUTION.\r\n     \r\n       //Both importString and getsnapprojectScript are needed to keep the project chosen in authoring even if options are changing.  \r\n    \r\n       \r\n};\r\n\r\nIDE_Morph.prototype.openDefaultProject = function (impString){\r\n\r\n    var str = impString; //Wiquid Solution \r\n           if(impString != \"\"){this.openProjectString(str);\r\n        }\r\n               \r\n} \r\n\r\n//***************************************************\r\n\r\nIDE_Morph.prototype.reflectLanguage = function (lang, callback) {\r\n    var projectData,\r\n        urlBar = location.hash;\r\n    SnapTranslator.language = lang;\r\n    if (!this.loadNewProject) {\r\n        if (Process.prototype.isCatchingErrors) {\r\n            try {\r\n                projectData = this.serializer.serialize(this.stage);\r\n            } catch (err) {\r\n                this.showMessage('Serialization failed: ' + err);\r\n            }\r\n        } else {\r\n            projectData = this.serializer.serialize(this.stage);\r\n        }\r\n    }\r\n    SpriteMorph.prototype.initBlocks();\r\n    this.spriteBar.tabBar.tabTo('scripts');\r\n    this.createCategories();\r\n    this.createCorralBar();\r\n    this.fixLayout();\r\n    if (this.loadNewProject) {\r\n        this.newProject();\r\n        location.hash = urlBar;\r\n    } else {\r\n        this.openProjectString(projectData);\r\n    }\r\n    this.saveSetting('language', lang);\r\n    if (callback) {callback.call(this); }\r\n};\r\n\r\n// IDE_Morph blocks scaling\r\n\r\nIDE_Morph.prototype.userSetBlocksScale = function () {\r\n    var myself = this,\r\n        scrpt,\r\n        blck,\r\n        shield,\r\n        sample,\r\n        action;\r\n\r\n    scrpt = new CommandBlockMorph();\r\n    scrpt.color = SpriteMorph.prototype.blockColor.motion;\r\n    scrpt.setSpec(localize('build'));\r\n    blck = new CommandBlockMorph();\r\n    blck.color = SpriteMorph.prototype.blockColor.sound;\r\n    blck.setSpec(localize('your own'));\r\n    scrpt.nextBlock(blck);\r\n    blck = new CommandBlockMorph();\r\n    blck.color = SpriteMorph.prototype.blockColor.operators;\r\n    blck.setSpec(localize('blocks'));\r\n    scrpt.bottomBlock().nextBlock(blck);\r\n   \r\n\r\n    sample = new FrameMorph();\r\n    sample.acceptsDrops = false;\r\n    sample.color = IDE_Morph.prototype.groupColor;\r\n    sample.cachedTexture = this.scriptsPaneTexture;\r\n    sample.setExtent(new Point(250, 180));\r\n    scrpt.setPosition(sample.position().add(10));\r\n    sample.add(scrpt);\r\n\r\n    shield = new Morph();\r\n    shield.alpha = 0;\r\n    shield.setExtent(sample.extent());\r\n    shield.setPosition(sample.position());\r\n    sample.add(shield);\r\n\r\n    action = function (num) {\r\n    \r\n        scrpt.blockSequence().forEach(function (block) {\r\n            block.setScale(num);\r\n            block.drawNew();\r\n            block.setSpec(block.blockSpec);\r\n        });\r\n        scrpt.changed();\r\n    };\r\n\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (num) {\r\n            myself.setBlocksScale(Math.min(num, 12));\r\n        }\r\n    ).withKey('zoomBlocks').prompt(\r\n        'Zoom blocks',\r\n        SyntaxElementMorph.prototype.scale.toString(),\r\n        this.world(),\r\n        sample, // pic\r\n        {\r\n            'normal (1x)' : 1,\r\n            'demo (1.2x)' : 1.2,\r\n            'presentation (1.4x)' : 1.4,\r\n            'big (2x)' : 2,\r\n            'huge (4x)' : 4,\r\n            'giant (8x)' : 8,\r\n            'monstrous (10x)' : 10\r\n        },\r\n        false, // read only?\r\n        true, // numeric\r\n        1, // slider min\r\n        12, // slider max\r\n        action // slider action\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.setBlocksScale = function (num) {\r\n    var projectData;\r\n    if (Process.prototype.isCatchingErrors) {\r\n        try {\r\n            projectData = this.serializer.serialize(this.stage);\r\n        } catch (err) {\r\n            this.showMessage('Serialization failed: ' + err);\r\n        }\r\n    } else {\r\n        projectData = this.serializer.serialize(this.stage);\r\n    }\r\n    SyntaxElementMorph.prototype.setScale(num);\r\n    CommentMorph.prototype.refreshScale();\r\n    SpriteMorph.prototype.initBlocks();\r\n    this.spriteBar.tabBar.tabTo('scripts');\r\n    this.createCategories();\r\n    this.createCorralBar();\r\n    this.fixLayout();\r\n    this.openProjectString(projectData);\r\n    this.saveSetting('zoom', num);\r\n};\r\n\r\n// IDE_Morph stage size manipulation\r\n\r\nIDE_Morph.prototype.userSetStageSize = function () {\r\n    new DialogBoxMorph(\r\n        this,\r\n        this.setStageExtent,\r\n        this\r\n    ).promptVector(\r\n        \"Stage size\",\r\n        StageMorph.prototype.dimensions,\r\n        new Point(480, 360),\r\n        'Stage width',\r\n        'Stage height',\r\n        this.world(),\r\n        null, // pic\r\n        null // msg\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.setStageExtent = function (aPoint) {\r\n    var myself = this,\r\n        world = this.world(),\r\n        ext = aPoint.max(new Point(240, 180));\r\n\r\n    function zoom() {\r\n        myself.step = function () {\r\n            var delta = ext.subtract(\r\n                StageMorph.prototype.dimensions\r\n            ).divideBy(2);\r\n            if (delta.abs().lt(new Point(5, 5))) {\r\n                StageMorph.prototype.dimensions = ext;\r\n                delete myself.step;\r\n            } else {\r\n                StageMorph.prototype.dimensions =\r\n                    StageMorph.prototype.dimensions.add(delta);\r\n            }\r\n            myself.stage.setExtent(StageMorph.prototype.dimensions);\r\n            myself.stage.clearPenTrails();\r\n            myself.fixLayout();\r\n            this.setExtent(world.extent());\r\n        };\r\n    }\r\n\r\n    this.stageRatio = 1;\r\n    this.isSmallStage = false;\r\n    this.controlBar.stageSizeButton.refresh();\r\n    this.setExtent(world.extent());\r\n    if (this.isAnimating) {\r\n        zoom();\r\n    } else {\r\n        StageMorph.prototype.dimensions = ext;\r\n        this.stage.setExtent(StageMorph.prototype.dimensions);\r\n        this.stage.clearPenTrails();\r\n        this.fixLayout();\r\n        this.setExtent(world.extent());\r\n    }\r\n};\r\n\r\n// IDE_Morph dragging threshold (internal feature)\r\n\r\nIDE_Morph.prototype.userSetDragThreshold = function () {\r\n    new DialogBoxMorph(\r\n        this,\r\n        function (num) {\r\n            MorphicPreferences.grabThreshold = Math.min(\r\n                Math.max(+num, 0),\r\n                200\r\n            );\r\n        },\r\n        this\r\n    ).prompt(\r\n        \"Dragging threshold\",\r\n        MorphicPreferences.grabThreshold.toString(),\r\n        this.world(),\r\n        null, // pic\r\n        null, // choices\r\n        null, // read only\r\n        true // numeric\r\n    );\r\n};\r\n\r\n// IDE_Morph cloud interface\r\n\r\nIDE_Morph.prototype.initializeCloud = function () {\r\n    var myself = this,\r\n        world = this.world();\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (user) {\r\n            var pwh = hex_sha512(user.password),\r\n                str;\r\n            SnapCloud.login(\r\n                user.username,\r\n                pwh,\r\n                function () {\r\n                    if (user.choice) {\r\n                        str = SnapCloud.encodeDict(\r\n                            {\r\n                                username: user.username,\r\n                                password: pwh\r\n                            }\r\n                        );\r\n                        localStorage['-snap-user'] = str;\r\n                    }\r\n                    myself.source = 'cloud';\r\n                    myself.showMessage('now connected.', 2);\r\n                },\r\n                myself.cloudError()\r\n            );\r\n        }\r\n    ).withKey('cloudlogin').promptCredentials(\r\n        'Sign in',\r\n        'login',\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        'stay signed in on this computer\\nuntil logging out',\r\n        world,\r\n        myself.cloudIcon(),\r\n        myself.cloudMsg\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.createCloudAccount = function () {\r\n    var myself = this,\r\n        world = this.world();\r\n/*\r\n    // force-logout, commented out for now:\r\n    delete localStorage['-snap-user'];\r\n    SnapCloud.clear();\r\n*/\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (user) {\r\n            SnapCloud.signup(\r\n                user.username,\r\n                user.email,\r\n                function (txt, title) {\r\n                    new DialogBoxMorph().inform(\r\n                        title,\r\n                        txt +\r\n                            '.\\n\\nAn e-mail with your password\\n' +\r\n                            'has been sent to the address provided',\r\n                        world,\r\n                        myself.cloudIcon(null, new Color(0, 180, 0))\r\n                    );\r\n                },\r\n                myself.cloudError()\r\n            );\r\n        }\r\n    ).withKey('cloudsignup').promptCredentials(\r\n        'Sign up',\r\n        'signup',\r\n        'http://snap.berkeley.edu/tos.html',\r\n        'Terms of Service...',\r\n        'http://snap.berkeley.edu/privacy.html',\r\n        'Privacy...',\r\n        'I have read and agree\\nto the Terms of Service',\r\n        world,\r\n        myself.cloudIcon(),\r\n        myself.cloudMsg\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.resetCloudPassword = function () {\r\n    var myself = this,\r\n        world = this.world();\r\n/*\r\n    // force-logout, commented out for now:\r\n    delete localStorage['-snap-user'];\r\n    SnapCloud.clear();\r\n*/\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (user) {\r\n            SnapCloud.resetPassword(\r\n                user.username,\r\n                function (txt, title) {\r\n                    new DialogBoxMorph().inform(\r\n                        title,\r\n                        txt +\r\n                            '.\\n\\nAn e-mail with a link to\\n' +\r\n                            'reset your password\\n' +\r\n                            'has been sent to the address provided',\r\n                        world,\r\n                        myself.cloudIcon(null, new Color(0, 180, 0))\r\n                    );\r\n                },\r\n                myself.cloudError()\r\n            );\r\n        }\r\n    ).withKey('cloudresetpassword').promptCredentials(\r\n        'Reset password',\r\n        'resetPassword',\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        world,\r\n        myself.cloudIcon(),\r\n        myself.cloudMsg\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.changeCloudPassword = function () {\r\n    var myself = this,\r\n        world = this.world();\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (user) {\r\n            SnapCloud.changePassword(\r\n                user.oldpassword,\r\n                user.password,\r\n                function () {\r\n                    myself.logout();\r\n                    myself.showMessage('password has been changed.', 2);\r\n                },\r\n                myself.cloudError()\r\n            );\r\n        }\r\n    ).withKey('cloudpassword').promptCredentials(\r\n        'Change Password',\r\n        'changePassword',\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        null,\r\n        world,\r\n        myself.cloudIcon(),\r\n        myself.cloudMsg\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.logout = function () {\r\n    var myself = this;\r\n    delete localStorage['-snap-user'];\r\n    SnapCloud.logout(\r\n        function () {\r\n            SnapCloud.clear();\r\n            myself.showMessage('disconnected.', 2);\r\n        },\r\n        function () {\r\n            SnapCloud.clear();\r\n            myself.showMessage('disconnected.', 2);\r\n        }\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.saveProjectToCloud = function (name) {\r\n    var myself = this;\r\n    if (name) {\r\n        this.showMessage('Saving project\\nto the cloud...');\r\n        this.setProjectName(name);\r\n        SnapCloud.saveProject(\r\n            this,\r\n            function () {myself.showMessage('saved.', 2); },\r\n            this.cloudError()\r\n        );\r\n    }\r\n};\r\n\r\nIDE_Morph.prototype.exportProjectMedia = function (name) {\r\n    var menu, media;\r\n    this.serializer.isCollectingMedia = true;\r\n    if (name) {\r\n        this.setProjectName(name);\r\n        try {\r\n            menu = this.showMessage('Exporting');\r\n            media = this.serializer.mediaXML(name);\r\n            this.saveXMLAs(media, this.projectName + ' media');\r\n            menu.destroy();\r\n            this.showMessage('Exported!', 1);\r\n        } catch (err) {\r\n            if (Process.prototype.isCatchingErrors) {\r\n                this.serializer.isCollectingMedia = false;\r\n                this.showMessage('Export failed: ' + err);\r\n            } else {\r\n                throw err;\r\n            }\r\n        }\r\n    }\r\n    this.serializer.isCollectingMedia = false;\r\n    this.serializer.flushMedia();\r\n    // this.hasChangedMedia = false;\r\n};\r\n\r\nIDE_Morph.prototype.exportProjectNoMedia = function (name) {\r\n    var menu, str;\r\n    this.serializer.isCollectingMedia = true;\r\n    if (name) {\r\n        this.setProjectName(name);\r\n        if (Process.prototype.isCatchingErrors) {\r\n            try {\r\n                menu = this.showMessage('Exporting');\r\n                str = this.serializer.serialize(this.stage);\r\n                this.saveXMLAs(str, this.projectName);\r\n                menu.destroy();\r\n                this.showMessage('Exported!', 1);\r\n            } catch (err) {\r\n                this.serializer.isCollectingMedia = false;\r\n                this.showMessage('Export failed: ' + err);\r\n            }\r\n        } else {\r\n            menu = this.showMessage('Exporting');\r\n            str = this.serializer.serialize(this.stage);\r\n            this.saveXMLAs(str, this.projectName);\r\n            menu.destroy();\r\n            this.showMessage('Exported!', 1);\r\n        }\r\n    }\r\n    this.serializer.isCollectingMedia = false;\r\n    this.serializer.flushMedia();\r\n};\r\n\r\nIDE_Morph.prototype.exportProjectAsCloudData = function (name) {\r\n    var menu, str, media, dta;\r\n    this.serializer.isCollectingMedia = true;\r\n    if (name) {\r\n        this.setProjectName(name);\r\n        if (Process.prototype.isCatchingErrors) {\r\n            try {\r\n                menu = this.showMessage('Exporting');\r\n                str = this.serializer.serialize(this.stage);\r\n                media = this.serializer.mediaXML(name);\r\n                dta = '<snapdata>' + str + media + '</snapdata>';\r\n                this.saveXMLAs(str, this.projectName);\r\n                menu.destroy();\r\n                this.showMessage('Exported!', 1);\r\n            } catch (err) {\r\n                this.serializer.isCollectingMedia = false;\r\n                this.showMessage('Export failed: ' + err);\r\n            }\r\n        } else {\r\n            menu = this.showMessage('Exporting');\r\n            str = this.serializer.serialize(this.stage);\r\n            media = this.serializer.mediaXML(name);\r\n            dta = '<snapdata>' + str + media + '</snapdata>';\r\n            this.saveXMLAs(str, this.projectName);\r\n            menu.destroy();\r\n            this.showMessage('Exported!', 1);\r\n        }\r\n    }\r\n    this.serializer.isCollectingMedia = false;\r\n    this.serializer.flushMedia();\r\n    // this.hasChangedMedia = false;\r\n};\r\n\r\nIDE_Morph.prototype.cloudAcknowledge = function () {\r\n    var myself = this;\r\n    return function (responseText, url) {\r\n        nop(responseText);\r\n        new DialogBoxMorph().inform(\r\n            'Cloud Connection',\r\n            'Successfully connected to:\\n'\r\n                + 'http://'\r\n                + url,\r\n            myself.world(),\r\n            myself.cloudIcon(null, new Color(0, 180, 0))\r\n        );\r\n    };\r\n};\r\n\r\nIDE_Morph.prototype.cloudResponse = function () {\r\n    var myself = this;\r\n    return function (responseText, url) {\r\n        var response = responseText;\r\n        if (response.length > 50) {\r\n            response = response.substring(0, 50) + '...';\r\n        }\r\n        new DialogBoxMorph().inform(\r\n            'Snap!Cloud',\r\n            'http://'\r\n                + url + ':\\n\\n'\r\n                + 'responds:\\n'\r\n                + response,\r\n            myself.world(),\r\n            myself.cloudIcon(null, new Color(0, 180, 0))\r\n        );\r\n    };\r\n};\r\n\r\nIDE_Morph.prototype.cloudError = function () {\r\n    var myself = this;\r\n\r\n    return function (responseText, url) {\r\n        // first, try to find out an explanation for the error\r\n        // and notify the user about it,\r\n        // if none is found, show an error dialog box\r\n        var response = responseText,\r\n            // explanation = getURL('http://snap.berkeley.edu/cloudmsg.txt'),\r\n            explanation = null;\r\n        if (myself.shield) {\r\n            myself.shield.destroy();\r\n            myself.shield = null;\r\n        }\r\n        if (explanation) {\r\n            myself.showMessage(explanation);\r\n            return;\r\n        }\r\n        if (response.length > 50) {\r\n            response = response.substring(0, 50) + '...';\r\n        }\r\n        new DialogBoxMorph().inform(\r\n            'Snap!Cloud',\r\n            (url ? url + '\\n' : '')\r\n                + response,\r\n            myself.world(),\r\n            myself.cloudIcon(null, new Color(180, 0, 0))\r\n        );\r\n    };\r\n};\r\n\r\nIDE_Morph.prototype.cloudIcon = function (height, color) {\r\n    var clr = color || DialogBoxMorph.prototype.titleBarColor,\r\n        isFlat = MorphicPreferences.isFlat,\r\n        icon = new SymbolMorph(\r\n            isFlat ? 'cloud' : 'cloudGradient',\r\n            height || 50,\r\n            clr,\r\n            isFlat ? null : new Point(-1, -1),\r\n            clr.darker(50)\r\n        );\r\n    if (!isFlat) {\r\n        icon.addShadow(new Point(1, 1), 1, clr.lighter(95));\r\n    }\r\n    return icon;\r\n};\r\n\r\nIDE_Morph.prototype.setCloudURL = function () {\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (url) {\r\n            SnapCloud.url = url;\r\n        }\r\n    ).withKey('cloudURL').prompt(\r\n        'Cloud URL',\r\n        SnapCloud.url,\r\n        this.world(),\r\n        null,\r\n        {\r\n            'Snap!Cloud' :\r\n                'https://snap.apps.miosoft.com/SnapCloud'\r\n        }\r\n    );\r\n};\r\n\r\n// IDE_Morph HTTP data fetching\r\n\r\nIDE_Morph.prototype.getURL = function (url, callback) {\r\n    // fetch the contents of a url and pass it into the specified callback.\r\n    // If no callback is specified synchronously fetch and return it\r\n    // Note: Synchronous fetching has been deprecated and should be switched\r\n    var request = new XMLHttpRequest(),\r\n        async = callback instanceof Function,\r\n        myself = this;\r\n    try {\r\n        request.open('GET', url, async);\r\n        if (async) {\r\n            request.onreadystatechange = function () {\r\n                if (request.readyState === 4) {\r\n                    if (request.responseText) {\r\n                        callback.call(\r\n                            myself,\r\n                            request.responseText\r\n                        );\r\n                    } else {\r\n                        throw new Error('unable to retrieve ' + url);\r\n                    }\r\n                }\r\n            };\r\n        }\r\n        request.send();\r\n        if (!async) {\r\n            if (request.status === 200) {\r\n                return request.responseText;\r\n            }\r\n            throw new Error('unable to retrieve ' + url);\r\n        }\r\n    } catch (err) {\r\n        myself.showMessage(err.toString());\r\n        if (async) {\r\n            callback.call(this);\r\n        } else {\r\n            return request.responseText;\r\n        }\r\n    }\r\n};\r\n\r\n// IDE_Morph user dialog shortcuts\r\n\r\nIDE_Morph.prototype.showMessage = function (message, secs) {\r\n    var m = new MenuMorph(null, message),\r\n        intervalHandle;\r\n    m.popUpCenteredInWorld(this.world());\r\n    if (secs) {\r\n        intervalHandle = setInterval(function () {\r\n            m.destroy();\r\n            clearInterval(intervalHandle);\r\n        }, secs * 1000);\r\n    }\r\n    return m;\r\n};\r\n\r\nIDE_Morph.prototype.inform = function (title, message) {\r\n    new DialogBoxMorph().inform(\r\n        title,\r\n        localize(message),\r\n        this.world()\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.confirm = function (message, title, action) {\r\n    new DialogBoxMorph(null, action).askYesNo(\r\n        title,\r\n        localize(message),\r\n        this.world()\r\n    );\r\n};\r\n\r\nIDE_Morph.prototype.prompt = function (message, callback, choices, key) {\r\n    (new DialogBoxMorph(null, callback)).withKey(key).prompt(\r\n        message,\r\n        '',\r\n        this.world(),\r\n        null,\r\n        choices\r\n    );\r\n};\r\n\r\n// ProjectDialogMorph ////////////////////////////////////////////////////\r\n\r\n// ProjectDialogMorph inherits from DialogBoxMorph:\r\n\r\nProjectDialogMorph.prototype = new DialogBoxMorph();\r\nProjectDialogMorph.prototype.constructor = ProjectDialogMorph;\r\nProjectDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// ProjectDialogMorph instance creation:\r\n\r\nfunction ProjectDialogMorph(ide, label) {\r\n    this.init(ide, label);\r\n}\r\n\r\nProjectDialogMorph.prototype.init = function (ide, task) {\r\n    var myself = this;\r\n\r\n    // additional properties:\r\n    this.ide = ide;\r\n    this.task = task || 'open'; // String describing what do do (open, save)\r\n    this.source = ide.source || 'local'; // or 'cloud' or 'examples'\r\n    this.projectList = []; // [{name: , thumb: , notes:}]\r\n\r\n    this.handle = null;\r\n    this.srcBar = null;\r\n    this.nameField = null;\r\n    this.filterField = null;\r\n    this.magnifyingGlass = null;\r\n    this.listField = null;\r\n    this.preview = null;\r\n    this.notesText = null;\r\n    this.notesField = null;\r\n    this.deleteButton = null;\r\n    this.shareButton = null;\r\n    this.unshareButton = null;\r\n\r\n    // initialize inherited properties:\r\n    ProjectDialogMorph.uber.init.call(\r\n        this,\r\n        this, // target\r\n        null, // function\r\n        null // environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.labelString = this.task === 'save' ? 'Save Project' : 'Open Project';\r\n    this.createLabel();\r\n    this.key = 'project' + task;\r\n\r\n    // build contents\r\n    this.buildContents();\r\n    this.onNextStep = function () { // yield to show \"updating\" message\r\n        myself.setSource(myself.source);\r\n    };\r\n};\r\n\r\nProjectDialogMorph.prototype.buildContents = function () {\r\n    var thumbnail, notification;\r\n\r\n    this.addBody(new Morph());\r\n    this.body.color = this.color;\r\n\r\n    this.srcBar = new AlignmentMorph('column', this.padding / 2);\r\n\r\n    if (this.ide.cloudMsg) {\r\n        notification = new TextMorph(\r\n            this.ide.cloudMsg,\r\n            10,\r\n            null, // style\r\n            false, // bold\r\n            null, // italic\r\n            null, // alignment\r\n            null, // width\r\n            null, // font name\r\n            new Point(1, 1), // shadow offset\r\n            new Color(255, 255, 255) // shadowColor\r\n        );\r\n        notification.refresh = nop;\r\n        this.srcBar.add(notification);\r\n    }\r\n\r\n    this.addSourceButton('cloud', localize('Cloud'), 'cloud');\r\n    this.addSourceButton('local', localize('Browser'), 'storage');\r\n    if (this.task === 'open') {\r\n        this.buildFilterField();\r\n        this.addSourceButton('examples', localize('Examples'), 'poster');\r\n    }\r\n    this.srcBar.fixLayout();\r\n    this.body.add(this.srcBar);\r\n\r\n    if (this.task === 'save') {\r\n        this.nameField = new InputFieldMorph(this.ide.projectName);\r\n        this.body.add(this.nameField);\r\n    }\r\n\r\n    this.listField = new ListMorph([]);\r\n    this.fixListFieldItemColors();\r\n    this.listField.fixLayout = nop;\r\n    this.listField.edge = InputFieldMorph.prototype.edge;\r\n    this.listField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.listField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.listField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.listField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.listField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    this.body.add(this.listField);\r\n\r\n    this.preview = new Morph();\r\n    this.preview.fixLayout = nop;\r\n    this.preview.edge = InputFieldMorph.prototype.edge;\r\n    this.preview.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.preview.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.preview.contrast = InputFieldMorph.prototype.contrast;\r\n    this.preview.drawNew = function () {\r\n        InputFieldMorph.prototype.drawNew.call(this);\r\n        if (this.texture) {\r\n            this.drawTexture(this.texture);\r\n        }\r\n    };\r\n    this.preview.drawCachedTexture = function () {\r\n        var context = this.image.getContext('2d');\r\n        context.drawImage(this.cachedTexture, this.edge, this.edge);\r\n        this.changed();\r\n    };\r\n    this.preview.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n    this.preview.setExtent(\r\n        this.ide.serializer.thumbnailSize.add(this.preview.edge * 2)\r\n    );\r\n\r\n    this.body.add(this.preview);\r\n    this.preview.drawNew();\r\n    if (this.task === 'save') {\r\n        thumbnail = this.ide.stage.thumbnail(\r\n            SnapSerializer.prototype.thumbnailSize\r\n        );\r\n        this.preview.texture = null;\r\n        this.preview.cachedTexture = thumbnail;\r\n        this.preview.drawCachedTexture();\r\n    }\r\n\r\n    this.notesField = new ScrollFrameMorph();\r\n    this.notesField.fixLayout = nop;\r\n\r\n    this.notesField.edge = InputFieldMorph.prototype.edge;\r\n    this.notesField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.notesField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.notesField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.notesField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.notesField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    this.notesField.acceptsDrops = false;\r\n    this.notesField.contents.acceptsDrops = false;\r\n\r\n    if (this.task === 'open') {\r\n        this.notesText = new TextMorph('');\r\n    } else { // 'save'\r\n        this.notesText = new TextMorph(this.ide.projectNotes);\r\n        this.notesText.isEditable = true;\r\n        this.notesText.enableSelecting();\r\n    }\r\n\r\n    this.notesField.isTextLineWrapping = true;\r\n    this.notesField.padding = 3;\r\n    this.notesField.setContents(this.notesText);\r\n    this.notesField.setWidth(this.preview.width());\r\n\r\n    this.body.add(this.notesField);\r\n\r\n    if (this.task === 'open') {\r\n        this.addButton('openProject', 'Open');\r\n        this.action = 'openProject';\r\n    } else { // 'save'\r\n        this.addButton('saveProject', 'Save');\r\n        this.action = 'saveProject';\r\n    }\r\n    this.shareButton = this.addButton('shareProject', 'Share');\r\n    this.unshareButton = this.addButton('unshareProject', 'Unshare');\r\n    this.shareButton.hide();\r\n    this.unshareButton.hide();\r\n    this.deleteButton = this.addButton('deleteProject', 'Delete');\r\n    this.addButton('cancel', 'Cancel');\r\n\r\n    if (notification) {\r\n        this.setExtent(new Point(455, 335).add(notification.extent()));\r\n    } else {\r\n        this.setExtent(new Point(455, 335));\r\n    }\r\n    this.fixLayout();\r\n\r\n};\r\n\r\nProjectDialogMorph.prototype.popUp = function (wrrld) {\r\n    var world = wrrld || this.ide.world();\r\n    if (world) {\r\n        ProjectDialogMorph.uber.popUp.call(this, world);\r\n        this.handle = new HandleMorph(\r\n            this,\r\n            350,\r\n            300,\r\n            this.corner,\r\n            this.corner\r\n        );\r\n    }\r\n};\r\n\r\n// ProjectDialogMorph source buttons\r\n\r\nProjectDialogMorph.prototype.addSourceButton = function (\r\n    source,\r\n    label,\r\n    symbol\r\n) {\r\n    var myself = this,\r\n        lbl1 = new StringMorph(\r\n            label,\r\n            10,\r\n            null,\r\n            true,\r\n            null,\r\n            null,\r\n            new Point(1, 1),\r\n            new Color(255, 255, 255)\r\n        ),\r\n        lbl2 = new StringMorph(\r\n            label,\r\n            10,\r\n            null,\r\n            true,\r\n            null,\r\n            null,\r\n            new Point(-1, -1),\r\n            this.titleBarColor.darker(50),\r\n            new Color(255, 255, 255)\r\n        ),\r\n        l1 = new Morph(),\r\n        l2 = new Morph(),\r\n        button;\r\n\r\n    lbl1.add(new SymbolMorph(\r\n        symbol,\r\n        24,\r\n        this.titleBarColor.darker(20),\r\n        new Point(1, 1),\r\n        this.titleBarColor.darker(50)\r\n    ));\r\n    lbl1.children[0].setCenter(lbl1.center());\r\n    lbl1.children[0].setBottom(lbl1.top() - this.padding / 2);\r\n\r\n    l1.image = lbl1.fullImage();\r\n    l1.bounds = lbl1.fullBounds();\r\n\r\n    lbl2.add(new SymbolMorph(\r\n        symbol,\r\n        24,\r\n        new Color(255, 255, 255),\r\n        new Point(-1, -1),\r\n        this.titleBarColor.darker(50)\r\n    ));\r\n    lbl2.children[0].setCenter(lbl2.center());\r\n    lbl2.children[0].setBottom(lbl2.top() - this.padding / 2);\r\n\r\n    l2.image = lbl2.fullImage();\r\n    l2.bounds = lbl2.fullBounds();\r\n\r\n    button = new ToggleButtonMorph(\r\n        null, //colors,\r\n        myself, // the ProjectDialog is the target\r\n        function () { // action\r\n            myself.setSource(source);\r\n        },\r\n        [l1, l2],\r\n        function () {  // query\r\n            return myself.source === source;\r\n        }\r\n    );\r\n\r\n    button.corner = this.buttonCorner;\r\n    button.edge = this.buttonEdge;\r\n    button.outline = this.buttonOutline;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n    button.labelMinExtent = new Point(60, 0);\r\n    button.padding = this.buttonPadding;\r\n    button.contrast = this.buttonContrast;\r\n    button.pressColor = this.titleBarColor.darker(20);\r\n\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    button.refresh();\r\n    this.srcBar.add(button);\r\n};\r\n\r\n// ProjectDialogMorph list field control\r\n\r\nProjectDialogMorph.prototype.fixListFieldItemColors = function () {\r\n    // remember to always fixLayout() afterwards for the changes\r\n    // to take effect\r\n    var myself = this;\r\n    this.listField.contents.children[0].alpha = 0;\r\n    this.listField.contents.children[0].children.forEach(function (item) {\r\n        item.pressColor = myself.titleBarColor.darker(20);\r\n        item.color = new Color(0, 0, 0, 0);\r\n        item.noticesTransparentClick = true;\r\n    });\r\n};\r\n\r\n// ProjectDialogMorph filter field\r\n\r\nProjectDialogMorph.prototype.buildFilterField = function () {\r\n    var myself = this;\r\n\r\n    this.filterField = new InputFieldMorph('');\r\n    this.magnifyingGlass =\r\n        new SymbolMorph(\r\n            'magnifyingGlass',\r\n            this.filterField.height(),\r\n            this.titleBarColor.darker(50));\r\n\r\n    this.body.add(this.magnifyingGlass);\r\n    this.body.add(this.filterField);\r\n\r\n    this.filterField.reactToKeystroke = function (evt) {\r\n        var text = this.getValue();\r\n\r\n        myself.listField.elements =\r\n            myself.projectList.filter(function (aProject) {\r\n                var name,\r\n                    notes;\r\n\r\n                if (aProject.ProjectName) { // cloud\r\n                    name = aProject.ProjectName;\r\n                    notes = aProject.Notes;\r\n                } else { // local or examples\r\n                    name = aProject.name;\r\n                    notes = aProject.notes || '';\r\n                }\r\n\r\n                return name.toLowerCase().indexOf(text.toLowerCase()) > -1 ||\r\n                    notes.toLowerCase().indexOf(text.toLowerCase()) > -1;\r\n            });\r\n\r\n        if (myself.listField.elements.length === 0) {\r\n            myself.listField.elements.push('(no matches)');\r\n        }\r\n\r\n        myself.clearDetails();\r\n        myself.listField.buildListContents();\r\n        myself.fixListFieldItemColors();\r\n        myself.listField.adjustScrollBars();\r\n        myself.listField.scrollY(myself.listField.top());\r\n        myself.fixLayout();\r\n    };\r\n};\r\n\r\n// ProjectDialogMorph ops\r\n\r\nProjectDialogMorph.prototype.setSource = function (source) {\r\n    var myself = this,\r\n        msg;\r\n\r\n    this.source = source; //this.task === 'save' ? 'local' : source;\r\n    this.srcBar.children.forEach(function (button) {\r\n        button.refresh();\r\n    });\r\n    switch (this.source) {\r\n    case 'cloud':\r\n        msg = myself.ide.showMessage('Updating\\nproject list...');\r\n        this.projectList = [];\r\n        SnapCloud.getProjectList(\r\n            function (projectList) {\r\n                // Don't show cloud projects if user has since switch panes.\r\n                if (myself.source === 'cloud') {\r\n                    myself.installCloudProjectList(projectList);\r\n                }\r\n                msg.destroy();\r\n            },\r\n            function (err, lbl) {\r\n                msg.destroy();\r\n                myself.ide.cloudError().call(null, err, lbl);\r\n            }\r\n        );\r\n        return;\r\n    case 'examples':\r\n        this.projectList = this.getExamplesProjectList();\r\n        break;\r\n    case 'local':\r\n        this.projectList = this.getLocalProjectList();\r\n        break;\r\n    }\r\n\r\n    this.listField.destroy();\r\n    this.listField = new ListMorph(\r\n        this.projectList,\r\n        this.projectList.length > 0 ?\r\n                function (element) {\r\n                    return element.name || element;\r\n                } : null,\r\n        null,\r\n        function () {myself.ok(); }\r\n    );\r\n\r\n    this.fixListFieldItemColors();\r\n    this.listField.fixLayout = nop;\r\n    this.listField.edge = InputFieldMorph.prototype.edge;\r\n    this.listField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.listField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.listField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.listField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.listField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    if (this.source === 'local') {\r\n        this.listField.action = function (item) {\r\n            var src, xml;\r\n\r\n            if (item === undefined) {return; }\r\n            if (myself.nameField) {\r\n                myself.nameField.setContents(item.name || '');\r\n            }\r\n            if (myself.task === 'open') {\r\n\r\n                src = localStorage['-snap-project-' + item.name];\r\n\r\n                if (src) {\r\n                    xml = myself.ide.serializer.parse(src);\r\n\r\n                    myself.notesText.text = xml.childNamed('notes').contents\r\n                        || '';\r\n                    myself.notesText.drawNew();\r\n                    myself.notesField.contents.adjustBounds();\r\n                    myself.preview.texture =\r\n                        xml.childNamed('thumbnail').contents || null;\r\n                    myself.preview.cachedTexture = null;\r\n                    myself.preview.drawNew();\r\n                }\r\n            }\r\n            myself.edit();\r\n        };\r\n    } else { // 'examples'; 'cloud' is initialized elsewhere\r\n        this.listField.action = function (item) {\r\n            var src, xml;\r\n            if (item === undefined) {return; }\r\n            if (myself.nameField) {\r\n                myself.nameField.setContents(item.name || '');\r\n            }\r\n            src = myself.ide.getURL(\r\n                myself.ide.resourceURL('Examples', item.fileName)\r\n            );\r\n\r\n            xml = myself.ide.serializer.parse(src);\r\n            myself.notesText.text = xml.childNamed('notes').contents\r\n                || '';\r\n            myself.notesText.drawNew();\r\n            myself.notesField.contents.adjustBounds();\r\n            myself.preview.texture = xml.childNamed('thumbnail').contents\r\n                || null;\r\n            myself.preview.cachedTexture = null;\r\n            myself.preview.drawNew();\r\n            myself.edit();\r\n        };\r\n    }\r\n    this.body.add(this.listField);\r\n    this.shareButton.hide();\r\n    this.unshareButton.hide();\r\n    if (this.source === 'local') {\r\n        this.deleteButton.show();\r\n    } else { // examples\r\n        this.deleteButton.hide();\r\n    }\r\n    this.buttons.fixLayout();\r\n    this.fixLayout();\r\n    if (this.task === 'open') {\r\n        this.clearDetails();\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.getLocalProjectList = function () {\r\n    var stored, name, dta,\r\n        projects = [];\r\n    for (stored in localStorage) {\r\n        if (Object.prototype.hasOwnProperty.call(localStorage, stored)\r\n                && stored.substr(0, 14) === '-snap-project-') {\r\n            name = stored.substr(14);\r\n            dta = {\r\n                name: name,\r\n                thumb: null,\r\n                notes: null\r\n            };\r\n            projects.push(dta);\r\n        }\r\n    }\r\n    projects.sort(function (x, y) {\r\n        return x.name.toLowerCase() < y.name.toLowerCase() ? -1 : 1;\r\n    });\r\n    return projects;\r\n};\r\n\r\nProjectDialogMorph.prototype.getExamplesProjectList = function () {\r\n    return this.ide.getMediaList('Examples');\r\n};\r\n\r\nProjectDialogMorph.prototype.installCloudProjectList = function (pl) {\r\n    var myself = this;\r\n    this.projectList = pl || [];\r\n    this.projectList.sort(function (x, y) {\r\n        return x.ProjectName.toLowerCase() < y.ProjectName.toLowerCase() ?\r\n                 -1 : 1;\r\n    });\r\n\r\n    this.listField.destroy();\r\n    this.listField = new ListMorph(\r\n        this.projectList,\r\n        this.projectList.length > 0 ?\r\n                function (element) {\r\n                    return element.ProjectName || element;\r\n                } : null,\r\n        [ // format: display shared project names bold\r\n            [\r\n                'bold',\r\n                function (proj) {return proj.Public === 'true'; }\r\n            ]\r\n        ],\r\n        function () {myself.ok(); }\r\n    );\r\n    this.fixListFieldItemColors();\r\n    this.listField.fixLayout = nop;\r\n    this.listField.edge = InputFieldMorph.prototype.edge;\r\n    this.listField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.listField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.listField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.listField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.listField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    this.listField.action = function (item) {\r\n        if (item === undefined) {return; }\r\n        if (myself.nameField) {\r\n            myself.nameField.setContents(item.ProjectName || '');\r\n        }\r\n        if (myself.task === 'open') {\r\n            myself.notesText.text = item.Notes || '';\r\n            myself.notesText.drawNew();\r\n            myself.notesField.contents.adjustBounds();\r\n            myself.preview.texture = item.Thumbnail || null;\r\n            myself.preview.cachedTexture = null;\r\n            myself.preview.drawNew();\r\n            (new SpeechBubbleMorph(new TextMorph(\r\n                localize('last changed') + '\\n' + item.Updated,\r\n                null,\r\n                null,\r\n                null,\r\n                null,\r\n                'center'\r\n            ))).popUp(\r\n                myself.world(),\r\n                myself.preview.rightCenter().add(new Point(2, 0))\r\n            );\r\n        }\r\n        if (item.Public === 'true') {\r\n            myself.shareButton.hide();\r\n            myself.unshareButton.show();\r\n        } else {\r\n            myself.unshareButton.hide();\r\n            myself.shareButton.show();\r\n        }\r\n        myself.buttons.fixLayout();\r\n        myself.fixLayout();\r\n        myself.edit();\r\n    };\r\n    this.body.add(this.listField);\r\n    this.shareButton.show();\r\n    this.unshareButton.hide();\r\n    this.deleteButton.show();\r\n    this.buttons.fixLayout();\r\n    this.fixLayout();\r\n    if (this.task === 'open') {\r\n        this.clearDetails();\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.clearDetails = function () {\r\n    this.notesText.text = '';\r\n    this.notesText.drawNew();\r\n    this.notesField.contents.adjustBounds();\r\n    this.preview.texture = null;\r\n    this.preview.cachedTexture = null;\r\n    this.preview.drawNew();\r\n};\r\n\r\nProjectDialogMorph.prototype.openProject = function () {\r\n    var proj = this.listField.selected,\r\n        src;\r\n    if (!proj) {return; }\r\n    this.ide.source = this.source;\r\n    if (this.source === 'cloud') {\r\n        this.openCloudProject(proj);\r\n    } else if (this.source === 'examples') {\r\n        // Note \"file\" is a property of the parseResourceFile function.\r\n        src = this.ide.getURL(this.ide.resourceURL('Examples', proj.fileName));\r\n        this.ide.openProjectString(src);\r\n        this.destroy();\r\n    } else { // 'local'\r\n        this.ide.openProject(proj.name);\r\n        this.destroy();\r\n    }\r\n\r\n};\r\n\r\nProjectDialogMorph.prototype.openCloudProject = function (project) {\r\n    var myself = this;\r\n    myself.ide.nextSteps([\r\n        function () {\r\n            myself.ide.showMessage('Fetching project\\nfrom the cloud...');\r\n        },\r\n        function () {\r\n            myself.rawOpenCloudProject(project);\r\n        }\r\n    ]);\r\n};\r\n\r\nProjectDialogMorph.prototype.rawOpenCloudProject = function (proj) {\r\n    var myself = this;\r\n    SnapCloud.reconnect(\r\n        function () {\r\n            SnapCloud.callService(\r\n                'getRawProject',\r\n                function (response) {\r\n                    SnapCloud.disconnect();\r\n                    \r\n                    myself.ide.source = 'cloud';\r\n                    myself.ide.droppedText(response);\r\n                    if (proj.Public === 'true') {\r\n                        location.hash = '#present:Username=' +\r\n                            encodeURIComponent(SnapCloud.username) +\r\n                            '&ProjectName=' +\r\n                            encodeURIComponent(proj.ProjectName);\r\n                    }\r\n                },\r\n                myself.ide.cloudError(),\r\n                [proj.ProjectName]\r\n            );\r\n        },\r\n        myself.ide.cloudError()\r\n    );\r\n    this.destroy();\r\n};\r\n\r\nProjectDialogMorph.prototype.saveProject = function () {\r\n\r\n    var name = this.nameField.contents().text.text,\r\n        notes = this.notesText.text,\r\n        myself = this;\r\n\r\n    this.ide.projectNotes = notes || this.ide.projectNotes;\r\n    if (name) {\r\n        if (this.source === 'cloud') {\r\n            if (detect(\r\n                    this.projectList,\r\n                    function (item) {return item.ProjectName === name; }\r\n                )) {\r\n                this.ide.confirm(\r\n                    localize(\r\n                        'Are you sure you want to replace'\r\n                    ) + '\\n\"' + name + '\"?',\r\n                    'Replace Project',\r\n                    function () {\r\n                        myself.ide.setProjectName(name);\r\n                        myself.saveCloudProject();\r\n                    }\r\n                );\r\n            } else {\r\n                this.ide.setProjectName(name);\r\n                myself.saveCloudProject();\r\n            }\r\n        } else { // 'local'\r\n            if (detect(\r\n                    this.projectList,\r\n                    function (item) {return item.name === name; }\r\n                )) {\r\n                this.ide.confirm(\r\n                    localize(\r\n                        'Are you sure you want to replace'\r\n                    ) + '\\n\"' + name + '\"?',\r\n                    'Replace Project',\r\n                    function () {\r\n                        myself.ide.setProjectName(name);\r\n                        myself.ide.source = 'local';\r\n                        myself.ide.saveProject(name);\r\n                        myself.destroy();\r\n                    }\r\n                );\r\n            } else {\r\n                this.ide.setProjectName(name);\r\n                myself.ide.source = 'local';\r\n                this.ide.saveProject(name);\r\n                this.destroy();\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.saveCloudProject = function () {\r\n    var myself = this;\r\n    this.ide.showMessage('Saving project\\nto the cloud...');\r\n    SnapCloud.saveProject(\r\n        this.ide,\r\n        function () {\r\n            myself.ide.source = 'cloud';\r\n            myself.ide.showMessage('saved.', 2);\r\n        },\r\n        this.ide.cloudError()\r\n    );\r\n    this.destroy();\r\n};\r\n\r\nProjectDialogMorph.prototype.deleteProject = function () {\r\n    var myself = this,\r\n        proj,\r\n        idx,\r\n        name;\r\n\r\n    if (this.source === 'cloud') {\r\n        proj = this.listField.selected;\r\n        if (proj) {\r\n            this.ide.confirm(\r\n                localize(\r\n                    'Are you sure you want to delete'\r\n                ) + '\\n\"' + proj.ProjectName + '\"?',\r\n                'Delete Project',\r\n                function () {\r\n                    SnapCloud.reconnect(\r\n                        function () {\r\n                            SnapCloud.callService(\r\n                                'deleteProject',\r\n                                function () {\r\n                                    SnapCloud.disconnect();\r\n                                    myself.ide.hasChangedMedia = true;\r\n                                    idx = myself.projectList.indexOf(proj);\r\n                                    myself.projectList.splice(idx, 1);\r\n                                    myself.installCloudProjectList(\r\n                                        myself.projectList\r\n                                    ); // refresh list\r\n                                },\r\n                                myself.ide.cloudError(),\r\n                                [proj.ProjectName]\r\n                            );\r\n                        },\r\n                        myself.ide.cloudError()\r\n                    );\r\n                }\r\n            );\r\n        }\r\n    } else { // 'local, examples'\r\n        if (this.listField.selected) {\r\n            name = this.listField.selected.name;\r\n            this.ide.confirm(\r\n                localize(\r\n                    'Are you sure you want to delete'\r\n                ) + '\\n\"' + name + '\"?',\r\n                'Delete Project',\r\n                function () {\r\n                    delete localStorage['-snap-project-' + name];\r\n                    myself.setSource(myself.source); // refresh list\r\n                }\r\n            );\r\n        }\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.shareProject = function () {\r\n    var myself = this,\r\n        ide = this.ide,\r\n        proj = this.listField.selected,\r\n        entry = this.listField.active;\r\n\r\n    if (proj) {\r\n        this.ide.confirm(\r\n            localize(\r\n                'Are you sure you want to publish'\r\n            ) + '\\n\"' + proj.ProjectName + '\"?',\r\n            'Share Project',\r\n            function () {\r\n                myself.ide.showMessage('sharing\\nproject...');\r\n                SnapCloud.reconnect(\r\n                    function () {\r\n                        SnapCloud.callService(\r\n                            'publishProject',\r\n                            function () {\r\n                                SnapCloud.disconnect();\r\n                                proj.Public = 'true';\r\n                                myself.unshareButton.show();\r\n                                myself.shareButton.hide();\r\n                                entry.label.isBold = true;\r\n                                entry.label.drawNew();\r\n                                entry.label.changed();\r\n                                myself.buttons.fixLayout();\r\n                                myself.drawNew();\r\n                                myself.ide.showMessage('shared.', 2);\r\n                            },\r\n                            myself.ide.cloudError(),\r\n                            [proj.ProjectName]\r\n                        );\r\n                        // Set the Shared URL if the project is currently open\r\n                        if (proj.ProjectName === ide.projectName) {\r\n                            var usr = SnapCloud.username,\r\n                                projectId = 'Username=' +\r\n                                    encodeURIComponent(usr.toLowerCase()) +\r\n                                    '&ProjectName=' +\r\n                                    encodeURIComponent(proj.ProjectName);\r\n                            location.hash = 'present:' + projectId;\r\n                        }\r\n                    },\r\n                    myself.ide.cloudError()\r\n                );\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.unshareProject = function () {\r\n    var myself = this,\r\n        ide = this.ide,\r\n        proj = this.listField.selected,\r\n        entry = this.listField.active;\r\n\r\n\r\n    if (proj) {\r\n        this.ide.confirm(\r\n            localize(\r\n                'Are you sure you want to unpublish'\r\n            ) + '\\n\"' + proj.ProjectName + '\"?',\r\n            'Unshare Project',\r\n            function () {\r\n                myself.ide.showMessage('unsharing\\nproject...');\r\n                SnapCloud.reconnect(\r\n                    function () {\r\n                        SnapCloud.callService(\r\n                            'unpublishProject',\r\n                            function () {\r\n                                SnapCloud.disconnect();\r\n                                proj.Public = 'false';\r\n                                myself.shareButton.show();\r\n                                myself.unshareButton.hide();\r\n                                entry.label.isBold = false;\r\n                                entry.label.drawNew();\r\n                                entry.label.changed();\r\n                                myself.buttons.fixLayout();\r\n                                myself.drawNew();\r\n                                myself.ide.showMessage('unshared.', 2);\r\n                            },\r\n                            myself.ide.cloudError(),\r\n                            [proj.ProjectName]\r\n                        );\r\n                        // Remove the shared URL if the project is open.\r\n                        if (proj.ProjectName === ide.projectName) {\r\n                            location.hash = '';\r\n                        }\r\n                    },\r\n                    myself.ide.cloudError()\r\n                );\r\n            }\r\n        );\r\n    }\r\n};\r\n\r\nProjectDialogMorph.prototype.edit = function () {\r\n    if (this.nameField) {\r\n        this.nameField.edit();\r\n    } else if (this.filterField) {\r\n        this.filterField.edit();\r\n    }\r\n};\r\n\r\n// ProjectDialogMorph layout\r\n\r\nProjectDialogMorph.prototype.fixLayout = function () {\r\n    var th = fontHeight(this.titleFontSize) + this.titlePadding * 2,\r\n        thin = this.padding / 2,\r\n        inputField = this.nameField || this.filterField,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.fixLayout();\r\n    }\r\n\r\n    if (this.body) {\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.body.setExtent(new Point(\r\n            this.width() - this.padding * 2,\r\n            this.height() - this.padding * 3 - th - this.buttons.height()\r\n        ));\r\n        this.srcBar.setPosition(this.body.position());\r\n\r\n        inputField.setWidth(\r\n                this.body.width() - this.srcBar.width() - this.padding * 6\r\n            );\r\n        inputField.setLeft(this.srcBar.right() + this.padding * 3);\r\n        inputField.setTop(this.srcBar.top());\r\n        inputField.drawNew();\r\n\r\n        this.listField.setLeft(this.srcBar.right() + this.padding);\r\n        this.listField.setWidth(\r\n            this.body.width()\r\n                - this.srcBar.width()\r\n                - this.preview.width()\r\n                - this.padding\r\n                - thin\r\n        );\r\n        this.listField.contents.children[0].adjustWidths();\r\n\r\n        this.listField.setTop(inputField.bottom() + this.padding);\r\n        this.listField.setHeight(\r\n            this.body.height() - inputField.height() - this.padding\r\n        );\r\n\r\n        if (this.magnifyingGlass) {\r\n            this.magnifyingGlass.setTop(inputField.top());\r\n            this.magnifyingGlass.setLeft(this.listField.left());\r\n        }\r\n\r\n        this.preview.setRight(this.body.right());\r\n        this.preview.setTop(inputField.bottom() + this.padding);\r\n\r\n        this.notesField.setTop(this.preview.bottom() + thin);\r\n        this.notesField.setLeft(this.preview.left());\r\n        this.notesField.setHeight(\r\n            this.body.bottom() - this.preview.bottom() - thin\r\n        );\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n    }\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n};\r\n\r\n// LibraryImportDialogMorph ///////////////////////////////////////////\r\n// I am preview dialog shown before importing a library.\r\n// I inherit from a DialogMorph but look similar to\r\n// ProjectDialogMorph, and BlockImportDialogMorph\r\n\r\nLibraryImportDialogMorph.prototype = new DialogBoxMorph();\r\nLibraryImportDialogMorph.prototype.constructor = LibraryImportDialogMorph;\r\nLibraryImportDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// LibraryImportDialogMorph instance creation:\r\n\r\nfunction LibraryImportDialogMorph(ide, librariesData) {\r\n    this.init(ide, librariesData);\r\n}\r\n\r\nLibraryImportDialogMorph.prototype.init = function (ide, librariesData) {\r\n    // initialize inherited properties:\r\n    LibraryImportDialogMorph.uber.init.call(\r\n        this,\r\n        this, // target\r\n        null, // function\r\n        null  // environment\r\n    );\r\n\r\n    this.ide = ide;\r\n    this.key = 'importLibrary';\r\n    this.librariesData = librariesData; // [{name: , fileName: , description:}]\r\n\r\n    // I contain a cached version of the libaries I have displayed,\r\n    // because users may choose to explore a library many times before\r\n    // importing.\r\n    this.libraryCache = {}; // {fileName: [blocks-array] }\r\n\r\n    this.handle = null;\r\n    this.listField = null;\r\n    this.palette = null;\r\n    this.notesText = null;\r\n    this.notesField = null;\r\n\r\n    this.labelString = 'Import library';\r\n    this.createLabel();\r\n\r\n    this.buildContents();\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.buildContents = function () {\r\n    this.addBody(new Morph());\r\n    this.body.color = this.color;\r\n\r\n    this.initializePalette();\r\n    this.initializeLibraryDescription();\r\n    this.installLibrariesList();\r\n\r\n    this.addButton('importLibrary', 'Import');\r\n    this.addButton('cancel', 'Cancel');\r\n\r\n    this.setExtent(new Point(460, 455));\r\n    this.fixLayout();\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.initializePalette = function () {\r\n    // I will display a scrolling list of blocks.\r\n    if (this.palette) {this.palette.destroy(); }\r\n\r\n    this.palette = new ScrollFrameMorph(\r\n        null,\r\n        null,\r\n        SpriteMorph.prototype.sliderColor\r\n    );\r\n    this.palette.color = SpriteMorph.prototype.paletteColor;\r\n    this.palette.padding = 4;\r\n    this.palette.isDraggable = false;\r\n    this.palette.acceptsDrops = false;\r\n    this.palette.contents.acceptsDrops = false;\r\n\r\n    this.body.add(this.palette);\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.initializeLibraryDescription = function () {\r\n    if (this.notesField) {this.notesField.destroy(); }\r\n\r\n    this.notesField = new ScrollFrameMorph();\r\n    this.notesField.fixLayout = nop;\r\n\r\n    this.notesField.edge = InputFieldMorph.prototype.edge;\r\n    this.notesField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.notesField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.notesField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.notesField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.notesField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    this.notesField.acceptsDrops = false;\r\n    this.notesField.contents.acceptsDrops = false;\r\n\r\n    this.notesText = new TextMorph('');\r\n\r\n    this.notesField.isTextLineWrapping = true;\r\n    this.notesField.padding = 3;\r\n    this.notesField.setContents(this.notesText);\r\n    this.notesField.setHeight(100);\r\n\r\n    this.body.add(this.notesField);\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.installLibrariesList = function () {\r\n    var myself = this;\r\n\r\n    if (this.listField) {this.listField.destroy(); }\r\n\r\n    this.listField = new ListMorph(\r\n        this.librariesData,\r\n        function (element) {return element.name; },\r\n        null,\r\n        function () {myself.importLibrary(); }\r\n    );\r\n\r\n    this.fixListFieldItemColors();\r\n\r\n    this.listField.fixLayout = nop;\r\n    this.listField.edge = InputFieldMorph.prototype.edge;\r\n    this.listField.fontSize = InputFieldMorph.prototype.fontSize;\r\n    this.listField.typeInPadding = InputFieldMorph.prototype.typeInPadding;\r\n    this.listField.contrast = InputFieldMorph.prototype.contrast;\r\n    this.listField.drawNew = InputFieldMorph.prototype.drawNew;\r\n    this.listField.drawRectBorder = InputFieldMorph.prototype.drawRectBorder;\r\n\r\n    this.listField.action = function (item) {\r\n        if (isNil(item)) {return; }\r\n\r\n        myself.notesText.text = item.description || '';\r\n        myself.notesText.drawNew();\r\n        myself.notesField.contents.adjustBounds();\r\n\r\n        if (myself.hasCached(item.fileName)) {\r\n            myself.displayBlocks(item.fileName);\r\n        } else {\r\n            myself.showMessage(\r\n                localize('Loading') + '\\n' + localize(item.name)\r\n            );\r\n            myself.ide.getURL(\r\n                myself.ide.resourceURL('libraries', item.fileName),\r\n                function(libraryXML) {\r\n                    myself.cacheLibrary(\r\n                        item.fileName,\r\n                        myself.ide.serializer.loadBlocks(libraryXML)\r\n                    );\r\n                    myself.displayBlocks(item.fileName);\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    this.listField.setWidth(200);\r\n    this.body.add(this.listField);\r\n\r\n    this.fixLayout();\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.popUp = function () {\r\n    var world = this.ide.world();\r\n    if (world) {\r\n        LibraryImportDialogMorph.uber.popUp.call(this, world);\r\n        this.handle = new HandleMorph(\r\n            this,\r\n            300,\r\n            300,\r\n            this.corner,\r\n            this.corner\r\n        );\r\n    }\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.fixListFieldItemColors =\r\n    ProjectDialogMorph.prototype.fixListFieldItemColors;\r\n\r\nLibraryImportDialogMorph.prototype.clearDetails =\r\n    ProjectDialogMorph.prototype.clearDetails;\r\n\r\nLibraryImportDialogMorph.prototype.fixLayout = function () {\r\n    var titleHeight = fontHeight(this.titleFontSize) + this.titlePadding * 2,\r\n        thin = this.padding / 2,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    if (this.body) {\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            titleHeight + this.padding\r\n        )));\r\n        this.body.setExtent(new Point(\r\n            this.width() - this.padding * 2,\r\n            this.height()\r\n                - this.padding * 3 // top, bottom and button padding.\r\n                - titleHeight\r\n                - this.buttons.height()\r\n        ));\r\n\r\n        this.listField.setExtent(new Point(\r\n            200,\r\n            this.body.height()\r\n        ));\r\n        this.notesField.setExtent(new Point(\r\n            this.body.width() - this.listField.width() - thin,\r\n            100\r\n        ));\r\n        this.palette.setExtent(new Point(\r\n            this.notesField.width(),\r\n            this.body.height() - this.notesField.height() - thin\r\n        ));\r\n        this.listField.contents.children[0].adjustWidths();\r\n\r\n        this.listField.setPosition(this.body.position());\r\n        this.palette.setPosition(this.listField.topRight().add(\r\n            new Point(thin, 0)\r\n        ));\r\n        this.notesField.setPosition(this.palette.bottomLeft().add(\r\n            new Point(0, thin)\r\n        ));\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(\r\n            this.top() + (titleHeight - this.label.height()) / 2\r\n        );\r\n    }\r\n\r\n    if (this.buttons) {\r\n        this.buttons.fixLayout();\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n};\r\n\r\n// Library Cache Utilities.\r\nLibraryImportDialogMorph.prototype.hasCached = function (key) {\r\n    return this.libraryCache.hasOwnProperty(key);\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.cacheLibrary = function (key, blocks) {\r\n    this.libraryCache[key] = blocks ;\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.cachedLibrary = function (key) {\r\n    return this.libraryCache[key];\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.importLibrary = function () {\r\n    var blocks,\r\n        ide = this.ide,\r\n        selectedLibrary = this.listField.selected.fileName,\r\n        libraryName = this.listField.selected.name;\r\n\r\n    if (this.hasCached(selectedLibrary)) {\r\n        blocks = this.cachedLibrary(selectedLibrary);\r\n        blocks.forEach(function (def) {\r\n            def.receiver = ide.stage;\r\n            ide.stage.globalBlocks.push(def);\r\n            ide.stage.replaceDoubleDefinitionsFor(def);\r\n        });\r\n        ide.showMessage(localize('Imported') + ' ' + localize(libraryName), 2);\r\n    } else {\r\n        ide.showMessage(localize('Loading') + ' ' + localize(libraryName));\r\n        ide.getURL(\r\n            ide.resourceURL('libraries', selectedLibrary),\r\n            function(libraryText) {\r\n                ide.droppedText(libraryText, libraryName);\r\n            }\r\n        );\r\n    }\r\n\r\n    this.destroy();\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.displayBlocks = function (libraryKey) {\r\n    var x, y, blockImage, previousCategory, blockContainer,\r\n        myself = this,\r\n        padding = 4,\r\n        blocksList = this.cachedLibrary(libraryKey);\r\n\r\n    if (!blocksList.length) {return; }\r\n    // populate palette, grouped by categories.\r\n    this.initializePalette();\r\n    x = this.palette.left() + padding;\r\n    y = this.palette.top();\r\n\r\n    SpriteMorph.prototype.categories.forEach(function (category) {\r\n        blocksList.forEach(function (definition) {\r\n            if (definition.category !== category) {return; }\r\n            if (category !== previousCategory) {\r\n                y += padding;\r\n            }\r\n            previousCategory = category;\r\n\r\n            blockImage = definition.templateInstance().fullImage();\r\n            blockContainer = new Morph();\r\n            blockContainer.setExtent(\r\n                new Point(blockImage.width, blockImage.height)\r\n            );\r\n            blockContainer.image = blockImage;\r\n            blockContainer.setPosition(new Point(x, y));\r\n            myself.palette.addContents(blockContainer);\r\n\r\n            y += blockContainer.fullBounds().height() + padding;\r\n        });\r\n    });\r\n\r\n    this.palette.scrollX(padding);\r\n    this.palette.scrollY(padding);\r\n    this.fixLayout();\r\n};\r\n\r\nLibraryImportDialogMorph.prototype.showMessage = function (msgText) {\r\n    var msg = new MenuMorph(null, msgText);\r\n    this.initializePalette();\r\n    this.fixLayout();\r\n    msg.popUpCenteredInWorld(this.palette.contents);\r\n};\r\n\r\n// SpriteIconMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a selectable element in the Sprite corral, keeping a self-updating\r\n    thumbnail of the sprite I'm respresenting, and a self-updating label\r\n    of the sprite's name (in case it is changed elsewhere)\r\n*/\r\n\r\n// SpriteIconMorph inherits from ToggleButtonMorph (Widgets)\r\n\r\nSpriteIconMorph.prototype = new ToggleButtonMorph();\r\nSpriteIconMorph.prototype.constructor = SpriteIconMorph;\r\nSpriteIconMorph.uber = ToggleButtonMorph.prototype;\r\n\r\n// SpriteIconMorph settings\r\n\r\nSpriteIconMorph.prototype.thumbSize = new Point(40, 40);\r\nSpriteIconMorph.prototype.labelShadowOffset = null;\r\nSpriteIconMorph.prototype.labelShadowColor = null;\r\nSpriteIconMorph.prototype.labelColor = new Color(255, 255, 255);\r\nSpriteIconMorph.prototype.fontSize = 9;\r\n\r\n// SpriteIconMorph instance creation:\r\n\r\nfunction SpriteIconMorph(aSprite, aTemplate) {\r\n    this.init(aSprite, aTemplate);\r\n}\r\n\r\nSpriteIconMorph.prototype.init = function (aSprite, aTemplate) {\r\n    var colors, action, query, hover, myself = this;\r\n\r\n    if (!aTemplate) {\r\n        colors = [\r\n            IDE_Morph.prototype.groupColor,\r\n            IDE_Morph.prototype.frameColor,\r\n            IDE_Morph.prototype.frameColor\r\n        ];\r\n\r\n    }\r\n\r\n    action = function () {\r\n        // make my sprite the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph);\r\n\r\n        if (ide) {\r\n            ide.selectSprite(myself.object);\r\n        }\r\n    };\r\n\r\n    query = function () {\r\n        // answer true if my sprite is the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph);\r\n\r\n        if (ide) {\r\n            return ide.currentSprite === myself.object;\r\n        }\r\n        return false;\r\n    };\r\n\r\n    hover = function () {\r\n        if (!aSprite.exemplar) {return null; }\r\n        return (localize('parent') + ':\\n' + aSprite.exemplar.name);\r\n    };\r\n\r\n    // additional properties:\r\n    this.object = aSprite || new SpriteMorph(); // mandatory, actually\r\n    this.version = this.object.version;\r\n    this.thumbnail = null;\r\n    this.rotationButton = null; // synchronous rotation of nested sprites\r\n\r\n    // initialize inherited properties:\r\n    SpriteIconMorph.uber.init.call(\r\n        this,\r\n        colors, // color overrides, <array>: [normal, highlight, pressed]\r\n        null, // target - not needed here\r\n        action, // a toggle function\r\n        this.object.name, // label string\r\n        query, // predicate/selector\r\n        null, // environment\r\n        hover, // hint\r\n        aTemplate // optional, for cached background images\r\n    );\r\n\r\n    // override defaults and build additional components\r\n    this.isDraggable = true;\r\n    this.createThumbnail();\r\n    this.padding = 2;\r\n    this.corner = 8;\r\n    this.fixLayout();\r\n    this.fps = 1;\r\n};\r\n\r\nSpriteIconMorph.prototype.createThumbnail = function () {\r\n    if (this.thumbnail) {\r\n        this.thumbnail.destroy();\r\n    }\r\n\r\n    this.thumbnail = new Morph();\r\n    this.thumbnail.setExtent(this.thumbSize);\r\n    if (this.object instanceof SpriteMorph) { // support nested sprites\r\n        this.thumbnail.image = this.object.fullThumbnail(this.thumbSize);\r\n        this.createRotationButton();\r\n    } else {\r\n        this.thumbnail.image = this.object.thumbnail(this.thumbSize);\r\n    }\r\n    this.add(this.thumbnail);\r\n};\r\n\r\nSpriteIconMorph.prototype.createLabel = function () {\r\n    var txt;\r\n\r\n    if (this.label) {\r\n        this.label.destroy();\r\n    }\r\n    txt = new StringMorph(\r\n        this.object.name,\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        true,\r\n        false,\r\n        false,\r\n        this.labelShadowOffset,\r\n        this.labelShadowColor,\r\n        this.labelColor\r\n    );\r\n\r\n    this.label = new FrameMorph();\r\n    this.label.acceptsDrops = false;\r\n    this.label.alpha = 0;\r\n    this.label.setExtent(txt.extent());\r\n    txt.setPosition(this.label.position());\r\n    this.label.add(txt);\r\n    this.add(this.label);\r\n};\r\n\r\nSpriteIconMorph.prototype.createRotationButton = function () {\r\n    var button, myself = this;\r\n\r\n    if (this.rotationButton) {\r\n        this.rotationButton.destroy();\r\n        this.roationButton = null;\r\n    }\r\n    if (!this.object.anchor) {\r\n        return;\r\n    }\r\n\r\n    button = new ToggleButtonMorph(\r\n        null, // colors,\r\n        null, // target\r\n        function () {\r\n            myself.object.rotatesWithAnchor =\r\n                !myself.object.rotatesWithAnchor;\r\n        },\r\n        [\r\n            '\\u2192',\r\n            '\\u21BB'\r\n        ],\r\n        function () {  // query\r\n            return myself.object.rotatesWithAnchor;\r\n        }\r\n    );\r\n\r\n    button.corner = 8;\r\n    button.labelMinExtent = new Point(11, 11);\r\n    button.padding = 0;\r\n    button.pressColor = button.color;\r\n    button.drawNew();\r\n    // button.hint = 'rotate synchronously\\nwith anchor';\r\n    button.fixLayout();\r\n    button.refresh();\r\n    button.changed();\r\n    this.rotationButton = button;\r\n    this.add(this.rotationButton);\r\n};\r\n\r\n// SpriteIconMorph stepping\r\n\r\nSpriteIconMorph.prototype.step = function () {\r\n    if (this.version !== this.object.version) {\r\n        this.createThumbnail();\r\n        this.createLabel();\r\n        this.fixLayout();\r\n        this.version = this.object.version;\r\n        this.refresh();\r\n    }\r\n};\r\n\r\n// SpriteIconMorph layout\r\n\r\nSpriteIconMorph.prototype.fixLayout = function () {\r\n    if (!this.thumbnail || !this.label) {return null; }\r\n\r\n    this.setWidth(\r\n        this.thumbnail.width()\r\n            + this.outline * 2\r\n            + this.edge * 2\r\n            + this.padding * 2\r\n    );\r\n\r\n    this.setHeight(\r\n        this.thumbnail.height()\r\n            + this.outline * 2\r\n            + this.edge * 2\r\n            + this.padding * 3\r\n            + this.label.height()\r\n    );\r\n\r\n    this.thumbnail.setCenter(this.center());\r\n    this.thumbnail.setTop(\r\n        this.top() + this.outline + this.edge + this.padding\r\n    );\r\n\r\n    if (this.rotationButton) {\r\n        this.rotationButton.setTop(this.top());\r\n        this.rotationButton.setRight(this.right());\r\n    }\r\n\r\n    this.label.setWidth(\r\n        Math.min(\r\n            this.label.children[0].width(), // the actual text\r\n            this.thumbnail.width()\r\n        )\r\n    );\r\n    this.label.setCenter(this.center());\r\n    this.label.setTop(\r\n        this.thumbnail.bottom() + this.padding\r\n    );\r\n};\r\n\r\n// SpriteIconMorph menu\r\n\r\nSpriteIconMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this),\r\n        myself = this;\r\n    if (this.object instanceof StageMorph) {\r\n        menu.addItem(\r\n            'pic...',\r\n            function () {\r\n                var ide = myself.parentThatIsA(IDE_Morph);\r\n                ide.saveCanvasAs(\r\n                    myself.object.fullImageClassic(),\r\n                    this.object.name\r\n                );\r\n            },\r\n            'open a new window\\nwith a picture of the stage'\r\n        );\r\n        return menu;\r\n    }\r\n    if (!(this.object instanceof SpriteMorph)) {return null; }\r\n    menu.addItem(\"show\", 'showSpriteOnStage');\r\n    menu.addLine();\r\n    menu.addItem(\"duplicate\", 'duplicateSprite');\r\n    if (StageMorph.prototype.enableInheritance) {\r\n        menu.addItem(\"clone\", 'instantiateSprite');\r\n    }\r\n    menu.addItem(\"delete\", 'removeSprite');\r\n    menu.addLine();\r\n    if (StageMorph.prototype.enableInheritance) {\r\n        \r\n        menu.addItem(\"parent...\", 'chooseExemplar');\r\n        if (this.object.exemplar) {\r\n            menu.addItem(\r\n                \"release\",\r\n                'releaseSprite',\r\n                'make temporary and\\nhide in the sprite corral'\r\n            );\r\n        }\r\n    }\r\n    if (this.object.anchor) {\r\n        menu.addItem(\r\n            localize('detach from') + ' ' + this.object.anchor.name,\r\n            function () {myself.object.detachFromAnchor(); }\r\n        );\r\n    }\r\n    if (this.object.parts.length) {\r\n        menu.addItem(\r\n            'detach all parts',\r\n            function () {myself.object.detachAllParts(); }\r\n        );\r\n    }\r\n    menu.addItem(\"export...\", 'exportSprite');\r\n    return menu;\r\n};\r\n\r\nSpriteIconMorph.prototype.duplicateSprite = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.duplicateSprite(this.object);\r\n    }\r\n};\r\n\r\nSpriteIconMorph.prototype.instantiateSprite = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.instantiateSprite(this.object);\r\n    }\r\n};\r\n\r\nSpriteIconMorph.prototype.removeSprite = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (ide) {\r\n        ide.removeSprite(this.object);\r\n    }\r\n};\r\n\r\nSpriteIconMorph.prototype.exportSprite = function () {\r\n    this.object.exportSprite();\r\n};\r\n\r\nSpriteIconMorph.prototype.chooseExemplar = function () {\r\n    this.object.chooseExemplar();\r\n};\r\n\r\nSpriteIconMorph.prototype.releaseSprite = function () {\r\n    this.object.release();\r\n};\r\n\r\nSpriteIconMorph.prototype.showSpriteOnStage = function () {\r\n    this.object.showOnStage();\r\n};\r\n\r\n// SpriteIconMorph events\r\n\r\nSpriteIconMorph.prototype.mouseDoubleClick = function () {\r\n\tif (this.object instanceof SpriteMorph) {\r\n    \tthis.object.flash();\r\n    }\r\n};\r\n\r\n// SpriteIconMorph drawing\r\n\r\nSpriteIconMorph.prototype.createBackgrounds = function () {\r\n//    only draw the edges if I am selected\r\n    var context,\r\n        ext = this.extent();\r\n\r\n    if (this.template) { // take the backgrounds images from the template\r\n        this.image = this.template.image;\r\n        this.normalImage = this.template.normalImage;\r\n        this.highlightImage = this.template.highlightImage;\r\n        this.pressImage = this.template.pressImage;\r\n        return null;\r\n    }\r\n\r\n    this.normalImage = newCanvas(ext);\r\n    context = this.normalImage.getContext('2d');\r\n    this.drawBackground(context, this.color);\r\n\r\n    this.highlightImage = newCanvas(ext);\r\n    context = this.highlightImage.getContext('2d');\r\n    this.drawBackground(context, this.highlightColor);\r\n\r\n    this.pressImage = newCanvas(ext);\r\n    context = this.pressImage.getContext('2d');\r\n    this.drawOutline(context);\r\n    this.drawBackground(context, this.pressColor);\r\n    this.drawEdges(\r\n        context,\r\n        this.pressColor,\r\n        this.pressColor.lighter(this.contrast),\r\n        this.pressColor.darker(this.contrast)\r\n    );\r\n\r\n    this.image = this.normalImage;\r\n};\r\n\r\n// SpriteIconMorph drag & drop\r\n\r\nSpriteIconMorph.prototype.prepareToBeGrabbed = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph),\r\n        idx;\r\n    this.mouseClickLeft(); // select me\r\n    this.alpha = 0.85;\r\n    if (ide) {\r\n        idx = ide.sprites.asArray().indexOf(this.object);\r\n        ide.sprites.remove(idx + 1);\r\n        ide.createCorral();\r\n        ide.fixLayout();\r\n    }\r\n};\r\n\r\nSpriteIconMorph.prototype.justDropped = function () {\r\n    this.alpha = 1;\r\n};\r\n\r\nSpriteIconMorph.prototype.wantsDropOf = function (morph) {\r\n    // allow scripts & media to be copied from one sprite to another\r\n    // by drag & drop\r\n    return morph instanceof BlockMorph\r\n        || (morph instanceof CostumeIconMorph)\r\n        || (morph instanceof SoundIconMorph);\r\n};\r\n\r\nSpriteIconMorph.prototype.reactToDropOf = function (morph, hand) {\r\n    if (morph instanceof BlockMorph) {\r\n        this.copyStack(morph);\r\n    } else if (morph instanceof CostumeIconMorph) {\r\n        this.copyCostume(morph.object);\r\n    } else if (morph instanceof SoundIconMorph) {\r\n        this.copySound(morph.object);\r\n    }\r\n    this.world().add(morph);\r\n    morph.slideBackTo(hand.grabOrigin);\r\n};\r\n\r\nSpriteIconMorph.prototype.copyStack = function (block) {\r\n    var sprite = this.object,\r\n    \tdup = block.fullCopy(),\r\n        y = Math.max(sprite.scripts.children.map(function (stack) {\r\n            return stack.fullBounds().bottom();\r\n        }).concat([sprite.scripts.top()]));\r\n\r\n    dup.setPosition(new Point(sprite.scripts.left() + 20, y + 20));\r\n    sprite.scripts.add(dup);\r\n    dup.allComments().forEach(function (comment) {\r\n        comment.align(dup);\r\n    });\r\n    sprite.scripts.adjustBounds();\r\n\r\n    // delete all local custom blocks (methods) that the receiver\r\n    // doesn't understand\r\n    dup.allChildren().forEach(function (morph) {\r\n\t    if (morph.isCustomBlock &&\r\n        \t\t!morph.isGlobal &&\r\n        \t\t!sprite.getMethod(morph.blockSpec)\r\n        ) {\r\n            morph.deleteBlock();\r\n        }\r\n    });\r\n};\r\n\r\nSpriteIconMorph.prototype.copyCostume = function (costume) {\r\n    var dup = costume.copy();\r\n    dup.name = this.object.newCostumeName(dup.name);\r\n    this.object.addCostume(dup);\r\n    this.object.wearCostume(dup);\r\n};\r\n\r\nSpriteIconMorph.prototype.copySound = function (sound) {\r\n    var dup = sound.copy();\r\n    this.object.addSound(dup.audio, dup.name);\r\n};\r\n\r\n// CostumeIconMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a selectable element in the SpriteEditor's \"Costumes\" tab, keeping\r\n    a self-updating thumbnail of the costume I'm respresenting, and a\r\n    self-updating label of the costume's name (in case it is changed\r\n    elsewhere)\r\n*/\r\n\r\n// CostumeIconMorph inherits from ToggleButtonMorph (Widgets)\r\n// ... and copies methods from SpriteIconMorph\r\n\r\nCostumeIconMorph.prototype = new ToggleButtonMorph();\r\nCostumeIconMorph.prototype.constructor = CostumeIconMorph;\r\nCostumeIconMorph.uber = ToggleButtonMorph.prototype;\r\n\r\n// CostumeIconMorph settings\r\n\r\nCostumeIconMorph.prototype.thumbSize = new Point(80, 60);\r\nCostumeIconMorph.prototype.labelShadowOffset = null;\r\nCostumeIconMorph.prototype.labelShadowColor = null;\r\nCostumeIconMorph.prototype.labelColor = new Color(255, 255, 255);\r\nCostumeIconMorph.prototype.fontSize = 9;\r\n\r\n// CostumeIconMorph instance creation:\r\n\r\nfunction CostumeIconMorph(aCostume, aTemplate) {\r\n    this.init(aCostume, aTemplate);\r\n}\r\n\r\nCostumeIconMorph.prototype.init = function (aCostume, aTemplate) {\r\n    var colors, action, query, myself = this;\r\n\r\n    if (!aTemplate) {\r\n        colors = [\r\n            IDE_Morph.prototype.groupColor,\r\n            IDE_Morph.prototype.frameColor,\r\n            IDE_Morph.prototype.frameColor\r\n        ];\r\n\r\n    }\r\n\r\n    action = function () {\r\n        // make my costume the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph),\r\n            wardrobe = myself.parentThatIsA(WardrobeMorph);\r\n\r\n        if (ide) {\r\n            ide.currentSprite.wearCostume(myself.object);\r\n        }\r\n        if (wardrobe) {\r\n            wardrobe.updateSelection();\r\n        }\r\n    };\r\n\r\n    query = function () {\r\n        // answer true if my costume is the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph);\r\n\r\n        if (ide) {\r\n            return ide.currentSprite.costume === myself.object;\r\n        }\r\n        return false;\r\n    };\r\n\r\n    // additional properties:\r\n    this.object = aCostume || new Costume(); // mandatory, actually\r\n    this.version = this.object.version;\r\n    this.thumbnail = null;\r\n\r\n    // initialize inherited properties:\r\n    CostumeIconMorph.uber.init.call(\r\n        this,\r\n        colors, // color overrides, <array>: [normal, highlight, pressed]\r\n        null, // target - not needed here\r\n        action, // a toggle function\r\n        this.object.name, // label string\r\n        query, // predicate/selector\r\n        null, // environment\r\n        null, // hint\r\n        aTemplate // optional, for cached background images\r\n    );\r\n\r\n    // override defaults and build additional components\r\n    this.isDraggable = true;\r\n    this.createThumbnail();\r\n    this.padding = 2;\r\n    this.corner = 8;\r\n    this.fixLayout();\r\n    this.fps = 1;\r\n};\r\n\r\nCostumeIconMorph.prototype.createThumbnail = function () {\r\n    var txt;\r\n    SpriteIconMorph.prototype.createThumbnail.call(this);\r\n    if (this.object instanceof SVG_Costume) {\r\n        txt = new StringMorph(\r\n            'svg',\r\n            this.fontSize * 0.8,\r\n            this.fontStyle,\r\n            false,\r\n            false,\r\n            false,\r\n            this.labelShadowOffset,\r\n            this.labelShadowColor,\r\n            this.labelColor\r\n        );\r\n        txt.setBottom(this.thumbnail.bottom());\r\n        this.thumbnail.add(txt);\r\n    }\r\n};\r\n\r\nCostumeIconMorph.prototype.createLabel\r\n    = SpriteIconMorph.prototype.createLabel;\r\n\r\n// CostumeIconMorph stepping\r\n\r\nCostumeIconMorph.prototype.step\r\n    = SpriteIconMorph.prototype.step;\r\n\r\n// CostumeIconMorph layout\r\n\r\nCostumeIconMorph.prototype.fixLayout\r\n    = SpriteIconMorph.prototype.fixLayout;\r\n\r\n// CostumeIconMorph menu\r\n\r\nCostumeIconMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    if (!(this.object instanceof Costume)) {return null; }\r\n    menu.addItem(\"edit\", \"editCostume\");\r\n    if (this.world().currentKey === 16) { // shift clicked\r\n        menu.addItem(\r\n            'edit rotation point only...',\r\n            'editRotationPointOnly',\r\n            null,\r\n            new Color(100, 0, 0)\r\n        );\r\n    }\r\n    menu.addItem(\"rename\", \"renameCostume\");\r\n    menu.addLine();\r\n    menu.addItem(\"duplicate\", \"duplicateCostume\");\r\n    menu.addItem(\"delete\", \"removeCostume\");\r\n    menu.addLine();\r\n    menu.addItem(\"export\", \"exportCostume\");\r\n    return menu;\r\n};\r\n\r\nCostumeIconMorph.prototype.editCostume = function () {\r\n    this.disinherit();\r\n    if (this.object instanceof SVG_Costume) {\r\n        this.object.editRotationPointOnly(this.world());\r\n    } else {\r\n        this.object.edit(\r\n            this.world(),\r\n            this.parentThatIsA(IDE_Morph),\r\n            false // not a new costume, retain existing rotation center\r\n        );\r\n    }\r\n};\r\n\r\nCostumeIconMorph.prototype.editRotationPointOnly = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    this.object.editRotationPointOnly(this.world());\r\n    ide.hasChangedMedia = true;\r\n};\r\n\r\nCostumeIconMorph.prototype.renameCostume = function () {\r\n    this.disinherit();\r\n    var costume = this.object,\r\n        wardrobe = this.parentThatIsA(WardrobeMorph),\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n    new DialogBoxMorph(\r\n        null,\r\n        function (answer) {\r\n            if (answer && (answer !== costume.name)) {\r\n                costume.name = wardrobe.sprite.newCostumeName(\r\n                    answer,\r\n                    costume\r\n                );\r\n                costume.version = Date.now();\r\n                ide.hasChangedMedia = true;\r\n            }\r\n        }\r\n    ).prompt(\r\n        this.currentSprite instanceof SpriteMorph ?\r\n            'rename costume' : 'rename background',\r\n        costume.name,\r\n        this.world()\r\n    );\r\n};\r\n\r\nCostumeIconMorph.prototype.duplicateCostume = function () {\r\n    var wardrobe = this.parentThatIsA(WardrobeMorph),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        newcos = this.object.copy();\r\n    newcos.name = wardrobe.sprite.newCostumeName(newcos.name);\r\n    wardrobe.sprite.addCostume(newcos);\r\n    wardrobe.updateList();\r\n    if (ide) {\r\n        ide.currentSprite.wearCostume(newcos);\r\n    }\r\n};\r\n\r\nCostumeIconMorph.prototype.removeCostume = function () {\r\n    var wardrobe = this.parentThatIsA(WardrobeMorph),\r\n        idx = this.parent.children.indexOf(this),\r\n        off = CamSnapshotDialogMorph.prototype.enableCamera ? 3 : 2,\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n    wardrobe.removeCostumeAt(idx - off); // ignore paintbrush and camera buttons\r\n    if (ide.currentSprite.costume === this.object) {\r\n        ide.currentSprite.wearCostume(null);\r\n    }\r\n};\r\n\r\nCostumeIconMorph.prototype.exportCostume = function () {\r\n    var ide = this.parentThatIsA(IDE_Morph);\r\n    if (this.object instanceof SVG_Costume) {\r\n        // don't show SVG costumes in a new tab (shows text)\r\n        ide.saveFileAs(this.object.contents.src, 'text/svg', this.object.name);\r\n    } else { // rasterized Costume\r\n        ide.saveCanvasAs(this.object.contents, this.object.name);\r\n    }\r\n};\r\n\r\n// CostumeIconMorph drawing\r\n\r\nCostumeIconMorph.prototype.createBackgrounds\r\n    = SpriteIconMorph.prototype.createBackgrounds;\r\n\r\n// CostumeIconMorph inheritance\r\n\r\nCostumeIconMorph.prototype.disinherit = function () {\r\n    var wardrobe = this.parentThatIsA(WardrobeMorph),\r\n        idx = this.parent.children.indexOf(this);\r\n    if (wardrobe.sprite.inheritsAttribute('costumes')) {\r\n        wardrobe.sprite.shadowAttribute('costumes');\r\n        this.object = wardrobe.sprite.costumes.at(idx - 2);\r\n    }\r\n};\r\n\r\n// CostumeIconMorph drag & drop\r\n\r\nCostumeIconMorph.prototype.prepareToBeGrabbed = function () {\r\n    this.disinherit();\r\n    this.mouseClickLeft(); // select me\r\n    this.removeCostume();\r\n};\r\n\r\n// TurtleIconMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a selectable element in the SpriteEditor's \"Costumes\" tab, keeping\r\n    a thumbnail of the sprite's or stage's default \"Turtle\" costume.\r\n*/\r\n\r\n// TurtleIconMorph inherits from ToggleButtonMorph (Widgets)\r\n// ... and copies methods from SpriteIconMorph\r\n\r\nTurtleIconMorph.prototype = new ToggleButtonMorph();\r\nTurtleIconMorph.prototype.constructor = TurtleIconMorph;\r\nTurtleIconMorph.uber = ToggleButtonMorph.prototype;\r\n\r\n// TurtleIconMorph settings\r\n\r\nTurtleIconMorph.prototype.thumbSize = new Point(80, 60);\r\nTurtleIconMorph.prototype.labelShadowOffset = null;\r\nTurtleIconMorph.prototype.labelShadowColor = null;\r\nTurtleIconMorph.prototype.labelColor = new Color(255, 255, 255);\r\nTurtleIconMorph.prototype.fontSize = 9;\r\n\r\n// TurtleIconMorph instance creation:\r\n\r\nfunction TurtleIconMorph(aSpriteOrStage, aTemplate) {\r\n    this.init(aSpriteOrStage, aTemplate);\r\n}\r\n\r\nTurtleIconMorph.prototype.init = function (aSpriteOrStage, aTemplate) {\r\n    var colors, action, query, myself = this;\r\n\r\n    if (!aTemplate) {\r\n        colors = [\r\n            IDE_Morph.prototype.groupColor,\r\n            IDE_Morph.prototype.frameColor,\r\n            IDE_Morph.prototype.frameColor\r\n        ];\r\n\r\n    }\r\n\r\n    action = function () {\r\n        // make my costume the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph),\r\n            wardrobe = myself.parentThatIsA(WardrobeMorph);\r\n\r\n        if (ide) {\r\n            ide.currentSprite.wearCostume(null);\r\n        }\r\n        if (wardrobe) {\r\n            wardrobe.updateSelection();\r\n        }\r\n    };\r\n\r\n    query = function () {\r\n        // answer true if my costume is the current one\r\n        var ide = myself.parentThatIsA(IDE_Morph);\r\n\r\n        if (ide) {\r\n            return ide.currentSprite.costume === null;\r\n        }\r\n        return false;\r\n    };\r\n\r\n    // additional properties:\r\n    this.object = aSpriteOrStage; // mandatory, actually\r\n    this.version = this.object.version;\r\n    this.thumbnail = null;\r\n\r\n    // initialize inherited properties:\r\n    TurtleIconMorph.uber.init.call(\r\n        this,\r\n        colors, // color overrides, <array>: [normal, highlight, pressed]\r\n        null, // target - not needed here\r\n        action, // a toggle function\r\n        'default', // label string\r\n        query, // predicate/selector\r\n        null, // environment\r\n        null, // hint\r\n        aTemplate // optional, for cached background images\r\n    );\r\n\r\n    // override defaults and build additional components\r\n    this.isDraggable = false;\r\n    this.createThumbnail();\r\n    this.padding = 2;\r\n    this.corner = 8;\r\n    this.fixLayout();\r\n};\r\n\r\nTurtleIconMorph.prototype.createThumbnail = function () {\r\n    var isFlat = MorphicPreferences.isFlat;\r\n\r\n    if (this.thumbnail) {\r\n        this.thumbnail.destroy();\r\n    }\r\n    if (this.object instanceof SpriteMorph) {\r\n        this.thumbnail = new SymbolMorph(\r\n            'turtle',\r\n            this.thumbSize.y,\r\n            this.labelColor,\r\n            isFlat ? null : new Point(-1, -1),\r\n            new Color(0, 0, 0)\r\n        );\r\n    } else {\r\n        this.thumbnail = new SymbolMorph(\r\n            'stage',\r\n            this.thumbSize.y,\r\n            this.labelColor,\r\n            isFlat ? null : new Point(-1, -1),\r\n            new Color(0, 0, 0)\r\n        );\r\n    }\r\n    this.add(this.thumbnail);\r\n};\r\n\r\nTurtleIconMorph.prototype.createLabel = function () {\r\n    var txt;\r\n\r\n    if (this.label) {\r\n        this.label.destroy();\r\n    }\r\n    txt = new StringMorph(\r\n        localize(\r\n            this.object instanceof SpriteMorph ? 'Turtle' : 'Empty'\r\n        ),\r\n        this.fontSize,\r\n        this.fontStyle,\r\n        true,\r\n        false,\r\n        false,\r\n        this.labelShadowOffset,\r\n        this.labelShadowColor,\r\n        this.labelColor\r\n    );\r\n\r\n    this.label = new FrameMorph();\r\n    this.label.acceptsDrops = false;\r\n    this.label.alpha = 0;\r\n    this.label.setExtent(txt.extent());\r\n    txt.setPosition(this.label.position());\r\n    this.label.add(txt);\r\n    this.add(this.label);\r\n};\r\n\r\n// TurtleIconMorph layout\r\n\r\nTurtleIconMorph.prototype.fixLayout\r\n    = SpriteIconMorph.prototype.fixLayout;\r\n\r\n// TurtleIconMorph drawing\r\n\r\nTurtleIconMorph.prototype.createBackgrounds\r\n    = SpriteIconMorph.prototype.createBackgrounds;\r\n\r\n// TurtleIconMorph user menu\r\n\r\nTurtleIconMorph.prototype.userMenu = function () {\r\n    var myself = this,\r\n        menu = new MenuMorph(this, 'pen'),\r\n        on = '\\u25CF',\r\n        off = '\\u25CB';\r\n    if (this.object instanceof StageMorph) {\r\n        return null;\r\n    }\r\n    menu.addItem(\r\n        (this.object.penPoint === 'tip' ? on : off) + ' ' + localize('tip'),\r\n        function () {\r\n            myself.object.penPoint = 'tip';\r\n            myself.object.changed();\r\n            myself.object.drawNew();\r\n            myself.object.changed();\r\n        }\r\n    );\r\n    menu.addItem(\r\n        (this.object.penPoint === 'middle' ? on : off) + ' ' + localize(\r\n            'middle'\r\n        ),\r\n        function () {\r\n            myself.object.penPoint = 'middle';\r\n            myself.object.changed();\r\n            myself.object.drawNew();\r\n            myself.object.changed();\r\n        }\r\n    );\r\n    return menu;\r\n};\r\n\r\n// WardrobeMorph ///////////////////////////////////////////////////////\r\n\r\n// I am a watcher on a sprite's costume list\r\n\r\n// WardrobeMorph inherits from ScrollFrameMorph\r\n\r\nWardrobeMorph.prototype = new ScrollFrameMorph();\r\nWardrobeMorph.prototype.constructor = WardrobeMorph;\r\nWardrobeMorph.uber = ScrollFrameMorph.prototype;\r\n\r\n// WardrobeMorph settings\r\n\r\n// ... to follow ...\r\n\r\n// WardrobeMorph instance creation:\r\n\r\nfunction WardrobeMorph(aSprite, sliderColor) {\r\n    this.init(aSprite, sliderColor);\r\n}\r\n\r\nWardrobeMorph.prototype.init = function (aSprite, sliderColor) {\r\n    // additional properties\r\n    this.sprite = aSprite || new SpriteMorph();\r\n    this.costumesVersion = null;\r\n    this.spriteVersion = null;\r\n\r\n    // initialize inherited properties\r\n    WardrobeMorph.uber.init.call(this, null, null, sliderColor);\r\n\r\n    // configure inherited properties\r\n    this.fps = 2;\r\n    this.updateList();\r\n};\r\n\r\n// Wardrobe updating\r\n\r\nWardrobeMorph.prototype.updateList = function () {\r\n    var myself = this,\r\n        x = this.left() + 5,\r\n        y = this.top() + 5,\r\n        padding = 4,\r\n        toolsPadding = 5,\r\n        oldFlag = Morph.prototype.trackChanges,\r\n        oldPos = this.contents.position(),\r\n        icon,\r\n        template,\r\n        txt,\r\n        paintbutton,\r\n        cambutton;\r\n\r\n    this.changed();\r\n    oldFlag = Morph.prototype.trackChanges;\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    this.contents.destroy();\r\n    this.contents = new FrameMorph(this);\r\n    this.contents.acceptsDrops = false;\r\n    this.contents.reactToDropOf = function (icon) {\r\n        myself.reactToDropOf(icon);\r\n    };\r\n    this.addBack(this.contents);\r\n\r\n    icon = new TurtleIconMorph(this.sprite);\r\n    icon.setPosition(new Point(x, y));\r\n    myself.addContents(icon);\r\n    y = icon.bottom() + padding;\r\n\r\n    paintbutton = new PushButtonMorph(\r\n        this,\r\n        \"paintNew\",\r\n        new SymbolMorph(\"brush\", 15)\r\n    );\r\n    paintbutton.padding = 0;\r\n    paintbutton.corner = 12;\r\n    paintbutton.color = IDE_Morph.prototype.groupColor;\r\n    paintbutton.highlightColor = IDE_Morph.prototype.frameColor.darker(50);\r\n    paintbutton.pressColor = paintbutton.highlightColor;\r\n    paintbutton.labelMinExtent = new Point(36, 18);\r\n    paintbutton.labelShadowOffset = new Point(-1, -1);\r\n    paintbutton.labelShadowColor = paintbutton.highlightColor;\r\n    paintbutton.labelColor = TurtleIconMorph.prototype.labelColor;\r\n    paintbutton.contrast = this.buttonContrast;\r\n    paintbutton.drawNew();\r\n    paintbutton.hint = \"Paint a new costume\";\r\n    paintbutton.setPosition(new Point(x, y));\r\n    paintbutton.fixLayout();\r\n    paintbutton.setCenter(icon.center());\r\n    paintbutton.setLeft(icon.right() + padding * 4);\r\n\r\n    this.addContents(paintbutton);\r\n\r\n    if (CamSnapshotDialogMorph.prototype.enableCamera) {\r\n        cambutton = new PushButtonMorph(\r\n            this,\r\n            \"newFromCam\",\r\n            new SymbolMorph(\"camera\", 15)\r\n            );\r\n        cambutton.padding = 0;\r\n        cambutton.corner = 12;\r\n        cambutton.color = IDE_Morph.prototype.groupColor;\r\n        cambutton.highlightColor = IDE_Morph.prototype.frameColor.darker(50);\r\n        cambutton.pressColor = paintbutton.highlightColor;\r\n        cambutton.labelMinExtent = new Point(36, 18);\r\n        cambutton.labelShadowOffset = new Point(-1, -1);\r\n        cambutton.labelShadowColor = paintbutton.highlightColor;\r\n        cambutton.labelColor = TurtleIconMorph.prototype.labelColor;\r\n        cambutton.contrast = this.buttonContrast;\r\n        cambutton.drawNew();\r\n        cambutton.hint = \"Import a new costume from your webcam\";\r\n        cambutton.setPosition(new Point(x, y));\r\n        cambutton.fixLayout();\r\n        cambutton.setCenter(paintbutton.center());\r\n        cambutton.setLeft(paintbutton.right() + toolsPadding);\r\n\r\n        this.addContents(cambutton);\r\n\r\n        if (!CamSnapshotDialogMorph.prototype.enabled) {\r\n            cambutton.disable();\r\n            cambutton.hint = CamSnapshotDialogMorph.prototype.notSupportedMessage;\r\n        }\r\n\r\n        document.addEventListener(\r\n            'cameraDisabled',\r\n            function () {\r\n                cambutton.disable();\r\n                cambutton.hint =\r\n                    CamSnapshotDialogMorph.prototype.notSupportedMessage;\r\n            }\r\n        );\r\n    }\r\n\r\n    txt = new TextMorph(localize(\r\n        \"costumes tab help\" // look up long string in translator\r\n    ));\r\n    txt.fontSize = 9;\r\n    txt.setColor(SpriteMorph.prototype.paletteTextColor);\r\n\r\n    txt.setPosition(new Point(x, y));\r\n    this.addContents(txt);\r\n    y = txt.bottom() + padding;\r\n\r\n    this.sprite.costumes.asArray().forEach(function (costume) {\r\n        template = icon = new CostumeIconMorph(costume, template);\r\n        icon.setPosition(new Point(x, y));\r\n        myself.addContents(icon);\r\n        y = icon.bottom() + padding;\r\n    });\r\n    this.costumesVersion = this.sprite.costumes.lastChanged;\r\n\r\n    this.contents.setPosition(oldPos);\r\n    this.adjustScrollBars();\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n\r\n    this.updateSelection();\r\n};\r\n\r\nWardrobeMorph.prototype.updateSelection = function () {\r\n    this.contents.children.forEach(function (morph) {\r\n        if (morph.refresh) {morph.refresh(); }\r\n    });\r\n    this.spriteVersion = this.sprite.version;\r\n};\r\n\r\n// Wardrobe stepping\r\n\r\nWardrobeMorph.prototype.step = function () {\r\n    if (this.costumesVersion !== this.sprite.costumes.lastChanged) {\r\n        this.updateList();\r\n    }\r\n    if (this.spriteVersion !== this.sprite.version) {\r\n        this.updateSelection();\r\n    }\r\n};\r\n\r\n// Wardrobe ops\r\n\r\nWardrobeMorph.prototype.removeCostumeAt = function (idx) {\r\n    this.sprite.shadowAttribute('costumes');\r\n    this.sprite.costumes.remove(idx);\r\n    this.updateList();\r\n};\r\n\r\nWardrobeMorph.prototype.paintNew = function () {\r\n    var cos = new Costume(\r\n            newCanvas(null, true),\r\n            this.sprite.newCostumeName(localize('Untitled'))\r\n        ),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        myself = this;\r\n    cos.edit(this.world(), ide, true, null, function () {\r\n        myself.sprite.shadowAttribute('costumes');\r\n        myself.sprite.addCostume(cos);\r\n        myself.updateList();\r\n        if (ide) {\r\n            ide.currentSprite.wearCostume(cos);\r\n        }\r\n    });\r\n};\r\n\r\nWardrobeMorph.prototype.newFromCam = function () {\r\n    var camDialog,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        myself = this,\r\n        sprite = this.sprite;\r\n\r\n    camDialog = new CamSnapshotDialogMorph(\r\n        ide,\r\n        sprite,\r\n        nop,\r\n        function (costume) {\r\n            sprite.addCostume(costume);\r\n            sprite.wearCostume(costume);\r\n            myself.updateList();\r\n        });\r\n\r\n    camDialog.popUp(this.world());\r\n};\r\n\r\n// Wardrobe drag & drop\r\n\r\nWardrobeMorph.prototype.wantsDropOf = function (morph) {\r\n    return morph instanceof CostumeIconMorph;\r\n};\r\n\r\nWardrobeMorph.prototype.reactToDropOf = function (icon) {\r\n    var idx = 0,\r\n        costume = icon.object,\r\n        top = icon.top();\r\n\r\n    icon.destroy();\r\n    this.contents.children.forEach(function (item) {\r\n        if (item instanceof CostumeIconMorph && item.top() < top - 4) {\r\n            idx += 1;\r\n        }\r\n    });\r\n    this.sprite.shadowAttribute('costumes');\r\n    this.sprite.costumes.add(costume, idx + 1);\r\n    this.updateList();\r\n    icon.mouseClickLeft(); // select\r\n};\r\n\r\n// SoundIconMorph ///////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am an element in the SpriteEditor's \"Sounds\" tab.\r\n*/\r\n\r\n// SoundIconMorph inherits from ToggleButtonMorph (Widgets)\r\n// ... and copies methods from SpriteIconMorph\r\n\r\nSoundIconMorph.prototype = new ToggleButtonMorph();\r\nSoundIconMorph.prototype.constructor = SoundIconMorph;\r\nSoundIconMorph.uber = ToggleButtonMorph.prototype;\r\n\r\n// SoundIconMorph settings\r\n\r\nSoundIconMorph.prototype.thumbSize = new Point(80, 60);\r\nSoundIconMorph.prototype.labelShadowOffset = null;\r\nSoundIconMorph.prototype.labelShadowColor = null;\r\nSoundIconMorph.prototype.labelColor = new Color(255, 255, 255);\r\nSoundIconMorph.prototype.fontSize = 9;\r\n\r\n// SoundIconMorph instance creation:\r\n\r\nfunction SoundIconMorph(aSound, aTemplate) {\r\n    this.init(aSound, aTemplate);\r\n}\r\n\r\nSoundIconMorph.prototype.init = function (aSound, aTemplate) {\r\n    var colors, action, query;\r\n\r\n    if (!aTemplate) {\r\n        colors = [\r\n            IDE_Morph.prototype.groupColor,\r\n            IDE_Morph.prototype.frameColor,\r\n            IDE_Morph.prototype.frameColor\r\n        ];\r\n\r\n    }\r\n\r\n    action = function () {\r\n        nop(); // When I am selected (which is never the case for sounds)\r\n    };\r\n\r\n    query = function () {\r\n        return false;\r\n    };\r\n\r\n    // additional properties:\r\n    this.object = aSound; // mandatory, actually\r\n    this.version = this.object.version;\r\n    this.thumbnail = null;\r\n\r\n    // initialize inherited properties:\r\n    SoundIconMorph.uber.init.call(\r\n        this,\r\n        colors, // color overrides, <array>: [normal, highlight, pressed]\r\n        null, // target - not needed here\r\n        action, // a toggle function\r\n        this.object.name, // label string\r\n        query, // predicate/selector\r\n        null, // environment\r\n        null, // hint\r\n        aTemplate // optional, for cached background images\r\n    );\r\n\r\n    // override defaults and build additional components\r\n    this.isDraggable = true;\r\n    this.createThumbnail();\r\n    this.padding = 2;\r\n    this.corner = 8;\r\n    this.fixLayout();\r\n    this.fps = 1;\r\n};\r\n\r\nSoundIconMorph.prototype.createThumbnail = function () {\r\n    var label;\r\n    if (this.thumbnail) {\r\n        this.thumbnail.destroy();\r\n    }\r\n    this.thumbnail = new Morph();\r\n    this.thumbnail.setExtent(this.thumbSize);\r\n    this.add(this.thumbnail);\r\n    label = new StringMorph(\r\n        this.createInfo(),\r\n        '16',\r\n        '',\r\n        true,\r\n        false,\r\n        false,\r\n        this.labelShadowOffset,\r\n        this.labelShadowColor,\r\n        new Color(200, 200, 200)\r\n    );\r\n    this.thumbnail.add(label);\r\n    label.setCenter(new Point(40, 15));\r\n\r\n    this.button = new PushButtonMorph(\r\n        this,\r\n        'toggleAudioPlaying',\r\n        (this.object.previewAudio ? 'Stop' : 'Play')\r\n    );\r\n    this.button.drawNew();\r\n    this.button.hint = 'Play sound';\r\n    this.button.fixLayout();\r\n    this.thumbnail.add(this.button);\r\n    this.button.setCenter(new Point(40, 40));\r\n};\r\n\r\nSoundIconMorph.prototype.createInfo = function () {\r\n    var dur = Math.round(this.object.audio.duration || 0),\r\n        mod = dur % 60;\r\n    return Math.floor(dur / 60).toString()\r\n            + \":\"\r\n            + (mod < 10 ? \"0\" : \"\")\r\n            + mod.toString();\r\n};\r\n\r\nSoundIconMorph.prototype.toggleAudioPlaying = function () {\r\n    var myself = this;\r\n    if (!this.object.previewAudio) {\r\n        //Audio is not playing\r\n        this.button.labelString = 'Stop';\r\n        this.button.hint = 'Stop sound';\r\n        this.object.previewAudio = this.object.play();\r\n        this.object.previewAudio.addEventListener('ended', function () {\r\n            myself.audioHasEnded();\r\n        }, false);\r\n    } else {\r\n        //Audio is currently playing\r\n        this.button.labelString = 'Play';\r\n        this.button.hint = 'Play sound';\r\n        this.object.previewAudio.pause();\r\n        this.object.previewAudio.terminated = true;\r\n        this.object.previewAudio = null;\r\n    }\r\n    this.button.createLabel();\r\n};\r\n\r\nSoundIconMorph.prototype.audioHasEnded = function () {\r\n    this.button.trigger();\r\n    this.button.mouseLeave();\r\n};\r\n\r\nSoundIconMorph.prototype.createLabel\r\n    = SpriteIconMorph.prototype.createLabel;\r\n\r\n// SoundIconMorph layout\r\n\r\nSoundIconMorph.prototype.fixLayout\r\n    = SpriteIconMorph.prototype.fixLayout;\r\n\r\n// SoundIconMorph menu\r\n\r\nSoundIconMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    if (!(this.object instanceof Sound)) { return null; }\r\n    menu.addItem('rename', 'renameSound');\r\n    menu.addItem('delete', 'removeSound');\r\n    return menu;\r\n};\r\n\r\n\r\nSoundIconMorph.prototype.renameSound = function () {\r\n    var sound = this.object,\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        myself = this;\r\n    this.disinherit();\r\n    (new DialogBoxMorph(\r\n        null,\r\n        function (answer) {\r\n            if (answer && (answer !== sound.name)) {\r\n                sound.name = answer;\r\n                sound.version = Date.now();\r\n                myself.createLabel(); // can be omitted once I'm stepping\r\n                myself.fixLayout(); // can be omitted once I'm stepping\r\n                ide.hasChangedMedia = true;\r\n            }\r\n        }\r\n    )).prompt(\r\n        'rename sound',\r\n        sound.name,\r\n        this.world()\r\n    );\r\n};\r\n\r\nSoundIconMorph.prototype.removeSound = function () {\r\n    var jukebox = this.parentThatIsA(JukeboxMorph),\r\n        idx = this.parent.children.indexOf(this);\r\n    jukebox.removeSound(idx);\r\n};\r\n\r\nSoundIconMorph.prototype.createBackgrounds\r\n    = SpriteIconMorph.prototype.createBackgrounds;\r\n\r\nSoundIconMorph.prototype.createLabel\r\n    = SpriteIconMorph.prototype.createLabel;\r\n\r\n// SoundIconMorph inheritance\r\n\r\nSoundIconMorph.prototype.disinherit = function () {\r\n    var jukebox = this.parentThatIsA(JukeboxMorph),\r\n        idx = this.parent.children.indexOf(this);\r\n    if (jukebox.sprite.inheritsAttribute('sounds')) {\r\n        jukebox.sprite.shadowAttribute('sounds');\r\n        this.object = jukebox.sprite.sounds.at(idx);\r\n    }\r\n};\r\n\r\n// SoundIconMorph drag & drop\r\n\r\nSoundIconMorph.prototype.prepareToBeGrabbed = function () {\r\n    this.disinherit();\r\n    this.removeSound();\r\n};\r\n\r\n// JukeboxMorph /////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am JukeboxMorph, like WardrobeMorph, but for sounds\r\n*/\r\n\r\n// JukeboxMorph instance creation\r\n\r\nJukeboxMorph.prototype = new ScrollFrameMorph();\r\nJukeboxMorph.prototype.constructor = JukeboxMorph;\r\nJukeboxMorph.uber = ScrollFrameMorph.prototype;\r\n\r\nfunction JukeboxMorph(aSprite, sliderColor) {\r\n    this.init(aSprite, sliderColor);\r\n}\r\n\r\nJukeboxMorph.prototype.init = function (aSprite, sliderColor) {\r\n    // additional properties\r\n    this.sprite = aSprite || new SpriteMorph();\r\n    this.soundsVersion = null;\r\n    this.spriteVersion = null;\r\n\r\n    // initialize inherited properties\r\n    JukeboxMorph.uber.init.call(this, null, null, sliderColor);\r\n\r\n    // configure inherited properties\r\n    this.acceptsDrops = false;\r\n    this.fps = 2;\r\n    this.updateList();\r\n};\r\n\r\n// Jukebox updating\r\n\r\nJukeboxMorph.prototype.updateList = function () {\r\n    var myself = this,\r\n        x = this.left() + 5,\r\n        y = this.top() + 5,\r\n        padding = 4,\r\n        oldFlag = Morph.prototype.trackChanges,\r\n        icon,\r\n        template,\r\n        txt;\r\n\r\n    this.changed();\r\n    oldFlag = Morph.prototype.trackChanges;\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    this.contents.destroy();\r\n    this.contents = new FrameMorph(this);\r\n    this.contents.acceptsDrops = false;\r\n    this.contents.reactToDropOf = function (icon) {\r\n        myself.reactToDropOf(icon);\r\n    };\r\n    this.addBack(this.contents);\r\n\r\n    txt = new TextMorph(localize(\r\n        'import a sound from your computer\\nby dragging it into here'\r\n    ));\r\n    txt.fontSize = 9;\r\n    txt.setColor(SpriteMorph.prototype.paletteTextColor);\r\n    txt.setPosition(new Point(x, y));\r\n    this.addContents(txt);\r\n    y = txt.bottom() + padding;\r\n\r\n    this.sprite.sounds.asArray().forEach(function (sound) {\r\n        template = icon = new SoundIconMorph(sound, template);\r\n        icon.setPosition(new Point(x, y));\r\n        myself.addContents(icon);\r\n        y = icon.bottom() + padding;\r\n    });\r\n    this.soundsVersion = this.sprite.costumes.lastChanged;\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n\r\n    this.updateSelection();\r\n};\r\n\r\nJukeboxMorph.prototype.updateSelection = function () {\r\n    this.contents.children.forEach(function (morph) {\r\n        if (morph.refresh) {morph.refresh(); }\r\n    });\r\n    this.spriteVersion = this.sprite.version;\r\n};\r\n\r\n// Jukebox stepping\r\n\r\nJukeboxMorph.prototype.step = function () {\r\n    if (this.soundsVersion !== this.sprite.sounds.lastChanged) {\r\n        this.updateList();\r\n    }\r\n    if (this.spriteVersion !== this.sprite.version) {\r\n        this.updateSelection();\r\n    }\r\n};\r\n\r\n// Jukebox ops\r\n\r\nJukeboxMorph.prototype.removeSound = function (idx) {\r\n    this.sprite.sounds.remove(idx);\r\n    this.updateList();\r\n};\r\n\r\n// Jukebox drag & drop\r\n\r\nJukeboxMorph.prototype.wantsDropOf = function (morph) {\r\n    return morph instanceof SoundIconMorph;\r\n};\r\n\r\nJukeboxMorph.prototype.reactToDropOf = function (icon) {\r\n    var idx = 0,\r\n        costume = icon.object,\r\n        top = icon.top();\r\n\r\n    icon.destroy();\r\n    this.contents.children.forEach(function (item) {\r\n        if (item.top() < top - 4) {\r\n            idx += 1;\r\n        }\r\n    });\r\n\r\n    this.sprite.shadowAttribute('sounds');\r\n    this.sprite.sounds.add(costume, idx);\r\n    this.updateList();\r\n};\r\n\r\n// StageHandleMorph ////////////////////////////////////////////////////////\r\n\r\n// I am a horizontal resizing handle for a StageMorph\r\n\r\n// StageHandleMorph inherits from Morph:\r\n\r\nStageHandleMorph.prototype = new Morph();\r\nStageHandleMorph.prototype.constructor = StageHandleMorph;\r\nStageHandleMorph.uber = Morph.prototype;\r\n\r\n// StageHandleMorph instance creation:\r\n\r\nfunction StageHandleMorph(target) {\r\n    this.init(target);\r\n}\r\n\r\nStageHandleMorph.prototype.init = function (target) {\r\n    this.target = target || null;\r\n    HandleMorph.uber.init.call(this);\r\n    this.color = MorphicPreferences.isFlat ?\r\n            IDE_Morph.prototype.groupColor : new Color(190, 190, 190);\r\n    this.isDraggable = false;\r\n    this.noticesTransparentClick = true;\r\n    this.setExtent(new Point(12, 50));\r\n};\r\n\r\n// StageHandleMorph drawing:\r\n\r\nStageHandleMorph.prototype.drawNew = function () {\r\n    this.normalImage = newCanvas(this.extent());\r\n    this.highlightImage = newCanvas(this.extent());\r\n    this.drawOnCanvas(\r\n        this.normalImage,\r\n        this.color\r\n    );\r\n    this.drawOnCanvas(\r\n        this.highlightImage,\r\n        MorphicPreferences.isFlat ?\r\n                new Color(245, 245, 255) : new Color(100, 100, 255),\r\n        this.color\r\n    );\r\n    this.image = this.normalImage;\r\n    this.fixLayout();\r\n};\r\n\r\nStageHandleMorph.prototype.drawOnCanvas = function (\r\n    aCanvas,\r\n    color,\r\n    shadowColor\r\n) {\r\n    var context = aCanvas.getContext('2d'),\r\n        l = aCanvas.height / 8,\r\n        w = aCanvas.width / 6,\r\n        r = w / 2,\r\n        x,\r\n        y,\r\n        i;\r\n\r\n    context.lineWidth = w;\r\n    context.lineCap = 'round';\r\n    y = aCanvas.height / 2;\r\n\r\n    context.strokeStyle = color.toString();\r\n    x = aCanvas.width / 12;\r\n    for (i = 0; i < 3; i += 1) {\r\n        if (i > 0) {\r\n            context.beginPath();\r\n            context.moveTo(x, y - (l - r));\r\n            context.lineTo(x, y + (l - r));\r\n            context.stroke();\r\n        }\r\n        x += (w * 2);\r\n        l *= 2;\r\n    }\r\n    if (shadowColor) {\r\n        context.strokeStyle = shadowColor.toString();\r\n        x = aCanvas.width / 12 + w;\r\n        l = aCanvas.height / 8;\r\n        for (i = 0; i < 3; i += 1) {\r\n            if (i > 0) {\r\n                context.beginPath();\r\n                context.moveTo(x, y - (l - r));\r\n                context.lineTo(x, y + (l - r));\r\n                context.stroke();\r\n            }\r\n            x += (w * 2);\r\n            l *= 2;\r\n        }\r\n    }\r\n};\r\n\r\n// StageHandleMorph layout:\r\n\r\nStageHandleMorph.prototype.fixLayout = function () {\r\n    if (!this.target) {return; }\r\n    var ide = this.target.parentThatIsA(IDE_Morph);\r\n    this.setTop(this.target.top() + 10);\r\n    this.setRight(this.target.left());\r\n    if (ide) {ide.add(this); } // come to front\r\n};\r\n\r\n// StageHandleMorph stepping:\r\n\r\nStageHandleMorph.prototype.step = null;\r\n\r\nStageHandleMorph.prototype.mouseDownLeft = function (pos) {\r\n    var world = this.world(),\r\n        offset = this.right() - pos.x,\r\n        myself = this,\r\n        ide = this.target.parentThatIsA(IDE_Morph);\r\n\r\n    if (!this.target) {\r\n        return null;\r\n    }\r\n    ide.isSmallStage = true;\r\n    ide.controlBar.stageSizeButton.refresh();\r\n    this.step = function () {\r\n        var newPos, newWidth;\r\n        if (world.hand.mouseButton) {\r\n            newPos = world.hand.bounds.origin.x + offset;\r\n            newWidth = myself.target.right() - newPos;\r\n            ide.stageRatio = newWidth / myself.target.dimensions.x;\r\n            ide.setExtent(world.extent());\r\n\r\n        } else {\r\n            this.step = null;\r\n            ide.isSmallStage = (ide.stageRatio !== 1);\r\n            ide.controlBar.stageSizeButton.refresh();\r\n        }\r\n    };\r\n};\r\n\r\n// StageHandleMorph events:\r\n\r\nStageHandleMorph.prototype.mouseEnter = function () {\r\n    this.image = this.highlightImage;\r\n    this.changed();\r\n};\r\n\r\nStageHandleMorph.prototype.mouseLeave = function () {\r\n    this.image = this.normalImage;\r\n    this.changed();\r\n};\r\n\r\nStageHandleMorph.prototype.mouseDoubleClick = function () {\r\n    this.target.parentThatIsA(IDE_Morph).toggleStageSize(true, 1);\r\n};\r\n\r\n// PaletteHandleMorph ////////////////////////////////////////////////////////\r\n\r\n// I am a horizontal resizing handle for a blocks palette\r\n// I pseudo-inherit many things from StageHandleMorph\r\n\r\n// PaletteHandleMorph inherits from Morph:\r\n\r\nPaletteHandleMorph.prototype = new Morph();\r\nPaletteHandleMorph.prototype.constructor = PaletteHandleMorph;\r\nPaletteHandleMorph.uber = Morph.prototype;\r\n\r\n// PaletteHandleMorph instance creation:\r\n\r\nfunction PaletteHandleMorph(target) {\r\n    this.init(target);\r\n}\r\n\r\nPaletteHandleMorph.prototype.init = function (target) {\r\n    this.target = target || null;\r\n    HandleMorph.uber.init.call(this);\r\n    this.color = MorphicPreferences.isFlat ?\r\n            new Color(255, 255, 255) : new Color(190, 190, 190);\r\n    this.isDraggable = false;\r\n    this.noticesTransparentClick = true;\r\n    this.setExtent(new Point(12, 50));\r\n};\r\n\r\n// PaletteHandleMorph drawing:\r\n\r\nPaletteHandleMorph.prototype.drawNew =\r\n    StageHandleMorph.prototype.drawNew;\r\n\r\nPaletteHandleMorph.prototype.drawOnCanvas =\r\n    StageHandleMorph.prototype.drawOnCanvas;\r\n\r\n// PaletteHandleMorph layout:\r\n\r\nPaletteHandleMorph.prototype.fixLayout = function () {\r\n    if (!this.target) {return; }\r\n    var ide = this.target.parentThatIsA(IDE_Morph);\r\n    this.setTop(this.target.top() + 10);\r\n    this.setRight(this.target.right());\r\n    if (ide) {ide.add(this); } // come to front\r\n};\r\n\r\n// PaletteHandleMorph stepping:\r\n\r\nPaletteHandleMorph.prototype.step = null;\r\n\r\nPaletteHandleMorph.prototype.mouseDownLeft = function (pos) {\r\n    var world = this.world(),\r\n        offset = this.right() - pos.x,\r\n        ide = this.target.parentThatIsA(IDE_Morph);\r\n\r\n    if (!this.target) {\r\n        return null;\r\n    }\r\n    this.step = function () {\r\n        var newPos;\r\n        if (world.hand.mouseButton) {\r\n            newPos = world.hand.bounds.origin.x + offset;\r\n            ide.paletteWidth = Math.min(\r\n                Math.max(200, newPos),\r\n                ide.stageHandle.left() - ide.spriteBar.tabBar.width()\r\n            );\r\n            ide.setExtent(world.extent());\r\n\r\n        } else {\r\n            this.step = null;\r\n        }\r\n    };\r\n};\r\n\r\n// PaletteHandleMorph events:\r\n\r\nPaletteHandleMorph.prototype.mouseEnter\r\n    = StageHandleMorph.prototype.mouseEnter;\r\n\r\nPaletteHandleMorph.prototype.mouseLeave\r\n    = StageHandleMorph.prototype.mouseLeave;\r\n\r\n//******************* Wiquid *********************************\r\n\r\nPaletteHandleMorph.prototype.mouseDoubleClick = function () {\r\n    \r\n    this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200); //Wiquid Solution\r\n\r\n};\r\n\r\n//************************************************************\r\n\r\n// CamSnapshotDialogMorph inherits from DialogBoxMorph:\r\n\r\nCamSnapshotDialogMorph.prototype = new DialogBoxMorph();\r\nCamSnapshotDialogMorph.prototype.constructor = CamSnapshotDialogMorph;\r\nCamSnapshotDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// CamSnapshotDialogMorph settings\r\n\r\nCamSnapshotDialogMorph.prototype.enableCamera = true; // off while experimental\r\nCamSnapshotDialogMorph.prototype.enabled = true;\r\n\r\nCamSnapshotDialogMorph.prototype.notSupportedMessage =\r\n\t'Please make sure your web browser is up to date\\n' +\r\n\t'and your camera is properly configured. \\n\\n' +\r\n\t'Some browsers also require you to access Snap!\\n' +\r\n\t'through HTTPS to use the camera.\\n\\n' +\r\n    'Plase replace the \"http://\" part of the address\\n' +\r\n    'in your browser by \"https://\" and try again.';\r\n\r\n// CamSnapshotDialogMorph instance creation\r\n\r\nfunction CamSnapshotDialogMorph(ide, sprite, onCancel, onAccept) {\r\n    this.init(ide, sprite, onCancel, onAccept);\r\n}\r\n\r\nCamSnapshotDialogMorph.prototype.init = function (\r\n    ide,\r\n    sprite,\r\n    onCancel,\r\n\tonAccept\r\n) {\r\n    this.ide = ide;\r\n    this.sprite = sprite;\r\n    this.padding = 10;\r\n    this.oncancel = onCancel;\r\n    this.accept = onAccept;\r\n    this.videoElement = null; // an HTML5 video element\r\n    this.videoView = new Morph(); // a morph where we'll copy the video contents\r\n\r\n    CamSnapshotDialogMorph.uber.init.call(this);\r\n    this.labelString = 'Camera';\r\n    this.createLabel();\r\n    this.buildContents();\r\n};\r\n\r\nCamSnapshotDialogMorph.prototype.buildContents = function () {\r\n    var myself = this,\r\n        stage = this.sprite.parentThatIsA(StageMorph);\r\n\r\n\tfunction noCameraSupport() {\r\n        myself.disable();\r\n        myself.ide.inform(\r\n            'Camera not supported',\r\n            CamSnapshotDialogMorph.prototype.notSupportedMessage\r\n        );\r\n        if (myself.videoElement) {\r\n        \tmyself.videoElement.remove();\r\n        }\r\n        myself.cancel();\r\n\t}\r\n\r\n    this.videoElement = document.createElement('video');\r\n    this.videoElement.hidden = true;\r\n    this.videoElement.width = stage.dimensions.x;\r\n    this.videoElement.height = stage.dimensions.y;\r\n\r\n    document.body.appendChild(this.videoElement);\r\n\r\n    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n        navigator.mediaDevices.getUserMedia({ video: true })\r\n            .then(function (stream) {\r\n                myself.videoElement.srcObject = stream;\r\n                myself.videoElement.play().catch(noCameraSupport);\r\n                myself.videoElement.stream = stream;\r\n            })\r\n            .catch(noCameraSupport);\r\n    }\r\n\r\n    this.videoView.setExtent(stage.dimensions);\r\n    this.videoView.image = newCanvas(stage.dimensions);\r\n\r\n    this.videoView.drawOn = function (aCanvas) {\r\n        var context = aCanvas.getContext('2d'),\r\n            videoWidth = myself.videoElement.videoWidth,\r\n            videoHeight = myself.videoElement.videoHeight,\r\n            w = stage.dimensions.x,\r\n            h = stage.dimensions.y,\r\n            clippingWidth, clippingHeight;\r\n\r\n        if (!videoWidth) { return; }\r\n\r\n        context.save();\r\n\r\n        // Flip the image so it looks like a mirror\r\n        context.translate(w, 0);\r\n        context.scale(-1, 1);\r\n\r\n        if (videoWidth / w > videoHeight / h) {\r\n            // preserve height, crop width\r\n            clippingWidth = w * (videoHeight / h);\r\n            clippingHeight = videoHeight;\r\n        } else {\r\n            // preserve width, crop height\r\n            clippingWidth = videoWidth;\r\n            clippingHeight = h * (videoWidth / w);\r\n        }\r\n\r\n        context.drawImage(\r\n            myself.videoElement,\r\n            0,\r\n            0,\r\n            clippingWidth,\r\n            clippingHeight,\r\n            this.left() * -1,\r\n            this.top(),\r\n            w,\r\n            h\r\n            );\r\n\r\n        context.restore();\r\n    };\r\n\r\n    this.videoView.step = function () {\r\n        this.changed();\r\n    };\r\n\r\n    this.addBody(new AlignmentMorph('column', this.padding / 2));\r\n    this.body.add(this.videoView);\r\n    this.body.fixLayout();\r\n\r\n    this.addButton('ok', 'Save');\r\n    this.addButton('cancel', 'Cancel');\r\n\r\n    this.fixLayout();\r\n    this.drawNew();\r\n};\r\n\r\nCamSnapshotDialogMorph.prototype.ok = function () {\r\n    this.accept(\r\n        new Costume(\r\n            this.videoView.fullImageClassic(),\r\n            this.sprite.newCostumeName('camera')\r\n        ).flipped()\r\n    );\r\n};\r\n\r\nCamSnapshotDialogMorph.prototype.disable = function () {\r\n    CamSnapshotDialogMorph.prototype.enabled = false;\r\n    document.dispatchEvent(new Event('cameraDisabled'));\r\n};\r\n\r\nCamSnapshotDialogMorph.prototype.destroy = function () {\r\n    this.oncancel.call(this);\r\n    this.close();\r\n};\r\n\r\nCamSnapshotDialogMorph.prototype.close = function () {\r\n    if (this.videoElement && this.videoElement.stream) {\r\n        this.videoElement.stream.getTracks()[0].stop();\r\n        this.videoElement.remove();\r\n    }\r\n    CamSnapshotDialogMorph.uber.destroy.call(this);\r\n};\r\n//fin de GUI.js\r\n/*\r\n    paint.js\r\n\r\n    a paint editor for Snap!\r\n    inspired by the Scratch paint editor.\r\n\r\n    written by Kartik Chandra\r\n    Copyright (C) 2016 by Kartik Chandra\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        PaintEditorMorph\r\n        PaintColorPickerMorph\r\n        PaintCanvasMorph\r\n\r\n\r\n    credits\r\n    -------\r\n    Nathan Dinsmore contributed a fully working prototype,\r\n    Nathan's brilliant flood-fill tool has been more or less\r\n    directly imported into this paint implementation.\r\n\r\n    Jens Mnig has contributed icons and bugfixes and says he has probably\r\n    introduced many other bugs in that process. :-)\r\n\r\n\r\n    revision history\r\n    ----------------\r\n    May 10 - first full release (Kartik)\r\n    May 14 - bugfixes, Snap integration (Jens)\r\n    May 16 - flat design adjustments (Jens)\r\n    July 12 - pipette tool, code formatting adjustments (Jens)\r\n    Sept 16 - flood fill freeze fix (Kartik)\r\n    Jan 08 - mouse leave dragging fix (Kartik)\r\n    Feb 11 - dynamically adjust to stage dimensions (Jens)\r\n    Apr 30 - localizations (Manuel)\r\n    June 3 - transformations (Kartik)\r\n    June 4 - tweaks (Jens)\r\n    Aug 24 - floodfill alpha-integer issue (Kartik)\r\n    Sep 29 - tweaks (Jens)\r\n    Sep 28 [of the following year :)] - Try to prevent antialiasing (Kartik)\r\n    Oct 02 - revert disable smoothing (Jens)\r\n    Dec 15 - center rotation point on costume creating (Craxic)\r\n    Jan 18 - avoid pixel collision detection in PaintCanvas (Jens)\r\n    Mar 22 - fixed automatic rotation center point mechanism (Jens)\r\n    May 10 - retina display support adjustments (Jens)\r\n    2017\r\n    April 10 - getGlobalPixelColor adjustment for Chrome & retina (Jens)\r\n*/\r\n\r\n/*global Point, Rectangle, DialogBoxMorph, AlignmentMorph, PushButtonMorph,\r\nColor, SymbolMorph, newCanvas, Morph, TextMorph, Costume, SpriteMorph, nop,\r\nlocalize, InputFieldMorph, SliderMorph, ToggleMorph, ToggleButtonMorph,\r\nBoxMorph, modules, radians, MorphicPreferences, getDocumentPositionOf,\r\nStageMorph, isNil*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.paint = '2017-April-10';\r\n\r\n// Declarations\r\n\r\nvar PaintEditorMorph;\r\nvar PaintCanvasMorph;\r\nvar PaintColorPickerMorph;\r\n\r\n// PaintEditorMorph //////////////////////////\r\n\r\n// A complete paint editor\r\n\r\nPaintEditorMorph.prototype = new DialogBoxMorph();\r\nPaintEditorMorph.prototype.constructor = PaintEditorMorph;\r\nPaintEditorMorph.uber = DialogBoxMorph.prototype;\r\n\r\nPaintEditorMorph.prototype.padding = 10;\r\n\r\nfunction PaintEditorMorph() {\r\n    this.init();\r\n}\r\n\r\nPaintEditorMorph.prototype.init = function () {\r\n    // additional properties:\r\n    this.paper = null; // paint canvas\r\n    this.oncancel = null;\r\n\r\n    // initialize inherited properties:\r\n    PaintEditorMorph.uber.init.call(this);\r\n\r\n    // override inherited properties:\r\n    this.labelString = \"Paint Editor\";\r\n    this.createLabel();\r\n\r\n    // build contents:\r\n    this.buildContents();\r\n};\r\n\r\nPaintEditorMorph.prototype.buildContents = function () {\r\n    var myself = this;\r\n\r\n    this.paper = new PaintCanvasMorph(function () {return myself.shift; });\r\n    this.paper.setExtent(StageMorph.prototype.dimensions);\r\n\r\n    this.addBody(new AlignmentMorph('row', this.padding));\r\n    this.controls = new AlignmentMorph('column', this.padding / 2);\r\n    this.controls.alignment = 'left';\r\n\r\n    this.edits = new AlignmentMorph('row', this.padding / 2);\r\n    this.buildEdits();\r\n    this.controls.add(this.edits);\r\n\r\n    this.body.color = this.color;\r\n\r\n    this.body.add(this.controls);\r\n    this.body.add(this.paper);\r\n\r\n    this.toolbox = new BoxMorph();\r\n    this.toolbox.color = SpriteMorph.prototype.paletteColor.lighter(8);\r\n    this.toolbox.borderColor = this.toolbox.color.lighter(40);\r\n    if (MorphicPreferences.isFlat) {\r\n        this.toolbox.edge = 0;\r\n    }\r\n\r\n    this.buildToolbox();\r\n    this.controls.add(this.toolbox);\r\n\r\n    this.scaleBox = new AlignmentMorph('row', this.padding / 2);\r\n    this.buildScaleBox();\r\n    this.controls.add(this.scaleBox);\r\n\r\n    this.propertiesControls = {\r\n        colorpicker: null,\r\n        penSizeSlider: null,\r\n        penSizeField: null,\r\n        primaryColorButton: null,\r\n        primaryColorViewer: null,\r\n        constrain: null\r\n    };\r\n    this.populatePropertiesMenu();\r\n\r\n    this.addButton(\"ok\", \"OK\");\r\n    this.addButton(\"cancel\", \"Cancel\");\r\n\r\n    this.refreshToolButtons();\r\n    this.fixLayout();\r\n    this.drawNew();\r\n};\r\n\r\nPaintEditorMorph.prototype.buildToolbox = function () {\r\n    var tools = {\r\n            brush:\r\n                \"Paintbrush tool\\n(free draw)\",\r\n            rectangle:\r\n                \"Stroked Rectangle\\n(shift: square)\",\r\n            circle:\r\n                \"Stroked Ellipse\\n(shift: circle)\",\r\n            eraser:\r\n                \"Eraser tool\",\r\n            crosshairs:\r\n                \"Set the rotation center\",\r\n\r\n            line:\r\n                \"Line tool\\n(shift: vertical/horizontal)\",\r\n            rectangleSolid:\r\n                \"Filled Rectangle\\n(shift: square)\",\r\n            circleSolid:\r\n                \"Filled Ellipse\\n(shift: circle)\",\r\n            paintbucket:\r\n                \"Fill a region\",\r\n            pipette:\r\n                \"Pipette tool\\n(pick a color anywhere)\"\r\n        },\r\n        myself = this,\r\n        left = this.toolbox.left(),\r\n        top = this.toolbox.top(),\r\n        padding = 2,\r\n        inset = 5,\r\n        x = 0,\r\n        y = 0;\r\n\r\n    Object.keys(tools).forEach(function (tool) {\r\n        var btn = myself.toolButton(tool, tools[tool]);\r\n        btn.setPosition(new Point(\r\n            left + x,\r\n            top + y\r\n        ));\r\n        x += btn.width() + padding;\r\n        if (tool === \"crosshairs\") {\r\n            x = 0;\r\n            y += btn.height() + padding;\r\n            myself.paper.drawcrosshair();\r\n        }\r\n        myself.toolbox[tool] = btn;\r\n        myself.toolbox.add(btn);\r\n    });\r\n\r\n    this.toolbox.bounds = this.toolbox.fullBounds().expandBy(inset * 2);\r\n    this.toolbox.drawNew();\r\n};\r\n\r\nPaintEditorMorph.prototype.buildEdits = function () {\r\n    var paper = this.paper;\r\n\r\n    this.edits.add(this.pushButton(\r\n        \"undo\",\r\n        function () {paper.undo(); }\r\n    ));\r\n\r\n    this.edits.add(this.pushButton(\r\n        \"clear\",\r\n        function () {paper.clearCanvas(); }\r\n    ));\r\n    this.edits.fixLayout();\r\n};\r\n\r\nPaintEditorMorph.prototype.buildScaleBox = function () {\r\n    var paper = this.paper;\r\n    this.scaleBox.add(this.pushButton(\r\n        \"grow\",\r\n        function () {paper.scale(0.05, 0.05); }\r\n    ));\r\n    this.scaleBox.add(this.pushButton(\r\n        \"shrink\",\r\n        function () {paper.scale(-0.05, -0.05); }\r\n    ));\r\n    this.scaleBox.add(this.pushButton(\r\n        \"flip \",\r\n        function () {paper.scale(-2, 0); }\r\n    ));\r\n    this.scaleBox.add(this.pushButton(\r\n        \"flip \",\r\n        function () {paper.scale(0, -2); }\r\n    ));\r\n    this.scaleBox.fixLayout();\r\n};\r\n\r\nPaintEditorMorph.prototype.openIn = function (world, oldim, oldrc, callback) {\r\n    // Open the editor in a world with an optional image to edit\r\n    this.oldim = oldim;\r\n    this.callback = callback || nop;\r\n\r\n    this.processKeyUp = function () {\r\n        this.shift = false;\r\n        this.propertiesControls.constrain.refresh();\r\n    };\r\n\r\n    this.processKeyDown = function () {\r\n        this.shift = this.world().currentKey === 16;\r\n        this.propertiesControls.constrain.refresh();\r\n    };\r\n\r\n    //merge oldim:\r\n    if (this.oldim) {\r\n        this.paper.automaticCrosshairs = isNil(oldrc);\r\n        this.paper.centermerge(this.oldim, this.paper.paper);\r\n        this.paper.rotationCenter =\r\n            (oldrc || new Point(0, 0)).add(\r\n                new Point(\r\n                    (this.paper.paper.width - this.oldim.width) / 2,\r\n                    (this.paper.paper.height - this.oldim.height) / 2\r\n                )\r\n            );\r\n        this.paper.drawNew();\r\n    }\r\n\r\n    this.key = 'paint';\r\n    this.popUp(world);\r\n};\r\n\r\nPaintEditorMorph.prototype.fixLayout = function () {\r\n    var oldFlag = Morph.prototype.trackChanges;\r\n\r\n    this.changed();\r\n    oldFlag = Morph.prototype.trackChanges;\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    if (this.paper) {\r\n        this.paper.buildContents();\r\n        this.paper.drawNew();\r\n    }\r\n    if (this.controls) {this.controls.fixLayout(); }\r\n    if (this.body) {this.body.fixLayout(); }\r\n    PaintEditorMorph.uber.fixLayout.call(this);\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n};\r\n\r\nPaintEditorMorph.prototype.refreshToolButtons = function () {\r\n    this.toolbox.children.forEach(function (toggle) {\r\n        toggle.refresh();\r\n    });\r\n};\r\n\r\nPaintEditorMorph.prototype.ok = function () {\r\n    this.paper.updateAutomaticCenter();\r\n    this.callback(\r\n        this.paper.paper,\r\n        this.paper.rotationCenter\r\n    );\r\n    this.destroy();\r\n};\r\n\r\nPaintEditorMorph.prototype.cancel = function () {\r\n    if (this.oncancel) {this.oncancel(); }\r\n    this.destroy();\r\n};\r\n\r\nPaintEditorMorph.prototype.populatePropertiesMenu = function () {\r\n    var c = this.controls,\r\n        myself = this,\r\n        pc = this.propertiesControls,\r\n        alpen = new AlignmentMorph(\"row\", this.padding);\r\n\r\n    pc.primaryColorViewer = new Morph();\r\n    pc.primaryColorViewer.setExtent(new Point(180, 50));\r\n    pc.primaryColorViewer.color = new Color(0, 0, 0);\r\n    pc.colorpicker = new PaintColorPickerMorph(\r\n        new Point(180, 100),\r\n        function (color) {\r\n            var ni = newCanvas(pc.primaryColorViewer.extent()),\r\n                ctx = ni.getContext(\"2d\"),\r\n                i,\r\n                j;\r\n            myself.paper.settings.primarycolor = color;\r\n            if (color === \"transparent\") {\r\n                for (i = 0; i < 180; i += 5) {\r\n                    for (j = 0; j < 15; j += 5) {\r\n                        ctx.fillStyle =\r\n                            ((j + i) / 5) % 2 === 0 ?\r\n                                            \"rgba(0, 0, 0, 0.2)\" :\r\n                                            \"rgba(0, 0, 0, 0.5)\";\r\n                        ctx.fillRect(i, j, 5, 5);\r\n\r\n                    }\r\n                }\r\n            } else {\r\n                ctx.fillStyle = color.toString();\r\n                ctx.fillRect(0, 0, 180, 15);\r\n            }\r\n            ctx.strokeStyle = \"black\";\r\n            ctx.lineWidth = Math.min(myself.paper.settings.linewidth, 20);\r\n            ctx.beginPath();\r\n            ctx.lineCap = \"round\";\r\n            ctx.moveTo(20, 30);\r\n            ctx.lineTo(160, 30);\r\n            ctx.stroke();\r\n            pc.primaryColorViewer.image = ni;\r\n            pc.primaryColorViewer.changed();\r\n        }\r\n    );\r\n    pc.colorpicker.action(new Color(0, 0, 0));\r\n\r\n    pc.penSizeSlider = new SliderMorph(0, 20, 5, 5);\r\n    pc.penSizeSlider.orientation = \"horizontal\";\r\n    pc.penSizeSlider.setHeight(15);\r\n    pc.penSizeSlider.setWidth(150);\r\n    pc.penSizeSlider.action = function (num) {\r\n        if (pc.penSizeField) {\r\n            pc.penSizeField.setContents(num);\r\n        }\r\n        myself.paper.settings.linewidth = num;\r\n        pc.colorpicker.action(myself.paper.settings.primarycolor);\r\n    };\r\n    pc.penSizeField = new InputFieldMorph(\"5\", true, null, false);\r\n    pc.penSizeField.contents().minWidth = 20;\r\n    pc.penSizeField.setWidth(25);\r\n    pc.penSizeField.accept = function () {\r\n        var val = parseFloat(pc.penSizeField.getValue());\r\n        pc.penSizeSlider.value = val;\r\n        pc.penSizeSlider.drawNew();\r\n        pc.penSizeSlider.updateValue();\r\n        this.setContents(val);\r\n        myself.paper.settings.linewidth = val;\r\n        this.world().keyboardReceiver = myself;\r\n        pc.colorpicker.action(myself.paper.settings.primarycolor);\r\n    };\r\n    alpen.add(pc.penSizeSlider);\r\n    alpen.add(pc.penSizeField);\r\n    alpen.color = myself.color;\r\n    alpen.fixLayout();\r\n    pc.penSizeField.drawNew();\r\n    pc.constrain = new ToggleMorph(\r\n        \"checkbox\",\r\n        this,\r\n        function () {myself.shift = !myself.shift; },\r\n        \"Constrain proportions of shapes?\\n(you can also hold shift)\",\r\n        function () {return myself.shift; }\r\n    );\r\n    c.add(pc.colorpicker);\r\n    //c.add(pc.primaryColorButton);\r\n    c.add(pc.primaryColorViewer);\r\n    c.add(new TextMorph(localize(\"Brush size\")));\r\n    c.add(alpen);\r\n    c.add(pc.constrain);\r\n};\r\n\r\nPaintEditorMorph.prototype.toolButton = function (icon, hint) {\r\n    var button, myself = this;\r\n\r\n    button = new ToggleButtonMorph(\r\n        null,\r\n        this,\r\n        function () { // action\r\n            myself.paper.currentTool = icon;\r\n            myself.paper.toolChanged(icon);\r\n            myself.refreshToolButtons();\r\n            if (icon === 'pipette') {\r\n                myself.getUserColor();\r\n            }\r\n        },\r\n        new SymbolMorph(icon, 18),\r\n        function () {return myself.paper.currentTool === icon; }\r\n    );\r\n\r\n    button.hint = hint;\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    return button;\r\n};\r\n\r\nPaintEditorMorph.prototype.pushButton = function (title, action, hint) {\r\n    return new PushButtonMorph(\r\n        this,\r\n        action,\r\n        title,\r\n        null,\r\n        hint\r\n    );\r\n};\r\n\r\nPaintEditorMorph.prototype.getUserColor = function () {\r\n    var myself = this,\r\n        world = this.world(),\r\n        hand = world.hand,\r\n        posInDocument = getDocumentPositionOf(world.worldCanvas),\r\n        mouseMoveBak = hand.processMouseMove,\r\n        mouseDownBak = hand.processMouseDown,\r\n        mouseUpBak = hand.processMouseUp;\r\n\r\n    hand.processMouseMove = function (event) {\r\n        var color;\r\n        hand.setPosition(new Point(\r\n            event.pageX - posInDocument.x,\r\n            event.pageY - posInDocument.y\r\n        ));\r\n        color = world.getGlobalPixelColor(hand.position());\r\n        if (!color.a) {\r\n            // ignore transparent,\r\n            // needed for retina-display support\r\n            return;\r\n        }\r\n        color.a = 255;\r\n        myself.propertiesControls.colorpicker.action(color);\r\n    };\r\n\r\n    hand.processMouseDown = nop;\r\n\r\n    hand.processMouseUp = function () {\r\n        myself.paper.currentTool = 'brush';\r\n        myself.paper.toolChanged('brush');\r\n        myself.refreshToolButtons();\r\n        hand.processMouseMove = mouseMoveBak;\r\n        hand.processMouseDown = mouseDownBak;\r\n        hand.processMouseUp = mouseUpBak;\r\n    };\r\n};\r\n\r\n// AdvancedColorPickerMorph //////////////////\r\n\r\n// A large hsl color picker\r\n\r\nPaintColorPickerMorph.prototype = new Morph();\r\nPaintColorPickerMorph.prototype.constructor = PaintColorPickerMorph;\r\nPaintColorPickerMorph.uber = Morph.prototype;\r\n\r\nfunction PaintColorPickerMorph(extent, action) {\r\n    this.init(extent, action);\r\n}\r\n\r\nPaintColorPickerMorph.prototype.init = function (extent, action) {\r\n    this.setExtent(extent || new Point(200, 100));\r\n    this.action = action || nop;\r\n    this.drawNew();\r\n};\r\n\r\nPaintColorPickerMorph.prototype.drawNew = function () {\r\n    var x = 0,\r\n        y = 0,\r\n        can = newCanvas(this.extent()),\r\n        ctx = can.getContext(\"2d\"),\r\n        colorselection,\r\n        r;\r\n    for (x = 0; x < this.width(); x += 1) {\r\n        for (y = 0; y < this.height() - 20; y += 1) {\r\n            ctx.fillStyle = \"hsl(\" +\r\n                (360 * x / this.width()) +\r\n                \",\" +\r\n                \"100%,\" +\r\n                (y * 100 / (this.height() - 20)) +\r\n                \"%)\";\r\n            ctx.fillRect(x, y, 1, 1);\r\n        }\r\n    }\r\n    for (x = 0; x < this.width(); x += 1) {\r\n        r = Math.floor(255 * x / this.width());\r\n        ctx.fillStyle = \"rgb(\" + r + \", \" + r + \", \" + r + \")\";\r\n        ctx.fillRect(x, this.height() - 20, 1, 10);\r\n    }\r\n    colorselection = [\"black\", \"white\", \"gray\"];\r\n    for (x = 0; x < colorselection.length; x += 1) {\r\n        ctx.fillStyle = colorselection[x];\r\n        ctx.fillRect(\r\n            x * this.width() / colorselection.length,\r\n            this.height() - 10,\r\n            this.width() / colorselection.length,\r\n            10\r\n        );\r\n    }\r\n    for (x = this.width() * 2 / 3; x < this.width(); x += 2) {\r\n        for (y = this.height() - 10; y < this.height(); y += 2) {\r\n            if ((x + y) / 2 % 2 === 0) {\r\n                ctx.fillStyle = \"#DDD\";\r\n                ctx.fillRect(x, y, 2, 2);\r\n            }\r\n        }\r\n    }\r\n    this.image = can;\r\n};\r\n\r\nPaintColorPickerMorph.prototype.mouseDownLeft = function (pos) {\r\n    if ((pos.subtract(this.position()).x > this.width() * 2 / 3) &&\r\n            (pos.subtract(this.position()).y > this.height() - 10)) {\r\n        this.action(\"transparent\");\r\n    } else {\r\n        this.action(this.getPixelColor(pos));\r\n    }\r\n};\r\n\r\nPaintColorPickerMorph.prototype.mouseMove =\r\n    PaintColorPickerMorph.prototype.mouseDownLeft;\r\n\r\n// PaintCanvasMorph ///////////////////////////\r\n/*\r\n    A canvas which reacts to drag events to\r\n    modify its image, based on a 'tool' property.\r\n*/\r\n\r\nPaintCanvasMorph.prototype = new Morph();\r\nPaintCanvasMorph.prototype.constructor = PaintCanvasMorph;\r\nPaintCanvasMorph.uber = Morph.prototype;\r\n\r\nfunction PaintCanvasMorph(shift) {\r\n    this.init(shift);\r\n}\r\n\r\nPaintCanvasMorph.prototype.init = function (shift) {\r\n    this.rotationCenter = new Point(240, 180);\r\n    this.dragRect = null;\r\n    this.previousDragPoint = null;\r\n    this.currentTool = \"brush\";\r\n    this.dragRect = new Rectangle();\r\n    // rectangle with origin being the starting drag position and\r\n    // corner being the current drag position\r\n    this.mask = newCanvas(this.extent(), true); // Temporary canvas\r\n    this.paper = newCanvas(this.extent(), true); // Actual canvas\r\n    this.erasermask = newCanvas(this.extent(), true); // eraser memory\r\n    this.background = newCanvas(this.extent()); // checkers\r\n    this.settings = {\r\n        \"primarycolor\": new Color(0, 0, 0, 255), // usually fill color\r\n        \"secondarycolor\": new Color(0, 0, 0, 255), // (unused)\r\n        \"linewidth\": 3 // stroke width\r\n    };\r\n    this.brushBuffer = [];\r\n    this.undoBuffer = [];\r\n    this.isShiftPressed = shift || function () {\r\n        var key = this.world().currentKey;\r\n        return (key === 16);\r\n    };\r\n    // should we calculate the center of the image ourselves,\r\n    // or use the user position\r\n    this.automaticCrosshairs = true;\r\n    this.noticesTransparentClick = true; // optimization\r\n    this.buildContents();\r\n};\r\n\r\n// Calculate the center of all the non-transparent pixels on the canvas.\r\nPaintCanvasMorph.prototype.calculateCanvasCenter = function(canvas) {\r\n    var canvasBounds = Costume.prototype.canvasBoundingBox(canvas);\r\n    if (canvasBounds === null) {\r\n        return null;\r\n    }\r\n    // Can't use canvasBounds.center(), it rounds down.\r\n    return new Point((canvasBounds.origin.x + canvasBounds.corner.x) / 2, (canvasBounds.origin.y + canvasBounds.corner.y) / 2);\r\n};\r\n\r\n// If we are in automaticCrosshairs mode, recalculate the rotationCenter.\r\nPaintCanvasMorph.prototype.updateAutomaticCenter = function () {\r\n    if (this.automaticCrosshairs) {\r\n        // Calculate this.rotationCenter from this.paper\r\n        var rotationCenter = this.calculateCanvasCenter(this.paper);\r\n        if (rotationCenter !== null) {\r\n            this.rotationCenter = rotationCenter;\r\n        }\r\n    }\r\n};\r\n\r\nPaintCanvasMorph.prototype.scale = function (x, y) {\r\n    this.updateAutomaticCenter();\r\n    this.mask = newCanvas(this.extent(), true);\r\n    var c = newCanvas(this.extent(), true);\r\n    c.getContext(\"2d\").save();\r\n    c.getContext(\"2d\").translate(\r\n        this.rotationCenter.x,\r\n        this.rotationCenter.y\r\n    );\r\n    c.getContext(\"2d\").scale(1 + x, 1 + y);\r\n    c.getContext(\"2d\").drawImage(\r\n        this.paper,\r\n        -this.rotationCenter.x,\r\n        -this.rotationCenter.y\r\n    );\r\n    c.getContext(\"2d\").restore();\r\n    this.paper = c;\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nPaintCanvasMorph.prototype.cacheUndo = function () {\r\n    var cachecan = newCanvas(this.extent(), true);\r\n    this.merge(this.paper, cachecan);\r\n    this.undoBuffer.push(cachecan);\r\n};\r\n\r\nPaintCanvasMorph.prototype.undo = function () {\r\n    if (this.undoBuffer.length > 0) {\r\n        this.paper = newCanvas(this.extent(), true);\r\n        this.mask.width = this.mask.width + 1 - 1;\r\n        this.merge(this.undoBuffer.pop(), this.paper);\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nPaintCanvasMorph.prototype.merge = function (a, b) {\r\n    b.getContext(\"2d\").drawImage(a, 0, 0);\r\n};\r\n\r\nPaintCanvasMorph.prototype.centermerge = function (a, b) {\r\n    b.getContext(\"2d\").drawImage(\r\n        a,\r\n        (b.width - a.width) / 2,\r\n        (b.height - a.height) / 2\r\n    );\r\n};\r\n\r\nPaintCanvasMorph.prototype.clearCanvas = function () {\r\n    this.buildContents();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nPaintCanvasMorph.prototype.toolChanged = function (tool) {\r\n    this.mask = newCanvas(this.extent(), true);\r\n    if (tool === \"crosshairs\") {\r\n        this.updateAutomaticCenter();\r\n        this.drawcrosshair();\r\n    }\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nPaintCanvasMorph.prototype.drawcrosshair = function (context) {\r\n    var ctx = context || this.mask.getContext(\"2d\"),\r\n        rp = this.rotationCenter;\r\n\r\n    ctx.lineWidth = 1;\r\n    ctx.strokeStyle = 'black';\r\n    ctx.clearRect(0, 0, this.mask.width, this.mask.height);\r\n\r\n    // draw crosshairs:\r\n    ctx.globalAlpha = 0.5;\r\n\r\n    // circle around center:\r\n    ctx.fillStyle = 'white';\r\n    ctx.beginPath();\r\n    ctx.arc(\r\n        rp.x,\r\n        rp.y,\r\n        20,\r\n        radians(0),\r\n        radians(360),\r\n        false\r\n    );\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    ctx.stroke();\r\n\r\n    ctx.beginPath();\r\n    ctx.arc(\r\n        rp.x,\r\n        rp.y,\r\n        10,\r\n        radians(0),\r\n        radians(360),\r\n        false\r\n    );\r\n    ctx.stroke();\r\n\r\n    // horizontal line:\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, rp.y);\r\n    ctx.lineTo(this.mask.width, rp.y);\r\n    ctx.stroke();\r\n\r\n    // vertical line:\r\n    ctx.beginPath();\r\n    ctx.moveTo(rp.x, 0);\r\n    ctx.lineTo(rp.x, this.mask.height);\r\n    ctx.stroke();\r\n\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nPaintCanvasMorph.prototype.floodfill = function (sourcepoint) {\r\n    var width = this.paper.width,\r\n        height = this.paper.height,\r\n        ctx = this.paper.getContext(\"2d\"),\r\n        img = ctx.getImageData(0, 0, width, height),\r\n        data = img.data,\r\n        stack = [Math.round(Math.round(sourcepoint.y) * width + sourcepoint.x)],\r\n        currentpoint,\r\n        read,\r\n        sourcecolor,\r\n        checkpoint;\r\n    read = function (p) {\r\n        var d = p * 4;\r\n        return [data[d], data[d + 1], data[d + 2], data[d + 3]];\r\n    };\r\n    sourcecolor = read(stack[0]);\r\n    checkpoint = function (p) {\r\n        return p[0] === sourcecolor[0] &&\r\n            p[1] === sourcecolor[1] &&\r\n            p[2] === sourcecolor[2] &&\r\n            p[3] === sourcecolor[3];\r\n    };\r\n\r\n    // if already filled, abort\r\n    if (sourcecolor[3] === 0 &&\r\n            this.settings.primarycolor === \"transparent\") {\r\n        return;\r\n    }\r\n    if (sourcecolor[0] === this.settings.primarycolor.r &&\r\n            sourcecolor[1] === this.settings.primarycolor.g &&\r\n            sourcecolor[2] === this.settings.primarycolor.b &&\r\n            sourcecolor[3] === this.settings.primarycolor.a) {\r\n        return;\r\n    }\r\n    if (sourcecolor[3] === 0 && this.settings.primarycolor.a === 0) {\r\n        return;\r\n    }\r\n\r\n    while (stack.length > 0) {\r\n        currentpoint = stack.pop();\r\n        if (checkpoint(read(currentpoint))) {\r\n            if (currentpoint % width > 1) {\r\n                stack.push(currentpoint + 1);\r\n                stack.push(currentpoint - 1);\r\n            }\r\n            if (currentpoint > 0 && currentpoint < height * width) {\r\n                stack.push(currentpoint + width);\r\n                stack.push(currentpoint - width);\r\n            }\r\n        }\r\n        if (this.settings.primarycolor === \"transparent\") {\r\n            data[currentpoint * 4 + 3] = 0;\r\n        } else {\r\n            data[currentpoint * 4] = this.settings.primarycolor.r;\r\n            data[currentpoint * 4 + 1] = this.settings.primarycolor.g;\r\n            data[currentpoint * 4 + 2] = this.settings.primarycolor.b;\r\n            data[currentpoint * 4 + 3] = this.settings.primarycolor.a * 255;\r\n        }\r\n    }\r\n    ctx.putImageData(img, 0, 0);\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nPaintCanvasMorph.prototype.mouseDownLeft = function (pos) {\r\n    this.cacheUndo();\r\n    this.dragRect.origin = pos.subtract(this.bounds.origin);\r\n    this.dragRect.corner = pos.subtract(this.bounds.origin);\r\n    this.previousDragPoint = this.dragRect.corner.copy();\r\n    if (this.currentTool === 'crosshairs') {\r\n        this.rotationCenter = pos.subtract(this.bounds.origin);\r\n        this.drawcrosshair();\r\n        return;\r\n    }\r\n    if (this.currentTool === \"paintbucket\") {\r\n        return this.floodfill(pos.subtract(this.bounds.origin));\r\n    }\r\n    if (this.settings.primarycolor === \"transparent\" &&\r\n            this.currentTool !== \"crosshairs\") {\r\n        this.erasermask = newCanvas(this.extent(), true);\r\n        this.merge(this.paper, this.erasermask);\r\n    }\r\n};\r\n\r\nPaintCanvasMorph.prototype.mouseMove = function (pos) {\r\n    if (this.currentTool === \"paintbucket\") {\r\n        return;\r\n    }\r\n\r\n    var relpos = pos.subtract(this.bounds.origin),\r\n        mctx = this.mask.getContext(\"2d\"),\r\n        pctx = this.paper.getContext(\"2d\"),\r\n        x = this.dragRect.origin.x, // original drag X\r\n        y = this.dragRect.origin.y, // original drag y\r\n        p = relpos.x,               // current drag x\r\n        q = relpos.y,               // current drag y\r\n        w = (p - x) / 2,            // half the rect width\r\n        h = (q - y) / 2,            // half the rect height\r\n        i,                          // iterator number\r\n        width = this.paper.width;\r\n\r\n    mctx.save();\r\n    function newW() {\r\n        return Math.max(Math.abs(w), Math.abs(h)) * (w / Math.abs(w));\r\n    }\r\n    function newH() {\r\n        return Math.max(Math.abs(w), Math.abs(h)) * (h / Math.abs(h));\r\n    }\r\n    this.brushBuffer.push([p, q]);\r\n    mctx.lineWidth = this.settings.linewidth;\r\n    mctx.clearRect(0, 0, this.bounds.width(), this.bounds.height()); // mask\r\n\r\n    this.dragRect.corner = relpos.subtract(this.dragRect.origin); // reset crn\r\n\r\n    if (this.settings.primarycolor === \"transparent\" &&\r\n            this.currentTool !== \"crosshairs\") {\r\n        this.merge(this.erasermask, this.mask);\r\n        pctx.clearRect(0, 0, this.bounds.width(), this.bounds.height());\r\n        mctx.globalCompositeOperation = \"destination-out\";\r\n    } else {\r\n        mctx.fillStyle = this.settings.primarycolor.toString();\r\n        mctx.strokeStyle = this.settings.primarycolor.toString();\r\n    }\r\n    switch (this.currentTool) {\r\n    case \"rectangle\":\r\n        if (this.isShiftPressed()) {\r\n            mctx.strokeRect(x, y, newW() * 2, newH() * 2);\r\n        } else {\r\n            mctx.strokeRect(x, y, w * 2, h * 2);\r\n        }\r\n        break;\r\n    case \"rectangleSolid\":\r\n        if (this.isShiftPressed()) {\r\n            mctx.fillRect(x, y, newW() * 2, newH() * 2);\r\n        } else {\r\n            mctx.fillRect(x, y, w * 2, h * 2);\r\n        }\r\n        break;\r\n    case \"brush\":\r\n        mctx.lineCap = \"round\";\r\n        mctx.lineJoin = \"round\";\r\n        mctx.beginPath();\r\n        mctx.moveTo(this.brushBuffer[0][0], this.brushBuffer[0][1]);\r\n        for (i = 0; i < this.brushBuffer.length; i += 1) {\r\n            mctx.lineTo(this.brushBuffer[i][0], this.brushBuffer[i][1]);\r\n        }\r\n        mctx.stroke();\r\n        break;\r\n    case \"line\":\r\n        mctx.beginPath();\r\n        mctx.moveTo(x, y);\r\n        if (this.isShiftPressed()) {\r\n            if (Math.abs(h) > Math.abs(w)) {\r\n                mctx.lineTo(x, q);\r\n            } else {\r\n                mctx.lineTo(p, y);\r\n            }\r\n        } else {\r\n            mctx.lineTo(p, q);\r\n        }\r\n        mctx.stroke();\r\n        break;\r\n    case \"circle\":\r\n    case \"circleSolid\":\r\n        mctx.beginPath();\r\n        if (this.isShiftPressed()) {\r\n            mctx.arc(\r\n                x,\r\n                y,\r\n                new Point(x, y).distanceTo(new Point(p, q)),\r\n                0,\r\n                Math.PI * 2,\r\n                false\r\n            );\r\n        } else {\r\n            for (i = 0; i < width; i += 1) {\r\n                mctx.lineTo(\r\n                    i,\r\n                    (2 * h) * Math.sqrt(2 - Math.pow(\r\n                        (i - x) / (2 * w),\r\n                        2\r\n                    )) + y\r\n                );\r\n            }\r\n            for (i = width; i > 0; i -= 1) {\r\n                mctx.lineTo(\r\n                    i,\r\n                    -1 * (2 * h) * Math.sqrt(2 - Math.pow(\r\n                        (i - x) / (2 * w),\r\n                        2\r\n                    )) + y\r\n                );\r\n            }\r\n        }\r\n        mctx.closePath();\r\n        if (this.currentTool === \"circleSolid\") {\r\n            mctx.fill();\r\n        } else {\r\n            if (this.currentTool === \"circle\") {\r\n                mctx.stroke();\r\n            }\r\n        }\r\n        break;\r\n    case \"crosshairs\":\r\n        // Disable automatic crosshairs: user has now chosen where they should be.\r\n        this.automaticCrosshairs = false;\r\n        this.rotationCenter = relpos.copy();\r\n        this.drawcrosshair(mctx);\r\n        break;\r\n    case \"eraser\":\r\n        this.merge(this.paper, this.mask);\r\n        mctx.save();\r\n        mctx.globalCompositeOperation = \"destination-out\";\r\n        mctx.beginPath();\r\n        mctx.moveTo(this.brushBuffer[0][0], this.brushBuffer[0][1]);\r\n        for (i = 0; i < this.brushBuffer.length; i += 1) {\r\n            mctx.lineTo(this.brushBuffer[i][0], this.brushBuffer[i][1]);\r\n        }\r\n        mctx.stroke();\r\n        mctx.restore();\r\n        this.paper = newCanvas(this.extent(), true);\r\n        this.merge(this.mask, this.paper);\r\n        break;\r\n    default:\r\n        nop();\r\n    }\r\n    this.previousDragPoint = relpos;\r\n    this.drawNew();\r\n    this.changed();\r\n    mctx.restore();\r\n};\r\n\r\nPaintCanvasMorph.prototype.mouseClickLeft = function () {\r\n    if (this.currentTool !== \"crosshairs\") {\r\n        this.merge(this.mask, this.paper);\r\n    }\r\n    this.brushBuffer = [];\r\n};\r\n\r\nPaintCanvasMorph.prototype.mouseLeaveDragging\r\n    = PaintCanvasMorph.prototype.mouseClickLeft;\r\n\r\nPaintCanvasMorph.prototype.buildContents = function () {\r\n    this.background = newCanvas(this.extent());\r\n    this.paper = newCanvas(this.extent(), true);\r\n    this.mask = newCanvas(this.extent(), true);\r\n    this.erasermask = newCanvas(this.extent(), true);\r\n    var i, j, bkctx = this.background.getContext(\"2d\");\r\n    for (i = 0; i < this.background.width; i += 5) {\r\n        for (j = 0; j < this.background.height; j += 5) {\r\n            if ((i + j) / 5 % 2 === 1) {\r\n                bkctx.fillStyle = \"rgba(255, 255, 255, 1)\";\r\n            } else {\r\n                bkctx.fillStyle = \"rgba(255, 255, 255, 0.3)\";\r\n            }\r\n            bkctx.fillRect(i, j, 5, 5);\r\n        }\r\n    }\r\n};\r\n\r\nPaintCanvasMorph.prototype.drawNew = function () {\r\n    var can = newCanvas(this.extent(), true);\r\n    this.merge(this.background, can);\r\n    this.merge(this.paper, can);\r\n    this.merge(this.mask, can);\r\n    this.image = can;\r\n    this.drawFrame();\r\n};\r\n\r\nPaintCanvasMorph.prototype.drawFrame = function () {\r\n    var context, borderColor;\r\n\r\n    context = this.image.getContext('2d');\r\n    if (this.parent) {\r\n        this.color = this.parent.color.lighter(this.contrast * 0.75);\r\n        borderColor = this.parent.color;\r\n    } else {\r\n        borderColor = new Color(120, 120, 120);\r\n    }\r\n    context.fillStyle = this.color.toString();\r\n\r\n    // cache my border colors\r\n    this.cachedClr = borderColor.toString();\r\n    this.cachedClrBright = borderColor.lighter(this.contrast)\r\n        .toString();\r\n    this.cachedClrDark = borderColor.darker(this.contrast).toString();\r\n    this.drawRectBorder(context);\r\n};\r\n\r\nPaintCanvasMorph.prototype.drawRectBorder\r\n    = InputFieldMorph.prototype.drawRectBorder;\r\n\r\nPaintCanvasMorph.prototype.edge\r\n    = InputFieldMorph.prototype.edge;\r\n\r\nPaintCanvasMorph.prototype.fontSize\r\n    = InputFieldMorph.prototype.fontSize;\r\n\r\nPaintCanvasMorph.prototype.typeInPadding\r\n    = InputFieldMorph.prototype.typeInPadding;\r\n\r\nPaintCanvasMorph.prototype.contrast\r\n    = InputFieldMorph.prototype.contrast;\r\n//fin de paint.js\r\n/*\r\n\r\n    lists.js\r\n\r\n    list data structure and GUI for SNAP!\r\n\r\n    written by Jens Mnig and Brian Harvey\r\n    jens@moenig.org, bh@cs.berkeley.edu\r\n\r\n    Copyright (C) 2017 by Jens Mnig and Brian Harvey\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js, widgets.js and gui.js\r\n\r\n\r\n    I. hierarchy\r\n    -------------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n    List\r\n\r\n    BoxMorph*\r\n        ListWatcherMorph\r\n\r\n    * from Morphic.js\r\n\r\n\r\n    II. toc\r\n    -------\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n    List\r\n    ListWatcherMorph\r\n\r\n*/\r\n\r\n// Global settings /////////////////////////////////////////////////////\r\n\r\n/*global modules, BoxMorph, HandleMorph, PushButtonMorph, SyntaxElementMorph,\r\nColor, Point, WatcherMorph, StringMorph, SpriteMorph, ScrollFrameMorph,\r\nCellMorph, ArrowMorph, MenuMorph, snapEquals, Morph, isNil, localize,\r\nMorphicPreferences, TableDialogMorph, SpriteBubbleMorph, SpeechBubbleMorph,\r\nTableFrameMorph, TableMorph, Variable, isSnapObject*/\r\n\r\nmodules.lists = '2017-September-01';\r\n\r\nvar List;\r\nvar ListWatcherMorph;\r\n\r\n// List ////////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a dynamic array data structure for SNAP!\r\n    My index starts with 1\r\n\r\n    I am a \"smart\" hybrid list, because I can be used as both a linked\r\n    list and as a dynamic array\r\n\r\n    public interface:\r\n\r\n    setters (linked):\r\n    -----------------\r\n    cons                - answer a new list with the given item in front\r\n    cdr                    - answer all but the first element\r\n\r\n    setters (arrayed):\r\n    ------------------\r\n    add(element, index)    - insert the element before the given slot,\r\n    put(element, index)    - overwrite the element at the given slot\r\n    remove(index)        - remove the given slot, shortening the list\r\n    clear()                - remove all elements\r\n\r\n    getters (all hybrid):\r\n    ---------------------\r\n    length()            - number of slots\r\n    at(index)            - element present in specified slot\r\n    contains(element)    - <bool>\r\n\r\n    conversion:\r\n    -----------\r\n    asArray()            - answer me as JavaScript array\r\n    asText()            - answer my elements (recursively) concatenated\r\n*/\r\n\r\n// List instance creation:\r\n\r\nfunction List(array) {\r\n    this.type = null; // for UI lists, such as costumes, sounds, sprites\r\n    this.contents = array || [];\r\n    this.first = null;\r\n    this.rest = null;\r\n    this.isLinked = false;\r\n    this.lastChanged = Date.now();\r\n}\r\n\r\n// List global preferences\r\n\r\nList.prototype.enableTables = false; // default, to not confuse NYC teachers\r\n\r\n// List printing\r\n\r\nList.prototype.toString = function () {\r\n    return 'a List [' + this.length + ' elements]';\r\n};\r\n\r\n// List updating:\r\n\r\nList.prototype.changed = function () {\r\n    this.lastChanged = Date.now();\r\n};\r\n\r\n// Linked List ops:\r\n\r\nList.prototype.cons = function (car, cdr) {\r\n    var answer = new List();\r\n    if (!(cdr instanceof List || isNil(cdr))) {\r\n        throw new Error(\"cdr isn't a list: \" + cdr);\r\n    }\r\n    answer.first = isNil(car) ? null : car;\r\n    answer.rest = cdr || null;\r\n    answer.isLinked = true;\r\n    return answer;\r\n};\r\n\r\nList.prototype.cdr = function () {\r\n    var result, i;\r\n    if (this.isLinked) {\r\n        return this.rest || new List();\r\n    }\r\n    if (this.contents.length < 2) {\r\n        return new List();\r\n    }\r\n\r\n    result = new List();\r\n    for (i = this.contents.length; i > 1; i -= 1) {\r\n        result = this.cons(this.at(i), result);\r\n    }\r\n    return result;\r\n};\r\n\r\n// List array setters:\r\n\r\nList.prototype.add = function (element, index) {\r\n/*\r\n    insert the element before the given slot index,\r\n    if no index is specifed, append the element\r\n*/\r\n    var idx = index || this.length() + 1,\r\n        obj = isNil(element) ? null : element;\r\n\r\n    this.becomeArray();\r\n    this.contents.splice(idx - 1, 0, obj);\r\n    this.changed();\r\n};\r\n\r\nList.prototype.put = function (element, index) {\r\n    // exchange the element at the given slot for another\r\n    var data = element === 0 ? 0\r\n            : element === false ? false\r\n                    : element || null;\r\n\r\n    this.becomeArray();\r\n    this.contents[index - 1] = data;\r\n    this.changed();\r\n};\r\n\r\nList.prototype.remove = function (index) {\r\n    // remove the given slot, shortening the list\r\n    this.becomeArray();\r\n    this.contents.splice(index - 1, 1);\r\n    this.changed();\r\n};\r\n\r\nList.prototype.clear = function () {\r\n    this.contents = [];\r\n    this.first = null;\r\n    this.rest = null;\r\n    this.isLinked = false;\r\n    this.changed();\r\n};\r\n\r\n// List getters (all hybrid):\r\n\r\nList.prototype.length = function () {\r\n    if (this.isLinked) {\r\n        var pair = this,\r\n            result = 0;\r\n        while (pair && pair.isLinked) {\r\n            result += 1;\r\n            pair = pair.rest;\r\n        }\r\n        return result + (pair ? pair.contents.length : 0);\r\n    }\r\n    return this.contents.length;\r\n};\r\n\r\nList.prototype.at = function (index) {\r\n    var value, idx = +index, pair = this;\r\n    while (pair.isLinked) {\r\n        if (idx > 1) {\r\n            pair = pair.rest;\r\n            idx -= 1;\r\n        } else {\r\n            return pair.first;\r\n        }\r\n    }\r\n    value = pair.contents[idx - 1];\r\n    return isNil(value) ? '' : value;\r\n};\r\n\r\nList.prototype.contains = function (element) {\r\n    var pair = this;\r\n    while (pair.isLinked) {\r\n        if (snapEquals(pair.first, element)) {\r\n            return true;\r\n        }\r\n        pair = pair.rest;\r\n    }\r\n    // in case I'm arrayed\r\n    return pair.contents.some(function (any) {\r\n        return snapEquals(any, element);\r\n    });\r\n};\r\n\r\n// List table (2D) accessing (for table morph widget):\r\n\r\nList.prototype.isTable = function () {\r\n    return this.enableTables && (this.length() > 100 || this.cols() > 1);\r\n};\r\n\r\nList.prototype.get = function (col, row) {\r\n    var r, len, cols;\r\n    if (!col) {\r\n        if (!row) {return [this.length()]; }\r\n        if (row > this.rows()) {return null; }\r\n        return this.rowName(row);\r\n    } else if (!row) {\r\n        if (this.cols() === 1) {return localize('items'); }\r\n        return this.colName(col);\r\n    }\r\n    r = this.at(row);\r\n\r\n    // encode \"orphaned\" as arrays and overshooting ones as Variables\r\n    if (r instanceof List) {\r\n        len = r.length();\r\n        cols = this.cols();\r\n        if (col > len) {\r\n            return null;\r\n        } else if (cols === 1 && len > 1) {\r\n            return [r];\r\n        } else if (col >= cols && len > cols) { // overshooting\r\n            return new Variable(r.at(col));\r\n        }\r\n        return r.at(col);\r\n    }\r\n    if (col === 1 && row <= this.rows()) {\r\n        return [r];\r\n    }\r\n    return null;\r\n};\r\n\r\nList.prototype.rows = function () {\r\n    return this.length();\r\n};\r\n\r\nList.prototype.cols = function () {\r\n    var r = (this.at(1));\r\n    return r instanceof List ? r.length() : 1;\r\n};\r\n\r\nList.prototype.colName = function (col) {\r\n    if (col > this.cols()) {return null; }\r\n    return String.fromCharCode(64 + ((col % 26) || 26)).repeat(\r\n        Math.floor((col - 1) / 26) + 1\r\n    );\r\n};\r\n\r\nList.prototype.rowName = function (row) {\r\n    return row;\r\n};\r\n\r\nList.prototype.columnNames = function () {\r\n    return [];\r\n};\r\n\r\nList.prototype.version = function (startRow, rows) {\r\n    var l = Math.min(startRow + rows, this.length()),\r\n        v = this.lastChanged,\r\n        r,\r\n        i;\r\n    for (i = startRow; i <= l; i += 1) {\r\n        r = this.at(i);\r\n        v = Math.max(v, r.lastChanged ? r.lastChanged : 0);\r\n    }\r\n    return v;\r\n};\r\n\r\n// List conversion:\r\n\r\nList.prototype.asArray = function () {\r\n    // for use in the evaluator\r\n    this.becomeArray();\r\n    return this.contents;\r\n};\r\n\r\nList.prototype.itemsArray = function () {\r\n    // answer an array containing my elements\r\n    // don't convert linked lists to arrays\r\n    if (this.isLinked) {\r\n        var next = this,\r\n            result = [],\r\n            i;\r\n        while (next && next.isLinked) {\r\n            result.push(next.first);\r\n            next = next.rest;\r\n        }\r\n        if (next) {\r\n            for (i = 1; i <= next.contents.length; i += 1) {\r\n                result.push(next.at(i));\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n    return this.contents;\r\n};\r\n\r\nList.prototype.asText = function () {\r\n    var result = '',\r\n        length,\r\n        element,\r\n        pair = this,\r\n        i;\r\n    while (pair.isLinked) {\r\n        element = pair.first;\r\n        if (element instanceof List) {\r\n            result = result.concat(element.asText());\r\n        } else {\r\n            element = isNil(element) ? '' : element.toString();\r\n            result = result.concat(element);\r\n        }\r\n        pair = pair.rest;\r\n    }\r\n    length = pair.length();\r\n    for (i = 1; i <= length; i += 1) {\r\n        element = pair.at(i);\r\n        if (element instanceof List) {\r\n            result = result.concat(element.asText());\r\n        } else {\r\n            element = isNil(element) ? '' : element.toString();\r\n            result = result.concat(element);\r\n        }\r\n    }\r\n    return result;\r\n};\r\n\r\nList.prototype.becomeArray = function () {\r\n    if (this.isLinked) {\r\n        this.contents = this.itemsArray();\r\n        this.isLinked = false;\r\n        this.first = null;\r\n        this.rest = null;\r\n    }\r\n};\r\n\r\nList.prototype.becomeLinked = function () {\r\n    var i, stop, tail = this;\r\n    if (!this.isLinked) {\r\n        stop = this.length();\r\n        for (i = 0; i < stop; i += 1) {\r\n            tail.first = this.contents[i];\r\n            if (i < (stop - 1)) {\r\n                tail.rest = new List();\r\n                tail.isLinked = true;\r\n                tail = tail.rest;\r\n            }\r\n        }\r\n        this.contents = [];\r\n        this.isLinked = true;\r\n    }\r\n};\r\n\r\n// List testing\r\n\r\nList.prototype.equalTo = function (other) {\r\n    var myself = this, it = other, i, j, loopcount;\r\n    if (!(other instanceof List)) {\r\n        return false;\r\n    }\r\n\r\n    while (myself.isLinked && it.isLinked) {\r\n        if (!snapEquals(myself.first, it.first)) {\r\n            return false;\r\n        }\r\n        myself = myself.rest;\r\n        it = it.rest;\r\n    }\r\n\r\n    if (it.isLinked) {\r\n        i = it;\r\n        it = myself;\r\n        myself = i;\r\n    }\r\n\r\n    j = 0;\r\n    while (myself.isLinked) {\r\n        if (!snapEquals(myself.first, it.contents[j])) {\r\n            return false;\r\n        }\r\n        myself = myself.rest;\r\n        j += 1;\r\n    }\r\n\r\n    i = 0;\r\n    if (myself.contents.length !== (it.contents.length - j)) {\r\n        return false;\r\n    }\r\n\r\n    loopcount = myself.contents.length;\r\n    while (loopcount > 0) {\r\n        loopcount -= 1;\r\n        if (!snapEquals(myself.contents[i], it.contents[j])) {\r\n            return false;\r\n        }\r\n        i += 1;\r\n        j += 1;\r\n    }\r\n    return true;\r\n};\r\n\r\n// ListWatcherMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a little window which observes a list and continuously\r\n    updates itself accordingly\r\n*/\r\n\r\n// ListWatcherMorph inherits from BoxMorph:\r\n\r\nListWatcherMorph.prototype = new BoxMorph();\r\nListWatcherMorph.prototype.constructor = ListWatcherMorph;\r\nListWatcherMorph.uber = BoxMorph.prototype;\r\n\r\n// ListWatcherMorph default settings\r\n\r\nListWatcherMorph.prototype.cellColor =\r\n    SpriteMorph.prototype.blockColor.lists;\r\n\r\n// ListWatcherMorph instance creation:\r\n\r\nfunction ListWatcherMorph(list, parentCell) {\r\n    this.init(list, parentCell);\r\n}\r\n\r\nListWatcherMorph.prototype.init = function (list, parentCell) {\r\n    var myself = this;\r\n\r\n    this.list = list || new List();\r\n    this.start = 1;\r\n    this.range = 100;\r\n    this.lastUpdated = Date.now();\r\n    this.lastCell = null;\r\n    this.parentCell = parentCell || null; // for circularity detection\r\n\r\n    // elements declarations\r\n    this.label = new StringMorph(\r\n        localize('length: ') + this.list.length(),\r\n        SyntaxElementMorph.prototype.fontSize,\r\n        null,\r\n        false,\r\n        false,\r\n        false,\r\n        MorphicPreferences.isFlat ? new Point() : new Point(1, 1),\r\n        new Color(255, 255, 255)\r\n    );\r\n    this.label.mouseClickLeft = function () {myself.startIndexMenu(); };\r\n\r\n\r\n    this.frame = new ScrollFrameMorph(null, 10);\r\n    this.frame.alpha = 0;\r\n    this.frame.acceptsDrops = false;\r\n    this.frame.contents.acceptsDrops = false;\r\n\r\n    this.handle = new HandleMorph(\r\n        this,\r\n        80,\r\n        70,\r\n        3,\r\n        3\r\n    );\r\n    this.handle.setExtent(new Point(13, 13));\r\n\r\n    this.arrow = new ArrowMorph(\r\n        'down',\r\n        SyntaxElementMorph.prototype.fontSize\r\n    );\r\n    this.arrow.mouseClickLeft = function () {myself.startIndexMenu(); };\r\n    this.arrow.setRight(this.handle.right());\r\n    this.arrow.setBottom(this.handle.top());\r\n    this.handle.add(this.arrow);\r\n\r\n    this.plusButton = new PushButtonMorph(\r\n        this.list,\r\n        'add',\r\n        '+'\r\n    );\r\n    this.plusButton.padding = 0;\r\n    this.plusButton.edge = 0;\r\n    this.plusButton.outlineColor = this.color;\r\n    this.plusButton.drawNew();\r\n    this.plusButton.fixLayout();\r\n\r\n    ListWatcherMorph.uber.init.call(\r\n        this,\r\n        SyntaxElementMorph.prototype.rounding,\r\n        1.000001, // shadow bug in Chrome,\r\n        new Color(120, 120, 120)\r\n    );\r\n\r\n    this.color = new Color(220, 220, 220);\r\n    this.isDraggable = false;\r\n    this.setExtent(new Point(80, 70).multiplyBy(\r\n        SyntaxElementMorph.prototype.scale\r\n    ));\r\n    this.add(this.label);\r\n    this.add(this.frame);\r\n    this.add(this.plusButton);\r\n    this.add(this.handle);\r\n    this.handle.drawNew();\r\n    this.update();\r\n    this.fixLayout();\r\n};\r\n\r\n// ListWatcherMorph updating:\r\n\r\nListWatcherMorph.prototype.update = function (anyway) {\r\n    var i, idx, ceil, morphs, cell, cnts, label, button, max,\r\n        starttime, maxtime = 1000;\r\n\r\n    this.frame.contents.children.forEach(function (m) {\r\n        if (m instanceof CellMorph) {\r\n            if (m.contentsMorph instanceof ListWatcherMorph) {\r\n                m.contentsMorph.update();\r\n            } else if (isSnapObject(m.contents)) {\r\n                m.update();\r\n            }\r\n        }\r\n    });\r\n\r\n    if (this.lastUpdated === this.list.lastChanged && !anyway) {\r\n        return null;\r\n    }\r\n\r\n    this.updateLength(true);\r\n\r\n    // adjust start index to current list length\r\n    this.start = Math.max(\r\n        Math.min(\r\n            this.start,\r\n            Math.floor((this.list.length() - 1) / this.range)\r\n                * this.range + 1\r\n        ),\r\n        1\r\n    );\r\n\r\n    // refresh existing cells\r\n    // highest index shown:\r\n    max = Math.min(\r\n        this.start + this.range - 1,\r\n        this.list.length()\r\n    );\r\n\r\n    // number of morphs available for refreshing\r\n    ceil = Math.min(\r\n        (max - this.start + 1) * 3,\r\n        this.frame.contents.children.length\r\n    );\r\n\r\n    for (i = 0; i < ceil; i += 3) {\r\n        idx = this.start + (i / 3);\r\n\r\n        cell = this.frame.contents.children[i];\r\n        label = this.frame.contents.children[i + 1];\r\n        button = this.frame.contents.children[i + 2];\r\n        cnts = this.list.at(idx);\r\n\r\n        if (cell.contents !== cnts) {\r\n            cell.contents = cnts;\r\n            cell.drawNew();\r\n            if (this.lastCell) {\r\n                cell.setLeft(this.lastCell.left());\r\n            }\r\n        }\r\n        this.lastCell = cell;\r\n\r\n        if (label.text !== idx.toString()) {\r\n            label.text = idx.toString();\r\n            label.drawNew();\r\n        }\r\n\r\n        button.action = idx;\r\n    }\r\n\r\n    // remove excess cells\r\n    // number of morphs to be shown\r\n    morphs = (max - this.start + 1) * 3;\r\n\r\n    while (this.frame.contents.children.length > morphs) {\r\n        this.frame.contents.children[morphs].destroy();\r\n    }\r\n\r\n    // add additional cells\r\n    ceil = morphs; //max * 3;\r\n    i = this.frame.contents.children.length;\r\n\r\n    starttime = Date.now();\r\n    if (ceil > i + 1) {\r\n        for (i; i < ceil; i += 3) {\r\n            if (Date.now() - starttime > maxtime) {\r\n                this.fixLayout();\r\n                this.frame.contents.adjustBounds();\r\n                this.frame.contents.setLeft(this.frame.left());\r\n                return null;\r\n            }\r\n            idx = this.start + (i / 3);\r\n            label = new StringMorph(\r\n                idx.toString(),\r\n                SyntaxElementMorph.prototype.fontSize,\r\n                null,\r\n                false,\r\n                false,\r\n                false,\r\n                MorphicPreferences.isFlat ? new Point() : new Point(1, 1),\r\n                new Color(255, 255, 255)\r\n            );\r\n            cell = new CellMorph(\r\n                this.list.at(idx),\r\n                this.cellColor,\r\n                idx,\r\n                this.parentCell\r\n            );\r\n            button = new PushButtonMorph(\r\n                this.list.remove,\r\n                idx,\r\n                '-',\r\n                this.list\r\n            );\r\n            button.padding = 1;\r\n            button.edge = 0;\r\n            button.corner = 1;\r\n            button.outlineColor = this.color.darker();\r\n            button.drawNew();\r\n            button.fixLayout();\r\n\r\n            this.frame.contents.add(cell);\r\n            if (this.lastCell) {\r\n                cell.setPosition(this.lastCell.bottomLeft());\r\n            } else {\r\n                cell.setTop(this.frame.contents.top());\r\n            }\r\n            this.lastCell = cell;\r\n            label.setCenter(cell.center());\r\n            label.setRight(cell.left() - 2);\r\n            this.frame.contents.add(label);\r\n            this.frame.contents.add(button);\r\n        }\r\n    }\r\n    this.lastCell = null;\r\n\r\n    this.fixLayout();\r\n    this.frame.contents.adjustBounds();\r\n    this.frame.contents.setLeft(this.frame.left());\r\n    this.updateLength();\r\n    this.lastUpdated = this.list.lastChanged;\r\n};\r\n\r\nListWatcherMorph.prototype.updateLength = function (notDone) {\r\n    this.label.text = localize('length: ') + this.list.length();\r\n    if (notDone) {\r\n        this.label.color = new Color(0, 0, 100);\r\n    } else {\r\n        this.label.color = new Color(0, 0, 0);\r\n    }\r\n    this.label.drawNew();\r\n    this.label.setCenter(this.center());\r\n    this.label.setBottom(this.bottom() - 3);\r\n};\r\n\r\nListWatcherMorph.prototype.startIndexMenu = function () {\r\n    var i,\r\n        range,\r\n        myself = this,\r\n        items = Math.ceil(this.list.length() / this.range),\r\n        menu = new MenuMorph(\r\n            function (idx) {myself.setStartIndex(idx); },\r\n            null,\r\n            myself\r\n        );\r\n    menu.addItem('1...', 1);\r\n    for (i = 1; i < items; i += 1) {\r\n        range = i * 100 + 1;\r\n        menu.addItem(range + '...', range);\r\n    }\r\n    menu.popUpAtHand(this.world());\r\n};\r\n\r\nListWatcherMorph.prototype.setStartIndex = function (index) {\r\n    this.start = index;\r\n    this.list.changed();\r\n};\r\n\r\nListWatcherMorph.prototype.fixLayout = function () {\r\n    if (!this.label) {return; }\r\n    Morph.prototype.trackChanges = false;\r\n    if (this.frame) {\r\n        this.arrangeCells();\r\n        this.frame.silentSetPosition(this.position().add(3));\r\n        this.frame.bounds.corner = this.bounds.corner.subtract(new Point(\r\n            3,\r\n            17\r\n        ));\r\n        this.frame.drawNew();\r\n        this.frame.contents.adjustBounds();\r\n    }\r\n\r\n    this.label.setCenter(this.center());\r\n    this.label.setBottom(this.bottom() - 3);\r\n    this.plusButton.setLeft(this.left() + 3);\r\n    this.plusButton.setBottom(this.bottom() - 3);\r\n\r\n    Morph.prototype.trackChanges = true;\r\n    this.changed();\r\n\r\n    if (this.parent && this.parent.fixLayout) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\nListWatcherMorph.prototype.arrangeCells = function () {\r\n    var i, cell, label, button, lastCell,\r\n        end = this.frame.contents.children.length;\r\n    for (i = 0; i < end; i += 3) {\r\n        cell = this.frame.contents.children[i];\r\n        label = this.frame.contents.children[i + 1];\r\n        button = this.frame.contents.children[i + 2];\r\n        if (lastCell) {\r\n            cell.setTop(lastCell.bottom());\r\n        }\r\n        if (label) {\r\n            label.setTop(cell.center().y - label.height() / 2);\r\n            label.setRight(cell.left() - 2);\r\n        }\r\n        if (button) {\r\n            button.setCenter(cell.center());\r\n            button.setLeft(cell.right() + 2);\r\n        }\r\n        lastCell = cell;\r\n    }\r\n    this.frame.contents.adjustBounds();\r\n};\r\n\r\nListWatcherMorph.prototype.expand = function (maxExtent) {\r\n    // make sure to show all (first 100) cells\r\n    var fe = this.frame.contents.extent(),\r\n        ext = new Point(fe.x + 6, fe.y + this.label.height() + 6);\r\n    if (maxExtent) {\r\n        ext = ext.min(maxExtent);\r\n    }\r\n    this.setExtent(ext);\r\n    this.handle.setRight(this.right() - 3);\r\n    this.handle.setBottom(this.bottom() - 3);\r\n};\r\n\r\n// ListWatcherMorph context menu\r\n\r\nListWatcherMorph.prototype.userMenu = function () {\r\n    if (!List.prototype.enableTables) {\r\n        return this.escalateEvent('userMenu');\r\n    }\r\n    var menu = new MenuMorph(this),\r\n        myself = this;\r\n    menu.addItem('table view...', 'showTableView');\r\n    menu.addLine();\r\n    menu.addItem(\r\n        'open in dialog...',\r\n        function () {\r\n            new TableDialogMorph(myself.list).popUp(myself.world());\r\n        }\r\n    );\r\n    return menu;\r\n};\r\n\r\nListWatcherMorph.prototype.showTableView = function () {\r\n    var view = this.parentThatIsAnyOf([\r\n        SpriteBubbleMorph,\r\n        SpeechBubbleMorph,\r\n        CellMorph\r\n    ]);\r\n    if (!view) {return; }\r\n    if (view instanceof SpriteBubbleMorph) {\r\n        view.changed();\r\n        view.drawNew(true);\r\n    } else if (view instanceof SpeechBubbleMorph) {\r\n        view.contents = new TableFrameMorph(new TableMorph(this.list, 10));\r\n        view.contents.expand(this.extent());\r\n        view.drawNew(true);\r\n    } else { // watcher cell\r\n        view.drawNew(true, 'table');\r\n        view.contentsMorph.expand(this.extent());\r\n    }\r\n    view.fixLayout();\r\n};\r\n\r\n// ListWatcherMorph events:\r\n\r\nListWatcherMorph.prototype.mouseDoubleClick = function (pos) {\r\n    if (List.prototype.enableTables) {\r\n        new TableDialogMorph(this.list).popUp(this.world());\r\n    } else {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    }\r\n};\r\n\r\n// ListWatcherMorph hiding/showing:\r\n\r\nListWatcherMorph.prototype.show = function () {\r\n    ListWatcherMorph.uber.show.call(this);\r\n    this.frame.contents.adjustBounds();\r\n};\r\n\r\n// ListWatcherMorph drawing:\r\n\r\nListWatcherMorph.prototype.drawNew = function () {\r\n    WatcherMorph.prototype.drawNew.call(this);\r\n    this.fixLayout();\r\n};\r\n//fin de Lists.js\r\n/*\r\n\r\n    byob.js\r\n\r\n    \"build your own blocks\" for Snap!\r\n    based on morphic.js, widgets.js blocks.js, threads.js and objects.js\r\n    inspired by Scratch\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs blocks.js, threads.js, objects.js, widgets.js and morphic.js\r\n\r\n\r\n    hierarchy\r\n    ---------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n    BlockLabelFragment\r\n    CustomBlockDefinition\r\n\r\n    CommandBlockMorph***\r\n        CustomCommandBlockMorph\r\n        HatBlockMorph***\r\n            PrototypeHatBlockMorph\r\n\r\n    DialogBoxMorph**\r\n        BlockDialogMorph\r\n        BlockEditorMorph\r\n        BlockExportDialogMorph\r\n        BlockImportDialogMorph\r\n        BlockRemovalDialogMorph\r\n        InputSlotDialogMorph\r\n        VariableDialogMorph\r\n\r\n    ReporterBlockMorph***\r\n        CustomReporterBlockMorph\r\n        JaggedBlockMorph\r\n\r\n\r\n    StringMorph*\r\n        BlockLabelFragmentMorph\r\n        BlockLabelPlaceHolderMorph\r\n\r\n    TemplateSlotMorph***\r\n        BlockInputFragmentMorph\r\n\r\n    * from morphic.js\r\n    ** from widgets.js\r\n    *** from blocks.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n    CustomBlockDefinition\r\n    CustomCommandBlockMorph\r\n    CustomReporterBlockMorph\r\n    JaggedBlockMorph\r\n    BlockDialogMorph\r\n    BlockEditorMorph\r\n    PrototypeHatBlockMorph\r\n    BlockLabelFragmentMorph\r\n    BlockLabelPlaceHolderMorph\r\n    BlockInputFragmentMorph\r\n    InputSlotDialogMorph\r\n    VariableDialogMorph\r\n    BlockExportDialogMorph\r\n    BlockImportDialogMorph\r\n    BlockRemovalDialogMorph\r\n\r\n*/\r\n\r\n/*global modules, CommandBlockMorph, SpriteMorph, TemplateSlotMorph,\r\nStringMorph, Color, DialogBoxMorph, ScriptsMorph, ScrollFrameMorph,\r\nPoint, HandleMorph, HatBlockMorph, BlockMorph, detect, List, Process,\r\nAlignmentMorph, ToggleMorph, InputFieldMorph, ReporterBlockMorph,\r\nStringMorph, nop, newCanvas, radians, BoxMorph, ArrowMorph, PushButtonMorph,\r\ncontains, InputSlotMorph, ToggleButtonMorph, IDE_Morph, MenuMorph, copy,\r\nToggleElementMorph, Morph, fontHeight, StageMorph, SyntaxElementMorph,\r\nSnapSerializer, CommentMorph, localize, CSlotMorph, MorphicPreferences,\r\nSymbolMorph, isNil, CursorMorph, VariableFrame, WatcherMorph, Variable,\r\nBooleanSlotMorph, XML_Serializer, SnapTranslator*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.byob = '2017-December-01';\r\n\r\n// Declarations\r\n\r\nvar CustomBlockDefinition;\r\nvar CustomCommandBlockMorph;\r\nvar CustomReporterBlockMorph;\r\nvar BlockDialogMorph;\r\nvar BlockEditorMorph;\r\nvar PrototypeHatBlockMorph;\r\nvar BlockLabelFragment;\r\nvar BlockLabelFragmentMorph;\r\nvar BlockInputFragmentMorph;\r\nvar BlockLabelPlaceHolderMorph;\r\nvar InputSlotDialogMorph;\r\nvar VariableDialogMorph;\r\nvar JaggedBlockMorph;\r\nvar BlockExportDialogMorph;\r\nvar BlockImportDialogMorph;\r\nvar BlockRemovalDialogMorph;\r\n\r\n// CustomBlockDefinition ///////////////////////////////////////////////\r\n\r\n// CustomBlockDefinition instance creation:\r\n\r\nfunction CustomBlockDefinition(spec, receiver) {\r\n    this.body = null; // a Context (i.e. a reified top block)\r\n    this.scripts = [];\r\n    this.category = null;\r\n    this.isGlobal = false;\r\n    this.type = 'command';\r\n    this.spec = spec || '';\r\n    // format: {'inputName' : [type, default, options, readonly]}\r\n    this.declarations = {};\r\n    this.variableNames = [];\r\n    this.comment = null;\r\n    this.codeMapping = null; // experimental, generate text code\r\n    this.codeHeader = null; // experimental, generate text code\r\n    this.translations = {}; // experimental, format: {lang : spec}\r\n\r\n    // don't serialize (not needed for functionality):\r\n    this.receiver = receiver || null; // for serialization only (pointer)\r\n    this.editorDimensions = null; // a rectangle, last bounds of the editor\r\n    this.cachedIsRecursive = null; // for automatic yielding\r\n    this.cachedTranslation = null; // for localized block specs\r\n}\r\n\r\n// CustomBlockDefinition instantiating blocks\r\n\r\nCustomBlockDefinition.prototype.blockInstance = function () {\r\n    var block;\r\n    if (this.type === 'command') {\r\n        block = new CustomCommandBlockMorph(this);\r\n    } else {\r\n        block = new CustomReporterBlockMorph(\r\n            this,\r\n            this.type === 'predicate'\r\n        );\r\n    }\r\n    block.isDraggable = true;\r\n    return block;\r\n};\r\n\r\nCustomBlockDefinition.prototype.templateInstance = function () {\r\n    var block;\r\n    block = this.blockInstance();\r\n    block.refreshDefaults(this);\r\n    block.isDraggable = false;\r\n    block.isTemplate = true;\r\n    return block;\r\n};\r\n\r\nCustomBlockDefinition.prototype.prototypeInstance = function () {\r\n    var block, slot, myself = this;\r\n\r\n    // make a new block instance and mark it as prototype\r\n    if (this.type === 'command') {\r\n        block = new CustomCommandBlockMorph(this, true);\r\n    } else {\r\n        block = new CustomReporterBlockMorph(\r\n            this,\r\n            this.type === 'predicate',\r\n            true\r\n        );\r\n    }\r\n\r\n    // assign slot declarations to prototype inputs\r\n    block.parts().forEach(function (part) {\r\n        if (part instanceof BlockInputFragmentMorph) {\r\n            slot = myself.declarations[part.fragment.labelString];\r\n            if (slot) {\r\n                part.fragment.type = slot[0];\r\n                part.fragment.defaultValue = slot[1];\r\n                part.fragment.options = slot[2];\r\n                part.fragment.isReadOnly = slot[3] || false;\r\n            }\r\n        }\r\n    });\r\n\r\n    return block;\r\n};\r\n\r\n// CustomBlockDefinition duplicating\r\n\r\nCustomBlockDefinition.prototype.copyAndBindTo = function (sprite, headerOnly) {\r\n    var c = copy(this);\r\n\r\n    delete c[XML_Serializer.prototype.idProperty];\r\n    c.receiver = sprite; // only for (kludgy) serialization\r\n    c.declarations = copy(this.declarations); // might have to go deeper\r\n    if (headerOnly) { // for serializing inherited method signatures\r\n        c.body = null;\r\n        return c;\r\n    }\r\n    if (c.body) {\r\n        c.body = Process.prototype.reify.call(\r\n            null,\r\n            this.body.expression,\r\n            new List(this.inputNames())\r\n        );\r\n        c.body.outerContext = null;\r\n    }\r\n    return c;\r\n};\r\n\r\n// CustomBlockDefinition accessing\r\n\r\nCustomBlockDefinition.prototype.blockSpec = function () {\r\n    var myself = this,\r\n        ans = [],\r\n        parts = this.parseSpec(this.spec),\r\n        spec;\r\n    parts.forEach(function (part) {\r\n        if (part[0] === '%' && part.length > 1) {\r\n            spec = myself.typeOf(part.slice(1));\r\n        } else if (part === '$nl') {\r\n            spec = '%br';\r\n        } else {\r\n            spec = part;\r\n        }\r\n        ans.push(spec);\r\n        ans.push(' ');\r\n    });\r\n    return ''.concat.apply('', ans).trim();\r\n};\r\n\r\nCustomBlockDefinition.prototype.helpSpec = function () {\r\n    var ans = [],\r\n        parts = this.parseSpec(this.spec);\r\n    parts.forEach(function (part) {\r\n        if (part[0] !== '%') {\r\n            ans.push(part);\r\n        }\r\n    });\r\n    return ''.concat.apply('', ans).replace(/\\?/g, '');\r\n};\r\n\r\nCustomBlockDefinition.prototype.typeOf = function (inputName) {\r\n    if (this.declarations[inputName]) {\r\n        return this.declarations[inputName][0];\r\n    }\r\n    return '%s';\r\n};\r\n\r\nCustomBlockDefinition.prototype.defaultValueOf = function (inputName) {\r\n    if (this.declarations[inputName]) {\r\n        return this.declarations[inputName][1];\r\n    }\r\n    return '';\r\n};\r\n\r\nCustomBlockDefinition.prototype.defaultValueOfInputIdx = function (idx) {\r\n    var inputName = this.inputNames()[idx];\r\n    return this.defaultValueOf(inputName);\r\n};\r\n\r\nCustomBlockDefinition.prototype.dropDownMenuOfInputIdx = function (idx) {\r\n    var inputName = this.inputNames()[idx];\r\n    return this.dropDownMenuOf(inputName);\r\n};\r\n\r\nCustomBlockDefinition.prototype.isReadOnlyInputIdx = function (idx) {\r\n    var inputName = this.inputNames()[idx];\r\n    return this.isReadOnlyInput(inputName);\r\n};\r\n\r\nCustomBlockDefinition.prototype.inputOptionsOfIdx = function (idx) {\r\n    var inputName = this.inputNames()[idx];\r\n    return this.inputOptionsOf(inputName);\r\n};\r\n\r\nCustomBlockDefinition.prototype.dropDownMenuOf = function (inputName) {\r\n    if (this.declarations[inputName] && this.declarations[inputName][2]) {\r\n        return this.parseChoices(this.declarations[inputName][2]);\r\n    }\r\n    return null;\r\n};\r\n\r\nCustomBlockDefinition.prototype.parseChoices = function (string) {\r\n    var dict = {},\r\n        stack = [dict];\r\n    string.split('\\n').forEach(function (line) {\r\n        var pair = line.split('=');\r\n        if (pair[0] === '}') {\r\n            stack.pop();\r\n            dict = stack[stack.length - 1];\r\n        } else if (pair[1] === '{') {\r\n            dict = {};\r\n            stack[stack.length - 1][pair[0]] = dict;\r\n            stack.push(dict);\r\n        } else {\r\n            dict[pair[0]] = isNil(pair[1]) ? pair[0] : pair[1];\r\n        }\r\n    });\r\n    return dict;\r\n};\r\n\r\nCustomBlockDefinition.prototype.isReadOnlyInput = function (inputName) {\r\n    return this.declarations[inputName] &&\r\n        this.declarations[inputName][3] === true;\r\n};\r\n\r\nCustomBlockDefinition.prototype.inputOptionsOf = function (inputName) {\r\n    return [\r\n        this.dropDownMenuOf(inputName),\r\n        this.isReadOnlyInput(inputName)\r\n    ];\r\n};\r\n\r\nCustomBlockDefinition.prototype.inputNames = function () {\r\n    var vNames = [],\r\n        parts = this.parseSpec(this.spec);\r\n    parts.forEach(function (part) {\r\n        if (part[0] === '%' && part.length > 1) {\r\n            vNames.push(part.slice(1));\r\n        }\r\n    });\r\n    return vNames;\r\n};\r\n\r\nCustomBlockDefinition.prototype.parseSpec = function (spec) {\r\n    // private\r\n    var parts = [], word = '', i, quoted = false, c;\r\n    for (i = 0; i < spec.length; i += 1) {\r\n        c = spec[i];\r\n        if (c === \"'\") {\r\n            quoted = !quoted;\r\n        } else if (c === ' ' && !quoted) {\r\n            parts.push(word);\r\n            word = '';\r\n        } else {\r\n            word = word.concat(c);\r\n        }\r\n    }\r\n    parts.push(word);\r\n    return parts;\r\n};\r\n\r\nCustomBlockDefinition.prototype.isDirectlyRecursive = function () {\r\n    var myspec;\r\n    if (this.cachedIsRecursive !== null) {\r\n        return this.cachedIsRecursive;\r\n    }\r\n    if (!this.body) {\r\n        this.cachedIsRecursive = false;\r\n    } else {\r\n        myspec = this.blockSpec();\r\n        this.cachedIsRecursive = this.body.expression.anyChild(\r\n            function (morph) {\r\n                return morph.isCustomBlock &&\r\n                    morph.blockSpec === myspec;\r\n            }\r\n        );\r\n    }\r\n    return this.cachedIsRecursive;\r\n};\r\n\r\n// CustomBlockDefinition localizing, highly experimental\r\n\r\nCustomBlockDefinition.prototype.localizedSpec = function () {\r\n\tif (this.cachedTranslation) {return this.cachedTranslation; }\r\n\r\n\tvar loc = this.translations[SnapTranslator.language],\r\n\t\tsem = this.blockSpec(),\r\n        locParts,\r\n  \t\tinputs,\r\n    \ti = -1;\r\n\r\n\tfunction isInput(str) {\r\n    \treturn (str.length > 1) && (str[0] === '%');\r\n \t}\r\n\r\n    if (isNil(loc)) {return sem; }\r\n    inputs = BlockMorph.prototype.parseSpec(sem).filter(function (str) {\r\n        return (isInput(str));\r\n    });\r\n\tlocParts = BlockMorph.prototype.parseSpec(loc);\r\n\r\n\t// perform a bunch of sanity checks on the localized spec\r\n\tif (locParts.some(function (str) {return isInput(str); }) ||\r\n \t\t\t(locParts.filter(function (str) {return str === '_'; }).length !==\r\n            \tinputs.length)\r\n    ) {\r\n \t\tthis.cachedTranslation = sem;\r\n    } else {\r\n\t\t// substitute each input place holder with its semantic spec part\r\n\t\tlocParts = locParts.map(function (str) {\r\n\t\t\tif (str === '_') {\r\n  \t\t\t\ti += 1;\r\n  \t\t\t\treturn inputs[i];\r\n  \t\t\t}\r\n    \t\treturn str;\r\n\t\t});\r\n \t\tthis.cachedTranslation = locParts.join(' ');\r\n   \t}\r\n  \treturn this.cachedTranslation;\r\n};\r\n\r\nCustomBlockDefinition.prototype.abstractBlockSpec = function () {\r\n\t// answer the semantic block spec substituting each input\r\n \t// with an underscore\r\n    return BlockMorph.prototype.parseSpec(this.blockSpec()).map(\r\n    \tfunction (str) {\r\n    \t\treturn (str.length > 1 && (str[0]) === '%') ? '_' : str;\r\n    \t}\r\n    ).join(' ');\r\n};\r\n\r\nCustomBlockDefinition.prototype.translationsAsText = function () {\r\n\tvar myself = this,\r\n \t\ttxt = '';\r\n\tObject.keys(this.translations).forEach(function (lang) {\r\n \t\ttxt += (lang + ':' + myself.translations[lang] + '\\n');\r\n    });\r\n    return txt;\r\n};\r\n\r\nCustomBlockDefinition.prototype.updateTranslations = function (text) {\r\n\tvar myself = this,\r\n    \tlines = text.split('\\n').filter(function (txt) {\r\n     \t   return txt.length;\r\n    \t});\r\n\tthis.translations = {};\r\n \tlines.forEach(function (txt) {\r\n  \t\tvar idx = txt.indexOf(':'),\r\n    \t\tkey = txt.slice(0, idx).trim(),\r\n      \t\tval = txt.slice(idx + 1).trim();\r\n    \tif (idx) {\r\n     \t\tmyself.translations[key] = val;\r\n     \t}\r\n    });\r\n};\r\n\r\n// CustomBlockDefinition picturing\r\n\r\nCustomBlockDefinition.prototype.scriptsPicture = function () {\r\n    return this.scriptsModel().scriptsPicture();\r\n};\r\n\r\nCustomBlockDefinition.prototype.sortedElements = function () {\r\n    return this.scriptsModel().sortedElements();\r\n};\r\n\r\nCustomBlockDefinition.prototype.scriptsModel = function () {\r\n    // answer a restored scripting area for the sake\r\n    // of creating script pictures\r\n    var scripts, proto, block, comment, template;\r\n\r\n    scripts = new ScriptsMorph();\r\n    scripts.cleanUpMargin = 10;\r\n    proto = new PrototypeHatBlockMorph(this);\r\n    proto.setPosition(scripts.position().add(10));\r\n    if (this.comment !== null) {\r\n        comment = this.comment.fullCopy();\r\n        proto.comment = comment;\r\n        comment.block = proto;\r\n    }\r\n    if (this.body !== null) {\r\n        proto.nextBlock(this.body.expression.fullCopy());\r\n    }\r\n    scripts.add(proto);\r\n    proto.fixBlockColor(null, true);\r\n    this.scripts.forEach(function (element) {\r\n        block = element.fullCopy();\r\n        block.setPosition(scripts.position().add(element.position()));\r\n        scripts.add(block);\r\n        if (block instanceof BlockMorph) {\r\n            block.allComments().forEach(function (comment) {\r\n                comment.align(block);\r\n            });\r\n        }\r\n    });\r\n    proto.allComments().forEach(function (comment) {\r\n        comment.align(proto);\r\n    });\r\n    template = proto.parts()[0];\r\n    template.fixLayout();\r\n    template.forceNormalColoring();\r\n    template.fixBlockColor(proto, true);\r\n    scripts.fixMultiArgs();\r\n    return scripts;\r\n};\r\n\r\n// CustomBlockDefinition purging deleted blocks\r\n\r\nCustomBlockDefinition.prototype.purgeCorpses = function () {\r\n    // remove blocks that have been marked for deletion\r\n    if (this.body && this.body.expression.isCorpse) {\r\n        this.body = null;\r\n    }\r\n    this.scripts = this.scripts.filter(function (topBlock) {\r\n        return !topBlock.isCorpse;\r\n    });\r\n};\r\n\r\n// CustomCommandBlockMorph /////////////////////////////////////////////\r\n\r\n// CustomCommandBlockMorph inherits from CommandBlockMorph:\r\n\r\nCustomCommandBlockMorph.prototype = new CommandBlockMorph();\r\nCustomCommandBlockMorph.prototype.constructor = CustomCommandBlockMorph;\r\nCustomCommandBlockMorph.uber = CommandBlockMorph.prototype;\r\n\r\n// CustomCommandBlockMorph shared settings:\r\n\r\nCustomCommandBlockMorph.prototype.isCustomBlock = true;\r\n\r\n// CustomCommandBlockMorph instance creation:\r\n\r\nfunction CustomCommandBlockMorph(definition, isProto) {\r\n    this.init(definition, isProto);\r\n}\r\n\r\nCustomCommandBlockMorph.prototype.init = function (definition, isProto) {\r\n    this.definition = definition; // mandatory\r\n    this.semanticSpec = '';\r\n    this.isGlobal = definition ? definition.isGlobal : false;\r\n    this.isPrototype = isProto || false; // optional\r\n    CustomCommandBlockMorph.uber.init.call(this, true); // silently\r\n    this.category = definition.category;\r\n    this.selector = 'evaluateCustomBlock';\r\n    this.variables = null;\r\n    this.initializeVariables();\r\n    if (definition) { // needed for de-serializing\r\n        this.refresh();\r\n    }\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.initializeVariables = function (oldVars) {\r\n    var myself = this;\r\n    this.variables = new VariableFrame();\r\n    if (!this.isGlobal) {\r\n        return;\r\n    }\r\n    this.definition.variableNames.forEach(function (name) {\r\n        var v = oldVars ? oldVars[name] : null;\r\n        myself.variables.addVar(\r\n            name,\r\n            v instanceof Variable ? v.value : null\r\n        );\r\n    });\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.refresh = function (aDefinition, silently) {\r\n    var def = aDefinition || this.definition,\r\n        newSpec = this.isPrototype ?\r\n                def.spec : def.localizedSpec(),\r\n        oldInputs;\r\n\r\n\tthis.semanticSpec = def.blockSpec();\r\n\r\n    // make sure local custom blocks don't hold on to a method.\r\n    // future performance optimization plan:\r\n    // null out the definition for local blocks here,\r\n    // and then cache them again when invoking them\r\n    if (!this.isGlobal && !this.isPrototype) {\r\n        this.definition = null;\r\n    }\r\n\r\n    this.setCategory(def.category);\r\n    if (this.blockSpec !== newSpec) {\r\n        oldInputs = this.inputs();\r\n        if (!this.zebraContrast) {\r\n            this.forceNormalColoring();\r\n        } else {\r\n            this.fixBlockColor();\r\n        }\r\n        this.setSpec(newSpec, silently, def);\r\n        this.fixLabelColor();\r\n        this.restoreInputs(oldInputs);\r\n    } else { // update all input slots' drop-downs\r\n        this.inputs().forEach(function (inp, i) {\r\n            if (inp instanceof InputSlotMorph) {\r\n                inp.setChoices.apply(inp, def.inputOptionsOfIdx(i));\r\n            }\r\n        });\r\n    }\r\n\r\n    // find unnamed upvars and label them\r\n    // to their internal definition (default)\r\n    this.cachedInputs = null;\r\n    this.inputs().forEach(function (inp, idx) {\r\n        if (inp instanceof TemplateSlotMorph && inp.contents() === '\\u2191') {\r\n            inp.setContents(def.inputNames()[idx]);\r\n        }\r\n    });\r\n\r\n    // initialize block vars\r\n    // preserve values of unchanged variable names\r\n    if (this.isGlobal) {\r\n        this.initializeVariables(this.variables.vars);\r\n    }\r\n\r\n    // make (double) sure I'm colored correctly\r\n    this.forceNormalColoring();\r\n    this.drawNew();\r\n    this.fixBlockColor(null, true);\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.restoreInputs = function (oldInputs) {\r\n    // try to restore my previous inputs when my spec has been changed\r\n    var i = 0,\r\n        old,\r\n        myself = this;\r\n\r\n    if (this.isPrototype) {return; }\r\n    this.cachedInputs = null;\r\n    this.inputs().forEach(function (inp) {\r\n        old = oldInputs[i];\r\n        if (old instanceof ReporterBlockMorph &&\r\n                (!(inp instanceof TemplateSlotMorph))) {\r\n            myself.silentReplaceInput(inp, old.fullCopy());\r\n        } else if (old instanceof InputSlotMorph\r\n                && inp instanceof InputSlotMorph) {\r\n            inp.setContents(old.evaluate());\r\n        } else if (old instanceof TemplateSlotMorph\r\n                && inp instanceof TemplateSlotMorph) {\r\n            inp.setContents(old.evaluate());\r\n        } else if (old instanceof CSlotMorph\r\n                && inp instanceof CSlotMorph) {\r\n            inp.nestedBlock(old.evaluate());\r\n        }\r\n        i += 1;\r\n    });\r\n    this.cachedInputs = null;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.refreshDefaults = function (definition) {\r\n    // fill my editable slots with the defaults specified in my definition\r\n    var inputs = this.inputs(), idx = 0, myself = this;\r\n\r\n    inputs.forEach(function (inp) {\r\n        if (inp instanceof InputSlotMorph || inp instanceof BooleanSlotMorph) {\r\n            inp.setContents(\r\n                (definition || myself.definition).defaultValueOfInputIdx(idx)\r\n            );\r\n        }\r\n        idx += 1;\r\n    });\r\n    this.cachedInputs = null;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.refreshPrototype = function () {\r\n    // create my label parts from my (edited) fragments only\r\n    var hat,\r\n        protoSpec,\r\n        frags = [],\r\n        myself = this,\r\n        words,\r\n        newFrag,\r\n        i = 0;\r\n\r\n    if (!this.isPrototype) {return null; }\r\n\r\n    hat = this.parentThatIsA(PrototypeHatBlockMorph);\r\n\r\n    // remember the edited fragments\r\n    this.parts().forEach(function (part) {\r\n        if (!part.fragment.isDeleted) {\r\n            // take into consideration that a fragment may spawn others\r\n            // if it isn't an input label consisting of several words\r\n            if (part.fragment.type) { // marked as input, take label as is\r\n                frags.push(part.fragment);\r\n            } else { // not an input, devide into several non-input fragments\r\n                words = myself.definition.parseSpec(\r\n                    part.fragment.labelString\r\n                );\r\n                words.forEach(function (word) {\r\n                    newFrag = part.fragment.copy();\r\n                    newFrag.labelString = word;\r\n                    frags.push(newFrag);\r\n                });\r\n            }\r\n        }\r\n    });\r\n\r\n    // remember the edited prototype spec\r\n    protoSpec = this.specFromFragments();\r\n\r\n\r\n    // update the prototype's type\r\n    // and possibly exchange 'this' for 'myself'\r\n    if (this instanceof CustomCommandBlockMorph\r\n            && ((hat.type === 'reporter') || (hat.type === 'predicate'))) {\r\n        myself = new CustomReporterBlockMorph(\r\n            this.definition,\r\n            hat.type === 'predicate',\r\n            true\r\n        );\r\n        hat.silentReplaceInput(this, myself);\r\n    } else if (this instanceof CustomReporterBlockMorph) {\r\n        if (hat.type === 'command') {\r\n            myself = new CustomCommandBlockMorph(\r\n                this.definition,\r\n                true\r\n            );\r\n            hat.silentReplaceInput(this, myself);\r\n        } else {\r\n            this.isPredicate = (hat.type === 'predicate');\r\n            this.drawNew();\r\n        }\r\n    }\r\n    myself.setCategory(hat.blockCategory || 'other');\r\n    hat.fixBlockColor();\r\n\r\n    // update the (new) prototype's appearance\r\n    myself.setSpec(protoSpec);\r\n\r\n    // update the (new) prototype's (new) fragments\r\n    // with the previously edited ones\r\n\r\n    myself.parts().forEach(function (part) {\r\n        if (!(part instanceof BlockLabelPlaceHolderMorph)) {\r\n            if (frags[i]) { // don't delete the default fragment\r\n                part.fragment = frags[i];\r\n            }\r\n            i += 1;\r\n        }\r\n    });\r\n\r\n    // refresh slot type indicators\r\n    this.refreshPrototypeSlotTypes();\r\n\r\n    hat.fixLayout();\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes = function () {\r\n    this.parts().forEach(function (part) {\r\n        if (part instanceof BlockInputFragmentMorph) {\r\n            part.template().instantiationSpec = part.contents();\r\n            part.setContents(part.fragment.defTemplateSpecFragment());\r\n        }\r\n    });\r\n    this.fixBlockColor(null, true); // enforce zebra coloring of templates\r\n};\r\n\r\n\r\nCustomCommandBlockMorph.prototype.inputFragmentNames = function () {\r\n    // for the variable name slot drop-down menu (in the block editor)\r\n    var ans = [];\r\n\r\n    this.parts().forEach(function (part) {\r\n        if (!part.fragment.isDeleted && (part.fragment.type)) {\r\n            ans.push(part.fragment.labelString);\r\n        }\r\n    });\r\n    return ans;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.upvarFragmentNames = function () {\r\n    // for the variable name slot drop-down menu (in the block editor)\r\n    var ans = [];\r\n\r\n    this.parts().forEach(function (part) {\r\n        if (!part.fragment.isDeleted && (part.fragment.type === '%upvar')) {\r\n            ans.push(part.fragment.labelString);\r\n        }\r\n    });\r\n    return ans;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.upvarFragmentName = function (idx) {\r\n    // for block prototypes while they are being edited\r\n    return this.upvarFragmentNames()[idx] || '\\u2191';\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.specFromFragments = function () {\r\n    // for block prototypes while they are being edited\r\n    var ans = '';\r\n\r\n    this.parts().forEach(function (part) {\r\n        if (!part.fragment.isDeleted) {\r\n            ans = ans + part.fragment.defSpecFragment() + ' ';\r\n        }\r\n    });\r\n    return ans.trim();\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.blockSpecFromFragments = function () {\r\n    // for block instances while their prototype is being edited\r\n    var ans = '';\r\n\r\n    this.parts().forEach(function (part) {\r\n        if (!part.fragment.isDeleted) {\r\n            ans = ans + part.fragment.blockSpecFragment() + ' ';\r\n        }\r\n    });\r\n    return ans.trim();\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.declarationsFromFragments = function () {\r\n    // format for type declarations: {inputName : [type, default]}\r\n    var ans = {};\r\n\r\n    this.parts().forEach(function (part) {\r\n        if (part instanceof BlockInputFragmentMorph) {\r\n            ans[part.fragment.labelString] = [\r\n                part.fragment.type,\r\n                part.fragment.defaultValue,\r\n                part.fragment.options,\r\n                part.fragment.isReadOnly\r\n            ];\r\n        }\r\n    });\r\n    return ans;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.parseSpec = function (spec) {\r\n    if (!this.isPrototype) {\r\n        return CustomCommandBlockMorph.uber.parseSpec.call(this, spec);\r\n    }\r\n    return CustomBlockDefinition.prototype.parseSpec(spec);\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.mouseClickLeft = function () {\r\n    if (!this.isPrototype) {\r\n        return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);\r\n    }\r\n    this.edit();\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.edit = function () {\r\n    var myself = this,\r\n        def = this.definition,\r\n        editor, block,\r\n        hat,\r\n        rcvr;\r\n\r\n    if (this.isPrototype) {\r\n        block = this.definition.blockInstance();\r\n        block.addShadow();\r\n        hat = this.parentThatIsA(PrototypeHatBlockMorph);\r\n        new BlockDialogMorph(\r\n            null,\r\n            function (definition) {\r\n                if (definition) { // temporarily update everything\r\n                    hat.blockCategory = definition.category;\r\n                    hat.type = definition.type;\r\n                    myself.refreshPrototype();\r\n                }\r\n            },\r\n            myself\r\n        ).openForChange(\r\n            'Change block',\r\n            hat.blockCategory,\r\n            hat.type,\r\n            myself.world(),\r\n            block.fullImage(),\r\n            myself.isInUse()\r\n        );\r\n    } else {\r\n        // check for local custom block inheritance\r\n        rcvr = this.scriptTarget();\r\n        if (!this.isGlobal) {\r\n            if (contains(\r\n                    Object.keys(rcvr.inheritedBlocks()),\r\n                    this.blockSpec\r\n                )\r\n            ) {\r\n                this.duplicateBlockDefinition();\r\n                return;\r\n            }\r\n            def = rcvr.getMethod(this.semanticSpec);\r\n        }\r\n        Morph.prototype.trackChanges = false;\r\n        editor = new BlockEditorMorph(def, rcvr);\r\n        editor.popUp();\r\n        Morph.prototype.trackChanges = true;\r\n        editor.changed();\r\n    }\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.labelPart = function (spec) {\r\n    var part;\r\n\r\n    if (!this.isPrototype) {\r\n        return CustomCommandBlockMorph.uber.labelPart.call(this, spec);\r\n    }\r\n    if ((spec[0] === '%') && (spec.length > 1)) {\r\n        // part = new BlockInputFragmentMorph(spec.slice(1));\r\n        part = new BlockInputFragmentMorph(spec.replace(/%/g, ''));\r\n    } else {\r\n        part = new BlockLabelFragmentMorph(spec);\r\n        part.fontSize = this.fontSize;\r\n        part.color = new Color(255, 255, 255);\r\n        part.isBold = true;\r\n        part.shadowColor = this.color.darker(this.labelContrast);\r\n        part.shadowOffset = this.embossing;\r\n        part.drawNew();\r\n    }\r\n    return part;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.placeHolder = function () {\r\n    var part;\r\n\r\n    part = new BlockLabelPlaceHolderMorph();\r\n    part.fontSize = this.fontSize * 1.4;\r\n    part.color = new Color(45, 45, 45);\r\n    part.drawNew();\r\n    return part;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.attachTargets = function () {\r\n    if (this.isPrototype) {\r\n        return [];\r\n    }\r\n    return CustomCommandBlockMorph.uber.attachTargets.call(this);\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.isInUse = function () {\r\n    // answer true if an instance of my definition is found\r\n    // in any of my receiver's scripts or block definitions\r\n    // NOTE: for sprite-local blocks only to be used in a situation\r\n    // where the user actively clicks on a block in the IDE,\r\n    // e.g. to edit it (and change its type)\r\n    var def = this.definition,\r\n        rcvr = this.scriptTarget(),\r\n        ide = rcvr.parentThatIsA(IDE_Morph);\r\n    if (def.isGlobal && ide) {\r\n        return ide.sprites.asArray().concat([ide.stage]).some(\r\n            function (any, idx) {\r\n                return any.usesBlockInstance(def, false, idx);\r\n            }\r\n        );\r\n    }\r\n    return rcvr.allDependentInvocationsOf(this.blockSpec).length > 0;\r\n};\r\n\r\n// CustomCommandBlockMorph menu:\r\n\r\nCustomCommandBlockMorph.prototype.userMenu = function () {\r\n    var hat = this.parentThatIsA(PrototypeHatBlockMorph),\r\n        rcvr = this.scriptTarget(),\r\n        myself = this,\r\n        shiftClicked = this.world().currentKey === 16,\r\n        menu;\r\n\r\n    function addOption(label, toggle, test, onHint, offHint) {\r\n        var on = '\\u2611 ',\r\n            off = '\\u2610 ';\r\n        menu.addItem(\r\n            (test ? on : off) + localize(label),\r\n            toggle,\r\n            test ? onHint : offHint\r\n        );\r\n    }\r\n\r\n   function monitor(vName) {\r\n        var stage = rcvr.parentThatIsA(StageMorph),\r\n            varFrame = myself.variables;\r\n        menu.addItem(\r\n            vName + '...',\r\n            function () {\r\n                var watcher = detect(\r\n                    stage.children,\r\n                    function (morph) {\r\n                        return morph instanceof WatcherMorph\r\n                            && morph.target === varFrame\r\n                            && morph.getter === vName;\r\n                    }\r\n                ),\r\n                    others;\r\n                if (watcher !== null) {\r\n                    watcher.show();\r\n                    watcher.fixLayout(); // re-hide hidden parts\r\n                    return;\r\n                }\r\n                watcher = new WatcherMorph(\r\n                    vName + ' ' + localize('(temporary)'),\r\n                    SpriteMorph.prototype.blockColor.variables,\r\n                    varFrame,\r\n                    vName\r\n                );\r\n                watcher.setPosition(stage.position().add(10));\r\n                others = stage.watchers(watcher.left());\r\n                if (others.length > 0) {\r\n                    watcher.setTop(others[others.length - 1].bottom());\r\n                }\r\n                stage.add(watcher);\r\n                watcher.fixLayout();\r\n            }\r\n        );\r\n    }\r\n\r\n    if (this.isPrototype) {\r\n        menu = new MenuMorph(this);\r\n        menu.addItem(\r\n            \"script pic...\",\r\n            function () {\r\n                var ide = this.world().children[0];\r\n                ide.saveCanvasAs(\r\n                    this.topBlock().scriptPic(),\r\n                    (ide.projectName || localize('untitled')) + ' ' +\r\n                        localize('script pic')\r\n                );\r\n            },\r\n            'open a new window\\nwith a picture of this script'\r\n        );\r\n        menu.addItem(\r\n            \"translations...\",\r\n            function () {\r\n                hat.parentThatIsA(BlockEditorMorph).editTranslations();\r\n            },\r\n            'experimental -\\nunder construction'\r\n        );\r\n        if (this.isGlobal) {\r\n            if (hat.inputs().length < 2) {\r\n                menu.addItem(\r\n                    \"block variables...\",\r\n                    function () {\r\n                        hat.enableBlockVars();\r\n                    },\r\n                    'experimental -\\nunder construction'\r\n                );\r\n            } else {\r\n                menu.addItem(\r\n                    \"remove block variables...\",\r\n                    function () {\r\n                        hat.enableBlockVars(false);\r\n                    },\r\n                    'experimental -\\nunder construction'\r\n                );\r\n            }\r\n        }\r\n    } else {\r\n        menu = this.constructor.uber.userMenu.call(this);\r\n        if (!menu) {\r\n            menu = new MenuMorph(this);\r\n        } else {\r\n            menu.addLine();\r\n        }\r\n        if (shiftClicked) {\r\n            // menu.addItem(\"export definition...\", 'exportBlockDefinition');\r\n            menu.addItem(\r\n                \"duplicate block definition...\",\r\n                'duplicateBlockDefinition',\r\n                null,\r\n                new Color(100, 0, 0)\r\n            );\r\n        }\r\n\r\n        if (this.isTemplate) { // inside the palette\r\n            if (this.isGlobal) {\r\n                menu.addItem(\r\n                    \"delete block definition...\",\r\n                    'deleteBlockDefinition'\r\n                );\r\n            } else { // local method\r\n                if (contains(\r\n                        Object.keys(rcvr.inheritedBlocks()),\r\n                        this.blockSpec\r\n                )) {\r\n                    // inherited\r\n                    addOption(\r\n                        'inherited',\r\n                        function () {\r\n                            var ide = myself.parentThatIsA(IDE_Morph);\r\n                            rcvr.customBlocks.push(\r\n                                rcvr.getMethod(\r\n                                    myself.blockSpec\r\n                                ).copyAndBindTo(rcvr)\r\n                            );\r\n                            if (ide) {\r\n                                ide.flushPaletteCache();\r\n                                ide.refreshPalette();\r\n                            }\r\n                        },\r\n                        true,\r\n                        'uncheck to\\ndisinherit',\r\n                        null\r\n                    );\r\n                } else if (rcvr.exemplar &&\r\n                    rcvr.exemplar.getMethod(this.blockSpec\r\n                )) {\r\n                    // shadowed\r\n                    addOption(\r\n                        'inherited',\r\n                        'deleteBlockDefinition',\r\n                        false,\r\n                        null,\r\n                        localize('check to inherit\\nfrom')\r\n                            + ' ' + rcvr.exemplar.name\r\n                    );\r\n                } else {\r\n                    // own block\r\n                    menu.addItem(\r\n                        \"delete block definition...\",\r\n                        'deleteBlockDefinition'\r\n                    );\r\n                }\r\n            }\r\n        } else { // inside a script\r\n            // if global or own method - let the user delete the definition\r\n            if (this.isGlobal ||\r\n                contains(\r\n                    Object.keys(rcvr.ownBlocks()),\r\n                    this.blockSpec\r\n                )\r\n            ) {\r\n                menu.addItem(\r\n                    \"delete block definition...\",\r\n                    'deleteBlockDefinition'\r\n                );\r\n            }\r\n        }\r\n\r\n        this.variables.names().forEach(function (vName) {\r\n            monitor(vName);\r\n        });\r\n    }\r\n    menu.addItem(\"edit...\", 'edit'); // works also for prototypes\r\n    return menu;\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.exportBlockDefinition = function () {\r\n    var xml = new SnapSerializer().serialize(this.definition),\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n\r\n    ide.saveXMLAs(xml, this.spec);\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.duplicateBlockDefinition = function () {\r\n    var rcvr = this.scriptTarget(),\r\n        ide = this.parentThatIsA(IDE_Morph),\r\n        def = this.isGlobal ? this.definition : rcvr.getMethod(this.blockSpec),\r\n        dup = def.copyAndBindTo(rcvr);\r\n    if (this.isGlobal) {\r\n        ide.stage.globalBlocks.push(dup);\r\n    } else {\r\n        rcvr.customBlocks.push(dup);\r\n    }\r\n    ide.flushPaletteCache();\r\n    ide.refreshPalette();\r\n    new BlockEditorMorph(dup, rcvr).popUp();\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.deleteBlockDefinition = function () {\r\n    var idx, stage, ide, method, block,\r\n        rcvr = this.scriptTarget(),\r\n        myself = this;\r\n    if (this.isPrototype) {\r\n        return null; // under construction...\r\n    }\r\n    method = this.isGlobal? this.definition\r\n            : rcvr.getLocalMethod(this.blockSpec);\r\n    block = method.blockInstance();\r\n    block.addShadow();\r\n    new DialogBoxMorph(\r\n        this,\r\n        function () {\r\n            rcvr.deleteAllBlockInstances(method);\r\n            if (method.isGlobal) {\r\n                stage = rcvr.parentThatIsA(StageMorph);\r\n                idx = stage.globalBlocks.indexOf(method);\r\n                if (idx !== -1) {\r\n                    stage.globalBlocks.splice(idx, 1);\r\n                }\r\n            } else {\r\n                // delete local definition\r\n                idx = rcvr.customBlocks.indexOf(method);\r\n                if (idx !== -1) {\r\n                    rcvr.customBlocks.splice(idx, 1);\r\n                }\r\n                // refresh instances of inherited method, if any\r\n                method = rcvr.getMethod(myself.blockSpec);\r\n                if (method) {\r\n                    rcvr.allDependentInvocationsOf(myself.blockSpec).forEach(\r\n                        function (block) {\r\n                            block.refresh(method);\r\n                        }\r\n                    );\r\n                }\r\n            }\r\n            ide = rcvr.parentThatIsA(IDE_Morph);\r\n            if (ide) {\r\n                ide.flushPaletteCache();\r\n                ide.refreshPalette();\r\n            }\r\n        },\r\n        this\r\n    ).askYesNo(\r\n        'Delete Custom Block',\r\n        localize('block deletion dialog text'), // long string lookup\r\n        myself.world(),\r\n        block.fullImage()\r\n    );\r\n};\r\n\r\n// CustomCommandBlockMorph relabelling\r\n\r\nCustomCommandBlockMorph.prototype.relabel = function (alternatives) {\r\n    var menu = new MenuMorph(this),\r\n        oldInputs = this.inputs().map(\r\n            function (each) {return each.fullCopy(); }\r\n        ),\r\n        myself = this;\r\n    alternatives.forEach(function (def) {\r\n        var block = def.blockInstance();\r\n        block.restoreInputs(oldInputs);\r\n        block.fixBlockColor(null, true);\r\n        block.addShadow(new Point(3, 3));\r\n        menu.addItem(\r\n            block,\r\n            function () {\r\n                myself.definition = def;\r\n                myself.refresh();\r\n            }\r\n        );\r\n    });\r\n    menu.popup(this.world(), this.bottomLeft().subtract(new Point(\r\n        8,\r\n        this instanceof CommandBlockMorph ? this.corner : 0\r\n    )));\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.alternatives = function () {\r\n    var rcvr = this.scriptTarget(),\r\n        stage = rcvr.parentThatIsA(StageMorph),\r\n        allDefs = rcvr.customBlocks.concat(stage.globalBlocks),\r\n        type = this instanceof CommandBlockMorph ? 'command'\r\n            : (this.isPredicate ? 'predicate' : 'reporter'),\r\n        myself = this;\r\n    return allDefs.filter(function (each) {\r\n        return each !== myself.definition &&\r\n            each.type === type;\r\n    });\r\n};\r\n\r\n// CustomReporterBlockMorph ////////////////////////////////////////////\r\n\r\n// CustomReporterBlockMorph inherits from ReporterBlockMorph:\r\n\r\nCustomReporterBlockMorph.prototype = new ReporterBlockMorph();\r\nCustomReporterBlockMorph.prototype.constructor = CustomReporterBlockMorph;\r\nCustomReporterBlockMorph.uber = ReporterBlockMorph.prototype;\r\n\r\n// CustomReporterBlockMorph shared settings:\r\n\r\nCustomReporterBlockMorph.prototype.isCustomBlock = true;\r\n\r\n// CustomReporterBlockMorph instance creation:\r\n\r\nfunction CustomReporterBlockMorph(definition, isPredicate, isProto) {\r\n    this.init(definition, isPredicate, isProto);\r\n}\r\n\r\nCustomReporterBlockMorph.prototype.init = function (\r\n    definition,\r\n    isPredicate,\r\n    isProto\r\n) {\r\n    this.definition = definition; // mandatory\r\n    this.semanticSpec = ''; // used for translations\r\n    this.isGlobal = definition ? definition.isGlobal : false;\r\n    this.isPrototype = isProto || false; // optional\r\n    CustomReporterBlockMorph.uber.init.call(this, isPredicate, true); // sil.\r\n    this.category = definition.category;\r\n    this.variables = new VariableFrame();\r\n    this.initializeVariables();\r\n    this.selector = 'evaluateCustomBlock';\r\n    if (definition) { // needed for de-serializing\r\n        this.refresh();\r\n    }\r\n};\r\n\r\nCustomReporterBlockMorph.prototype.initializeVariables =\r\n    CustomCommandBlockMorph.prototype.initializeVariables;\r\n\r\nCustomReporterBlockMorph.prototype.refresh = function (aDefinition) {\r\n    var def = aDefinition || this.definition;\r\n    CustomCommandBlockMorph.prototype.refresh.call(this, aDefinition, true);\r\n    if (!this.isPrototype) {\r\n        this.isPredicate = (def.type === 'predicate');\r\n    }\r\n    if (this.parent instanceof SyntaxElementMorph) {\r\n        this.parent.cachedInputs = null;\r\n    }\r\n    this.drawNew();\r\n};\r\n\r\nCustomReporterBlockMorph.prototype.mouseClickLeft = function () {\r\n    if (!this.isPrototype) {\r\n        return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);\r\n    }\r\n    this.edit();\r\n};\r\n\r\nCustomReporterBlockMorph.prototype.placeHolder\r\n    = CustomCommandBlockMorph.prototype.placeHolder;\r\n\r\nCustomReporterBlockMorph.prototype.parseSpec\r\n    = CustomCommandBlockMorph.prototype.parseSpec;\r\n\r\nCustomReporterBlockMorph.prototype.edit\r\n    = CustomCommandBlockMorph.prototype.edit;\r\n\r\nCustomReporterBlockMorph.prototype.labelPart\r\n    = CustomCommandBlockMorph.prototype.labelPart;\r\n\r\nCustomReporterBlockMorph.prototype.upvarFragmentNames\r\n    = CustomCommandBlockMorph.prototype.upvarFragmentNames;\r\n\r\nCustomReporterBlockMorph.prototype.upvarFragmentName\r\n    = CustomCommandBlockMorph.prototype.upvarFragmentName;\r\n\r\nCustomReporterBlockMorph.prototype.inputFragmentNames\r\n    = CustomCommandBlockMorph.prototype.inputFragmentNames;\r\n\r\nCustomReporterBlockMorph.prototype.specFromFragments\r\n    = CustomCommandBlockMorph.prototype.specFromFragments;\r\n\r\nCustomReporterBlockMorph.prototype.blockSpecFromFragments\r\n    = CustomCommandBlockMorph.prototype.blockSpecFromFragments;\r\n\r\nCustomReporterBlockMorph.prototype.declarationsFromFragments\r\n    = CustomCommandBlockMorph.prototype.declarationsFromFragments;\r\n\r\nCustomReporterBlockMorph.prototype.refreshPrototype\r\n    = CustomCommandBlockMorph.prototype.refreshPrototype;\r\n\r\nCustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes\r\n    = CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes;\r\n\r\nCustomReporterBlockMorph.prototype.restoreInputs\r\n    = CustomCommandBlockMorph.prototype.restoreInputs;\r\n\r\nCustomReporterBlockMorph.prototype.refreshDefaults\r\n    = CustomCommandBlockMorph.prototype.refreshDefaults;\r\n\r\nCustomReporterBlockMorph.prototype.isInUse\r\n    = CustomCommandBlockMorph.prototype.isInUse;\r\n\r\n// CustomReporterBlockMorph menu:\r\n\r\nCustomReporterBlockMorph.prototype.userMenu\r\n    = CustomCommandBlockMorph.prototype.userMenu;\r\n\r\nCustomReporterBlockMorph.prototype.duplicateBlockDefinition\r\n    = CustomCommandBlockMorph.prototype.duplicateBlockDefinition;\r\n\r\nCustomReporterBlockMorph.prototype.deleteBlockDefinition\r\n    = CustomCommandBlockMorph.prototype.deleteBlockDefinition;\r\n\r\n// CustomReporterBlockMorph events:\r\n\r\n// hover help - commented out for now\r\n/*\r\nCustomReporterBlockMorph.prototype.mouseEnter\r\n    = CustomCommandBlockMorph.prototype.mouseEnter;\r\n\r\nCustomReporterBlockMorph.prototype.mouseLeave\r\n    = CustomCommandBlockMorph.prototype.mouseLeave;\r\n*/\r\n\r\n// CustomReporterBlockMorph bubble help:\r\n\r\nCustomReporterBlockMorph.prototype.bubbleHelp\r\n    = CustomCommandBlockMorph.prototype.bubbleHelp;\r\n\r\nCustomReporterBlockMorph.prototype.popUpbubbleHelp\r\n    = CustomCommandBlockMorph.prototype.popUpbubbleHelp;\r\n\r\n// CustomReporterBlockMorph relabelling\r\n\r\nCustomReporterBlockMorph.prototype.relabel\r\n    = CustomCommandBlockMorph.prototype.relabel;\r\n\r\nCustomReporterBlockMorph.prototype.alternatives\r\n    = CustomCommandBlockMorph.prototype.alternatives;\r\n\r\n// JaggedBlockMorph ////////////////////////////////////////////////////\r\n\r\n/*\r\n    I am a reporter block with jagged left and right edges conveying the\r\n    appearance of having the broken out of a bigger block. I am used to\r\n    display input types in the long form input dialog.\r\n*/\r\n\r\n// JaggedBlockMorph inherits from ReporterBlockMorph:\r\n\r\nJaggedBlockMorph.prototype = new ReporterBlockMorph();\r\nJaggedBlockMorph.prototype.constructor = JaggedBlockMorph;\r\nJaggedBlockMorph.uber = ReporterBlockMorph.prototype;\r\n\r\n// JaggedBlockMorph preferences settings:\r\n\r\nJaggedBlockMorph.prototype.jag = 5;\r\n\r\n// JaggedBlockMorph instance creation:\r\n\r\nfunction JaggedBlockMorph(spec) {\r\n    this.init(spec);\r\n}\r\n\r\nJaggedBlockMorph.prototype.init = function (spec) {\r\n    JaggedBlockMorph.uber.init.call(this);\r\n    if (spec) {this.setSpec(spec); }\r\n    if (spec === '%cs') {\r\n        this.minWidth = 25;\r\n        this.fixLayout();\r\n    }\r\n};\r\n\r\n// JaggedBlockMorph drawing:\r\n\r\nJaggedBlockMorph.prototype.drawNew = function () {\r\n    var context;\r\n\r\n    this.cachedClr = this.color.toString();\r\n    this.cachedClrBright = this.bright();\r\n    this.cachedClrDark = this.dark();\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = this.cachedClr;\r\n\r\n    this.drawBackground(context);\r\n    if (!MorphicPreferences.isFlat) {\r\n        this.drawEdges(context);\r\n    }\r\n\r\n    // erase holes\r\n    this.eraseHoles(context);\r\n};\r\n\r\nJaggedBlockMorph.prototype.drawBackground = function (context) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        jags = Math.round(h / this.jag),\r\n        delta = h / jags,\r\n        i,\r\n        y;\r\n\r\n    context.fillStyle = this.cachedClr;\r\n    context.beginPath();\r\n\r\n    context.moveTo(0, 0);\r\n    context.lineTo(w, 0);\r\n\r\n    y = 0;\r\n    for (i = 0; i < jags; i += 1) {\r\n        y += delta / 2;\r\n        context.lineTo(w - this.jag / 2, y);\r\n        y += delta / 2;\r\n        context.lineTo(w, y);\r\n    }\r\n\r\n    context.lineTo(0, h);\r\n    y = h;\r\n    for (i = 0; i < jags; i += 1) {\r\n        y -= delta / 2;\r\n        context.lineTo(this.jag / 2, y);\r\n        y -= delta / 2;\r\n        context.lineTo(0, y);\r\n    }\r\n\r\n    context.closePath();\r\n    context.fill();\r\n};\r\n\r\nJaggedBlockMorph.prototype.drawEdges = function (context) {\r\n    var w = this.width(),\r\n        h = this.height(),\r\n        jags = Math.round(h / this.jag),\r\n        delta = h / jags,\r\n        shift = this.edge / 2,\r\n        gradient,\r\n        i,\r\n        y;\r\n\r\n    context.lineWidth = this.edge;\r\n    context.lineJoin = 'round';\r\n    context.lineCap = 'round';\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        this.edge\r\n    );\r\n    gradient.addColorStop(0, this.cachedClrBright);\r\n    gradient.addColorStop(1, this.cachedClr);\r\n    context.strokeStyle = gradient;\r\n\r\n    context.beginPath();\r\n    context.moveTo(shift, shift);\r\n    context.lineTo(w - shift, shift);\r\n    context.stroke();\r\n\r\n    y = 0;\r\n    for (i = 0; i < jags; i += 1) {\r\n        context.strokeStyle = this.cachedClrDark;\r\n        context.beginPath();\r\n        context.moveTo(w - shift, y);\r\n        y += delta / 2;\r\n        context.lineTo(w - this.jag / 2 - shift, y);\r\n        context.stroke();\r\n        y += delta / 2;\r\n    }\r\n\r\n    gradient = context.createLinearGradient(\r\n        0,\r\n        h - this.edge,\r\n        0,\r\n        h\r\n    );\r\n    gradient.addColorStop(0, this.cachedClr);\r\n    gradient.addColorStop(1, this.cachedClrDark);\r\n    context.strokeStyle = gradient;\r\n    context.beginPath();\r\n    context.moveTo(w - shift, h - shift);\r\n    context.lineTo(shift, h - shift);\r\n    context.stroke();\r\n\r\n    y = h;\r\n    for (i = 0; i < jags; i += 1) {\r\n        context.strokeStyle = this.cachedClrBright;\r\n        context.beginPath();\r\n        context.moveTo(shift, y);\r\n        y -= delta / 2;\r\n        context.lineTo(this.jag / 2 + shift, y);\r\n        context.stroke();\r\n        y -= delta / 2;\r\n    }\r\n};\r\n\r\n// BlockDialogMorph ////////////////////////////////////////////////////\r\n\r\n// BlockDialogMorph inherits from DialogBoxMorph:\r\n\r\nBlockDialogMorph.prototype = new DialogBoxMorph();\r\nBlockDialogMorph.prototype.constructor = BlockDialogMorph;\r\nBlockDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// BlockDialogMorph instance creation:\r\n\r\nfunction BlockDialogMorph(target, action, environment) {\r\n    this.init(target, action, environment);\r\n}\r\n\r\nBlockDialogMorph.prototype.init = function (target, action, environment) {\r\n    // additional properties:\r\n    this.blockType = 'command';\r\n    this.category = 'other';\r\n    this.isGlobal = true;\r\n    this.types = null;\r\n    this.categories = null;\r\n\r\n    // initialize inherited properties:\r\n    BlockDialogMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.key = 'makeABlock';\r\n\r\n    this.types = new AlignmentMorph('row', this.padding);\r\n    this.add(this.types);\r\n    this.scopes = new AlignmentMorph('row', this.padding);\r\n    this.add(this.scopes);\r\n\r\n    this.categories = new BoxMorph();\r\n    this.categories.color = SpriteMorph.prototype.paletteColor.lighter(8);\r\n    this.categories.borderColor = this.categories.color.lighter(40);\r\n    this.createCategoryButtons();\r\n    this.fixCategoriesLayout();\r\n    this.add(this.categories);\r\n\r\n    this.createTypeButtons();\r\n    this.creatpanel_LefteButtons();\r\n    this.fixLayout();\r\n};\r\n\r\nBlockDialogMorph.prototype.openForChange = function (\r\n    title,\r\n    category,\r\n    type,\r\n    world,\r\n    pic,\r\n    preventTypeChange // <bool>\r\n) {\r\n    var clr = SpriteMorph.prototype.blockColor[category];\r\n    this.key = 'changeABlock';\r\n    this.category = category;\r\n    this.blockType = type;\r\n\r\n    this.categories.children.forEach(function (each) {\r\n        each.refresh();\r\n    });\r\n    this.types.children.forEach(function (each) {\r\n        each.setColor(clr);\r\n        each.refresh();\r\n    });\r\n\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n    this.addButton('ok', 'OK');\r\n    this.addButton('cancel', 'Cancel');\r\n    if (preventTypeChange) {\r\n        this.types.destroy();\r\n        this.types = null;\r\n    }\r\n    this.scopes.destroy();\r\n    this.scopes = null;\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.popUp(world);\r\n};\r\n\r\n// category buttons\r\n\r\nBlockDialogMorph.prototype.createCategoryButtons = function () {\r\n    var myself = this,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n    SpriteMorph.prototype.categories.forEach(function (cat) {\r\n        myself.addCategoryButton(cat);\r\n    });\r\n    Morph.prototype.trackChanges = oldFlag;\r\n};\r\n\r\nBlockDialogMorph.prototype.addCategoryButton = function (category) {\r\n    var labelWidth = 75,\r\n        myself = this,\r\n        colors = [\r\n            SpriteMorph.prototype.paletteColor,\r\n            SpriteMorph.prototype.paletteColor.darker(50),\r\n            SpriteMorph.prototype.blockColor[category]\r\n        ],\r\n        button;\r\n\r\n    button = new ToggleButtonMorph(\r\n        colors,\r\n        this, // this block dialog box is the target\r\n        function () {\r\n            myself.category = category;\r\n            myself.categories.children.forEach(function (each) {\r\n                each.refresh();\r\n            });\r\n            if (myself.types) {\r\n                myself.types.children.forEach(function (each) {\r\n                    each.setColor(colors[2]);\r\n                });\r\n            }\r\n            myself.edit();\r\n        },\r\n        category[0].toUpperCase().concat(category.slice(1)), // UCase label\r\n        function () {return myself.category === category; }, // query\r\n        null, // env\r\n        null, // hint\r\n        null, // template cache\r\n        labelWidth, // minWidth\r\n        true // has preview\r\n    );\r\n\r\n    button.corner = 8;\r\n    button.padding = 0;\r\n    button.labelShadowOffset = new Point(-1, -1);\r\n    button.labelShadowColor = colors[1];\r\n    button.labelColor = IDE_Morph.prototype.buttonLabelColor;\r\n    button.contrast = this.buttonContrast;\r\n    button.fixLayout();\r\n    button.refresh();\r\n    this.categories.add(button);\r\n    return button;\r\n};\r\n\r\nBlockDialogMorph.prototype.fixCategoriesLayout = function () {\r\n    var buttonWidth = this.categories.children[0].width(), // all the same\r\n        buttonHeight = this.categories.children[0].height(), // all the same\r\n        xPadding = 15,\r\n        yPadding = 2,\r\n        border = 10, // this.categories.border,\r\n        rows =  Math.ceil((this.categories.children.length) / 2),\r\n        l = this.categories.left(),\r\n        t = this.categories.top(),\r\n        i = 0,\r\n        row,\r\n        col,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    this.categories.children.forEach(function (button) {\r\n        i += 1;\r\n        row = Math.ceil(i / 2);\r\n        col = 2 - (i % 2);\r\n        button.setPosition(new Point(\r\n            l + (col * xPadding + ((col - 1) * buttonWidth)),\r\n            t + (row * yPadding + ((row - 1) * buttonHeight) + border)\r\n        ));\r\n    });\r\n\r\n    if (MorphicPreferences.isFlat) {\r\n        this.categories.corner = 0;\r\n        this.categories.border = 0;\r\n        this.categories.edge = 0;\r\n    }\r\n    this.categories.setExtent(new Point(\r\n        3 * xPadding + 2 * buttonWidth,\r\n        (rows + 1) * yPadding + rows * buttonHeight + 2 * border\r\n    ));\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.categories.changed();\r\n};\r\n\r\n// type radio buttons\r\n\r\nBlockDialogMorph.prototype.createTypeButtons = function () {\r\n    var block,\r\n        myself = this,\r\n        clr = SpriteMorph.prototype.blockColor[this.category];\r\n\r\n\r\n    block = new CommandBlockMorph();\r\n    block.setColor(clr);\r\n    block.setSpec(localize('Command'));\r\n    this.addBlockTypeButton(\r\n        function () {myself.setType('command'); },\r\n        block,\r\n        function () {return myself.blockType === 'command'; }\r\n    );\r\n\r\n    block = new ReporterBlockMorph();\r\n    block.setColor(clr);\r\n    block.setSpec(localize('Reporter'));\r\n    this.addBlockTypeButton(\r\n        function () {myself.setType('reporter'); },\r\n        block,\r\n        function () {return myself.blockType === 'reporter'; }\r\n    );\r\n\r\n    block = new ReporterBlockMorph(true);\r\n    block.setColor(clr);\r\n    block.setSpec(localize('Predicate'));\r\n    this.addBlockTypeButton(\r\n        function () {myself.setType('predicate'); },\r\n        block,\r\n        function () {return myself.blockType === 'predicate'; }\r\n    );\r\n};\r\n\r\nBlockDialogMorph.prototype.addBlockTypeButton = function (\r\n    action,\r\n    element,\r\n    query\r\n) {\r\n    var button = new ToggleElementMorph(\r\n        this,\r\n        action,\r\n        element,\r\n        query,\r\n        null,\r\n        null,\r\n        'rebuild'\r\n    );\r\n    button.refresh();\r\n    this.types.add(button);\r\n    return button;\r\n};\r\n\r\nBlockDialogMorph.prototype.addTypeButton = function (action, label, query) {\r\n    var button = new ToggleMorph(\r\n        'radiobutton',\r\n        this,\r\n        action,\r\n        label,\r\n        query\r\n    );\r\n    button.edge = this.buttonEdge / 2;\r\n    button.outline = this.buttonOutline / 2;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n    button.contrast = this.buttonContrast;\r\n\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    this.types.add(button);\r\n    return button;\r\n};\r\n\r\nBlockDialogMorph.prototype.setType = function (blockType) {\r\n    this.blockType = blockType || this.blockType;\r\n    this.types.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\n// scope radio buttons\r\n\r\nBlockDialogMorph.prototype.creatpanel_LefteButtons = function () {\r\n    var myself = this;\r\n\r\n    this.addScopeButton(\r\n        function () {myself.setScope('global'); },\r\n        \"for all sprites\",\r\n        function () {return myself.isGlobal; }\r\n    );\r\n    this.addScopeButton(\r\n        function () {myself.setScope('local'); },\r\n        \"for this sprite only\",\r\n        function () {return !myself.isGlobal; }\r\n    );\r\n};\r\n\r\nBlockDialogMorph.prototype.addScopeButton = function (action, label, query) {\r\n    var button = new ToggleMorph(\r\n        'radiobutton',\r\n        this,\r\n        action,\r\n        label,\r\n        query\r\n    );\r\n    button.edge = this.buttonEdge / 2;\r\n    button.outline = this.buttonOutline / 2;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n    button.contrast = this.buttonContrast;\r\n\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    this.scopes.add(button);\r\n    return button;\r\n};\r\n\r\n\r\nBlockDialogMorph.prototype.setScope = function (varType) {\r\n    this.isGlobal = (varType === 'global');\r\n    this.scopes.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\n// other ops\r\n\r\nBlockDialogMorph.prototype.getInput = function () {\r\n    var spec, def, body;\r\n    if (this.body instanceof InputFieldMorph) {\r\n        spec = this.normalizeSpaces(this.body.getValue());\r\n    }\r\n    def = new CustomBlockDefinition(spec);\r\n    def.type = this.blockType;\r\n    def.category = this.category;\r\n    def.isGlobal = this.isGlobal;\r\n    if (def.type === 'reporter' || def.type === 'predicate') {\r\n        body = Process.prototype.reify.call(\r\n            null,\r\n            SpriteMorph.prototype.blockForSelector('doReport'),\r\n            new List(),\r\n            true // ignore empty slots for custom block reification\r\n        );\r\n        body.outerContext = null;\r\n        def.body = body;\r\n    }\r\n    return def;\r\n};\r\n\r\nBlockDialogMorph.prototype.fixLayout = function () {\r\n    var th = fontHeight(this.titleFontSize) + this.titlePadding * 2;\r\n\r\n    if (this.body) {\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.silentSetWidth(this.body.width() + this.padding * 2);\r\n        this.silentSetHeight(\r\n            this.body.height()\r\n                + this.padding * 2\r\n                + th\r\n        );\r\n        if (this.categories) {\r\n            this.categories.setCenter(this.body.center());\r\n            this.categories.setTop(this.body.top());\r\n            this.body.setTop(this.categories.bottom() + this.padding);\r\n            this.silentSetHeight(\r\n                this.height()\r\n                    + this.categories.height()\r\n                    + this.padding\r\n            );\r\n        }\r\n    } else if (this.head) { // when changing an existing prototype\r\n        if (this.types) {\r\n            this.types.fixLayout();\r\n            this.silentSetWidth(\r\n                Math.max(this.types.width(), this.head.width())\r\n                    + this.padding * 2\r\n            );\r\n        } else {\r\n            this.silentSetWidth(\r\n                Math.max(this.categories.width(), this.head.width())\r\n                    + this.padding * 2\r\n            );\r\n        }\r\n        this.head.setCenter(this.center());\r\n        this.head.setTop(th + this.padding);\r\n        this.silentSetHeight(\r\n            this.head.height()\r\n                + this.padding * 2\r\n                + th\r\n        );\r\n        if (this.categories) {\r\n            this.categories.setCenter(this.center());\r\n            this.categories.setTop(this.head.bottom() + this.padding);\r\n            this.silentSetHeight(\r\n                this.height()\r\n                    + this.categories.height()\r\n                    + this.padding\r\n            );\r\n        }\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n    }\r\n\r\n    if (this.types) {\r\n        this.types.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.types.height()\r\n                    + this.padding\r\n        );\r\n        this.silentSetWidth(Math.max(\r\n            this.width(),\r\n            this.types.width() + this.padding * 2\r\n        ));\r\n        this.types.setCenter(this.center());\r\n        if (this.body) {\r\n            this.types.setTop(this.body.bottom() + this.padding);\r\n        } else if (this.categories) {\r\n            this.types.setTop(this.categories.bottom() + this.padding);\r\n        }\r\n    }\r\n\r\n    if (this.scopes) {\r\n        this.scopes.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.scopes.height()\r\n                    + (this.padding / 3)\r\n        );\r\n        this.silentSetWidth(Math.max(\r\n            this.width(),\r\n            this.scopes.width() + this.padding * 2\r\n        ));\r\n        this.scopes.setCenter(this.center());\r\n        if (this.types) {\r\n            this.scopes.setTop(this.types.bottom() + (this.padding / 3));\r\n        }\r\n    }\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.buttons.height()\r\n                    + this.padding\r\n        );\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n};\r\n\r\nBlockDialogMorph.prototype.accept = function () {\r\n    if ((this.body instanceof InputFieldMorph) &&\r\n            (this.normalizeSpaces(this.body.getValue()) === '')) {\r\n        this.edit();\r\n    } else {\r\n        BlockDialogMorph.uber.accept.call(this);\r\n    }\r\n};\r\n\r\n// BlockEditorMorph ////////////////////////////////////////////////////\r\n\r\n// BlockEditorMorph inherits from DialogBoxMorph:\r\n\r\nBlockEditorMorph.prototype = new DialogBoxMorph();\r\nBlockEditorMorph.prototype.constructor = BlockEditorMorph;\r\nBlockEditorMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// BlockEditorMorph instance creation:\r\n\r\nfunction BlockEditorMorph(definition, target) {\r\n    this.init(definition, target);\r\n}\r\n\r\nBlockEditorMorph.prototype.init = function (definition, target) {\r\n    var scripts, proto, scriptsFrame, block, comment, myself = this,\r\n        isLive = Process.prototype.enableLiveCoding ||\r\n            Process.prototype.enableSingleStepping;\r\n\r\n    // additional properties:\r\n    this.definition = definition;\r\n    this.translations = definition.translationsAsText();\r\n    this.handle = null;\r\n\r\n    // initialize inherited properties:\r\n    BlockEditorMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        function () {myself.updateDefinition(); },\r\n        target\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.key = 'editBlock' + definition.spec;\r\n    this.labelString = this.definition.isGlobal ? 'Block Editor'\r\n    \t\t: 'Method Editor';\r\n    this.createLabel();\r\n\r\n    // create scripting area\r\n    scripts = new ScriptsMorph();\r\n    scripts.rejectsHats = true;\r\n    scripts.isDraggable = false;\r\n    scripts.color = IDE_Morph.prototype.groupColor;\r\n    scripts.cachedTexture = IDE_Morph.prototype.scriptsPaneTexture;\r\n    scripts.cleanUpMargin = 10;\r\n\r\n    proto = new PrototypeHatBlockMorph(this.definition);\r\n    proto.setPosition(scripts.position().add(10));\r\n    if (definition.comment !== null) {\r\n        comment = definition.comment.fullCopy();\r\n        proto.comment = comment;\r\n        comment.block = proto;\r\n    }\r\n    if (definition.body !== null) {\r\n        proto.nextBlock(isLive ? definition.body.expression\r\n                : definition.body.expression.fullCopy()\r\n        );\r\n    }\r\n\r\n    scripts.add(proto);\r\n    proto.fixBlockColor(null, true);\r\n    proto.drawNew();\r\n\r\n    this.definition.scripts.forEach(function (element) {\r\n        block = element.fullCopy();\r\n        block.setPosition(scripts.position().add(element.position()));\r\n        scripts.add(block);\r\n        if (block instanceof BlockMorph) {\r\n            block.allComments().forEach(function (comment) {\r\n                comment.align(block);\r\n            });\r\n        }\r\n    });\r\n    proto.allComments().forEach(function (comment) {\r\n        comment.align(proto);\r\n    });\r\n\r\n    scriptsFrame = new ScrollFrameMorph(scripts);\r\n    scriptsFrame.padding = 10;\r\n    scriptsFrame.growth = 50;\r\n    scriptsFrame.isDraggable = false;\r\n    scriptsFrame.acceptsDrops = false;\r\n    scriptsFrame.contents.acceptsDrops = true;\r\n    scripts.scrollFrame = scriptsFrame;\r\n    scripts.updateToolbar();\r\n\r\n    this.addBody(scriptsFrame);\r\n    this.addButton('ok', 'OK');\r\n    if (!isLive) {\r\n        this.addButton('updateDefinition', 'Apply');\r\n        this.addButton('cancel', 'Cancel');\r\n    }\r\n\r\n    this.setExtent(new Point(375, 300)); // normal initial extent\r\n    this.fixLayout();\r\n    scripts.fixMultiArgs();\r\n\r\n    block = proto.parts()[0];\r\n    block.forceNormalColoring();\r\n    block.fixBlockColor(proto, true);\r\n};\r\n\r\nBlockEditorMorph.prototype.popUp = function () {\r\n    var world = this.target.world();\r\n\r\n    if (world) {\r\n        BlockEditorMorph.uber.popUp.call(this, world);\r\n        this.setInitialDimensions();\r\n        this.handle = new HandleMorph(\r\n            this,\r\n            280,\r\n            220,\r\n            this.corner,\r\n            this.corner\r\n        );\r\n        world.keyboardReceiver = null;\r\n    }\r\n};\r\n\r\nBlockEditorMorph.prototype.justDropped = function () {\r\n    // override the inherited default behavior, which is to\r\n    // give keyboard focus to dialog boxes, as in this case\r\n    // we want Snap-global keyboard-shortcuts like ctrl-f\r\n    // to still work\r\n    nop();\r\n\r\n};\r\n\r\n// BlockEditorMorph ops\r\n\r\nBlockEditorMorph.prototype.accept = function (origin) {\r\n    // check DialogBoxMorph comment for accept()\r\n    if (origin instanceof CursorMorph) {return; }\r\n    if (this.action) {\r\n        if (typeof this.target === 'function') {\r\n            if (typeof this.action === 'function') {\r\n                this.target.call(this.environment, this.action.call());\r\n            } else {\r\n                this.target.call(this.environment, this.action);\r\n            }\r\n        } else {\r\n            if (typeof this.action === 'function') {\r\n                this.action.call(this.target, this.getInput());\r\n            } else { // assume it's a String\r\n                this.target[this.action](this.getInput());\r\n            }\r\n        }\r\n    }\r\n    this.close();\r\n};\r\n\r\nBlockEditorMorph.prototype.cancel = function (origin) {\r\n    if (origin instanceof CursorMorph) {return; }\r\n    //this.refreshAllBlockInstances();\r\n    this.close();\r\n};\r\n\r\nBlockEditorMorph.prototype.close = function () {\r\n    var doubles, block,\r\n        myself = this;\r\n\r\n    // assert that no scope conflicts exists, i.e. that a global\r\n    // definition doesn't contain any local custom blocks, as they\r\n    // will be rendered \"Obsolete!\" when reloading the project\r\n    if (this.definition.isGlobal) {\r\n        block = detect(\r\n            this.body.contents.allChildren(),\r\n            function (morph) {\r\n                return morph.definition && !morph.definition.isGlobal;\r\n            }\r\n        );\r\n        if (block) {\r\n            block = block.definition.blockInstance();\r\n            block.addShadow();\r\n            new DialogBoxMorph().inform(\r\n                'Local Block(s) in Global Definition',\r\n                'This global block definition contains one or more\\n'\r\n                    + 'local custom blocks which must be removed first.',\r\n                myself.world(),\r\n                block.fullImage()\r\n            );\r\n            return;\r\n        }\r\n    }\r\n\r\n    // allow me to disappear only when name collisions\r\n    // have been resolved\r\n    doubles = this.target.doubleDefinitionsFor(this.definition);\r\n    if (doubles.length > 0) {\r\n        block = doubles[0].blockInstance();\r\n        block.addShadow();\r\n        new DialogBoxMorph(this, 'consolidateDoubles', this).askYesNo(\r\n            'Same Named Blocks',\r\n            'Another custom block with this name exists.\\n'\r\n                + 'Would you like to replace it?',\r\n            myself.world(),\r\n            block.fullImage()\r\n        );\r\n        return;\r\n    }\r\n\r\n    this.destroy();\r\n};\r\n\r\nBlockEditorMorph.prototype.consolidateDoubles = function () {\r\n    this.target.replaceDoubleDefinitionsFor(this.definition);\r\n    this.destroy();\r\n};\r\n\r\nBlockEditorMorph.prototype.refreshAllBlockInstances = function (oldSpec) {\r\n    var def = this.definition,\r\n        template = this.target.paletteBlockInstance(def);\r\n\r\n    if (this.definition.isGlobal) {\r\n        this.target.allBlockInstances(this.definition).forEach(\r\n            function (block) {\r\n                block.refresh();\r\n            }\r\n        );\r\n    } else {\r\n        this.target.allDependentInvocationsOf(oldSpec).forEach(\r\n            function (block) {\r\n                block.refresh(def);\r\n            }\r\n        );\r\n    }\r\n    if (template) {\r\n        template.refreshDefaults();\r\n    }\r\n};\r\n\r\nBlockEditorMorph.prototype.updateDefinition = function () {\r\n    var head, ide,\r\n        oldSpec = this.definition.blockSpec(),\r\n        pos = this.body.contents.position(),\r\n        element,\r\n        myself = this;\r\n\r\n    this.definition.receiver = this.target; // only for serialization\r\n    this.definition.spec = this.prototypeSpec();\r\n    this.definition.declarations = this.prototypeSlots();\r\n    this.definition.variableNames = this.variableNames();\r\n    this.definition.scripts = [];\r\n    this.definition.updateTranslations(this.translations);\r\n    this.definition.cachedTranslation = null;\r\n    this.definition.editorDimensions = this.bounds.copy();\r\n    this.definition.cachedIsRecursive = null; // flush the cache, don't update\r\n\r\n    this.body.contents.children.forEach(function (morph) {\r\n        if (morph instanceof PrototypeHatBlockMorph) {\r\n            head = morph;\r\n        } else if (morph instanceof BlockMorph ||\r\n                (morph instanceof CommentMorph && !morph.block)) {\r\n            element = morph.fullCopy();\r\n            element.parent = null;\r\n            element.setPosition(morph.position().subtract(pos));\r\n            myself.definition.scripts.push(element);\r\n        }\r\n    });\r\n\r\n    if (head) {\r\n        if (this.definition.category !== head.blockCategory) {\r\n            this.target.shadowAttribute('scripts');\r\n        }\r\n        this.definition.category = head.blockCategory;\r\n        this.definition.type = head.type;\r\n        if (head.comment) {\r\n            this.definition.comment = head.comment.fullCopy();\r\n            this.definition.comment.block = true; // serialize in short form\r\n        } else {\r\n            this.definition.comment = null;\r\n        }\r\n    }\r\n\r\n    this.definition.body = this.context(head);\r\n    this.refreshAllBlockInstances(oldSpec);\r\n    ide = this.target.parentThatIsA(IDE_Morph);\r\n    ide.flushPaletteCache();\r\n    ide.refreshPalette();\r\n};\r\n\r\nBlockEditorMorph.prototype.context = function (prototypeHat) {\r\n    // answer my script reified for deferred execution\r\n    // if no prototypeHat is given, my body is scanned\r\n    var head, topBlock, stackFrame;\r\n\r\n    head = prototypeHat || detect(\r\n        this.body.contents.children,\r\n        function (c) {return c instanceof PrototypeHatBlockMorph; }\r\n    );\r\n    topBlock = head.nextBlock();\r\n    if (topBlock === null) {\r\n        return null;\r\n    }\r\n    topBlock.allChildren().forEach(function (c) {\r\n        if (c instanceof BlockMorph) {c.cachedInputs = null; }\r\n    });\r\n    stackFrame = Process.prototype.reify.call(\r\n        null,\r\n        topBlock,\r\n        new List(this.definition.inputNames()),\r\n        true // ignore empty slots for custom block reification\r\n    );\r\n    stackFrame.outerContext = null;\r\n    return stackFrame;\r\n};\r\n\r\nBlockEditorMorph.prototype.prototypeSpec = function () {\r\n    // answer the spec represented by my (edited) block prototype\r\n    return detect(\r\n        this.body.contents.children,\r\n        function (c) {return c instanceof PrototypeHatBlockMorph; }\r\n    ).parts()[0].specFromFragments();\r\n};\r\n\r\nBlockEditorMorph.prototype.prototypeSlots = function () {\r\n    // answer the slot declarations from my (edited) block prototype\r\n    return detect(\r\n        this.body.contents.children,\r\n        function (c) {return c instanceof PrototypeHatBlockMorph; }\r\n    ).parts()[0].declarationsFromFragments();\r\n};\r\n\r\nBlockEditorMorph.prototype.variableNames = function () {\r\n    // answer the variable declarations from my prototype hat\r\n    return detect(\r\n        this.body.contents.children,\r\n        function (c) {return c instanceof PrototypeHatBlockMorph; }\r\n    ).variableNames();\r\n};\r\n\r\n// BlockEditorMorph translation\r\n\r\nBlockEditorMorph.prototype.editTranslations = function () {\r\n    var myself = this,\r\n    \tblock = this.definition.blockInstance();\r\n    block.addShadow(new Point(3, 3));\r\n    new DialogBoxMorph(\r\n        myself,\r\n        function (text) {\r\n            myself.translations = text;\r\n        },\r\n        myself\r\n    ).promptCode(\r\n        'Custom Block Translations',\r\n        myself.translations,\r\n        myself.world(),\r\n        block.fullImage(),\r\n        myself.definition.abstractBlockSpec() +\r\n            '\\n\\n' +\r\n            localize('Enter one translation per line. ' +\r\n                'use colon (\":\") as lang/spec delimiter\\n' +\r\n                'and underscore (\"_\") as placeholder for an input, ' +\r\n                'e.g.:\\n\\nen:say _ for _ secs')\r\n    );\r\n};\r\n\r\n// BlockEditorMorph layout\r\n\r\nBlockEditorMorph.prototype.setInitialDimensions = function () {\r\n    var world = this.world(),\r\n        mex = world.extent().subtract(new Point(this.padding, this.padding)),\r\n        th = fontHeight(this.titleFontSize) + this.titlePadding * 2,\r\n        bh = this.buttons.height();\r\n\r\n    if (this.definition.editorDimensions) {\r\n        this.setPosition(this.definition.editorDimensions.origin);\r\n        this.setExtent(this.definition.editorDimensions.extent().min(mex));\r\n        this.keepWithin(world);\r\n        return;\r\n    }\r\n    this.setExtent(\r\n        this.body.contents.extent().add(\r\n            new Point(this.padding, this.padding + th + bh)\r\n        ).min(mex)\r\n    );\r\n    this.setCenter(this.world().center());\r\n};\r\n\r\nBlockEditorMorph.prototype.fixLayout = function () {\r\n    var th = fontHeight(this.titleFontSize) + this.titlePadding * 2;\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.fixLayout();\r\n    }\r\n\r\n    if (this.body) {\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.body.setExtent(new Point(\r\n            this.width() - this.padding * 2,\r\n            this.height() - this.padding * 3 - th - this.buttons.height()\r\n        ));\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n    }\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n};\r\n\r\n// PrototypeHatBlockMorph /////////////////////////////////////////////\r\n\r\n// PrototypeHatBlockMorph inherits from HatBlockMorph:\r\n\r\nPrototypeHatBlockMorph.prototype = new HatBlockMorph();\r\nPrototypeHatBlockMorph.prototype.constructor = PrototypeHatBlockMorph;\r\nPrototypeHatBlockMorph.uber = HatBlockMorph.prototype;\r\n\r\n// PrototypeHatBlockMorph instance creation:\r\n\r\nfunction PrototypeHatBlockMorph(definition) {\r\n    this.init(definition);\r\n}\r\n\r\nPrototypeHatBlockMorph.prototype.init = function (definition) {\r\n    var proto = definition.prototypeInstance(),\r\n        vars;\r\n\r\n    this.definition = definition;\r\n\r\n    // additional attributes to store edited data\r\n    this.blockCategory = definition ? definition.category : null;\r\n    this.type = definition ? definition.type : null;\r\n\r\n    // init inherited stuff\r\n    HatBlockMorph.uber.init.call(this);\r\n    this.color = SpriteMorph.prototype.blockColor.control;\r\n    this.category = 'control';\r\n    this.add(proto);\r\n    if (definition.variableNames.length) {\r\n        vars = this.labelPart('%blockVars');\r\n        this.add(this.labelPart('%br'));\r\n        this.add(vars);\r\n        definition.variableNames.forEach(function (name) {\r\n            vars.addInput(name);\r\n        });\r\n    }\r\n    proto.refreshPrototypeSlotTypes(); // show slot type indicators\r\n    this.fixLayout();\r\n    proto.fixBlockColor(this, true);\r\n};\r\n\r\nPrototypeHatBlockMorph.prototype.mouseClickLeft = function () {\r\n    // relay the mouse click to my prototype block to\r\n    // pop-up a Block Dialog, unless the shift key\r\n    // is pressed, in which case initiate keyboard\r\n    // editing support\r\n\r\n    if (this.world().currentKey === 16) { // shift-clicked\r\n        return this.focus();\r\n    }\r\n    this.parts()[0].mouseClickLeft();\r\n};\r\n\r\nPrototypeHatBlockMorph.prototype.userMenu = function () {\r\n    return this.parts()[0].userMenu();\r\n};\r\n\r\n// PrototypeHatBlockMorph zebra coloring\r\n\r\nPrototypeHatBlockMorph.prototype.fixBlockColor = function (\r\n    nearestBlock,\r\n    isForced\r\n) {\r\n    var nearest = this.parts()[0] || nearestBlock;\r\n\r\n    if (!this.zebraContrast && !isForced) {\r\n        return;\r\n    }\r\n    if (!this.zebraContrast && isForced) {\r\n        return this.forceNormalColoring();\r\n    }\r\n\r\n    if (nearest.category === this.category) {\r\n        if (nearest.color.eq(this.color)) {\r\n            this.alternateBlockColor();\r\n        }\r\n    } else if (this.category && !this.color.eq(\r\n            SpriteMorph.prototype.blockColor[this.category]\r\n        )) {\r\n        this.alternateBlockColor();\r\n    }\r\n    if (isForced) {\r\n        this.fixChildrensBlockColor(true);\r\n    }\r\n};\r\n\r\n// PrototypeHatBlockMorph block instance variables\r\n\r\nPrototypeHatBlockMorph.prototype.variableNames = function (choice) {\r\n    var parts = this.parts();\r\n    if (parts.length < 3) {return []; }\r\n    return parts[2].evaluate();\r\n};\r\n\r\nPrototypeHatBlockMorph.prototype.enableBlockVars = function (choice) {\r\n    var prot = this.parts()[0];\r\n    if (choice === false) {\r\n        this.setSpec('%s', true);\r\n    } else {\r\n        this.setSpec('%s %br %blockVars', true);\r\n    }\r\n    this.replaceInput(this.parts()[0], prot);\r\n    this.spec = null;\r\n};\r\n\r\n// BlockLabelFragment //////////////////////////////////////////////////\r\n\r\n// BlockLabelFragment instance creation:\r\n\r\nfunction BlockLabelFragment(labelString) {\r\n    this.labelString = labelString || '';\r\n    this.type = '%s';    // null for label, a spec for an input\r\n    this.defaultValue = '';\r\n    this.options = '';\r\n    this.isReadOnly = false; // for input slots\r\n    this.isDeleted = false;\r\n}\r\n\r\n// accessing\r\n\r\nBlockLabelFragment.prototype.defSpecFragment = function () {\r\n    // answer a string representing my prototype's spec\r\n    var pref = this.type ? '%\\'' : '';\r\n    return this.isDeleted ?\r\n            '' : pref + this.labelString + (this.type ? '\\'' : '');\r\n};\r\n\r\nBlockLabelFragment.prototype.defTemplateSpecFragment = function () {\r\n    // answer a string representing my prototype's spec\r\n    // which also indicates my type, default value or arity\r\n    var suff = '';\r\n    if (!this.type) {return this.defSpecFragment(); }\r\n    if (this.isUpvar()) {\r\n        suff = ' \\u2191';\r\n    } else if (this.isMultipleInput()) {\r\n        suff = '...';\r\n    } else if (this.type === '%cs') {\r\n        suff = ' \\u03BB'; // ' [\\u03BB'\r\n    } else if (this.type === '%b') {\r\n        suff = ' ?';\r\n    } else if (this.type === '%l') {\r\n        suff = ' \\uFE19';\r\n    } else if (this.type === '%obj') {\r\n        suff = ' %turtleOutline';\r\n    } else if (contains(\r\n            ['%cmdRing', '%repRing', '%predRing', '%anyUE', '%boolUE'],\r\n            this.type\r\n        )) {\r\n        suff = ' \\u03BB';\r\n    } else if (this.defaultValue) {\r\n        if (this.type === '%n') {\r\n            suff = ' # = ' + this.defaultValue.toString();\r\n        } else { // 'any' or 'text'\r\n            suff = ' = ' + this.defaultValue.toString();\r\n        }\r\n    } else if (this.type === '%n') {\r\n        suff = ' #';\r\n    }\r\n    return this.labelString + suff;\r\n};\r\n\r\nBlockLabelFragment.prototype.blockSpecFragment = function () {\r\n    // answer a string representing my block spec\r\n    return this.isDeleted ? '' : this.type || this.labelString;\r\n};\r\n\r\nBlockLabelFragment.prototype.copy = function () {\r\n    var ans = new BlockLabelFragment(this.labelString);\r\n    ans.type = this.type;\r\n    ans.defaultValue = this.defaultValue;\r\n    ans.options = this.options;\r\n    ans.isReadOnly = this.isReadOnly;\r\n    return ans;\r\n};\r\n\r\n// arity\r\n\r\nBlockLabelFragment.prototype.isSingleInput = function () {\r\n    return !this.isMultipleInput() &&\r\n        (this.type !== '%upvar');\r\n};\r\n\r\nBlockLabelFragment.prototype.isMultipleInput = function () {\r\n    // answer true if the type begins with '%mult'\r\n    if (!this.type) {\r\n        return false; // not an input at all\r\n    }\r\n    return this.type.indexOf('%mult') > -1;\r\n};\r\n\r\nBlockLabelFragment.prototype.isUpvar = function () {\r\n    if (!this.type) {\r\n        return false; // not an input at all\r\n    }\r\n    return this.type === '%upvar';\r\n};\r\n\r\nBlockLabelFragment.prototype.setToSingleInput = function () {\r\n    if (!this.type) {return null; } // not an input at all\r\n    if (this.type === '%upvar') {\r\n        this.type = '%s';\r\n    } else {\r\n        this.type = this.singleInputType();\r\n    }\r\n};\r\n\r\nBlockLabelFragment.prototype.setToMultipleInput = function () {\r\n    if (!this.type) {return null; } // not an input at all\r\n    if (this.type === '%upvar') {\r\n        this.type = '%s';\r\n    }\r\n    this.type = '%mult'.concat(this.singleInputType());\r\n};\r\n\r\nBlockLabelFragment.prototype.setToUpvar = function () {\r\n    if (!this.type) {return null; } // not an input at all\r\n    this.type = '%upvar';\r\n};\r\n\r\nBlockLabelFragment.prototype.singleInputType = function () {\r\n    // answer the type of my input withtou any preceding '%mult'\r\n    if (!this.type) {\r\n        return null; // not an input at all\r\n    }\r\n    if (this.isMultipleInput()) {\r\n        return this.type.substr(5); // everything following '%mult'\r\n    }\r\n    return this.type;\r\n};\r\n\r\nBlockLabelFragment.prototype.setSingleInputType = function (type) {\r\n    if (!this.type || !this.isMultipleInput()) {\r\n        this.type = type;\r\n    } else {\r\n        this.type = '%mult'.concat(type);\r\n    }\r\n};\r\n\r\n// BlockLabelFragmentMorph ///////////////////////////////////////////////\r\n\r\n/*\r\n    I am a single word in a custom block prototype's label. I can be clicked\r\n    to edit my contents and to turn me into an input placeholder.\r\n*/\r\n\r\n// BlockLabelFragmentMorph inherits from StringMorph:\r\n\r\nBlockLabelFragmentMorph.prototype = new StringMorph();\r\nBlockLabelFragmentMorph.prototype.constructor = BlockLabelFragmentMorph;\r\nBlockLabelFragmentMorph.uber = StringMorph.prototype;\r\n\r\n// BlockLabelFragmentMorph instance creation:\r\n\r\nfunction BlockLabelFragmentMorph(text) {\r\n    this.init(text);\r\n}\r\n\r\nBlockLabelFragmentMorph.prototype.init = function (text) {\r\n    this.fragment = new BlockLabelFragment(text);\r\n    this.fragment.type = null;\r\n    this.sO = null; // temporary backup for shadowOffset\r\n    BlockLabelFragmentMorph.uber.init.call(\r\n        this,\r\n        text,\r\n        null, // font size\r\n        SyntaxElementMorph.prototype.labelFontStyle,\r\n        null, // bold\r\n        null, // italic\r\n        null, // numeric\r\n        null, // shadow offset\r\n        null, // shadow color\r\n        null, // color\r\n        SyntaxElementMorph.prototype.labelFontName\r\n    );\r\n};\r\n\r\n// BlockLabelFragmentMorph events:\r\n\r\nBlockLabelFragmentMorph.prototype.mouseEnter = function () {\r\n    this.sO = this.shadowOffset;\r\n    this.shadowOffset = this.sO.neg();\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nBlockLabelFragmentMorph.prototype.mouseLeave = function () {\r\n    this.shadowOffset = this.sO;\r\n    this.drawNew();\r\n    this.changed();\r\n};\r\n\r\nBlockLabelFragmentMorph.prototype.mouseClickLeft = function () {\r\n/*\r\n    make a copy of my fragment object and open an InputSlotDialog on it.\r\n    If the user acknowledges the DialogBox, assign the - edited - copy\r\n    of the fragment object to be my new fragment object and update the\r\n    custom block'label (the prototype in the block editor). Do not yet update\r\n    the definition and every block instance, as this happens only after\r\n    the user acknowledges and closes the block editor\r\n*/\r\n    var frag = this.fragment.copy(),\r\n        myself = this,\r\n        isPlaceHolder = this instanceof BlockLabelPlaceHolderMorph,\r\n        isOnlyElement = this.parent.parseSpec(this.parent.blockSpec).length\r\n            < 2;\r\n\r\n    new InputSlotDialogMorph(\r\n        frag,\r\n        null,\r\n        function () {myself.updateBlockLabel(frag); },\r\n        this,\r\n        this.parent.definition.category\r\n    ).open(\r\n        this instanceof BlockLabelFragmentMorph ?\r\n                'Edit label fragment' :\r\n                isPlaceHolder ? 'Create input name' : 'Edit input name',\r\n        frag.labelString,\r\n        this.world(),\r\n        null,\r\n        isPlaceHolder || isOnlyElement\r\n    );\r\n};\r\n\r\nBlockLabelFragmentMorph.prototype.updateBlockLabel = function (newFragment) {\r\n    var prot = this.parentThatIsA(BlockMorph);\r\n\r\n    this.fragment = newFragment;\r\n    if (prot) {\r\n        prot.refreshPrototype();\r\n    }\r\n};\r\n\r\nBlockLabelFragmentMorph.prototype.userMenu = function () {\r\n    // show a menu of built-in special symbols\r\n    var myself = this,\r\n        symbolColor = new Color(100, 100, 130),\r\n        menu = new MenuMorph(\r\n            function (string) {\r\n                var tuple = myself.text.split('-');\r\n                myself.changed();\r\n                tuple[0] = '$' + string;\r\n                myself.text = tuple.join('-');\r\n                myself.fragment.labelString = myself.text;\r\n                myself.parent.parent.changed();\r\n                myself.drawNew();\r\n                myself.changed();\r\n                myself.parent.parent.fixLayout();\r\n                myself.parent.parent.changed();\r\n            },\r\n            null,\r\n            this,\r\n            this.fontSize\r\n        );\r\n    SymbolMorph.prototype.names.forEach(function (name) {\r\n        menu.addItem(\r\n            [new SymbolMorph(name, menu.fontSize, symbolColor), name],\r\n            name\r\n        );\r\n    });\r\n    menu.addLine();\r\n    menu.addItem('\\u23CE ' + localize('new line'), 'nl');\r\n    return menu;\r\n};\r\n\r\n// BlockLabelPlaceHolderMorph ///////////////////////////////////////////////\r\n\r\n/*\r\n    I am a space between words or inputs in a custom block prototype's label.\r\n    When I am moused over I display a plus sign on a colored background\r\n    circle. I can be clicked to add a new word or input to the prototype.\r\n*/\r\n\r\n// BlockLabelPlaceHolderMorph inherits from StringMorph:\r\n\r\nBlockLabelPlaceHolderMorph.prototype = new StringMorph();\r\nBlockLabelPlaceHolderMorph.prototype.constructor = BlockLabelPlaceHolderMorph;\r\nBlockLabelPlaceHolderMorph.uber = StringMorph.prototype;\r\n\r\n// BlockLabelPlaceHolderMorph preferences settings\r\n\r\nBlockLabelPlaceHolderMorph.prototype.plainLabel = false; // always show (+)\r\n\r\n// BlockLabelPlaceHolderMorph instance creation:\r\n\r\nfunction BlockLabelPlaceHolderMorph() {\r\n    this.init();\r\n}\r\n\r\nBlockLabelPlaceHolderMorph.prototype.init = function () {\r\n    this.fragment = new BlockLabelFragment('');\r\n    this.fragment.type = '%s';\r\n    this.fragment.isDeleted = true;\r\n    this.isHighlighted = false;\r\n    this.isProtectedLabel = true; // doesn't participate in zebra coloring\r\n    BlockLabelFragmentMorph.uber.init.call(this, '+');\r\n};\r\n\r\n// BlockLabelPlaceHolderMorph drawing\r\n\r\nBlockLabelPlaceHolderMorph.prototype.drawNew = function () {\r\n    var context, width, x, y, cx, cy;\r\n\r\n    // set my text contents depending on the \"plainLabel\" flag\r\n    if (this.plainLabel) {\r\n        this.text = this.isHighlighted ? ' + ' : '';\r\n    }\r\n\r\n    // initialize my surface property\r\n    this.image = newCanvas();\r\n    context = this.image.getContext('2d');\r\n    context.font = this.font();\r\n\r\n    // set my extent\r\n    width = Math.max(\r\n        context.measureText(this.text).width\r\n            + Math.abs(this.shadowOffset.x),\r\n        1\r\n    );\r\n    this.bounds.corner = this.bounds.origin.add(\r\n        new Point(\r\n            width,\r\n            fontHeight(this.fontSize) + Math.abs(this.shadowOffset.y)\r\n        )\r\n    );\r\n    this.image.width = width;\r\n    this.image.height = this.height();\r\n\r\n    // draw background, if any\r\n    if (this.isHighlighted) {\r\n        cx = Math.floor(width / 2);\r\n        cy = Math.floor(this.height() / 2);\r\n        context.fillStyle = this.color.toString();\r\n        context.beginPath();\r\n        context.arc(\r\n            cx,\r\n            cy * 1.2,\r\n            Math.min(cx, cy),\r\n            radians(0),\r\n            radians(360),\r\n            false\r\n        );\r\n        context.closePath();\r\n        context.fill();\r\n    }\r\n\r\n    // prepare context for drawing text\r\n    context.font = this.font();\r\n    context.textAlign = 'left';\r\n    context.textBaseline = 'bottom';\r\n\r\n    // first draw the shadow, if any\r\n    if (this.shadowColor) {\r\n        x = Math.max(this.shadowOffset.x, 0);\r\n        y = Math.max(this.shadowOffset.y, 0);\r\n        context.fillStyle = this.shadowColor.toString();\r\n        context.fillText(this.text, x, fontHeight(this.fontSize) + y);\r\n    }\r\n\r\n    // now draw the actual text\r\n    x = Math.abs(Math.min(this.shadowOffset.x, 0));\r\n    y = Math.abs(Math.min(this.shadowOffset.y, 0));\r\n    context.fillStyle = this.isHighlighted ?\r\n            'white' : this.color.toString();\r\n    context.fillText(this.text, x, fontHeight(this.fontSize) + y);\r\n\r\n    // notify my parent of layout change\r\n    if (this.parent) {\r\n        if (this.parent.fixLayout) {\r\n            this.parent.fixLayout();\r\n        }\r\n        if (this.parent.parent instanceof PrototypeHatBlockMorph) {\r\n            this.parent.parent.fixLayout();\r\n        }\r\n    }\r\n};\r\n\r\n// BlockLabelPlaceHolderMorph events:\r\n\r\nBlockLabelPlaceHolderMorph.prototype.mouseEnter = function () {\r\n    var hat = this.parentThatIsA(PrototypeHatBlockMorph);\r\n    this.isHighlighted = true;\r\n    if (this.plainLabel && hat) {\r\n        hat.changed();\r\n        this.drawNew();\r\n        hat.changed();\r\n    } else {\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nBlockLabelPlaceHolderMorph.prototype.mouseLeave = function () {\r\n    var hat = this.parentThatIsA(PrototypeHatBlockMorph);\r\n    this.isHighlighted = false;\r\n    if (this.plainLabel && hat) {\r\n        hat.changed();\r\n        this.drawNew();\r\n        hat.changed();\r\n    } else {\r\n        this.drawNew();\r\n        this.changed();\r\n    }\r\n};\r\n\r\nBlockLabelPlaceHolderMorph.prototype.mouseClickLeft\r\n    = BlockLabelFragmentMorph.prototype.mouseClickLeft;\r\n\r\nBlockLabelPlaceHolderMorph.prototype.updateBlockLabel\r\n    = BlockLabelFragmentMorph.prototype.updateBlockLabel;\r\n\r\n// BlockInputFragmentMorph ///////////////////////////////////////////////\r\n\r\n/*\r\n    I am a variable blob in a custom block prototype's label. I can be clicked\r\n    to edit my contents and to turn me into an part of the block's label text.\r\n*/\r\n\r\n// BlockInputFragmentMorph inherits from TemplateSlotMorph:\r\n\r\nBlockInputFragmentMorph.prototype = new TemplateSlotMorph();\r\nBlockInputFragmentMorph.prototype.constructor = BlockInputFragmentMorph;\r\nBlockInputFragmentMorph.uber = TemplateSlotMorph.prototype;\r\n\r\n// BlockInputFragmentMorph instance creation:\r\n\r\nfunction BlockInputFragmentMorph(text) {\r\n    this.init(text);\r\n}\r\n\r\nBlockInputFragmentMorph.prototype.init = function (text) {\r\n    this.fragment = new BlockLabelFragment(text);\r\n    this.fragment.type = '%s';\r\n    BlockInputFragmentMorph.uber.init.call(this, text);\r\n};\r\n\r\n// BlockInputFragmentMorph events:\r\n\r\nBlockInputFragmentMorph.prototype.mouseClickLeft\r\n    = BlockLabelFragmentMorph.prototype.mouseClickLeft;\r\n\r\nBlockInputFragmentMorph.prototype.updateBlockLabel\r\n    = BlockLabelFragmentMorph.prototype.updateBlockLabel;\r\n\r\n// InputSlotDialogMorph ////////////////////////////////////////////////\r\n\r\n// ... \"inherits\" some methods from BlockDialogMorph\r\n\r\n// InputSlotDialogMorph inherits from DialogBoxMorph:\r\n\r\nInputSlotDialogMorph.prototype = new DialogBoxMorph();\r\nInputSlotDialogMorph.prototype.constructor = InputSlotDialogMorph;\r\nInputSlotDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// InputSlotDialogMorph preferences settings:\r\n\r\n// if \"isLaunchingExpanded\" is true I always open in the long form\r\nInputSlotDialogMorph.prototype.isLaunchingExpanded = false;\r\n\r\n// InputSlotDialogMorph instance creation:\r\n\r\nfunction InputSlotDialogMorph(\r\n    fragment,\r\n    target,\r\n    action,\r\n    environment,\r\n    category\r\n) {\r\n    this.init(fragment, target, action, environment, category);\r\n}\r\n\r\nInputSlotDialogMorph.prototype.init = function (\r\n    fragment,\r\n    target,\r\n    action,\r\n    environment,\r\n    category\r\n) {\r\n    var scale = SyntaxElementMorph.prototype.scale,\r\n        fh = fontHeight(10) / 1.2 * scale; // \"raw height\"\r\n\r\n    // additional properties:\r\n    this.fragment = fragment || new BlockLabelFragment();\r\n    this.textfield = null;\r\n    this.types = null;\r\n    this.slots = null;\r\n    this.isExpanded = false;\r\n    this.category = category || 'other';\r\n    this.cachedRadioButton = null; // \"template\" for radio button backgrounds\r\n    this.noDelete = false;\r\n\r\n    // initialize inherited properties:\r\n    BlockDialogMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.types = new AlignmentMorph('row', this.padding);\r\n    this.types.respectHiddens = true; // prevent the arrow from flipping\r\n    this.add(this.types);\r\n    this.slots = new BoxMorph();\r\n    this.slots.color = new Color(55, 55, 55); // same as palette\r\n    this.slots.borderColor = this.slots.color.lighter(50);\r\n    this.slots.setExtent(new Point((fh + 10) * 24, (fh + 10 * scale) * 10.4));\r\n    this.add(this.slots);\r\n    this.createSlotTypeButtons();\r\n    this.fixSlotsLayout();\r\n    this.addSlotsMenu();\r\n    this.createTypeButtons();\r\n    this.fixLayout();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.createTypeButtons = function () {\r\n    var block,\r\n        arrow,\r\n        myself = this,\r\n        clr = SpriteMorph.prototype.blockColor[this.category];\r\n\r\n\r\n    block = new JaggedBlockMorph(localize('Title text'));\r\n    block.setColor(clr);\r\n    this.addBlockTypeButton(\r\n        function () {myself.setType(null); },\r\n        block,\r\n        function () {return myself.fragment.type === null; }\r\n    );\r\n\r\n    block = new JaggedBlockMorph('%inputName');\r\n    block.setColor(clr);\r\n    this.addBlockTypeButton(\r\n        function () {myself.setType('%s'); },\r\n        block,\r\n        function () {return myself.fragment.type !== null; }\r\n    );\r\n\r\n    // add an arrow button for long form/short form toggling\r\n    arrow = new ArrowMorph(\r\n        'right',\r\n        PushButtonMorph.prototype.fontSize + 4,\r\n        2\r\n    );\r\n    arrow.noticesTransparentClick = true;\r\n    this.types.add(arrow);\r\n    this.types.fixLayout();\r\n\r\n    // configure arrow button\r\n    arrow.refresh = function () {\r\n        if (myself.fragment.type === null) {\r\n            myself.isExpanded = false;\r\n            arrow.hide();\r\n            myself.drawNew();\r\n        } else {\r\n            arrow.show();\r\n            if (myself.isExpanded) {\r\n                arrow.direction = 'down';\r\n            } else {\r\n                arrow.direction = 'right';\r\n            }\r\n            arrow.drawNew();\r\n            arrow.changed();\r\n        }\r\n    };\r\n\r\n    arrow.mouseClickLeft = function () {\r\n        if (arrow.isVisible) {\r\n            myself.isExpanded = !myself.isExpanded;\r\n            myself.types.children.forEach(function (c) {\r\n                c.refresh();\r\n            });\r\n            myself.drawNew();\r\n            myself.edit();\r\n        }\r\n    };\r\n\r\n    arrow.refresh();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.addTypeButton\r\n    = BlockDialogMorph.prototype.addTypeButton;\r\n\r\nInputSlotDialogMorph.prototype.addBlockTypeButton\r\n    = BlockDialogMorph.prototype.addBlockTypeButton;\r\n\r\nInputSlotDialogMorph.prototype.setType = function (fragmentType) {\r\n    this.textfield.choices = fragmentType ? null : this.symbolMenu;\r\n    this.textfield.drawNew();\r\n    this.fragment.type = fragmentType || null;\r\n    this.types.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.slots.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.getInput = function () {\r\n    var lbl;\r\n    if (this.body instanceof InputFieldMorph) {\r\n        lbl = this.normalizeSpaces(this.body.getValue());\r\n    }\r\n    if (lbl) {\r\n        this.fragment.labelString = lbl;\r\n        if (contains(['%b', '%boolUE'], this.fragment.type)) {\r\n            this.fragment.defaultValue =\r\n                this.slots.defaultSwitch.evaluate();\r\n        } else {\r\n            this.fragment.defaultValue =\r\n                this.slots.defaultInputField.getValue();\r\n        }\r\n        return lbl;\r\n    } else if (!this.noDelete) {\r\n        this.fragment.isDeleted = true;\r\n    }\r\n    return null;\r\n};\r\n\r\nInputSlotDialogMorph.prototype.fixLayout = function () {\r\n    var maxWidth,\r\n        left = this.left(),\r\n        th = fontHeight(this.titleFontSize) + this.titlePadding * 2;\r\n\r\n    if (!this.isExpanded) {\r\n        if (this.slots) {\r\n            this.slots.hide();\r\n        }\r\n        return BlockDialogMorph.prototype.fixLayout.call(this);\r\n    }\r\n\r\n    this.slots.show();\r\n    maxWidth = this.slots.width();\r\n\r\n    // arrange panes :\r\n    // body (input field)\r\n    this.body.setPosition(this.position().add(new Point(\r\n        this.padding + (maxWidth - this.body.width()) / 2,\r\n        th + this.padding\r\n    )));\r\n\r\n    // label\r\n    this.label.setLeft(\r\n        left + this.padding + (maxWidth - this.label.width()) / 2\r\n    );\r\n    this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n\r\n    // types\r\n    this.types.fixLayout();\r\n    this.types.setTop(this.body.bottom() + this.padding);\r\n    this.types.setLeft(\r\n        left + this.padding + (maxWidth - this.types.width()) / 2\r\n    );\r\n\r\n    // slots\r\n    this.slots.setPosition(new Point(\r\n        this.left() + this.padding,\r\n        this.types.bottom() + this.padding\r\n    ));\r\n    this.slots.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n\r\n    // buttons\r\n    this.buttons.fixLayout();\r\n    this.buttons.setTop(this.slots.bottom() + this.padding);\r\n    this.buttons.setLeft(\r\n        left + this.padding + (maxWidth - this.buttons.width()) / 2\r\n    );\r\n\r\n    // set dialog box dimensions:\r\n    this.silentSetHeight(this.buttons.bottom() - this.top() + this.padding);\r\n    this.silentSetWidth(this.slots.right() - this.left() + this.padding);\r\n};\r\n\r\nInputSlotDialogMorph.prototype.open = function (\r\n    title,\r\n    defaultString,\r\n    world,\r\n    pic,\r\n    noDeleteButton\r\n) {\r\n    var txt = new InputFieldMorph(defaultString),\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    if (!this.fragment.type) {\r\n        txt.choices = this.symbolMenu;\r\n    }\r\n    Morph.prototype.trackChanges = false;\r\n    this.isExpanded = this.isLaunchingExpanded;\r\n    txt.setWidth(250);\r\n    this.labelString = title;\r\n    this.createLabel();\r\n    if (pic) {this.setPicture(pic); }\r\n    this.addBody(txt);\r\n    txt.drawNew();\r\n    this.textfield = txt;\r\n    this.addButton('ok', 'OK');\r\n    if (!noDeleteButton) {\r\n        this.addButton('deleteFragment', 'Delete');\r\n    } else {\r\n        this.noDelete = true;\r\n    }\r\n    this.addButton('cancel', 'Cancel');\r\n    this.fixLayout();\r\n    this.drawNew();\r\n    this.fixLayout();\r\n    this.popUp(world);\r\n    this.add(this.types); // make the types come to front\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.changed();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.symbolMenu = function () {\r\n    var symbols = [],\r\n        symbolColor = new Color(100, 100, 130),\r\n        myself = this;\r\n    SymbolMorph.prototype.names.forEach(function (symbol) {\r\n        symbols.push([\r\n            [\r\n                new SymbolMorph(symbol, myself.fontSize, symbolColor),\r\n                localize(symbol)\r\n            ],\r\n            '$' + symbol\r\n        ]);\r\n    });\r\n    symbols.push(['\\u23CE ' + localize('new line'), '$nl']);\r\n    return symbols;\r\n};\r\n\r\nInputSlotDialogMorph.prototype.deleteFragment = function () {\r\n    this.fragment.isDeleted = true;\r\n    this.accept();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.createSlotTypeButtons = function () {\r\n    // populate my 'slots' area with radio buttons, labels and input fields\r\n    var myself = this, defLabel, defInput, defSwitch,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    // slot types\r\n    this.addSlotTypeButton('Object', '%obj');\r\n    this.addSlotTypeButton('Text', '%txt');\r\n    this.addSlotTypeButton('List', '%l');\r\n    this.addSlotTypeButton('Number', '%n');\r\n    this.addSlotTypeButton('Any type', '%s');\r\n    this.addSlotTypeButton('Boolean (T/F)', '%b');\r\n    this.addSlotTypeButton('Command\\n(inline)', '%cmdRing'); //'%cmd');\r\n    this.addSlotTypeButton('Reporter', '%repRing'); //'%r');\r\n    this.addSlotTypeButton('Predicate', '%predRing'); //'%p');\r\n    this.addSlotTypeButton('Command\\n(C-shape)', '%cs');\r\n    this.addSlotTypeButton('Any\\n(unevaluated)', '%anyUE');\r\n    this.addSlotTypeButton('Boolean\\n(unevaluated)', '%boolUE');\r\n\r\n    // arity and upvars\r\n    this.slots.radioButtonSingle = this.addSlotArityButton(\r\n        function () {myself.setSlotArity('single'); },\r\n        \"Single input.\",\r\n        function () {return myself.fragment.isSingleInput(); }\r\n    );\r\n    this.addSlotArityButton(\r\n        function () {myself.setSlotArity('multiple'); },\r\n        \"Multiple inputs (value is list of inputs)\",\r\n        function () {return myself.fragment.isMultipleInput(); }\r\n    );\r\n    this.addSlotArityButton(\r\n        function () {myself.setSlotArity('upvar'); },\r\n        \"Upvar - make internal variable visible to caller\",\r\n        function () {return myself.fragment.isUpvar(); }\r\n    );\r\n\r\n    // default values\r\n    defLabel = new StringMorph(localize('Default Value:'));\r\n    defLabel.fontSize = this.slots.radioButtonSingle.fontSize;\r\n    defLabel.setColor(new Color(255, 255, 255));\r\n    defLabel.refresh = function () {\r\n        if (myself.isExpanded && contains(\r\n                ['%s', '%n', '%txt', '%anyUE', '%b', '%boolUE'],\r\n                myself.fragment.type\r\n            )) {\r\n            defLabel.show();\r\n        } else {\r\n            defLabel.hide();\r\n        }\r\n    };\r\n    this.slots.defaultInputLabel = defLabel;\r\n    this.slots.add(defLabel);\r\n\r\n    defInput = new InputFieldMorph(this.fragment.defaultValue);\r\n    defInput.contents().fontSize = defLabel.fontSize;\r\n    defInput.contrast = 90;\r\n    defInput.contents().drawNew();\r\n    defInput.setWidth(50);\r\n    defInput.refresh = function () {\r\n        if (myself.isExpanded && contains(\r\n            ['%s', '%n', '%txt', '%anyUE'],\r\n            myself.fragment.type\r\n        )) {\r\n            defInput.show();\r\n            if (myself.fragment.type === '%n') {\r\n                defInput.setIsNumeric(true);\r\n            } else {\r\n                defInput.setIsNumeric(false);\r\n            }\r\n        } else {\r\n            defInput.hide();\r\n        }\r\n    };\r\n    this.slots.defaultInputField = defInput;\r\n    this.slots.add(defInput);\r\n    defInput.drawNew();\r\n\r\n    defSwitch = new BooleanSlotMorph(this.fragment.defaultValue);\r\n    defSwitch.refresh = function () {\r\n        if (myself.isExpanded && contains(\r\n            ['%b', '%boolUE'],\r\n            myself.fragment.type\r\n        )) {\r\n            defSwitch.show();\r\n        } else {\r\n            defSwitch.hide();\r\n        }\r\n    };\r\n    this.slots.defaultSwitch = defSwitch;\r\n    this.slots.add(defSwitch);\r\n    defSwitch.drawNew();\r\n\r\n    Morph.prototype.trackChanges = oldFlag;\r\n};\r\n\r\nInputSlotDialogMorph.prototype.setSlotType = function (type) {\r\n    this.fragment.setSingleInputType(type);\r\n    this.slots.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.setSlotArity = function (arity) {\r\n    if (arity === 'single') {\r\n        this.fragment.setToSingleInput();\r\n    } else if (arity === 'multiple') {\r\n        this.fragment.setToMultipleInput();\r\n    } else if (arity === 'upvar') {\r\n        this.fragment.setToUpvar();\r\n        // hide other options - under construction\r\n    }\r\n    this.slots.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.addSlotTypeButton = function (\r\n    label,\r\n    spec\r\n) {\r\n/*\r\n    this method produces a radio button with a picture of the\r\n    slot type indicated by \"spec\" and the \"label\" text to\r\n    its right.\r\n    Note that you can make the slot picture interactive (turn\r\n    it into a ToggleElementMorph by changing the\r\n\r\n        element.fullImage()\r\n\r\n    line to just\r\n\r\n        element\r\n\r\n    I've opted for the simpler representation because it reduces\r\n    the duration of time it takes for the InputSlotDialog to load\r\n    and show. But in the future computers and browsers may be\r\n    faster.\r\n*/\r\n    var myself = this,\r\n        action = function () {myself.setSlotType(spec); },\r\n        query,\r\n        element = new JaggedBlockMorph(spec),\r\n        button;\r\n\r\n    query = function () {\r\n        return myself.fragment.singleInputType() === spec;\r\n    };\r\n    element.setCategory(this.category);\r\n    element.rebuild();\r\n    button = new ToggleMorph(\r\n        'radiobutton',\r\n        this,\r\n        action,\r\n        label,\r\n        query,\r\n        null,\r\n        null,\r\n        this.cachedRadioButton,\r\n        element.fullImage(), // delete the \"fullImage()\" part for interactive\r\n        'rebuild'\r\n    );\r\n    button.edge = this.buttonEdge / 2;\r\n    button.outline = this.buttonOutline / 2;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    button.label.isBold = false;\r\n    button.label.setColor(new Color(255, 255, 255));\r\n    if (!this.cachedRadioButton) {\r\n        this.cachedRadioButton = button;\r\n    }\r\n    this.slots.add(button);\r\n    return button;\r\n};\r\n\r\nInputSlotDialogMorph.prototype.addSlotArityButton = function (\r\n    action,\r\n    label,\r\n    query\r\n) {\r\n    var button = new ToggleMorph(\r\n        'radiobutton',\r\n        this,\r\n        action,\r\n        label,\r\n        query,\r\n        null,\r\n        null,\r\n        this.cachedRadioButton\r\n    );\r\n    button.edge = this.buttonEdge / 2;\r\n    button.outline = this.buttonOutline / 2;\r\n    button.outlineColor = this.buttonOutlineColor;\r\n    button.outlineGradient = this.buttonOutlineGradient;\r\n\r\n    button.drawNew();\r\n    button.fixLayout();\r\n    // button.label.isBold = false;\r\n    button.label.setColor(new Color(255, 255, 255));\r\n    this.slots.add(button);\r\n    if (!this.cachedRadioButton) {\r\n        this.cachedRadioButton = button;\r\n    }\r\n    return button;\r\n};\r\n\r\nInputSlotDialogMorph.prototype.fixSlotsLayout = function () {\r\n    var slots = this.slots,\r\n        scale = SyntaxElementMorph.prototype.scale,\r\n        xPadding = 10 * scale,\r\n        ypadding = 14 * scale,\r\n        bh = (fontHeight(10) / 1.2 + 15) * scale, // slot type button height\r\n        ah = (fontHeight(10) / 1.2 + 10) * scale, // arity button height\r\n        size = 12, // number slot type radio buttons\r\n        cols = [\r\n            slots.left() + xPadding,\r\n            slots.left() + slots.width() / 3,\r\n            slots.left() + slots.width() * 2 / 3\r\n        ],\r\n        rows = [\r\n            slots.top() + ypadding,\r\n            slots.top() + ypadding + bh,\r\n            slots.top() + ypadding + bh * 2,\r\n            slots.top() + ypadding + bh * 3,\r\n            slots.top() + ypadding + bh * 4,\r\n            slots.top() + ypadding + bh * 5,\r\n\r\n            slots.top() + ypadding + bh * 5 + ah,\r\n            slots.top() + ypadding + bh * 5 + ah * 2\r\n        ],\r\n        idx,\r\n        row = -1,\r\n        col,\r\n        oldFlag = Morph.prototype.trackChanges;\r\n\r\n    Morph.prototype.trackChanges = false;\r\n\r\n    // slot types:\r\n\r\n    for (idx = 0; idx < size; idx += 1) {\r\n        col = idx % 3;\r\n        if (idx % 3 === 0) {row += 1; }\r\n        slots.children[idx].setPosition(new Point(\r\n            cols[col],\r\n            rows[row]\r\n        ));\r\n    }\r\n\r\n    // arity:\r\n\r\n    col = 0;\r\n    row = 5;\r\n    for (idx = size; idx < size + 3; idx += 1) {\r\n        slots.children[idx].setPosition(new Point(\r\n            cols[col],\r\n            rows[row + idx - size]\r\n        ));\r\n    }\r\n\r\n    // default input\r\n\r\n    this.slots.defaultInputLabel.setPosition(\r\n        this.slots.radioButtonSingle.label.topRight().add(new Point(5, 0))\r\n    );\r\n    this.slots.defaultInputField.setCenter(\r\n        this.slots.defaultInputLabel.center().add(new Point(\r\n            this.slots.defaultInputField.width() / 2\r\n                + this.slots.defaultInputLabel.width() / 2 + 5,\r\n            0\r\n        ))\r\n    );\r\n    this.slots.defaultSwitch.setCenter(\r\n        this.slots.defaultInputLabel.center().add(new Point(\r\n            this.slots.defaultSwitch.width() / 2\r\n                + this.slots.defaultInputLabel.width() / 2 + 5,\r\n            0\r\n        ))\r\n    );\r\n    Morph.prototype.trackChanges = oldFlag;\r\n    this.slots.changed();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.addSlotsMenu = function () {\r\n    var myself = this;\r\n\r\n    this.slots.userMenu = function () {\r\n        if (contains(['%s', '%n', '%txt', '%anyUE'], myself.fragment.type)) {\r\n            var menu = new MenuMorph(myself),\r\n                on = '\\u2611 ',\r\n                off = '\\u2610 ';\r\n            menu.addItem('options...', 'editSlotOptions');\r\n            menu.addItem(\r\n                (myself.fragment.isReadOnly ? on : off) +\r\n                    localize('read-only'),\r\n                function () {myself.fragment.isReadOnly =\r\n                         !myself.fragment.isReadOnly;\r\n                         }\r\n            );\r\n            return menu;\r\n        }\r\n        return Morph.prototype.userMenu.call(myself);\r\n    };\r\n};\r\n\r\nInputSlotDialogMorph.prototype.editSlotOptions = function () {\r\n    var myself = this;\r\n    new DialogBoxMorph(\r\n        myself,\r\n        function (options) {\r\n            myself.fragment.options = options.trim();\r\n        },\r\n        myself\r\n    ).promptCode(\r\n        'Input Slot Options',\r\n        myself.fragment.options,\r\n        myself.world(),\r\n        null,\r\n        localize('Enter one option per line.\\n' +\r\n            'Optionally use \"=\" as key/value delimiter ' +\r\n            'and {} for submenus. ' +\r\n            'e.g.\\n   the answer=42')\r\n    );\r\n};\r\n\r\n// InputSlotDialogMorph hiding and showing:\r\n\r\n/*\r\n    override the inherited behavior to recursively hide/show all\r\n    children, so that my instances get restored correctly when\r\n    hiding/showing my parent.\r\n*/\r\n\r\nInputSlotDialogMorph.prototype.hide = function () {\r\n    this.isVisible = false;\r\n    this.changed();\r\n};\r\n\r\nInputSlotDialogMorph.prototype.show = function () {\r\n    this.isVisible = true;\r\n    this.changed();\r\n};\r\n\r\n// VariableDialogMorph ////////////////////////////////////////////////////\r\n\r\n// VariableDialogMorph inherits from DialogBoxMorph:\r\n\r\nVariableDialogMorph.prototype = new DialogBoxMorph();\r\nVariableDialogMorph.prototype.constructor = VariableDialogMorph;\r\nVariableDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// ... and some behavior from BlockDialogMorph\r\n\r\n// VariableDialogMorph instance creation:\r\n\r\nfunction VariableDialogMorph(target, action, environment) {\r\n    this.init(target, action, environment);\r\n}\r\n\r\nVariableDialogMorph.prototype.init = function (target, action, environment) {\r\n    // additional properties:\r\n    this.types = null;\r\n    this.isGlobal = true;\r\n\r\n    // initialize inherited properties:\r\n    BlockDialogMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        action,\r\n        environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.types = new AlignmentMorph('row', this.padding);\r\n    this.add(this.types);\r\n    this.createTypeButtons();\r\n};\r\n\r\nVariableDialogMorph.prototype.createTypeButtons = function () {\r\n    var myself = this;\r\n\r\n    this.addTypeButton(\r\n        function () {myself.setType('global'); },\r\n        \"for all sprites\",\r\n        function () {return myself.isGlobal; }\r\n    );\r\n    this.addTypeButton(\r\n        function () {myself.setType('local'); },\r\n        \"for this sprite only\",\r\n        function () {return !myself.isGlobal; }\r\n    );\r\n};\r\n\r\nVariableDialogMorph.prototype.addTypeButton\r\n    = BlockDialogMorph.prototype.addTypeButton;\r\n\r\nVariableDialogMorph.prototype.setType = function (varType) {\r\n    this.isGlobal = (varType === 'global');\r\n    this.types.children.forEach(function (c) {\r\n        c.refresh();\r\n    });\r\n    this.edit();\r\n};\r\n\r\nVariableDialogMorph.prototype.getInput = function () {\r\n    // answer a tuple: [varName, isGlobal]\r\n    var name = this.normalizeSpaces(this.body.getValue());\r\n    return name ? [name, this.isGlobal] : null;\r\n};\r\n\r\nVariableDialogMorph.prototype.fixLayout = function () {\r\n    var th = fontHeight(this.titleFontSize) + this.titlePadding * 2;\r\n\r\n    if (this.body) {\r\n        this.body.setPosition(this.position().add(new Point(\r\n            this.padding,\r\n            th + this.padding\r\n        )));\r\n        this.silentSetWidth(this.body.width() + this.padding * 2);\r\n        this.silentSetHeight(\r\n            this.body.height()\r\n                + this.padding * 2\r\n                + th\r\n        );\r\n    }\r\n\r\n    if (this.label) {\r\n        this.label.setCenter(this.center());\r\n        this.label.setTop(this.top() + (th - this.label.height()) / 2);\r\n    }\r\n\r\n    if (this.types) {\r\n        this.types.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.types.height()\r\n                    + this.padding\r\n        );\r\n        this.silentSetWidth(Math.max(\r\n            this.width(),\r\n            this.types.width() + this.padding * 2\r\n        ));\r\n        this.types.setCenter(this.center());\r\n        if (this.body) {\r\n            this.types.setTop(this.body.bottom() + this.padding);\r\n        } else if (this.categories) {\r\n            this.types.setTop(this.categories.bottom() + this.padding);\r\n        }\r\n    }\r\n\r\n    if (this.buttons && (this.buttons.children.length > 0)) {\r\n        this.buttons.fixLayout();\r\n        this.silentSetHeight(\r\n            this.height()\r\n                    + this.buttons.height()\r\n                    + this.padding\r\n        );\r\n        this.buttons.setCenter(this.center());\r\n        this.buttons.setBottom(this.bottom() - this.padding);\r\n    }\r\n};\r\n\r\n// BlockExportDialogMorph ////////////////////////////////////////////////////\r\n\r\n// BlockExportDialogMorph inherits from DialogBoxMorph:\r\n\r\nBlockExportDialogMorph.prototype = new DialogBoxMorph();\r\nBlockExportDialogMorph.prototype.constructor = BlockExportDialogMorph;\r\nBlockExportDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// BlockExportDialogMorph constants:\r\n\r\nBlockExportDialogMorph.prototype.key = 'blockExport';\r\n\r\n// BlockExportDialogMorph instance creation:\r\n\r\nfunction BlockExportDialogMorph(serializer, blocks) {\r\n    this.init(serializer, blocks);\r\n}\r\n\r\nBlockExportDialogMorph.prototype.init = function (serializer, blocks) {\r\n    var myself = this;\r\n\r\n    // additional properties:\r\n    this.serializer = serializer;\r\n    this.blocks = blocks.slice(0);\r\n    this.handle = null;\r\n\r\n    // initialize inherited properties:\r\n    BlockExportDialogMorph.uber.init.call(\r\n        this,\r\n        null, // target\r\n        function () {myself.exportBlocks(); },\r\n        null // environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.labelString = 'Export blocks';\r\n    this.createLabel();\r\n\r\n    // build contents\r\n    this.buildContents();\r\n};\r\n\r\nBlockExportDialogMorph.prototype.buildContents = function () {\r\n    var palette, x, y, block, checkBox, lastCat,\r\n        myself = this,\r\n        padding = 4;\r\n\r\n    // create plaette\r\n    palette = new ScrollFrameMorph(\r\n        null,\r\n        null,\r\n        SpriteMorph.prototype.sliderColor\r\n    );\r\n    palette.color = SpriteMorph.prototype.paletteColor;\r\n    palette.padding = padding;\r\n    palette.isDraggable = false;\r\n    palette.acceptsDrops = false;\r\n    palette.contents.acceptsDrops = false;\r\n\r\n    // populate palette\r\n    x = palette.left() + padding;\r\n    y = palette.top() + padding;\r\n    SpriteMorph.prototype.categories.forEach(function (category) {\r\n        myself.blocks.forEach(function (definition) {\r\n            if (definition.category === category) {\r\n                if (lastCat && (category !== lastCat)) {\r\n                    y += padding;\r\n                }\r\n                lastCat = category;\r\n                block = definition.templateInstance();\r\n                checkBox = new ToggleMorph(\r\n                    'checkbox',\r\n                    myself,\r\n                    function () {\r\n                        var idx = myself.blocks.indexOf(definition);\r\n                        if (idx > -1) {\r\n                            myself.blocks.splice(idx, 1);\r\n                        } else {\r\n                            myself.blocks.push(definition);\r\n                        }\r\n                    },\r\n                    null,\r\n                    function () {\r\n                        return contains(\r\n                            myself.blocks,\r\n                            definition\r\n                        );\r\n                    },\r\n                    null,\r\n                    null,\r\n                    null,\r\n                    block.fullImage()\r\n                );\r\n                checkBox.setPosition(new Point(\r\n                    x,\r\n                    y + (checkBox.top() - checkBox.toggleElement.top())\r\n                ));\r\n                palette.addContents(checkBox);\r\n                y += checkBox.fullBounds().height() + padding;\r\n            }\r\n        });\r\n    });\r\n\r\n    palette.scrollX(padding);\r\n    palette.scrollY(padding);\r\n    this.addBody(palette);\r\n\r\n    this.addButton('ok', 'OK');\r\n    this.addButton('cancel', 'Cancel');\r\n\r\n    this.setExtent(new Point(220, 300));\r\n    this.fixLayout();\r\n\r\n};\r\n\r\nBlockExportDialogMorph.prototype.popUp = function (wrrld) {\r\n    var world = wrrld || this.target.world();\r\n    if (world) {\r\n        BlockExportDialogMorph.uber.popUp.call(this, world);\r\n        this.handle = new HandleMorph(\r\n            this,\r\n            200,\r\n            220,\r\n            this.corner,\r\n            this.corner\r\n        );\r\n    }\r\n};\r\n\r\n// BlockExportDialogMorph menu\r\n\r\nBlockExportDialogMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this, 'select');\r\n    menu.addItem('all', 'selectAll');\r\n    menu.addItem('none', 'selectNone');\r\n    return menu;\r\n};\r\n\r\nBlockExportDialogMorph.prototype.selectAll = function () {\r\n    this.body.contents.children.forEach(function (checkBox) {\r\n        if (!checkBox.state) {\r\n            checkBox.trigger();\r\n        }\r\n    });\r\n};\r\n\r\nBlockExportDialogMorph.prototype.selectNone = function () {\r\n    this.blocks = [];\r\n    this.body.contents.children.forEach(function (checkBox) {\r\n        checkBox.refresh();\r\n    });\r\n};\r\n\r\n// BlockExportDialogMorph ops\r\n\r\nBlockExportDialogMorph.prototype.exportBlocks = function () {\r\n    var str = this.serializer.serialize(this.blocks, true), // for library\r\n        ide = this.world().children[0];\r\n\r\n    if (this.blocks.length > 0) {\r\n        str = '<blocks app=\"'\r\n            + this.serializer.app\r\n            + '\" version=\"'\r\n            + this.serializer.version\r\n            + '\">'\r\n            + str\r\n            + '</blocks>';\r\n        ide.saveXMLAs(\r\n            str,\r\n            (ide.projectName || localize('untitled')) + ' ' + localize('blocks')\r\n        );\r\n    } else {\r\n        new DialogBoxMorph().inform(\r\n            'Export blocks',\r\n            'no blocks were selected',\r\n            this.world()\r\n        );\r\n    }\r\n};\r\n\r\n// BlockExportDialogMorph layout\r\n\r\nBlockExportDialogMorph.prototype.fixLayout\r\n    = BlockEditorMorph.prototype.fixLayout;\r\n\r\n// BlockImportDialogMorph ////////////////////////////////////////////////////\r\n\r\n// BlockImportDialogMorph inherits from DialogBoxMorph\r\n// and pseudo-inherits from BlockExportDialogMorph:\r\n\r\nBlockImportDialogMorph.prototype = new DialogBoxMorph();\r\nBlockImportDialogMorph.prototype.constructor = BlockImportDialogMorph;\r\nBlockImportDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// BlockImportDialogMorph constants:\r\n\r\nBlockImportDialogMorph.prototype.key = 'blockImport';\r\n\r\n// BlockImportDialogMorph instance creation:\r\n\r\nfunction BlockImportDialogMorph(blocks, target, name) {\r\n    this.init(blocks, target, name);\r\n}\r\n\r\nBlockImportDialogMorph.prototype.init = function (blocks, target, name) {\r\n    var myself = this;\r\n\r\n    // additional properties:\r\n    this.blocks = blocks.slice(0);\r\n    this.handle = null;\r\n\r\n    // initialize inherited properties:\r\n    BlockExportDialogMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        function () {myself.importBlocks(name); },\r\n        null // environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.labelString = localize('Import blocks')\r\n        + (name ? ': ' : '')\r\n        + name || '';\r\n    this.createLabel();\r\n\r\n    // build contents\r\n    this.buildContents();\r\n};\r\n\r\nBlockImportDialogMorph.prototype.buildContents\r\n    = BlockExportDialogMorph.prototype.buildContents;\r\n\r\nBlockImportDialogMorph.prototype.popUp\r\n    = BlockExportDialogMorph.prototype.popUp;\r\n\r\n// BlockImportDialogMorph menu\r\n\r\nBlockImportDialogMorph.prototype.userMenu\r\n    = BlockExportDialogMorph.prototype.userMenu;\r\n\r\nBlockImportDialogMorph.prototype.selectAll\r\n    = BlockExportDialogMorph.prototype.selectAll;\r\n\r\nBlockImportDialogMorph.prototype.selectNone\r\n    = BlockExportDialogMorph.prototype.selectNone;\r\n\r\n// BlockImportDialogMorph ops\r\n\r\nBlockImportDialogMorph.prototype.importBlocks = function (name) {\r\n    var ide = this.target.parentThatIsA(IDE_Morph);\r\n    if (!ide) {return; }\r\n    if (this.blocks.length > 0) {\r\n        this.blocks.forEach(function (def) {\r\n            def.receiver = ide.stage;\r\n            ide.stage.globalBlocks.push(def);\r\n            ide.stage.replaceDoubleDefinitionsFor(def);\r\n        });\r\n        ide.flushPaletteCache();\r\n        ide.refreshPalette();\r\n        ide.showMessage(\r\n            'Imported Blocks Module' + (name ? ': ' + name : '') + '.',\r\n            2\r\n        );\r\n    } else {\r\n        new DialogBoxMorph().inform(\r\n            'Import blocks',\r\n            'no blocks were selected',\r\n            this.world()\r\n        );\r\n    }\r\n};\r\n\r\n// BlockImportDialogMorph layout\r\n\r\nBlockImportDialogMorph.prototype.fixLayout\r\n    = BlockEditorMorph.prototype.fixLayout;\r\n\r\n// BlockRemovalDialogMorph ///////////////////////////////////////////////////\r\n\r\n// BlockRemovalDialogMorph inherits from DialogBoxMorph\r\n// and pseudo-inherits from BlockExportDialogMorph:\r\n\r\nBlockRemovalDialogMorph.prototype = new DialogBoxMorph();\r\nBlockRemovalDialogMorph.prototype.constructor = BlockImportDialogMorph;\r\nBlockRemovalDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// BlockRemovalDialogMorph constants:\r\n\r\nBlockRemovalDialogMorph.prototype.key = 'blockRemove';\r\n\r\n// BlockRemovalDialogMorph instance creation:\r\n\r\nfunction BlockRemovalDialogMorph(blocks, target) {\r\n    this.init(blocks, target);\r\n}\r\n\r\nBlockRemovalDialogMorph.prototype.init = function (blocks, target) {\r\n    var myself = this;\r\n\r\n    // additional properties:\r\n    this.blocks = blocks.slice(0);\r\n    this.handle = null;\r\n\r\n    // initialize inherited properties:\r\n    BlockExportDialogMorph.uber.init.call(\r\n        this,\r\n        target,\r\n        function () {myself.removeBlocks(); },\r\n        null // environment\r\n    );\r\n\r\n    // override inherited properites:\r\n    this.labelString = localize('Remove unused blocks')\r\n        + (name ? ': ' : '')\r\n        + name || '';\r\n    this.createLabel();\r\n\r\n    // build contents\r\n    this.buildContents();\r\n};\r\n\r\nBlockRemovalDialogMorph.prototype.buildContents\r\n    = BlockExportDialogMorph.prototype.buildContents;\r\n\r\nBlockRemovalDialogMorph.prototype.popUp\r\n    = BlockExportDialogMorph.prototype.popUp;\r\n\r\n// BlockRemovalDialogMorph menu\r\n\r\nBlockRemovalDialogMorph.prototype.userMenu\r\n    = BlockExportDialogMorph.prototype.userMenu;\r\n\r\nBlockRemovalDialogMorph.prototype.selectAll\r\n    = BlockExportDialogMorph.prototype.selectAll;\r\n\r\nBlockRemovalDialogMorph.prototype.selectNone\r\n    = BlockExportDialogMorph.prototype.selectNone;\r\n\r\n// BlockRemovalDialogMorph ops\r\n\r\nBlockRemovalDialogMorph.prototype.removeBlocks = function () {\r\n    var ide = this.target.parentThatIsA(IDE_Morph);\r\n    if (!ide) {return; }\r\n    if (this.blocks.length > 0) {\r\n        this.blocks.forEach(function (def) {\r\n            var idx = ide.stage.globalBlocks.indexOf(def);\r\n            if (idx !== -1) {\r\n                ide.stage.globalBlocks.splice(idx, 1);\r\n            }\r\n        });\r\n        ide.flushPaletteCache();\r\n        ide.refreshPalette();\r\n        ide.showMessage(\r\n            this.blocks.length + ' ' + localize('unused block(s) removed'),\r\n            2\r\n        );\r\n    } else {\r\n        new DialogBoxMorph().inform(\r\n            'Remove unused blocks',\r\n            'no blocks were selected',\r\n            this.world()\r\n        );\r\n    }\r\n};\r\n\r\n// BlockRemovalDialogMorph layout\r\n\r\nBlockRemovalDialogMorph.prototype.fixLayout\r\n    = BlockEditorMorph.prototype.fixLayout;\r\n//fin de byob.\r\n/*\r\n\r\n    tables.js\r\n\r\n    basic spreadsheet elements for Snap!\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2016 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js, list.js, widgets.js, byob.js, threads\r\n\r\n\r\n    I. hierarchy\r\n    -------------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n    DialogBoxMorph**\r\n        TableDialogMorph\r\n    Morph*\r\n        FrameMorph*\r\n            TableMorph\r\n        TableCellMorph\r\n        TableFrameMorph\r\n    Table\r\n\r\n    * from morphic.js\r\n    ** from widgets.js\r\n\r\n\r\n    II. toc\r\n    -------\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n    Table\r\n    TableCellMorph\r\n    TableMorph\r\n    TableFrameMorph\r\n    TableDialogMorph\r\n\r\n*/\r\n\r\n// Global settings /////////////////////////////////////////////////////\r\n\r\n/*global modules, Point, newCanvas, Morph, fontHeight, SliderMorph, List,\r\nMorphicPreferences, FrameMorph, HandleMorph, DialogBoxMorph, isString,\r\nSpriteMorph, Context, Costume, ArgMorph, BlockEditorMorph, SymbolMorph,\r\nSyntaxElementMorph, MenuMorph, SpriteBubbleMorph, SpeechBubbleMorph, Sound,\r\nCellMorph, ListWatcherMorph, isNil, BoxMorph, Variable, isSnapObject*/\r\n\r\nmodules.tables = '2017-September-01';\r\n\r\nvar Table;\r\nvar TableCellMorph;\r\nvar TableMorph;\r\nvar TableFrameMorph;\r\n\r\n// Table /////////////////////////////////////////////////////////////\r\n\r\n/*\r\n    Observable 2D data collections accessible by rows, columns and cells\r\n    with indices starting at 1.\r\n    currently only used for testing TableViews in Snap, because Snap\r\n    automatically displays 2D lists as tables.\r\n*/\r\n\r\nfunction Table(cols, rows) {\r\n    this.colCount = +cols;\r\n    this.rowCount = +rows;\r\n    this.colNames = [];\r\n    this.rowNames = [];\r\n    this.contents = new Array(+rows);\r\n    for (var i = 0; i < rows; i += 1) {\r\n        this.contents[i] = new Array(+cols);\r\n    }\r\n    this.lastChanged = Date.now();\r\n}\r\n\r\n// Table testing:\r\n\r\nTable.prototype.demo = function(aWorld) {\r\n    // new Table(50, 10000).demo(world)\r\n    var dlg;\r\n    this.fillWithTestData();\r\n    dlg = new TableDialogMorph(this);\r\n    dlg.popUp (aWorld);\r\n};\r\n\r\n// Table updating:\r\n\r\nTable.prototype.changed = function () {\r\n    this.lastChanged = Date.now();\r\n};\r\n\r\n// Table querying:\r\n\r\nTable.prototype.get = function (col, row) {\r\n    if (!col) {\r\n        if (!row) {return [this.rowCount]; }\r\n        return this.rowName(row);\r\n    } else if (!row) {\r\n        return this.colName(col);\r\n    }\r\n    if (col > this.colCount || row > this.rowCount) {return null; }\r\n    return (this.contents[row - 1] || [])[col - 1];\r\n};\r\n\r\nTable.prototype.row = function(row) {\r\n    return this.contents[row - 1];\r\n};\r\n\r\nTable.prototype.col = function(col) {\r\n    var dta = [],\r\n        c = col - 1,\r\n        i;\r\n    for (i = 0; i < this.rowCount; i += 1) {\r\n        dta.push(this.contents[i][c]);\r\n    }\r\n    return dta;\r\n};\r\n\r\nTable.prototype.colName = function (col) {\r\n    // answer the specified name or a capital letter A-Z\r\n    // repeated accordingly\r\n    if (col > this.colCount) {return null; }\r\n    var name = this.colNames[col - 1];\r\n    if (name !== undefined) {return name; }\r\n    return String.fromCharCode(64 + ((col % 26) || 26)).repeat(\r\n        Math.floor((col - 1) / 26) + 1\r\n    );\r\n};\r\n\r\nTable.prototype.rowName = function (row) {\r\n    // answer the specified name or row number\r\n    if (row > this.rowCount) {return null; }\r\n    return this.rowNames[row - 1] || row;\r\n};\r\n\r\nTable.prototype.rows = function () {\r\n    return this.rowCount;\r\n};\r\n\r\nTable.prototype.cols = function () {\r\n    return this.colCount;\r\n};\r\n\r\nTable.prototype.columnNames = function () {\r\n    return this.colNames;\r\n};\r\n\r\n// Table setting:\r\n\r\nTable.prototype.set = function (data, col, row) {\r\n    this.contents[row - 1][col - 1] = data;\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setRows = function (rowsArray, colNames, rowNames) {\r\n    this.contents = rowsArray;\r\n    if (colNames) {this.colNames = colNames; }\r\n    if (rowNames) {this.rowNames = rowNames; }\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setCols = function (colsArray, colNames, rowNames) {\r\n    var r, c;\r\n    for (c = 0; c < this.colCount; c += 1) {\r\n        for (r = 0; r < this.rowCount; r += 1) {\r\n            this.contents[r][c] = colsArray[c][r];\r\n        }\r\n    }\r\n    if (colNames) {this.colNames = colNames; }\r\n    if (rowNames) {this.rowNames = rowNames; }\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setColNames = function (array) {\r\n    this.colNames = array || [];\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setRowNames = function (array) {\r\n    this.rowNames = array || [];\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setColName = function (col, name) {\r\n    this.colNames[col + 1] = name;\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.setRowName = function (row, name) {\r\n    this.rowNames[row + 1] = name;\r\n    this.changed();\r\n};\r\n\r\n// Table growing:\r\n\r\nTable.prototype.addRow = function (array, name) {\r\n    if (array) {\r\n        this.contents[this.rowCount] = array;\r\n    } else {\r\n        this.contents[this.rowCount] = new Array(this.rowCount);\r\n    }\r\n    this.rowNames[this.rowCount] = name;\r\n    this.rowCount += 1;\r\n    this.changed();\r\n};\r\n\r\nTable.prototype.addCol = function (array, name) {\r\n    var i;\r\n    if (array) {\r\n        for (i = 0; i < this.col; i += 1) {\r\n            this.contents[i][this.colCount] = array[i];\r\n        }\r\n    }\r\n    this.colNames[this.colCount] = name;\r\n    this.colCount += 1;\r\n    this.changed();\r\n};\r\n\r\n// Table converting:\r\n\r\nTable.prototype.toList = function () {\r\n    return new List(\r\n        this.contents.map(function (eachRow) {\r\n            return new List(eachRow);\r\n        })\r\n    );\r\n};\r\n\r\n// Table testing\r\n\r\nTable.prototype.fillWithTestData = function () {\r\n    var c, r;\r\n    for (c = 1; c <= this.colCount; c += 1) {\r\n        for (r = 1; r <= this.rowCount; r += 1) {\r\n            this.set (this.colName(c) + this.rowName(r), c, r);\r\n        }\r\n    }\r\n};\r\n\r\n// TableCellMorph /////////////////////////////////////////////////////////\r\n\r\n// basic fast data view, currently constrained to a single line of text\r\n\r\n// TableCellMorph inherits from Morph:\r\n\r\nTableCellMorph.prototype = new Morph();\r\nTableCellMorph.prototype.constructor = TableCellMorph;\r\nTableCellMorph.uber = Morph.prototype;\r\n\r\n// TableCellMorph global setting:\r\n\r\nTableCellMorph.prototype.listSymbol = ArgMorph.prototype.listIcon();\r\n\r\n// TableCellMorph instance creation:\r\n\r\nfunction TableCellMorph(data, extent, isLabel) {\r\n    this.init(data, extent, isLabel);\r\n}\r\n\r\nTableCellMorph.prototype.init = function (data, extent, isLabel) {\r\n    // additional properties:\r\n    this.data = data;\r\n    this.isLabel = isLabel || false;\r\n\r\n    // initialize inherited properties:\r\n    TableCellMorph.uber.init.call(this, true);\r\n\r\n    // override inherited properites:\r\n    this.noticesTransparentClick = true;\r\n    if (extent) {this.silentSetExtent(extent); }\r\n    this.drawNew();\r\n};\r\n\r\nTableCellMorph.prototype.setData = function (data, extent) {\r\n    this.data = data;\r\n    if (extent && (!extent.eq(this.extent()))) {\r\n        this.silentSetExtent(extent);\r\n        this.drawNew();\r\n    } else {\r\n        this.drawData();\r\n    }\r\n    // note: don't call changed(), let the TableMorph handle it instead\r\n};\r\n\r\nTableCellMorph.prototype.getData = function () {\r\n    return this.data instanceof Array ? this.data[0] : this.data;\r\n};\r\n\r\nTableCellMorph.prototype.drawNew = function () {\r\n    this.image = newCanvas(this.extent());\r\n    this.drawData();\r\n};\r\n\r\nTableCellMorph.prototype.drawData = function (lbl, bg) {\r\n    var dta = lbl || this.dataRepresentation(this.data),\r\n        context = this.image.getContext('2d'),\r\n        fontSize = SyntaxElementMorph.prototype.fontSize,\r\n        empty = TableMorph.prototype.highContrast ? 'rgb(220, 220, 220)'\r\n                : 'transparent',\r\n        orphaned = 'rgb(217, 77, 17)',\r\n        fontStyle = this.isLabel ?\r\n                (this.data instanceof Array ? 'italic'  : '')\r\n                        : this.shouldBeList() ? 'bold' : '',\r\n        font = fontStyle + ' ' + fontSize + 'px Helvetica, Arial, sans-serif',\r\n        background = bg || (this.isLabel ? empty\r\n                : (this.shouldBeList() ? orphaned\r\n                        : (this.isOvershooting() ? 'white'\r\n                                : (isNil(this.data) ? empty : 'white')))),\r\n        foreground = !this.isLabel && this.shouldBeList()? 'white' : 'black',\r\n        width = this.width(),\r\n        height = this.height(),\r\n        txtWidth,\r\n        txtHeight,\r\n        x,\r\n        y;\r\n\r\n    context.clearRect(0, 0, width, height);\r\n    context.fillStyle = background;\r\n    if (this.shouldBeList()) {\r\n        BoxMorph.prototype.outlinePath.call(\r\n            this, context, SyntaxElementMorph.prototype.corner + 1, 0\r\n        );\r\n        context.fill();\r\n    } else if (this.isOvershooting()) {\r\n        this.raggedBoxPath(context);\r\n        context.fill();\r\n    } else {\r\n        context.fillRect(0, 0, width, height);\r\n    }\r\n\r\n    if (!dta) {return; }\r\n    if (dta instanceof HTMLCanvasElement) {\r\n        x = Math.max((width - dta.width) / 2, 0);\r\n        y = Math.max((height - dta.height) / 2, 0);\r\n        context.shadowOffsetX = 4;\r\n        context.shadowOffsetY = 4;\r\n        context.shadowBlur = 4;\r\n        context.shadowColor = 'lightgray';\r\n        context.drawImage(dta, x, y);\r\n    } else { // text\r\n        context.font = font;\r\n        context.textAlign = 'left';\r\n        context.textBaseline = 'bottom';\r\n        txtWidth = context.measureText(dta).width;\r\n        txtHeight = fontHeight(fontSize);\r\n        context.fillStyle = foreground;\r\n        x = Math.max((width - txtWidth) / 2, 0);\r\n        y = Math.max((height - txtHeight) / 2, 0);\r\n        context.fillText(dta, x, txtHeight + y);\r\n    }\r\n};\r\n\r\nTableCellMorph.prototype.dataRepresentation = function (dta) {\r\n    if (dta instanceof Morph) {\r\n        if (isSnapObject(dta)) {\r\n            return dta.thumbnail(new Point(40, 40));\r\n        } else {\r\n            return dta.fullImageClassic();\r\n        }\r\n    } else if (isString(dta)) {\r\n        return dta.length > 100 ? dta.slice(0, 100) + '...' : dta;\r\n    } else if (typeof dta === 'number') {\r\n        return dta.toString();\r\n    } else if (typeof dta === 'boolean') {\r\n        return SpriteMorph.prototype.booleanMorph.call(\r\n            null,\r\n            dta\r\n        ).fullImage();\r\n    } else if (dta instanceof Array) {\r\n        return this.dataRepresentation(dta[0]);\r\n    } else if (dta instanceof Variable) {\r\n        return this.dataRepresentation(dta.value);\r\n    } else if (dta instanceof HTMLCanvasElement) {\r\n        return dta;\r\n    } else if (dta instanceof Context) {\r\n        return dta.image();\r\n    } else if (dta instanceof Costume) {\r\n        return dta.thumbnail(new Point(40, 40));\r\n    } else if (dta instanceof Sound) {\r\n        return new SymbolMorph('notes', 30).image;\r\n    } else if (dta instanceof List) {\r\n        return this.listSymbol;\r\n        // return new ListWatcherMorph(dta).fullImageClassic();\r\n    } else {\r\n        return dta ? dta.toString() : (dta === 0 ? '0' : null);\r\n    }\r\n};\r\n\r\nTableCellMorph.prototype.raggedBoxPath = function (context) {\r\n    var width = this.width(),\r\n        height = this.height(),\r\n        x = width * 0.75,\r\n        step = height / 6,\r\n        y = 0;\r\n    context.beginPath();\r\n    context.moveTo(0, 0);\r\n    context.lineTo(width, 0);\r\n    for (y = 0; y < height; y += (step * 2)) {\r\n        context.lineTo(x, y + step);\r\n        context.lineTo(width, y + (step * 2));\r\n    }\r\n    context.lineTo(width, height);\r\n    context.lineTo(0, height);\r\n    context.closePath();\r\n};\r\n\r\nTableCellMorph.prototype.shouldBeList = function () {\r\n    return this.data instanceof Array;\r\n};\r\n\r\nTableCellMorph.prototype.isOvershooting = function () {\r\n    return this.data instanceof Variable;\r\n};\r\n\r\n// TableCellMorph events:\r\n\r\nTableCellMorph.prototype.mouseDoubleClick = function (pos) {\r\n    if (this.data instanceof Table || this.data instanceof List) {\r\n        new TableDialogMorph(this.data).popUp(this.world());\r\n    } else if (this.data instanceof Array && this.data[0] instanceof List) {\r\n        new TableDialogMorph(this.data[0]).popUp(this.world());\r\n    } else {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    }\r\n};\r\n\r\nTableCellMorph.prototype.mouseEnter = function () {\r\n    var tm, x, c;\r\n    if (this.isLabel) {\r\n        tm = this.parentThatIsA(TableMorph);\r\n        x = tm.world().hand.left() - tm.left();\r\n        c = tm.columnAt(x);\r\n        if (c > 0) {\r\n            this.drawData(c, 'rgb(220, 220, 250)');\r\n            this.changed();\r\n        }\r\n    }\r\n};\r\n\r\nTableCellMorph.prototype.mouseLeave = function () {\r\n    if (this.isLabel) {\r\n        this.drawData();\r\n        this.changed();\r\n    }\r\n};\r\n\r\n// TableMorph //////////////////////////////////////////////////////////\r\n\r\n// TableMorph inherits from FrameMorph:\r\n\r\nTableMorph.prototype = new FrameMorph();\r\nTableMorph.prototype.constructor = TableMorph;\r\nTableMorph.uber = FrameMorph.prototype;\r\n\r\n// TableMorph preferences settings:\r\n\r\nTableMorph.prototype.highContrast = false;\r\n\r\n// TableMorph instance creation:\r\n\r\nfunction TableMorph(\r\n    table,\r\n    // optional parameters below this line\r\n    scrollBarSize,\r\n    extent,\r\n    startRow,\r\n    startCol,\r\n    globalColWidth,\r\n    colWidths,\r\n    rowHeight,\r\n    colLabelHeight,\r\n    padding\r\n) {\r\n    this.init(\r\n        table,\r\n        scrollBarSize,\r\n        extent,\r\n        startRow,\r\n        startCol,\r\n        globalColWidth,\r\n        colWidths,\r\n        rowHeight,\r\n        colLabelHeight,\r\n        padding\r\n    );\r\n}\r\n\r\nTableMorph.prototype.init = function (\r\n    table,\r\n    scrollBarSize,\r\n    extent,\r\n    startRow,\r\n    startCol,\r\n    globalColWidth,\r\n    colWidths,\r\n    rowHeight,\r\n    colLabelHeight,\r\n    padding\r\n) {\r\n    // additional properties:\r\n    this.table = table;\r\n    this.scrollBarSize = scrollBarSize || MorphicPreferences.scrollBarSize;\r\n    this.startRow = startRow || 1;\r\n    this.startCol = startCol || 1;\r\n    this.textHeight = Math.ceil(\r\n        fontHeight(SyntaxElementMorph.prototype.fontSize) * 1.3\r\n    );\r\n    this.rowHeight = rowHeight || this.textHeight;\r\n    this.colWidths = colWidths || [];\r\n    this.globalColWidth = globalColWidth || Math.ceil(this.textHeight * 3.5);\r\n    this.colLabelHeight = colLabelHeight || this.textHeight;\r\n    this.padding = padding || SyntaxElementMorph.prototype.scale; //1;\r\n    this.tableVersion = this.table.lastChanged;\r\n\r\n    // scroll bars:\r\n    this.hBar = null;\r\n    this.vBar = null;\r\n\r\n    // cached properties (do not persist):\r\n    this.rowLabelWidth = 0;\r\n    this.columns = []; // relative left positions\r\n    this.rows = 0;\r\n\r\n    // cached properties for scrolling and resizing (do not persist):\r\n    this.maxStartRow = null;\r\n    this.maxStartCol = null;\r\n    this.dragAnchor = null;\r\n    this.resizeAnchor = null;\r\n    this.resizeCol = null;\r\n    this.resizeRow = null;\r\n\r\n    // cached property for updating (don not persist):\r\n    this.wantsUpdate = false;\r\n\r\n    // initialize inherited properties:\r\n    // make sure not to draw anything just yet\r\n    // therefore omit FrameMorph's properties (not needed here)\r\n    // and only initialize properties inherited from Morph:\r\n    Morph.prototype.init.call(this, true);\r\n\r\n    // override inherited properites:\r\n    // this.fps = 3; // this will slow down the sliders (!)\r\n    if (extent) {this.silentSetExtent(extent); }\r\n    this.initScrollBars();\r\n    this.drawNew();\r\n};\r\n\r\nTableMorph.prototype.initScrollBars = function () {\r\n    var myself = this;\r\n\r\n    // horizontal scroll bar - scrolls columns\r\n    this.hBar = new SliderMorph(\r\n        1, // start\r\n        null, // stop\r\n        null, // value\r\n        null, // size\r\n        'horizontal'\r\n    );\r\n    this.hBar.setHeight(this.scrollBarSize);\r\n    this.hBar.action = function (num) {\r\n        myself.showData(num, null, true);\r\n    };\r\n    this.hBar.isDraggable = false;\r\n    this.add(this.hBar);\r\n\r\n    // vertical scroll bar - scrolls rows\r\n    this.vBar = new SliderMorph(\r\n        1, // start\r\n        null, // stop\r\n        null, // value\r\n        null, // size\r\n        'vertical'\r\n    );\r\n    this.vBar.setWidth(this.scrollBarSize);\r\n    this.vBar.action = function (num) {\r\n        myself.showData(null, num, true);\r\n    };\r\n    this.vBar.isDraggable = false;\r\n    this.add(this.vBar);\r\n};\r\n\r\nTableMorph.prototype.updateScrollBars = function () {\r\n    if (this.maxStartCol === 1) {\r\n        this.hBar.hide();\r\n    } else {\r\n        this.hBar.show();\r\n        this.hBar.stop = this.maxStartCol;\r\n        this.hBar.value = this.startCol;\r\n        this.hBar.size = Math.max(\r\n            this.hBar.rangeSize() * this.columns.length / this.table.cols(),\r\n            this.hBar.rangeSize() / 10\r\n        );\r\n        this.hBar.drawNew();\r\n    }\r\n\r\n    this.vBar.stop = this.maxStartRow;\r\n    this.vBar.value = this.startRow;\r\n    if (this.maxStartRow === 1) {\r\n        this.vBar.hide();\r\n    } else {\r\n        this.vBar.show();\r\n        this.vBar.size = Math.max(\r\n            this.vBar.rangeSize() * this.rows / this.table.rows(),\r\n            this.vBar.rangeSize() / 10\r\n        );\r\n        this.vBar.drawNew();\r\n    }\r\n};\r\n\r\nTableMorph.prototype.drawNew = function () {\r\n    var context, w, i;\r\n    this.image = newCanvas(this.extent());\r\n    context = this.image.getContext('2d');\r\n    context.fillStyle = 'rgb(220, 220, 220)';\r\n    BoxMorph.prototype.outlinePath.call(\r\n        this, context, SyntaxElementMorph.prototype.corner + 1, 0\r\n    );\r\n    context.fill();\r\n\r\n    // determine and cache layout information\r\n    this.rowLabelWidth = this.rowLabelsWidth();\r\n    this.columns = this.columnsLayout();\r\n    this.rows = this.visibleRows();\r\n\r\n    // optionally draw grid\r\n    if (this.highContrast && this.table.cols() > 1) {\r\n        w = this.padding;\r\n        for (i = this.startCol; i <= this.table.cols(); i += 1) {\r\n            w += (this.colWidth(i) + this.padding);\r\n        }\r\n        context.fillStyle = 'darkGray';\r\n        context.fillRect(\r\n            this.padding + this.rowLabelWidth,\r\n            this.padding + this.colLabelHeight,\r\n            w,\r\n            (this.rowHeight + this.padding) *\r\n                (this.table.rows() + 1 - this.startRow) +\r\n                this.padding\r\n        );\r\n    }\r\n\r\n    this.buildCells();\r\n\r\n    // fix scroll bars layout\r\n    this.hBar.setWidth(this.width() - this.vBar.width());\r\n    this.hBar.setLeft(this.left());\r\n    this.hBar.setBottom(this.bottom());\r\n    this.vBar.setHeight(this.height() - this.hBar.height());\r\n    this.vBar.setRight(this.right());\r\n    this.vBar.setTop(this.top());\r\n};\r\n\r\nTableMorph.prototype.buildCells = function () {\r\n    // also populate cells with the correct data and\r\n    // arrange the layout of cells all in one pass\r\n    var cell, r, c,\r\n        pos = this.position();\r\n\r\n    // delete all existing cells\r\n    this.children = [];\r\n\r\n    // create cells\r\n    for (c = 0; c <= this.columns.length; c += 1) {\r\n        for (r = 0; r <= this.rows; r += 1) {\r\n            cell = new TableCellMorph(\r\n                this.table.get(\r\n                    !c ? c : c + this.startCol - 1,\r\n                    !r ? r : r + this.startRow - 1\r\n                ),\r\n                new Point(\r\n                    !c ? this.rowLabelWidth\r\n                            : this.colWidth(c + this.startCol - 1),\r\n                    !r ? this.colLabelHeight : this.rowHeight\r\n                ),\r\n                !(r && c), // isLabel\r\n                false // should be list\r\n            );\r\n            cell.setPosition(\r\n                new Point(\r\n                    !c ? this.padding\r\n                            : this.columns[c - 1],\r\n                    !r ? this.padding :\r\n                            this.padding * 2 + this.colLabelHeight +\r\n                                ((r - 1) * (this.rowHeight + this.padding))\r\n                ).add(pos)\r\n            );\r\n            this.add(cell);\r\n            if (isSnapObject(cell.getData())) {\r\n                this.wantsUpdate = true;\r\n            }\r\n        }\r\n    }\r\n    this.add(this.hBar);\r\n    this.add(this.vBar);\r\n    this.updateScrollBars();\r\n    this.changed();\r\n};\r\n\r\nTableMorph.prototype.drawData = function (noScrollUpdate) {\r\n    // redraw all cells with their current data or label\r\n    var cell, cellIdx = 0, r, c;\r\n    for (c = 0; c <= this.columns.length; c += 1) {\r\n        for (r = 0; r <= this.rows; r += 1) {\r\n            cell = this.children[cellIdx];\r\n            cellIdx += 1;\r\n            cell.setData(\r\n                this.table.get(\r\n                    !c ? c : c + this.startCol - 1,\r\n                    !r ? r : r + this.startRow - 1\r\n                )\r\n            );\r\n            if (isSnapObject(cell.getData())) {\r\n                this.wantsUpdate = true;\r\n            }\r\n        }\r\n    }\r\n    if (!noScrollUpdate) {this.updateScrollBars(); }\r\n    this.changed();\r\n};\r\n\r\n// TableMorph scrolling\r\n\r\nTableMorph.prototype.scroll = function (xSteps, ySteps) {\r\n    this.showData(\r\n        Math.min(\r\n            this.maxStartCol,\r\n            Math.max(1, this.startCol + Math.round(xSteps))\r\n        ),\r\n        Math.min(\r\n            this.maxStartRow,\r\n            Math.max(1, this.startRow + Math.round(ySteps))\r\n        )\r\n    );\r\n    this.updateScrollBars();\r\n};\r\n\r\nTableMorph.prototype.showData = function (startCol, startRow, noScrollUpdate) {\r\n    var c = startCol || this.startCol,\r\n        r = startRow || this.startRow;\r\n    if (c === this.startCol) {\r\n        if (r === this.startRow) {return; } // no change\r\n        this.startRow = r;\r\n        this.rows = this.visibleRows();\r\n        this.drawData(noScrollUpdate);\r\n    } else {\r\n        this.startCol = c;\r\n        this.startRow = r;\r\n        this.rows = this.visibleRows();\r\n        if (this.colWidths.length) {\r\n            this.columns = this.columnsLayout();\r\n            this.buildCells();\r\n        } else {\r\n            this.drawData(noScrollUpdate);\r\n        }\r\n    }\r\n};\r\n\r\n// TableMorph stepping\r\n\r\nTableMorph.prototype.step = function () {\r\n    if (this.dragAnchor) {\r\n        this.shiftCells(this.world().hand.position());\r\n    } else if (this.resizeAnchor) {\r\n        this.resizeCells(this.world().hand.position());\r\n    }\r\n    this.update();\r\n};\r\n\r\nTableMorph.prototype.update = function () {\r\n    var oldCols, oldRows,\r\n        version = this.table instanceof List ?\r\n            this.table.version(this.startRow, this.rows)\r\n                    : this.table.lastChanged;\r\n    if (this.tableVersion === version && !this.wantsUpdate) {\r\n        return;\r\n    }\r\n    this.wantsUpdate = false;\r\n    if (this.table instanceof List) {\r\n        oldCols = this.columns.length;\r\n        oldRows = this.rows;\r\n        this.rowLabelWidth = this.rowLabelsWidth();\r\n        this.columns = this.columnsLayout();\r\n        this.rows = this.visibleRows();\r\n        if (this.columns.length !== oldCols || (this.rows !== oldRows)) {\r\n            this.buildCells();\r\n        } else {\r\n            this.drawData();\r\n        }\r\n    } else { // Table\r\n        this.drawData();\r\n    }\r\n    this.tableVersion = version;\r\n};\r\n\r\n// TableMorph layout helpers (all private):\r\n\r\nTableMorph.prototype.rowLabelsWidth = function () {\r\n    var ctx = newCanvas().getContext('2d');\r\n    ctx.font = 'italic ' + SyntaxElementMorph.prototype.fontSize +\r\n        'px Helvetica, Arial, sans-serif';\r\n    return Math.max(\r\n        0,\r\n        Math.max.apply(\r\n            null,\r\n            this.table.columnNames().map(function (name) {\r\n                return name ? ctx.measureText(name).width : 0;\r\n            })\r\n        )\r\n    ) || ctx.measureText(this.table.rows().toString()).width +\r\n            (6 * SyntaxElementMorph.prototype.scale);\r\n};\r\n\r\nTableMorph.prototype.columnsLayout = function () {\r\n    // determines and maxStartCol and\r\n    // modifies startCol if needed\r\n    var c = [],\r\n        x = this.padding * 2 + this.rowLabelWidth,\r\n        colNum,\r\n        w;\r\n\r\n    // determine maxStartCol\r\n    colNum = this.table.cols();\r\n    w = x;\r\n    while (w < this.width() && colNum > 0) {\r\n        w += this.colWidth(colNum);\r\n        colNum -= 1;\r\n    }\r\n    if (colNum === 0 && (w < this.width())) {\r\n        this.maxStartCol = 1;\r\n    } else {\r\n        this.maxStartCol = Math.min(colNum + 2, this.table.cols());\r\n    }\r\n\r\n    // determine the left position of every shown column\r\n    this.startCol = Math.min(this.startCol, this.maxStartCol);\r\n    colNum = this.startCol;\r\n    while (x < this.width() &&\r\n        (colNum < (this.table.cols() + this.startCol))\r\n    ) {\r\n        w = this.colWidth(colNum);\r\n        c.push(x);\r\n        x += w;\r\n        x += this.padding;\r\n        colNum += 1;\r\n    }\r\n    return c;\r\n};\r\n\r\nTableMorph.prototype.colWidth = function (col) {\r\n    return this.colWidths[col - 1] || this.globalColWidth;\r\n};\r\n\r\nTableMorph.prototype.visibleRows = function () {\r\n    // determines maxStartRow and\r\n    // modifies startRow if needed\r\n    var rest = this.height() - this.colLabelHeight - this.padding,\r\n        possible;\r\n    if (rest < 0) {return 0; }\r\n    possible = Math.ceil(rest / (this.rowHeight + this.padding));\r\n    this.maxStartRow = Math.max(1, this.table.rows() - possible + 2);\r\n    this.startRow = Math.min(this.startRow, this.maxStartRow);\r\n    return Math.min(this.table.rows(), possible);\r\n};\r\n\r\nTableMorph.prototype.globalExtent = function () {\r\n    var i,\r\n        w = this.rowLabelsWidth() + 2,\r\n        cols = this.table.cols();\r\n    for (i = 0; i < cols; i += 1) {\r\n        w += this.colWidth(i + 1);\r\n        w += this.padding;\r\n    }\r\n    if (cols === 1) {\r\n        w += this.scrollBarSize;\r\n        w += this.padding * 2;\r\n    }\r\n    return new Point(\r\n        w + this.padding,\r\n        this.colLabelHeight + (this.padding * 2) +\r\n            ((this.rowHeight + this.padding) * this.table.rows())\r\n    );\r\n};\r\n\r\n// TableMorph events:\r\n\r\nTableMorph.prototype.mouseScroll = function (y, x) {\r\n    this.scroll(\r\n        -(+x * MorphicPreferences.mouseScrollAmount / 4),\r\n        -(+y * MorphicPreferences.mouseScrollAmount)\r\n    );\r\n};\r\n\r\nTableMorph.prototype.mouseDownLeft = function (pos) {\r\n    var rel = pos.subtract(this.position());\r\n    if (rel.x <= this.rowLabelWidth || (rel.y <= this.colLabelHeight)) {\r\n        // resize cells\r\n        if (this.world().currentKey === 16) { // shiftClicked\r\n            this.resizeCol = 0;\r\n        } else {\r\n            this.resizeCol = this.columnAt(rel.x);\r\n        }\r\n        this.resizeRow = (rel.y > (this.colLabelHeight));\r\n        this.resizeAnchor = pos;\r\n    } else {\r\n        // shift the viewed portion\r\n        this.resizeRow = null;\r\n        this.dragAnchor = pos;\r\n    }\r\n};\r\n\r\nTableMorph.prototype.mouseClickLeft = function (pos) {\r\n    this.dragAnchor = null;\r\n    this.resizeAnchor = null;\r\n        this.resizeRow = null;\r\n};\r\n\r\nTableMorph.prototype.mouseLeaveDragging = function (pos) {\r\n    this.dragAnchor = null;\r\n    this.resizeAnchor = null;\r\n        this.resizeRow = null;\r\n};\r\n\r\nTableMorph.prototype.mouseDoubleClick = function (pos) {\r\n    if (this.parentThatIsA(TableDialogMorph)) {\r\n        this.escalateEvent('mouseDoubleClick', pos);\r\n    } else {\r\n        new TableDialogMorph(\r\n            this.table,\r\n            this.globalColWidth,\r\n            this.colWidths,\r\n            this.rowHeight\r\n        ).popUp(this.world());\r\n    }\r\n};\r\n\r\n// TableMorph scrolling and resizing cells by \"hand\"\r\n\r\nTableMorph.prototype.shiftCells = function (pos) {\r\n    var delta = this.dragAnchor.subtract(pos),\r\n        scrollX = Math.round(delta.x / this.globalColWidth),\r\n        scrollY = Math.round(delta.y / this.rowHeight);\r\n    if (scrollX || scrollY) {\r\n        this.scroll(scrollX, scrollY);\r\n        this.dragAnchor = pos;\r\n    }\r\n};\r\n\r\nTableMorph.prototype.resizeCells = function (pos) {\r\n    var delta = pos.subtract(this.resizeAnchor),\r\n        i;\r\n\r\n    if (this.resizeCol) {\r\n        this.colWidths[this.resizeCol - 1] = Math.max(\r\n            16,\r\n            (this.colWidths[this.resizeCol - 1] || this.globalColWidth) +\r\n                delta.x\r\n        );\r\n    } else if (this.resizeRow) {\r\n        this.rowHeight = Math.max(16, this.rowHeight + delta.y);\r\n    } else {\r\n        this.globalColWidth = Math.max(16, this.globalColWidth + delta.x);\r\n        for (i = 0; i < this.colWidths.length; i += 1) {\r\n            if (this.colWidths[i]) {\r\n                this.colWidths[i] = Math.max(\r\n                    16,\r\n                    this.colWidths[i] + delta.x\r\n                );\r\n            }\r\n        }\r\n    }\r\n    if (this.highContrast) {\r\n        this.drawNew();\r\n    } else {\r\n        this.rowLabelWidth = this.rowLabelsWidth();\r\n        this.columns = this.columnsLayout();\r\n        this.rows = this.visibleRows();\r\n        this.buildCells();\r\n    }\r\n    this.resizeAnchor = pos;\r\n};\r\n\r\nTableMorph.prototype.columnAt = function (relativeX) {\r\n    var c = 0;\r\n    if (relativeX < (this.columns[0])) {\r\n        return 0;\r\n    }\r\n    while (relativeX > this.columns[c]) {\r\n        c += 1;\r\n    }\r\n    return c + this.startCol - 1;\r\n};\r\n\r\n// TableMorph context menu\r\n\r\nTableMorph.prototype.userMenu = function () {\r\n    var menu = new MenuMorph(this);\r\n    if (this.parentThatIsA(TableDialogMorph)) {\r\n        if (this.colWidths.length) {\r\n            menu.addItem('reset columns', 'resetColumns');\r\n            menu.addLine();\r\n        }\r\n        menu.addItem('open in another dialog...', 'openInDialog');\r\n        return menu;\r\n    }\r\n\r\n    if (this.colWidths.length) {\r\n        menu.addItem('reset columns', 'resetColumns');\r\n    }\r\n    menu.addItem('list view...', 'showListView');\r\n    menu.addLine();\r\n    menu.addItem('open in dialog...', 'openInDialog');\r\n    return menu;\r\n};\r\n\r\nTableMorph.prototype.resetColumns = function () {\r\n    this.colWidths = [];\r\n    if (this.highContrast) {\r\n        this.drawNew();\r\n    } else {\r\n        this.rowLabelWidth = this.rowLabelsWidth();\r\n        this.columns = this.columnsLayout();\r\n        this.rows = this.visibleRows();\r\n        this.buildCells();\r\n    }\r\n};\r\n\r\nTableMorph.prototype.openInDialog = function () {\r\n    new TableDialogMorph(\r\n        this.table,\r\n        this.globalColWidth,\r\n        this.colWidths,\r\n        this.rowHeight\r\n    ).popUp(this.world());\r\n};\r\n\r\nTableMorph.prototype.showListView = function () {\r\n    var view = this.parentThatIsAnyOf([\r\n        SpriteBubbleMorph,\r\n        SpeechBubbleMorph,\r\n        CellMorph\r\n    ]);\r\n    if (!view) {return; }\r\n    if (view instanceof SpriteBubbleMorph) {\r\n        view.changed();\r\n        view.drawNew(true);\r\n    } else if (view instanceof SpeechBubbleMorph) {\r\n        view.contents = new ListWatcherMorph(this.table);\r\n        view.contents.step = view.contents.update;\r\n        view.contents.expand(this.extent());\r\n        view.drawNew(true);\r\n    } else { // watcher cell\r\n        view.drawNew(true);\r\n        view.contentsMorph.expand(this.extent());\r\n    }\r\n    view.fixLayout();\r\n};\r\n\r\n// TableMorph updating:\r\n\r\nTableMorph.prototype.show = function () {\r\n    TableMorph.uber.show.call(this);\r\n    this.updateScrollBars();\r\n};\r\n\r\n// TableFrameMorph /////////////////////////////////////////////////////////\r\n\r\n// a UI for table morphs, for re-sizing tables and their columns\r\n\r\n// TableFrameMorph inherits from Morph:\r\n\r\nTableFrameMorph.prototype = new Morph();\r\nTableFrameMorph.prototype.constructor = TableFrameMorph;\r\nTableFrameMorph.uber = Morph.prototype;\r\n\r\n// TableFrameMorph instance creation:\r\n\r\nfunction TableFrameMorph(tableMorph, noResize) {\r\n    this.init(tableMorph, noResize);\r\n}\r\n\r\nTableFrameMorph.prototype.init = function (tableMorph, noResize) {\r\n    // additional properties:\r\n    this.tableMorph = tableMorph;\r\n    this.handle = null;\r\n\r\n    // initialize inherited properties:\r\n    TableFrameMorph.uber.init.call(this, true);\r\n\r\n    // override inherited properites:\r\n    this.color = 'transparent';\r\n    this.noticesTransparentClick = false;\r\n    this.bounds = this.tableMorph.bounds.copy();\r\n    this.add(this.tableMorph);\r\n\r\n    if (!noResize) {\r\n        this.handle = new HandleMorph(\r\n            this, // target\r\n            80, // minX\r\n            25, // minY\r\n            null, // insetX\r\n            null // insetY\r\n        );\r\n    }\r\n\r\n    this.drawNew();\r\n};\r\n\r\nTableFrameMorph.prototype.fixLayout = function () {\r\n    var ext = this.extent();\r\n    if (this.tableMorph.extent().eq(ext)) {return; }\r\n    this.tableMorph.setExtent(this.extent());\r\n    if (this.parent && this.parent.fixLayout) {\r\n        this.parent.fixLayout();\r\n    }\r\n};\r\n\r\nTableFrameMorph.prototype.setExtent = function (aPoint, silently) {\r\n    TableFrameMorph.uber.setExtent.call(this, aPoint, silently);\r\n    this.fixLayout();\r\n};\r\n\r\n// TableFrameMorph result / speech balloon support:\r\n\r\nTableFrameMorph.prototype.expand = function (maxExtent) {\r\n    var ext = this.tableMorph.globalExtent();\r\n    if (maxExtent) {\r\n        ext = ext.min(maxExtent);\r\n    }\r\n    this.setExtent(ext);\r\n    this.handle.setRight(this.right());\r\n    this.handle.setBottom(this.bottom());\r\n};\r\n\r\n// TableDialogMorph inherits from DialogBoxMorph:\r\n\r\nTableDialogMorph.prototype = new DialogBoxMorph();\r\nTableDialogMorph.prototype.constructor = TableDialogMorph;\r\nTableDialogMorph.uber = DialogBoxMorph.prototype;\r\n\r\n// TableDialogMorph instance creation:\r\n\r\nfunction TableDialogMorph(data, globalColWidth, colWidths, rowHeight) {\r\n    this.init(data, globalColWidth, colWidths, rowHeight);\r\n}\r\n\r\nTableDialogMorph.prototype.init = function (\r\n    data,\r\n    globalColWidth,\r\n    colWidths,\r\n    rowHeight\r\n) {\r\n    // additional properties:\r\n    this.handle = null;\r\n    this.data = data;\r\n    this.tableView = null;\r\n\r\n    // initialize inherited properties:\r\n    TableDialogMorph.uber.init.call(this);\r\n\r\n    // override inherited properites:\r\n    this.labelString = 'Table view';\r\n    this.createLabel();\r\n\r\n    // build contents\r\n    this.buildContents(data, globalColWidth, colWidths, rowHeight);\r\n};\r\n\r\nTableDialogMorph.prototype.buildContents = function (\r\n    data,\r\n    globalColWidth,\r\n    colWidths,\r\n    rowHeight\r\n) {\r\n    this.tableView = new TableMorph(\r\n        data,\r\n        null, // scrollBarSize\r\n        null, // extent\r\n        null, // startRow\r\n        null, // startCol\r\n        globalColWidth,\r\n        colWidths,\r\n        rowHeight,\r\n        null, // colLabelHeight\r\n        null // padding\r\n    );\r\n    this.addBody(new TableFrameMorph(this.tableView, true));\r\n    this.addButton('ok', 'OK');\r\n};\r\n\r\nTableDialogMorph.prototype.setInitialDimensions = function () {\r\n    var world = this.world(),\r\n        mex = world.extent().subtract(new Point(this.padding, this.padding)),\r\n        th = fontHeight(this.titleFontSize) + this.titlePadding * 3, // hm...\r\n        bh = this.buttons.height();\r\n    this.setExtent(\r\n        this.tableView.globalExtent().add(\r\n            new Point(this.padding * 2, this.padding * 2 + th + bh)\r\n        ).min(mex).max(new Point(100, 100))\r\n    );\r\n    this.setCenter(this.world().center());\r\n};\r\n\r\nTableDialogMorph.prototype.popUp = function (world) {\r\n    if (world) {\r\n        TableDialogMorph.uber.popUp.call(this, world);\r\n        this.setInitialDimensions();\r\n        this.handle = new HandleMorph(\r\n            this,\r\n            100,\r\n            100,\r\n            this.corner,\r\n            this.corner\r\n        );\r\n    }\r\n};\r\n\r\nTableDialogMorph.prototype.fixLayout =\r\n    BlockEditorMorph.prototype.fixLayout;\r\n//fin de Tables.js\r\n/*\r\n\r\n    symbols.js\r\n\r\n    graphical GUI-symbols for for morphic.js and Snap!\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    additional symbols have been contributed by members of the Snap!\r\n    open-source community, especially by Bernat Romagosa\r\n\r\n*/\r\n\r\n/*global modules, Morph, Point, newCanvas, Costume, radians, Color*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.symbols = '2017-September-26';\r\n\r\nvar SymbolMorph;\r\n\r\n// SymbolMorph //////////////////////////////////////////////////////////\r\n\r\n/*\r\n    I display graphical symbols, such as special letters. I have been\r\n    called into existence out of frustration about not being able to\r\n    consistently use Unicode characters to the same ends.\r\n\r\n    Symbols can also display costumes, if one is specified in lieu\r\n    of a name property, although this feature is currently not being\r\n    used because of asynchronous image loading issues.\r\n */\r\n\r\n// SymbolMorph inherits from Morph:\r\n\r\nSymbolMorph.prototype = new Morph();\r\nSymbolMorph.prototype.constructor = SymbolMorph;\r\nSymbolMorph.uber = Morph.prototype;\r\n\r\n// SymbolMorph available symbols:\r\n\r\nSymbolMorph.prototype.names = [\r\n    'square',\r\n    'pointRight',\r\n    'stepForward',\r\n    'gears',\r\n    'file',\r\n    'fullScreen',\r\n    'normalScreen',\r\n    'smallStage',\r\n    'normalStage',\r\n    'turtle',\r\n    'stage',\r\n    'turtleOutline',\r\n    'pause',\r\n    'flag',\r\n    'octagon',\r\n    'cloud',\r\n    'cloudOutline',\r\n    'cloudGradient',\r\n    'turnRight',\r\n    'turnLeft',\r\n    'storage',\r\n    'poster',\r\n    'flash',\r\n    'brush',\r\n    'rectangle',\r\n    'rectangleSolid',\r\n    'circle',\r\n    'circleSolid',\r\n    'line',\r\n    'cross',\r\n    'crosshairs',\r\n    'paintbucket',\r\n    'eraser',\r\n    'pipette',\r\n    'speechBubble',\r\n    'speechBubbleOutline',\r\n    'turnBack',\r\n    'turnForward',\r\n    'arrowUp',\r\n    'arrowUpOutline',\r\n    'arrowLeft',\r\n    'arrowLeftOutline',\r\n    'arrowDown',\r\n    'arrowDownOutline',\r\n    'arrowRight',\r\n    'arrowRightOutline',\r\n    'robot',\r\n    'magnifyingGlass',\r\n    'magnifierOutline',\r\n    'notes',\r\n    'camera',\r\n    'location',\r\n    'footprints',\r\n    'keyboard',\r\n    'keyboardFilled'\r\n];\r\n\r\n// SymbolMorph instance creation:\r\n\r\nfunction SymbolMorph(name, size, color, shadowOffset, shadowColor) {\r\n    this.init(name, size, color, shadowOffset, shadowColor);\r\n}\r\n\r\nSymbolMorph.prototype.init = function (\r\n    name, // or costume\r\n    size,\r\n    color,\r\n    shadowOffset,\r\n    shadowColor\r\n) {\r\n    this.isProtectedLabel = false; // participate in zebraing\r\n    this.isReadOnly = true;\r\n    this.name = name || 'square'; // can also be a costume\r\n    this.size = size || ((size === 0) ? 0 : 50);\r\n    this.shadowOffset = shadowOffset || new Point(0, 0);\r\n    this.shadowColor = shadowColor || null;\r\n\r\n    SymbolMorph.uber.init.call(this, true); // silently\r\n    this.color = color || new Color(0, 0, 0);\r\n    this.drawNew();\r\n};\r\n\r\n// SymbolMorph zebra coloring:\r\n\r\nSymbolMorph.prototype.setLabelColor = function (\r\n    textColor,\r\n    shadowColor,\r\n    shadowOffset\r\n) {\r\n    this.shadowOffset = shadowOffset || new Point();\r\n    this.shadowColor = shadowColor;\r\n    this.setColor(textColor);\r\n};\r\n\r\n// SymbolMorph displaying:\r\n\r\nSymbolMorph.prototype.drawNew = function () {\r\n    var ctx, x, y, sx, sy;\r\n    this.image = newCanvas(new Point(\r\n        this.symbolWidth() + Math.abs(this.shadowOffset.x),\r\n        this.size + Math.abs(this.shadowOffset.y)\r\n    ));\r\n    this.silentSetWidth(this.image.width);\r\n    this.silentSetHeight(this.image.height);\r\n    ctx = this.image.getContext('2d');\r\n    sx = this.shadowOffset.x < 0 ? 0 : this.shadowOffset.x;\r\n    sy = this.shadowOffset.y < 0 ? 0 : this.shadowOffset.y;\r\n    x = this.shadowOffset.x < 0 ? Math.abs(this.shadowOffset.x) : 0;\r\n    y = this.shadowOffset.y < 0 ? Math.abs(this.shadowOffset.y) : 0;\r\n    if (this.shadowColor) {\r\n        ctx.drawImage(\r\n            this.symbolCanvasColored(this.shadowColor),\r\n            sx,\r\n            sy\r\n        );\r\n    }\r\n    ctx.drawImage(\r\n        this.symbolCanvasColored(this.color),\r\n        x,\r\n        y\r\n    );\r\n};\r\n\r\nSymbolMorph.prototype.symbolCanvasColored = function (aColor) {\r\n    // private\r\n    if (this.name instanceof Costume) {\r\n        return this.name.thumbnail(new Point(this.symbolWidth(), this.size));\r\n    }\r\n\r\n    var canvas = newCanvas(new Point(this.symbolWidth(), this.size));\r\n\r\n    switch (this.name) {\r\n    case 'square':\r\n        return this.drawSymbolStop(canvas, aColor);\r\n    case 'pointRight':\r\n        return this.drawSymbolPointRight(canvas, aColor);\r\n    case 'stepForward':\r\n        return this.drawSymbolStepForward(canvas, aColor);\r\n    case 'gears':\r\n        return this.drawSymbolGears(canvas, aColor);\r\n    case 'file':\r\n        return this.drawSymbolFile(canvas, aColor);\r\n    case 'fullScreen':\r\n        return this.drawSymbolFullScreen(canvas, aColor);\r\n    case 'normalScreen':\r\n        return this.drawSymbolNormalScreen(canvas, aColor);\r\n    case 'smallStage':\r\n        return this.drawSymbolSmallStage(canvas, aColor);\r\n    case 'normalStage':\r\n        return this.drawSymbolNormalStage(canvas, aColor);\r\n    case 'turtle':\r\n        return this.drawSymbolTurtle(canvas, aColor);\r\n    case 'stage':\r\n        return this.drawSymbolStop(canvas, aColor);\r\n    case 'turtleOutline':\r\n        return this.drawSymbolTurtleOutline(canvas, aColor);\r\n    case 'pause':\r\n        return this.drawSymbolPause(canvas, aColor);\r\n    case 'flag':\r\n        return this.drawSymbolFlag(canvas, aColor);\r\n    case 'octagon':\r\n        return this.drawSymbolOctagon(canvas, aColor);\r\n    case 'cloud':\r\n        return this.drawSymbolCloud(canvas, aColor);\r\n    case 'cloudOutline':\r\n        return this.drawSymbolCloudOutline(canvas, aColor);\r\n    case 'cloudGradient':\r\n        return this.drawSymbolCloudGradient(canvas, aColor);\r\n    case 'turnRight':\r\n        return this.drawSymbolTurnRight(canvas, aColor);\r\n    case 'turnLeft':\r\n        return this.drawSymbolTurnLeft(canvas, aColor);\r\n    case 'storage':\r\n        return this.drawSymbolStorage(canvas, aColor);\r\n    case 'poster':\r\n        return this.drawSymbolPoster(canvas, aColor);\r\n    case 'flash':\r\n        return this.drawSymbolFlash(canvas, aColor);\r\n    case 'brush':\r\n        return this.drawSymbolBrush(canvas, aColor);\r\n    case 'rectangle':\r\n        return this.drawSymbolRectangle(canvas, aColor);\r\n    case 'rectangleSolid':\r\n        return this.drawSymbolRectangleSolid(canvas, aColor);\r\n    case 'circle':\r\n        return this.drawSymbolCircle(canvas, aColor);\r\n    case 'circleSolid':\r\n        return this.drawSymbolCircleSolid(canvas, aColor);\r\n    case 'line':\r\n        return this.drawSymbolLine(canvas, aColor);\r\n    case 'cross':\r\n        return this.drawSymbolCross(canvas, aColor);\r\n    case 'crosshairs':\r\n        return this.drawSymbolCrosshairs(canvas, aColor);\r\n    case 'paintbucket':\r\n        return this.drawSymbolPaintbucket(canvas, aColor);\r\n    case 'eraser':\r\n        return this.drawSymbolEraser(canvas, aColor);\r\n    case 'pipette':\r\n        return this.drawSymbolPipette(canvas, aColor);\r\n    case 'speechBubble':\r\n        return this.drawSymbolSpeechBubble(canvas, aColor);\r\n    case 'speechBubbleOutline':\r\n        return this.drawSymbolSpeechBubbleOutline(canvas, aColor);\r\n    case 'turnBack':\r\n        return this.drawSymbolTurnBack(canvas, aColor);\r\n    case 'turnForward':\r\n        return this.drawSymbolTurnForward(canvas, aColor);\r\n    case 'arrowUp':\r\n        return this.drawSymbolArrowUp(canvas, aColor);\r\n    case 'arrowUpOutline':\r\n        return this.drawSymbolArrowUpOutline(canvas, aColor);\r\n    case 'arrowLeft':\r\n        return this.drawSymbolArrowLeft(canvas, aColor);\r\n    case 'arrowLeftOutline':\r\n        return this.drawSymbolArrowLeftOutline(canvas, aColor);\r\n    case 'arrowDown':\r\n        return this.drawSymbolArrowDown(canvas, aColor);\r\n    case 'arrowDownOutline':\r\n        return this.drawSymbolArrowDownOutline(canvas, aColor);\r\n    case 'arrowRight':\r\n        return this.drawSymbolArrowRight(canvas, aColor);\r\n    case 'arrowRightOutline':\r\n        return this.drawSymbolArrowRightOutline(canvas, aColor);\r\n    case 'robot':\r\n        return this.drawSymbolRobot(canvas, aColor);\r\n    case 'magnifyingGlass':\r\n        return this.drawSymbolMagnifyingGlass(canvas, aColor);\r\n    case 'magnifierOutline':\r\n        return this.drawSymbolMagnifierOutline(canvas, aColor);\r\n    case 'notes':\r\n        return this.drawSymbolNotes(canvas, aColor);\r\n    case 'camera':\r\n        return this.drawSymbolCamera(canvas, aColor);\r\n    case 'location':\r\n        return this.drawSymbolLocation(canvas, aColor);\r\n    case 'footprints':\r\n        return this.drawSymbolFootprints(canvas, aColor);\r\n    case 'keyboard':\r\n        return this.drawSymbolKeyboard(canvas, aColor);\r\n    case 'keyboardFilled':\r\n        return this.drawSymbolKeyboardFilled(canvas, aColor);\r\n    default:\r\n        return canvas;\r\n    }\r\n};\r\n\r\nSymbolMorph.prototype.symbolWidth = function () {\r\n    // private\r\n    var size = this.size;\r\n\r\n    if (this.name instanceof Costume) {\r\n        return (size / this.name.height()) * this.name.width();\r\n    }\r\n    switch (this.name) {\r\n    case 'pointRight':\r\n        return Math.sqrt(size * size - Math.pow(size / 2, 2));\r\n    case 'location':\r\n        return size * 0.6;\r\n    case 'flash':\r\n    case 'file':\r\n        return size * 0.8;\r\n    case 'smallStage':\r\n    case 'normalStage':\r\n        return size * 1.2;\r\n    case 'turtle':\r\n    case 'turtleOutline':\r\n    case 'stage':\r\n        return size * 1.3;\r\n    case 'cloud':\r\n    case 'cloudGradient':\r\n    case 'cloudOutline':\r\n    case 'turnBack':\r\n    case 'turnForward':\r\n    case 'keyboard':\r\n    case 'keyboardFilled':\r\n        return size * 1.6;\r\n    case 'turnRight':\r\n    case 'turnLeft':\r\n        return size / 3 * 2;\r\n    default:\r\n        return size;\r\n    }\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolStop = function (canvas, color) {\r\n    // answer a canvas showing a vertically centered square\r\n    var ctx = canvas.getContext('2d');\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolPointRight = function (canvas, color) {\r\n    // answer a canvas showing a right-pointing, equilateral triangle\r\n    var ctx = canvas.getContext('2d');\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(canvas.width, Math.round(canvas.height / 2));\r\n    ctx.lineTo(0, canvas.height);\r\n    ctx.lineTo(0, 0);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolStepForward = function (canvas, color) {\r\n    // answer a canvas showing a right-pointing triangle\r\n    // followed by a vertical bar\r\n    var ctx = canvas.getContext('2d');\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(canvas.width * 0.75, Math.round(canvas.height / 2));\r\n    ctx.lineTo(0, canvas.height);\r\n    ctx.lineTo(0, 0);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    ctx.fillRect(\r\n        canvas.width * 0.75,\r\n        0,\r\n        canvas.width * 0.25,\r\n        canvas.height\r\n    );\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolGears = function (canvas, color) {\r\n    // answer a canvas showing gears\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        r = w / 2,\r\n        e = w / 6;\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = canvas.width / 7;\r\n\r\n    ctx.beginPath();\r\n    ctx.arc(r, r, w, radians(0), radians(360), true);\r\n    ctx.arc(r, r, e * 1.5, radians(0), radians(360), false);\r\n    ctx.closePath();\r\n    ctx.clip();\r\n\r\n    ctx.moveTo(0, r);\r\n    ctx.lineTo(w, r);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(r, 0);\r\n    ctx.lineTo(r, w);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(e, e);\r\n    ctx.lineTo(w - e, w - e);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(w - e, e);\r\n    ctx.lineTo(e, w - e);\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolFile = function (canvas, color) {\r\n    // answer a canvas showing a page symbol\r\n    var ctx = canvas.getContext('2d'),\r\n        w = Math.min(canvas.width, canvas.height) / 2;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(w, 0);\r\n    ctx.lineTo(w, w);\r\n    ctx.lineTo(canvas.width, w);\r\n    ctx.lineTo(canvas.width, canvas.height);\r\n    ctx.lineTo(0, canvas.height);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.fillStyle = color.darker(25).toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(w, 0);\r\n    ctx.lineTo(canvas.width, w);\r\n    ctx.lineTo(w, w);\r\n    ctx.lineTo(w, 0);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolFullScreen = function (canvas, color) {\r\n    // answer a canvas showing two arrows pointing diagonally outwards\r\n    var ctx = canvas.getContext('2d'),\r\n        h = canvas.height,\r\n        c = canvas.width / 2,\r\n        off = canvas.width / 20,\r\n        w = canvas.width / 2;\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = canvas.width / 5;\r\n    ctx.moveTo(c - off, c + off);\r\n    ctx.lineTo(0, h);\r\n    ctx.stroke();\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = canvas.width / 5;\r\n    ctx.moveTo(c + off, c - off);\r\n    ctx.lineTo(h, 0);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, h);\r\n    ctx.lineTo(0, h - w);\r\n    ctx.lineTo(w, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(h, 0);\r\n    ctx.lineTo(h - w, 0);\r\n    ctx.lineTo(h, w);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolNormalScreen = function (canvas, color) {\r\n    // answer a canvas showing two arrows pointing diagonally inwards\r\n    var ctx = canvas.getContext('2d'),\r\n        h = canvas.height,\r\n        c = canvas.width / 2,\r\n        off = canvas.width / 20,\r\n        w = canvas.width;\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = canvas.width / 5;\r\n    ctx.moveTo(c - off * 3, c + off * 3);\r\n    ctx.lineTo(0, h);\r\n    ctx.stroke();\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = canvas.width / 5;\r\n    ctx.moveTo(c + off * 3, c - off * 3);\r\n    ctx.lineTo(h, 0);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(c + off, c - off);\r\n    ctx.lineTo(w, c - off);\r\n    ctx.lineTo(c + off, 0);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(c - off, c + off);\r\n    ctx.lineTo(0, c + off);\r\n    ctx.lineTo(c - off, w);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolSmallStage = function (canvas, color) {\r\n    // answer a canvas showing a stage toggling symbol\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        w2 = w / 2,\r\n        h2 = h / 2;\r\n\r\n    ctx.fillStyle = color.darker(40).toString();\r\n    ctx.fillRect(0, 0, w, h);\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(w2, 0, w2, h2);\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolNormalStage = function (canvas, color) {\r\n    // answer a canvas showing a stage toggling symbol\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        w2 = w / 2,\r\n        h2 = h / 2;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, w, h);\r\n\r\n    ctx.fillStyle = color.darker(25).toString();\r\n    ctx.fillRect(w2, 0, w2, h2);\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurtle = function (canvas, color) {\r\n    // answer a canvas showing a turtle\r\n    var ctx = canvas.getContext('2d');\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(canvas.width, canvas.height / 2);\r\n    ctx.lineTo(0, canvas.height);\r\n    ctx.lineTo(canvas.height / 2, canvas.height / 2);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurtleOutline = function (canvas, color) {\r\n    // answer a canvas showing a turtle\r\n    var ctx = canvas.getContext('2d');\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(canvas.width, canvas.height / 2);\r\n    ctx.lineTo(0, canvas.height);\r\n    ctx.lineTo(canvas.height / 2, canvas.height / 2);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolPause = function (canvas, color) {\r\n    // answer a canvas showing two parallel rectangles\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width / 5;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, w * 2, canvas.height);\r\n    ctx.fillRect(w * 3, 0, w * 2, canvas.height);\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolFlag = function (canvas, color) {\r\n    // answer a canvas showing a flag\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        l = Math.max(w / 12, 1),\r\n        h = canvas.height;\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(l / 2, 0);\r\n    ctx.lineTo(l / 2, canvas.height);\r\n    ctx.stroke();\r\n\r\n    ctx.lineWidth = h / 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, h / 4);\r\n    ctx.bezierCurveTo(\r\n        w * 0.8,\r\n        h / 4,\r\n        w * 0.1,\r\n        h * 0.5,\r\n        w,\r\n        h * 0.5\r\n    );\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolOctagon = function (canvas, color) {\r\n    // answer a canvas showing an octagon\r\n    var ctx = canvas.getContext('2d'),\r\n        side = canvas.width,\r\n        vert = (side - (side * 0.383)) / 2;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(vert, 0);\r\n    ctx.lineTo(side - vert, 0);\r\n    ctx.lineTo(side, vert);\r\n    ctx.lineTo(side, side - vert);\r\n    ctx.lineTo(side - vert, side);\r\n    ctx.lineTo(vert, side);\r\n    ctx.lineTo(0, side - vert);\r\n    ctx.lineTo(0, vert);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCloud = function (canvas, color) {\r\n    // answer a canvas showing an cloud\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r1 = h * 2 / 5,\r\n        r2 = h / 4,\r\n        r3 = h * 3 / 10,\r\n        r4 = h / 5;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(r2, h - r2, r2, radians(90), radians(259), false);\r\n    ctx.arc(w / 20 * 5, h / 9 * 4, r4, radians(165), radians(300), false);\r\n    ctx.arc(w / 20 * 11, r1, r1, radians(200), radians(357), false);\r\n    ctx.arc(w - r3, h - r3, r3, radians(269), radians(90), false);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCloudGradient = function (canvas, color) {\r\n    // answer a canvas showing an cloud\r\n    var ctx = canvas.getContext('2d'),\r\n        gradient,\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r1 = h * 2 / 5,\r\n        r2 = h / 4,\r\n        r3 = h * 3 / 10,\r\n        r4 = h / 5;\r\n\r\n    gradient = ctx.createRadialGradient(\r\n        0,\r\n        0,\r\n        0,\r\n        0,\r\n        0,\r\n        w\r\n    );\r\n    gradient.addColorStop(0, color.lighter(25).toString());\r\n    gradient.addColorStop(1, color.darker(25).toString());\r\n    ctx.fillStyle = gradient;\r\n    ctx.beginPath();\r\n    ctx.arc(r2, h - r2, r2, radians(90), radians(259), false);\r\n    ctx.arc(w / 20 * 5, h / 9 * 4, r4, radians(165), radians(300), false);\r\n    ctx.arc(w / 20 * 11, r1, r1, radians(200), radians(357), false);\r\n    ctx.arc(w - r3, h - r3, r3, radians(269), radians(90), false);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCloudOutline = function (canvas, color) {\r\n    // answer a canvas showing an cloud\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r1 = h * 2 / 5,\r\n        r2 = h / 4,\r\n        r3 = h * 3 / 10,\r\n        r4 = h / 5;\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(r2 + 1, h - r2 - 1, r2, radians(90), radians(259), false);\r\n    ctx.arc(w / 20 * 5, h / 9 * 4, r4, radians(165), radians(300), false);\r\n    ctx.arc(w / 20 * 11, r1 + 1, r1, radians(200), radians(357), false);\r\n    ctx.arc(w - r3 - 1, h - r3 - 1, r3, radians(269), radians(90), false);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurnRight = function (canvas, color) {\r\n    // answer a canvas showing a right-turning arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        l = Math.max(w / 10, 1),\r\n        r = w / 2;\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(r, r * 2, r - l / 2, radians(0), radians(-90), false);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(w, r);\r\n    ctx.lineTo(r, 0);\r\n    ctx.lineTo(r, r * 2);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurnLeft = function (canvas, color) {\r\n    // answer a canvas showing a left-turning arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        l = Math.max(w / 10, 1),\r\n        r = w / 2;\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(r, r * 2, r - l / 2, radians(180), radians(-90), true);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, r);\r\n    ctx.lineTo(r, 0);\r\n    ctx.lineTo(r, r * 2);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolStorage = function (canvas, color) {\r\n    // answer a canvas showing a stack of three disks\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r = canvas.height,\r\n        unit = canvas.height / 11;\r\n\r\n    function drawDisk(bottom, fillTop) {\r\n        ctx.fillStyle = color.toString();\r\n        ctx.beginPath();\r\n        ctx.arc(w / 2, bottom - h, r, radians(60), radians(120), false);\r\n        ctx.lineTo(0, bottom - unit * 2);\r\n        ctx.arc(\r\n            w / 2,\r\n            bottom - h - unit * 2,\r\n            r,\r\n            radians(120),\r\n            radians(60),\r\n            true\r\n        );\r\n        ctx.closePath();\r\n        ctx.fill();\r\n\r\n        ctx.fillStyle = color.darker(25).toString();\r\n        ctx.beginPath();\r\n\r\n        if (fillTop) {\r\n            ctx.arc(\r\n                w / 2,\r\n                bottom - h - unit * 2,\r\n                r,\r\n                radians(120),\r\n                radians(60),\r\n                true\r\n            );\r\n        }\r\n\r\n        ctx.arc(\r\n            w / 2,\r\n            bottom + unit * 6 + 1,\r\n            r,\r\n            radians(60),\r\n            radians(120),\r\n            true\r\n        );\r\n        ctx.closePath();\r\n\r\n        if (fillTop) {\r\n            ctx.fill();\r\n        } else {\r\n            ctx.stroke();\r\n        }\r\n    }\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    drawDisk(h);\r\n    drawDisk(h - unit * 3);\r\n    drawDisk(h - unit * 6, false);\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolPoster = function (canvas, color) {\r\n    // answer a canvas showing a poster stand\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        bottom = h * 0.75,\r\n        edge = canvas.height / 5;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.strokeStyle = color.toString();\r\n\r\n    ctx.lineWidth = w / 15;\r\n    ctx.moveTo(w / 2, h / 3);\r\n    ctx.lineTo(w / 6, h);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(w / 2, h / 3);\r\n    ctx.lineTo(w / 2, h);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(w / 2, h / 3);\r\n    ctx.lineTo(w * 5 / 6, h);\r\n    ctx.stroke();\r\n\r\n    ctx.fillRect(0, 0, w, bottom);\r\n    ctx.clearRect(0, bottom, w, w / 20);\r\n\r\n    ctx.clearRect(w - edge, bottom - edge, edge + 1, edge + 1);\r\n\r\n    ctx.fillStyle = color.darker(25).toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(w, bottom - edge);\r\n    ctx.lineTo(w - edge, bottom - edge);\r\n    ctx.lineTo(w - edge, bottom);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolFlash = function (canvas, color) {\r\n    // answer a canvas showing a flash\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        w3 = w / 3,\r\n        h = canvas.height,\r\n        h3 = h / 3,\r\n        off = h3 / 3;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(w3, 0);\r\n    ctx.lineTo(0, h3);\r\n    ctx.lineTo(w3, h3);\r\n    ctx.lineTo(0, h3 * 2);\r\n    ctx.lineTo(w3, h3 * 2);\r\n    ctx.lineTo(0, h);\r\n    ctx.lineTo(w, h3 * 2 - off);\r\n    ctx.lineTo(w3 * 2, h3 * 2 - off);\r\n    ctx.lineTo(w, h3 - off);\r\n    ctx.lineTo(w3 * 2, h3 - off);\r\n    ctx.lineTo(w, 0);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolBrush = function (canvas, color) {\r\n    // answer a canvas showing a paintbrush\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        l = Math.max(w / 30, 0.5);\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(w / 8 * 3, h / 2);\r\n    ctx.quadraticCurveTo(0, h / 2, l, h - l);\r\n    ctx.quadraticCurveTo(w / 2, h, w / 2, h / 8 * 5);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.lineJoin = 'round';\r\n    ctx.lineCap = 'round';\r\n    ctx.strokeStyle = color.toString();\r\n\r\n    ctx.moveTo(w / 8 * 3, h / 2);\r\n    ctx.lineTo(w * 0.75, l);\r\n    ctx.quadraticCurveTo(w, 0, w - l, h * 0.25);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(w / 2, h / 8 * 5);\r\n    ctx.lineTo(w - l, h * 0.25);\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolRectangle = function (canvas, color) {\r\n    // answer a canvas showing a rectangle\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.width,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, l);\r\n    ctx.lineTo(w - l, l);\r\n    ctx.lineTo(w - l, h - l);\r\n    ctx.lineTo(l, h - l);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolRectangleSolid = function (canvas, color) {\r\n    // answer a canvas showing a solid rectangle\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.width;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(w, 0);\r\n    ctx.lineTo(w, h);\r\n    ctx.lineTo(0, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCircle = function (canvas, color) {\r\n    // answer a canvas showing a circle\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.arc(w / 2, w / 2, w / 2 - l, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCircleSolid = function (canvas, color) {\r\n    // answer a canvas showing a solid circle\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.arc(w / 2, w / 2, w / 2, radians(0), radians(360), false);\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolLine = function (canvas, color) {\r\n    // answer a canvas showing a plus sign cross\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.lineCap = 'round';\r\n    ctx.moveTo(l, l);\r\n    ctx.lineTo(w - l, h - l);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCross = function (canvas, color) {\r\n    // answer a canvas showing a diagonal line\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.lineCap = 'round';\r\n    ctx.moveTo(l, w / 2);\r\n    ctx.lineTo(w - l, w / 2);\r\n    ctx.stroke();\r\n    ctx.moveTo(w / 2, l);\r\n    ctx.lineTo(w / 2, w - l);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCrosshairs = function (canvas, color) {\r\n    // answer a canvas showing a crosshairs\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        l = 0.5;\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.moveTo(l, h / 2);\r\n    ctx.lineTo(w - l, h / 2);\r\n    ctx.stroke();\r\n    ctx.moveTo(w / 2, l);\r\n    ctx.lineTo(w / 2, h - l);\r\n    ctx.stroke();\r\n    ctx.moveTo(w / 2, h / 2);\r\n    ctx.arc(w / 2, w / 2, w / 3 - l, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolPaintbucket = function (canvas, color) {\r\n    // answer a canvas showing a paint bucket\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 5,\r\n        l = Math.max(w / 30, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 2, n);\r\n    ctx.lineTo(n * 4, n * 3);\r\n    ctx.lineTo(n * 3, n * 4);\r\n    ctx.quadraticCurveTo(n * 2, h, n, n * 4);\r\n    ctx.quadraticCurveTo(0, n * 3, n, n * 2);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.moveTo(n * 2, n * 2.5);\r\n    ctx.arc(n * 2, n * 2.5, l, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(n * 2, n * 2.5);\r\n    ctx.lineTo(n * 2, n / 2 + l);\r\n    ctx.stroke();\r\n\r\n    ctx.arc(n * 1.5, n / 2 + l, n / 2, radians(0), radians(180), true);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(n, n / 2 + l);\r\n    ctx.lineTo(n, n * 2);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 3.5, n * 3.5);\r\n    ctx.quadraticCurveTo(w, n * 3.5, w - l, h);\r\n    ctx.lineTo(w, h);\r\n    ctx.quadraticCurveTo(w, n * 2, n * 2.5, n * 1.5);\r\n    ctx.lineTo(n * 4, n * 3);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolEraser = function (canvas, color) {\r\n    // answer a canvas showing an eraser\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 4,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 3, l);\r\n    ctx.lineTo(l, n * 3);\r\n    ctx.quadraticCurveTo(n, h, n * 2, n * 3);\r\n    ctx.lineTo(w - l, n);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 3, 0);\r\n    ctx.lineTo(n * 1.5, n * 1.5);\r\n    ctx.lineTo(n * 2.5, n * 2.5);\r\n    ctx.lineTo(w, n);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolPipette = function (canvas, color) {\r\n    // answer a canvas showing an eyedropper\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 4,\r\n        n2 = n / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, h - l);\r\n    ctx.quadraticCurveTo(n2, h - n2, n2, h - n);\r\n    ctx.lineTo(n * 2, n * 1.5);\r\n    ctx.stroke();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, h - l);\r\n    ctx.quadraticCurveTo(n2, h - n2, n, h - n2);\r\n    ctx.lineTo(n * 2.5, n * 2);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.arc(n * 3, n, n - l, radians(0), radians(360), false);\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 2, n);\r\n    ctx.lineTo(n * 3, n * 2);\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolSpeechBubble = function (canvas, color) {\r\n    // answer a canvas showing a speech bubble\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 3,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(n, n * 2);\r\n    ctx.quadraticCurveTo(l, n * 2, l, n);\r\n    ctx.quadraticCurveTo(l, l, n, l);\r\n    ctx.lineTo(n * 2, l);\r\n    ctx.quadraticCurveTo(w - l, l, w - l, n);\r\n    ctx.quadraticCurveTo(w - l, n * 2, n * 2, n * 2);\r\n    ctx.lineTo(n / 2, h - l);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolSpeechBubbleOutline = function (\r\n    canvas,\r\n    color\r\n) {\r\n    // answer a canvas showing a speech bubble\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 3,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(n, n * 2);\r\n    ctx.quadraticCurveTo(l, n * 2, l, n);\r\n    ctx.quadraticCurveTo(l, l, n, l);\r\n    ctx.lineTo(n * 2, l);\r\n    ctx.quadraticCurveTo(w - l, l, w - l, n);\r\n    ctx.quadraticCurveTo(w - l, n * 2, n * 2, n * 2);\r\n    ctx.lineTo(n / 2, h - l);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurnBack = function (canvas, aColor) {\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        w2 = canvas.width / 2,\r\n        h2 = canvas.height / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.fillStyle = aColor.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, h2);\r\n    ctx.lineTo(w2, 0);\r\n    ctx.lineTo(w2, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    ctx.lineWidth = l * 3;\r\n    ctx.strokeStyle = aColor.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(w2, h, h2, radians(0), radians(-90), true);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolTurnForward = function (canvas, aColor) {\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        w2 = canvas.width / 2,\r\n        h2 = canvas.height / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.fillStyle = aColor.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(w, h2);\r\n    ctx.lineTo(w2, 0);\r\n    ctx.lineTo(w2, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    ctx.lineWidth = l * 3;\r\n    ctx.strokeStyle = aColor.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(w2, h, h2, radians(-180), radians(-90), false);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowUp = function (canvas, color) {\r\n    // answer a canvas showing an up arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, n);\r\n    ctx.lineTo(n, l);\r\n    ctx.lineTo(w - l, n);\r\n    ctx.lineTo(w * 0.65, n);\r\n    ctx.lineTo(w * 0.65, h - l);\r\n    ctx.lineTo(w * 0.35, h - l);\r\n    ctx.lineTo(w * 0.35, n);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowUpOutline = function (canvas, color) {\r\n    // answer a canvas showing an up arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.lineWidth = l * 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, n);\r\n    ctx.lineTo(n, l);\r\n    ctx.lineTo(w - l, n);\r\n    ctx.lineTo(w * 0.65, n);\r\n    ctx.lineTo(w * 0.65, h - l);\r\n    ctx.lineTo(w * 0.35, h - l);\r\n    ctx.lineTo(w * 0.35, n);\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowDown = function (canvas, color) {\r\n    // answer a canvas showing a down arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(w, w);\r\n    ctx.rotate(radians(180));\r\n    this.drawSymbolArrowUp(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowDownOutline = function (canvas, color) {\r\n    // answer a canvas showing a down arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(w, w);\r\n    ctx.rotate(radians(180));\r\n    this.drawSymbolArrowUpOutline(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowLeft = function (canvas, color) {\r\n    // answer a canvas showing a left arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(0, w);\r\n    ctx.rotate(radians(-90));\r\n    this.drawSymbolArrowUp(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowLeftOutline = function (canvas, color) {\r\n    // answer a canvas showing a left arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(0, w);\r\n    ctx.rotate(radians(-90));\r\n    this.drawSymbolArrowUpOutline(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowRight = function (canvas, color) {\r\n    // answer a canvas showing a right arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(w, 0);\r\n    ctx.rotate(radians(90));\r\n    this.drawSymbolArrowUp(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolArrowRightOutline = function (canvas, color) {\r\n    // answer a canvas showing a right arrow\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width;\r\n    ctx.save();\r\n    ctx.translate(w, 0);\r\n    ctx.rotate(radians(90));\r\n    this.drawSymbolArrowUpOutline(canvas, color);\r\n    ctx.restore();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolRobot = function (canvas, color) {\r\n    // answer a canvas showing a humanoid robot\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        n = canvas.width / 6,\r\n        n2 = n / 2,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.fillStyle = color.toString();\r\n    //ctx.lineWidth = l * 2;\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n + l, n);\r\n    ctx.lineTo(n * 2, n);\r\n    ctx.lineTo(n * 2.5, n * 1.5);\r\n    ctx.lineTo(n * 3.5, n * 1.5);\r\n    ctx.lineTo(n * 4, n);\r\n    ctx.lineTo(n * 5 - l, n);\r\n    ctx.lineTo(n * 4, n * 3);\r\n    ctx.lineTo(n * 4, n * 4 - l);\r\n    ctx.lineTo(n * 2, n * 4 - l);\r\n    ctx.lineTo(n * 2, n * 3);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 2.75, n + l);\r\n    ctx.lineTo(n * 2.4, n);\r\n    ctx.lineTo(n * 2.2, 0);\r\n    ctx.lineTo(n * 3.8, 0);\r\n    ctx.lineTo(n * 3.6, n);\r\n    ctx.lineTo(n * 3.25, n + l);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 2.5, n * 4);\r\n    ctx.lineTo(n, n * 4);\r\n    ctx.lineTo(n2 + l, h);\r\n    ctx.lineTo(n * 2, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 3.5, n * 4);\r\n    ctx.lineTo(n * 5, n * 4);\r\n    ctx.lineTo(w - (n2 + l), h);\r\n    ctx.lineTo(n * 4, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n, n);\r\n    ctx.lineTo(l, n * 1.5);\r\n    ctx.lineTo(l, n * 3.25);\r\n    ctx.lineTo(n * 1.5, n * 3.5);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(n * 5, n);\r\n    ctx.lineTo(w - l, n * 1.5);\r\n    ctx.lineTo(w - l, n * 3.25);\r\n    ctx.lineTo(n * 4.5, n * 3.5);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolMagnifyingGlass = function (canvas, color) {\r\n    // answer a canvas showing a magnifying glass\r\n    var ctx = canvas.getContext('2d'),\r\n        gradient,\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r = w * 0.3,\r\n        x = w * 2 / 3 - Math.sqrt(r),\r\n        y = h / 3 + Math.sqrt(r),\r\n        l = Math.max(w / 5, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n\r\n    gradient = ctx.createRadialGradient(\r\n        x,\r\n        y,\r\n        0,\r\n        x + r,\r\n        y + r,\r\n        w\r\n    );\r\n\r\n    gradient.addColorStop(0, color.inverted().lighter(50).toString());\r\n    gradient.addColorStop(1, color.inverted().darker(25).toString());\r\n    ctx.fillStyle = gradient;\r\n    ctx.arc(x, y, r, radians(0), radians(360), false);\r\n    ctx.fill();\r\n\r\n    ctx.lineWidth = l / 2;\r\n    ctx.arc(x, y, r, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l / 2, h - l / 2);\r\n    ctx.lineTo(x - Math.sqrt(r + l), y + Math.sqrt(r + l));\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolMagnifierOutline = function (canvas, color) {\r\n    // answer a canvas showing a magnifying glass\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r = w * 0.3,\r\n        x = w * 2 / 3 - Math.sqrt(r),\r\n        y = h / 3 + Math.sqrt(r),\r\n        l = Math.max(w / 5, 0.5);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n\r\n    ctx.lineWidth = l * 0.5;\r\n    ctx.arc(x, y, r, radians(0), radians(360), false);\r\n    ctx.stroke();\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.beginPath();\r\n    ctx.moveTo(l / 2, h - l / 2);\r\n    ctx.lineTo(x - Math.sqrt(r + l), y + Math.sqrt(r + l));\r\n    ctx.closePath();\r\n    ctx.stroke();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolNotes = function (canvas, color) {\r\n    // answer a canvas showing two musical notes\r\n    var ctx = canvas.getContext('2d'),\r\n        size = canvas.width,\r\n        r = size / 6,\r\n        l = Math.max(r / 3, 1);\r\n\r\n    ctx.strokeStyle = color.toString();\r\n    ctx.fillStyle = color.toString();\r\n\r\n    ctx.arc(r, size - r, r, radians(0), radians(360), false);\r\n    ctx.fill();\r\n    ctx.arc(size - r, size - (r * 2), r, radians(0), radians(360), false);\r\n    ctx.fill();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(r * 2 - l, r);\r\n    ctx.lineTo(size, 0);\r\n    ctx.lineTo(size, r);\r\n    ctx.lineTo(r * 2 - l, r * 2);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    ctx.lineWidth = l;\r\n    ctx.beginPath();\r\n    ctx.moveTo(r * 2 - (l / 2), size - r);\r\n    ctx.lineTo(r * 2 - (l / 2), r + l);\r\n    ctx.stroke();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(size - (l / 2), size - (r * 2));\r\n    ctx.lineTo(size - (l / 2), l);\r\n    ctx.stroke();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolCamera = function (canvas, color) {\r\n    // answer a canvas showing a camera\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.width,\r\n        r = w * 0.16,\r\n        l = Math.max(w / 20, 0.5);\r\n\r\n    ctx.lineWidth = l * 2;\r\n\r\n    // camera body\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.moveTo(l, h * 5 / 6);\r\n    ctx.lineTo(w - l, h * 5 / 6);\r\n    ctx.lineTo(w - l, h / 4);\r\n    ctx.lineTo(w * 3 / 4 , h / 4);\r\n    ctx.lineTo(w * 5 / 8 , l);\r\n    ctx.lineTo(w * 3 / 8 , l);\r\n    ctx.lineTo(w / 4 , h / 4);\r\n    ctx.lineTo(l , h / 4);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    // camera lens\r\n    ctx.save();\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.beginPath();\r\n    ctx.arc(w / 2, h / 2, r, radians(0), radians(360), false);\r\n    ctx.fill();\r\n    ctx.restore();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolLocation = function (canvas, color) {\r\n    // answer a canvas showing a map pin\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        r = w / 2;\r\n\r\n    // pin\r\n    ctx.fillStyle = color.toString();\r\n    ctx.beginPath();\r\n    ctx.arc(r, r, r, radians(-210), radians(30), false);\r\n    ctx.lineTo(r, h);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    // hole\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    ctx.beginPath();\r\n    ctx.arc(r, r, r * 0.5, radians(0), radians(360), false);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolFootprints = function (canvas, color) {\r\n    // answer a canvas showing a pair of (shoe) footprints\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        u = w / 10,\r\n        r = u * 1.5;\r\n\r\n    ctx.fillStyle = color.toString();\r\n\r\n    // left shoe\r\n    // tip\r\n    ctx.beginPath();\r\n    ctx.arc(r, r, r, radians(-200), radians(0), false);\r\n    ctx.lineTo(r * 2, u * 5.5);\r\n    ctx.lineTo(u, u * 6);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    // heel\r\n    ctx.beginPath();\r\n    ctx.arc(u * 2.25, u * 6.75, u , radians(-40), radians(-170), false);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n\r\n    // right shoe\r\n    // tip\r\n    ctx.beginPath();\r\n    ctx.arc(w - r, u * 4.5, r, radians(-180), radians(20), false);\r\n    ctx.lineTo(w - u, u * 8.5);\r\n    ctx.lineTo(w - (r * 2), u * 8);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    // heel\r\n    ctx.beginPath();\r\n    ctx.arc(w - (u * 2.25), u * 9, u, radians(0), radians(-150), false);\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    return canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolKeyboard = function (canvas, color) {\r\n    // answer a canvas showing a typing keyboard\r\n    var ctx = canvas.getContext('2d'),\r\n        h = canvas.height,\r\n        u = h / 10,\r\n        k = h / 5,\r\n        row, col;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    for (row = 0; row < 2; row += 1) {\r\n\t\tfor (col = 0; col < 5; col += 1) {\r\n\t\t\tctx.fillRect(\r\n      \t\t\t((u + k) * col) + u,\r\n          \t\t((u + k) * row) + u,\r\n           \t\tk,\r\n           \t\tk\r\n\t\t\t);\r\n   \t\t}\r\n  \t}\r\n\tctx.fillRect(u * 4, u * 7, k * 4, k);\r\n\treturn canvas;\r\n};\r\n\r\nSymbolMorph.prototype.drawSymbolKeyboardFilled = function (canvas, color) {\r\n    // answer a canvas showing a typing keyboard\r\n    var ctx = canvas.getContext('2d'),\r\n        w = canvas.width,\r\n        h = canvas.height,\r\n        u = h / 10,\r\n        k = h / 5,\r\n        row, col;\r\n\r\n    ctx.fillStyle = color.toString();\r\n    ctx.fillRect(0, 0, w, h);\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    for (row = 0; row < 2; row += 1) {\r\n        for (col = 0; col < 5; col += 1) {\r\n            ctx.fillRect(\r\n                  ((u + k) * col) + u,\r\n                  ((u + k) * row) + u,\r\n                   k,\r\n                   k\r\n            );\r\n           }\r\n      }\r\n    ctx.fillRect(u * 4, u * 7, k * 4, k);\r\n    return canvas;\r\n};\r\n//fin de Symbols\r\n/*\r\n\r\n    xml.js\r\n\r\n    a simple XML DOM, encoder and parser for morphic.js\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2015 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js\r\n\r\n\r\n    hierarchy\r\n    ---------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n        Node*\r\n            XML_Element\r\n        ReadStream\r\n\r\n    * defined in morphic.js\r\n\r\n\r\n    toc\r\n    ---\r\n    the following list shows the order in which all constructors are\r\n    defined. Use this list to locate code in this document:\r\n\r\n        ReadStream\r\n        XML_Element\r\n\r\n\r\n    credits\r\n    -------\r\n    Nathan Dinsmore contributed to the design and implemented a first\r\n    working version of a complete XMLSerializer. I have taken much of the\r\n    overall design and many of the functions and methods in this file from\r\n    Nathan's fine original prototype. Recently Nathan has once again\r\n    worked his magic on the parser and optimized it by an order of\r\n    magnitude.\r\n\r\n*/\r\n\r\n/*global modules, detect, Node, isNil*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.xml = '2017-November-15';\r\n\r\n// Declarations\r\n\r\nvar ReadStream;\r\nvar XML_Element;\r\n\r\n// ReadStream ////////////////////////////////////////////////////////////\r\n\r\n// I am a sequential reading interface to an Array or String\r\n\r\n// ReadStream instance creation:\r\n\r\nfunction ReadStream(arrayOrString) {\r\n    this.contents = arrayOrString || '';\r\n    this.index = 0;\r\n}\r\n\r\n// ReadStream constants:\r\n\r\nReadStream.prototype.nonSpace = /\\S|$/g;\r\nReadStream.prototype.nonWord = /[\\s\\>\\/\\=]|$/g;\r\n\r\n// ReadStream accessing:\r\n\r\nReadStream.prototype.next = function (count) {\r\n    var element, start;\r\n    if (count === undefined) {\r\n        element = this.contents[this.index];\r\n        this.index += 1;\r\n        return element;\r\n    }\r\n    start = this.index;\r\n    this.index += count;\r\n    return this.contents.slice(start, this.index);\r\n};\r\n\r\nReadStream.prototype.peek = function () {\r\n    return this.contents[this.index];\r\n};\r\n\r\nReadStream.prototype.skip = function (count) {\r\n    this.index += count || 1;\r\n};\r\n\r\nReadStream.prototype.atEnd = function () {\r\n    return this.index > (this.contents.length - 1);\r\n};\r\n\r\n// ReadStream accessing String contents:\r\n\r\nReadStream.prototype.upTo = function (str) {\r\n    var i = this.contents.indexOf(str, this.index);\r\n    return i === -1 ? '' : this.contents.slice(this.index, this.index = i);\r\n};\r\n\r\nReadStream.prototype.peekUpTo = function (str) {\r\n    var i = this.contents.indexOf(str, this.index);\r\n    return i === -1 ? '' : this.contents.slice(this.index, i);\r\n};\r\n\r\nReadStream.prototype.skipSpace = function () {\r\n    this.nonSpace.lastIndex = this.index;\r\n    var result = this.nonSpace.exec(this.contents);\r\n    if (result) this.index = result.index;\r\n};\r\n\r\nReadStream.prototype.word = function () {\r\n    this.nonWord.lastIndex = this.index;\r\n    var result = this.nonWord.exec(this.contents);\r\n    return result ? this.contents.slice(this.index, this.index = result.index) : '';\r\n};\r\n\r\n// XML_Element ///////////////////////////////////////////////////////////\r\n/*\r\n    I am a DOM-Node which can encode itself to as well as parse itself\r\n    from a well-formed XML string. Note that there is no separate parser\r\n    object, all the parsing can be done in a single object.\r\n*/\r\n\r\n// XML_Element inherits from Node:\r\n\r\nXML_Element.prototype = Object.create(Node.prototype);\r\nXML_Element.prototype.constructor = XML_Element;\r\nXML_Element.uber = Node.prototype;\r\n\r\n// XML_Element preferences settings:\r\n\r\nXML_Element.prototype.indentation = '  ';\r\n\r\n// XML_Element instance creation:\r\n\r\nfunction XML_Element(tag, contents, parent) {\r\n    this.init(tag, contents, parent);\r\n}\r\n\r\nXML_Element.prototype.init = function (tag, contents, parent) {\r\n    // additional properties:\r\n    this.tag = tag || 'unnamed';\r\n    this.attributes = {};\r\n    this.contents = contents || '';\r\n\r\n    // initialize inherited properties:\r\n    XML_Element.uber.init.call(this);\r\n\r\n    // override inherited properties\r\n    if (parent) parent.addChild(this);\r\n};\r\n\r\n// XML_Element DOM navigation: (aside from what's inherited from Node)\r\n\r\nXML_Element.prototype.require = function (tagName) {\r\n    // answer the first direct child with the specified tagName, or throw\r\n    // an error if it doesn't exist\r\n    var child = this.childNamed(tagName);\r\n    if (!child) {\r\n        throw new Error('Missing required element <' + tagName + '>!');\r\n    }\r\n    return child;\r\n};\r\n\r\nXML_Element.prototype.childNamed = function (tagName) {\r\n    // answer the first direct child with the specified tagName, or null\r\n    return detect(\r\n        this.children,\r\n        function (child) {return child.tag === tagName; }\r\n    );\r\n};\r\n\r\nXML_Element.prototype.childrenNamed = function (tagName) {\r\n    // answer all direct children with the specified tagName\r\n    return this.children.filter(\r\n        function (child) {return child.tag === tagName; }\r\n    );\r\n};\r\n\r\nXML_Element.prototype.parentNamed = function (tagName) {\r\n    // including myself\r\n    if (this.tag === tagName) {\r\n        return this;\r\n    }\r\n    if (!this.parent) {\r\n        return null;\r\n    }\r\n    return this.parent.parentNamed(tagName);\r\n};\r\n\r\n// XML_Element output:\r\n\r\nXML_Element.prototype.toString = function (isFormatted, indentationLevel) {\r\n    var result = '',\r\n        indent = '',\r\n        level = indentationLevel || 0,\r\n        key,\r\n        i;\r\n\r\n    // spaces for indentation, if any\r\n    if (isFormatted) {\r\n        for (i = 0; i < level; i += 1) {\r\n            indent += this.indentation;\r\n        }\r\n        result += indent;\r\n    }\r\n\r\n    // opening tag\r\n    result += ('<' + this.tag);\r\n\r\n    // attributes, if any\r\n    for (key in this.attributes) {\r\n        if (Object.prototype.hasOwnProperty.call(this.attributes, key)\r\n                && this.attributes[key]) {\r\n            result += ' ' + key + '=\"' + this.escape(this.attributes[key]) + '\"';\r\n        }\r\n    }\r\n\r\n    // contents, subnodes, and closing tag\r\n    if (!this.contents.length && !this.children.length) {\r\n        result += '/>';\r\n    } else {\r\n        result += '>';\r\n        result += this.escape(this.contents);\r\n        this.children.forEach(function (element) {\r\n            if (isFormatted) {\r\n                result += '\\n';\r\n            }\r\n            result += element.toString(isFormatted, level + 1);\r\n        });\r\n        if (isFormatted && this.children.length) {\r\n            result += ('\\n' + indent);\r\n        }\r\n        result += '</' + this.tag + '>';\r\n    }\r\n    return result;\r\n};\r\n\r\nXML_Element.prototype.escape = function (string, ignoreQuotes) {\r\n    var src = isNil(string) ? '' : string.toString(),\r\n        result = '',\r\n        i,\r\n        ch;\r\n    for (i = 0; i < src.length; i += 1) {\r\n        ch = src[i];\r\n        switch (ch) {\r\n        case '\\'':\r\n            result += '&apos;';\r\n            break;\r\n        case '\\\"':\r\n            result += ignoreQuotes ? ch : '&quot;';\r\n            break;\r\n        case '<':\r\n            result += '&lt;';\r\n            break;\r\n        case '>':\r\n            result += '&gt;';\r\n            break;\r\n        case '&':\r\n            result += '&amp;';\r\n            break;\r\n        case '\\n': // escape CR b/c of export to URL feature\r\n            result += '&#xD;';\r\n            break;\r\n        case '~': // escape tilde b/c it's overloaded in serializer.store()\r\n            result += '&#126;';\r\n            break;\r\n        default:\r\n            result += ch;\r\n        }\r\n    }\r\n    return result;\r\n};\r\n\r\nXML_Element.prototype.unescape = function (string) {\r\n    return string.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g, function(_, name) {\r\n        switch (name) {\r\n            case 'amp': return '&';\r\n            case 'apos': return '\\'';\r\n            case 'quot': return '\"';\r\n            case 'lt': return '<';\r\n            case 'gt': return '>';\r\n            case '#xD': return '\\n';\r\n            case '#126': return '~';\r\n            default: console.warn('unreachable');\r\n        }\r\n    });\r\n};\r\n\r\n// XML_Element parsing:\r\n\r\nXML_Element.prototype.parseString = function (string) {\r\n    var stream = new ReadStream(string);\r\n    stream.upTo('<');\r\n    stream.skip();\r\n    this.parseStream(stream);\r\n};\r\n\r\nXML_Element.prototype.parseStream = function (stream) {\r\n    var key, value, ch, child;\r\n\r\n    // tag:\r\n    this.tag = stream.word();\r\n    stream.skipSpace();\r\n\r\n    // attributes:\r\n    ch = stream.peek();\r\n    while (ch !== '>' && ch !== '/') {\r\n        key = stream.word();\r\n        stream.skipSpace();\r\n        if (stream.next() !== '=') {\r\n            throw new Error('Expected \"=\" after attribute name');\r\n        }\r\n        stream.skipSpace();\r\n        ch = stream.next();\r\n        if (ch !== '\"' && ch !== \"'\") {\r\n            throw new Error('Expected single- or double-quoted attribute value');\r\n        }\r\n        value = stream.upTo(ch);\r\n        stream.skip(1);\r\n        stream.skipSpace();\r\n        this.attributes[key] = this.unescape(value);\r\n        ch = stream.peek();\r\n    }\r\n\r\n    // empty tag:\r\n    if (ch === '/') {\r\n        stream.skip();\r\n        if (stream.next() !== '>') {\r\n            throw new Error('Expected \">\" after \"/\" in empty tag');\r\n        }\r\n        return;\r\n    }\r\n    if (stream.next() !== '>') {\r\n        throw new Error('Expected \">\" after tag name and attributes');\r\n    }\r\n\r\n    // contents and children\r\n    while (!stream.atEnd()) {\r\n        ch = stream.next();\r\n        if (ch === '<') {\r\n            if (stream.peek() === '/') { // closing tag\r\n                stream.skip();\r\n                if (stream.word() !== this.tag) {\r\n                    throw new Error('Expected to close ' + this.tag);\r\n                }\r\n                stream.upTo('>');\r\n                stream.skip();\r\n                this.contents = this.unescape(this.contents);\r\n                return;\r\n            }\r\n            child = new XML_Element(null, null, this);\r\n            child.parseStream(stream);\r\n        } else {\r\n            this.contents += ch;\r\n        }\r\n    }\r\n};\r\n//fin de xml\r\n/*\r\n\r\n    store.js\r\n\r\n    saving and loading Snap! projects\r\n\r\n    written by Jens Mnig\r\n    jens@moenig.org\r\n\r\n    Copyright (C) 2017 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n    prerequisites:\r\n    --------------\r\n    needs morphic.js, xml.js, and most of Snap!'s other modules\r\n\r\n\r\n    hierarchy\r\n    ---------\r\n    the following tree lists all constructors hierarchically,\r\n    indentation indicating inheritance. Refer to this list to get a\r\n    contextual overview:\r\n\r\n        XML_Serializer\r\n            SnapSerializer\r\n\r\n\r\n    credits\r\n    -------\r\n    Nathan Dinsmore contributed to the design and implemented a first\r\n    working version of a complete XMLSerializer. I have taken much of the\r\n    overall design and many of the functions and methods in this file from\r\n    Nathan's fine original prototype.\r\n\r\n*/\r\n\r\n/*global modules, XML_Element, VariableFrame, StageMorph, SpriteMorph,\r\nWatcherMorph, Point, CustomBlockDefinition, Context, ReporterBlockMorph,\r\nCommandBlockMorph, detect, CustomCommandBlockMorph, CustomReporterBlockMorph,\r\nColor, List, newCanvas, Costume, Sound, Audio, IDE_Morph, ScriptsMorph,\r\nBlockMorph, ArgMorph, InputSlotMorph, TemplateSlotMorph, CommandSlotMorph,\r\nFunctionSlotMorph, MultiArgMorph, ColorSlotMorph, nop, CommentMorph, isNil,\r\nlocalize, sizeOf, ArgLabelMorph, SVG_Costume, MorphicPreferences,\r\nSyntaxElementMorph, Variable, isSnapObject, console, BooleanSlotMorph,\r\nnormalizeCanvas, contains*/\r\n\r\n// Global stuff ////////////////////////////////////////////////////////\r\n\r\nmodules.store = '2017-December-01';\r\n\r\n\r\n// XML_Serializer ///////////////////////////////////////////////////////\r\n/*\r\n    I am an abstract protype for my heirs.\r\n\r\n    I manage object identities and keep track of circular data structures.\r\n    Objects are \"touched\" and a property named \"serializationID\" is added\r\n    to each, representing an index integer in the list, starting with 1.\r\n*/\r\n\r\n// XML_Serializer instance creation:\r\n\r\nfunction XML_Serializer() {\r\n    this.contents = [];\r\n    this.media = [];\r\n    this.isCollectingMedia = false;\r\n    this.isExportingBlocksLibrary = false;\r\n}\r\n\r\n// XML_Serializer preferences settings:\r\n\r\nXML_Serializer.prototype.idProperty = 'serializationID';\r\nXML_Serializer.prototype.mediaIdProperty = 'serializationMediaID';\r\nXML_Serializer.prototype.mediaDetectionProperty = 'isMedia';\r\nXML_Serializer.prototype.version = 1; // increment on structural change\r\n\r\n// XML_Serializer accessing:\r\n\r\nXML_Serializer.prototype.serialize = function (object, forBlocksLibrary) {\r\n    // public: answer an XML string representing the given object\r\n    var xml;\r\n    this.flush(); // in case an error occurred in an earlier attempt\r\n    this.flushMedia();\r\n    this.isExportingBlocksLibrary = forBlocksLibrary;\r\n    xml = this.store(object);\r\n    this.flush();\r\n    return xml;\r\n};\r\n\r\nXML_Serializer.prototype.store = function (object, mediaID) {\r\n    // private - mediaID is optional\r\n    if (isNil(object) || !object.toXML) {\r\n        // unsupported type, to be checked before calling store()\r\n        // when debugging, be sure to throw an error at this point\r\n        return '';\r\n    }\r\n    if (this.isCollectingMedia && object[this.mediaDetectionProperty]) {\r\n        this.addMedia(object, mediaID);\r\n        return this.format(\r\n            '<ref mediaID=\"@\"></ref>',\r\n            object[this.mediaIdProperty]\r\n        );\r\n    }\r\n    if (object[this.idProperty]) {\r\n        return this.format('<ref id=\"@\"></ref>', object[this.idProperty]);\r\n    }\r\n    this.add(object);\r\n    return object.toXML(this, mediaID).replace(\r\n        '~',\r\n        this.format('id=\"@\"', object[this.idProperty])\r\n    );\r\n};\r\n\r\nXML_Serializer.prototype.mediaXML = function () {\r\n    // answer a project's collected media module as XML\r\n    var xml = '<media>',\r\n        myself = this;\r\n    this.media.forEach(function (object) {\r\n        var str = object.toXML(myself).replace(\r\n            '~',\r\n            myself.format('mediaID=\"@\"', object[myself.mediaIdProperty])\r\n        );\r\n        xml = xml + str;\r\n    });\r\n    return xml + '</media>';\r\n};\r\n\r\nXML_Serializer.prototype.add = function (object) {\r\n    // private - mark the object with a serializationID property and add it\r\n    if (object[this.idProperty]) { // already present\r\n        return -1;\r\n    }\r\n    this.contents.push(object);\r\n    object[this.idProperty] = this.contents.length;\r\n    return this.contents.length;\r\n};\r\n\r\nXML_Serializer.prototype.addMedia = function (object, mediaID) {\r\n    // private - mark the object with a serializationMediaID property\r\n    // and add it to media\r\n    // if a mediaID is given, take it, otherwise generate one\r\n    if (object[this.mediaIdProperty]) { // already present\r\n        return -1;\r\n    }\r\n    this.media.push(object);\r\n    if (mediaID) {\r\n        object[this.mediaIdProperty] = mediaID + '_' + object.name;\r\n    } else {\r\n        object[this.mediaIdProperty] = this.media.length;\r\n    }\r\n    return this.media.length;\r\n};\r\n\r\nXML_Serializer.prototype.at = function (integer) {\r\n    // private\r\n    return this.contents[integer - 1];\r\n};\r\n\r\nXML_Serializer.prototype.flush = function () {\r\n    // private - free all objects and empty my contents\r\n    var myself = this;\r\n    this.contents.forEach(function (obj) {\r\n        delete obj[myself.idProperty];\r\n    });\r\n    this.contents = [];\r\n};\r\n\r\nXML_Serializer.prototype.flushMedia = function () {\r\n    // private - free all media objects and empty my media\r\n    var myself = this;\r\n    if (this.media instanceof Array) {\r\n        this.media.forEach(function (obj) {\r\n            delete obj[myself.mediaIdProperty];\r\n        });\r\n    }\r\n    this.media = [];\r\n    this.isExportingBlocksLibrary = false;\r\n};\r\n\r\n// XML_Serializer formatting:\r\n\r\nXML_Serializer.prototype.escape = XML_Element.prototype.escape;\r\nXML_Serializer.prototype.unescape = XML_Element.prototype.unescape;\r\n\r\n\r\nXML_Serializer.prototype.format = function (string) {\r\n    // private\r\n    var myself = this,\r\n        i = -1,\r\n        values = arguments,\r\n        value;\r\n\r\n    return string.replace(/[@$%]([\\d]+)?/g, function (spec, index) {\r\n        index = parseInt(index, 10);\r\n\r\n        if (isNaN(index)) {\r\n            i += 1;\r\n            value = values[i + 1];\r\n        } else {\r\n            value = values[index + 1];\r\n        }\r\n        // original line of code - now frowned upon by JSLint:\r\n        // value = values[(isNaN(index) ? (i += 1) : index) + 1];\r\n\r\n        return spec === '@' ?\r\n                myself.escape(value)\r\n                    : spec === '$' ?\r\n                        myself.escape(value, true)\r\n                            : value;\r\n    });\r\n};\r\n\r\n// XML_Serializer loading:\r\n\r\nXML_Serializer.prototype.load = function (xmlString) {\r\n    // public - answer a new object which is represented by the given\r\n    // XML string.\r\n    nop(xmlString);\r\n    throw new Error(\r\n        'loading should be implemented in heir of XML_Serializer'\r\n    );\r\n};\r\n\r\nXML_Serializer.prototype.parse = function (xmlString) {\r\n    // private - answer an XML_Element representing the given XML String\r\n    var element = new XML_Element();\r\n    element.parseString(xmlString);\r\n    return element;\r\n};\r\n\r\n// SnapSerializer ////////////////////////////////////////////////////////////\r\n\r\nvar SnapSerializer;\r\n\r\n// SnapSerializer inherits from XML_Serializer:\r\n\r\nSnapSerializer.prototype = new XML_Serializer();\r\nSnapSerializer.prototype.constructor = SnapSerializer;\r\nSnapSerializer.uber = XML_Serializer.prototype;\r\n\r\n// SnapSerializer constants:\r\n\r\nSnapSerializer.prototype.app = 'Snap! 4.1, http://snap.berkeley.edu';\r\n\r\nSnapSerializer.prototype.thumbnailSize = new Point(160, 120);\r\n\r\nSnapSerializer.prototype.watcherLabels = {\r\n    xPosition: 'x position',\r\n    yPosition: 'y position',\r\n    direction: 'direction',\r\n    getScale: 'size',\r\n    getTempo: 'tempo',\r\n    getLastAnswer: 'answer',\r\n    getLastMessage: 'message',\r\n    getTimer: 'timer',\r\n    getCostumeIdx: 'costume #',\r\n    reportMouseX: 'mouse x',\r\n    reportMouseY: 'mouse y',\r\n    reportThreadCount: 'processes'\r\n};\r\n\r\n// SnapSerializer instance creation:\r\n\r\nfunction SnapSerializer() {\r\n    this.init();\r\n}\r\n\r\n// SnapSerializer initialization:\r\n\r\nSnapSerializer.prototype.init = function () {\r\n    this.project = {};\r\n    this.objects = {};\r\n    this.mediaDict = {};\r\n};\r\n\r\n// SnapSerializer saving:\r\n\r\nXML_Serializer.prototype.mediaXML = function (name) {\r\n    // under construction....\r\n    var xml = '<media name=\"' +\r\n            (name || 'untitled') +\r\n            '\" app=\"' + this.app +\r\n            '\" version=\"' +\r\n            this.version +\r\n            '\">',\r\n        myself = this;\r\n    this.media.forEach(function (object) {\r\n        var str = object.toXML(myself).replace(\r\n            '~',\r\n            myself.format('mediaID=\"@\"', object[myself.mediaIdProperty])\r\n        );\r\n        xml = xml + str;\r\n    });\r\n    return xml + '</media>';\r\n};\r\n\r\n// SnapSerializer loading:\r\n\r\nSnapSerializer.prototype.load = function (xmlString, ide) {\r\n    // public - answer a new Project represented by the given XML String\r\n    return this.loadProjectModel(this.parse(xmlString), ide);\r\n};\r\n\r\nSnapSerializer.prototype.loadProjectModel = function (xmlNode, ide) {\r\n    // public - answer a new Project represented by the given XML top node\r\n    // show a warning if the origin apps differ\r\n\r\n    var appInfo = xmlNode.attributes.app,\r\n        app = appInfo ? appInfo.split(' ')[0] : null;\r\n\r\n    if (ide && app && app !== this.app.split(' ')[0]) {\r\n        ide.inform(\r\n            app + ' Project',\r\n            'This project has been created by a different app:\\n\\n' +\r\n                app +\r\n                '\\n\\nand may be incompatible or fail to load here.'\r\n        );\r\n    }\r\n    return this.rawLoadProjectModel(xmlNode);\r\n};\r\n\r\nSnapSerializer.prototype.rawLoadProjectModel = function (xmlNode) {\r\n    // private\r\n    var myself = this,\r\n        project = {sprites: {}},\r\n        model,\r\n        nameID;\r\n\r\n    this.project = project;\r\n\r\n    model = {project: xmlNode };\r\n    if (+xmlNode.attributes.version > this.version) {\r\n        throw 'Project uses newer version of Serializer';\r\n    }\r\n\r\n    /* Project Info */\r\n\r\n    this.objects = {};\r\n    project.name = model.project.attributes.name;\r\n    if (!project.name) {\r\n        nameID = 1;\r\n        while (\r\n            Object.prototype.hasOwnProperty.call(\r\n                localStorage,\r\n                '-snap-project-Untitled ' + nameID\r\n            )\r\n        ) {\r\n            nameID += 1;\r\n        }\r\n        project.name = 'Untitled ' + nameID;\r\n    }\r\n    model.notes = model.project.childNamed('notes');\r\n    if (model.notes) {\r\n        project.notes = model.notes.contents;\r\n    }\r\n    model.globalVariables = model.project.childNamed('variables');\r\n    project.globalVariables = new VariableFrame();\r\n\r\n    /* Stage */\r\n\r\n    model.stage = model.project.require('stage');\r\n    StageMorph.prototype.frameRate = 0;\r\n    project.stage = new StageMorph(project.globalVariables);\r\n    if (Object.prototype.hasOwnProperty.call(\r\n            model.stage.attributes,\r\n            'id'\r\n        )) {\r\n        this.objects[model.stage.attributes.id] = project.stage;\r\n    }\r\n    if (model.stage.attributes.name) {\r\n        project.stage.name = model.stage.attributes.name;\r\n    }\r\n    if (model.stage.attributes.scheduled === 'true') {\r\n        project.stage.fps = 30;\r\n        StageMorph.prototype.frameRate = 30;\r\n    }\r\n    model.pentrails = model.stage.childNamed('pentrails');\r\n    if (model.pentrails) {\r\n        project.pentrails = new Image();\r\n        project.pentrails.onload = function () {\r\n            if (project.stage.trailsCanvas) { // work-around a bug in FF\r\n                normalizeCanvas(project.stage.trailsCanvas);\r\n                var context = project.stage.trailsCanvas.getContext('2d');\r\n                context.drawImage(project.pentrails, 0, 0);\r\n                project.stage.changed();\r\n            }\r\n        };\r\n        project.pentrails.src = model.pentrails.contents;\r\n    }\r\n    project.stage.setTempo(model.stage.attributes.tempo);\r\n    StageMorph.prototype.dimensions = new Point(480, 360);\r\n    if (model.stage.attributes.width) {\r\n        StageMorph.prototype.dimensions.x =\r\n            Math.max(+model.stage.attributes.width, 240);\r\n    }\r\n    if (model.stage.attributes.height) {\r\n        StageMorph.prototype.dimensions.y =\r\n            Math.max(+model.stage.attributes.height, 180);\r\n    }\r\n    project.stage.setExtent(StageMorph.prototype.dimensions);\r\n    SpriteMorph.prototype.useFlatLineEnds =\r\n        model.stage.attributes.lines === 'flat';\r\n    BooleanSlotMorph.prototype.isTernary =\r\n        model.stage.attributes.ternary !== 'false';\r\n    project.stage.isThreadSafe =\r\n        model.stage.attributes.threadsafe === 'true';\r\n    StageMorph.prototype.enableCodeMapping =\r\n        model.stage.attributes.codify === 'true';\r\n    StageMorph.prototype.enableInheritance =\r\n        model.stage.attributes.inheritance !== 'false';\r\n    StageMorph.prototype.enableSublistIDs =\r\n        model.stage.attributes.sublistIDs === 'true';\r\n\r\n    model.hiddenPrimitives = model.project.childNamed('hidden');\r\n    if (model.hiddenPrimitives) {\r\n        model.hiddenPrimitives.contents.split(' ').forEach(\r\n            function (sel) {\r\n                if (sel) {\r\n                    StageMorph.prototype.hiddenPrimitives[sel] = true;\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    model.codeHeaders = model.project.childNamed('headers');\r\n    if (model.codeHeaders) {\r\n        model.codeHeaders.children.forEach(function (xml) {\r\n            StageMorph.prototype.codeHeaders[xml.tag] = xml.contents;\r\n        });\r\n    }\r\n\r\n    model.codeMappings = model.project.childNamed('code');\r\n    if (model.codeMappings) {\r\n        model.codeMappings.children.forEach(function (xml) {\r\n            StageMorph.prototype.codeMappings[xml.tag] = xml.contents;\r\n        });\r\n    }\r\n\r\n    model.globalBlocks = model.project.childNamed('blocks');\r\n    if (model.globalBlocks) {\r\n        this.loadCustomBlocks(project.stage, model.globalBlocks, true);\r\n        this.populateCustomBlocks(\r\n            project.stage,\r\n            model.globalBlocks,\r\n            true\r\n        );\r\n    }\r\n    this.loadObject(project.stage, model.stage);\r\n\r\n    /* Sprites */\r\n\r\n    model.sprites = model.stage.require('sprites');\r\n    project.sprites[project.stage.name] = project.stage;\r\n\r\n    model.sprites.childrenNamed('sprite').forEach(function (model) {\r\n        myself.loadValue(model);\r\n    });\r\n\r\n    // restore inheritance and nesting associations\r\n    myself.project.stage.children.forEach(function (sprite) {\r\n        var exemplar, anchor;\r\n        if (sprite.inheritanceInfo) { // only sprites can inherit\r\n            exemplar = myself.project.sprites[\r\n                sprite.inheritanceInfo.exemplar\r\n            ];\r\n            if (exemplar) {\r\n                sprite.setExemplar(exemplar);\r\n            }\r\n            sprite.inheritedAttributes = sprite.inheritanceInfo.delegated || [];\r\n        }\r\n        if (sprite.nestingInfo) { // only sprites may have nesting info\r\n            anchor = myself.project.sprites[sprite.nestingInfo.anchor];\r\n            if (anchor) {\r\n                anchor.attachPart(sprite);\r\n            }\r\n            sprite.rotatesWithAnchor = (sprite.nestingInfo.synch === 'true');\r\n        }\r\n    });\r\n    myself.project.stage.children.forEach(function (sprite) {\r\n        var costume;\r\n        if (sprite.nestingInfo) { // only sprites may have nesting info\r\n            sprite.nestingScale = +(sprite.nestingInfo.scale || sprite.scale);\r\n            delete sprite.nestingInfo;\r\n        }\r\n        ['scripts', 'costumes', 'sounds'].forEach(function (att) {\r\n            if (sprite.inheritsAttribute(att)) {\r\n                sprite.refreshInheritedAttribute(att);\r\n            }\r\n        });\r\n        if (sprite.inheritsAttribute('costumes')) {\r\n            costume = sprite.costumes.asArray()[\r\n                sprite.inheritanceInfo.costumeNumber - 1\r\n            ];\r\n            if (costume) {\r\n                if (costume.loaded) {\r\n                    sprite.wearCostume(costume, true);\r\n                } else {\r\n                    costume.loaded = function () {\r\n                        sprite.wearCostume(costume, true);\r\n                        this.loaded = true;\r\n                    };\r\n                }\r\n            }\r\n        }\r\n        delete sprite.inheritanceInfo;\r\n    });\r\n\r\n    /* Global Variables */\r\n\r\n    if (model.globalVariables) {\r\n        this.loadVariables(\r\n            project.globalVariables,\r\n            model.globalVariables\r\n        );\r\n    }\r\n\r\n    this.objects = {};\r\n\r\n    /* Watchers */\r\n\r\n    model.sprites.childrenNamed('watcher').forEach(function (model) {\r\n        var watcher, color, target, hidden, extX, extY;\r\n\r\n        color = myself.loadColor(model.attributes.color);\r\n        target = Object.prototype.hasOwnProperty.call(\r\n            model.attributes,\r\n            'scope'\r\n        ) ? project.sprites[model.attributes.scope] : null;\r\n\r\n        // determine whether the watcher is hidden, slightly\r\n        // complicated to retain backward compatibility\r\n        // with former tag format: hidden=\"hidden\"\r\n        // now it's: hidden=\"true\"\r\n        hidden = Object.prototype.hasOwnProperty.call(\r\n            model.attributes,\r\n            'hidden'\r\n        ) && (model.attributes.hidden !== 'false');\r\n\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'var'\r\n            )) {\r\n            watcher = new WatcherMorph(\r\n                model.attributes['var'],\r\n                color,\r\n                isNil(target) ? project.globalVariables\r\n                    : target.variables,\r\n                model.attributes['var'],\r\n                hidden\r\n            );\r\n        } else {\r\n            watcher = new WatcherMorph(\r\n                localize(myself.watcherLabels[model.attributes.s]),\r\n                color,\r\n                target,\r\n                model.attributes.s,\r\n                hidden\r\n            );\r\n        }\r\n        watcher.setStyle(model.attributes.style || 'normal');\r\n        if (watcher.style === 'slider') {\r\n            watcher.setSliderMin(model.attributes.min || '1', true);\r\n            watcher.setSliderMax(model.attributes.max || '100', true);\r\n        }\r\n        watcher.setPosition(\r\n            project.stage.topLeft().add(new Point(\r\n                +model.attributes.x || 0,\r\n                +model.attributes.y || 0\r\n            ))\r\n        );\r\n        project.stage.add(watcher);\r\n        watcher.onNextStep = function () {this.currentValue = null; };\r\n\r\n        // set watcher's contentsMorph's extent if it is showing a list and\r\n        // its monitor dimensions are given\r\n        if (watcher.currentValue instanceof List) {\r\n            extX = model.attributes.extX;\r\n            if (extX) {\r\n                watcher.cellMorph.contentsMorph.setWidth(+extX);\r\n            }\r\n            extY = model.attributes.extY;\r\n            if (extY) {\r\n                watcher.cellMorph.contentsMorph.setHeight(+extY);\r\n            }\r\n            // adjust my contentsMorph's handle position\r\n            watcher.cellMorph.contentsMorph.handle.drawNew();\r\n        }\r\n    });\r\n\r\n    // clear sprites' inherited methods caches, if any\r\n    myself.project.stage.children.forEach(function (sprite) {\r\n        sprite.inheritedMethodsCache = [];\r\n    });\r\n\r\n    this.objects = {};\r\n    return project;\r\n};\r\n\r\nSnapSerializer.prototype.loadBlocks = function (xmlString, targetStage) {\r\n    // public - answer a new Array of custom block definitions\r\n    // represented by the given XML String\r\n    var stage = new StageMorph(),\r\n        model;\r\n\r\n    this.project = {\r\n        stage: stage,\r\n        sprites: {},\r\n        targetStage: targetStage // for secondary custom block def look-up\r\n    };\r\n    model = this.parse(xmlString);\r\n    if (+model.attributes.version > this.version) {\r\n        throw 'Module uses newer version of Serializer';\r\n    }\r\n    this.loadCustomBlocks(stage, model, true);\r\n    this.populateCustomBlocks(\r\n        stage,\r\n        model,\r\n        true\r\n    );\r\n    this.objects = {};\r\n    stage.globalBlocks.forEach(function (def) {\r\n        def.receiver = null;\r\n    });\r\n    this.objects = {};\r\n    this.project = {};\r\n    this.mediaDict = {};\r\n    return stage.globalBlocks;\r\n};\r\n\r\nSnapSerializer.prototype.loadSprites = function (xmlString, ide) {\r\n    // public - import a set of sprites represented by xmlString\r\n    // into the current project of the ide\r\n    var model, project, myself = this;\r\n\r\n    project = this.project = {\r\n        globalVariables: ide.globalVariables,\r\n        stage: ide.stage,\r\n        sprites: {}\r\n    };\r\n    project.sprites[project.stage.name] = project.stage;\r\n\r\n    model = this.parse(xmlString);\r\n    if (+model.attributes.version > this.version) {\r\n        throw 'Module uses newer version of Serializer';\r\n    }\r\n    model.childrenNamed('sprite').forEach(function (model) {\r\n        var sprite  = new SpriteMorph(project.globalVariables);\r\n\r\n        if (model.attributes.id) {\r\n            myself.objects[model.attributes.id] = sprite;\r\n        }\r\n        if (model.attributes.name) {\r\n            sprite.name = ide.newSpriteName(model.attributes.name);\r\n            project.sprites[sprite.name] = sprite;\r\n        }\r\n        if (model.attributes.color) {\r\n            sprite.color = myself.loadColor(model.attributes.color);\r\n        }\r\n        if (model.attributes.pen) {\r\n            sprite.penPoint = model.attributes.pen;\r\n        }\r\n        project.stage.add(sprite);\r\n        ide.sprites.add(sprite);\r\n        sprite.scale = parseFloat(model.attributes.scale || '1');\r\n        sprite.rotationStyle = parseFloat(\r\n            model.attributes.rotation || '1'\r\n        );\r\n        sprite.isDraggable = model.attributes.draggable !== 'false';\r\n        sprite.isVisible = model.attributes.hidden !== 'true';\r\n        sprite.heading = parseFloat(model.attributes.heading) || 0;\r\n        sprite.drawNew();\r\n        sprite.gotoXY(+model.attributes.x || 0, +model.attributes.y || 0);\r\n        myself.loadObject(sprite, model);\r\n    });\r\n\r\n    // restore inheritance and nesting associations\r\n    project.stage.children.forEach(function (sprite) {\r\n        var exemplar, anchor;\r\n        if (sprite.inheritanceInfo) { // only sprites can inherit\r\n            exemplar = project.sprites[\r\n                sprite.inheritanceInfo.exemplar\r\n            ];\r\n            if (exemplar) {\r\n                sprite.setExemplar(exemplar);\r\n            }\r\n        }\r\n        if (sprite.nestingInfo) { // only sprites may have nesting info\r\n            anchor = project.sprites[sprite.nestingInfo.anchor];\r\n            if (anchor) {\r\n                anchor.attachPart(sprite);\r\n            }\r\n            sprite.rotatesWithAnchor = (sprite.nestingInfo.synch === 'true');\r\n        }\r\n    });\r\n    project.stage.children.forEach(function (sprite) {\r\n        delete sprite.inheritanceInfo;\r\n        if (sprite.nestingInfo) { // only sprites may have nesting info\r\n            sprite.nestingScale = +(sprite.nestingInfo.scale || sprite.scale);\r\n            delete sprite.nestingInfo;\r\n        }\r\n    });\r\n\r\n    this.objects = {};\r\n    this.project = {};\r\n    this.mediaDict = {};\r\n\r\n//    ide.stage.drawNew();\r\n    ide.createCorral();\r\n    ide.fixLayout();\r\n};\r\n\r\nSnapSerializer.prototype.loadMedia = function (xmlString) {\r\n    // public - load the media represented by xmlString into memory\r\n    // to be referenced by a media-less project later\r\n    return this.loadMediaModel(this.parse(xmlString));\r\n};\r\n\r\nSnapSerializer.prototype.loadMediaModel = function (xmlNode) {\r\n    // public - load the media represented by xmlNode into memory\r\n    // to be referenced by a media-less project later\r\n    var myself = this,\r\n        model = xmlNode;\r\n    this.mediaDict = {};\r\n    if (+model.attributes.version > this.version) {\r\n        throw 'Module uses newer version of Serializer';\r\n    }\r\n    model.children.forEach(function (model) {\r\n        myself.loadValue(model);\r\n    });\r\n    return this.mediaDict;\r\n};\r\n\r\nSnapSerializer.prototype.loadObject = function (object, model) {\r\n    // private\r\n    var blocks = model.require('blocks'),\r\n        dispatches = model.childNamed('dispatches');\r\n\r\n    // load the instrument\r\n    if (model.attributes.instrument) {\r\n        object.instrument = +model.attributes.instrument;\r\n    }\r\n\r\n    this.loadInheritanceInfo(object, model);\r\n    this.loadNestingInfo(object, model);\r\n\r\n    // load costumes unless they're inherited\r\n    if (!(object.inheritanceInfo &&\r\n            (object.inheritanceInfo.delegated instanceof Array) &&\r\n            contains(object.inheritanceInfo.delegated, 'costumes'))) {\r\n        this.loadCostumes(object, model);\r\n    }\r\n\r\n    // load sounds unless they're inherited\r\n    if (!(object.inheritanceInfo &&\r\n            (object.inheritanceInfo.delegated instanceof Array) &&\r\n            contains(object.inheritanceInfo.delegated, 'sounds'))) {\r\n        this.loadSounds(object, model);\r\n    }\r\n\r\n    this.loadCustomBlocks(object, blocks);\r\n    if (dispatches) {\r\n        this.loadCustomBlocks(object, dispatches, false, true);\r\n    }\r\n    this.populateCustomBlocks(object, blocks);\r\n    this.loadVariables(object.variables, model.require('variables'), object);\r\n\r\n    // load scripts unless they're inherited\r\n    if (!(object.inheritanceInfo &&\r\n            (object.inheritanceInfo.delegated instanceof Array) &&\r\n            contains(object.inheritanceInfo.delegated, 'scripts'))) {\r\n        this.loadScripts(object, object.scripts, model.require('scripts'));\r\n    }\r\n\r\n    // note: the dispatches cache isn't cleared until after\r\n    // *all* objects are loaded\r\n};\r\n\r\nSnapSerializer.prototype.loadInheritanceInfo = function (object, model) {\r\n    // private\r\n    var info = model.childNamed('inherit'),\r\n        delegated;\r\n    if (info) {\r\n        object.inheritanceInfo = info.attributes;\r\n        delegated = info.childNamed('list');\r\n        if (delegated) {\r\n            object.inheritanceInfo.delegated =\r\n                this.loadValue(delegated).asArray();\r\n        }\r\n        object.inheritanceInfo.costumeNumber = model.attributes.costume;\r\n    }\r\n};\r\n\r\nSnapSerializer.prototype.loadNestingInfo = function (object, model) {\r\n    // private\r\n    var info = model.childNamed('nest');\r\n    if (info) {\r\n        object.nestingInfo = info.attributes;\r\n    }\r\n};\r\n\r\nSnapSerializer.prototype.loadCostumes = function (object, model) {\r\n    // private\r\n    var costumes = model.childNamed('costumes'),\r\n        costume;\r\n    if (costumes) {\r\n        object.costumes = this.loadValue(costumes.require('list'));\r\n        object.costumes.type = 'costume';\r\n    }\r\n    if (Object.prototype.hasOwnProperty.call(\r\n            model.attributes,\r\n            'costume'\r\n        )) {\r\n        costume = object.costumes.asArray()[model.attributes.costume - 1];\r\n        if (costume) {\r\n            if (costume.loaded) {\r\n                object.wearCostume(costume, true);\r\n            } else {\r\n                costume.loaded = function () {\r\n                    object.wearCostume(costume, true);\r\n                    this.loaded = true;\r\n                };\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nSnapSerializer.prototype.loadSounds = function (object, model) {\r\n    // private\r\n    var sounds = model.childNamed('sounds');\r\n    if (sounds) {\r\n        object.sounds = this.loadValue(sounds.require('list'));\r\n        object.sounds.type = 'sound';\r\n    }\r\n};\r\n\r\nSnapSerializer.prototype.loadVariables = function (varFrame, element, object) {\r\n    // private\r\n    var myself = this;\r\n\r\n    element.children.forEach(function (child) {\r\n        var v, value;\r\n        if (child.tag !== 'variable') {\r\n            return;\r\n        }\r\n        value = child.children[0];\r\n        v = new Variable();\r\n        v.isTransient = (child.attributes.transient === 'true');\r\n        v.value = (v.isTransient || !value ) ? 0\r\n                : myself.loadValue(value, object);\r\n        varFrame.vars[child.attributes.name] = v;\r\n    });\r\n};\r\n\r\nSnapSerializer.prototype.loadCustomBlocks = function (\r\n    object,\r\n    element,\r\n    isGlobal,\r\n    isDispatch\r\n) {\r\n    // private\r\n    var myself = this;\r\n    element.children.forEach(function (child) {\r\n        var definition, names, inputs, vars, header, code, trans, comment, i;\r\n        if (child.tag !== 'block-definition') {\r\n            return;\r\n        }\r\n        definition = new CustomBlockDefinition(\r\n            child.attributes.s || '',\r\n            object\r\n        );\r\n        definition.category = child.attributes.category || 'other';\r\n        definition.type = child.attributes.type || 'command';\r\n        definition.isGlobal = (isGlobal === true);\r\n        if (isDispatch) {\r\n            object.inheritedMethodsCache.push(definition);\r\n        } else {\r\n            if (definition.isGlobal) {\r\n                object.globalBlocks.push(definition);\r\n            } else {\r\n                object.customBlocks.push(definition);\r\n            }\r\n        }\r\n\r\n        names = definition.parseSpec(definition.spec).filter(\r\n            function (str) {\r\n                return str.charAt(0) === '%' && str.length > 1;\r\n            }\r\n        ).map(function (str) {\r\n            return str.substr(1);\r\n        });\r\n\r\n        definition.names = names;\r\n        inputs = child.childNamed('inputs');\r\n        if (inputs) {\r\n            i = -1;\r\n            inputs.children.forEach(function (child) {\r\n                var options = child.childNamed('options');\r\n                if (child.tag !== 'input') {\r\n                    return;\r\n                }\r\n                i += 1;\r\n                definition.declarations[names[i]] = [\r\n                    child.attributes.type,\r\n                    contains(['%b', '%boolUE'], child.attributes.type) ?\r\n                        (child.contents ? child.contents === 'true' : null)\r\n                            : child.contents,\r\n                    options ? options.contents : undefined,\r\n                    child.attributes.readonly === 'true'\r\n                ];\r\n            });\r\n        }\r\n\r\n        vars = child.childNamed('variables');\r\n        if (vars) {\r\n            definition.variableNames = myself.loadValue(\r\n                vars.require('list')\r\n            ).asArray();\r\n        }\r\n\r\n        header = child.childNamed('header');\r\n        if (header) {\r\n            definition.codeHeader = header.contents;\r\n        }\r\n\r\n        code = child.childNamed('code');\r\n        if (code) {\r\n            definition.codeMapping = code.contents;\r\n        }\r\n\r\n        trans = child.childNamed('translations');\r\n        if (trans) {\r\n            definition.updateTranslations(trans.contents);\r\n        }\r\n\r\n        comment = child.childNamed('comment');\r\n        if (comment) {\r\n            definition.comment = myself.loadComment(comment);\r\n        }\r\n    });\r\n};\r\n\r\nSnapSerializer.prototype.populateCustomBlocks = function (\r\n    object,\r\n    element,\r\n    isGlobal\r\n) {\r\n    // private\r\n    var myself = this;\r\n    element.children.forEach(function (child, index) {\r\n        var definition, script, scripts;\r\n        if (child.tag !== 'block-definition') {\r\n            return;\r\n        }\r\n        definition = isGlobal ? object.globalBlocks[index]\r\n                : object.customBlocks[index];\r\n        script = child.childNamed('script');\r\n        if (script) {\r\n            definition.body = new Context(\r\n                null,\r\n                script ? myself.loadScript(script, object) : null,\r\n                null,\r\n                object\r\n            );\r\n            definition.body.inputs = definition.names.slice(0);\r\n        }\r\n        scripts = child.childNamed('scripts');\r\n        if (scripts) {\r\n            definition.scripts = myself.loadScriptsArray(scripts, object);\r\n        }\r\n\r\n        delete definition.names;\r\n    });\r\n};\r\n\r\nSnapSerializer.prototype.loadScripts = function (object, scripts, model) {\r\n    // private\r\n    var myself = this,\r\n        scale = SyntaxElementMorph.prototype.scale;\r\n    scripts.cachedTexture = IDE_Morph.prototype.scriptsPaneTexture;\r\n    model.children.forEach(function (child) {\r\n        var element;\r\n        if (child.tag === 'script') {\r\n            element = myself.loadScript(child, object);\r\n            if (!element) {\r\n                return;\r\n            }\r\n            element.setPosition(new Point(\r\n                (+child.attributes.x || 0) * scale,\r\n                (+child.attributes.y || 0) * scale\r\n            ).add(scripts.topLeft()));\r\n            scripts.add(element);\r\n            element.fixBlockColor(null, true); // force zebra coloring\r\n            element.allComments().forEach(function (comment) {\r\n                comment.align(element);\r\n            });\r\n        } else if (child.tag === 'comment') {\r\n            element = myself.loadComment(child);\r\n            if (!element) {\r\n                return;\r\n            }\r\n            element.setPosition(new Point(\r\n                (+child.attributes.x || 0) * scale,\r\n                (+child.attributes.y || 0) * scale\r\n            ).add(scripts.topLeft()));\r\n            scripts.add(element);\r\n        }\r\n    });\r\n};\r\n\r\nSnapSerializer.prototype.loadScriptsArray = function (model, object) {\r\n    // private - answer an array containting the model's scripts\r\n    var myself = this,\r\n        scale = SyntaxElementMorph.prototype.scale,\r\n        scripts = [];\r\n    model.children.forEach(function (child) {\r\n        var element;\r\n        if (child.tag === 'script') {\r\n            element = myself.loadScript(child, object);\r\n            if (!element) {\r\n                return;\r\n            }\r\n            element.setPosition(new Point(\r\n                (+child.attributes.x || 0) * scale,\r\n                (+child.attributes.y || 0) * scale\r\n            ));\r\n            scripts.push(element);\r\n            element.fixBlockColor(null, true); // force zebra coloring\r\n        } else if (child.tag === 'comment') {\r\n            element = myself.loadComment(child);\r\n            if (!element) {\r\n                return;\r\n            }\r\n            element.setPosition(new Point(\r\n                (+child.attributes.x || 0) * scale,\r\n                (+child.attributes.y || 0) * scale\r\n            ));\r\n            scripts.push(element);\r\n        }\r\n    });\r\n    return scripts;\r\n};\r\n\r\nSnapSerializer.prototype.loadScript = function (model, object) {\r\n    // private\r\n    var topBlock, block, nextBlock,\r\n        myself = this;\r\n    model.children.forEach(function (child) {\r\n        nextBlock = myself.loadBlock(child, false, object);\r\n        if (!nextBlock) {\r\n            return;\r\n        }\r\n        if (block) {\r\n            if (block.nextBlock && (nextBlock instanceof CommandBlockMorph)) {\r\n                block.nextBlock(nextBlock);\r\n            } else {\r\n                console.log(\r\n                    'SNAP: expecting a command but getting a reporter:\\n' +\r\n                        '  ' + block.blockSpec + '\\n' +\r\n                        '  ' + nextBlock.blockSpec\r\n                );\r\n                return topBlock;\r\n            }\r\n        } else {\r\n            topBlock = nextBlock;\r\n        }\r\n        block = nextBlock;\r\n    });\r\n    return topBlock;\r\n};\r\n\r\nSnapSerializer.prototype.loadComment = function (model) {\r\n    // private\r\n    var comment = new CommentMorph(model.contents),\r\n        scale = SyntaxElementMorph.prototype.scale;\r\n    comment.isCollapsed = (model.attributes.collapsed === 'true');\r\n    comment.setTextWidth(+model.attributes.w * scale);\r\n    return comment;\r\n};\r\n\r\nSnapSerializer.prototype.loadBlock = function (model, isReporter, object) {\r\n    // private\r\n    var block, info, inputs, isGlobal, receiver, migration,\r\n        migrationOffset = 0;\r\n    if (model.tag === 'block') {\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'var'\r\n            )) {\r\n            return SpriteMorph.prototype.variableBlock(\r\n                model.attributes['var']\r\n            );\r\n        }\r\n       \r\n        block = SpriteMorph.prototype.blockForSelector(model.attributes.s);\r\n        migration = SpriteMorph.prototype.blockMigrations[model.attributes.s];\r\n        if (migration) {\r\n            migrationOffset = migration.offset;\r\n        }\r\n    } else if (model.tag === 'custom-block') {\r\n        isGlobal = model.attributes.scope ? false : true;\r\n        receiver = isGlobal ? this.project.stage : object;\r\n        if (isGlobal) {\r\n            info = detect(receiver.globalBlocks, function (block) {\r\n                return block.blockSpec() === model.attributes.s;\r\n            });\r\n            if (!info && this.project.targetStage) { // importing block files\r\n                info = detect(\r\n                    this.project.targetStage.globalBlocks,\r\n                    function (block) {\r\n                        return block.blockSpec() === model.attributes.s;\r\n                    }\r\n                );\r\n            }\r\n        } else {\r\n            // lookup in inherited methods\r\n            info = detect(receiver.customBlocks, function (block) {\r\n                return block.blockSpec() === model.attributes.s;\r\n            }) || (\r\n            \treceiver.inheritedMethodsCache ?\r\n                \tdetect(receiver.inheritedMethodsCache, function (block) {\r\n                    \treturn block.blockSpec() === model.attributes.s;\r\n                \t})\r\n          \t\t: null\r\n          \t);\r\n        }\r\n        if (!info) {\r\n            return this.obsoleteBlock(isReporter);\r\n        }\r\n        block = info.type === 'command' ? new CustomCommandBlockMorph(\r\n            info,\r\n            false\r\n        ) : new CustomReporterBlockMorph(\r\n            info,\r\n            info.type === 'predicate',\r\n            false\r\n        );\r\n    }\r\n    if (block === null) {\r\n        block = this.obsoleteBlock(isReporter);\r\n    }\r\n    block.isDraggable = true;\r\n    inputs = block.inputs();\r\n    model.children.forEach(function (child, i) {\r\n        if (child.tag === 'variables') {\r\n            this.loadVariables(block.variables, child, object);\r\n        } else if (child.tag === 'comment') {\r\n            block.comment = this.loadComment(child);\r\n            block.comment.block = block;\r\n        } else if (child.tag === 'receiver') {\r\n            nop(); // ignore\r\n        } else {\r\n            this.loadInput(child, inputs[i + migrationOffset], block, object);\r\n        }\r\n    }, this);\r\n    block.cachedInputs = null;\r\n    return block;\r\n};\r\n\r\nSnapSerializer.prototype.obsoleteBlock = function (isReporter) {\r\n    // private\r\n    var block = isReporter ? new ReporterBlockMorph()\r\n            : new CommandBlockMorph();\r\n    block.selector = 'errorObsolete';\r\n    block.color = new Color(200, 0, 20);\r\n    block.setSpec('Obsolete!');\r\n    block.isDraggable = true;\r\n    return block;\r\n};\r\n\r\nSnapSerializer.prototype.loadInput = function (model, input, block, object) {\r\n    // private\r\n    var inp, val, myself = this;\r\n    if (isNil(input)) {\r\n        return;\r\n    }\r\n    if (model.tag === 'script') {\r\n        inp = this.loadScript(model, object);\r\n        if (inp) {\r\n            input.add(inp);\r\n            input.fixLayout();\r\n        }\r\n    } else if (model.tag === 'autolambda' && model.children[0]) {\r\n        inp = this.loadBlock(model.children[0], true, object);\r\n        if (inp) {\r\n            input.silentReplaceInput(input.children[0], inp);\r\n            input.fixLayout();\r\n        }\r\n    } else if (model.tag === 'list') {\r\n        while (input.inputs().length > 0) {\r\n            input.removeInput();\r\n        }\r\n        model.children.forEach(function (item) {\r\n            input.addInput();\r\n            myself.loadInput(\r\n                item,\r\n                input.children[input.children.length - 2],\r\n                input,\r\n                object\r\n            );\r\n        });\r\n        input.fixLayout();\r\n    } else if (model.tag === 'block' || model.tag === 'custom-block') {\r\n        block.silentReplaceInput(input, this.loadBlock(model, true, object));\r\n    } else if (model.tag === 'color') {\r\n        input.setColor(this.loadColor(model.contents));\r\n    } else {\r\n        val = this.loadValue(model);\r\n        if (!isNil(val) && !isNil(input) && input.setContents) {\r\n            // checking whether \"input\" is nil should not\r\n            // be necessary, but apparently is after retina support\r\n            // was added.\r\n            input.setContents(this.loadValue(model));\r\n        }\r\n    }\r\n};\r\n\r\nSnapSerializer.prototype.loadValue = function (model, object) {\r\n    // private\r\n    var v, i, lst, items, el, center, image, name, audio, option, bool, origin,\r\n        myself = this;\r\n\r\n    function record() {\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'id'\r\n            )) {\r\n            myself.objects[model.attributes.id] = v;\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'mediaID'\r\n            )) {\r\n            myself.mediaDict[model.attributes.mediaID] = v;\r\n        }\r\n    }\r\n\r\n    switch (model.tag) {\r\n    case 'ref':\r\n        if (Object.prototype.hasOwnProperty.call(model.attributes, 'id')) {\r\n            return this.objects[model.attributes.id];\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'mediaID'\r\n            )) {\r\n            return this.mediaDict[model.attributes.mediaID];\r\n        }\r\n        throw new Error('expecting a reference id');\r\n    case 'l':\r\n        option = model.childNamed('option');\r\n        if (option) {\r\n            return [option.contents];\r\n        }\r\n        bool = model.childNamed('bool');\r\n        if (bool) {\r\n            return this.loadValue(bool);\r\n        }\r\n        return model.contents;\r\n    case 'bool':\r\n        return model.contents === 'true';\r\n    case 'list':\r\n        if (model.attributes.hasOwnProperty('linked')) {\r\n            v = new List();\r\n            v.isLinked = true;\r\n            record();\r\n            lst = v;\r\n            items = model.childrenNamed('item');\r\n            items.forEach(function (item, i) {\r\n                var value = item.children[0];\r\n                if (!value) {\r\n                    v.first = 0;\r\n                } else {\r\n                    v.first = myself.loadValue(value, object);\r\n                }\r\n                var tail = model.childNamed('list') ||\r\n                    model.childNamed('ref');\r\n                if (tail) {\r\n                    v.rest = myself.loadValue(tail, object);\r\n                } else {\r\n                    if (i < (items.length - 1)) {\r\n                        v.rest = new List();\r\n                        v = v.rest;\r\n                        v.isLinked = true;\r\n                    }\r\n                }\r\n            });\r\n            return lst;\r\n        }\r\n        v = new List();\r\n        record();\r\n        v.contents = model.childrenNamed('item').map(function (item) {\r\n            var value = item.children[0];\r\n            if (!value) {\r\n                return 0;\r\n            }\r\n            return myself.loadValue(value, object);\r\n        });\r\n        return v;\r\n    case 'sprite':\r\n        v  = new SpriteMorph(myself.project.globalVariables);\r\n        if (model.attributes.id) {\r\n            myself.objects[model.attributes.id] = v;\r\n        }\r\n        if (model.attributes.name) {\r\n            v.name = model.attributes.name;\r\n            myself.project.sprites[model.attributes.name] = v;\r\n        }\r\n        if (model.attributes.idx) {\r\n            v.idx = +model.attributes.idx;\r\n        }\r\n        if (model.attributes.color) {\r\n            v.color = myself.loadColor(model.attributes.color);\r\n        }\r\n        if (model.attributes.pen) {\r\n            v.penPoint = model.attributes.pen;\r\n        }\r\n        myself.project.stage.add(v);\r\n        v.scale = parseFloat(model.attributes.scale || '1');\r\n        v.rotationStyle = parseFloat(\r\n            model.attributes.rotation || '1'\r\n        );\r\n        v.isDraggable = model.attributes.draggable !== 'false';\r\n        v.isVisible = model.attributes.hidden !== 'true';\r\n        v.heading = parseFloat(model.attributes.heading) || 0;\r\n        v.drawNew();\r\n        v.gotoXY(+model.attributes.x || 0, +model.attributes.y || 0);\r\n        myself.loadObject(v, model);\r\n        return v;\r\n    case 'context':\r\n        v = new Context(null);\r\n        record();\r\n        el = model.childNamed('origin');\r\n        if (el) {\r\n            el = el.childNamed('ref') || el.childNamed('sprite');\r\n            if (el) {\r\n                v.origin = this.loadValue(el);\r\n            }\r\n        }\r\n        el = model.childNamed('receiver');\r\n        if (el) {\r\n            el = el.childNamed('ref') || el.childNamed('sprite');\r\n            if (el) {\r\n                v.receiver = this.loadValue(el);\r\n            }\r\n        }\r\n        origin = v.origin || v.receiver || object; // for local blocks look up\r\n        el = model.childNamed('script');\r\n        if (el) {\r\n            v.expression = this.loadScript(el, origin);\r\n        } else {\r\n            el = model.childNamed('block') ||\r\n                model.childNamed('custom-block');\r\n            if (el) {\r\n                v.expression = this.loadBlock(el, null, origin);\r\n            } else {\r\n                el = model.childNamed('l');\r\n                if (el) {\r\n                    bool = el.childNamed('bool');\r\n                    if (bool) {\r\n                        v.expression = new BooleanSlotMorph(\r\n                            this.loadValue(bool)\r\n                        );\r\n                    } else {\r\n                        v.expression = new InputSlotMorph(el.contents);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (v.expression instanceof BlockMorph) {\r\n            // bind empty slots to implicit formal parameters\r\n            i = 0;\r\n            v.expression.allEmptySlots().forEach(function (slot) {\r\n                i += 1;\r\n                if (slot instanceof MultiArgMorph) {\r\n                    slot.bindingID = ['arguments'];\r\n                } else {\r\n                    slot.bindingID = i;\r\n                }\r\n            });\r\n            // and remember the number of detected empty slots\r\n            v.emptySlots = i;\r\n        }\r\n        el = model.childNamed('inputs');\r\n        if (el) {\r\n            el.children.forEach(function (item) {\r\n                if (item.tag === 'input') {\r\n                    v.inputs.push(item.contents);\r\n                }\r\n            });\r\n        }\r\n        el = model.childNamed('variables');\r\n        if (el) {\r\n            this.loadVariables(v.variables, el, origin);\r\n        }\r\n        el = model.childNamed('context');\r\n        if (el) {\r\n            v.outerContext = this.loadValue(el, origin);\r\n        }\r\n        if (v.outerContext && v.receiver &&\r\n                !v.outerContext.variables.parentFrame) {\r\n            v.outerContext.variables.parentFrame = v.receiver.variables;\r\n        }\r\n        return v;\r\n    case 'costume':\r\n        center = new Point();\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'center-x'\r\n            )) {\r\n            center.x = parseFloat(model.attributes['center-x']);\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'center-y'\r\n            )) {\r\n            center.y = parseFloat(model.attributes['center-y']);\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'name'\r\n            )) {\r\n            name = model.attributes.name;\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'image'\r\n            )) {\r\n            image = new Image();\r\n            if (model.attributes.image.indexOf('data:image/svg+xml') === 0\r\n                    && !MorphicPreferences.rasterizeSVGs) {\r\n                v = new SVG_Costume(null, name, center);\r\n                image.onload = function () {\r\n                    v.contents = image;\r\n                    v.version = +new Date();\r\n                    if (typeof v.loaded === 'function') {\r\n                        v.loaded();\r\n                    } else {\r\n                        v.loaded = true;\r\n                    }\r\n                };\r\n            } else {\r\n                v = new Costume(null, name, center);\r\n                image.onload = function () {\r\n                    var canvas = newCanvas(\r\n                            new Point(image.width, image.height),\r\n                            true // nonRetina\r\n                        ),\r\n                        context = canvas.getContext('2d');\r\n                    context.drawImage(image, 0, 0);\r\n                    v.contents = canvas;\r\n                    v.version = +new Date();\r\n                    if (typeof v.loaded === 'function') {\r\n                        v.loaded();\r\n                    } else {\r\n                        v.loaded = true;\r\n                    }\r\n                };\r\n            }\r\n            image.src = model.attributes.image;\r\n        }\r\n        record();\r\n        return v;\r\n    case 'sound':\r\n        audio = new Audio();\r\n        audio.src = model.attributes.sound;\r\n        v = new Sound(audio, model.attributes.name);\r\n        if (Object.prototype.hasOwnProperty.call(\r\n                model.attributes,\r\n                'mediaID'\r\n            )) {\r\n            myself.mediaDict[model.attributes.mediaID] = v;\r\n        }\r\n        record();\r\n        return v;\r\n    }\r\n    return undefined;\r\n};\r\n\r\nSnapSerializer.prototype.loadColor = function (colorString) {\r\n    // private\r\n    var c = (colorString || '').split(',');\r\n    return new Color(\r\n        parseFloat(c[0]),\r\n        parseFloat(c[1]),\r\n        parseFloat(c[2]),\r\n        parseFloat(c[3])\r\n    );\r\n};\r\n\r\nSnapSerializer.prototype.openProject = function (project, ide) {\r\n    var stage = ide.stage,\r\n        sprites = [],\r\n        sprite;\r\n    if (!project || !project.stage) {\r\n        return;\r\n    }\r\n    ide.projectName = project.name;\r\n    ide.projectNotes = project.notes || '';\r\n    if (ide.globalVariables) {\r\n        ide.globalVariables = project.globalVariables;\r\n    }\r\n    if (stage) {\r\n        stage.destroy();\r\n    }\r\n    ide.add(project.stage);\r\n    ide.stage = project.stage;\r\n    sprites = ide.stage.children.filter(function (child) {\r\n        return child instanceof SpriteMorph;\r\n    });\r\n    sprites.sort(function (x, y) {\r\n        return x.idx - y.idx;\r\n    });\r\n\r\n    ide.sprites = new List(sprites);\r\n    sprite = sprites[0] || project.stage;\r\n\r\n    if (sizeOf(this.mediaDict) > 0) {\r\n        ide.hasChangedMedia = false;\r\n        this.mediaDict = {};\r\n    } else {\r\n        ide.hasChangedMedia = true;\r\n    }\r\n    project.stage.drawNew();\r\n    ide.createCorral();\r\n    ide.selectSprite(sprite);\r\n    ide.fixLayout();\r\n\r\n    // force watchers to update\r\n    //project.stage.watchers().forEach(function (watcher) {\r\n    //  watcher.onNextStep = function () {this.currentValue = null;};\r\n    //})\r\n\r\n    ide.world().keyboardReceiver = project.stage;\r\n};\r\n\r\n// SnapSerializer XML-representation of objects:\r\n\r\n// Generics\r\n// Sprites\r\n\r\nStageMorph.prototype.toXML = function (serializer) {\r\n    var thumbnail = normalizeCanvas(\r\n            this.thumbnail(SnapSerializer.prototype.thumbnailSize),\r\n            true\r\n        ),\r\n        thumbdata,\r\n        ide = this.parentThatIsA(IDE_Morph);\r\n\r\n    // catch cross-origin tainting exception when using SVG costumes\r\n    try {\r\n        thumbdata = thumbnail.toDataURL('image/png');\r\n    } catch (error) {\r\n        thumbdata = null;\r\n    }\r\n\r\n    function code(key) {\r\n        var str = '';\r\n        Object.keys(StageMorph.prototype[key]).forEach(\r\n            function (selector) {\r\n                str += (\r\n                    '<' + selector + '>' +\r\n                        XML_Element.prototype.escape(\r\n                            StageMorph.prototype[key][selector]\r\n                        ) +\r\n                        '</' + selector + '>'\r\n                );\r\n            }\r\n        );\r\n        return str;\r\n    }\r\n\r\n    this.removeAllClones();\r\n    return serializer.format(\r\n        '<project name=\"@\" app=\"@\" version=\"@\">' +\r\n            '<notes>$</notes>' +\r\n            '<thumbnail>$</thumbnail>' +\r\n            '<stage name=\"@\" width=\"@\" height=\"@\" ' +\r\n            'costume=\"@\" tempo=\"@\" threadsafe=\"@\" ' +\r\n            '%' +\r\n            'lines=\"@\" ' +\r\n            'ternary=\"@\" ' +\r\n            'codify=\"@\" ' +\r\n            'inheritance=\"@\" ' +\r\n            'sublistIDs=\"@\" ' +\r\n            'scheduled=\"@\" ~>' +\r\n            '<pentrails>$</pentrails>' +\r\n            '<costumes>%</costumes>' +\r\n            '<sounds>%</sounds>' +\r\n            '<variables>%</variables>' +\r\n            '<blocks>%</blocks>' +\r\n            '<scripts>%</scripts><sprites>%</sprites>' +\r\n            '</stage>' +\r\n            '<hidden>$</hidden>' +\r\n            '<headers>%</headers>' +\r\n            '<code>%</code>' +\r\n            '<blocks>%</blocks>' +\r\n            '<variables>%</variables>' +\r\n            '</project>',\r\n        (ide && ide.projectName) ? ide.projectName : localize('Untitled'),\r\n        serializer.app,\r\n        serializer.version,\r\n        (ide && ide.projectNotes) ? ide.projectNotes : '',\r\n        thumbdata,\r\n        this.name,\r\n        StageMorph.prototype.dimensions.x,\r\n        StageMorph.prototype.dimensions.y,\r\n        this.getCostumeIdx(),\r\n        this.getTempo(),\r\n        this.isThreadSafe,\r\n        this.instrument ?\r\n                ' instrument=\"' + parseInt(this.instrument) + '\" ' : '',\r\n        SpriteMorph.prototype.useFlatLineEnds ? 'flat' : 'round',\r\n        BooleanSlotMorph.prototype.isTernary,\r\n        this.enableCodeMapping,\r\n        this.enableInheritance,\r\n        this.enableSublistIDs,\r\n        StageMorph.prototype.frameRate !== 0,\r\n        normalizeCanvas(this.trailsCanvas, true).toDataURL('image/png'),\r\n        serializer.store(this.costumes, this.name + '_cst'),\r\n        serializer.store(this.sounds, this.name + '_snd'),\r\n        serializer.store(this.variables),\r\n        serializer.store(this.customBlocks),\r\n        serializer.store(this.scripts),\r\n        serializer.store(this.children),\r\n        Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(\r\n                function (a, b) {return a + ' ' + b; },\r\n                ''\r\n            ),\r\n        code('codeHeaders'),\r\n        code('codeMappings'),\r\n        serializer.store(this.globalBlocks),\r\n        (ide && ide.globalVariables) ?\r\n                    serializer.store(ide.globalVariables) : ''\r\n    );\r\n};\r\n\r\nSpriteMorph.prototype.toXML = function (serializer) {\r\n    var stage = this.parentThatIsA(StageMorph),\r\n        ide = stage ? stage.parentThatIsA(IDE_Morph) : null,\r\n        idx = ide ? ide.sprites.asArray().indexOf(this) + 1 : 0,\r\n        noCostumes = this.inheritsAttribute('costumes'),\r\n        noSounds = this.inheritsAttribute('sounds'),\r\n        noScripts = this.inheritsAttribute('scripts');\r\n\r\n    return serializer.format(\r\n        '<sprite name=\"@\" idx=\"@\" x=\"@\" y=\"@\"' +\r\n            ' heading=\"@\"' +\r\n            ' scale=\"@\"' +\r\n            ' rotation=\"@\"' +\r\n            '%' +\r\n            ' draggable=\"@\"' +\r\n            '%' +\r\n            ' costume=\"@\" color=\"@,@,@\" pen=\"@\" ~>' +\r\n            '%' + // inheritance info\r\n            '%' + // nesting info\r\n            (noCostumes ? '%' : '<costumes>%</costumes>') +\r\n            (noSounds ? '%' : '<sounds>%</sounds>') +\r\n            '<blocks>%</blocks>' +\r\n            '<variables>%</variables>' +\r\n            (this.exemplar ? '<dispatches>%</dispatches>' : '%') +\r\n            (noScripts ? '%' : '<scripts>%</scripts>') +\r\n            '</sprite>',\r\n        this.name,\r\n        idx,\r\n        this.xPosition(),\r\n        this.yPosition(),\r\n        this.heading,\r\n        this.scale,\r\n        this.rotationStyle,\r\n        this.instrument ?\r\n                ' instrument=\"' + parseInt(this.instrument) + '\" ' : '',\r\n        this.isDraggable,\r\n        this.isVisible ? '' : ' hidden=\"true\"',\r\n        this.getCostumeIdx(),\r\n        this.color.r,\r\n        this.color.g,\r\n        this.color.b,\r\n        this.penPoint,\r\n\r\n        // inheritance info\r\n        this.exemplar\r\n            ? '<inherit exemplar=\"' +\r\n                    this.exemplar.name +\r\n                    '\">' +\r\n                    (this.inheritedAttributes.length ?\r\n                        serializer.store(new List(this.inheritedAttributes))\r\n                        : '') +\r\n                    '</inherit>'\r\n            : '',\r\n\r\n        // nesting info\r\n        this.anchor\r\n            ? '<nest anchor=\"' +\r\n                    this.anchor.name +\r\n                    '\" synch=\"'\r\n                    + this.rotatesWithAnchor\r\n                    + (this.scale === this.nestingScale ? '' :\r\n                            '\"'\r\n                            + ' scale=\"'\r\n                            + this.nestingScale)\r\n\r\n                    + '\"/>'\r\n            : '',\r\n\r\n        noCostumes ? '' : serializer.store(this.costumes, this.name + '_cst'),\r\n        noSounds ? '' : serializer.store(this.sounds, this.name + '_snd'),\r\n        !this.customBlocks ? '' : serializer.store(this.customBlocks),\r\n        serializer.store(this.variables),\r\n        this.exemplar ? serializer.store(this.inheritedMethods()) : '',\r\n        noScripts ? '' : serializer.store(this.scripts)\r\n    );\r\n};\r\n\r\nCostume.prototype[XML_Serializer.prototype.mediaDetectionProperty] = true;\r\n\r\nCostume.prototype.toXML = function (serializer) {\r\n    return serializer.format(\r\n        '<costume name=\"@\" center-x=\"@\" center-y=\"@\" image=\"@\" ~/>',\r\n        this.name,\r\n        this.rotationCenter.x,\r\n        this.rotationCenter.y,\r\n        this instanceof SVG_Costume ? this.contents.src\r\n                : normalizeCanvas(this.contents).toDataURL('image/png')\r\n    );\r\n};\r\n\r\nSound.prototype[XML_Serializer.prototype.mediaDetectionProperty] = true;\r\n\r\nSound.prototype.toXML = function (serializer) {\r\n    return serializer.format(\r\n        '<sound name=\"@\" sound=\"@\" ~/>',\r\n        this.name,\r\n        this.toDataURL()\r\n    );\r\n};\r\n\r\nVariableFrame.prototype.toXML = function (serializer) {\r\n    var myself = this;\r\n    return Object.keys(this.vars).reduce(function (vars, v) {\r\n        var val = myself.vars[v].value,\r\n            dta;\r\n        if (myself.vars[v].isTransient) {\r\n            dta = serializer.format(\r\n                '<variable name=\"@\" transient=\"true\"/>',\r\n                v)\r\n            ;\r\n        } else if (val === undefined || val === null) {\r\n            dta = serializer.format('<variable name=\"@\"/>', v);\r\n        } else {\r\n            dta = serializer.format(\r\n                '<variable name=\"@\">%</variable>',\r\n                v,\r\n                typeof val === 'object' ?\r\n                        (isSnapObject(val) ? ''\r\n                                : serializer.store(val))\r\n                                : typeof val === 'boolean' ?\r\n                                        serializer.format(\r\n                                            '<bool>$</bool>', val\r\n                                        )\r\n                                        : serializer.format('<l>$</l>', val)\r\n            );\r\n        }\r\n        return vars + dta;\r\n    }, '');\r\n};\r\n\r\n// Watchers\r\n\r\nWatcherMorph.prototype.toXML = function (serializer) {\r\n    var isVar = this.target instanceof VariableFrame,\r\n        isList = this.currentValue instanceof List,\r\n        color = this.readoutColor,\r\n        position = this.parent ?\r\n                this.topLeft().subtract(this.parent.topLeft())\r\n                : this.topLeft();\r\n\r\n    if (this.isTemporary()) {\r\n        // do not save watchers on temporary variables\r\n        return '';\r\n    }\r\n    return serializer.format(\r\n        '<watcher% % style=\"@\"% x=\"@\" y=\"@\" color=\"@,@,@\"%%/>',\r\n        (isVar && this.target.owner) || (!isVar && this.target) ?\r\n                    serializer.format(' scope=\"@\"',\r\n                        isVar ? this.target.owner.name : this.target.name)\r\n                            : '',\r\n        serializer.format(isVar ? 'var=\"@\"' : 's=\"@\"', this.getter),\r\n        this.style,\r\n        isVar && this.style === 'slider' ? serializer.format(\r\n                ' min=\"@\" max=\"@\"',\r\n                this.sliderMorph.start,\r\n                this.sliderMorph.stop\r\n            ) : '',\r\n        position.x,\r\n        position.y,\r\n        color.r,\r\n        color.g,\r\n        color.b,\r\n        !isList ? ''\r\n                : serializer.format(\r\n                ' extX=\"@\" extY=\"@\"',\r\n                this.cellMorph.contentsMorph.width(),\r\n                this.cellMorph.contentsMorph.height()\r\n            ),\r\n        this.isVisible ? '' : ' hidden=\"true\"'\r\n    );\r\n};\r\n\r\n// Scripts\r\n\r\nScriptsMorph.prototype.toXML = function (serializer) {\r\n    return this.children.reduce(function (xml, child) {\r\n        if (child instanceof BlockMorph) {\r\n            return xml + child.toScriptXML(serializer, true);\r\n        }\r\n        if (child instanceof CommentMorph && !child.block) { // unattached\r\n            return xml + child.toXML(serializer);\r\n        }\r\n        return xml;\r\n    }, '');\r\n};\r\n\r\nBlockMorph.prototype.toXML = BlockMorph.prototype.toScriptXML = function (\r\n    serializer,\r\n    savePosition\r\n) {\r\n    var position,\r\n        xml,\r\n        scale = SyntaxElementMorph.prototype.scale,\r\n        block = this;\r\n\r\n    // determine my position\r\n    if (this.parent) {\r\n        position = this.topLeft().subtract(this.parent.topLeft());\r\n    } else {\r\n        position = this.topLeft();\r\n    }\r\n\r\n    // save my position to xml\r\n    if (savePosition) {\r\n        xml = serializer.format(\r\n            '<script x=\"@\" y=\"@\">',\r\n            position.x / scale,\r\n            position.y / scale\r\n        );\r\n    } else {\r\n        xml = '<script>';\r\n    }\r\n\r\n    // recursively add my next blocks to xml\r\n    do {\r\n        xml += block.toBlockXML(serializer);\r\n        block = block.nextBlock();\r\n    } while (block);\r\n    xml += '</script>';\r\n    return xml;\r\n};\r\n\r\nBlockMorph.prototype.toBlockXML = function (serializer) {\r\n    return serializer.format(\r\n        '<block s=\"@\">%%</block>',\r\n        this.selector,\r\n        serializer.store(this.inputs()),\r\n        this.comment ? this.comment.toXML(serializer) : ''\r\n    );\r\n};\r\n\r\nReporterBlockMorph.prototype.toXML = function (serializer) {\r\n    return this.selector === 'reportGetVar' ? serializer.format(\r\n        '<block var=\"@\"/>',\r\n        this.blockSpec\r\n    ) : this.toBlockXML(serializer);\r\n};\r\n\r\nReporterBlockMorph.prototype.toScriptXML = function (\r\n    serializer,\r\n    savePosition\r\n) {\r\n    var position,\r\n        scale = SyntaxElementMorph.prototype.scale;\r\n\r\n    // determine my save-position\r\n    if (this.parent) {\r\n        position = this.topLeft().subtract(this.parent.topLeft());\r\n    } else {\r\n        position = this.topLeft();\r\n    }\r\n\r\n    if (savePosition) {\r\n        return serializer.format(\r\n            '<script x=\"@\" y=\"@\">%</script>',\r\n            position.x / scale,\r\n            position.y / scale,\r\n            this.toXML(serializer)\r\n        );\r\n    }\r\n    return serializer.format('<script>%</script>', this.toXML(serializer));\r\n};\r\n\r\nCustomCommandBlockMorph.prototype.toBlockXML = function (serializer) {\r\n    var scope = this.isGlobal ? undefined : 'local';\r\n    return serializer.format(\r\n        '<custom-block s=\"@\"%>%%%</custom-block>',\r\n        this.semanticSpec,\r\n        this.isGlobal ?\r\n                '' : serializer.format(' scope=\"@\"', scope),\r\n        serializer.store(this.inputs()),\r\n        this.isGlobal &&\r\n        \tthis.definition.variableNames.length &&\r\n            !serializer.isExportingBlocksLibrary ?\r\n                '<variables>' +\r\n                    this.variables.toXML(serializer) +\r\n                    '</variables>'\r\n                        : '',\r\n        this.comment ? this.comment.toXML(serializer) : ''\r\n    );\r\n};\r\n\r\nCustomReporterBlockMorph.prototype.toBlockXML\r\n    = CustomCommandBlockMorph.prototype.toBlockXML;\r\n\r\nCustomBlockDefinition.prototype.toXML = function (serializer) {\r\n    var myself = this;\r\n\r\n    function encodeScripts(array) {\r\n        return array.reduce(function (xml, element) {\r\n            if (element instanceof BlockMorph) {\r\n                return xml + element.toScriptXML(serializer, true);\r\n            }\r\n            if (element instanceof CommentMorph && !element.block) {\r\n                return xml + element.toXML(serializer);\r\n            }\r\n            return xml;\r\n        }, '');\r\n    }\r\n\r\n    return serializer.format(\r\n        '<block-definition s=\"@\" type=\"@\" category=\"@\">' +\r\n            '%' +\r\n            (this.variableNames.length ? '<variables>%</variables>' : '@') +\r\n            '<header>@</header>' +\r\n            '<code>@</code>' +\r\n            '<translations>@</translations>' +\r\n            '<inputs>%</inputs>%%' +\r\n            '</block-definition>',\r\n        this.spec,\r\n        this.type,\r\n        this.category || 'other',\r\n        this.comment ? this.comment.toXML(serializer) : '',\r\n        (this.variableNames.length ?\r\n                serializer.store(new List(this.variableNames)) : ''),\r\n        this.codeHeader || '',\r\n        this.codeMapping || '',\r\n        this.translationsAsText(),\r\n        Object.keys(this.declarations).reduce(function (xml, decl) {\r\n                return xml + serializer.format(\r\n                    '<input type=\"@\"$>$%</input>',\r\n                    myself.declarations[decl][0],\r\n                    myself.declarations[decl][3] ?\r\n                            ' readonly=\"true\"' : '',\r\n                    myself.declarations[decl][1],\r\n                    myself.declarations[decl][2] ?\r\n                            '<options>' + myself.declarations[decl][2] +\r\n                                '</options>'\r\n                                : ''\r\n                );\r\n            }, ''),\r\n        this.body ? serializer.store(this.body.expression) : '',\r\n        this.scripts.length > 0 ?\r\n                    '<scripts>' + encodeScripts(this.scripts) + '</scripts>'\r\n                        : ''\r\n    );\r\n};\r\n\r\n// Scripts - Inputs\r\n\r\nArgMorph.prototype.toXML = function () {\r\n    return '<l/>'; // empty by default\r\n};\r\n\r\nBooleanSlotMorph.prototype.toXML = function () {\r\n    return (typeof this.value === 'boolean') ?\r\n            '<l><bool>' + this.value + '</bool></l>'\r\n                    : '<l/>';\r\n\r\n};\r\n\r\nInputSlotMorph.prototype.toXML = function (serializer) {\r\n    if (this.constant) {\r\n        return serializer.format(\r\n            '<l><option>$</option></l>',\r\n            this.constant\r\n        );\r\n    }\r\n    return serializer.format('<l>$</l>', this.contents().text);\r\n};\r\n\r\nTemplateSlotMorph.prototype.toXML = function (serializer) {\r\n    return serializer.format('<l>$</l>', this.contents());\r\n};\r\n\r\nCommandSlotMorph.prototype.toXML = function (serializer) {\r\n    var block = this.children[0];\r\n    if (block instanceof BlockMorph) {\r\n        if (block instanceof ReporterBlockMorph) {\r\n            return serializer.format(\r\n                '<autolambda>%</autolambda>',\r\n                serializer.store(block)\r\n            );\r\n        }\r\n        return serializer.store(block);\r\n    }\r\n    return '<script></script>';\r\n};\r\n\r\nFunctionSlotMorph.prototype.toXML = CommandSlotMorph.prototype.toXML;\r\n\r\nMultiArgMorph.prototype.toXML = function (serializer) {\r\n    return serializer.format(\r\n        '<list>%</list>',\r\n        serializer.store(this.inputs())\r\n    );\r\n};\r\n\r\nArgLabelMorph.prototype.toXML = function (serializer) {\r\n    return serializer.format(\r\n        '%',\r\n        serializer.store(this.inputs()[0])\r\n    );\r\n};\r\n\r\nColorSlotMorph.prototype.toXML = function (serializer) {\r\n    return serializer.format(\r\n        '<color>$,$,$,$</color>',\r\n        this.color.r,\r\n        this.color.g,\r\n        this.color.b,\r\n        this.color.a\r\n    );\r\n};\r\n\r\n// Values\r\n\r\nList.prototype.toXML = function (serializer, mediaContext) {\r\n    // mediaContext is an optional name-stub\r\n    // when collecting media into a separate module\r\n    var xml, value, item;\r\n    if (this.isLinked) {\r\n        xml = '<list linked=\"linked\" ~>';\r\n        if (StageMorph.prototype.enableSublistIDs) {\r\n            // recursively nest tails:\r\n            value = this.first;\r\n            if (!isNil(value)) {\r\n                xml += serializer.format(\r\n                    '<item>%</item>',\r\n                    typeof value === 'object' ?\r\n                            (isSnapObject(value) ? ''\r\n                                    : serializer.store(value, mediaContext))\r\n                            : typeof value === 'boolean' ?\r\n                                    serializer.format('<bool>$</bool>', value)\r\n                                    : serializer.format('<l>$</l>', value)\r\n                );\r\n            }\r\n            if (!isNil(this.rest)) {\r\n                xml += serializer.store(this.rest, mediaContext);\r\n            }\r\n            return xml + '</list>';\r\n        }\r\n        // else sequentially serialize tails:\r\n        item = this;\r\n        do {\r\n            value = item.first;\r\n            if (!isNil(value)) {\r\n                xml += serializer.format(\r\n                    '<item>%</item>',\r\n                    typeof value === 'object' ?\r\n                            (isSnapObject(value) ? ''\r\n                                    : serializer.store(value, mediaContext))\r\n                            : typeof value === 'boolean' ?\r\n                                    serializer.format('<bool>$</bool>', value)\r\n                                    : serializer.format('<l>$</l>', value)\r\n                );\r\n            }\r\n            item = item.rest;\r\n        } while (!isNil(item));\r\n        return xml + '</list>';\r\n    }\r\n    // dynamic array:\r\n    return serializer.format(\r\n        '<list ~>%</list>',\r\n        this.contents.reduce(function (xml, item) {\r\n            return xml + serializer.format(\r\n                '<item>%</item>',\r\n                typeof item === 'object' ?\r\n                        (isSnapObject(item) ? ''\r\n                                : serializer.store(item, mediaContext))\r\n                        : typeof item === 'boolean' ?\r\n                                serializer.format('<bool>$</bool>', item)\r\n                                : serializer.format('<l>$</l>', item)\r\n            );\r\n        }, '')\r\n    );\r\n};\r\n\r\nContext.prototype.toXML = function (serializer) {\r\n    if (this.isContinuation) { // continuations are transient in Snap!\r\n        return '';\r\n    }\r\n    return serializer.format(\r\n        '<context ~><inputs>%</inputs><variables>%</variables>' +\r\n            '%<receiver>%</receiver><origin>%</origin>%</context>',\r\n        this.inputs.reduce(\r\n                function (xml, input) {\r\n                    return xml + serializer.format('<input>$</input>', input);\r\n                },\r\n                ''\r\n            ),\r\n        this.variables ? serializer.store(this.variables) : '',\r\n        this.expression ? serializer.store(this.expression) : '',\r\n        this.receiver ? serializer.store(this.receiver) : '',\r\n        this.receiver ? serializer.store(this.origin) : '',\r\n        this.outerContext ? serializer.store(this.outerContext) : ''\r\n    );\r\n};\r\n\r\n// Comments\r\n\r\nCommentMorph.prototype.toXML = function (serializer) {\r\n    var position,\r\n        scale = SyntaxElementMorph.prototype.scale;\r\n\r\n    if (this.block) { // attached to a block\r\n        return serializer.format(\r\n            '<comment w=\"@\" collapsed=\"@\">%</comment>',\r\n            this.textWidth() / scale,\r\n            this.isCollapsed,\r\n            serializer.escape(this.text())\r\n        );\r\n    }\r\n\r\n    // free-floating, determine my save-position\r\n    if (this.parent) {\r\n        position = this.topLeft().subtract(this.parent.topLeft());\r\n    } else {\r\n        position = this.topLeft();\r\n    }\r\n    return serializer.format(\r\n        '<comment x=\"@\" y=\"@\" w=\"@\" collapsed=\"@\">%</comment>',\r\n        position.x / scale,\r\n        position.y / scale,\r\n        this.textWidth() / scale,\r\n        this.isCollapsed,\r\n        serializer.escape(this.text())\r\n    );\r\n};\r\n\r\n//fin de store.js\r\n/*\r\n\r\n    cloud.js\r\n\r\n    a backend API for SNAP!\r\n\r\n    written by Jens Mnig\r\n\r\n    Copyright (C) 2015 by Jens Mnig\r\n\r\n    This file is part of Snap!.\r\n\r\n    Snap! is free software: you can redistribute it and/or modify\r\n    it under the terms of the GNU Affero General Public License as\r\n    published by the Free Software Foundation, either version 3 of\r\n    the License, or (at your option) any later version.\r\n\r\n    This program is distributed in the hope that it will be useful,\r\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n    GNU Affero General Public License for more details.\r\n\r\n    You should have received a copy of the GNU Affero General Public License\r\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n*/\r\n\r\n// Global settings /////////////////////////////////////////////////////\r\n\r\n/*global modules, IDE_Morph, SnapSerializer, hex_sha512, alert, nop,\r\nlocalize*/\r\n\r\nmodules.cloud = '2015-December-15';\r\n\r\n// Global stuff\r\n\r\nvar Cloud;\r\nvar SnapCloud = new Cloud(\r\n    'https://snap.apps.miosoft.com/SnapCloud'\r\n);\r\n\r\n// Cloud /////////////////////////////////////////////////////////////\r\n\r\nfunction Cloud(url) {\r\n    this.username = null;\r\n    this.password = null; // hex_sha512 hashed\r\n    this.url = url;\r\n    this.session = null;\r\n    this.limo = null;\r\n    this.route = null;\r\n    this.api = {};\r\n}\r\n\r\nCloud.prototype.clear = function () {\r\n    this.username = null;\r\n    this.password = null;\r\n    this.session = null;\r\n    this.limo = null;\r\n    this.route = null;\r\n    this.api = {};\r\n};\r\n\r\nCloud.prototype.hasProtocol = function () {\r\n    return this.url.toLowerCase().indexOf('http') === 0;\r\n};\r\n\r\nCloud.prototype.setRoute = function (username) {\r\n    var routes = 20,\r\n        userNum = 0,\r\n        i;\r\n\r\n    for (i = 0; i < username.length; i += 1) {\r\n        userNum += username.charCodeAt(i);\r\n    }\r\n    userNum = userNum % routes + 1;\r\n    this.route = '.sc1m' +\r\n        (userNum < 10 ? '0' : '') +\r\n        userNum;\r\n};\r\n\r\n// Cloud: Snap! API\r\n\r\nCloud.prototype.signup = function (\r\n    username,\r\n    email,\r\n    callBack,\r\n    errorCall\r\n) {\r\n    // both callBack and errorCall are two-argument functions\r\n    var request = new XMLHttpRequest(),\r\n        myself = this;\r\n    try {\r\n        request.open(\r\n            \"GET\",\r\n            (this.hasProtocol() ? '' : 'http://')\r\n                + this.url + 'SignUp'\r\n                + '?Username='\r\n                + encodeURIComponent(username)\r\n                + '&Email='\r\n                + encodeURIComponent(email),\r\n            true\r\n        );\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/x-www-form-urlencoded\"\r\n        );\r\n        request.withCredentials = true;\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    if (request.responseText.indexOf('ERROR') === 0) {\r\n                        errorCall.call(\r\n                            this,\r\n                            request.responseText,\r\n                            'Signup'\r\n                        );\r\n                    } else {\r\n                        callBack.call(\r\n                            null,\r\n                            request.responseText,\r\n                            'Signup'\r\n                        );\r\n                    }\r\n                } else {\r\n                    errorCall.call(\r\n                        null,\r\n                        myself.url + 'SignUp',\r\n                        localize('could not connect to:')\r\n                    );\r\n                }\r\n            }\r\n        };\r\n        request.send(null);\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), 'Snap!Cloud');\r\n    }\r\n};\r\n\r\nCloud.prototype.getPublicProject = function (\r\n    id,\r\n    callBack,\r\n    errorCall\r\n) {\r\n    // id is Username=username&projectName=projectname,\r\n    // where the values are url-component encoded\r\n    // callBack is a single argument function, errorCall take two args\r\n    var request = new XMLHttpRequest(),\r\n        myself = this;\r\n    try {\r\n        request.open(\r\n            \"GET\",\r\n            (this.hasProtocol() ? '' : 'http://')\r\n                + this.url + 'RawPublic'\r\n                + '?'\r\n                + id,\r\n            true\r\n        );\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/x-www-form-urlencoded\"\r\n        );\r\n        request.withCredentials = true;\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    if (request.responseText.indexOf('ERROR') === 0) {\r\n                        errorCall.call(\r\n                            this,\r\n                            request.responseText\r\n                        );\r\n                    } else {\r\n                        callBack.call(\r\n                            null,\r\n                            request.responseText\r\n                        );\r\n                    }\r\n                } else {\r\n                    errorCall.call(\r\n                        null,\r\n                        myself.url + 'Public',\r\n                        localize('could not connect to:')\r\n                    );\r\n                }\r\n            }\r\n        };\r\n        request.send(null);\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), 'Snap!Cloud');\r\n    }\r\n};\r\n\r\nCloud.prototype.resetPassword = function (\r\n    username,\r\n    callBack,\r\n    errorCall\r\n) {\r\n    // both callBack and errorCall are two-argument functions\r\n    var request = new XMLHttpRequest(),\r\n        myself = this;\r\n    try {\r\n        request.open(\r\n            \"GET\",\r\n            (this.hasProtocol() ? '' : 'http://')\r\n                + this.url + 'ResetPW'\r\n                + '?Username='\r\n                + encodeURIComponent(username),\r\n            true\r\n        );\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/x-www-form-urlencoded\"\r\n        );\r\n        request.withCredentials = true;\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    if (request.responseText.indexOf('ERROR') === 0) {\r\n                        errorCall.call(\r\n                            this,\r\n                            request.responseText,\r\n                            'Reset Password'\r\n                        );\r\n                    } else {\r\n                        callBack.call(\r\n                            null,\r\n                            request.responseText,\r\n                            'Reset Password'\r\n                        );\r\n                    }\r\n                } else {\r\n                    errorCall.call(\r\n                        null,\r\n                        myself.url + 'ResetPW',\r\n                        localize('could not connect to:')\r\n                    );\r\n                }\r\n            }\r\n        };\r\n        request.send(null);\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), 'Snap!Cloud');\r\n    }\r\n};\r\n\r\nCloud.prototype.login = function (\r\n    username,\r\n    password,\r\n    callBack,\r\n    errorCall\r\n) {\r\n    // both callBack and errorCall are two-argument functions\r\n    var request = new XMLHttpRequest(),\r\n        usr = JSON.stringify({'__h': password, '__u': username}),\r\n        myself = this;\r\n    this.setRoute(username);\r\n    try {\r\n        request.open(\r\n            \"POST\",\r\n            (this.hasProtocol() ? '' : 'http://') +\r\n                this.url +\r\n                '?SESSIONGLUE=' +\r\n                this.route,\r\n            true\r\n        );\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/json; charset=utf-8\"\r\n        );\r\n        // glue this session to a route:\r\n        request.setRequestHeader('SESSIONGLUE', this.route);\r\n        request.withCredentials = true;\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    myself.api = myself.parseAPI(request.responseText);\r\n                    myself.session = request.getResponseHeader('MioCracker')\r\n                        .split(';')[0];\r\n                    // set the cookie identifier:\r\n                    myself.limo = this.getResponseHeader(\"miocracker\")\r\n                        .substring(\r\n                            9,\r\n                            this.getResponseHeader(\"miocracker\").indexOf(\"=\")\r\n                        );\r\n                    if (myself.api.logout) {\r\n                        myself.username = username;\r\n                        myself.password = password;\r\n                        callBack.call(null, myself.api, 'Snap!Cloud');\r\n                    } else {\r\n                        errorCall.call(\r\n                            null,\r\n                            request.responseText,\r\n                            'connection failed'\r\n                        );\r\n                    }\r\n                } else {\r\n                    errorCall.call(\r\n                        null,\r\n                        myself.url,\r\n                        localize('could not connect to:')\r\n                    );\r\n                }\r\n            }\r\n        };\r\n        request.send(usr);\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), 'Snap!Cloud');\r\n    }\r\n};\r\n\r\nCloud.prototype.reconnect = function (\r\n    callBack,\r\n    errorCall\r\n) {\r\n    if (!(this.username && this.password)) {\r\n        this.message('You are not logged in');\r\n        return;\r\n    }\r\n    this.login(\r\n        this.username,\r\n        this.password,\r\n        callBack,\r\n        errorCall\r\n    );\r\n};\r\n\r\nCloud.prototype.saveProject = function (ide, callBack, errorCall) {\r\n    var myself = this,\r\n        pdata,\r\n        media,\r\n        size,\r\n        mediaSize;\r\n\r\n    ide.serializer.isCollectingMedia = true;\r\n    pdata = ide.serializer.serialize(ide.stage);\r\n    media = ide.hasChangedMedia ?\r\n            ide.serializer.mediaXML(ide.projectName) : null;\r\n    ide.serializer.isCollectingMedia = false;\r\n    ide.serializer.flushMedia();\r\n\r\n    mediaSize = media ? media.length : 0;\r\n    size = pdata.length + mediaSize;\r\n    if (mediaSize > 10485760) {\r\n        new DialogBoxMorph().inform(\r\n            'Snap!Cloud - Cannot Save Project',\r\n            'The media inside this project exceeds 10 MB.\\n' +\r\n                'Please reduce the size of costumes or sounds.\\n',\r\n            ide.world(),\r\n            ide.cloudIcon(null, new Color(180, 0, 0))\r\n        );\r\n        throw new Error('Project media exceeds 10 MB size limit');\r\n    }\r\n\r\n    // check if serialized data can be parsed back again\r\n    try {\r\n        ide.serializer.parse(pdata);\r\n    } catch (err) {\r\n        ide.showMessage('Serialization of program data failed:\\n' + err);\r\n        throw new Error('Serialization of program data failed:\\n' + err);\r\n    }\r\n    if (media !== null) {\r\n        try {\r\n            ide.serializer.parse(media);\r\n        } catch (err) {\r\n            ide.showMessage('Serialization of media failed:\\n' + err);\r\n            throw new Error('Serialization of media failed:\\n' + err);\r\n        }\r\n    }\r\n    ide.serializer.isCollectingMedia = false;\r\n    ide.serializer.flushMedia();\r\n\r\n    ide.showMessage('Uploading ' + Math.round(size / 1024) + ' KB...');\r\n    myself.reconnect(\r\n        function () {\r\n            myself.callService(\r\n                'saveProject',\r\n                function (response, url) {\r\n                    callBack.call(null, response, url);\r\n                    myself.disconnect();\r\n                    ide.hasChangedMedia = false;\r\n                },\r\n                errorCall,\r\n                [\r\n                    ide.projectName,\r\n                    pdata,\r\n                    media,\r\n                    pdata.length,\r\n                    media ? media.length : 0\r\n                ]\r\n            );\r\n        },\r\n        errorCall\r\n    );\r\n};\r\n\r\nCloud.prototype.getProjectList = function (callBack, errorCall) {\r\n    var myself = this;\r\n    this.reconnect(\r\n        function () {\r\n            myself.callService(\r\n                'getProjectList',\r\n                function (response, url) {\r\n                    callBack.call(null, response, url);\r\n                    myself.disconnect();\r\n                },\r\n                errorCall\r\n            );\r\n        },\r\n        errorCall\r\n    );\r\n};\r\n\r\nCloud.prototype.changePassword = function (\r\n    oldPW,\r\n    newPW,\r\n    callBack,\r\n    errorCall\r\n) {\r\n    var myself = this;\r\n    this.reconnect(\r\n        function () {\r\n            myself.callService(\r\n                'changePassword',\r\n                function (response, url) {\r\n                    callBack.call(null, response, url);\r\n                    myself.disconnect();\r\n                },\r\n                errorCall,\r\n                [hex_sha512(oldPW), hex_sha512(newPW)]\r\n            );\r\n        },\r\n        errorCall\r\n    );\r\n};\r\n\r\nCloud.prototype.logout = function (callBack, errorCall) {\r\n    this.clear();\r\n    this.callService(\r\n        'logout',\r\n        callBack,\r\n        errorCall\r\n    );\r\n};\r\n\r\nCloud.prototype.disconnect = function () {\r\n    this.callService(\r\n        'logout',\r\n        nop,\r\n        nop\r\n    );\r\n};\r\n\r\n// Cloud: backend communication\r\n\r\nCloud.prototype.callURL = function (url, callBack, errorCall) {\r\n    // both callBack and errorCall are optional two-argument functions\r\n    var request = new XMLHttpRequest(),\r\n        stickyUrl,\r\n        myself = this;\r\n    try {\r\n        // set the Limo. Also set the glue as a query paramter for backup.\r\n        stickyUrl = url +\r\n            '&SESSIONGLUE=' +\r\n            this.route +\r\n            '&_Limo=' +\r\n            this.limo;\r\n        request.open('GET', stickyUrl, true);\r\n        request.withCredentials = true;\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/x-www-form-urlencoded\"\r\n        );\r\n        request.setRequestHeader('MioCracker', this.session);\r\n        // Set the glue as a request header.\r\n        request.setRequestHeader('SESSIONGLUE', this.route);\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                if (request.responseText) {\r\n                    var responseList = myself.parseResponse(\r\n                        request.responseText\r\n                    );\r\n                    callBack.call(null, responseList, url);\r\n                } else {\r\n                    errorCall.call(\r\n                        null,\r\n                        url,\r\n                        'no response from:'\r\n                    );\r\n                }\r\n            }\r\n        };\r\n        request.send(null);\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), url);\r\n    }\r\n};\r\n\r\nCloud.prototype.callService = function (\r\n    serviceName,\r\n    callBack,\r\n    errorCall,\r\n    args\r\n) {\r\n    // both callBack and errorCall are optional two-argument functions\r\n    var request = new XMLHttpRequest(),\r\n        service = this.api[serviceName],\r\n        myself = this,\r\n        stickyUrl,\r\n        postDict;\r\n\r\n    if (!this.session) {\r\n        errorCall.call(null, 'You are not connected', 'Cloud');\r\n        return;\r\n    }\r\n    if (!service) {\r\n        errorCall.call(\r\n            null,\r\n            'service ' + serviceName + ' is not available',\r\n            'API'\r\n        );\r\n        return;\r\n    }\r\n    if (args && args.length > 0) {\r\n        postDict = {};\r\n        service.parameters.forEach(function (parm, idx) {\r\n            postDict[parm] = args[idx];\r\n        });\r\n    }\r\n    try {\r\n        stickyUrl = this.url +\r\n            '/' +\r\n            service.url +\r\n            '&SESSIONGLUE=' +\r\n            this.route +\r\n            '&_Limo=' +\r\n            this.limo;\r\n        request.open(service.method, stickyUrl, true);\r\n        request.withCredentials = true;\r\n        request.setRequestHeader(\r\n            \"Content-Type\",\r\n            \"application/x-www-form-urlencoded\"\r\n        );\r\n        request.setRequestHeader('MioCracker', this.session);\r\n        request.setRequestHeader('SESSIONGLUE', this.route);\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                var responseList = [];\r\n                if (request.responseText &&\r\n                        request.responseText.indexOf('ERROR') === 0) {\r\n                    errorCall.call(\r\n                        this,\r\n                        request.responseText,\r\n                        localize('Service:') + ' ' + localize(serviceName)\r\n                    );\r\n                    return;\r\n                }\r\n                if (serviceName === 'login') {\r\n                    myself.api = myself.parseAPI(request.responseText);\r\n                }\r\n                if (serviceName === 'getRawProject') {\r\n                    responseList = request.responseText;\r\n                } else {\r\n                    responseList = myself.parseResponse(\r\n                        request.responseText\r\n                    );\r\n                }\r\n                callBack.call(null, responseList, service.url);\r\n            }\r\n        };\r\n        request.send(this.encodeDict(postDict));\r\n    } catch (err) {\r\n        errorCall.call(this, err.toString(), service.url);\r\n    }\r\n};\r\n\r\n// Cloud: payload transformation\r\n\r\nCloud.prototype.parseAPI = function (src) {\r\n    var api = {},\r\n        services;\r\n    services = src.split(\" \");\r\n    services.forEach(function (service) {\r\n        var entries = service.split(\"&\"),\r\n            serviceDescription = {},\r\n            parms;\r\n        entries.forEach(function (entry) {\r\n            var pair = entry.split(\"=\"),\r\n                key = decodeURIComponent(pair[0]).toLowerCase(),\r\n                val = decodeURIComponent(pair[1]);\r\n            if (key === \"service\") {\r\n                api[val] = serviceDescription;\r\n            } else if (key === \"parameters\") {\r\n                parms = val.split(\",\");\r\n                if (!(parms.length === 1 && !parms[0])) {\r\n                    serviceDescription.parameters = parms;\r\n                }\r\n            } else {\r\n                serviceDescription[key] = val;\r\n            }\r\n        });\r\n    });\r\n    return api;\r\n};\r\n\r\nCloud.prototype.parseResponse = function (src) {\r\n    var ans = [],\r\n        lines;\r\n    if (!src) {return ans; }\r\n    lines = src.split(\" \");\r\n    lines.forEach(function (service) {\r\n        var entries = service.split(\"&\"),\r\n            dict = {};\r\n        entries.forEach(function (entry) {\r\n            var pair = entry.split(\"=\"),\r\n                key = decodeURIComponent(pair[0]),\r\n                val = decodeURIComponent(pair[1]);\r\n            dict[key] = val;\r\n        });\r\n        ans.push(dict);\r\n    });\r\n    return ans;\r\n};\r\n\r\nCloud.prototype.parseDict = function (src) {\r\n    var dict = {};\r\n    if (!src) {return dict; }\r\n    src.split(\"&\").forEach(function (entry) {\r\n        var pair = entry.split(\"=\"),\r\n            key = decodeURIComponent(pair[0]),\r\n            val = decodeURIComponent(pair[1]);\r\n        dict[key] = val;\r\n    });\r\n    return dict;\r\n};\r\n\r\nCloud.prototype.encodeDict = function (dict) {\r\n    var str = '',\r\n        pair,\r\n        key;\r\n    if (!dict) {return null; }\r\n    for (key in dict) {\r\n        if (dict.hasOwnProperty(key)) {\r\n            pair = encodeURIComponent(key)\r\n                + '='\r\n                + encodeURIComponent(dict[key]);\r\n            if (str.length > 0) {\r\n                str += '&';\r\n            }\r\n            str += pair;\r\n        }\r\n    }\r\n    return str;\r\n};\r\n\r\n// Cloud: user messages (to be overridden)\r\n\r\nCloud.prototype.message = function (string) {\r\n    alert(string);\r\n};\r\n//fin de cloud.js\r\n/*\r\n\r\n\tsha512.js\r\n\r\n\tencryption for SNAP!\r\n    This file is derived from crypto-js.\r\n\r\n     20092012 by Jeff Mott. All rights reserved.\r\n\r\n    Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\r\n\r\n    Redistributions of source code must retain the above copyright notice, this list of conditions, and the following disclaimer.\r\n    Redistributions in binary form must reproduce the above copyright notice, this list of conditions, and the following disclaimer in the documentation or other materials provided with the distribution.\r\n    Neither the name CryptoJS nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\r\n    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS,\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n\r\n*/\r\n\r\nvar hex_sha512 = (function (hex_sha512) {\r\n\r\n    var hexcase = 0;\r\n\r\n    function hex_sha512(s)\r\n    {\r\n      return CryptoJS.SHA512(str2rstr_utf8(s)).toString(CryptoJS.enc.Hex);\r\n    }\r\n\r\n    function rstr_sha512(s)\r\n    {\r\n      return binb2rstr(binb_sha512(rstr2binb(s), s.length * 8));\r\n    }\r\n\r\n    var CryptoJS=CryptoJS||function(a,g){var m={},e=m.lib={},q=e.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var d=new a;b&&d.mixIn(b);d.$super=this;return d},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var k in a)a.hasOwnProperty(k)&&(this[k]=a[k]);a.hasOwnProperty(\"toString\")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),r=e.WordArray=q.extend({init:function(a,b){a=\r\n    this.words=a||[];this.sigBytes=b!=g?b:4*a.length},toString:function(a){return(a||n).stringify(this)},concat:function(a){var b=this.words,d=a.words,c=this.sigBytes,a=a.sigBytes;this.clamp();if(c%4)for(var i=0;i<a;i++)b[c+i>>>2]|=(d[i>>>2]>>>24-8*(i%4)&255)<<24-8*((c+i)%4);else if(65535<d.length)for(i=0;i<a;i+=4)b[c+i>>>2]=d[i>>>2];else b.push.apply(b,d);this.sigBytes+=a;return this},clamp:function(){var k=this.words,b=this.sigBytes;k[b>>>2]&=4294967295<<32-8*(b%4);k.length=a.ceil(b/4)},clone:function(){var a=\r\n    q.clone.call(this);a.words=this.words.slice(0);return a},random:function(k){for(var b=[],d=0;d<k;d+=4)b.push(4294967296*a.random()|0);return r.create(b,k)}}),y=m.enc={},n=y.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,d=[],c=0;c<a;c++){var i=b[c>>>2]>>>24-8*(c%4)&255;d.push((i>>>4).toString(16));d.push((i&15).toString(16))}return d.join(\"\")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c+=2)d[c>>>3]|=parseInt(a.substr(c,2),16)<<24-4*(c%8);return r.create(d,b/2)}},l=y.Latin1={stringify:function(a){for(var b=\r\n    a.words,a=a.sigBytes,d=[],c=0;c<a;c++)d.push(String.fromCharCode(b[c>>>2]>>>24-8*(c%4)&255));return d.join(\"\")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c++)d[c>>>2]|=(a.charCodeAt(c)&255)<<24-8*(c%4);return r.create(d,b)}},da=y.Utf8={stringify:function(a){try{return decodeURIComponent(escape(l.stringify(a)))}catch(b){throw Error(\"Malformed UTF-8 data\");}},parse:function(a){return l.parse(unescape(encodeURIComponent(a)))}},h=e.BufferedBlockAlgorithm=q.extend({reset:function(){this._data=\r\n    r.create();this._nDataBytes=0},_append:function(a){\"string\"==typeof a&&(a=da.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(k){var b=this._data,d=b.words,c=b.sigBytes,i=this.blockSize,l=c/(4*i),l=k?a.ceil(l):a.max((l|0)-this._minBufferSize,0),k=l*i,c=a.min(4*k,c);if(k){for(var h=0;h<k;h+=i)this._doProcessBlock(d,h);h=d.splice(0,k);b.sigBytes-=c}return r.create(h,c)},clone:function(){var a=q.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});e.Hasher=\r\n    h.extend({init:function(){this.reset()},reset:function(){h.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);this._doFinalize();return this._hash},clone:function(){var a=h.clone.call(this);a._hash=this._hash.clone();return a},blockSize:16,_createHelper:function(a){return function(b,d){return a.create(d).finalize(b)}},_createHmacHelper:function(a){return function(b,d){return ea.HMAC.create(a,d).finalize(b)}}});\r\n    var ea=m.algo={};return m}(Math);\r\n    (function(a){var g=CryptoJS,m=g.lib,e=m.Base,q=m.WordArray,g=g.x64={};g.Word=e.extend({init:function(a,e){this.high=a;this.low=e}});g.WordArray=e.extend({init:function(e,y){e=this.words=e||[];this.sigBytes=y!=a?y:8*e.length},toX32:function(){for(var a=this.words,e=a.length,n=[],l=0;l<e;l++){var g=a[l];n.push(g.high);n.push(g.low)}return q.create(n,this.sigBytes)},clone:function(){for(var a=e.clone.call(this),g=a.words=this.words.slice(0),n=g.length,l=0;l<n;l++)g[l]=g[l].clone();return a}})})();\r\n    (function(){function a(){return q.create.apply(q,arguments)}var g=CryptoJS,m=g.lib.Hasher,e=g.x64,q=e.Word,r=e.WordArray,e=g.algo,y=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),\r\n    a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,\r\n    2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),\r\n    a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,\r\n    3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],n=[];(function(){for(var l=0;80>l;l++)n[l]=a()})();e=e.SHA512=m.extend({_doReset:function(){this._hash=r.create([a(1779033703,4089235720),a(3144134277,2227873595),a(1013904242,4271175723),a(2773480762,1595750129),a(1359893119,2917565137),a(2600822924,725511199),a(528734635,4215389547),a(1541459225,327033209)])},_doProcessBlock:function(a,e){for(var h=this._hash.words,g=h[0],k=h[1],b=h[2],d=h[3],c=h[4],i=h[5],m=\r\n    h[6],h=h[7],q=g.high,r=g.low,W=k.high,K=k.low,X=b.high,L=b.low,Y=d.high,M=d.low,Z=c.high,N=c.low,$=i.high,O=i.low,aa=m.high,P=m.low,ba=h.high,Q=h.low,t=q,o=r,E=W,C=K,F=X,D=L,T=Y,G=M,u=Z,p=N,R=$,H=O,S=aa,I=P,U=ba,J=Q,v=0;80>v;v++){var z=n[v];if(16>v)var s=z.high=a[e+2*v]|0,f=z.low=a[e+2*v+1]|0;else{var s=n[v-15],f=s.high,w=s.low,s=(w<<31|f>>>1)^(w<<24|f>>>8)^f>>>7,w=(f<<31|w>>>1)^(f<<24|w>>>8)^(f<<25|w>>>7),B=n[v-2],f=B.high,j=B.low,B=(j<<13|f>>>19)^(f<<3|j>>>29)^f>>>6,j=(f<<13|j>>>19)^(j<<3|f>>>29)^\r\n    (f<<26|j>>>6),f=n[v-7],V=f.high,A=n[v-16],x=A.high,A=A.low,f=w+f.low,s=s+V+(f>>>0<w>>>0?1:0),f=f+j,s=s+B+(f>>>0<j>>>0?1:0),f=f+A,s=s+x+(f>>>0<A>>>0?1:0);z.high=s;z.low=f}var V=u&R^~u&S,A=p&H^~p&I,z=t&E^t&F^E&F,fa=o&C^o&D^C&D,w=(o<<4|t>>>28)^(t<<30|o>>>2)^(t<<25|o>>>7),B=(t<<4|o>>>28)^(o<<30|t>>>2)^(o<<25|t>>>7),j=y[v],ga=j.high,ca=j.low,j=J+((u<<18|p>>>14)^(u<<14|p>>>18)^(p<<23|u>>>9)),x=U+((p<<18|u>>>14)^(p<<14|u>>>18)^(u<<23|p>>>9))+(j>>>0<J>>>0?1:0),j=j+A,x=x+V+(j>>>0<A>>>0?1:0),j=j+ca,x=x+ga+\r\n    (j>>>0<ca>>>0?1:0),j=j+f,x=x+s+(j>>>0<f>>>0?1:0),f=B+fa,z=w+z+(f>>>0<B>>>0?1:0),U=S,J=I,S=R,I=H,R=u,H=p,p=G+j|0,u=T+x+(p>>>0<G>>>0?1:0)|0,T=F,G=D,F=E,D=C,E=t,C=o,o=j+f|0,t=x+z+(o>>>0<j>>>0?1:0)|0}r=g.low=r+o|0;g.high=q+t+(r>>>0<o>>>0?1:0)|0;K=k.low=K+C|0;k.high=W+E+(K>>>0<C>>>0?1:0)|0;L=b.low=L+D|0;b.high=X+F+(L>>>0<D>>>0?1:0)|0;M=d.low=M+G|0;d.high=Y+T+(M>>>0<G>>>0?1:0)|0;N=c.low=N+p|0;c.high=Z+u+(N>>>0<p>>>0?1:0)|0;O=i.low=O+H|0;i.high=$+R+(O>>>0<H>>>0?1:0)|0;P=m.low=P+I|0;m.high=aa+S+(P>>>0<I>>>\r\n    0?1:0)|0;Q=h.low=Q+J|0;h.high=ba+U+(Q>>>0<J>>>0?1:0)|0},_doFinalize:function(){var a=this._data,e=a.words,h=8*this._nDataBytes,g=8*a.sigBytes;e[g>>>5]|=128<<24-g%32;e[(g+128>>>10<<5)+31]=h;a.sigBytes=4*e.length;this._process();this._hash=this._hash.toX32()},blockSize:32});g.SHA512=m._createHelper(e);g.HmacSHA512=m._createHmacHelper(e)})();\r\n\r\n    function rstr2hex(input)\r\n    {\r\n      try { hexcase } catch(e) { hexcase=0; }\r\n      var hex_tab = hexcase ? \"0123456789ABCDEF\" : \"0123456789abcdef\";\r\n      var output = \"\";\r\n      var x;\r\n      for(var i = 0; i < input.length; i++)\r\n      {\r\n        x = input.charCodeAt(i);\r\n        output += hex_tab.charAt((x >>> 4) & 0x0F)\r\n               +  hex_tab.charAt( x        & 0x0F);\r\n      }\r\n      return output;\r\n    }\r\n\r\n    function str2rstr_utf8(input)\r\n    {\r\n      var output = \"\";\r\n      var i = -1;\r\n      var x, y;\r\n\r\n      while(++i < input.length)\r\n      {\r\n        x = input.charCodeAt(i);\r\n        y = i + 1 < input.length ? input.charCodeAt(i + 1) : 0;\r\n        if(0xD800 <= x && x <= 0xDBFF && 0xDC00 <= y && y <= 0xDFFF)\r\n        {\r\n          x = 0x10000 + ((x & 0x03FF) << 10) + (y & 0x03FF);\r\n          i++;\r\n        }\r\n\r\n        if(x <= 0x7F)\r\n          output += String.fromCharCode(x);\r\n        else if(x <= 0x7FF)\r\n          output += String.fromCharCode(0xC0 | ((x >>> 6 ) & 0x1F),\r\n                                        0x80 | ( x         & 0x3F));\r\n        else if(x <= 0xFFFF)\r\n          output += String.fromCharCode(0xE0 | ((x >>> 12) & 0x0F),\r\n                                        0x80 | ((x >>> 6 ) & 0x3F),\r\n                                        0x80 | ( x         & 0x3F));\r\n        else if(x <= 0x1FFFFF)\r\n          output += String.fromCharCode(0xF0 | ((x >>> 18) & 0x07),\r\n                                        0x80 | ((x >>> 12) & 0x3F),\r\n                                        0x80 | ((x >>> 6 ) & 0x3F),\r\n                                        0x80 | ( x         & 0x3F));\r\n      }\r\n      return output;\r\n    }\r\n\r\n    function rstr2binb(input)\r\n    {\r\n      var output = Array(input.length >> 2);\r\n      for(var i = 0; i < output.length; i++)\r\n        output[i] = 0;\r\n      for(var i = 0; i < input.length * 8; i += 8)\r\n        output[i>>5] |= (input.charCodeAt(i / 8) & 0xFF) << (24 - i % 32);\r\n      return output;\r\n    }\r\n\r\n    function binb2rstr(input)\r\n    {\r\n      var output = \"\";\r\n      for(var i = 0; i < input.length * 32; i += 8)\r\n        output += String.fromCharCode((input[i>>5] >>> (24 - i % 32)) & 0xFF);\r\n      return output;\r\n    }\r\n\r\n    var sha512_k;\r\n    function binb_sha512(x, len)\r\n    {\r\n      if(sha512_k == undefined)\r\n      {\r\n        sha512_k = new Array(\r\n    new int64(0x428a2f98, -685199838), new int64(0x71374491, 0x23ef65cd),\r\n    new int64(-1245643825, -330482897), new int64(-373957723, -2121671748),\r\n    new int64(0x3956c25b, -213338824), new int64(0x59f111f1, -1241133031),\r\n    new int64(-1841331548, -1357295717), new int64(-1424204075, -630357736),\r\n    new int64(-670586216, -1560083902), new int64(0x12835b01, 0x45706fbe),\r\n    new int64(0x243185be, 0x4ee4b28c), new int64(0x550c7dc3, -704662302),\r\n    new int64(0x72be5d74, -226784913), new int64(-2132889090, 0x3b1696b1),\r\n    new int64(-1680079193, 0x25c71235), new int64(-1046744716, -815192428),\r\n    new int64(-459576895, -1628353838), new int64(-272742522, 0x384f25e3),\r\n    new int64(0xfc19dc6, -1953704523), new int64(0x240ca1cc, 0x77ac9c65),\r\n    new int64(0x2de92c6f, 0x592b0275), new int64(0x4a7484aa, 0x6ea6e483),\r\n    new int64(0x5cb0a9dc, -1119749164), new int64(0x76f988da, -2096016459),\r\n    new int64(-1740746414, -295247957), new int64(-1473132947, 0x2db43210),\r\n    new int64(-1341970488, -1728372417), new int64(-1084653625, -1091629340),\r\n    new int64(-958395405, 0x3da88fc2), new int64(-710438585, -1828018395),\r\n    new int64(0x6ca6351, -536640913), new int64(0x14292967, 0xa0e6e70),\r\n    new int64(0x27b70a85, 0x46d22ffc), new int64(0x2e1b2138, 0x5c26c926),\r\n    new int64(0x4d2c6dfc, 0x5ac42aed), new int64(0x53380d13, -1651133473),\r\n    new int64(0x650a7354, -1951439906), new int64(0x766a0abb, 0x3c77b2a8),\r\n    new int64(-2117940946, 0x47edaee6), new int64(-1838011259, 0x1482353b),\r\n    new int64(-1564481375, 0x4cf10364), new int64(-1474664885, -1136513023),\r\n    new int64(-1035236496, -789014639), new int64(-949202525, 0x654be30),\r\n    new int64(-778901479, -688958952), new int64(-694614492, 0x5565a910),\r\n    new int64(-200395387, 0x5771202a), new int64(0x106aa070, 0x32bbd1b8),\r\n    new int64(0x19a4c116, -1194143544), new int64(0x1e376c08, 0x5141ab53),\r\n    new int64(0x2748774c, -544281703), new int64(0x34b0bcb5, -509917016),\r\n    new int64(0x391c0cb3, -976659869), new int64(0x4ed8aa4a, -482243893),\r\n    new int64(0x5b9cca4f, 0x7763e373), new int64(0x682e6ff3, -692930397),\r\n    new int64(0x748f82ee, 0x5defb2fc), new int64(0x78a5636f, 0x43172f60),\r\n    new int64(-2067236844, -1578062990), new int64(-1933114872, 0x1a6439ec),\r\n    new int64(-1866530822, 0x23631e28), new int64(-1538233109, -561857047),\r\n    new int64(-1090935817, -1295615723), new int64(-965641998, -479046869),\r\n    new int64(-903397682, -366583396), new int64(-779700025, 0x21c0c207),\r\n    new int64(-354779690, -840897762), new int64(-176337025, -294727304),\r\n    new int64(0x6f067aa, 0x72176fba), new int64(0xa637dc5, -1563912026),\r\n    new int64(0x113f9804, -1090974290), new int64(0x1b710b35, 0x131c471b),\r\n    new int64(0x28db77f5, 0x23047d84), new int64(0x32caab7b, 0x40c72493),\r\n    new int64(0x3c9ebe0a, 0x15c9bebc), new int64(0x431d67c4, -1676669620),\r\n    new int64(0x4cc5d4be, -885112138), new int64(0x597f299c, -60457430),\r\n    new int64(0x5fcb6fab, 0x3ad6faec), new int64(0x6c44198c, 0x4a475817));\r\n      }\r\n\r\n      var H = new Array(\r\n    new int64(0x6a09e667, -205731576),\r\n    new int64(-1150833019, -2067093701),\r\n    new int64(0x3c6ef372, -23791573),\r\n    new int64(-1521486534, 0x5f1d36f1),\r\n    new int64(0x510e527f, -1377402159),\r\n    new int64(-1694144372, 0x2b3e6c1f),\r\n    new int64(0x1f83d9ab, -79577749),\r\n    new int64(0x5be0cd19, 0x137e2179));\r\n\r\n      var T1 = new int64(0, 0),\r\n        T2 = new int64(0, 0),\r\n        a = new int64(0,0),\r\n        b = new int64(0,0),\r\n        c = new int64(0,0),\r\n        d = new int64(0,0),\r\n        e = new int64(0,0),\r\n        f = new int64(0,0),\r\n        g = new int64(0,0),\r\n        h = new int64(0,0),\r\n\r\n        s0 = new int64(0, 0),\r\n        s1 = new int64(0, 0),\r\n        Ch = new int64(0, 0),\r\n        Maj = new int64(0, 0),\r\n        r1 = new int64(0, 0),\r\n        r2 = new int64(0, 0),\r\n        r3 = new int64(0, 0);\r\n      var j, i;\r\n      var W = new Array(80);\r\n      for(i=0; i<80; i++)\r\n        W[i] = new int64(0, 0);\r\n\r\n      x[len >> 5] |= 0x80 << (24 - (len & 0x1f));\r\n      x[((len + 128 >> 10)<< 5) + 31] = len;\r\n\r\n      for(i = 0; i<x.length; i+=32)\r\n      {\r\n        int64copy(a, H[0]);\r\n        int64copy(b, H[1]);\r\n        int64copy(c, H[2]);\r\n        int64copy(d, H[3]);\r\n        int64copy(e, H[4]);\r\n        int64copy(f, H[5]);\r\n        int64copy(g, H[6]);\r\n        int64copy(h, H[7]);\r\n\r\n        for(j=0; j<16; j++)\r\n        {\r\n            W[j].h = x[i + 2*j];\r\n            W[j].l = x[i + 2*j + 1];\r\n        }\r\n\r\n        for(j=16; j<80; j++)\r\n        {\r\n          int64rrot(r1, W[j-2], 19);\r\n          int64revrrot(r2, W[j-2], 29);\r\n          int64shr(r3, W[j-2], 6);\r\n          s1.l = r1.l ^ r2.l ^ r3.l;\r\n          s1.h = r1.h ^ r2.h ^ r3.h;\r\n          int64rrot(r1, W[j-15], 1);\r\n          int64rrot(r2, W[j-15], 8);\r\n          int64shr(r3, W[j-15], 7);\r\n          s0.l = r1.l ^ r2.l ^ r3.l;\r\n          s0.h = r1.h ^ r2.h ^ r3.h;\r\n\r\n          int64add4(W[j], s1, W[j-7], s0, W[j-16]);\r\n        }\r\n\r\n        for(j = 0; j < 80; j++)\r\n        {\r\n          Ch.l = (e.l & f.l) ^ (~e.l & g.l);\r\n          Ch.h = (e.h & f.h) ^ (~e.h & g.h);\r\n\r\n          int64rrot(r1, e, 14);\r\n          int64rrot(r2, e, 18);\r\n          int64revrrot(r3, e, 9);\r\n          s1.l = r1.l ^ r2.l ^ r3.l;\r\n          s1.h = r1.h ^ r2.h ^ r3.h;\r\n          int64rrot(r1, a, 28);\r\n          int64revrrot(r2, a, 2);\r\n          int64revrrot(r3, a, 7);\r\n          s0.l = r1.l ^ r2.l ^ r3.l;\r\n          s0.h = r1.h ^ r2.h ^ r3.h;\r\n\r\n          Maj.l = (a.l & b.l) ^ (a.l & c.l) ^ (b.l & c.l);\r\n          Maj.h = (a.h & b.h) ^ (a.h & c.h) ^ (b.h & c.h);\r\n\r\n          int64add5(T1, h, s1, Ch, sha512_k[j], W[j]);\r\n          int64add(T2, s0, Maj);\r\n\r\n          int64copy(h, g);\r\n          int64copy(g, f);\r\n          int64copy(f, e);\r\n          int64add(e, d, T1);\r\n          int64copy(d, c);\r\n          int64copy(c, b);\r\n          int64copy(b, a);\r\n          int64add(a, T1, T2);\r\n        }\r\n        int64add(H[0], H[0], a);\r\n        int64add(H[1], H[1], b);\r\n        int64add(H[2], H[2], c);\r\n        int64add(H[3], H[3], d);\r\n        int64add(H[4], H[4], e);\r\n        int64add(H[5], H[5], f);\r\n        int64add(H[6], H[6], g);\r\n        int64add(H[7], H[7], h);\r\n      }\r\n\r\n      var hash = new Array(16);\r\n      for(i=0; i<8; i++)\r\n      {\r\n        hash[2*i] = H[i].h;\r\n        hash[2*i + 1] = H[i].l;\r\n      }\r\n      return hash;\r\n    }\r\n\r\n    function int64(h, l)\r\n    {\r\n      this.h = h;\r\n      this.l = l;\r\n    }\r\n\r\n    function int64copy(dst, src)\r\n    {\r\n      dst.h = src.h;\r\n      dst.l = src.l;\r\n    }\r\n\r\n    function int64rrot(dst, x, shift)\r\n    {\r\n        dst.l = (x.l >>> shift) | (x.h << (32-shift));\r\n        dst.h = (x.h >>> shift) | (x.l << (32-shift));\r\n    }\r\n\r\n    function int64revrrot(dst, x, shift)\r\n    {\r\n        dst.l = (x.h >>> shift) | (x.l << (32-shift));\r\n        dst.h = (x.l >>> shift) | (x.h << (32-shift));\r\n    }\r\n\r\n    function int64shr(dst, x, shift)\r\n    {\r\n        dst.l = (x.l >>> shift) | (x.h << (32-shift));\r\n        dst.h = (x.h >>> shift);\r\n    }\r\n\r\n    function int64add(dst, x, y)\r\n    {\r\n       var w0 = (x.l & 0xffff) + (y.l & 0xffff);\r\n       var w1 = (x.l >>> 16) + (y.l >>> 16) + (w0 >>> 16);\r\n       var w2 = (x.h & 0xffff) + (y.h & 0xffff) + (w1 >>> 16);\r\n       var w3 = (x.h >>> 16) + (y.h >>> 16) + (w2 >>> 16);\r\n       dst.l = (w0 & 0xffff) | (w1 << 16);\r\n       dst.h = (w2 & 0xffff) | (w3 << 16);\r\n    }\r\n\r\n    function int64add4(dst, a, b, c, d)\r\n    {\r\n       var w0 = (a.l & 0xffff) + (b.l & 0xffff) + (c.l & 0xffff) + (d.l & 0xffff);\r\n       var w1 = (a.l >>> 16) + (b.l >>> 16) + (c.l >>> 16) + (d.l >>> 16) + (w0 >>> 16);\r\n       var w2 = (a.h & 0xffff) + (b.h & 0xffff) + (c.h & 0xffff) + (d.h & 0xffff) + (w1 >>> 16);\r\n       var w3 = (a.h >>> 16) + (b.h >>> 16) + (c.h >>> 16) + (d.h >>> 16) + (w2 >>> 16);\r\n       dst.l = (w0 & 0xffff) | (w1 << 16);\r\n       dst.h = (w2 & 0xffff) | (w3 << 16);\r\n    }\r\n\r\n    function int64add5(dst, a, b, c, d, e)\r\n    {\r\n       var w0 = (a.l & 0xffff) + (b.l & 0xffff) + (c.l & 0xffff) + (d.l & 0xffff) + (e.l & 0xffff);\r\n       var w1 = (a.l >>> 16) + (b.l >>> 16) + (c.l >>> 16) + (d.l >>> 16) + (e.l >>> 16) + (w0 >>> 16);\r\n       var w2 = (a.h & 0xffff) + (b.h & 0xffff) + (c.h & 0xffff) + (d.h & 0xffff) + (e.h & 0xffff) + (w1 >>> 16);\r\n       var w3 = (a.h >>> 16) + (b.h >>> 16) + (c.h >>> 16) + (d.h >>> 16) + (e.h >>> 16) + (w2 >>> 16);\r\n       dst.l = (w0 & 0xffff) | (w1 << 16);\r\n       dst.h = (w2 & 0xffff) | (w3 << 16);\r\n    }\r\n\r\n    return hex_sha512;\r\n\r\n})({});\r\n//End of sha512.js\r\n\r\n\r\n/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */\r\nvar saveAs=saveAs||function(e){\"use strict\";if(typeof e===\"undefined\"||typeof navigator!==\"undefined\"&&/MSIE [1-9]\\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS(\"http://www.w3.org/1999/xhtml\",\"a\"),o=\"download\"in r,a=function(e){var t=new MouseEvent(\"click\");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\\/[\\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s=\"application/octet-stream\",d=1e3*40,c=function(e){var t=function(){if(typeof e===\"string\"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e[\"on\"+t[r]];if(typeof o===\"function\"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\\s*(?:text\\/\\S*|application\\/xml|\\S*\\/\\S*\\+xml)\\s*;.*charset\\s*=\\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,\"writestart progress write writeend\".split(\" \"))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,\"data:attachment/file;\");var n=e.open(t,\"_blank\");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,\"_blank\");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||\"download\",n)};if(typeof navigator!==\"undefined\"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||\"download\";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!==\"undefined\"&&self||typeof window!==\"undefined\"&&window||this.content);if(typeof module!==\"undefined\"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!==\"undefined\"&&define!==null&&define.amd!==null){define(\"FileSaver.js\",[],function(){return saveAs})}\r\n\r\n// End of bundeling\r\n\r\n//********************Wiquid******************************************************\r\n\r\nsnapsrc.snap.tao = function(message){alert(message);};\r\n\r\n    disableRetinaSupport();// here modify OPTION RETINA \r\n    //world = new WorldMorph(document.getElementById('world')); // original syntax rejected because of id use.\r\n    var world; \r\n    var elementCanvas = $container.find('.world');\r\n   \r\n    world = new WorldMorph(elementCanvas[0]);\r\n    snapsrc.snap.world = world;\r\n    world.worldCanvas.focus();\r\n    new IDE_Morph().openIn(world);\r\n    world.panelLeft = panel_Left;\r\n    \r\n    world.xmlString = getSnapProjectScript;\r\n\r\n    world.leftReducer = function leftReducer() {    \r\n        panel_Left.setPaletteWidth(1); return 1; \r\n    };\r\n\r\n    world.leftExpand = function leftExpand() { panel_Left.setPaletteWidth(200); return 200; };\r\n\r\n    //Fix blurry text \r\n    $container.find(\".world\").css({ position : 'absolute'});\r\n    world.width = world.clientWidth;\r\n    world.height = world.clientHeight;\r\n\r\n    \r\n    if($container.find(\".world\")[1]){ $container.find($container.find(\".world\")[1].remove());}\r\n   \r\n    \r\n    world.importator = function importator() {\r\n        var myself = world.children[0];\r\n        var inp = document.createElement('input');\r\n        if (myself.filePicker) {\r\n            document.body.removeChild(myself.filePicker);\r\n            myself.filePicker = null;\r\n        }\r\n        inp.type = 'file';\r\n        inp.style.color = \"transparent\";\r\n        inp.style.backgroundColor = \"transparent\";\r\n        inp.style.border = \"none\";\r\n        inp.style.outline = \"none\";\r\n        inp.style.position = \"absolute\";\r\n        inp.style.top = \"0px\";\r\n        inp.style.left = \"0px\";\r\n        inp.style.width = \"0px\";\r\n        inp.style.height = \"0px\";\r\n        inp.style.display = \"none\";\r\n        inp.addEventListener(\"change\",function () {\r\n            document.body.removeChild(inp);\r\n            myself.filePicker = null;\r\n            world.hand.processDrop(inp.files);\r\n        },false);\r\n        document.body.appendChild(inp);\r\n        myself.filePicker = inp;\r\n        inp.click();\r\n    }\r\n \r\n    loop();\r\n\r\n    function loop() {\r\n        requestAnimationFrame(loop);\r\n        world.doOneCycle();  \r\n\r\n    }\r\n\r\n       \r\n\r\n\r\n return panel_Left;\r\n    }; //End of snapsrc.snap\r\n\r\n\r\nreturn snapsrc;\r\n//*************************End snapsrc - Wiquid solution ***************************    \r\n});\n",
    "/*\r\n\r\nBuild by Wiquid's PCI Generator for TAO platform Free to use - http://www.wiquid.fr/depp/ent/\r\nCopyright DEPP  2018 - Ministre de l'ducation nationale \r\n\r\n */\r\n\r\ndefine('SnapForTao/runtime/js/renderer',['taoQtiItem/portableLib/jquery_2_1_1', 'taoQtiItem/portableLib/OAT/util/html', 'SnapForTao/runtime/js/lib/snapsrc'], function($, html, snapsrc){\r\n    'use strict';\r\n\r\n function renderSnap(id, $container, config){\r\n   \r\n    var snapInstance;\r\n    $container.find(\".snapy\").html(\"\");\r\n    $container.find(\".snapyOverlay\").html(\"\");\r\n    $container.find(\".blockTracker\").html(\"\"); //Clean nbSpace\r\n    $container.find(\".compteur\").html(\"\");\r\n    $container.find(\".snapy\").append('<canvas class=\"world\" tabindex=\"1\" ><p>Your browser doesn\\'t support canvas.</p></canvas>');   \r\n    snapInstance = snapsrc.snap(id, $container, config);\r\n    \r\n    \r\n    // Left Panel Sizer \r\n    if(config.panelSizer == 'nonVisible'){ snapsrc.snap.world.leftReducer(); }\r\n    else{snapsrc.snap.world.leftExpand();}\r\n    $container.find(\".world\").css('position','relative'); \r\n } \r\n\r\n        return {\r\n        render : function(id, container, config, assetManager){\r\n\r\n            var $container = $(container);\r\n\r\n            renderSnap(id, $container, config);\r\n            \r\n            //render rich text content in prompt\r\n            html.render($container.find('.prompt'));\r\n        },\r\n        renderSnap : function(id, container, config){\r\n            renderSnap(id, $(container), config);\r\n        }\r\n\r\n    };\r\n});\r\n \r\n \n",
    "/**\n * @license\n * Lo-Dash 2.4.1 (Custom Build) lodash.com/license | Underscore.js 1.5.2 underscorejs.org/LICENSE\n * Build: `lodash -o ./dist/lodash.compat.js`\n */\n;(function(){function n(n,t,e){e=(e||0)-1;for(var r=n?n.length:0;++e<r;)if(n[e]===t)return e;return-1}function t(t,e){var r=typeof e;if(t=t.l,\"boolean\"==r||null==e)return t[e]?0:-1;\"number\"!=r&&\"string\"!=r&&(r=\"object\");var u=\"number\"==r?e:b+e;return t=(t=t[r])&&t[u],\"object\"==r?t&&-1<n(t,e)?0:-1:t?0:-1}function e(n){var t=this.l,e=typeof n;if(\"boolean\"==e||null==n)t[n]=true;else{\"number\"!=e&&\"string\"!=e&&(e=\"object\");var r=\"number\"==e?n:b+n,t=t[e]||(t[e]={});\"object\"==e?(t[r]||(t[r]=[])).push(n):t[r]=true\n}}function r(n){return n.charCodeAt(0)}function u(n,t){for(var e=n.m,r=t.m,u=-1,o=e.length;++u<o;){var a=e[u],i=r[u];if(a!==i){if(a>i||typeof a==\"undefined\")return 1;if(a<i||typeof i==\"undefined\")return-1}}return n.n-t.n}function o(n){var t=-1,r=n.length,u=n[0],o=n[r/2|0],a=n[r-1];if(u&&typeof u==\"object\"&&o&&typeof o==\"object\"&&a&&typeof a==\"object\")return false;for(u=l(),u[\"false\"]=u[\"null\"]=u[\"true\"]=u.undefined=false,o=l(),o.k=n,o.l=u,o.push=e;++t<r;)o.push(n[t]);return o}function a(n){return\"\\\\\"+Y[n]\n}function i(){return v.pop()||[]}function l(){return y.pop()||{k:null,l:null,m:null,\"false\":false,n:0,\"null\":false,number:null,object:null,push:null,string:null,\"true\":false,undefined:false,o:null}}function f(n){return typeof n.toString!=\"function\"&&typeof(n+\"\")==\"string\"}function c(n){n.length=0,v.length<w&&v.push(n)}function p(n){var t=n.l;t&&p(t),n.k=n.l=n.m=n.object=n.number=n.string=n.o=null,y.length<w&&y.push(n)}function s(n,t,e){t||(t=0),typeof e==\"undefined\"&&(e=n?n.length:0);var r=-1;e=e-t||0;for(var u=Array(0>e?0:e);++r<e;)u[r]=n[t+r];\nreturn u}function g(e){function v(n){return n&&typeof n==\"object\"&&!qe(n)&&we.call(n,\"__wrapped__\")?n:new y(n)}function y(n,t){this.__chain__=!!t,this.__wrapped__=n}function w(n){function t(){if(r){var n=s(r);je.apply(n,arguments)}if(this instanceof t){var o=nt(e.prototype),n=e.apply(o,n||arguments);return xt(n)?n:o}return e.apply(u,n||arguments)}var e=n[0],r=n[2],u=n[4];return ze(t,n),t}function Y(n,t,e,r,u){if(e){var o=e(n);if(typeof o!=\"undefined\")return o}if(!xt(n))return n;var a=he.call(n);if(!V[a]||!Le.nodeClass&&f(n))return n;\nvar l=Te[a];switch(a){case L:case z:return new l(+n);case W:case M:return new l(n);case J:return o=l(n.source,S.exec(n)),o.lastIndex=n.lastIndex,o}if(a=qe(n),t){var p=!r;r||(r=i()),u||(u=i());for(var g=r.length;g--;)if(r[g]==n)return u[g];o=a?l(n.length):{}}else o=a?s(n):Ye({},n);return a&&(we.call(n,\"index\")&&(o.index=n.index),we.call(n,\"input\")&&(o.input=n.input)),t?(r.push(n),u.push(o),(a?Xe:tr)(n,function(n,a){o[a]=Y(n,t,e,r,u)}),p&&(c(r),c(u)),o):o}function nt(n){return xt(n)?Se(n):{}}function tt(n,t,e){if(typeof n!=\"function\")return Ht;\nif(typeof t==\"undefined\"||!(\"prototype\"in n))return n;var r=n.__bindData__;if(typeof r==\"undefined\"&&(Le.funcNames&&(r=!n.name),r=r||!Le.funcDecomp,!r)){var u=be.call(n);Le.funcNames||(r=!A.test(u)),r||(r=B.test(u),ze(n,r))}if(false===r||true!==r&&1&r[1])return n;switch(e){case 1:return function(e){return n.call(t,e)};case 2:return function(e,r){return n.call(t,e,r)};case 3:return function(e,r,u){return n.call(t,e,r,u)};case 4:return function(e,r,u,o){return n.call(t,e,r,u,o)}}return Mt(n,t)}function et(n){function t(){var n=l?a:this;\nif(u){var h=s(u);je.apply(h,arguments)}return(o||c)&&(h||(h=s(arguments)),o&&je.apply(h,o),c&&h.length<i)?(r|=16,et([e,p?r:-4&r,h,null,a,i])):(h||(h=arguments),f&&(e=n[g]),this instanceof t?(n=nt(e.prototype),h=e.apply(n,h),xt(h)?h:n):e.apply(n,h))}var e=n[0],r=n[1],u=n[2],o=n[3],a=n[4],i=n[5],l=1&r,f=2&r,c=4&r,p=8&r,g=e;return ze(t,n),t}function rt(e,r){var u=-1,a=ht(),i=e?e.length:0,l=i>=_&&a===n,f=[];if(l){var c=o(r);c?(a=t,r=c):l=false}for(;++u<i;)c=e[u],0>a(r,c)&&f.push(c);return l&&p(r),f}function ot(n,t,e,r){r=(r||0)-1;\nfor(var u=n?n.length:0,o=[];++r<u;){var a=n[r];if(a&&typeof a==\"object\"&&typeof a.length==\"number\"&&(qe(a)||dt(a))){t||(a=ot(a,t,e));var i=-1,l=a.length,f=o.length;for(o.length+=l;++i<l;)o[f++]=a[i]}else e||o.push(a)}return o}function at(n,t,e,r,u,o){if(e){var a=e(n,t);if(typeof a!=\"undefined\")return!!a}if(n===t)return 0!==n||1/n==1/t;if(n===n&&!(n&&X[typeof n]||t&&X[typeof t]))return false;if(null==n||null==t)return n===t;var l=he.call(n),p=he.call(t);if(l==T&&(l=G),p==T&&(p=G),l!=p)return false;switch(l){case L:case z:return+n==+t;\ncase W:return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case J:case M:return n==ie(t)}if(p=l==$,!p){var s=we.call(n,\"__wrapped__\"),g=we.call(t,\"__wrapped__\");if(s||g)return at(s?n.__wrapped__:n,g?t.__wrapped__:t,e,r,u,o);if(l!=G||!Le.nodeClass&&(f(n)||f(t)))return false;if(l=!Le.argsObject&&dt(n)?oe:n.constructor,s=!Le.argsObject&&dt(t)?oe:t.constructor,l!=s&&!(jt(l)&&l instanceof l&&jt(s)&&s instanceof s)&&\"constructor\"in n&&\"constructor\"in t)return false}for(l=!u,u||(u=i()),o||(o=i()),s=u.length;s--;)if(u[s]==n)return o[s]==t;\nvar h=0,a=true;if(u.push(n),o.push(t),p){if(s=n.length,h=t.length,(a=h==s)||r)for(;h--;)if(p=s,g=t[h],r)for(;p--&&!(a=at(n[p],g,e,r,u,o)););else if(!(a=at(n[h],g,e,r,u,o)))break}else nr(t,function(t,i,l){return we.call(l,i)?(h++,a=we.call(n,i)&&at(n[i],t,e,r,u,o)):void 0}),a&&!r&&nr(n,function(n,t,e){return we.call(e,t)?a=-1<--h:void 0});return u.pop(),o.pop(),l&&(c(u),c(o)),a}function it(n,t,e,r,u){(qe(t)?Dt:tr)(t,function(t,o){var a,i,l=t,f=n[o];if(t&&((i=qe(t))||er(t))){for(l=r.length;l--;)if(a=r[l]==t){f=u[l];\nbreak}if(!a){var c;e&&(l=e(f,t),c=typeof l!=\"undefined\")&&(f=l),c||(f=i?qe(f)?f:[]:er(f)?f:{}),r.push(t),u.push(f),c||it(f,t,e,r,u)}}else e&&(l=e(f,t),typeof l==\"undefined\"&&(l=t)),typeof l!=\"undefined\"&&(f=l);n[o]=f})}function lt(n,t){return n+de(Fe()*(t-n+1))}function ft(e,r,u){var a=-1,l=ht(),f=e?e.length:0,s=[],g=!r&&f>=_&&l===n,h=u||g?i():s;for(g&&(h=o(h),l=t);++a<f;){var v=e[a],y=u?u(v,a,e):v;(r?!a||h[h.length-1]!==y:0>l(h,y))&&((u||g)&&h.push(y),s.push(v))}return g?(c(h.k),p(h)):u&&c(h),s}function ct(n){return function(t,e,r){var u={};\nif(e=v.createCallback(e,r,3),qe(t)){r=-1;for(var o=t.length;++r<o;){var a=t[r];n(u,a,e(a,r,t),t)}}else Xe(t,function(t,r,o){n(u,t,e(t,r,o),o)});return u}}function pt(n,t,e,r,u,o){var a=1&t,i=4&t,l=16&t,f=32&t;if(!(2&t||jt(n)))throw new le;l&&!e.length&&(t&=-17,l=e=false),f&&!r.length&&(t&=-33,f=r=false);var c=n&&n.__bindData__;return c&&true!==c?(c=s(c),c[2]&&(c[2]=s(c[2])),c[3]&&(c[3]=s(c[3])),!a||1&c[1]||(c[4]=u),!a&&1&c[1]&&(t|=8),!i||4&c[1]||(c[5]=o),l&&je.apply(c[2]||(c[2]=[]),e),f&&Ee.apply(c[3]||(c[3]=[]),r),c[1]|=t,pt.apply(null,c)):(1==t||17===t?w:et)([n,t,e,r,u,o])\n}function st(){Q.h=F,Q.b=Q.c=Q.g=Q.i=\"\",Q.e=\"t\",Q.j=true;for(var n,t=0;n=arguments[t];t++)for(var e in n)Q[e]=n[e];t=Q.a,Q.d=/^[^,]+/.exec(t)[0],n=ee,t=\"return function(\"+t+\"){\",e=Q;var r=\"var n,t=\"+e.d+\",E=\"+e.e+\";if(!t)return E;\"+e.i+\";\";e.b?(r+=\"var u=t.length;n=-1;if(\"+e.b+\"){\",Le.unindexedChars&&(r+=\"if(s(t)){t=t.split('')}\"),r+=\"while(++n<u){\"+e.g+\";}}else{\"):Le.nonEnumArgs&&(r+=\"var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';\"+e.g+\";}}else{\"),Le.enumPrototypes&&(r+=\"var G=typeof t=='function';\"),Le.enumErrorProps&&(r+=\"var F=t===k||t instanceof Error;\");\nvar u=[];if(Le.enumPrototypes&&u.push('!(G&&n==\"prototype\")'),Le.enumErrorProps&&u.push('!(F&&(n==\"message\"||n==\"name\"))'),e.j&&e.f)r+=\"var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];\",u.length&&(r+=\"if(\"+u.join(\"&&\")+\"){\"),r+=e.g+\";\",u.length&&(r+=\"}\"),r+=\"}\";else if(r+=\"for(n in t){\",e.j&&u.push(\"m.call(t, n)\"),u.length&&(r+=\"if(\"+u.join(\"&&\")+\"){\"),r+=e.g+\";\",u.length&&(r+=\"}\"),r+=\"}\",Le.nonEnumShadows){for(r+=\"if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];\",k=0;7>k;k++)r+=\"n='\"+e.h[k]+\"';if((!(r&&x[n])&&m.call(t,n))\",e.j||(r+=\"||(!x[n]&&t[n]!==A[n])\"),r+=\"){\"+e.g+\"}\";\nr+=\"}\"}return(e.b||Le.nonEnumArgs)&&(r+=\"}\"),r+=e.c+\";return E\",n(\"d,j,k,m,o,p,q,s,v,A,B,y,I,J,L\",t+r+\"}\")(tt,q,ce,we,d,dt,qe,kt,Q.f,pe,X,$e,M,se,he)}function gt(n){return Ve[n]}function ht(){var t=(t=v.indexOf)===zt?n:t;return t}function vt(n){return typeof n==\"function\"&&ve.test(n)}function yt(n){var t,e;return!n||he.call(n)!=G||(t=n.constructor,jt(t)&&!(t instanceof t))||!Le.argsClass&&dt(n)||!Le.nodeClass&&f(n)?false:Le.ownLast?(nr(n,function(n,t,r){return e=we.call(r,t),false}),false!==e):(nr(n,function(n,t){e=t\n}),typeof e==\"undefined\"||we.call(n,e))}function mt(n){return He[n]}function dt(n){return n&&typeof n==\"object\"&&typeof n.length==\"number\"&&he.call(n)==T||false}function bt(n,t,e){var r=We(n),u=r.length;for(t=tt(t,e,3);u--&&(e=r[u],false!==t(n[e],e,n)););return n}function _t(n){var t=[];return nr(n,function(n,e){jt(n)&&t.push(e)}),t.sort()}function wt(n){for(var t=-1,e=We(n),r=e.length,u={};++t<r;){var o=e[t];u[n[o]]=o}return u}function jt(n){return typeof n==\"function\"}function xt(n){return!(!n||!X[typeof n])\n}function Ct(n){return typeof n==\"number\"||n&&typeof n==\"object\"&&he.call(n)==W||false}function kt(n){return typeof n==\"string\"||n&&typeof n==\"object\"&&he.call(n)==M||false}function Et(n){for(var t=-1,e=We(n),r=e.length,u=Zt(r);++t<r;)u[t]=n[e[t]];return u}function Ot(n,t,e){var r=-1,u=ht(),o=n?n.length:0,a=false;return e=(0>e?Be(0,o+e):e)||0,qe(n)?a=-1<u(n,t,e):typeof o==\"number\"?a=-1<(kt(n)?n.indexOf(t,e):u(n,t,e)):Xe(n,function(n){return++r<e?void 0:!(a=n===t)}),a}function St(n,t,e){var r=true;if(t=v.createCallback(t,e,3),qe(n)){e=-1;\nfor(var u=n.length;++e<u&&(r=!!t(n[e],e,n)););}else Xe(n,function(n,e,u){return r=!!t(n,e,u)});return r}function At(n,t,e){var r=[];if(t=v.createCallback(t,e,3),qe(n)){e=-1;for(var u=n.length;++e<u;){var o=n[e];t(o,e,n)&&r.push(o)}}else Xe(n,function(n,e,u){t(n,e,u)&&r.push(n)});return r}function It(n,t,e){if(t=v.createCallback(t,e,3),!qe(n)){var r;return Xe(n,function(n,e,u){return t(n,e,u)?(r=n,false):void 0}),r}e=-1;for(var u=n.length;++e<u;){var o=n[e];if(t(o,e,n))return o}}function Dt(n,t,e){if(t&&typeof e==\"undefined\"&&qe(n)){e=-1;\nfor(var r=n.length;++e<r&&false!==t(n[e],e,n););}else Xe(n,t,e);return n}function Nt(n,t,e){var r=n,u=n?n.length:0;if(t=t&&typeof e==\"undefined\"?t:tt(t,e,3),qe(n))for(;u--&&false!==t(n[u],u,n););else{if(typeof u!=\"number\")var o=We(n),u=o.length;else Le.unindexedChars&&kt(n)&&(r=n.split(\"\"));Xe(n,function(n,e,a){return e=o?o[--u]:--u,t(r[e],e,a)})}return n}function Bt(n,t,e){var r=-1,u=n?n.length:0,o=Zt(typeof u==\"number\"?u:0);if(t=v.createCallback(t,e,3),qe(n))for(;++r<u;)o[r]=t(n[r],r,n);else Xe(n,function(n,e,u){o[++r]=t(n,e,u)\n});return o}function Pt(n,t,e){var u=-1/0,o=u;if(typeof t!=\"function\"&&e&&e[t]===n&&(t=null),null==t&&qe(n)){e=-1;for(var a=n.length;++e<a;){var i=n[e];i>o&&(o=i)}}else t=null==t&&kt(n)?r:v.createCallback(t,e,3),Xe(n,function(n,e,r){e=t(n,e,r),e>u&&(u=e,o=n)});return o}function Rt(n,t,e,r){var u=3>arguments.length;if(t=v.createCallback(t,r,4),qe(n)){var o=-1,a=n.length;for(u&&(e=n[++o]);++o<a;)e=t(e,n[o],o,n)}else Xe(n,function(n,r,o){e=u?(u=false,n):t(e,n,r,o)});return e}function Ft(n,t,e,r){var u=3>arguments.length;\nreturn t=v.createCallback(t,r,4),Nt(n,function(n,r,o){e=u?(u=false,n):t(e,n,r,o)}),e}function Tt(n){var t=-1,e=n?n.length:0,r=Zt(typeof e==\"number\"?e:0);return Dt(n,function(n){var e=lt(0,++t);r[t]=r[e],r[e]=n}),r}function $t(n,t,e){var r;if(t=v.createCallback(t,e,3),qe(n)){e=-1;for(var u=n.length;++e<u&&!(r=t(n[e],e,n)););}else Xe(n,function(n,e,u){return!(r=t(n,e,u))});return!!r}function Lt(n,t,e){var r=0,u=n?n.length:0;if(typeof t!=\"number\"&&null!=t){var o=-1;for(t=v.createCallback(t,e,3);++o<u&&t(n[o],o,n);)r++\n}else if(r=t,null==r||e)return n?n[0]:h;return s(n,0,Pe(Be(0,r),u))}function zt(t,e,r){if(typeof r==\"number\"){var u=t?t.length:0;r=0>r?Be(0,u+r):r||0}else if(r)return r=Kt(t,e),t[r]===e?r:-1;return n(t,e,r)}function qt(n,t,e){if(typeof t!=\"number\"&&null!=t){var r=0,u=-1,o=n?n.length:0;for(t=v.createCallback(t,e,3);++u<o&&t(n[u],u,n);)r++}else r=null==t||e?1:Be(0,t);return s(n,r)}function Kt(n,t,e,r){var u=0,o=n?n.length:u;for(e=e?v.createCallback(e,r,1):Ht,t=e(t);u<o;)r=u+o>>>1,e(n[r])<t?u=r+1:o=r;\nreturn u}function Wt(n,t,e,r){return typeof t!=\"boolean\"&&null!=t&&(r=e,e=typeof t!=\"function\"&&r&&r[t]===n?null:t,t=false),null!=e&&(e=v.createCallback(e,r,3)),ft(n,t,e)}function Gt(){for(var n=1<arguments.length?arguments:arguments[0],t=-1,e=n?Pt(ar(n,\"length\")):0,r=Zt(0>e?0:e);++t<e;)r[t]=ar(n,t);return r}function Jt(n,t){var e=-1,r=n?n.length:0,u={};for(t||!r||qe(n[0])||(t=[]);++e<r;){var o=n[e];t?u[o]=t[e]:o&&(u[o[0]]=o[1])}return u}function Mt(n,t){return 2<arguments.length?pt(n,17,s(arguments,2),null,t):pt(n,1,null,null,t)\n}function Vt(n,t,e){var r,u,o,a,i,l,f,c=0,p=false,s=true;if(!jt(n))throw new le;if(t=Be(0,t)||0,true===e)var g=true,s=false;else xt(e)&&(g=e.leading,p=\"maxWait\"in e&&(Be(t,e.maxWait)||0),s=\"trailing\"in e?e.trailing:s);var v=function(){var e=t-(ir()-a);0<e?l=Ce(v,e):(u&&me(u),e=f,u=l=f=h,e&&(c=ir(),o=n.apply(i,r),l||u||(r=i=null)))},y=function(){l&&me(l),u=l=f=h,(s||p!==t)&&(c=ir(),o=n.apply(i,r),l||u||(r=i=null))};return function(){if(r=arguments,a=ir(),i=this,f=s&&(l||!g),false===p)var e=g&&!l;else{u||g||(c=a);\nvar h=p-(a-c),m=0>=h;m?(u&&(u=me(u)),c=a,o=n.apply(i,r)):u||(u=Ce(y,h))}return m&&l?l=me(l):l||t===p||(l=Ce(v,t)),e&&(m=true,o=n.apply(i,r)),!m||l||u||(r=i=null),o}}function Ht(n){return n}function Ut(n,t,e){var r=true,u=t&&_t(t);t&&(e||u.length)||(null==e&&(e=t),o=y,t=n,n=v,u=_t(t)),false===e?r=false:xt(e)&&\"chain\"in e&&(r=e.chain);var o=n,a=jt(o);Dt(u,function(e){var u=n[e]=t[e];a&&(o.prototype[e]=function(){var t=this.__chain__,e=this.__wrapped__,a=[e];if(je.apply(a,arguments),a=u.apply(n,a),r||t){if(e===a&&xt(a))return this;\na=new o(a),a.__chain__=t}return a})})}function Qt(){}function Xt(n){return function(t){return t[n]}}function Yt(){return this.__wrapped__}e=e?ut.defaults(Z.Object(),e,ut.pick(Z,R)):Z;var Zt=e.Array,ne=e.Boolean,te=e.Date,ee=e.Function,re=e.Math,ue=e.Number,oe=e.Object,ae=e.RegExp,ie=e.String,le=e.TypeError,fe=[],ce=e.Error.prototype,pe=oe.prototype,se=ie.prototype,ge=e._,he=pe.toString,ve=ae(\"^\"+ie(he).replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\").replace(/toString| for [^\\]]+/g,\".*?\")+\"$\"),ye=re.ceil,me=e.clearTimeout,de=re.floor,be=ee.prototype.toString,_e=vt(_e=oe.getPrototypeOf)&&_e,we=pe.hasOwnProperty,je=fe.push,xe=pe.propertyIsEnumerable,Ce=e.setTimeout,ke=fe.splice,Ee=fe.unshift,Oe=function(){try{var n={},t=vt(t=oe.defineProperty)&&t,e=t(n,n,n)&&t\n}catch(r){}return e}(),Se=vt(Se=oe.create)&&Se,Ae=vt(Ae=Zt.isArray)&&Ae,Ie=e.isFinite,De=e.isNaN,Ne=vt(Ne=oe.keys)&&Ne,Be=re.max,Pe=re.min,Re=e.parseInt,Fe=re.random,Te={};Te[$]=Zt,Te[L]=ne,Te[z]=te,Te[K]=ee,Te[G]=oe,Te[W]=ue,Te[J]=ae,Te[M]=ie;var $e={};$e[$]=$e[z]=$e[W]={constructor:true,toLocaleString:true,toString:true,valueOf:true},$e[L]=$e[M]={constructor:true,toString:true,valueOf:true},$e[q]=$e[K]=$e[J]={constructor:true,toString:true},$e[G]={constructor:true},function(){for(var n=F.length;n--;){var t,e=F[n];\nfor(t in $e)we.call($e,t)&&!we.call($e[t],e)&&($e[t][e]=false)}}(),y.prototype=v.prototype;var Le=v.support={};!function(){var n=function(){this.x=1},t={0:1,length:1},r=[];n.prototype={valueOf:1,y:1};for(var u in new n)r.push(u);for(u in arguments);Le.argsClass=he.call(arguments)==T,Le.argsObject=arguments.constructor==oe&&!(arguments instanceof Zt),Le.enumErrorProps=xe.call(ce,\"message\")||xe.call(ce,\"name\"),Le.enumPrototypes=xe.call(n,\"prototype\"),Le.funcDecomp=!vt(e.WinRTError)&&B.test(g),Le.funcNames=typeof ee.name==\"string\",Le.nonEnumArgs=0!=u,Le.nonEnumShadows=!/valueOf/.test(r),Le.ownLast=\"x\"!=r[0],Le.spliceObjects=(fe.splice.call(t,0,1),!t[0]),Le.unindexedChars=\"xx\"!=\"x\"[0]+oe(\"x\")[0];\ntry{Le.nodeClass=!(he.call(document)==G&&!({toString:0}+\"\"))}catch(o){Le.nodeClass=true}}(1),v.templateSettings={escape:/<%-([\\s\\S]+?)%>/g,evaluate:/<%([\\s\\S]+?)%>/g,interpolate:I,variable:\"\",imports:{_:v}},Se||(nt=function(){function n(){}return function(t){if(xt(t)){n.prototype=t;var r=new n;n.prototype=null}return r||e.Object()}}());var ze=Oe?function(n,t){U.value=t,Oe(n,\"__bindData__\",U)}:Qt;Le.argsClass||(dt=function(n){return n&&typeof n==\"object\"&&typeof n.length==\"number\"&&we.call(n,\"callee\")&&!xe.call(n,\"callee\")||false\n});var qe=Ae||function(n){return n&&typeof n==\"object\"&&typeof n.length==\"number\"&&he.call(n)==$||false},Ke=st({a:\"z\",e:\"[]\",i:\"if(!(B[typeof z]))return E\",g:\"E.push(n)\"}),We=Ne?function(n){return xt(n)?Le.enumPrototypes&&typeof n==\"function\"||Le.nonEnumArgs&&n.length&&dt(n)?Ke(n):Ne(n):[]}:Ke,Ge={a:\"g,e,K\",i:\"e=e&&typeof K=='undefined'?e:d(e,K,3)\",b:\"typeof u=='number'\",v:We,g:\"if(e(t[n],n,g)===false)return E\"},Je={a:\"z,H,l\",i:\"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){\",v:We,g:\"if(typeof E[n]=='undefined')E[n]=t[n]\",c:\"}}\"},Me={i:\"if(!B[typeof t])return E;\"+Ge.i,b:false},Ve={\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",'\"':\"&quot;\",\"'\":\"&#39;\"},He=wt(Ve),Ue=ae(\"(\"+We(He).join(\"|\")+\")\",\"g\"),Qe=ae(\"[\"+We(Ve).join(\"\")+\"]\",\"g\"),Xe=st(Ge),Ye=st(Je,{i:Je.i.replace(\";\",\";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}\"),g:\"E[n]=e?e(E[n],t[n]):t[n]\"}),Ze=st(Je),nr=st(Ge,Me,{j:false}),tr=st(Ge,Me);\njt(/x/)&&(jt=function(n){return typeof n==\"function\"&&he.call(n)==K});var er=_e?function(n){if(!n||he.call(n)!=G||!Le.argsClass&&dt(n))return false;var t=n.valueOf,e=vt(t)&&(e=_e(t))&&_e(e);return e?n==e||_e(n)==e:yt(n)}:yt,rr=ct(function(n,t,e){we.call(n,e)?n[e]++:n[e]=1}),ur=ct(function(n,t,e){(we.call(n,e)?n[e]:n[e]=[]).push(t)}),or=ct(function(n,t,e){n[e]=t}),ar=Bt,ir=vt(ir=te.now)&&ir||function(){return(new te).getTime()},lr=8==Re(j+\"08\")?Re:function(n,t){return Re(kt(n)?n.replace(D,\"\"):n,t||0)};\nreturn v.after=function(n,t){if(!jt(t))throw new le;return function(){return 1>--n?t.apply(this,arguments):void 0}},v.assign=Ye,v.at=function(n){var t=arguments,e=-1,r=ot(t,true,false,1),t=t[2]&&t[2][t[1]]===n?1:r.length,u=Zt(t);for(Le.unindexedChars&&kt(n)&&(n=n.split(\"\"));++e<t;)u[e]=n[r[e]];return u},v.bind=Mt,v.bindAll=function(n){for(var t=1<arguments.length?ot(arguments,true,false,1):_t(n),e=-1,r=t.length;++e<r;){var u=t[e];n[u]=pt(n[u],1,null,null,n)}return n},v.bindKey=function(n,t){return 2<arguments.length?pt(t,19,s(arguments,2),null,n):pt(t,3,null,null,n)\n},v.chain=function(n){return n=new y(n),n.__chain__=true,n},v.compact=function(n){for(var t=-1,e=n?n.length:0,r=[];++t<e;){var u=n[t];u&&r.push(u)}return r},v.compose=function(){for(var n=arguments,t=n.length;t--;)if(!jt(n[t]))throw new le;return function(){for(var t=arguments,e=n.length;e--;)t=[n[e].apply(this,t)];return t[0]}},v.constant=function(n){return function(){return n}},v.countBy=rr,v.create=function(n,t){var e=nt(n);return t?Ye(e,t):e},v.createCallback=function(n,t,e){var r=typeof n;if(null==n||\"function\"==r)return tt(n,t,e);\nif(\"object\"!=r)return Xt(n);var u=We(n),o=u[0],a=n[o];return 1!=u.length||a!==a||xt(a)?function(t){for(var e=u.length,r=false;e--&&(r=at(t[u[e]],n[u[e]],null,true)););return r}:function(n){return n=n[o],a===n&&(0!==a||1/a==1/n)}},v.curry=function(n,t){return t=typeof t==\"number\"?t:+t||n.length,pt(n,4,null,null,null,t)},v.debounce=Vt,v.defaults=Ze,v.defer=function(n){if(!jt(n))throw new le;var t=s(arguments,1);return Ce(function(){n.apply(h,t)},1)},v.delay=function(n,t){if(!jt(n))throw new le;var e=s(arguments,2);\nreturn Ce(function(){n.apply(h,e)},t)},v.difference=function(n){return rt(n,ot(arguments,true,true,1))},v.filter=At,v.flatten=function(n,t,e,r){return typeof t!=\"boolean\"&&null!=t&&(r=e,e=typeof t!=\"function\"&&r&&r[t]===n?null:t,t=false),null!=e&&(n=Bt(n,e,r)),ot(n,t)},v.forEach=Dt,v.forEachRight=Nt,v.forIn=nr,v.forInRight=function(n,t,e){var r=[];nr(n,function(n,t){r.push(t,n)});var u=r.length;for(t=tt(t,e,3);u--&&false!==t(r[u--],r[u],n););return n},v.forOwn=tr,v.forOwnRight=bt,v.functions=_t,v.groupBy=ur,v.indexBy=or,v.initial=function(n,t,e){var r=0,u=n?n.length:0;\nif(typeof t!=\"number\"&&null!=t){var o=u;for(t=v.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else r=null==t||e?1:t||r;return s(n,0,Pe(Be(0,u-r),u))},v.intersection=function(){for(var e=[],r=-1,u=arguments.length,a=i(),l=ht(),f=l===n,s=i();++r<u;){var g=arguments[r];(qe(g)||dt(g))&&(e.push(g),a.push(f&&g.length>=_&&o(r?e[r]:s)))}var f=e[0],h=-1,v=f?f.length:0,y=[];n:for(;++h<v;){var m=a[0],g=f[h];if(0>(m?t(m,g):l(s,g))){for(r=u,(m||s).push(g);--r;)if(m=a[r],0>(m?t(m,g):l(e[r],g)))continue n;y.push(g)\n}}for(;u--;)(m=a[u])&&p(m);return c(a),c(s),y},v.invert=wt,v.invoke=function(n,t){var e=s(arguments,2),r=-1,u=typeof t==\"function\",o=n?n.length:0,a=Zt(typeof o==\"number\"?o:0);return Dt(n,function(n){a[++r]=(u?t:n[t]).apply(n,e)}),a},v.keys=We,v.map=Bt,v.mapValues=function(n,t,e){var r={};return t=v.createCallback(t,e,3),tr(n,function(n,e,u){r[e]=t(n,e,u)}),r},v.max=Pt,v.memoize=function(n,t){if(!jt(n))throw new le;var e=function(){var r=e.cache,u=t?t.apply(this,arguments):b+arguments[0];return we.call(r,u)?r[u]:r[u]=n.apply(this,arguments)\n};return e.cache={},e},v.merge=function(n){var t=arguments,e=2;if(!xt(n))return n;if(\"number\"!=typeof t[2]&&(e=t.length),3<e&&\"function\"==typeof t[e-2])var r=tt(t[--e-1],t[e--],2);else 2<e&&\"function\"==typeof t[e-1]&&(r=t[--e]);for(var t=s(arguments,1,e),u=-1,o=i(),a=i();++u<e;)it(n,t[u],r,o,a);return c(o),c(a),n},v.min=function(n,t,e){var u=1/0,o=u;if(typeof t!=\"function\"&&e&&e[t]===n&&(t=null),null==t&&qe(n)){e=-1;for(var a=n.length;++e<a;){var i=n[e];i<o&&(o=i)}}else t=null==t&&kt(n)?r:v.createCallback(t,e,3),Xe(n,function(n,e,r){e=t(n,e,r),e<u&&(u=e,o=n)\n});return o},v.omit=function(n,t,e){var r={};if(typeof t!=\"function\"){var u=[];nr(n,function(n,t){u.push(t)});for(var u=rt(u,ot(arguments,true,false,1)),o=-1,a=u.length;++o<a;){var i=u[o];r[i]=n[i]}}else t=v.createCallback(t,e,3),nr(n,function(n,e,u){t(n,e,u)||(r[e]=n)});return r},v.once=function(n){var t,e;if(!jt(n))throw new le;return function(){return t?e:(t=true,e=n.apply(this,arguments),n=null,e)}},v.pairs=function(n){for(var t=-1,e=We(n),r=e.length,u=Zt(r);++t<r;){var o=e[t];u[t]=[o,n[o]]}return u\n},v.partial=function(n){return pt(n,16,s(arguments,1))},v.partialRight=function(n){return pt(n,32,null,s(arguments,1))},v.pick=function(n,t,e){var r={};if(typeof t!=\"function\")for(var u=-1,o=ot(arguments,true,false,1),a=xt(n)?o.length:0;++u<a;){var i=o[u];i in n&&(r[i]=n[i])}else t=v.createCallback(t,e,3),nr(n,function(n,e,u){t(n,e,u)&&(r[e]=n)});return r},v.pluck=ar,v.property=Xt,v.pull=function(n){for(var t=arguments,e=0,r=t.length,u=n?n.length:0;++e<r;)for(var o=-1,a=t[e];++o<u;)n[o]===a&&(ke.call(n,o--,1),u--);\nreturn n},v.range=function(n,t,e){n=+n||0,e=typeof e==\"number\"?e:+e||1,null==t&&(t=n,n=0);var r=-1;t=Be(0,ye((t-n)/(e||1)));for(var u=Zt(t);++r<t;)u[r]=n,n+=e;return u},v.reject=function(n,t,e){return t=v.createCallback(t,e,3),At(n,function(n,e,r){return!t(n,e,r)})},v.remove=function(n,t,e){var r=-1,u=n?n.length:0,o=[];for(t=v.createCallback(t,e,3);++r<u;)e=n[r],t(e,r,n)&&(o.push(e),ke.call(n,r--,1),u--);return o},v.rest=qt,v.shuffle=Tt,v.sortBy=function(n,t,e){var r=-1,o=qe(t),a=n?n.length:0,f=Zt(typeof a==\"number\"?a:0);\nfor(o||(t=v.createCallback(t,e,3)),Dt(n,function(n,e,u){var a=f[++r]=l();o?a.m=Bt(t,function(t){return n[t]}):(a.m=i())[0]=t(n,e,u),a.n=r,a.o=n}),a=f.length,f.sort(u);a--;)n=f[a],f[a]=n.o,o||c(n.m),p(n);return f},v.tap=function(n,t){return t(n),n},v.throttle=function(n,t,e){var r=true,u=true;if(!jt(n))throw new le;return false===e?r=false:xt(e)&&(r=\"leading\"in e?e.leading:r,u=\"trailing\"in e?e.trailing:u),H.leading=r,H.maxWait=t,H.trailing=u,Vt(n,t,H)},v.times=function(n,t,e){n=-1<(n=+n)?n:0;var r=-1,u=Zt(n);\nfor(t=tt(t,e,1);++r<n;)u[r]=t(r);return u},v.toArray=function(n){return n&&typeof n.length==\"number\"?Le.unindexedChars&&kt(n)?n.split(\"\"):s(n):Et(n)},v.transform=function(n,t,e,r){var u=qe(n);if(null==e)if(u)e=[];else{var o=n&&n.constructor;e=nt(o&&o.prototype)}return t&&(t=v.createCallback(t,r,4),(u?Xe:tr)(n,function(n,r,u){return t(e,n,r,u)})),e},v.union=function(){return ft(ot(arguments,true,true))},v.uniq=Wt,v.values=Et,v.where=At,v.without=function(n){return rt(n,s(arguments,1))},v.wrap=function(n,t){return pt(t,16,[n])\n},v.xor=function(){for(var n=-1,t=arguments.length;++n<t;){var e=arguments[n];if(qe(e)||dt(e))var r=r?ft(rt(r,e).concat(rt(e,r))):e}return r||[]},v.zip=Gt,v.zipObject=Jt,v.collect=Bt,v.drop=qt,v.each=Dt,v.eachRight=Nt,v.extend=Ye,v.methods=_t,v.object=Jt,v.select=At,v.tail=qt,v.unique=Wt,v.unzip=Gt,Ut(v),v.clone=function(n,t,e,r){return typeof t!=\"boolean\"&&null!=t&&(r=e,e=t,t=false),Y(n,t,typeof e==\"function\"&&tt(e,r,1))},v.cloneDeep=function(n,t,e){return Y(n,true,typeof t==\"function\"&&tt(t,e,1))},v.contains=Ot,v.escape=function(n){return null==n?\"\":ie(n).replace(Qe,gt)\n},v.every=St,v.find=It,v.findIndex=function(n,t,e){var r=-1,u=n?n.length:0;for(t=v.createCallback(t,e,3);++r<u;)if(t(n[r],r,n))return r;return-1},v.findKey=function(n,t,e){var r;return t=v.createCallback(t,e,3),tr(n,function(n,e,u){return t(n,e,u)?(r=e,false):void 0}),r},v.findLast=function(n,t,e){var r;return t=v.createCallback(t,e,3),Nt(n,function(n,e,u){return t(n,e,u)?(r=n,false):void 0}),r},v.findLastIndex=function(n,t,e){var r=n?n.length:0;for(t=v.createCallback(t,e,3);r--;)if(t(n[r],r,n))return r;\nreturn-1},v.findLastKey=function(n,t,e){var r;return t=v.createCallback(t,e,3),bt(n,function(n,e,u){return t(n,e,u)?(r=e,false):void 0}),r},v.has=function(n,t){return n?we.call(n,t):false},v.identity=Ht,v.indexOf=zt,v.isArguments=dt,v.isArray=qe,v.isBoolean=function(n){return true===n||false===n||n&&typeof n==\"object\"&&he.call(n)==L||false},v.isDate=function(n){return n&&typeof n==\"object\"&&he.call(n)==z||false},v.isElement=function(n){return n&&1===n.nodeType||false},v.isEmpty=function(n){var t=true;if(!n)return t;var e=he.call(n),r=n.length;\nreturn e==$||e==M||(Le.argsClass?e==T:dt(n))||e==G&&typeof r==\"number\"&&jt(n.splice)?!r:(tr(n,function(){return t=false}),t)},v.isEqual=function(n,t,e,r){return at(n,t,typeof e==\"function\"&&tt(e,r,2))},v.isFinite=function(n){return Ie(n)&&!De(parseFloat(n))},v.isFunction=jt,v.isNaN=function(n){return Ct(n)&&n!=+n},v.isNull=function(n){return null===n},v.isNumber=Ct,v.isObject=xt,v.isPlainObject=er,v.isRegExp=function(n){return n&&X[typeof n]&&he.call(n)==J||false},v.isString=kt,v.isUndefined=function(n){return typeof n==\"undefined\"\n},v.lastIndexOf=function(n,t,e){var r=n?n.length:0;for(typeof e==\"number\"&&(r=(0>e?Be(0,r+e):Pe(e,r-1))+1);r--;)if(n[r]===t)return r;return-1},v.mixin=Ut,v.noConflict=function(){return e._=ge,this},v.noop=Qt,v.now=ir,v.parseInt=lr,v.random=function(n,t,e){var r=null==n,u=null==t;return null==e&&(typeof n==\"boolean\"&&u?(e=n,n=1):u||typeof t!=\"boolean\"||(e=t,u=true)),r&&u&&(t=1),n=+n||0,u?(t=n,n=0):t=+t||0,e||n%1||t%1?(e=Fe(),Pe(n+e*(t-n+parseFloat(\"1e-\"+((e+\"\").length-1))),t)):lt(n,t)},v.reduce=Rt,v.reduceRight=Ft,v.result=function(n,t){if(n){var e=n[t];\nreturn jt(e)?n[t]():e}},v.runInContext=g,v.size=function(n){var t=n?n.length:0;return typeof t==\"number\"?t:We(n).length},v.some=$t,v.sortedIndex=Kt,v.template=function(n,t,e){var r=v.templateSettings;n=ie(n||\"\"),e=Ze({},e,r);var u,o=Ze({},e.imports,r.imports),r=We(o),o=Et(o),i=0,l=e.interpolate||N,f=\"__p+='\",l=ae((e.escape||N).source+\"|\"+l.source+\"|\"+(l===I?O:N).source+\"|\"+(e.evaluate||N).source+\"|$\",\"g\");n.replace(l,function(t,e,r,o,l,c){return r||(r=o),f+=n.slice(i,c).replace(P,a),e&&(f+=\"'+__e(\"+e+\")+'\"),l&&(u=true,f+=\"';\"+l+\";\\n__p+='\"),r&&(f+=\"'+((__t=(\"+r+\"))==null?'':__t)+'\"),i=c+t.length,t\n}),f+=\"';\",l=e=e.variable,l||(e=\"obj\",f=\"with(\"+e+\"){\"+f+\"}\"),f=(u?f.replace(x,\"\"):f).replace(C,\"$1\").replace(E,\"$1;\"),f=\"function(\"+e+\"){\"+(l?\"\":e+\"||(\"+e+\"={});\")+\"var __t,__p='',__e=_.escape\"+(u?\",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}\":\";\")+f+\"return __p}\";try{var c=ee(r,\"return \"+f).apply(h,o)}catch(p){throw p.source=f,p}return t?c(t):(c.source=f,c)},v.unescape=function(n){return null==n?\"\":ie(n).replace(Ue,mt)},v.uniqueId=function(n){var t=++m;return ie(null==n?\"\":n)+t\n},v.all=St,v.any=$t,v.detect=It,v.findWhere=It,v.foldl=Rt,v.foldr=Ft,v.include=Ot,v.inject=Rt,Ut(function(){var n={};return tr(v,function(t,e){v.prototype[e]||(n[e]=t)}),n}(),false),v.first=Lt,v.last=function(n,t,e){var r=0,u=n?n.length:0;if(typeof t!=\"number\"&&null!=t){var o=u;for(t=v.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[u-1]:h;return s(n,Be(0,u-r))},v.sample=function(n,t,e){return n&&typeof n.length!=\"number\"?n=Et(n):Le.unindexedChars&&kt(n)&&(n=n.split(\"\")),null==t||e?n?n[lt(0,n.length-1)]:h:(n=Tt(n),n.length=Pe(Be(0,t),n.length),n)\n},v.take=Lt,v.head=Lt,tr(v,function(n,t){var e=\"sample\"!==t;v.prototype[t]||(v.prototype[t]=function(t,r){var u=this.__chain__,o=n(this.__wrapped__,t,r);return u||null!=t&&(!r||e&&typeof t==\"function\")?new y(o,u):o})}),v.VERSION=\"2.4.1\",v.prototype.chain=function(){return this.__chain__=true,this},v.prototype.toString=function(){return ie(this.__wrapped__)},v.prototype.value=Yt,v.prototype.valueOf=Yt,Xe([\"join\",\"pop\",\"shift\"],function(n){var t=fe[n];v.prototype[n]=function(){var n=this.__chain__,e=t.apply(this.__wrapped__,arguments);\nreturn n?new y(e,n):e}}),Xe([\"push\",\"reverse\",\"sort\",\"unshift\"],function(n){var t=fe[n];v.prototype[n]=function(){return t.apply(this.__wrapped__,arguments),this}}),Xe([\"concat\",\"slice\",\"splice\"],function(n){var t=fe[n];v.prototype[n]=function(){return new y(t.apply(this.__wrapped__,arguments),this.__chain__)}}),Le.spliceObjects||Xe([\"pop\",\"shift\",\"splice\"],function(n){var t=fe[n],e=\"splice\"==n;v.prototype[n]=function(){var n=this.__chain__,r=this.__wrapped__,u=t.apply(r,arguments);return 0===r.length&&delete r[0],n||e?new y(u,n):u\n}}),v}var h,v=[],y=[],m=0,d={},b=+new Date+\"\",_=75,w=40,j=\" \\t\\x0B\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\",x=/\\b__p\\+='';/g,C=/\\b(__p\\+=)''\\+/g,E=/(__e\\(.*?\\)|\\b__t\\))\\+'';/g,O=/\\$\\{([^\\\\}]*(?:\\\\.[^\\\\}]*)*)\\}/g,S=/\\w*$/,A=/^\\s*function[ \\n\\r\\t]+\\w/,I=/<%=([\\s\\S]+?)%>/g,D=RegExp(\"^[\"+j+\"]*0+(?=.$)\"),N=/($^)/,B=/\\bthis\\b/,P=/['\\n\\r\\t\\u2028\\u2029\\\\]/g,R=\"Array Boolean Date Error Function Math Number Object RegExp String _ attachEvent clearTimeout isFinite isNaN parseInt setTimeout\".split(\" \"),F=\"constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf\".split(\" \"),T=\"[object Arguments]\",$=\"[object Array]\",L=\"[object Boolean]\",z=\"[object Date]\",q=\"[object Error]\",K=\"[object Function]\",W=\"[object Number]\",G=\"[object Object]\",J=\"[object RegExp]\",M=\"[object String]\",V={};\nV[K]=false,V[T]=V[$]=V[L]=V[z]=V[W]=V[G]=V[J]=V[M]=true;var H={leading:false,maxWait:0,trailing:false},U={configurable:false,enumerable:false,value:null,writable:false},Q={a:\"\",b:null,c:\"\",d:\"\",e:\"\",v:null,g:\"\",h:null,support:null,i:\"\",j:false},X={\"boolean\":false,\"function\":true,object:true,number:false,string:false,undefined:false},Y={\"\\\\\":\"\\\\\",\"'\":\"'\",\"\\n\":\"n\",\"\\r\":\"r\",\"\\t\":\"t\",\"\\u2028\":\"u2028\",\"\\u2029\":\"u2029\"},Z=X[typeof window]&&window||this,nt=X[typeof exports]&&exports&&!exports.nodeType&&exports,tt=X[typeof module]&&module&&!module.nodeType&&module,et=tt&&tt.exports===nt&&nt,rt=X[typeof global]&&global;\n!rt||rt.global!==rt&&rt.window!==rt||(Z=rt);var ut=g();typeof define==\"function\"&&typeof define.amd==\"object\"&&define.amd?(Z._=ut, define('taoQtiItem/portableLib/lodash',[],function(){return ut})):nt&&tt?et?(tt.exports=ut)._=ut:nt._=ut:Z._=ut}).call(this);\n",
    "define('taoQtiItem/portableLib/OAT/util/EventMgr',['taoQtiItem/portableLib/lodash'], function(_){\n    'use strict';\n\n    return function EventMgr(){\n        \n        var events = {};\n        \n        this.get = function get(event){\n            if(event && events[event]){\n                return _.clone(events[event]);\n            }else{\n                return [];\n            }\n        };\n        \n        this.on = function on(event, callback){\n            var name;\n            var tokens = event.split('.');\n            if(tokens[0]){\n                name = tokens.shift();\n                events[name] = events[name] || [];\n                events[name].push({\n                    ns : tokens,\n                    callback : callback\n                });\n            }\n        };\n        \n        this.off = function off(event){\n            if(event && events[event]){\n                events[event] = [];\n            }\n        };\n        \n        this.trigger = function trigger(event, data){\n            if(events[event]){\n                _.forEach(events[event], function(e){\n                    e.callback.apply({\n                        type : event,\n                        ns : []\n                    }, data);\n                });\n            }\n        };\n    };\n});\n",
    "define('taoQtiItem/portableLib/OAT/util/event',['taoQtiItem/portableLib/OAT/util/EventMgr'], function(EventMgr){\n\n    return {\n        addEventMgr : function(instance){\n\n            var eventMgr = new EventMgr();\n\n            instance.on = function on(event, callback){\n                eventMgr.on(event, callback);\n            };\n            instance.off = function off(event){\n                eventMgr.off(event);\n            };\n            instance.trigger = function trigger(event, data){\n                eventMgr.trigger(event, data);\n            };\n\n        }\n    };\n});\n",
    "/*\r\n\r\nBuild by Wiquid's PCI Generator for TAO platform Free to use - http://www.wiquid.fr/depp/ent/\r\nCopyright DEPP  2018 - Ministre de l'ducation nationale \r\n\r\n*/\r\n\r\ndefine('SnapForTao/runtime/SnapForTao.amd',['qtiCustomInteractionContext', 'taoQtiItem/portableLib/jquery_2_1_1', 'SnapForTao/runtime/js/renderer', 'SnapForTao/runtime/js/lib/snapsrc','taoQtiItem/portableLib/OAT/util/event', 'taoQtiItem/portableLib/lodash' ], function(qtiCustomInteractionContext, $, renderer, snapsrc,event, _){\r\n    'use strict';\r\n\r\n    var SnapForTao = {\r\n        id : -1,\r\n        getTypeIdentifier : function getTypeIdentifier(){\r\n            return 'SnapForTao';\r\n        },\r\n        /**\r\n         * Render the PCI : \r\n         * @param {String} id\r\n         * @param {Node} dom\r\n         * @param {Object} config - json\r\n         */\r\n        initialize : function initialize(id, dom, config, assetManager){\r\n\r\n            //add method on(), off() and trigger() to the current object\r\n            event.addEventMgr(this);\r\n            var customSnapContext = {};\r\n            event.addEventMgr(customSnapContext);\r\n\r\n            var _this = this;\r\n            this.id = id;\r\n            this.dom = dom;\r\n            this.config = config || {};\r\n            this.config.customSnapContext = customSnapContext;\r\n            \r\n\r\n            customSnapContext.on('rawDefinitionChange',function(value){\r\n                _this.trigger('scriptSaverChange', [value]);\r\n\r\n            });\r\n\r\n            renderer.render(this.id, this.dom, this.config, assetManager);\r\n            //tell the rendering engine that I am ready\r\n            qtiCustomInteractionContext.notifyReady(this);\r\n\r\n            //listening to dynamic configuration change for 1.panelSizer 2.testLimiter 3.scriptImporter 4.snapScript\r\n            this.on('panelSizerChange', function(level){\r\n                _this.config.panelSizer = level;\r\n                renderer.renderSnap(_this.id, _this.dom, _this.config);\r\n                if(level == 'nonVisible'){\r\n                    snapsrc.snap.world.leftReducer();                       \r\n                }\r\n                else{snapsrc.snap.world.leftExpand();}\r\n                \r\n            });\r\n\r\n            this.on('testLimiterChange', function(limiter){\r\n                _this.config.testlimiter = limiter;\r\n                renderer.renderSnap(_this.id, _this.dom, _this.config);\r\n            });\r\n\r\n            this.on('scriptImporterChange', function(){\r\n                // Importator function open file explorer to find xml project.\r\n                snapsrc.snap.world.importator();\r\n                \r\n                \r\n            });\r\n\r\n\r\n        },\r\n        /**\r\n         * Programmatically set the response following the json schema described in\r\n         * http://www.imsglobal.org/assessment/pciv1p0cf/imsPCIv1p0cf.html#_Toc353965343\r\n         * \r\n         * @param {Object} interaction\r\n         * @param {Object} response\r\n         */\r\n        setResponse : function setResponse(response){\r\n           \r\n        },\r\n        /**\r\n         * Get the response in the json format described in\r\n         * http://www.imsglobal.org/assessment/pciv1p0cf/imsPCIv1p0cf.html#_Toc353965343\r\n         * \r\n         * @param {Object} interaction\r\n         * @returns {Object}\r\n         */\r\n        getResponse : function getResponse(){\r\n            var $container = $(this.dom);\r\n            var receiver, i, top, cleanblockTracker, cleanProcessus, countingString, canvas,dataURL,value ;\r\n            var canvasArrLenght = $container.find(\".world\").length;\r\n\r\n            canvasArrLenght = canvasArrLenght - 1;\r\n            // Building Json format answer\r\n            receiver = snapsrc.snap.world.children[0].stage.children;\r\n            snapsrc.blockReporter = [];\r\n            for (i = 0; i < receiver.length; i++) {\r\n                if (typeof receiver[i].scripts != \"undefined\") {\r\n                    top = receiver[i].scripts.children[0];\r\n                    if (typeof top != \"undefined\") {\r\n                        snapsrc.snap.world.children[0].stage.threads.startProcess(top, receiver[i]);\r\n                    }\r\n                }\r\n            }\r\n            cleanblockTracker = $container.find(\".blockTracker\").html();\r\n            cleanProcessus = JSON.stringify(snapsrc.blockReporter);\r\n            cleanProcessus = cleanProcessus.substring(0, cleanProcessus.length - 1);\r\n            cleanProcessus = cleanProcessus.substring(1);\r\n            cleanblockTracker = cleanblockTracker.substring(0, cleanblockTracker.length - 1);\r\n            countingString = $container.find(\".compteur\").html();\r\n            if (countingString !== \"\") {\r\n                countingString = \",\"+ countingString + \",\";\r\n            } else {\r\n                countingString = \",\"\r\n            }\r\n            canvas = $container.find(\".world\")[canvasArrLenght];\r\n            dataURL = canvas.toDataURL();\r\n            value = \"{\\\"actions\\\": {\" + cleanblockTracker + \"},\" + \"\\\"processus\\\":[\" + cleanProcessus + \"]\" + countingString + \"\\\"snapImage\\\" : \\\"\" + dataURL + \"\\\"}\";\r\n            return { base: { string: value } };\r\n        },\r\n        /**\r\n         * Remove the current response set in the interaction\r\n         * The state may not be restored at this point.\r\n         * \r\n         * @param {Object} interaction\r\n         */\r\n        resetResponse : function resetResponse(){\r\n        \r\n        },\r\n        /**\r\n         * Reverse operation performed by render()\r\n         * After this function is executed, only the inital naked markup remains \r\n         * Event listeners are removed and the state and the response are reset\r\n         * \r\n         * @param {Object} interaction\r\n         */\r\n        destroy : function destroy(config){\r\n            var $container = $(this.dom);\r\n            var receiver, i, top;\r\n            \r\n            $container.off().empty();\r\n            receiver = snapsrc.snap.world.children[0].stage.children;\r\n            for (i = 0; i < receiver.length; i++) {\r\n                if (typeof receiver[i].scripts != \"undefined\") {\r\n                    top = receiver[i].scripts.children[0];\r\n                    if (typeof top != \"undefined\") {\r\n                        //JP : stop the process after few seconds how long ?\r\n                        setTimeout(() => {\r\n                        snapsrc.snap.world.children[0].stage.threads.stopProcess(top, receiver[i]);\r\n                        }, 3000);\r\n                        // \r\n                    }\r\n                }\r\n            }\r\n        },\r\n        /**\r\n         * Restore the state of the interaction from the serializedState.\r\n         * \r\n         * @param {Object} interaction\r\n         * @param {Object} serializedState - json format\r\n         */\r\n        setSerializedState : function setSerializedState(state){\r\n              \r\n        },\r\n        /**\r\n         * Get the current state of the interaction as a string.\r\n         * It enables saving the state for later usage.\r\n         * \r\n         * @param {Object} interaction\r\n         * @returns {Object} json format\r\n         */\r\n        getSerializedState : function getSerializedState(){\r\n\r\n            return {};\r\n        }\r\n    };\r\n\r\n    qtiCustomInteractionContext.register(SnapForTao);\r\n});\r\n\n",
    "define(['SnapForTao/runtime/SnapForTao.amd'],function(PCI){return PCI});\n"
  ]
}